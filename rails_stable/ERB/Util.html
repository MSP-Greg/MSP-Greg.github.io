<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ERB::Util &mdash; Rails 7-1-stable</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ERB::Util",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Rails 7-1-stable</a> &raquo; 
      <a href='../_index.html#alpha_U'>Index (U)</a> &raquo; 
        <a href="../ERB.html" title="ERB (class)">ERB</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Util&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: ERB::Util</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Included In:</div>
      <div class='box_11'>
        <a class='nodoc' href="../ActionDispatch/DebugView.html" title="ActionDispatch::DebugView (class)"><code>::ActionDispatch::DebugView</code></a>,
          <a href="../ActionView/Base.html" title="ActionView::Base (class)"><code>::ActionView::Base</code></a>
      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="../ActiveSupport/CoreExt/ERBUtilPrivate.html" title="ActiveSupport::CoreExt::ERBUtilPrivate (module)"><code>::ActiveSupport::CoreExt::ERBUtilPrivate</code></a>,
          <a href="../ActiveSupport/CoreExt/ERBUtil.html" title="ActiveSupport::CoreExt::ERBUtil (module)"><code>::ActiveSupport::CoreExt::ERBUtil</code></a>
        </div>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L39'>activesupport/lib/active_support/core_ext/erb/util.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='HTML_ESCAPE-constant' class='summary_signature'>HTML_ESCAPE =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L40-L40'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 40</a>    <pre class='code ruby'>{ <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&amp;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&amp;amp;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&amp;gt;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>   <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&amp;lt;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&amp;quot;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&amp;#39;</span><span class='tstring_end'>&quot;</span></span> }</pre>
  </li>
  <li>
    <span id='HTML_ESCAPE_ONCE_REGEXP-constant' class='summary_signature'>HTML_ESCAPE_ONCE_REGEXP =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L41-L41'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 41</a>    <pre class='code ruby'><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[&quot;&gt;&lt;&#39;]|&amp;(?!([a-zA-Z]|(#\d)|(#[xX][\dA-Fa-f]+));)</span><span class='regexp_end'>/</span></span></pre>
  </li>
  <li>
    <span id='INVALID_TAG_NAME_FOLLOWING_REGEXP-constant' class='summary_signature'>INVALID_TAG_NAME_FOLLOWING_REGEXP =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L49-L49'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 49</a>    <pre class='code ruby'><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[^</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#TAG_NAME_FOLLOWING_CODEPOINTS-constant" title="ERB::Util::TAG_NAME_FOLLOWING_CODEPOINTS (constant)">TAG_NAME_FOLLOWING_CODEPOINTS</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='regexp_end'>/</span></span></pre>
  </li>
  <li>
    <span id='INVALID_TAG_NAME_START_REGEXP-constant' class='summary_signature'>INVALID_TAG_NAME_START_REGEXP =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L47-L47'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 47</a>    <pre class='code ruby'><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[^</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#TAG_NAME_START_CODEPOINTS-constant" title="ERB::Util::TAG_NAME_START_CODEPOINTS (constant)">TAG_NAME_START_CODEPOINTS</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='regexp_end'>/</span></span></pre>
  </li>
  <li>
    <span id='SAFE_XML_TAG_NAME_REGEXP-constant' class='summary_signature'>SAFE_XML_TAG_NAME_REGEXP =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L50-L50'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 50</a>    <pre class='code ruby'><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A[</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#TAG_NAME_START_CODEPOINTS-constant" title="ERB::Util::TAG_NAME_START_CODEPOINTS (constant)">TAG_NAME_START_CODEPOINTS</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>][</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#TAG_NAME_FOLLOWING_CODEPOINTS-constant" title="ERB::Util::TAG_NAME_FOLLOWING_CODEPOINTS (constant)">TAG_NAME_FOLLOWING_CODEPOINTS</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>]*\z</span><span class='regexp_end'>/</span></span></pre>
  </li>
  <li>
    <span id='TAG_NAME_FOLLOWING_CODEPOINTS-constant' class='summary_signature'>TAG_NAME_FOLLOWING_CODEPOINTS =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L48-L48'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 48</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#TAG_NAME_START_CODEPOINTS-constant" title="ERB::Util::TAG_NAME_START_CODEPOINTS (constant)">TAG_NAME_START_CODEPOINTS</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>\\-.0-9\u{B7}\u{0300}-\u{036F}\u{203F}-\u{2040}</span><span class='tstring_end'>&quot;</span></span></pre>
  </li>
  <li>
    <span id='TAG_NAME_REPLACEMENT_CHAR-constant' class='summary_signature'>TAG_NAME_REPLACEMENT_CHAR =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L51-L51'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 51</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_</span><span class='tstring_end'>&quot;</span></span></pre>
  </li>
  <li>
    <span id='TAG_NAME_START_CODEPOINTS-constant' class='summary_signature'>TAG_NAME_START_CODEPOINTS =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>Following XML requirements: <a href="https://www.w3.org/TR/REC-xml/#NT-Name">www.w3.org/TR/REC-xml/#NT-Name</a></p>

  </div>
</div>
    <a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L44-L46'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 44</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@:A-Z_a-z\u{C0}-\u{D6}\u{D8}-\u{F6}\u{F8}-\u{2FF}\u{370}-\u{37D}\u{37F}-\u{1FFF}</span><span class='tstring_end'>&quot;</span></span> \
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\u{200C}-\u{200D}\u{2070}-\u{218F}\u{2C00}-\u{2FEF}\u{3001}-\u{D7FF}\u{F900}-\u{FDCF}</span><span class='tstring_end'>&quot;</span></span> \
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\u{FDF0}-\u{FFFD}\u{10000}-\u{EFFFF}</span><span class='tstring_end'>&quot;</span></span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature mf'>
      <a href="#html_escape_once-class_method" title=".html_escape_once (class method)">.<strong>html_escape_once</strong>(s)  </a>
    </span>
    <span class='mod_func note title'>mod_func</span>
    <div class='summary_desc'>
      <div class='inline'><p>A utility method for escaping HTML without affecting existing escaped entities.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature mf'>
      <a href="#json_escape-class_method" title=".json_escape (class method)">.<strong>json_escape</strong>(s)  </a>
    </span>
    <span class='mod_func note title'>mod_func</span>
    <div class='summary_desc'>
      <div class='inline'><p>A utility method for escaping HTML entities in JSON strings.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature mf'>
      <a href="#xml_name_escape-class_method" title=".xml_name_escape (class method)">.<strong>xml_name_escape</strong>(name)  </a>
    </span>
    <span class='mod_func note title'>mod_func</span>
    <div class='summary_desc'>
      <div class='inline'><p>A utility method for escaping XML names of tags and names of attributes.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#tokenize-class_method" title=".tokenize (class method)">.<strong>tokenize</strong>(source)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Tokenizes a line of <a href="../ERB.html" title="ERB (class)"><code>::ERB</code></a>.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_Method_summary'>Instance Method Summary</h2>
<div class='div_sum'>

<h3 class='inherited'><a href="../ActiveSupport/CoreExt/ERBUtil.html" title="ActiveSupport::CoreExt::ERBUtil (module)"><code>::ActiveSupport::CoreExt::ERBUtil</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../ActiveSupport/CoreExt/ERBUtil.html#h-instance_method" title="ActiveSupport::CoreExt::ERBUtil#h (method)">#h</a></td>
      <td><div class='inline'><p>Alias for <a href="../ActiveSupport/CoreExt/ERBUtil.html#html_escape-instance_method" title="ActiveSupport::CoreExt::ERBUtil#html_escape (method)">ActiveSupport::CoreExt::ERBUtil#html_escape</a>.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="../ActiveSupport/CoreExt/ERBUtil.html#html_escape-instance_method" title="ActiveSupport::CoreExt::ERBUtil#html_escape (method)">#html_escape</a></td>
      <td><div class='inline'><p>A utility method for escaping HTML tag characters.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="../ActiveSupport/CoreExt/ERBUtil.html#unwrapped_html_escape-instance_method" title="ActiveSupport::CoreExt::ERBUtil#unwrapped_html_escape (method)">#unwrapped_html_escape</a></td>
      <td><div class='inline'><p>Alias for <a href="../ActiveSupport/CoreExt/ERBUtil.html#html_escape-instance_method" title="ActiveSupport::CoreExt::ERBUtil#html_escape (method)">ActiveSupport::CoreExt::ERBUtil#html_escape</a>.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Class Method Details</h2>
<section class='method_details first' id="html_escape_once-class_method">
  <h3 class='signature private first'>
    .<strong>html_escape_once</strong>(s)   <span class="extras">(<span class='mod_func'>mod_func</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>A utility method for escaping HTML without affecting existing escaped entities.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_html_escape_once'>html_escape_once</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1 &lt; 2 &amp;amp; 3</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># =&gt; &quot;1 &amp;lt; 2 &amp;amp; 3&quot;
</span>
<span class='id identifier rubyid_html_escape_once'>html_escape_once</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&amp;lt;&amp;lt; Accept &amp; Checkout</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># =&gt; &quot;&amp;lt;&amp;lt; Accept &amp;amp; Checkout&quot;</span></code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L63-L65'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='65'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_html_escape_once'>html_escape_once</span>(<span class='id identifier rubyid_s'>s</span>)
  <span class='const'><a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="../ActiveSupport/Multibyte.html" title="ActiveSupport::Multibyte (module)">Multibyte</a></span><span class='op'>::</span><span class='const'><a href="../ActiveSupport/Multibyte/Unicode.html" title="ActiveSupport::Multibyte::Unicode (module)">Unicode</a></span>.<span class='id identifier rubyid_tidy_bytes'><a href="../ActiveSupport/Multibyte/Unicode.html#tidy_bytes-instance_method" title="ActiveSupport::Multibyte::Unicode#tidy_bytes (method)">tidy_bytes</a></span>(<span class='id identifier rubyid_s'>s</span>.<span class='id identifier rubyid_to_s'>to_s</span>).<span class='id identifier rubyid_gsub'>gsub</span>(<span class='const'><a href="#HTML_ESCAPE_ONCE_REGEXP-constant" title="ERB::Util::HTML_ESCAPE_ONCE_REGEXP (constant)">HTML_ESCAPE_ONCE_REGEXP</a></span><span class='comma'>,</span> <span class='const'><a href="#HTML_ESCAPE-constant" title="ERB::Util::HTML_ESCAPE (constant)">HTML_ESCAPE</a></span>).<span class='id identifier rubyid_html_safe'>html_safe</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="json_escape-class_method">
  <h3 class='signature private'>
    .<strong>json_escape</strong>(s)   <span class="extras">(<span class='mod_func'>mod_func</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>A utility method for escaping HTML entities in JSON strings. Specifically, the &amp;, &gt; and &lt; characters are replaced with their equivalent unicode escaped form - u0026, u003e, and u003c. The Unicode sequences u2028 and u2029 are also escaped as they are treated as newline characters in some JavaScript engines. These sequences have identical meaning as the original characters inside the context of a JSON string, so assuming the input is a valid and well-formed JSON value, the output will have equivalent meaning when parsed:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_json'>json</span> <span class='op'>=</span> <span class='const'>JSON</span>.<span class='id identifier rubyid_generate'>generate</span>({ <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;/script&gt;&lt;script&gt;alert(&#39;PWNED!!!&#39;)&lt;/script&gt;</span><span class='tstring_end'>&quot;</span></span>})
<span class='comment'># =&gt; &quot;{\&quot;name\&quot;:\&quot;&lt;/script&gt;&lt;script&gt;alert(&#39;PWNED!!!&#39;)&lt;/script&gt;\&quot;}&quot;
</span>
<span class='id identifier rubyid_json_escape'>json_escape</span>(<span class='id identifier rubyid_json'>json</span>)
<span class='comment'># =&gt; &quot;{\&quot;name\&quot;:\&quot;\\u003C/script\\u003E\\u003Cscript\\u003Ealert(&#39;PWNED!!!&#39;)\\u003C/script\\u003E\&quot;}&quot;
</span>
<span class='const'>JSON</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_json'>json</span>) <span class='op'>==</span> <span class='const'>JSON</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_json_escape'>json_escape</span>(<span class='id identifier rubyid_json'>json</span>))
<span class='comment'># =&gt; true</span></code></pre>

<p>The intended use case for this method is to escape JSON strings before including them inside a script tag to avoid XSS vulnerability:</p>

<pre class="code xml"><code class="xml">&lt;script&gt;
  var currentUser = &lt;%= raw json_escape(current_user.to_json) %&gt;;
&lt;/script&gt;
</code></pre>

<p>It is necessary to <code>raw</code> the result of <code>json_escape</code>, so that quotation marks don’t get converted to <code>&amp;quot;</code> entities. <code>json_escape</code> doesn’t automatically flag the result as HTML safe, since the raw value is unsafe to use inside HTML attributes.</p>

<p>If your JSON is being used downstream for insertion into the DOM, be aware of whether or not it is being inserted via <code>html()</code>. Most jQuery plugins do this. If that is the case, be sure to <code>html_escape</code> or <code>sanitize</code> any user-generated content returned by your JSON.</p>

<p>If you need to output JSON elsewhere in your HTML, you can just do something like this, as any unsafe characters (including quotation marks) will be automatically escaped for you:</p>

<pre class="code xml"><code class="xml">&lt;div data-user-info=&quot;&lt;%= current_user.to_json %&gt;&quot;&gt;...&lt;/div&gt;
</code></pre>

<p>WARNING: this helper only works with valid JSON. Using this on non-JSON values will open up serious XSS vulnerabilities. For example, if you replace the <code>current_user.to_json</code> in the example above with user input instead, the browser will happily <code>eval()</code> that string as JavaScript.</p>

<p>The escaping performed in this method is identical to those performed in the Active Support JSON encoder when <code>ActiveSupport.escape_html_entities_in_json</code> is set to true. Because this transformation is idempotent, this helper can be applied even if <code>ActiveSupport.escape_html_entities_in_json</code> is already true.</p>

<p>Therefore, when you are unsure if <code>ActiveSupport.escape_html_entities_in_json</code> is enabled, or if you are unsure where your JSON string originated from, it is recommended that you always apply this helper (other libraries, such as the JSON gem, do not provide this kind of protection by default; also some gems might override <code>to_json</code> to bypass Active Support’s encoder).</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L124-L132'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='124' data-end='132'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 124</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_json_escape'>json_escape</span>(<span class='id identifier rubyid_s'>s</span>)
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_s'>s</span>.<span class='id identifier rubyid_to_s'>to_s</span>.<span class='id identifier rubyid_dup'>dup</span>
  <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_gsub!'>gsub!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\u003e</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_gsub!'>gsub!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\u003c</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_gsub!'>gsub!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&amp;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\u0026</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_gsub!'>gsub!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\u2028</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\u2028</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_gsub!'>gsub!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\u2029</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\u2029</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_s'>s</span>.<span class='id identifier rubyid_html_safe?'>html_safe?</span> <span class='op'>?</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_html_safe'>html_safe</span> <span class='op'>:</span> <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="tokenize-class_method">
  <h3 class='signature nodoc'>
    .<strong>tokenize</strong>(source)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Tokenizes a line of <a href="../ERB.html" title="ERB (class)"><code>::ERB</code></a>.  This is really just for error reporting and nobody should use it.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L161-L194'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='161' data-end='194'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 161</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_tokenize'>tokenize</span>(<span class='id identifier rubyid_source'>source</span>) <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>strscan</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_source'>source</span> <span class='op'>=</span> <span class='const'>StringScanner</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_chomp'>chomp</span>)
  <span class='id identifier rubyid_tokens'>tokens</span> <span class='op'>=</span> []

  <span class='id identifier rubyid_start_re'>start_re</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>&lt;%(?:={1,2}|-|\#|%)?</span><span class='regexp_end'>/m</span></span>
  <span class='id identifier rubyid_finish_re'>finish_re</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(?:[-=])?%&gt;</span><span class='regexp_end'>/m</span></span>

  <span class='kw'>while</span> <span class='op'>!</span><span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_eos?'>eos?</span>
    <span class='id identifier rubyid_pos'>pos</span> <span class='op'>=</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_pos'>pos</span>
    <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_scan_until'>scan_until</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(?:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_start_re'>start_re</span><span class='embexpr_end'>}</span><span class='tstring_content'>|</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_finish_re'>finish_re</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='regexp_end'>/</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span> <span class='kw'>if</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_matched'>matched</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_len'>len</span> <span class='op'>=</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_pos'>pos</span> <span class='op'>-</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_matched'>matched</span>.<span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>-</span> <span class='id identifier rubyid_pos'>pos</span>

    <span class='kw'>case</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_matched'>matched</span>
    <span class='kw'>when</span> <span class='id identifier rubyid_start_re'>start_re</span>
      <span class='id identifier rubyid_tokens'>tokens</span> <span class='op'>&lt;&lt;</span> [<span class='symbeg'>:</span><span class='const'>TEXT</span><span class='comma'>,</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_string'>string</span>[<span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_len'>len</span>]] <span class='kw'>if</span> <span class='id identifier rubyid_len'>len</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_tokens'>tokens</span> <span class='op'>&lt;&lt;</span> [<span class='symbeg'>:</span><span class='const'>OPEN</span><span class='comma'>,</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_matched'>matched</span>]
      <span class='kw'>if</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_scan'>scan</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(.*?)(?=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_finish_re'>finish_re</span><span class='embexpr_end'>}</span><span class='tstring_content'>|\z)</span><span class='regexp_end'>/m</span></span>)
        <span class='id identifier rubyid_tokens'>tokens</span> <span class='op'>&lt;&lt;</span> [<span class='symbeg'>:</span><span class='const'>CODE</span><span class='comma'>,</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_matched'>matched</span>] <span class='kw'>unless</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_matched'>matched</span>.<span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_tokens'>tokens</span> <span class='op'>&lt;&lt;</span> [<span class='symbeg'>:</span><span class='const'>CLOSE</span><span class='comma'>,</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_scan'>scan</span>(<span class='id identifier rubyid_finish_re'>finish_re</span>)] <span class='kw'>unless</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_eos?'>eos?</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span>
      <span class='kw'>end</span>
    <span class='kw'>when</span> <span class='id identifier rubyid_finish_re'>finish_re</span>
      <span class='id identifier rubyid_tokens'>tokens</span> <span class='op'>&lt;&lt;</span> [<span class='symbeg'>:</span><span class='const'>CODE</span><span class='comma'>,</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_string'>string</span>[<span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_len'>len</span>]] <span class='kw'>if</span> <span class='id identifier rubyid_len'>len</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_tokens'>tokens</span> <span class='op'>&lt;&lt;</span> [<span class='symbeg'>:</span><span class='const'>CLOSE</span><span class='comma'>,</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_matched'>matched</span>]
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span><span class='comma'>,</span> <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_matched'>matched</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tokens'>tokens</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="xml_name_escape-class_method">
  <h3 class='signature private'>
    .<strong>xml_name_escape</strong>(name)   <span class="extras">(<span class='mod_func'>mod_func</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>A utility method for escaping XML names of tags and names of attributes.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_xml_name_escape'>xml_name_escape</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1 &lt; 2 &amp; 3</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># =&gt; &quot;1___2___3&quot;</span></code></pre>

<p>It follows the requirements of the specification: <a href="https://www.w3.org/TR/REC-xml/#NT-Name">www.w3.org/TR/REC-xml/#NT-Name</a></p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/7-1-stable/activesupport/lib/active_support/core_ext/erb/util.rb#L142-L156'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='142' data-end='156'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/core_ext/erb/util.rb', line 142</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_xml_name_escape'>xml_name_escape</span>(<span class='id identifier rubyid_name'>name</span>)
  <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_blank?'>blank?</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_name'>name</span> <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_match?'>match?</span>(<span class='const'><a href="#SAFE_XML_TAG_NAME_REGEXP-constant" title="ERB::Util::SAFE_XML_TAG_NAME_REGEXP (constant)">SAFE_XML_TAG_NAME_REGEXP</a></span>)

  <span class='id identifier rubyid_starting_char'>starting_char</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>[<span class='int'>0</span>]
  <span class='id identifier rubyid_starting_char'>starting_char</span>.<span class='id identifier rubyid_gsub!'>gsub!</span>(<span class='const'><a href="#INVALID_TAG_NAME_START_REGEXP-constant" title="ERB::Util::INVALID_TAG_NAME_START_REGEXP (constant)">INVALID_TAG_NAME_START_REGEXP</a></span><span class='comma'>,</span> <span class='const'><a href="#TAG_NAME_REPLACEMENT_CHAR-constant" title="ERB::Util::TAG_NAME_REPLACEMENT_CHAR (constant)">TAG_NAME_REPLACEMENT_CHAR</a></span>)

  <span class='kw'>return</span> <span class='id identifier rubyid_starting_char'>starting_char</span> <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>==</span> <span class='int'>1</span>

  <span class='id identifier rubyid_following_chars'>following_chars</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>[<span class='int'>1</span><span class='op'>..</span><span class='op'>-</span><span class='int'>1</span>]
  <span class='id identifier rubyid_following_chars'>following_chars</span>.<span class='id identifier rubyid_gsub!'>gsub!</span>(<span class='const'><a href="#INVALID_TAG_NAME_FOLLOWING_REGEXP-constant" title="ERB::Util::INVALID_TAG_NAME_FOLLOWING_REGEXP (constant)">INVALID_TAG_NAME_FOLLOWING_REGEXP</a></span><span class='comma'>,</span> <span class='const'><a href="#TAG_NAME_REPLACEMENT_CHAR-constant" title="ERB::Util::TAG_NAME_REPLACEMENT_CHAR (constant)">TAG_NAME_REPLACEMENT_CHAR</a></span>)

  <span class='id identifier rubyid_starting_char'>starting_char</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_following_chars'>following_chars</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>