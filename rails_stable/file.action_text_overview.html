<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Action Text Overview &mdash; Rails 7-1-stable</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "action_text_overview",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 7-1-stable</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Action Text Overview&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1>Action Text Overview</h1>

<p>This guide provides you with all you need to get started in handling
rich text content.</p>

<p>After reading this guide, you will know:</p>

<ul>
<li>How to configure Action Text.</li>
<li>How to handle rich text content.</li>
<li>How to style rich text content and attachments.</li>
</ul>

<hr>

<h2>What is Action Text?</h2>

<p>Action Text brings rich text content and editing to <a href="Rails.html" title="Rails (module)"><code>Rails</code></a>. It includes
the <a href="https://trix-editor.org">Trix editor</a> that handles everything from formatting
to links to quotes to lists to embedded images and galleries.
The rich text content generated by the Trix editor is saved in its own
RichText model that&#39;s associated with any existing Active Record model in the application.
Any embedded images (or other attachments) are automatically stored using
Active Storage and associated with the included RichText model.</p>

<h2>Trix Compared to Other Rich Text Editors</h2>

<p>Most WYSIWYG editors are wrappers around HTML’s <code>contenteditable</code> and <code>execCommand</code> APIs,
designed by Microsoft to support live editing of web pages in Internet Explorer 5.5,
and <a href="https://blog.whatwg.org/the-road-to-html-5-contenteditable#history">eventually reverse-engineered</a>
and copied by other browsers.</p>

<p>Because these APIs were never fully specified or documented,
and because WYSIWYG HTML editors are enormous in scope, each
browser&#39;s implementation has its own set of bugs and quirks,
and JavaScript developers are left to resolve the inconsistencies.</p>

<p>Trix sidesteps these inconsistencies by treating <code>contenteditable</code>
as an I/O device: when input makes its way to the editor, Trix converts that input
into an editing operation on its internal document model, then re-renders
that document back into the editor. This gives Trix complete control over what
happens after every keystroke, and avoids the need to use <code>execCommand</code> at all.</p>

<h2>Installation</h2>

<p>Run <code>bin/rails action_text:install</code> to add the Yarn package and copy over the necessary migration. Also, you need to set up Active Storage for embedded images and other attachments. Please refer to the <a href="active_storage_overview.html">Active Storage Overview</a> guide.</p>

<p>NOTE: Action Text uses polymorphic relationships with the <code>action_text_rich_texts</code> table so that it can be shared with all models that have rich text attributes. If your models with Action Text content use UUID values for identifiers, all models that use Action Text attributes will need to use UUID values for their unique identifiers. The generated migration for Action Text will also need to be updated to specify <code>type: :uuid</code> for the <code>:record</code> <code>references</code> line.</p>

<p>After the installation is complete, a <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> app should have the following changes:</p>

<ol>
<li><p>Both <code>trix</code> and <code>@rails/actiontext</code> should be required in your JavaScript entrypoint.</p>

<pre class="code js"><code class="js">// application.js
import &quot;trix&quot;
import &quot;@rails/actiontext&quot;
</code></pre></li>
<li><p>The <code>trix</code> stylesheet will be included together with Action Text styles in your <code>application.css</code> file.</p></li>
</ol>

<h2>Creating Rich Text Content</h2>

<p>Add a rich text field to an existing model:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/message.rb
</span><span class='kw'>class</span> <span class='const'>Message</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_rich_text'>has_rich_text</span> <span class='symbeg'>:</span><span class='id identifier rubyid_content'>content</span>
<span class='kw'>end</span></code></pre>

<p>or add rich text field while creating a new model using:</p>

<pre class="code bash"><code class="bash">$ bin/rails generate model Message content:rich_text
</code></pre>

<p>NOTE: you don&#39;t need to add a <code>content</code> field to your <code>messages</code> table.</p>

<p>Then use <a href="https://api.rubyonrails.org/classes/ActionView/Helpers/FormHelper.html#method-i-rich_text_area"><code>rich_text_area</code></a> to refer to this field in the form for the model:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/messages/_form.html.erb %&gt;
&lt;%= form_with model: message do |form| %&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;%= form.label :content %&gt;
    &lt;%= form.rich_text_area :content %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>

<p>And finally, display the sanitized rich text on a page:</p>

<pre class="code xml"><code class="xml">&lt;%= @message.content %&gt;
</code></pre>

<p>NOTE: If there&#39;s an attached resource within <code>content</code> field, it might not show properly unless you
have <em>libvips/libvips42</em> package installed locally on your machine.
Check their <a href="https://www.libvips.org/install.html">install docs</a> on how to get it.</p>

<p>To accept the rich text content, all you have to do is permit the referenced attribute:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MessagesController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='const'>Message</span>.<span class='id identifier rubyid_create!'>create!</span> <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_require'>require</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_message'>message</span>).<span class='id identifier rubyid_permit'>permit</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_content'>content</span>)
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_message'>message</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h2>Rendering Rich Text Content</h2>

<p>By default, Action Text will render rich text content inside an element with the
<code>.trix-content</code> class:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/layouts/action_text/contents/_content.html.erb %&gt;
&lt;div class=&quot;trix-content&quot;&gt;
  &lt;%= yield %&gt;
&lt;/div&gt;
</code></pre>

<p>Elements with this class, as well as the Action Text editor, are styled by the
<a href="https://unpkg.com/trix/dist/trix.css"><code>trix</code> stylesheet</a>.
To provide your own styles instead, remove the <code>= require trix</code> line from the
<code>app/assets/stylesheets/actiontext.css</code> stylesheet created by the installer.</p>

<p>To customize the HTML rendered around rich text content, edit the
<code>app/views/layouts/action_text/contents/_content.html.erb</code> layout created by the
installer.</p>

<p>To customize the HTML rendered for embedded images and other attachments (known
as blobs), edit the <code>app/views/active_storage/blobs/_blob.html.erb</code> template
created by the installer.</p>

<h3>Rendering attachments</h3>

<p>In addition to attachments uploaded through Active Storage, Action Text can
embed anything that can be resolved by a <a href="https://github.com/rails/globalid#signed-global-ids">Signed
GlobalID</a>.</p>

<p>Action Text renders embedded <code>&lt;action-text-attachment&gt;</code> elements by resolving
their <code>sgid</code> attribute into an instance. Once resolved, that instance is passed
along to
<a href="https://api.rubyonrails.org/classes/ActionView/Helpers/RenderingHelper.html#method-i-render"><code>render</code></a>.
The resulting HTML is embedded as a descendant of the <code>&lt;action-text-attachment&gt;</code>
element.</p>

<p>For example, consider a <code>User</code> model:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/user.rb
</span><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one_attached'>has_one_attached</span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>1</span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_to_global_id'>to_global_id</span>.<span class='id identifier rubyid_to_s'>to_s</span> <span class='comment'>#=&gt; gid://MyRailsApp/User/1
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_to_signed_global_id'>to_signed_global_id</span>.<span class='id identifier rubyid_to_s'>to_s</span> <span class='comment'>#=&gt; BAh7CEkiCG…</span></code></pre>

<p>Next, consider some rich text content that embeds an <code>&lt;action-text-attachment&gt;</code>
element that references the <code>User</code> instance&#39;s signed GlobalID:</p>

<pre class="code xml"><code class="xml">&lt;p&gt;Hello, &lt;action-text-attachment sgid=&quot;BAh7CEkiCG…&quot;&gt;&lt;/action-text-attachment&gt;.&lt;/p&gt;
</code></pre>

<p>Action Text resolves uses the &quot;BAh7CEkiCG…&quot; String to resolve the <code>User</code>
instance. Next, consider the application&#39;s <code>users/user</code> partial:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/users/_user.html.erb %&gt;
&lt;span&gt;&lt;%= image_tag user.avatar %&gt; &lt;%= user.name %&gt;&lt;/span&gt;
</code></pre>

<p>The resulting HTML rendered by Action Text would look something like:</p>

<pre class="code xml"><code class="xml">&lt;p&gt;Hello, &lt;action-text-attachment sgid=&quot;BAh7CEkiCG…&quot;&gt;&lt;span&gt;&lt;img src=&quot;...&quot;&gt; Jane Doe&lt;/span&gt;&lt;/action-text-attachment&gt;.&lt;/p&gt;
</code></pre>

<p>To render a different partial, define <code>User#to_attachable_partial_path</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_to_attachable_partial_path'>to_attachable_partial_path</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>users/attachable</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Then declare that partial. The <code>User</code> instance will be available as the <code>user</code>
partial-local variable:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/users/_attachable.html.erb %&gt;
&lt;span&gt;&lt;%= image_tag user.avatar %&gt; &lt;%= user.name %&gt;&lt;/span&gt;
</code></pre>

<p>If Action Text is unable to resolve the <code>User</code> instance (for example, if the
record has been deleted), then a default fallback partial will be rendered.</p>

<p>Rails provides a global partial for missing attachments. This partial is installed
in your application at <code>views/action_text/attachables/missing_attachable</code> and can
be modified if you want to render different HTML.</p>

<p>To render a different missing attachment partial, define a class-level
<code>to_missing_attachable_partial_path</code> method:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_to_missing_attachable_partial_path'>to_missing_attachable_partial_path</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>users/missing_attachable</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Then declare that partial.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/users/missing_attachable.html.erb %&gt;
&lt;span&gt;Deleted user&lt;/span&gt;
</code></pre>

<p>To integrate with Action Text <code>&lt;action-text-attachment&gt;</code> element rendering, a
class must:</p>

<ul>
<li>include the <a href="ActionText/Attachable.html" title="ActionText::Attachable (module)"><code>::ActionText::Attachable</code></a> module</li>
<li>implement <code>#to_sgid(**options)</code> (made available through the <a href="https://github.com/rails/globalid#usage"><code>GlobalID::Identification</code> concern</a>)</li>
<li>(optional) declare <code>#to_attachable_partial_path</code></li>
<li>(optional) declare a class-level method <code>#to_missing_attachable_partial_path</code> for handling missing records</li>
</ul>

<p>By default, all <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> descendants mix-in
<a href="https://github.com/rails/globalid#usage"><code>GlobalID::Identification</code> concern</a>, and are therefore
<a href="ActionText/Attachable.html" title="ActionText::Attachable (module)"><code>::ActionText::Attachable</code></a> compatible.</p>

<h2>Avoid N+1 Queries</h2>

<p>If you wish to preload the dependent <code>ActionText::RichText</code> model, assuming your rich text field is named <code>content</code>, you can use the named scope:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Message</span>.<span class='id identifier rubyid_all'>all</span>.<span class='id identifier rubyid_with_rich_text_content'>with_rich_text_content</span> <span class='comment'># Preload the body without attachments.
</span><span class='const'>Message</span>.<span class='id identifier rubyid_all'>all</span>.<span class='id identifier rubyid_with_rich_text_content_and_embeds'>with_rich_text_content_and_embeds</span> <span class='comment'># Preload both body and attachments.</span></code></pre>

<h2>API / Backend Development</h2>

<ol>
<li><p>A backend API (for example, using JSON) needs a separate endpoint for uploading files that creates an <code>ActiveStorage::Blob</code> and returns its <code>attachable_sgid</code>:</p>

<pre class="code json"><code class="json">{
  &quot;attachable_sgid&quot;: &quot;BAh7CEkiCG…&quot;
}
</code></pre></li>
<li><p>Take that <code>attachable_sgid</code> and ask your frontend to insert it in rich text content using an <code>&lt;action-text-attachment&gt;</code> tag:</p>

<pre class="code xml"><code class="xml">&lt;action-text-attachment sgid=&quot;BAh7CEkiCG…&quot;&gt;&lt;/action-text-attachment&gt;
</code></pre></li>
</ol>

<p>This is based on Basecamp, so if you still can&#39;t find what you are looking for, check this [Basecamp Doc]).</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>