<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Active Record Encryption &mdash; Rails 8-1-stable</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "active_record_encryption",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 8-1-stable</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Active Record Encryption&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON
<a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1>Active Record Encryption</h1>

<p>This guide covers how to encrypt data in your database using Active Record.</p>

<p>After reading this guide, you will know:</p>

<ul>
<li>How to set up database encryption with Active Record.</li>
<li>How to migrate unencrypted data.</li>
<li>How to make different encryption schemes coexist.</li>
<li>More about advanced concepts like Encryption Contexts and Key Providers.</li>
</ul>

<hr>

<p>Active Record Encryption exists to protect sensitive information in your
application, such as personally identifiable information (PII) about your users.
Active Record supports application-level encryption by allowing you to declare
which attributes should be encrypted. It enables transparent encryption and
decryption of attributes when saving and retrieving data.</p>

<h2>Why Encrypt Data at the Application Level?</h2>

<p>Encrypting specific attributes at the application level adds an additional
security layer. For example, if someone gains access to your application logs or
database backup, the encrypted data remains unreadable. It also helps avoid
accidental exposure of sensitive information in your application console or
logs.</p>

<p>Most importantly, this feature lets you explicitly define what data is sensitive
in your code. This enables precise access control throughout your application
and any connected services. For example, you can use tools like
<a href="https://github.com/basecamp/console1984">console1984</a> to restrict decrypted
data access in the <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> console. You can also take advantage of automatic
<a href="#filtering-params-named-as-encrypted-attributes">parameter filtering</a> for
encrypted fields.</p>

<h2>Setup</h2>

<p>To start using Active Record Encryption, you need to generate keys and declare
attributes you want to encrypt in the model.</p>

<h3>Generate Encryption Key</h3>

<p>You can generate a random key set by running <code>bin/rails db:encryption:init</code>:</p>

<pre class="code bash"><code class="bash">$ bin/rails db:encryption:init
Add this entry to the credentials of the target environment:

active_record_encryption:
  primary_key: YehXdfzxVKpoLvKseJMJIEGs2JxerkB8
  deterministic_key: uhtk2DYS80OweAPnMLtrV2FhYIXaceAy
  key_derivation_salt: g7Q66StqUQDQk9SJ81sWbYZXgiRogBwS
</code></pre>

<p>These values can be stored by copying and pasting the generated values into your
existing <a href="/security.html#custom-credentials">Rails credentials</a> file using
<code>bin/rails credentials:edit</code>.</p>

<p>Alternatively, the encryption keys can also be configured from other sources,
such as environment variables:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/application.rb
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_primary_key'>primary_key</span> <span class='op'>=</span> <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY</span><span class='tstring_end'>&quot;</span></span>]
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_deterministic_key'>deterministic_key</span> <span class='op'>=</span> <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY</span><span class='tstring_end'>&quot;</span></span>]
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_key_derivation_salt'>key_derivation_salt</span> <span class='op'>=</span> <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT</span><span class='tstring_end'>&quot;</span></span>]</code></pre>

<p>WARNING: It&#39;s recommended to use Rails built-in credentials support to store
keys. If you set them manually via configuration properties, make sure you don&#39;t
commit them with your code (e.g. use environment variables).</p>

<p>NOTE: The generated values are 32 bytes in length. If you generate these
yourself, the recommended minimum length is 12 bytes for the primary key and 20
bytes for the <a href="https://en.wikipedia.org/wiki/Salt_(cryptography)">salt</a>.</p>

<p>Once the keys are generated and stored, you can start using Active Record
Encryption by declaring attributes to be encrypted in the model.</p>

<h3>Declare Encrypted Attributes</h3>

<p>The <a href="https://api.rubyonrails.org/classes/ActiveRecord/Encryption/EncryptableRecord.html#method-i-encrypts"><code>encrypts</code>
method</a>
defines the attributes to be encrypted at the model level. These are regular
Active Record attributes backed by a column with the same name.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span>
<span class='kw'>end</span></code></pre>

<p>Active Record Encryption will transparently encrypt these attributes before
saving them to the database and will decrypt them upon retrieval. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_article'>article</span> <span class='op'>=</span> <span class='const'>Article</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Encrypt it all!</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_article'>article</span>.<span class='id identifier rubyid_title'>title</span> <span class='comment'># =&gt; &quot;Encrypt it all!&quot;</span></code></pre>

<p>However, in the Rails console, the executed SQL looks like this:</p>

<pre class="code sql"><code class="sql">INSERT INTO &quot;articles&quot; (&quot;title&quot;, &quot;created_at&quot;, &quot;updated_at&quot;)
VALUES (&#39;{&quot;p&quot;:&quot;oqRFYW8CucALxnJ6ccx&quot;,&quot;h&quot;:{&quot;iv&quot;:&quot;3nrJAIYcN1YcGMQ&quot;,&quot;at&quot;:&quot;JBsw7uB90yAyWbQ8E3krjg==&quot;}}&#39;, ...) RETURNING &quot;id&quot;
</code></pre>

<p>The value inserted is a JSON object that contains the encrypted value for the
<code>title</code> attribute. More specifically, the JSON object stores two keys: <code>p</code> for
payload and <code>h</code> for headers. The ciphertext, which is compressed and encoded in
Base64, is stored as the payload. The <code>h</code> key stores metadata needed to decrypt
the value. The <code>iv</code> value is the initialization vector and <code>at</code> is
authentication tag (used to ensure the ciphertext has not been tampered with).</p>

<p>When looking at the <code>Article</code> in the Rails console, the encrypted attribute
<code>title</code> will also be filtered:</p>

<pre class="code irb"><code class="irb">my-app(dev)&gt; Article.first
  Article Load (0.1ms)  SELECT &quot;articles&quot;.* FROM &quot;articles&quot; ORDER BY &quot;articles&quot;.&quot;id&quot; ASC LIMIT ?  [[&quot;LIMIT&quot;, 1]]
=&gt; #&lt;Article:0x00007f83fd9533b8
    id: 1,
    title: &quot;[FILTERED]&quot;,
    created_at: Fri, 12 Sep 2025 16:57:45.753372000 UTC +00:00,
    updated_at: Fri, 12 Sep 2025 16:57:45.753372000 UTC +00:00&gt;
</code></pre>

<h3>Important: Storage Considerations</h3>

<p>Encrypted data takes more storage because Active Record Encryption stores
additional metadata alongside the encrypted payload, and the payload itself is
Base64-encoded so it can fit safely in text-based columns.</p>

<p>When using the built-in envelope encryption key provider, you can estimate the
worst-case overhead to be around 255 bytes. This overhead is negligible for
larger sizes. Encryption also uses compression by default, which can offer up to
30% storage savings over the unencrypted version for larger payloads.</p>

<p>When using <code>string</code> columns, it’s important to know that modern databases define
the column size in terms of <em>number of characters</em>, not bytes. With encodings
like UTF-8, a single character can take up to four bytes. This means that a
column defined to hold N characters may actually consume up to 4 × N bytes in
storage.</p>

<p>Since an encrypted payload is binary data serialized with Base64, it can be
stored in regular a <code>string</code> column. Because it&#39;s a sequence of ASCII bytes, an
encrypted column can take up to four times its clear version size. So, even if
the bytes stored in the database are the same, the column must be four times
bigger.</p>

<p>In practice, this means:</p>

<ul>
<li>When encrypting short texts written in Western alphabets (mostly ASCII
characters), you should account for that 255 additional overhead when defining
the column size.</li>
<li>When encrypting short texts written in non-Western alphabets, such as
Cyrillic, you should multiply the column size by 4. Notice that the storage
overhead is 255 bytes at most.</li>
<li>When encrypting long texts, you can ignore column size concerns.</li>
</ul>

<p>For example:</p>

<table><thead>
<tr>
<th>Content to encrypt</th>
<th>Original column size</th>
<th>Recommended encrypted column size</th>
<th>Storage overhead (worst case)</th>
</tr>
</thead><tbody>
<tr>
<td>Email addresses</td>
<td>string(255)</td>
<td>string(510)</td>
<td>255 bytes</td>
</tr>
<tr>
<td>Short sequence of emojis</td>
<td>string(255)</td>
<td>string(1020)</td>
<td>255 bytes</td>
</tr>
<tr>
<td>Summary of texts written in non-western alphabets</td>
<td>string(500)</td>
<td>string(2000)</td>
<td>255 bytes</td>
</tr>
<tr>
<td>Arbitrary long text</td>
<td>text</td>
<td>text</td>
<td>negligible</td>
</tr>
</tbody></table>

<h2>Basic Usage</h2>

<h3>Querying Encrypted Data: Deterministic vs. Non-deterministic Encryption</h3>

<p>By default, Active Record Encryption is non-deterministic, which means that
encrypting the same value with the same key twice will result in <em>different</em>
encrypted values (aka ciphertexts). The non-deterministic approach improves
security by making crypto-analysis of ciphertexts harder. However, it also means
that queries (such as <code>WHERE title = &quot;Encrypt it all!&quot;</code>) on encrypted values are
not possible, since the same plaintext value can result in a different encrypted
value that does not match the encrypted value previously stored in the JSON
document.</p>

<p>You can use deterministic encryption if you need to query using encrypted
values. For example, the <code>email</code> field on the <code>Author</code> model below:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>deterministic:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='comment'># You can only query by email if using deterministic encryption.
</span><span class='const'>Author</span>.<span class='id identifier rubyid_find_by_email'>find_by_email</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tolkien@email.com</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>The <code>:deterministic</code> option generates initialization vectors in a deterministic
way, meaning it will produce the same encrypted output given the same plaintext
input value. This makes querying encrypted attributes possible by string
equality comparison. For example, notice that the <code>p</code> and <code>iv</code> key in the JSON
document have the same value when we create and when we query an Author&#39;s email:</p>

<pre class="code irb"><code class="irb">my-app(dev)&gt; author = Author.create(name: &quot;J.R.R. Tolkien&quot;, email: &quot;tolkien@email.com&quot;)
  TRANSACTION (0.1ms)  begin transaction
  Author Create (0.4ms)  INSERT INTO &quot;authors&quot; (&quot;name&quot;, &quot;email&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (?, ?, ?, ?) RETURNING &quot;id&quot;  [[&quot;name&quot;, &quot;J.R.R. Tolkien&quot;], [&quot;email&quot;, &quot;{\&quot;p\&quot;:\&quot;8BAc8dGXqxksThLNmKmbWG8=\&quot;,\&quot;h\&quot;:{\&quot;iv\&quot;:\&quot;NgqthINGlvoN+fhP\&quot;,\&quot;at\&quot;:\&quot;1uVTEDmQmPfpi1ULT9Nznw==\&quot;}}&quot;], [&quot;created_at&quot;, &quot;2025-09-19 18:08:40.104634&quot;], [&quot;updated_at&quot;, &quot;2025-09-19 18:08:40.104634&quot;]]
  TRANSACTION (0.1ms)  commit transaction

my-app(dev)&gt; Author.find_by_email(&quot;tolkien@email.com&quot;)
  Author Load (0.1ms)  SELECT &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;email&quot; = ? LIMIT ?  [[&quot;email&quot;, &quot;{\&quot;p\&quot;:\&quot;8BAc8dGXqxksThLNmKmbWG8=\&quot;,\&quot;h\&quot;:{\&quot;iv\&quot;:\&quot;NgqthINGlvoN+fhP\&quot;,\&quot;at\&quot;:\&quot;1uVTEDmQmPfpi1ULT9Nznw==\&quot;}}&quot;], [&quot;LIMIT&quot;, 1]]
=&gt; #&lt;Author:0x00007f8a396289d0
    id: 3,
    name: &quot;J.R.R. Tolkien&quot;,
    email: &quot;[FILTERED]&quot;,
    created_at: Fri, 19 Sep 2025 18:08:40.104634000 UTC +00:00,
    updated_at: Fri, 19 Sep 2025 18:08:40.104634000 UTC +00:00&gt;
</code></pre>

<p>In the above example, the initialization vector, <code>iv</code>, has the value
<code>&quot;NgqthINGlvoN+fhP&quot;</code> for the same string. Even if you use the same email string
in a different model instance (or different attribute with deterministic
encryption), it will map to the same <code>p</code> and <code>iv</code> values:</p>

<pre class="code irb"><code class="irb">my-app(dev)&gt; author2 = Author.create(name: &quot;Different Author&quot;, email: &quot;tolkien@email.com&quot;)
  TRANSACTION (0.1ms)  begin transaction
  Author Create (0.4ms)  INSERT INTO &quot;authors&quot; (&quot;name&quot;, &quot;email&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (?, ?, ?, ?) RETURNING &quot;id&quot;  [[&quot;name&quot;, &quot;Different Author&quot;], [&quot;email&quot;, &quot;{\&quot;p\&quot;:\&quot;8BAc8dGXqxksThLNmKmbWG8=\&quot;,\&quot;h\&quot;:{\&quot;iv\&quot;:\&quot;NgqthINGlvoN+fhP\&quot;,\&quot;at\&quot;:\&quot;1uVTEDmQmPfpi1ULT9Nznw==\&quot;}}&quot;], [&quot;created_at&quot;, &quot;2025-09-19 18:20:11.291969&quot;], [&quot;updated_at&quot;, &quot;2025-09-19 18:20:11.291969&quot;]]
  TRANSACTION (0.1ms)  commit transaction
</code></pre>

<p>The <code>:deterministic</code> option allows for querying by trading off lesser security.
The data is still encrypted but the determinism makes crypto-analysis easier.
For this reason, non-deterministic encryption is recommended for all data unless
you need to query by the encrypted attribute.</p>

<p>NOTE: In non-deterministic mode, Active Record uses
<a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a>-<a href="https://en.wikipedia.org/wiki/Galois/Counter_Mode">GCM</a>
with a 256-bits key and a random initialization vector. In deterministic mode,
it also uses AES-GCM, but the initialization vector is not random. It is
generated as a function of the key and the plaintext content
(<a href="https://en.wikipedia.org/wiki/HMAC">HMAC</a>-SHA-256 digest of the two).</p>

<p>NOTE: If you do not define a <code>deterministic_key</code>, then you have effectively
disabled deterministic encryption.</p>

<h3>Ignoring Case</h3>

<p>You might want to ignore the case when querying deterministically encrypted
data. There are two options for achieving this - <code>:downcase</code> and <code>:ignore_case</code>.</p>

<p>When you use the <code>:downcase</code> option when declaring the encrypted attribute, it
converts the data to downcase before encryption occurs. This allows to
effectively ignore case when querying data.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email_address'>email_address</span><span class='comma'>,</span> <span class='label'>deterministic:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>downcase:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>When using <code>:downcase</code>, the original case is lost.</p>

<p>You can use the <code>:ignore_case</code> option when you want to preserve the original
case for displaying but ignore the case when querying data:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Label</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>deterministic:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>ignore_case:</span> <span class='kw'>true</span> <span class='comment'># the encrypted content with the original case will be stored in the column `original_name`
</span><span class='kw'>end</span></code></pre>

<p>With the <code>:ignore_case</code> option, you need to add a new column named
<code>original_&lt;column_name&gt;</code> to store the encrypted content with the case unchanged.
When reading the <code>name</code> attribute, Rails will serve the version with the
original case. When querying <code>name</code>, it will ignore case.</p>

<h3>Serialized Attributes</h3>

<p>By default, Active Record Encryption will serialize values using the underlying
type before encrypting them as long as the value is serializable as Strings. If
the underlying type is not serializable as a String, you can use a custom
<a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Encryption/MessageSerializer.html"><code>message_serializer</code></a>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_metadata'>metadata</span><span class='comma'>,</span> <span class='label'>message_serializer:</span> <span class='const'>SomeCustomMessageSerializer</span>.<span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span></code></pre>

<p>Attributes with structured types using the
<a href="https://api.rubyonrails.org/v8.0.2/classes/ActiveRecord/AttributeMethods/Serialization/ClassMethods.html#method-i-serialize"><code>serialized</code></a>
method can be encrypted as well. The <code>serialized</code> method is used when you have
an attribute that needs to be saved to the database as a serialized object
(using <code>YAML</code>, <code>JSON</code> or such), and retrieved by deserializing into the same
object.</p>

<p>WARNING: When using serialized attributes for custom types, the declaration of
the serialized attribute should go <strong>before</strong> the encryption declaration:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># CORRECT
</span><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_serialize'>serialize</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Title</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span>
<span class='kw'>end</span>

<span class='comment'># INCORRECT
</span><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span>
  <span class='id identifier rubyid_serialize'>serialize</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Title</span>
<span class='kw'>end</span></code></pre>

<h3>Ensuring Uniqueness with Encrypted Data</h3>

<p>Checking for uniqueness is only supported with deterministically encrypted data.</p>

<h4>Unique Validations</h4>

<p>If an attribute is deterministically encrypted, a uniqueness validation can be
specified normally, along with encryption:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_validates'>validates</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email_address'>email_address</span><span class='comma'>,</span> <span class='label'>uniqueness:</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email_address'>email_address</span><span class='comma'>,</span> <span class='label'>deterministic:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>downcase:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>If you want to ignore the case for uniqueness, make sure to use the <code>:downcase</code>
or <code>:ignore_case</code> option in the <code>encrypts</code> declaration. Using the
<code>:case_sensitive</code> option in the validation won&#39;t work.</p>

<p>NOTE: If you have a mix of unencrypted and encrypted data or if you have data
that is encrypted using two different sets of keys/schemes, you&#39;ll need to
enable <a href="configuring.html#config-active-record-encryption-extend-queries">extended
queries</a> with
<code>config.active_record.encryption.extend_queries = true</code> in order to support
unique validations.</p>

<h4>Unique Indexes</h4>

<p>In order to support unique indexes on deterministically encrypted attributes,
it’s important to ensure that a given plaintext always produces the same
ciphertext. This consistency is what makes indexing and querying possible.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email_address'>email_address</span><span class='comma'>,</span> <span class='label'>deterministic:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>In order for unique indexes to work, you will have to ensure that the encryption
properties for the underlying attributes don&#39;t change.</p>

<h3>Filtering Params Named as Encrypted Attributes</h3>

<p>Encrypted attributes are configured to be automatically
<a href="configuring.html#config-filter-parameters">filtered</a> out of the Rails logs. So
sensitive information, like encrypted emails or credit card numbers, isn&#39;t
stored in your logs. For example, if you are filtering the <code>email</code> field, you
will see something like this in the logs: <code>Parameters: {&quot;email&quot;=&gt;&quot;[FILTERED]&quot;,
...}</code>.</p>

<p>In case you need to disable filtering of encrypted parameters, you can use the
following configuration:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/application.rb
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_add_to_filter_parameters'>add_to_filter_parameters</span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>

<p>When filtering is enabled, if you want to exclude specific attributes from
automatic filtering, you can use this configuration:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_excluded_from_filter_parameters'>excluded_from_filter_parameters</span> <span class='op'>=</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_catchphrase'>catchphrase</span>]</code></pre>

<p>NOTE: When generating the filter parameter, Rails will use the model name as a
prefix. E.g: For <code>User#email</code>, the filter parameter will be <code>user.email</code>.</p>

<h3>Action Text</h3>

<p>You can encrypt Action Text attributes by passing <code>encrypted: true</code> in their
declaration.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Message</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_rich_text'>has_rich_text</span> <span class='symbeg'>:</span><span class='id identifier rubyid_content'>content</span><span class='comma'>,</span> <span class='label'>encrypted:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: Passing individual encryption options to Action Text attributes is not
supported. It will use non-deterministic encryption with the global encryption
options configured.</p>

<h3>Fixtures</h3>

<p>To allow your tests can use plain text values in the YAML fixture files for
encrypted attributes, you can configure fixtures to be automatically encrypted
by adding this configuration to your <code>config/environments/test.rb</code> file:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_configure'>configure</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_encrypt_fixtures'>encrypt_fixtures</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='comment'># ...
</span><span class='kw'>end</span></code></pre>

<p>Without this setting, Rails would load fixture values as is. This wouldn&#39;t work
for encrypted attributes and Active Record Encryption expects a JSON value in
that column. However, when <code>encrypt_fixtures</code> is enabled, all the encryptable
attributes will be automatically encrypted  and also seamlessly decrypted,
according to the encryption settings defined in the model.</p>

<h4>Action Text Fixtures</h4>

<p>To encrypt Action Text fixtures, you can place them in
<code>fixtures/action_text/encrypted_rich_texts.yml</code>.</p>

<h3>Encoding</h3>

<p>When encrypting strings non-deterministically, their original encoding is
preserved automatically.</p>

<p>For deterministic encryption, Rails stores the string encoding alongside the
ciphertext. However, to ensure consistent encryption output, especially for
querying or enforcing uniqueness, the library forces UTF-8 encoding by default.
This avoids producing different ciphertexts for identical strings with different
encodings.</p>

<p>You can customize this behavior. To change the default forced encoding:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_forced_encoding_for_deterministic_encryption'>forced_encoding_for_deterministic_encryption</span> <span class='op'>=</span> <span class='const'>Encoding</span><span class='op'>::</span><span class='const'>US_ASCII</span></code></pre>

<p>To disable forced encoding and preserve the original encoding in all cases:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_forced_encoding_for_deterministic_encryption'>forced_encoding_for_deterministic_encryption</span> <span class='op'>=</span> <span class='kw'>nil</span></code></pre>

<h3>Compression</h3>

<p>Active Record Encryption enables compression of encrypted payloads by default.
This can save up to 30% of the storage space for larger payloads.</p>

<p>NOTE: Compression is enabled by default but <em>not</em> applied to all payloads. It is
based on a size threshold (such as 140 bytes), which is used as a heuristic to
determine if compression is &quot;worth it&quot;.</p>

<p>You can disable compression by setting the <code>compress</code> option to <code>false</code> when
encrypting attributes:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_content'>content</span><span class='comma'>,</span> <span class='label'>compress:</span> <span class='kw'>false</span>
<span class='kw'>end</span></code></pre>

<p>You can also configure the algorithm used for the compression. The default
compressor is <a href="https://en.wikipedia.org/wiki/Zlib"><code>Zlib</code></a>. You can implement
your own compressor by creating a class or module that responds to <code>deflate</code> and
<code>inflate</code> methods. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>zstd-ruby</span><span class='tstring_end'>&quot;</span></span>

<span class='kw'>module</span> <span class='const'>ZstdCompressor</span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_deflate'>deflate</span>(<span class='id identifier rubyid_data'>data</span>)
    <span class='const'>Zstd</span>.<span class='id identifier rubyid_compress'>compress</span>(<span class='id identifier rubyid_data'>data</span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_inflate'>inflate</span>(<span class='id identifier rubyid_data'>data</span>)
    <span class='const'>Zstd</span>.<span class='id identifier rubyid_decompress'>decompress</span>(<span class='id identifier rubyid_data'>data</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>compressor:</span> <span class='const'>ZstdCompressor</span>
<span class='kw'>end</span></code></pre>

<p>You can also configure the desired compression method globally:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_compressor'>compressor</span> <span class='op'>=</span> <span class='const'>ZstdCompressor</span></code></pre>

<h3>Using the API</h3>

<p>Active Record Encryption is meant to be used declaratively, but there is also an
API for debugging or advanced use cases.</p>

<p>You can encrypt and decrypt all relevant attributes of an <code>article</code> model like
this:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_article'>article</span>.<span class='id identifier rubyid_encrypt'>encrypt</span> <span class='comment'># encrypt or re-encrypt all the encryptable attributes
</span><span class='id identifier rubyid_article'>article</span>.<span class='id identifier rubyid_decrypt'>decrypt</span> <span class='comment'># decrypt all the encryptable attributes</span></code></pre>

<p>You can check whether a given attribute is encrypted:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_article'>article</span>.<span class='id identifier rubyid_encrypted_attribute?'>encrypted_attribute?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span>)</code></pre>

<p>You can read the <code>ciphertext</code> for an attribute:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_article'>article</span>.<span class='id identifier rubyid_ciphertext_for'>ciphertext_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span>)</code></pre>

<h2>Migrating Existing Data</h2>

<h3>Support for Unencrypted Data</h3>

<p>To ease the transition from unencrypted to encrypted attributes in your Rails
application, you can enable support for unencrypted data with:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_support_unencrypted_data'>support_unencrypted_data</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>When enabled:</p>

<ul>
<li><p>Reading attributes that are still unencrypted will succeed without raising
errors.</p></li>
<li><p>Queries on deterministically encrypted attributes can match both encrypted and
cleartext values, if you also enable <code>extended_queries</code>:</p></li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_extend_queries'>extend_queries</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>This setup is intended only for migration periods during which both encrypted
and unencrypted data need to coexist in your application. Both options default
to <code>false</code>, which is the recommended long-term configuration to ensure data is
fully encrypted and enforced.</p>

<h3>Support for Previous Encryption Schemes</h3>

<p>Changing encryption properties of attributes can break existing data. For
example, imagine you want to make a deterministic attribute non-deterministic.
If you change the declaration in the model, reading existing ciphertexts will
fail because the encryption method is different now.</p>

<p>To support these situations, you can specify previous encryption schemes to be
used globally or on a per-attribute basis.</p>

<p>Once you configure the previous scheme, the following will be supported:</p>

<ul>
<li><p>When reading encrypted data, Active Record Encryption will try previous
encryption schemes if the current scheme doesn&#39;t work.</p></li>
<li><p>When querying deterministic data, it will add ciphertexts using previous
schemes so that queries work seamlessly with data encrypted with different
schemes.</p></li>
</ul>

<p>You need to enable <code>extended_queries</code> configuration for this to work:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_extend_queries'>extend_queries</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>Next, let&#39;s see how to configure previous encryption schemes.</p>

<h4>Global Previous Encryption Schemes</h4>

<p>You can add previous encryption schemes by adding them as a list of properties
using the <code>previous</code> config property in your <code>config/application.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_previous'>previous</span> <span class='op'>=</span> [ { <span class='label'>key_provider:</span> <span class='const'>MyOldKeyProvider</span>.<span class='id identifier rubyid_new'>new</span> } ]</code></pre>

<h4>Per-attribute Previous Encryption Schemes</h4>

<p>Use the <code>previous</code> option when declaring the encrypted attribute:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Article</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='label'>deterministic:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>previous:</span> { <span class='label'>deterministic:</span> <span class='kw'>false</span> }
<span class='kw'>end</span></code></pre>

<h4>Encryption Schemes and Determinism</h4>

<p>With deterministic encryption, you typically want ciphertexts to remain
constant. So when changing encryption schemes, non-deterministic and
deterministic encryption behave differently.</p>

<ul>
<li><p>With <strong>non-deterministic encryption</strong>, new information will always be
encrypted with the <em>newest</em> (current) encryption scheme.</p></li>
<li><p>With <strong>deterministic encryption</strong>, new information will be encrypted with the
<em>oldest</em> encryption scheme by default.</p></li>
</ul>

<p>It is possible to change this behavior for deterministic encryption to use the
<em>newest</em> encryption scheme for encrypting new data like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Article</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='label'>deterministic:</span> { <span class='label'>fixed:</span> <span class='kw'>false</span> }
<span class='kw'>end</span></code></pre>

<h2>Encryption Contexts</h2>

<p>An encryption context defines the encryption components that are used at a given
moment. There is a default encryption context based on your global
configuration, but you can also configure a custom context for a given attribute
or when running a specific block of code.</p>

<p>NOTE: Encryption contexts are a flexible but advanced configuration mechanism.
Most users would not need to use them.</p>

<p>The main components of encryption contexts are:</p>

<ul>
<li><code>encryptor</code>: exposes the internal API for encrypting and decrypting data.  It
interacts with a <code>key_provider</code> to build encrypted messages and deal with
their serialization. The encryption/decryption itself is done by the <code>cipher</code>
and the serialization by <code>message_serializer</code>.</li>
<li><code>cipher</code>: the encryption algorithm itself (AES 256 GCM).</li>
<li><code>key_provider</code>: serves encryption and decryption keys.</li>
<li><code>message_serializer</code>: serializes and deserializes encrypted payloads.</li>
</ul>

<p>WARNING: If you decide to build your own <code>message_serializer</code>, it&#39;s important to
use safe mechanisms that can&#39;t deserialize arbitrary objects. A commonly
supported scenario is encrypting existing unencrypted data. An attacker can
leverage this to enter a tampered payload before encryption takes place and
perform RCE attacks. This means custom serializers should avoid <code>Marshal</code>,
<code>YAML.load</code> (use <code>YAML.safe_load</code>  instead), or <code>JSON.load</code> (use <code>JSON.parse</code>
instead).</p>

<h3>Built-In Encryption Context</h3>

<p>The global encryption context is the one used by default and is configured with
other configuration properties in your <code>config/application.rb</code> or environment
config files.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_key_provider'>key_provider</span> <span class='op'>=</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)">Encryption</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption/EnvelopeEncryptionKeyProvider.html" title="ActiveRecord::Encryption::EnvelopeEncryptionKeyProvider (class)">EnvelopeEncryptionKeyProvider</a></span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_encryptor'>encryptor</span> <span class='op'>=</span> <span class='const'>MyEncryptor</span>.<span class='id identifier rubyid_new'>new</span></code></pre>

<p>You can use
<a href="https://api.rubyonrails.org/classes/ActiveRecord/Encryption/Contexts.html#method-i-with_encryption_context"><code>with_encryption_context</code></a>
to override any of the properties of the encryption context.</p>

<h3>Encryption Context with a Block of Code</h3>

<p>You can set an encryption context for a given block of code using
<code>with_encryption_context</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)">Encryption</a></span>.<span class='id identifier rubyid_with_encryption_context'>with_encryption_context</span>(<span class='label'>encryptor:</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)">Encryption</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption/NullEncryptor.html" title="ActiveRecord::Encryption::NullEncryptor (class)">NullEncryptor</a></span>.<span class='id identifier rubyid_new'>new</span>) <span class='kw'>do</span>
  <span class='comment'># ...
</span><span class='kw'>end</span></code></pre>

<h3>Per-attribute Encryption Contexts</h3>

<p>You can override encryption context configuration by passing options in the
attribute declaration:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Attribute</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='label'>encryptor:</span> <span class='const'>MyAttributeEncryptor</span>.<span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span></code></pre>

<h3>Encryption Context to Disable Encryption</h3>

<p>You can run code without encryption:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)">Encryption</a></span>.<span class='id identifier rubyid_without_encryption'>without_encryption</span> <span class='kw'>do</span>
  <span class='comment'># ...
</span><span class='kw'>end</span></code></pre>

<p>This means that reading encrypted text will return the ciphertext, and saved
content will be stored unencrypted.</p>

<h3>Encryption Context to Protect Encrypted Data</h3>

<p>You can run code in a block without encryption but prevent overwriting encrypted
content:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)">Encryption</a></span>.<span class='id identifier rubyid_protecting_encrypted_data'>protecting_encrypted_data</span> <span class='kw'>do</span>
  <span class='comment'># ...
</span><span class='kw'>end</span></code></pre>

<p>This can be handy if you want to protect encrypted data while running arbitrary
code against it (e.g. in a Rails console).</p>

<h2>Key Management</h2>

<p>Key providers implement key management strategies. You can configure key
providers globally or on a per-attribute basis.</p>

<h3>Built-in Key Providers</h3>

<h4>DerivedSecretKeyProvider</h4>

<p>The
<a href="https://api.rubyonrails.org/classes/ActiveRecord/Encryption/DerivedSecretKeyProvider.html"><code>DerivedSecretKeyProvider</code></a>
serves keys derived from the provided passwords using PBKDF2. This is the key
provider configured by default.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_key_provider'>key_provider</span> <span class='op'>=</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)">Encryption</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption/DerivedSecretKeyProvider.html" title="ActiveRecord::Encryption::DerivedSecretKeyProvider (class)">DerivedSecretKeyProvider</a></span>.<span class='id identifier rubyid_new'><a href="ActiveRecord/Encryption/DerivedSecretKeyProvider.html#new-class_method" title="ActiveRecord::Encryption::DerivedSecretKeyProvider.new (method)">new</a></span>([<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>some passwords</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>to derive keys from. </span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>These should be in</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>credentials</span><span class='tstring_end'>&quot;</span></span>])</code></pre>

<p>NOTE: By default, <code>active_record.encryption</code> configures a
<code>DerivedSecretKeyProvider</code> with the keys defined in
<code>active_record.encryption.primary_key</code>.</p>

<h4>EnvelopeEncryptionKeyProvider</h4>

<p>The
<a href="https://api.rubyonrails.org/classes/ActiveRecord/Encryption/EnvelopeEncryptionKeyProvider.html"><code>EnvelopeEncryptionKeyProvider</code></a>
implements a simple <a href="https://en.wikipedia.org/wiki/Hybrid_cryptosystem#Envelope_encryption">envelope
encryption</a>
strategy, where the data is encrypted with a key, which in turn is also
encrypted.</p>

<p>The <code>EnvelopeEncryptionKeyProvider</code> generates a random key for each data
encryption operation. It stores the data-key with the data itself. Then, the
data-key is also encrypted with a primary key defined in the credential
<code>active_record.encryption.primary_key</code>.</p>

<p>You can configure Active Record to use this key provider by adding this to your
<code>config/application.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_key_provider'>key_provider</span> <span class='op'>=</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)">Encryption</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption/EnvelopeEncryptionKeyProvider.html" title="ActiveRecord::Encryption::EnvelopeEncryptionKeyProvider (class)">EnvelopeEncryptionKeyProvider</a></span>.<span class='id identifier rubyid_new'>new</span></code></pre>

<p>As with other built-in key providers, you can provide a list of primary keys in
<code>active_record.encryption.primary_key</code> to implement key-rotation schemes.</p>

<h3>Custom Key Providers</h3>

<p>For more advanced key-management schemes, you can configure a custom key
provider in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)">Encryption</a></span>.<span class='id identifier rubyid_key_provider'>key_provider</span> <span class='op'>=</span> <span class='const'>MyKeyProvider</span>.<span class='id identifier rubyid_new'>new</span></code></pre>

<p>A key provider must implement this interface:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MyKeyProvider</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_encryption_key'>encryption_key</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_decryption_keys'>decryption_keys</span>(<span class='id identifier rubyid_encrypted_message'>encrypted_message</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Both methods return <a href="ActiveRecord/Encryption/Key.html" title="ActiveRecord::Encryption::Key (class)"><code>::ActiveRecord::Encryption::Key</code></a> objects:</p>

<ul>
<li><code>encryption_key</code> returns the key used for encrypting some content</li>
<li><code>decryption_keys</code> returns a list of potential keys for decrypting a given
ciphertext.</li>
</ul>

<p>A key can include arbitrary tags that will be stored unencrypted with the
message. You can use
<a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Encryption/Message.html"><a href="ActiveRecord/Encryption/Message.html#headers-instance_method" title="ActiveRecord::Encryption::Message#headers (method)">ActiveRecord::Encryption::Message#headers</a></a>
to examine those values when decrypting.</p>

<h3>Attribute-specific Key Providers</h3>

<p>You can configure a key provider on a per-attribute basis with the
<code>key_provider</code> option. For example, assuming you have defined a custom key
provider called <code>ArticleKeyProvider</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_summary'>summary</span><span class='comma'>,</span> <span class='label'>key_provider:</span> <span class='const'>ArticleKeyProvider</span>.<span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span></code></pre>

<h3>Attribute-specific Keys</h3>

<p>You can configure a specific key for a given attribute using the <code>key</code> option:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_summary'>summary</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SOME_SECRET_KEY_FOR_ARTICLE_SUMMARIES</span><span class='tstring_end'>&quot;</span></span>]
<span class='kw'>end</span></code></pre>

<p>Active Record will use the key passed to <code>encrypts</code> to encrypt and decrypt the
<code>summary</code> attribute above.</p>

<h3>Rotating Keys</h3>

<p>Active Record Encryption can work with lists of keys to support implementing key
rotation schemes. The reason to rotate keys may be as part of your
organization&#39;s security policy or if you suspect a key may be compromised.</p>

<p>In the example below, the <em>last key</em> is used for encrypting new content and all
keys are tried when decrypting content until one works.</p>

<pre class="code yml"><code class="yml">active_record_encryption:
  primary_key:
    - a1cc4d7b9f420e40a337b9e68c5ecec6 # Previous keys can still decrypt existing content
    - bc17e7b413fd4720716a7633027f8cc4 # Active, encrypts new content
  key_derivation_salt: a3226b97b3b2f8372d1fc6d497a0c0d3
</code></pre>

<p>This enables key rotation workflow where you keep a short list of keys by adding
new keys, re-encrypting content, and deleting old keys.</p>

<p>NOTE: Rotating keys is not supported for deterministic encryption.</p>

<h3>Storing Key References</h3>

<p>You can store a reference to the encryption key in the encrypted message itself.
The advantage of doing this is that decryption can be more performant as the
system does not have to try a list of keys to find one that works. The tradeoff
is that the encryption data will be a bit larger.</p>

<p>In order to store a key reference, you need to enable this configuration:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_store_key_references'>store_key_references</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>