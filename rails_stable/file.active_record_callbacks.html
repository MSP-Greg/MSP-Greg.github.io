<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Active Record Callbacks &mdash; Rails 8-1-stable</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "active_record_callbacks",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 8-1-stable</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Active Record Callbacks&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1>Active Record Callbacks</h1>

<p>This guide teaches you how to hook into the life cycle of your Active Record
objects.</p>

<p>After reading this guide, you will know:</p>

<ul>
<li>When certain events occur during the life of an Active Record object.</li>
<li>How to register, run, and skip callbacks that respond to these events.</li>
<li>How to create relational, association, conditional, and transactional
callbacks.</li>
<li>How to create objects that encapsulate common behavior for your callbacks to
be reused.</li>
</ul>

<hr>

<h2>The Object Life Cycle</h2>

<p>During the normal operation of a <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> application, objects may be <a href="active_record_basics.html#crud-reading-and-writing-data">created,
updated, and
destroyed</a>. Active
Record provides hooks into this object life cycle so that you can control your
application and its data.</p>

<p>Callbacks allow you to trigger logic before or after a change to an object&#39;s
state. They are methods that get called at certain moments of an object&#39;s life
cycle. With callbacks it is possible to write code that will run whenever an
Active Record object is initialized, created, saved, updated, deleted,
validated, or loaded from the database.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>BirthdayCake</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_create'>after_create</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Congratulations, the callback has run!</span><span class='tstring_end'>&quot;</span></span>) }
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; BirthdayCake.create
Congratulations, the callback has run!
</code></pre>

<p>As you will see, there are many life cycle events and multiple options to hook
into these — either before, after, or even around them.</p>

<h2>Callback Registration</h2>

<p>To use the available callbacks, you need to implement and register them.
Implementation can be done in a multitude of ways like using ordinary methods,
blocks and procs, or defining custom callback objects using classes or modules.
Let&#39;s go through each of these implementation techniques.</p>

<p>You can register the callbacks with a <strong>macro-style class method that calls an
ordinary method</strong> for implementation.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_validates'>validates</span> <span class='symbeg'>:</span><span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>presence:</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_before_validation'>before_validation</span> <span class='symbeg'>:</span><span class='id identifier rubyid_ensure_username_has_value'>ensure_username_has_value</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_ensure_username_has_value'>ensure_username_has_value</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_username'>username</span>.<span class='id identifier rubyid_blank?'>blank?</span>
        <span class='kw'>self</span>.<span class='id identifier rubyid_username'>username</span> <span class='op'>=</span> <span class='id identifier rubyid_email'>email</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The <strong>macro-style class methods can also receive a block</strong>. Consider using this
style if the code inside your block is so short that it fits in a single line:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_validates'>validates</span> <span class='symbeg'>:</span><span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>presence:</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_before_validation'>before_validation</span> <span class='kw'>do</span>
    <span class='kw'>self</span>.<span class='id identifier rubyid_username'>username</span> <span class='op'>=</span> <span class='id identifier rubyid_email'>email</span> <span class='kw'>if</span> <span class='id identifier rubyid_username'>username</span>.<span class='id identifier rubyid_blank?'>blank?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Alternatively, you can <strong>pass a proc to the callback</strong> to be triggered.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_validates'>validates</span> <span class='symbeg'>:</span><span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>presence:</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_before_validation'>before_validation</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_user'>user</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_username'>username</span> <span class='op'>=</span> <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_email'>email</span> <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_username'>username</span>.<span class='id identifier rubyid_blank?'>blank?</span> }
<span class='kw'>end</span></code></pre>

<p>Lastly, you can define <a href="#callback-objects"><strong>a custom callback object</strong></a>, as
shown below. We will cover these later in more detail.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_validates'>validates</span> <span class='symbeg'>:</span><span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>presence:</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_before_validation'>before_validation</span> <span class='const'>AddUsername</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>AddUsername</span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_before_validation'>before_validation</span>(<span class='id identifier rubyid_record'>record</span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_record'>record</span>.<span class='id identifier rubyid_username'>username</span>.<span class='id identifier rubyid_blank?'>blank?</span>
      <span class='id identifier rubyid_record'>record</span>.<span class='id identifier rubyid_username'>username</span> <span class='op'>=</span> <span class='id identifier rubyid_record'>record</span>.<span class='id identifier rubyid_email'>email</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Registering Callbacks to Fire on Life Cycle Events</h3>

<p>Callbacks can also be registered to only fire on certain life cycle events, this
can be done using the <code>:on</code> option and allows complete control over when and in
what context your callbacks are triggered.</p>

<p>NOTE: A context is like a category or a scenario in which you want certain
validations to apply. When you validate an ActiveRecord model, you can specify a
context to group validations. This allows you to have different sets of
validations that apply in different situations. In Rails, there are certain
default contexts for validations like :create, :update, and :save.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_validates'>validates</span> <span class='symbeg'>:</span><span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>presence:</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_before_validation'>before_validation</span> <span class='symbeg'>:</span><span class='id identifier rubyid_ensure_username_has_value'>ensure_username_has_value</span><span class='comma'>,</span> <span class='label'>on:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_create'>create</span>

  <span class='comment'># :on takes an array as well
</span>  <span class='id identifier rubyid_after_validation'>after_validation</span> <span class='symbeg'>:</span><span class='id identifier rubyid_set_location'>set_location</span><span class='comma'>,</span> <span class='label'>on:</span> [ <span class='symbeg'>:</span><span class='id identifier rubyid_create'>create</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update'>update</span> ]

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_ensure_username_has_value'>ensure_username_has_value</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_username'>username</span>.<span class='id identifier rubyid_blank?'>blank?</span>
        <span class='kw'>self</span>.<span class='id identifier rubyid_username'>username</span> <span class='op'>=</span> <span class='id identifier rubyid_email'>email</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_set_location'>set_location</span>
      <span class='kw'>self</span>.<span class='id identifier rubyid_location'>location</span> <span class='op'>=</span> <span class='const'>LocationService</span>.<span class='id identifier rubyid_query'>query</span>(<span class='kw'>self</span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: It is considered good practice to declare callback methods as private. If
left public, they can be called from outside of the model and violate the
principle of object encapsulation.</p>

<p>WARNING. Refrain from using methods like <code>update</code>, <code>save</code>, or any other methods
that cause side effects on the object within your callback methods. <br><br>
For instance, avoid calling <code>update(attribute: &quot;value&quot;)</code> inside a callback. This
practice can modify the model&#39;s state and potentially lead to unforeseen side
effects during commit. <br><br> Instead, you can assign values directly (e.g.,
<code>self.attribute = &quot;value&quot;</code>) in <code>before_create</code>, <code>before_update</code>, or earlier
callbacks for a safer approach.</p>

<h2>Available Callbacks</h2>

<p>Here is a list with all the available Active Record callbacks, listed <strong>in the
order in which they will get called</strong> during the respective operations:</p>

<h3>Creating an Object</h3>

<ul>
<li><a href="https://api.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-before_validation"><code>before_validation</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-after_validation"><code>after_validation</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_save"><code>before_save</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_save"><code>around_save</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_create"><code>before_create</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_create"><code>around_create</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_create"><code>after_create</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_save"><code>after_save</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> / <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a></li>
</ul>

<p>See the <a href="active_record_callbacks.html#after-commit-and-after-rollback"><code>after_commit</code> / <code>after_rollback</code>
section</a> for
examples using these two callbacks.</p>

<p>There are examples below that show how to use these callbacks. We&#39;ve grouped
them by the operation they are associated with, and lastly show how they can be
used in combination.</p>

<h4>Validation Callbacks</h4>

<p>Validation callbacks are triggered whenever the record is validated directly via
the
<a href="https://api.rubyonrails.org/classes/ActiveModel/Validations.html#method-i-valid-3F"><code>valid?</code></a>
( or its alias
<a href="https://api.rubyonrails.org/classes/ActiveModel/Validations.html#method-i-validate"><code>validate</code></a>)
or
<a href="https://api.rubyonrails.org/classes/ActiveModel/Validations.html#method-i-invalid-3F"><code>invalid?</code></a>
method, or indirectly via <code>create</code>, <code>update</code>, or <code>save</code>. They are called before
and after the validation phase.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_validates'>validates</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>presence:</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_before_validation'>before_validation</span> <span class='symbeg'>:</span><span class='id identifier rubyid_titleize_name'>titleize_name</span>
  <span class='id identifier rubyid_after_validation'>after_validation</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_errors'>log_errors</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_titleize_name'>titleize_name</span>
      <span class='kw'>self</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_downcase'>downcase</span>.<span class='id identifier rubyid_titleize'>titleize</span> <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_present?'>present?</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Name titleized to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_log_errors'>log_errors</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_errors'>errors</span>.<span class='id identifier rubyid_any?'>any?</span>
        <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_error'>error</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Validation failed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_errors'>errors</span>.<span class='id identifier rubyid_full_messages'>full_messages</span>.<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span>)<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.new(name: &quot;&quot;, email: &quot;john.doe@example.com&quot;, password: &quot;abc123456&quot;)
=&gt; #&lt;User id: nil, email: &quot;john.doe@example.com&quot;, created_at: nil, updated_at: nil, name: &quot;&quot;&gt;

irb&gt; user.valid?
Name titleized to
Validation failed: Name can&#39;t be blank
=&gt; false
</code></pre>

<h4>Save Callbacks</h4>

<p>Save callbacks are triggered whenever the record is persisted (i.e. &quot;saved&quot;) to
the underlying database, via the <code>create</code>, <code>update</code>, or <code>save</code> methods. They are
called before, after, and around the object is saved.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_save'>before_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_hash_password'>hash_password</span>
  <span class='id identifier rubyid_around_save'>around_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_saving'>log_saving</span>
  <span class='id identifier rubyid_after_save'>after_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update_cache'>update_cache</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_hash_password'>hash_password</span>
      <span class='kw'>self</span>.<span class='id identifier rubyid_password_digest'>password_digest</span> <span class='op'>=</span> <span class='const'>BCrypt</span><span class='op'>::</span><span class='const'>Password</span>.<span class='id identifier rubyid_create'>create</span>(<span class='id identifier rubyid_password'>password</span>)
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Password hashed for user with email: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_log_saving'>log_saving</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Saving user with email: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>yield</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User saved with email: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_update_cache'>update_cache</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_cache'><a href="Rails.html#cache-class_method" title="Rails.cache (method)">cache</a></span>.<span class='id identifier rubyid_write'>write</span>([<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user_data</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='kw'>self</span>]<span class='comma'>,</span> <span class='id identifier rubyid_attributes'>attributes</span>)
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Update Cache</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.create(name: &quot;Jane Doe&quot;, password: &quot;password&quot;, email: &quot;jane.doe@example.com&quot;)

Password hashed for user with email: jane.doe@example.com
Saving user with email: jane.doe@example.com
User saved with email: jane.doe@example.com
Update Cache
=&gt; #&lt;User id: 1, email: &quot;jane.doe@example.com&quot;, created_at: &quot;2024-03-20 16:02:43.685500000 +0000&quot;, updated_at: &quot;2024-03-20 16:02:43.685500000 +0000&quot;, name: &quot;Jane Doe&quot;&gt;
</code></pre>

<h4>Create Callbacks</h4>

<p>Create callbacks are triggered whenever the record is persisted (i.e. &quot;saved&quot;)
to the underlying database <strong>for the first time</strong> — in other words, when we&#39;re
saving a new record, via the <code>create</code> or <code>save</code> methods. They are called before,
after and around the object is created.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_create'>before_create</span> <span class='symbeg'>:</span><span class='id identifier rubyid_set_default_role'>set_default_role</span>
  <span class='id identifier rubyid_around_create'>around_create</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_creation'>log_creation</span>
  <span class='id identifier rubyid_after_create'>after_create</span> <span class='symbeg'>:</span><span class='id identifier rubyid_send_welcome_email'>send_welcome_email</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_set_default_role'>set_default_role</span>
      <span class='kw'>self</span>.<span class='id identifier rubyid_role'>role</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User role set to default: user</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_log_creation'>log_creation</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Creating user with email: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>yield</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User created with email: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_send_welcome_email'>send_welcome_email</span>
      <span class='const'>UserMailer</span>.<span class='id identifier rubyid_welcome_email'>welcome_email</span>(<span class='kw'>self</span>).<span class='id identifier rubyid_deliver_later'>deliver_later</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User welcome email sent to: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.create(name: &quot;John Doe&quot;, email: &quot;john.doe@example.com&quot;)

User role set to default: user
Creating user with email: john.doe@example.com
User created with email: john.doe@example.com
User welcome email sent to: john.doe@example.com
=&gt; #&lt;User id: 10, email: &quot;john.doe@example.com&quot;, created_at: &quot;2024-03-20 16:19:52.405195000 +0000&quot;, updated_at: &quot;2024-03-20 16:19:52.405195000 +0000&quot;, name: &quot;John Doe&quot;&gt;
</code></pre>

<h3>Updating an Object</h3>

<p>Update callbacks are triggered whenever an <strong>existing</strong> record is persisted
(i.e. &quot;saved&quot;) to the underlying database. They are called before, after and
around the object is updated.</p>

<ul>
<li><a href="https://api.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-before_validation"><code>before_validation</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-after_validation"><code>after_validation</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_save"><code>before_save</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_save"><code>around_save</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_update"><code>before_update</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_update"><code>around_update</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_update"><code>after_update</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_save"><code>after_save</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> / <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a></li>
</ul>

<p>WARNING: The <code>after_save</code> callback is triggered on both create and update
operations. However, it consistently executes after the more specific callbacks
<code>after_create</code> and <code>after_update</code>, regardless of the sequence in which the macro
calls were made. Similarly, before and around save callbacks follow the same
rule: <code>before_save</code> runs before create/update, and <code>around_save</code> runs around
create/update operations. It&#39;s important to note that save callbacks will always
run before/around/after the more specific create/update callbacks.</p>

<p>We&#39;ve already covered <a href="#validation-callbacks">validation</a> and
<a href="#save-callbacks">save</a> callbacks. See the <a href="#after-commit-and-after-rollback"><code>after_commit</code> /
<code>after_rollback</code> section</a> for examples using
these two callbacks.</p>

<h4>Update Callbacks</h4>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_update'>before_update</span> <span class='symbeg'>:</span><span class='id identifier rubyid_check_role_change'>check_role_change</span>
  <span class='id identifier rubyid_around_update'>around_update</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_updating'>log_updating</span>
  <span class='id identifier rubyid_after_update'>after_update</span> <span class='symbeg'>:</span><span class='id identifier rubyid_send_update_email'>send_update_email</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_check_role_change'>check_role_change</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_role_changed?'>role_changed?</span>
        <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User role changed to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_role'>role</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_log_updating'>log_updating</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Updating user with email: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>yield</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User updated with email: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_send_update_email'>send_update_email</span>
      <span class='const'>UserMailer</span>.<span class='id identifier rubyid_update_email'>update_email</span>(<span class='kw'>self</span>).<span class='id identifier rubyid_deliver_later'>deliver_later</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Update email sent to: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.find(1)
=&gt; #&lt;User id: 1, email: &quot;john.doe@example.com&quot;, created_at: &quot;2024-03-20 16:19:52.405195000 +0000&quot;, updated_at: &quot;2024-03-20 16:19:52.405195000 +0000&quot;, name: &quot;John Doe&quot;, role: &quot;user&quot; &gt;

irb&gt; user.update(role: &quot;admin&quot;)
User role changed to admin
Updating user with email: john.doe@example.com
User updated with email: john.doe@example.com
Update email sent to: john.doe@example.com
</code></pre>

<h4>Using a Combination of Callbacks</h4>

<p>Often, you will need to use a combination of callbacks to achieve the desired
behavior. For example, you may want to send a confirmation email after a user is
created, but only if the user is new and not being updated. When a user is
updated, you may want to notify an admin if critical information is changed. In
this case, you can use <code>after_create</code> and <code>after_update</code> callbacks together.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_create'>after_create</span> <span class='symbeg'>:</span><span class='id identifier rubyid_send_confirmation_email'>send_confirmation_email</span>
  <span class='id identifier rubyid_after_update'>after_update</span> <span class='symbeg'>:</span><span class='id identifier rubyid_notify_admin_if_critical_info_updated'>notify_admin_if_critical_info_updated</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_send_confirmation_email'>send_confirmation_email</span>
      <span class='const'>UserMailer</span>.<span class='id identifier rubyid_confirmation_email'>confirmation_email</span>(<span class='kw'>self</span>).<span class='id identifier rubyid_deliver_later'>deliver_later</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Confirmation email sent to: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_notify_admin_if_critical_info_updated'>notify_admin_if_critical_info_updated</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_saved_change_to_email?'>saved_change_to_email?</span> <span class='op'>||</span> <span class='id identifier rubyid_saved_change_to_phone_number?'>saved_change_to_phone_number?</span>
        <span class='const'>AdminMailer</span>.<span class='id identifier rubyid_user_critical_info_updated'>user_critical_info_updated</span>(<span class='kw'>self</span>).<span class='id identifier rubyid_deliver_later'>deliver_later</span>
        <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Notification sent to admin about critical info update for: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.create(name: &quot;John Doe&quot;, email: &quot;john.doe@example.com&quot;)
Confirmation email sent to: john.doe@example.com
=&gt; #&lt;User id: 1, email: &quot;john.doe@example.com&quot;, ...&gt;

irb&gt; user.update(email: &quot;john.doe.new@example.com&quot;)
Notification sent to admin about critical info update for: john.doe.new@example.com
=&gt; true
</code></pre>

<h3>Destroying an Object</h3>

<p>Destroy callbacks are triggered whenever a record is destroyed, but ignored when
a record is deleted. They are called before, after and around the object is
destroyed.</p>

<ul>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_destroy"><code>before_destroy</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_destroy"><code>around_destroy</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_destroy"><code>after_destroy</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> / <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a></li>
</ul>

<p>Find <a href="#after-commit-and-after-rollback">examples for using <code>after_commit</code> /
<code>after_rollback</code></a>.</p>

<h4>Destroy Callbacks</h4>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_destroy'>before_destroy</span> <span class='symbeg'>:</span><span class='id identifier rubyid_check_admin_count'>check_admin_count</span>
  <span class='id identifier rubyid_around_destroy'>around_destroy</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_destroy_operation'>log_destroy_operation</span>
  <span class='id identifier rubyid_after_destroy'>after_destroy</span> <span class='symbeg'>:</span><span class='id identifier rubyid_notify_users'>notify_users</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_check_admin_count'>check_admin_count</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_admin?'>admin?</span> <span class='op'>&amp;&amp;</span> <span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>role:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_count'>count</span> <span class='op'>==</span> <span class='int'>1</span>
        <span class='id identifier rubyid_throw'>throw</span> <span class='symbeg'>:</span><span class='id identifier rubyid_abort'>abort</span>
      <span class='kw'>end</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Checked the admin count</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_log_destroy_operation'>log_destroy_operation</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>About to destroy user with ID </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>yield</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User with ID </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'> destroyed successfully</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_notify_users'>notify_users</span>
      <span class='const'>UserMailer</span>.<span class='id identifier rubyid_deletion_email'>deletion_email</span>(<span class='kw'>self</span>).<span class='id identifier rubyid_deliver_later'>deliver_later</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Notification sent to other users about user deletion</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.find(1)
=&gt; #&lt;User id: 1, email: &quot;john.doe@example.com&quot;, created_at: &quot;2024-03-20 16:19:52.405195000 +0000&quot;, updated_at: &quot;2024-03-20 16:19:52.405195000 +0000&quot;, name: &quot;John Doe&quot;, role: &quot;admin&quot;&gt;

irb&gt; user.destroy
Checked the admin count
About to destroy user with ID 1
User with ID 1 destroyed successfully
Notification sent to other users about user deletion
</code></pre>

<h3><code>after_initialize</code> and <code>after_find</code></h3>

<p>Whenever an Active Record object is instantiated, either by directly using <code>new</code>
or when a record is loaded from the database, the <a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_initialize"><code>after_initialize</code></a>
callback will be called. It can be useful to avoid the need to directly override
your Active Record <code>initialize</code> method.</p>

<p>When loading a record from the database the <a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_find"><code>after_find</code></a> callback will be
called. <code>after_find</code> is called before <code>after_initialize</code> if both are defined.</p>

<p>NOTE: The <code>after_initialize</code> and <code>after_find</code> callbacks have no <code>before_*</code>
counterparts.</p>

<p>They can be registered just like the other Active Record callbacks.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_initialize'>after_initialize</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_user'>user</span><span class='op'>|</span>
    <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You have initialized an object!</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_after_find'>after_find</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_user'>user</span><span class='op'>|</span>
    <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You have found an object!</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; User.new
You have initialized an object!
=&gt; #&lt;User id: nil&gt;

irb&gt; User.first
You have found an object!
You have initialized an object!
=&gt; #&lt;User id: 1&gt;
</code></pre>

<h3><code>after_touch</code></h3>

<p>The <a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_touch"><code>after_touch</code></a> callback will be called whenever an Active Record object
is touched. You can <a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-touch">read more about <code>touch</code> in the API
docs</a>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_touch'>after_touch</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_user'>user</span><span class='op'>|</span>
    <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You have touched an object</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.create(name: &quot;Kuldeep&quot;)
=&gt; #&lt;User id: 1, name: &quot;Kuldeep&quot;, created_at: &quot;2013-11-25 12:17:49&quot;, updated_at: &quot;2013-11-25 12:17:49&quot;&gt;

irb&gt; user.touch
You have touched an object
=&gt; true
</code></pre>

<p>It can be used along with <code>belongs_to</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_library'>library</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_after_touch'>after_touch</span> <span class='kw'>do</span>
    <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A Book was touched</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Library</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span>
  <span class='id identifier rubyid_after_touch'>after_touch</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_when_books_or_library_touched'>log_when_books_or_library_touched</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_log_when_books_or_library_touched'>log_when_books_or_library_touched</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Book/Library was touched</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; book = Book.last
=&gt; #&lt;Book id: 1, library_id: 1, created_at: &quot;2013-11-25 17:04:22&quot;, updated_at: &quot;2013-11-25 17:05:05&quot;&gt;

irb&gt; book.touch # triggers book.library.touch
A Book was touched
Book/Library was touched
=&gt; true
</code></pre>

<h2>Running Callbacks</h2>

<p>The following methods trigger callbacks:</p>

<ul>
<li><code>create</code></li>
<li><code>create!</code></li>
<li><code>destroy</code></li>
<li><code>destroy!</code></li>
<li><code>destroy_all</code></li>
<li><code>destroy_by</code></li>
<li><code>save</code></li>
<li><code>save!</code></li>
<li><code>save(validate: false)</code></li>
<li><code>save!(validate: false)</code></li>
<li><code>toggle!</code></li>
<li><code>touch</code></li>
<li><code>update_attribute</code></li>
<li><code>update_attribute!</code></li>
<li><code>update</code></li>
<li><code>update!</code></li>
<li><code>valid?</code></li>
<li><code>validate</code></li>
</ul>

<p>Additionally, the <code>after_find</code> callback is triggered by the following finder
methods:</p>

<ul>
<li><code>all</code></li>
<li><code>first</code></li>
<li><code>find</code></li>
<li><code>find_by</code></li>
<li><code>find_by!</code></li>
<li><code>find_by_*</code></li>
<li><code>find_by_*!</code></li>
<li><code>find_by_sql</code></li>
<li><code>last</code></li>
<li><code>sole</code></li>
<li><code>take</code></li>
</ul>

<p>The <code>after_initialize</code> callback is triggered every time a new object of the
class is initialized.</p>

<p>NOTE: The <code>find_by_*</code> and <code>find_by_*!</code> methods are dynamic finders generated
automatically for every attribute. Learn more about them in the <a href="active_record_querying.html#dynamic-finders">Dynamic finders
section</a>.</p>

<h2>Conditional Callbacks</h2>

<p>As with <a href="active_record_validations.html">validations</a>, we can also make the
calling of a callback method conditional on the satisfaction of a given
predicate. We can do this using the <code>:if</code> and <code>:unless</code> options, which can take
a symbol, a <code>Proc</code> or an <a href="Array.html" title="Array (class)"><code>Array</code></a>.</p>

<p>You may use the <code>:if</code> option when you want to specify under which conditions the
callback <strong>should</strong> be called. If you want to specify the conditions under which
the callback <strong>should not</strong> be called, then you may use the <code>:unless</code> option.</p>

<h3>Using <code>:if</code> and <code>:unless</code> with a <a href="Symbol.html" title="Symbol (class)"><code>Symbol</code></a></h3>

<p>You can associate the <code>:if</code> and <code>:unless</code> options with a symbol corresponding to
the name of a predicate method that will get called right before the callback.</p>

<p>When using the <code>:if</code> option, the callback <strong>won&#39;t</strong> be executed if the predicate
method returns <strong>false</strong>; when using the <code>:unless</code> option, the callback
<strong>won&#39;t</strong> be executed if the predicate method returns <strong>true</strong>. This is the most
common option.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_save'>before_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_normalize_card_number'>normalize_card_number</span><span class='comma'>,</span> <span class='label'>if:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_paid_with_card?'>paid_with_card?</span>
<span class='kw'>end</span></code></pre>

<p>Using this form of registration it is also possible to register several
different predicates that should be called to check if the callback should be
executed. We will cover this in the <a href="#multiple-callback-conditions">Multiple Callback Conditions
section</a>.</p>

<h3>Using <code>:if</code> and <code>:unless</code> with a <code>Proc</code></h3>

<p>It is possible to associate <code>:if</code> and <code>:unless</code> with a <code>Proc</code> object. This
option is best suited when writing short validation methods, usually one-liners:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_save'>before_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_normalize_card_number'>normalize_card_number</span><span class='comma'>,</span>
    <span class='label'>if:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_order'>order</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_order'>order</span>.<span class='id identifier rubyid_paid_with_card?'>paid_with_card?</span> }
<span class='kw'>end</span></code></pre>

<p>Since the proc is evaluated in the context of the object, it is also possible to
write this as:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_save'>before_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_normalize_card_number'>normalize_card_number</span><span class='comma'>,</span> <span class='label'>if:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_paid_with_card?'>paid_with_card?</span> }
<span class='kw'>end</span></code></pre>

<h3>Multiple Callback Conditions</h3>

<p>The <code>:if</code> and <code>:unless</code> options also accept an array of procs or method names as
symbols:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Comment</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_save'>before_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_filter_content'>filter_content</span><span class='comma'>,</span>
    <span class='label'>if:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_subject_to_parental_control?'>subject_to_parental_control?</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_untrusted_author?'>untrusted_author?</span>]
<span class='kw'>end</span></code></pre>

<p>You can easily include a proc in the list of conditions:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Comment</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_save'>before_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_filter_content'>filter_content</span><span class='comma'>,</span>
    <span class='label'>if:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_subject_to_parental_control?'>subject_to_parental_control?</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_untrusted_author?'>untrusted_author?</span> }]
<span class='kw'>end</span></code></pre>

<h3>Using Both <code>:if</code> and <code>:unless</code></h3>

<p>Callbacks can mix both <code>:if</code> and <code>:unless</code> in the same declaration:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Comment</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_save'>before_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_filter_content'>filter_content</span><span class='comma'>,</span>
    <span class='label'>if:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_forum'>forum</span>.<span class='id identifier rubyid_parental_control?'>parental_control?</span> }<span class='comma'>,</span>
    <span class='label'>unless:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_author'>author</span>.<span class='id identifier rubyid_trusted?'>trusted?</span> }
<span class='kw'>end</span></code></pre>

<p>The callback only runs when all the <code>:if</code> conditions and none of the <code>:unless</code>
conditions are evaluated to <code>true</code>.</p>

<h2>Skipping Callbacks</h2>

<p>Just as with <a href="active_record_validations.html">validations</a>, it is also possible
to skip callbacks by using the following methods:</p>

<ul>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-decrement-21"><code>decrement!</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/CounterCache/ClassMethods.html#method-i-decrement_counter"><code>decrement_counter</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-delete"><code>delete</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-delete_all"><code>delete_all</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-delete_by"><code>delete_by</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-increment-21"><code>increment!</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/CounterCache/ClassMethods.html#method-i-increment_counter"><code>increment_counter</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-insert"><code>insert</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-insert-21"><code>insert!</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-insert_all"><code>insert_all</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-insert_all-21"><code>insert_all!</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-touch_all"><code>touch_all</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-update_column"><code>update_column</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-update_columns"><code>update_columns</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-update_all"><code>update_all</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-update_counters"><code>update_counters</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-upsert"><code>upsert</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-upsert_all"><code>upsert_all</code></a></li>
</ul>

<p>Let&#39;s consider a <code>User</code> model where the <code>before_save</code> callback logs any changes
to the user&#39;s email address:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_save'>before_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_email_change'>log_email_change</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_log_email_change'>log_email_change</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_email_changed?'>email_changed?</span>
        <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Email changed from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email_was'>email_was</span><span class='embexpr_end'>}</span><span class='tstring_content'> to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Now, suppose there&#39;s a scenario where you want to update the user&#39;s email
address without triggering the <code>before_save</code> callback to log the email change.
You can use the <code>update_columns</code> method for this purpose:</p>

<pre class="code irb"><code class="irb">irb&gt; user = User.find(1)
irb&gt; user.update_columns(email: &#39;new_email@example.com&#39;)
</code></pre>

<p>The above will update the user&#39;s email address without triggering the
<code>before_save</code> callback.</p>

<p>WARNING. These methods should be used with caution because there may be
important business rules and application logic in callbacks that you do not want
to bypass. Bypassing them without understanding the potential implications may
lead to invalid data.</p>

<h2>Suppressing Saving</h2>

<p>In certain scenarios, you may need to temporarily prevent records from being
saved within your callbacks.
This can be useful if you have a record with complex nested associations and want
to skip saving specific records during certain operations without permanently disabling
the callbacks or introducing complex conditional logic.</p>

<p>Rails provides a mechanism to prevent saving records using the
<a href="https://api.rubyonrails.org/classes/ActiveRecord/Suppressor.html"><a href="ActiveRecord/Suppressor.html" title="ActiveRecord::Suppressor (module)"><code>::ActiveRecord::Suppressor</code></a> module</a>.
By using this module, you can wrap a block of code where you want to avoid
saving records of a specific type that otherwise would be saved by the code block.</p>

<p>Let&#39;s consider a scenario where a user has many notifications.
Creating a <code>User</code> will automatically create a <code>Notification</code> record as well.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_notifications'>notifications</span>

  <span class='id identifier rubyid_after_create'>after_create</span> <span class='symbeg'>:</span><span class='id identifier rubyid_create_welcome_notification'>create_welcome_notification</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_create_welcome_notification'>create_welcome_notification</span>
    <span class='id identifier rubyid_notifications'>notifications</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>event:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sign_up</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Notification</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>
<span class='kw'>end</span></code></pre>

<p>To create a user without creating a notification, we can use the
ActiveRecord::Suppressor module as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Notification</span>.<span class='id identifier rubyid_suppress'>suppress</span> <span class='kw'>do</span>
  <span class='const'>User</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Jane</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>jane@example.com</span><span class='tstring_end'>&quot;</span></span>)
<span class='kw'>end</span></code></pre>

<p>In the above code, the <code>Notification.suppress</code> block ensures that the
<code>Notification</code> is not saved during the creation of the &quot;Jane&quot; user.</p>

<p>WARNING: Using the Active Record Suppressor can introduce complexity and
unexpected behavior. Suppressing saving can obscure the intended flow of your
application, leading to difficulties in understanding and maintaining the
codebase over time. Carefully consider the implications of using the suppressor,
ensuring thorough documentation and thoughtful testing to mitigate
risks of unintended side effects and test failures.</p>

<h2>Halting Execution</h2>

<p>As you start registering new callbacks for your models, they will be queued for
execution. This queue will include all of your model&#39;s validations, the
registered callbacks, and the database operation to be executed.</p>

<p>The whole callback chain is wrapped in a transaction. If any callback raises an
exception, the execution chain gets halted and a <strong>rollback</strong> is issued, and the
error will be re-raised.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Product</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_validation'>before_validation</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Price can&#39;t be negative</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_total_price'>total_price</span> <span class='op'>&lt;</span> <span class='int'>0</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>Product</span>.<span class='id identifier rubyid_create'>create</span> <span class='comment'># raises &quot;Price can&#39;t be negative&quot;</span></code></pre>

<p>This unexpectedly breaks code that does not expect methods like <code>create</code> and
<code>save</code> to raise exceptions.</p>

<p>NOTE: If an exception occurs during the callback chain, Rails will re-raise it
unless it is an <a href="ActiveRecord/Rollback.html" title="ActiveRecord::Rollback (class)"><code>::ActiveRecord::Rollback</code></a> or <a href="ActiveRecord/RecordInvalid.html" title="ActiveRecord::RecordInvalid (class)"><code>::ActiveRecord::RecordInvalid</code></a>
exception. Instead, you should use <code>throw :abort</code> to intentionally halt the
chain. If any callback throws <code>:abort</code>, the process will be aborted and <code>create</code>
will return false.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Product</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_validation'>before_validation</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_throw'>throw</span> <span class='symbeg'>:</span><span class='id identifier rubyid_abort'>abort</span> <span class='kw'>if</span> <span class='id identifier rubyid_total_price'>total_price</span> <span class='op'>&lt;</span> <span class='int'>0</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>Product</span>.<span class='id identifier rubyid_create'>create</span> <span class='comment'># =&gt; false</span></code></pre>

<p>However, it will raise an <a href="ActiveRecord/RecordNotSaved.html" title="ActiveRecord::RecordNotSaved (class)"><code>::ActiveRecord::RecordNotSaved</code></a> when calling <code>create!</code>.
This exception indicates that the record was not saved due to the callback&#39;s
interruption.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Product</span>.<span class='id identifier rubyid_create!'>create!</span> <span class='comment'># =&gt; raises an ActiveRecord::RecordNotSaved</span></code></pre>

<p>When <code>throw :abort</code> is called in any destroy callback, <code>destroy</code> will return
false:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_destroy'>before_destroy</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_throw'>throw</span> <span class='symbeg'>:</span><span class='id identifier rubyid_abort'>abort</span> <span class='kw'>if</span> <span class='id identifier rubyid_still_active?'>still_active?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_destroy'>destroy</span> <span class='comment'># =&gt; false</span></code></pre>

<p>However, it will raise an <a href="ActiveRecord/RecordNotDestroyed.html" title="ActiveRecord::RecordNotDestroyed (class)"><code>::ActiveRecord::RecordNotDestroyed</code></a> when calling
<code>destroy!</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_destroy!'>destroy!</span> <span class='comment'># =&gt; raises an ActiveRecord::RecordNotDestroyed</span></code></pre>

<h2>Association Callbacks</h2>

<p>Association callbacks are similar to normal callbacks, but they are triggered by
events in the life cycle of the associated collection. There are four available
association callbacks:</p>

<ul>
<li><code>before_add</code></li>
<li><code>after_add</code></li>
<li><code>before_remove</code></li>
<li><code>after_remove</code></li>
</ul>

<p>You can define association callbacks by adding options to the association.</p>

<p>Suppose you have an example where an author can have many books. However, before
adding a book to the authors collection, you want to ensure that the author has
not reached their book limit. You can do this by adding a <code>before_add</code> callback
to check the limit.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span><span class='comma'>,</span> <span class='label'>before_add:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_check_limit'>check_limit</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_check_limit'>check_limit</span>(<span class='id identifier rubyid__book'>_book</span>)
      <span class='kw'>if</span> <span class='id identifier rubyid_books'>books</span>.<span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;=</span> <span class='int'>5</span>
        <span class='id identifier rubyid_errors'>errors</span>.<span class='id identifier rubyid_add'>add</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_base'>base</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cannot add more than 5 books for this author</span><span class='tstring_end'>&quot;</span></span>)
        <span class='id identifier rubyid_throw'>throw</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_abort'>abort</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>If a <code>before_add</code> callback throws <code>:abort</code>, the object does not get added to the
collection.</p>

<p>At times you may want to perform multiple actions on the associated object. In
this case, you can stack callbacks on a single event by passing them as an
array. Additionally, Rails passes the object being added or removed to the
callback for you to use.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span><span class='comma'>,</span> <span class='label'>before_add:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_check_limit'>check_limit</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_calculate_shipping_charges'>calculate_shipping_charges</span>]

  <span class='kw'>def</span> <span class='id identifier rubyid_check_limit'>check_limit</span>(<span class='id identifier rubyid__book'>_book</span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_books'>books</span>.<span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;=</span> <span class='int'>5</span>
      <span class='id identifier rubyid_errors'>errors</span>.<span class='id identifier rubyid_add'>add</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_base'>base</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cannot add more than 5 books for this author</span><span class='tstring_end'>&quot;</span></span>)
      <span class='id identifier rubyid_throw'>throw</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_abort'>abort</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_calculate_shipping_charges'>calculate_shipping_charges</span>(<span class='id identifier rubyid_book'>book</span>)
    <span class='id identifier rubyid_weight_in_pounds'>weight_in_pounds</span> <span class='op'>=</span> <span class='id identifier rubyid_book'>book</span>.<span class='id identifier rubyid_weight_in_pounds'>weight_in_pounds</span> <span class='op'>||</span> <span class='int'>1</span>
    <span class='id identifier rubyid_shipping_charges'>shipping_charges</span> <span class='op'>=</span> <span class='id identifier rubyid_weight_in_pounds'>weight_in_pounds</span> <span class='op'>*</span> <span class='int'>2</span>

    <span class='id identifier rubyid_shipping_charges'>shipping_charges</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Similarly, if a <code>before_remove</code> callback throws <code>:abort</code>, the object does not
get removed from the collection.</p>

<p>NOTE: These callbacks are called only when the associated objects are added or
removed through the association collection.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Triggers `before_add` callback
</span><span class='id identifier rubyid_author'>author</span>.<span class='id identifier rubyid_books'>books</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_book'>book</span>
<span class='id identifier rubyid_author'>author</span>.<span class='id identifier rubyid_books'>books</span> <span class='op'>=</span> [<span class='id identifier rubyid_book'>book</span><span class='comma'>,</span> <span class='id identifier rubyid_book2'>book2</span>]

<span class='comment'># Does not trigger the `before_add` callback
</span><span class='id identifier rubyid_book'>book</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>author_id:</span> <span class='int'>1</span>)</code></pre>

<h2>Cascading Association Callbacks</h2>

<p>Callbacks can be performed when associated objects are changed. They work
through the model associations whereby life cycle events can cascade on
associations and fire callbacks.</p>

<p>Suppose an example where a user has many articles. A user&#39;s articles should be
destroyed if the user is destroyed. Let&#39;s add an <code>after_destroy</code> callback to the
<code>User</code> model by way of its association to the <code>Article</code> model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_articles'>articles</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy'>destroy</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_destroy'>after_destroy</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_destroy_action'>log_destroy_action</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_log_destroy_action'>log_destroy_action</span>
    <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Article destroyed</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.first
=&gt; #&lt;User id: 1&gt;
irb&gt; user.articles.create!
=&gt; #&lt;Article id: 1, user_id: 1&gt;
irb&gt; user.destroy
Article destroyed
=&gt; #&lt;User id: 1&gt;
</code></pre>

<p>WARNING: When using a <code>before_destroy</code> callback, it should be placed before
<code>dependent: :destroy</code> associations (or use the <code>prepend: true</code> option), to
ensure they execute before the records are deleted by <code>dependent: :destroy</code>.</p>

<h2>Transaction Callbacks</h2>

<h3><code>after_commit</code> and <code>after_rollback</code></h3>

<p>Two additional callbacks are triggered by the completion of a database
transaction: <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> and <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a>. These callbacks are
very similar to the <code>after_save</code> callback except that they don&#39;t execute until
after database changes have either been committed or rolled back. They are most
useful when your Active Record models need to interact with external systems
that are not part of the database transaction.</p>

<p>Consider a <code>PictureFile</code> model that needs to delete a file after the
corresponding record is destroyed.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>PictureFile</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_destroy'>after_destroy</span> <span class='symbeg'>:</span><span class='id identifier rubyid_delete_picture_file_from_disk'>delete_picture_file_from_disk</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_delete_picture_file_from_disk'>delete_picture_file_from_disk</span>
    <span class='kw'>if</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_exist?'>exist?</span>(<span class='id identifier rubyid_filepath'>filepath</span>)
      <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_filepath'>filepath</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>If anything raises an exception after the <code>after_destroy</code> callback is called and
the transaction rolls back, then the file will have been deleted and the model
will be left in an inconsistent state. For example, suppose that
<code>picture_file_2</code> in the code below is not valid and the <code>save!</code> method raises an
error.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>PictureFile</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_picture_file_1'>picture_file_1</span>.<span class='id identifier rubyid_destroy'>destroy</span>
  <span class='id identifier rubyid_picture_file_2'>picture_file_2</span>.<span class='id identifier rubyid_save!'>save!</span>
<span class='kw'>end</span></code></pre>

<p>By using the <code>after_commit</code> callback we can account for this case.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>PictureFile</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_commit'>after_commit</span> <span class='symbeg'>:</span><span class='id identifier rubyid_delete_picture_file_from_disk'>delete_picture_file_from_disk</span><span class='comma'>,</span> <span class='label'>on:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy'>destroy</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_delete_picture_file_from_disk'>delete_picture_file_from_disk</span>
    <span class='kw'>if</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_exist?'>exist?</span>(<span class='id identifier rubyid_filepath'>filepath</span>)
      <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_filepath'>filepath</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: The <code>:on</code> option specifies when a callback will be fired. If you don&#39;t
supply the <code>:on</code> option the callback will fire for every life cycle event. <a href="#registering-callbacks-to-fire-on-life-cycle-events">Read
more about <code>:on</code></a>.</p>

<p>When a transaction completes, the <code>after_commit</code> or <code>after_rollback</code> callbacks
are called for all models created, updated, or destroyed within that
transaction. However, if an exception is raised within one of these callbacks,
the exception will bubble up and any remaining <code>after_commit</code> or
<code>after_rollback</code> methods will <em>not</em> be executed.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_after_commit'>after_commit</span> { <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Intentional Error</span><span class='tstring_end'>&quot;</span></span> }
  <span class='id identifier rubyid_after_commit'>after_commit</span> {
    <span class='comment'># This won&#39;t get called because the previous after_commit raises an exception
</span>    <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This will not be logged</span><span class='tstring_end'>&quot;</span></span>)
  }
<span class='kw'>end</span></code></pre>

<p>WARNING. If your callback code raises an exception, you&#39;ll need to rescue it and
handle it within the callback in order to allow other callbacks to run.</p>

<p><code>after_commit</code> makes very different guarantees than <code>after_save</code>,
<code>after_update</code>, and <code>after_destroy</code>. For example, if an exception occurs in an
<code>after_save</code> the transaction will be rolled back and the data will not be
persisted.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_after_save'>after_save</span> <span class='kw'>do</span>
    <span class='comment'># If this fails the user won&#39;t be saved.
</span>    <span class='const'>EventLog</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>event:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user_saved</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>However, during <code>after_commit</code> the data was already persisted to the database,
and thus any exception won&#39;t roll anything back anymore.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_after_commit'>after_commit</span> <span class='kw'>do</span>
    <span class='comment'># If this fails the user was already saved.
</span>    <span class='const'>EventLog</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>event:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user_saved</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The code executed within <code>after_commit</code> or <code>after_rollback</code> callbacks is itself
not enclosed within a transaction.</p>

<p>In the context of a single transaction, if you represent the same record in the
database, there&#39;s a crucial behavior in the <code>after_commit</code> and <code>after_rollback</code>
callbacks to note. These callbacks are triggered only for the first object of
the specific record that changes within the transaction. Other loaded objects,
despite representing the same database record, will not have their respective
<code>after_commit</code> or <code>after_rollback</code> callbacks triggered.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_commit'>after_commit</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_user_saved_to_db'>log_user_saved_to_db</span><span class='comma'>,</span> <span class='label'>on:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update'>update</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_log_user_saved_to_db'>log_user_saved_to_db</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User was saved to database</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.create
irb&gt; User.transaction { user.save; user.save }
# User was saved to database
</code></pre>

<p>WARNING: This nuanced behavior is particularly impactful in scenarios where you
expect independent callback execution for each object associated with the same
database record. It can influence the flow and predictability of callback
sequences, leading to potential inconsistencies in application logic following
the transaction.</p>

<h3>Aliases for <code>after_commit</code></h3>

<p>Using the <code>after_commit</code> callback only on create, update, or destroy is common.
Sometimes you may also want to use a single callback for both <code>create</code> and
<code>update</code>. Here are some common aliases for these operations:</p>

<ul>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_destroy_commit"><code>after_destroy_commit</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_create_commit"><code>after_create_commit</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_update_commit"><code>after_update_commit</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_save_commit"><code>after_save_commit</code></a></li>
</ul>

<p>Let&#39;s go through some examples:</p>

<p>Instead of using <code>after_commit</code> with the <code>on</code> option for a destroy like below:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>PictureFile</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_commit'>after_commit</span> <span class='symbeg'>:</span><span class='id identifier rubyid_delete_picture_file_from_disk'>delete_picture_file_from_disk</span><span class='comma'>,</span> <span class='label'>on:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy'>destroy</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_delete_picture_file_from_disk'>delete_picture_file_from_disk</span>
    <span class='kw'>if</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_exist?'>exist?</span>(<span class='id identifier rubyid_filepath'>filepath</span>)
      <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_filepath'>filepath</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>You can instead use the <code>after_destroy_commit</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>PictureFile</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_destroy_commit'>after_destroy_commit</span> <span class='symbeg'>:</span><span class='id identifier rubyid_delete_picture_file_from_disk'>delete_picture_file_from_disk</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_delete_picture_file_from_disk'>delete_picture_file_from_disk</span>
    <span class='kw'>if</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_exist?'>exist?</span>(<span class='id identifier rubyid_filepath'>filepath</span>)
      <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_filepath'>filepath</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The same applies for <code>after_create_commit</code> and <code>after_update_commit</code>.</p>

<p>However, if you use the <code>after_create_commit</code> and the <code>after_update_commit</code>
callback with the same method name, it will only allow the last callback defined
to take effect, as they both internally alias to <code>after_commit</code> which overrides
previously defined callbacks with the same method name.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_create_commit'>after_create_commit</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_user_saved_to_db'>log_user_saved_to_db</span>
  <span class='id identifier rubyid_after_update_commit'>after_update_commit</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_user_saved_to_db'>log_user_saved_to_db</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_log_user_saved_to_db'>log_user_saved_to_db</span>
      <span class='comment'># This only gets called once
</span>      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User was saved to database</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.create # prints nothing

irb&gt; user.save # updating @user
User was saved to database
</code></pre>

<p>In this case, it&#39;s better to use <code>after_save_commit</code> instead which is an alias
for using the <code>after_commit</code> callback for both create and update:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_save_commit'>after_save_commit</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_user_saved_to_db'>log_user_saved_to_db</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_log_user_saved_to_db'>log_user_saved_to_db</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User was saved to database</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; user = User.create # creating a User
User was saved to database

irb&gt; user.save # updating user
User was saved to database
</code></pre>

<h3>Transactional Callback Ordering</h3>

<p>By default (from Rails 7.1), transaction callbacks will run in the order they
are defined.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_after_commit'>after_commit</span> { <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>this gets called first</span><span class='tstring_end'>&quot;</span></span>) }
  <span class='id identifier rubyid_after_commit'>after_commit</span> { <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>this gets called second</span><span class='tstring_end'>&quot;</span></span>) }
<span class='kw'>end</span></code></pre>

<p>However, in prior versions of Rails, when defining multiple transactional
<code>after_</code> callbacks (<code>after_commit</code>, <code>after_rollback</code>, etc), the order in which
the callbacks were run was reversed.</p>

<p>If for some reason you&#39;d still like them to run in reverse, you can set the
following configuration to <code>false</code>. The callbacks will then run in the reverse
order. See the <a href="configuring.html#config-active-record-run-after-transaction-callbacks-in-order-defined">Active Record configuration
options</a>
for more details.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_run_after_transaction_callbacks_in_order_defined'>run_after_transaction_callbacks_in_order_defined</span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>

<p>NOTE: This applies to all <code>after_*_commit</code> variations too, such as
<code>after_destroy_commit</code>.</p>

<h3>Per transaction callback</h3>

<p>You can also register transactional callbacks such as <code>before_commit</code>, <code>after_commit</code> and <code>after_rollback</code> on a specific transaction.
This is handy in situations where you need to perform an action that isn&#39;t specific to a model but rather a unit of work.</p>

<p><code>ActiveRecord::Base.transaction</code> yields an <a href="ActiveRecord/Transaction.html" title="ActiveRecord::Transaction (class)"><code>::ActiveRecord::Transaction</code></a> object, which allows registering the said callbacks on it.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Article</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_transaction'>transaction</span><span class='op'>|</span>
  <span class='id identifier rubyid_article'>article</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>published:</span> <span class='kw'>true</span>)

  <span class='id identifier rubyid_transaction'>transaction</span>.<span class='id identifier rubyid_after_commit'>after_commit</span> <span class='kw'>do</span>
    <span class='const'>PublishNotificationMailer</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>article:</span> <span class='id identifier rubyid_article'>article</span>).<span class='id identifier rubyid_deliver_later'>deliver_later</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3><a href="ActiveRecord.html#after_all_transactions_commit-class_method" title="ActiveRecord.after_all_transactions_commit (method)">ActiveRecord.after_all_transactions_commit</a></h3>

<p><a href="https://api.rubyonrails.org/classes/ActiveRecord.html#method-c-after_all_transactions_commit"><a href="ActiveRecord.html#after_all_transactions_commit-class_method" title="ActiveRecord.after_all_transactions_commit (method)">ActiveRecord.after_all_transactions_commit</a></a> is a callback that allows you to run code after all the current transactions have been successfully committed to the database.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_publish_article'>publish_article</span>(<span class='id identifier rubyid_article'>article</span>)
  <span class='const'>Article</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
    <span class='const'>Post</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
      <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span>.<span class='id identifier rubyid_after_all_transactions_commit'><a href="ActiveRecord.html#after_all_transactions_commit-class_method" title="ActiveRecord.after_all_transactions_commit (method)">after_all_transactions_commit</a></span> <span class='kw'>do</span>
        <span class='const'>PublishNotificationMailer</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>article:</span> <span class='id identifier rubyid_article'>article</span>).<span class='id identifier rubyid_deliver_later'>deliver_later</span>
        <span class='comment'># An email will be sent after the outermost transaction is committed.
</span>      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>A callback registered to <code>after_all_transactions_commit</code> will be triggered after the outermost transaction is committed. If any of the currently open transactions is rolled back, the block is never called.
In the event that there are no open transactions at the time a callback is registered, the block will be yielded immediately.</p>

<h2>Callback Objects</h2>

<p>Sometimes the callback methods that you&#39;ll write will be useful enough to be
reused by other models. Active Record makes it possible to create classes that
encapsulate the callback methods, so they can be reused.</p>

<p>Here&#39;s an example of an <code>after_commit</code> callback  class to deal with the cleanup
of discarded files on the filesystem. This behavior may not be unique to our
<code>PictureFile</code> model and we may want to share it, so it&#39;s a good idea to
encapsulate this into a separate class. This will make testing that behavior and
changing it much easier.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>FileDestroyerCallback</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_after_commit'>after_commit</span>(<span class='id identifier rubyid_file'>file</span>)
    <span class='kw'>if</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_exist?'>exist?</span>(<span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_filepath'>filepath</span>)
      <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_filepath'>filepath</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>When declared inside a class, as above, the callback methods will receive the
model object as a parameter. This will work on any model that uses the class
like so:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>PictureFile</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_commit'>after_commit</span> <span class='const'>FileDestroyerCallback</span>.<span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span></code></pre>

<p>Note that we needed to instantiate a new <code>FileDestroyerCallback</code> object, since
we declared our callback as an instance method. This is particularly useful if
the callbacks make use of the state of the instantiated object. Often, however,
it will make more sense to declare the callbacks as class methods:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>FileDestroyerCallback</span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_after_commit'>after_commit</span>(<span class='id identifier rubyid_file'>file</span>)
    <span class='kw'>if</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_exist?'>exist?</span>(<span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_filepath'>filepath</span>)
      <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_filepath'>filepath</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>When the callback method is declared this way, it won&#39;t be necessary to
instantiate a new <code>FileDestroyerCallback</code> object in our model.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>PictureFile</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_after_commit'>after_commit</span> <span class='const'>FileDestroyerCallback</span>
<span class='kw'>end</span></code></pre>

<p>You can declare as many callbacks as you want inside your callback objects.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>