<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Extending Sprockets &mdash; Sprockets main</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "extending_sprockets",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Sprockets main</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Extending Sprockets&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>Extending Sprockets</h1>

<p><a href="Sprockets.html" title="Sprockets (module)"><code>Sprockets</code></a> can use custom processors, compressors, and directives. This document is intended for library authors who want to extend <a href="Sprockets.html" title="Sprockets (module)"><code>Sprockets</code></a> functionality.</p>

<h2>Contents</h2>

<ul>
<li><a href="#types-of-extensions">Types of Extensions</a>

<ul>
<li><a href="#processors">Processors</a></li>
<li><a href="#transformers">Transformers</a></li>
<li><a href="#compressors">Compressors</a></li>
<li><a href="#exporters">Exporters</a></li>
</ul></li>
<li><a href="#extension-interface">Extension Interface</a>

<ul>
<li><a href="#extension-keys">Extension Keys</a></li>
<li><a href="#extension-metadata-keys">Extension Metadata Keys</a></li>
<li><a href="#register-mime-types">Register Mime Type</a></li>
</ul></li>
<li><a href="#adding-directives-to-your-extension">Adding Directives to your Extension</a></li>
<li><a href="#adding-erb-support-to-your-extension">Adding ERB Support to your Extension</a></li>
<li><a href="#supporting-all-versions-of-sprockets-in-processors">Supporting All Versions of <a href="Sprockets.html" title="Sprockets (module)"><code>Sprockets</code></a> in Processors</a>

<ul>
<li><a href="#registering-all-versions-of-sprockets-in-processors">Registering All Versions of Sprockets in Processors</a></li>
</ul></li>
</ul>

<h2>Types of Extensions</h2>

<p><a href="Sprockets.html" title="Sprockets (module)"><code>Sprockets</code></a> supports a few different ways to extend functionality.</p>

<ul>
<li>processors</li>
<li>transformers</li>
<li>compressors</li>
<li>exporters</li>
</ul>

<p>For a detailed explanation of each see the respective sections below.</p>

<p><a href="Sprockets.html" title="Sprockets (module)"><code>Sprockets</code></a> ships with a number of built in processors, transformers and compressors. You can see all the defaults registered in <code>lib/sprockets.rb</code>.</p>

<h3>Processors</h3>

<p>There are two types of processors: preprocessors and postprocessors.</p>

<p>A preprocessor is called as an asset is loaded. Generally preprocessors take in a raw file and convert its contents. For example the <a href="Sprockets/DirectiveProcessor.html" title="Sprockets::DirectiveProcessor (class)"><code>DirectiveProcessor</code></a> is the processor that is responsible for reading in the <a href="Sprockets.html" title="Sprockets (module)"><code>Sprockets</code></a> directives such as:</p>

<pre class="code js"><code class="js">//= require &quot;foo&quot;
</code></pre>

<p>It will then load in the <code>foo</code> file and add its contents to the original file.</p>

<p>A postprocessor is called after all of the transformers run. Generally postprocessors do a final transformation to an asset before it is ready for bundling in the asset pipeline.</p>

<p>For example, imagine that you like to write JavaScript without semicolons. However, your project uses a CoffeeScript library. Since CoffeeScript adds semicolons during compilation, you might make a processor that removes all <code>;</code> from JavaScript files since CoffeeScript compiles to JavaScript. A simple implementation of this could be a proc:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_remove_semicolons_processor'>remove_semicolons_processor</span> <span class='op'>=</span> <span class='tlambda'>-&gt;</span> (<span class='id identifier rubyid_input'>input</span>) <span class='tlambeg'>{</span>
  <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_data'>data</span>].<span class='id identifier rubyid_gsub'>gsub</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>)
  { <span class='label'>data:</span> <span class='id identifier rubyid_data'>data</span> }
}</code></pre>

<p>When you register this processor as a postprocessor your CoffeeScript library will first be compiled to JavaScript, then post-processed by this processor, thus removing all semicolons from the output.</p>

<p>Without postprocessors, you would have to ensure that the CoffeeScript transformer is run <em>before</em> your processor so you would have to insert it after the CoffeeScript transformer much like two Rack middlewares that have an order-dependence on one another. With postprocessors, you can register your processor as a postprocessor and not need to worry about ordering it after the CoffeeScript transformer.</p>

<h2>Transformers</h2>

<p>A transformer takes one asset and converts it into another asset. For example the <a href="Sprockets/CoffeeScriptProcessor.html" title="Sprockets::CoffeeScriptProcessor (module)"><code>CoffeeScriptProcessor</code></a> is what takes a file with a <code>.coffee</code> file extension and returns a <code>.js</code> file.</p>

<h3>Transformers</h3>

<p>Like a preprocessor, a transformer will return the contents of the file in a <code>:data</code> key, and any other metadata.</p>

<p>You can register a transformer like this:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_register_transformer'><a href="Sprockets/Transformers.html#register_transformer-instance_method" title="Sprockets::Transformers#register_transformer (method)">register_transformer</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/coffeescript</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/javascript</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'><a href="Sprockets/CoffeeScriptProcessor.html" title="Sprockets::CoffeeScriptProcessor (module)">CoffeeScriptProcessor</a></span></code></pre>

<p>The first argument is the mime type of the file that the processor accepts. The second argument is the mime type that it generates, and the last argument is the object that responds to <code>call</code>.</p>

<p>For example, say you wanted to have Sprockets process a <code>.html</code> file, and output the mime type as application/javascript. To accomplish this, you would do the following:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_register_transformer'><a href="Sprockets/Transformers.html#register_transformer-instance_method" title="Sprockets::Transformers#register_transformer (method)">register_transformer</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/html</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/javascript</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>MyTemplateProcessor</span></code></pre>

<h3>Compressors</h3>

<p>A compressor takes in an asset, and returns a smaller version of that asset. For example the uglifier compressor takes in a JavaScript file, it then removes the whitespace and applies other space saving techniques and returns a smaller JavaScript source.</p>

<p>Compressors must respond to <code>call</code> and return a <code>:data</code> key in a hash similar to a processor.</p>

<p>You can register a compressor like this:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_register_compressor'><a href="Sprockets/Compressing.html#register_compressor-instance_method" title="Sprockets::Compressing#register_compressor (method)">register_compressor</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/javascript</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uglify'>uglify</span><span class='comma'>,</span> <span class='const'><a href="Sprockets/UglifierCompressor.html" title="Sprockets::UglifierCompressor (class)">UglifierCompressor</a></span></code></pre>

<p>Registering a compressor allows it to be used later. After registering a compressor you can activate it using the <code>js_compressor=</code> or <code>css_compressor=</code> method on the environment or Sprockets global.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_register_compressor'><a href="Sprockets/Compressing.html#register_compressor-instance_method" title="Sprockets::Compressing#register_compressor (method)">register_compressor</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_my_css'>my_css</span><span class='comma'>,</span> <span class='const'>MyCssCompressor</span>
<span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_css_compressor'><a href="Sprockets/Compressing.html#css_compressor-instance_method" title="Sprockets::Compressing#css_compressor (method)">css_compressor</a></span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_my_css'>my_css</span></code></pre>

<p>Compressors only operate on JavaScript and CSS. If you want to compress a different type of asset, use a processor (see &quot;Processors&quot; above) to process the asset.</p>

<h2>Exporters</h2>

<p>An exporter takes a compiled asset and writes it to disk. The default exporters are <code>FileExporter</code> which writes an asset&#39;s compiled source to disk and <code>ZlibExporter</code> that will produce a <code>.gz</code> file extension.</p>

<p>You can write your own exporter:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_register_exporter'>register_exporter</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>*/*</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span><span class='op'>::</span><span class='const'><a href="Sprockets/Exporters.html" title="Sprockets::Exporters (module)">Exporters</a></span><span class='op'>::</span><span class='const'><a href="Sprockets/Exporters/ZlibExporter.html" title="Sprockets::Exporters::ZlibExporter (class)">ZlibExporter</a></span></code></pre>

<p>First argument is the mime type of files that the exporter will operate on. For your convenience, a <a href="Sprockets/Exporters/Base.html" title="Sprockets::Exporters::Base (class)"><code>Exporters::Base</code></a> class is provided for you to inherit from. Details about the required interface for an exporter are in that class.</p>

<p>Your exporter gets initialized once for each asset to be exported by sprockets with the following keyword arguments</p>

<ul>
<li>asset (Instance of Sprockets::Asset)</li>
<li>environment (Instance of Sprockets::Environment)</li>
<li>directory (Instance of String)</li>
</ul>

<p>A <code>setup</code> method is called right after the exporter is initialized. Your exporter is expected implement a <code>skip?</code> method. If this method returns true then sprockets will skip your exporter and move to the next one. An instance of <code>Sprockets::Logger</code> is passed into this method that can be used to indicate to the user what is happening. This method is called synchronously.</p>

<p>The work of writing the new asset to disk is performed in the <code>call</code> method. This method is potentially called in a new thread and should not mutate any global state. A <code>write</code> method is provided that takes a <code>filename</code> to be written to (full path) and yields an IO object.</p>

<h2>Extension Interface</h2>

<p>A processor is expected to respond to <code>call()</code> and it accepts a hash of file contents. It is expected to return a hash that includes a <code>:data</code> key. The value returned in the <code>:data</code> key will be used as the contents for the file. Any other keys returned will be stored in the <code>:metadata</code> hash of an asset. For example, this result:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>HelloWorldProcessor</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_input'>input</span>)
    <span class='kw'>return</span> { <span class='label'>data:</span> <span class='id identifier rubyid_input'>input</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_data'>data</span>] <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n&#39;hello world&#39;</span><span class='tstring_end'>&quot;</span></span> }
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Would append the string <code>&#39;hello world&#39;</code> on a new line to any asset.</p>

<p>For Sprockets to call the processor it must be registered. If we wanted this processor to be called with any JavaScript files we would use the JavaScript mime type <code>application/javascript</code> and pass in the object that responds to call, in this case an instance of the <code>HelloWorldProcessor</code> class:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_register_preprocessor'><a href="Sprockets/Processing.html#register_preprocessor-instance_method" title="Sprockets::Processing#register_preprocessor (method)">register_preprocessor</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/javascript</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>HelloWorldProcessor</span>.<span class='id identifier rubyid_new'>new</span>)</code></pre>

<p>To register a processor as a postprocessor instead of a preprocessor, invoke the <code>register_postprocessor</code> command instead:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_register_postprocessor'><a href="Sprockets/Processing.html#register_postprocessor-instance_method" title="Sprockets::Processing#register_postprocessor (method)">register_postprocessor</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/javascript</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>HelloWorldProcessor</span>.<span class='id identifier rubyid_new'>new</span>)</code></pre>

<h3>Extension Keys</h3>

<p>The <code>call</code> interface returns a hash. In different versions of Sprockets there may be different keys. This doc is for Sprockets 4 (master). You can see these values being passed into processors <a href="https://github.com/rails/sprockets/blob/a9b53daaa5404443c0684103b7f83cd5be208575/lib/sprockets/loader.rb#L148-L161">in the Sprockets loader</a>.</p>

<ul>
<li><code>:data</code> - [String] Contains the contents of the file being passed to the your processor.</li>
</ul>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>var foo = &quot;bar&quot;</span><span class='tstring_end'>&#39;</span></span></code></pre>

<ul>
<li><code>:uri</code> - [String] A full URI to the asset, may include custom Sprockets params.</li>
</ul>

<p>Example:</p>

<pre class="code ruby"><code class="ruby">&quot;file:///Users/richardschneeman/Documents/projects/sprockets/test/fixtures/default/application.coffee?type=application/javascript&quot;,</code></pre>

<ul>
<li><code>:filename</code> - [String] Full path to asset on disk.</li>
</ul>

<p>Example:</p>

<pre class="code ruby"><code class="ruby">&quot;/Users/richardschneeman/Documents/projects/sprockets/test/fixtures/default/gallery.js\&quot;</code></pre>

<ul>
<li><code>:load_path</code> - [String] The load path that was used to find the asset.</li>
</ul>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/Users/richardschneeman/Documents/projects/sprockets/test/fixtures/default</span><span class='tstring_end'>&quot;</span></span></code></pre>

<ul>
<li><code>:name</code> - [String] The name of the file being loaded without extension.</li>
</ul>

<p>Example</p>

<pre class="code ruby"><code class="ruby"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gallery</span><span class='tstring_end'>&quot;</span></span></code></pre>

<ul>
<li><code>:content_type</code> - [String] The corresponding mime content type of the asset.</li>
</ul>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>application/javascript</span><span class='tstring_end'>&quot;</span></span></code></pre>

<ul>
<li><code>:metadata</code> - [Hash] Extra data, see the &quot;metadata&quot; section.</li>
</ul>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"># See metadata section for more info
{
  dependencies: [].to_set
  map: {
    # ...
  }
}</code></pre>

<ul>
<li><p><code>:cache</code> - [Sprockets::Cache] A cache object you can use to store and retrieve intermediate objects. You can use <a href="Sprockets/Cache.html#get-instance_method" title="Sprockets::Cache#get (method)">Sprockets::Cache#get</a>, <a href="Sprockets/Cache.html#set-instance_method" title="Sprockets::Cache#set (method)">Sprockets::Cache#set</a> and <a href="Sprockets/Cache.html#fetch-instance_method" title="Sprockets::Cache#fetch (method)">Sprockets::Cache#fetch</a> api. Refer to method docs for more info. If using paths for the key or contents, use <code>Sprockets::Environment#compress_from_root</code> and <code>Sprockets::Environment#expand_from_root</code> as the location of of your files absolute path will change.</p></li>
<li><p><code>:environment</code>  [Sprockets::Environment] Now you have direct access to all 105 methods that Sprockets uses! Use carefully, we may consider limiting this in the future. If you have feedback on what methods you need or use please say hi, Open an issue and let the Sprockets team know.</p></li>
</ul>

<h3>Extension Metadata Keys</h3>

<p>While you can store arbitrary keys in the metadata returned by your extension, there are some with special meaning and
uses inside of Sprockets. More may be added in the future.</p>

<p>Anything you add to the metadata will be stored in the Sprockets cache for the asset.</p>

<ul>
<li>map: This key contains a source map for the asset.</li>
</ul>

<p>A source map is a way to tell a browser how to map a generated file to an original for example if you write a
CoffeeScript file, Sprockets will generate a JavaScript file which is what the browser will see. If you need to debug
this javascript file it helps if you know where the in your original CoffeeScript file the generated JavaScript code
came from. The source map tells the browser how to map from a generated file to an original.</p>

<p>Sprockets expects this map to follow the <a href="https://docs.google.com/document/d/1U1RGAehQwRypUTovF1KRlpiOFze0b-_2gc6fAH0KY0k">source map spec</a>.</p>

<ul>
<li>charset: This key contains the mime charset for an asset.</li>
</ul>

<p>A charset is the encoding for text based assets. If you do not specify a charset then one will be automatically assigned
by sprockets based on the encoding type of the contents returned in the <code>:data</code> key. Normally you want that, the only
time you don&#39;t want that is if you&#39;re working with binary data, or data you don&#39;t want to be compressed. If Sprockets
sees a <code>charset</code> then it will think that the contents of the file are text and can be compressed via GZIP. You can avoid
this by setting the field manually.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>return</span> { <span class='label'>data:</span> <span class='id identifier rubyid_data'>data</span><span class='comma'>,</span> <span class='label'>charset:</span> <span class='kw'>nil</span> }</code></pre>

<p>WIP the format of the source map may be subject to change before 4.0 is released. Currently it takes a <code>:original</code>
and <code>:generated</code> key which each hold an array of line and column numbers. Line numbers are 1 indexed column numbers
are 0 indexed. The first character of a file will always be <code>[1,0]</code>.</p>

<ul>
<li><p>required: A <code>Set</code> of String Asset URIs that the Bundle processor should concatenate together.</p></li>
<li><p>stubbed: A <code>Set</code> of String Asset URIs that will be omitted from the <code>:required</code> set.</p></li>
<li><p>links: A <code>Set</code> of String Asset URIs that should be compiled along with this asset.</p></li>
<li><p>dependencies: A <code>Set</code> of String Cache URIs that should be monitored for caching.</p></li>
</ul>

<h3>Register Mime Types</h3>

<p>You can add new mime-types to Sprockets by using the <code>register_mime_type</code> method. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_register_mime_type'><a href="Sprockets/Mime.html#register_mime_type-instance_method" title="Sprockets::Mime#register_mime_type (method)">register_mime_type</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/json</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>extensions:</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.json</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span> <span class='label'>charset:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unicode'>unicode</span>
<span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_register_mime_type'><a href="Sprockets/Mime.html#register_mime_type-instance_method" title="Sprockets::Mime#register_mime_type (method)">register_mime_type</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/ruby</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>extensions:</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.rb</span><span class='tstring_end'>&#39;</span></span>]</code></pre>

<p>The first method is the mime-type of the object. The <code>:extensions</code> key passed to the second argument contains an array of all the extensions for the given mime type. An optional charset can be registered. This should only be used for text based mimetypes.</p>

<p>Your extension may have multiple parts for example some people use <code>.js.coffee</code> when this file type is used, we do not wish it to process as javascript first and then as coffee script so we register this entire extension:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_register_mime_type'><a href="Sprockets/Mime.html#register_mime_type-instance_method" title="Sprockets::Mime#register_mime_type (method)">register_mime_type</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/coffeescript</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>extensions:</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.coffee</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.js.coffee</span><span class='tstring_end'>&#39;</span></span>]</code></pre>

<h2>Adding Directives to your Extension</h2>

<p>If you are writing a transformer you likely also want it to understand Sprockets directives (such as the ability to <code>require</code> other files). You don&#39;t have to add this functionality in manually, instead you can register a custom instance of <a href="Sprockets/DirectiveProcessor.html" title="Sprockets::DirectiveProcessor (class)"><code>DirectiveProcessor</code></a> to run with your asset.</p>

<p>The <a href="Sprockets/DirectiveProcessor.html" title="Sprockets::DirectiveProcessor (class)"><code>DirectiveProcessor</code></a> can be initialized with a <code>:comments</code> key that holds an array of characters that denote a comment. For example the coffeescript language uses <code>#</code> as a comment. We could apply directive support to coffeescript files by registering:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span>.<span class='id identifier rubyid_register_preprocessor'><a href="Sprockets/Processing.html#register_preprocessor-instance_method" title="Sprockets::Processing#register_preprocessor (method)">register_preprocessor</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/coffeescript</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'><a href="Sprockets/DirectiveProcessor.html" title="Sprockets::DirectiveProcessor (class)">DirectiveProcessor</a></span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>comments:</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>###</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>###</span><span class='tstring_end'>&quot;</span></span>]])</code></pre>

<h2>Adding ERB Support to your Extension</h2>

<p>In Sprockets 4 file types are no longer &quot;chainable&quot; this means that if you wanted to use a <code>.coffee.erb</code> that it must be registered to sprockets explicitly. This is different from previous versions of sprockets where you would have to register only a <code>.erb</code> processor and then a <code>.coffee</code> processor and sprockets would chain them (first running erb then coffee).</p>

<p>The reason for the change is to have more explicit behavior. It helps sprockets know to do the right thing, decreases magic, and increases speed. It also means that as a library maintainer you must tell sprockets all the extensions you want your project to work with. Going with the coffee script example. You would need to register a mime type</p>

<!---
Right now sprockets uses an "internal interface" to register erb files. I'm not actually sure how to register support for an ERB file correctly without using that interface, need to do more research

```
env.register_mime_type 'text/coffeescript+ruby', extensions: ['.coffee.erb', '.js.coffee.erb']

env.register_mime_type 'text/coffeescript', extensions: ['.coffee', '.js.coffee']
env.register_transformer 'text/coffeescript', 'application/javascript', CoffeeScriptProcessor
env.register_preprocessor 'text/coffeescript', DirectiveProcessor.new(comments: ["#", ["###", "###"]])
```

-->

<h2>Supporting All Versions of Sprockets in Processors</h2>

<p>If you are extending sprockets you may want to support all current major versions of sprockets (2, 3, and 4). The processor interface was deprecated from Sprockets 2 and a legacy shim was put into Sprockets 3. Now that Sprockets 4 is out that shim no longer is active, so you&#39;ll need to update your gem to either only use the new interface or use both interfaces. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Sprockets 2, 3 &amp; 4 interface
</span>
<span class='kw'>class</span> <span class='const'>MySprocketsExtension</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
    <span class='ivar'>@filename</span> <span class='op'>=</span> <span class='id identifier rubyid_filename'>filename</span>
    <span class='ivar'>@source</span>   <span class='op'>=</span> <span class='id identifier rubyid_block'>block</span>.<span class='id identifier rubyid_call'>call</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_render'>render</span>(<span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_empty_hash_wtf'>empty_hash_wtf</span>)
    <span class='kw'>self</span>.<span class='id identifier rubyid_class'>class</span>.<span class='id identifier rubyid_run'>run</span>(<span class='ivar'>@filename</span><span class='comma'>,</span> <span class='ivar'>@source</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_run'>run</span>(<span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_source'>source</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)
    <span class='id identifier rubyid_source'>source</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/* Hello From my sprockets extension */</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_input'>input</span>)
    <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_filename'>filename</span>]
    <span class='id identifier rubyid_source'>source</span>   <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_data'>data</span>]
    <span class='id identifier rubyid_context'>context</span>  <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_environment'>environment</span>].<span class='id identifier rubyid_context_class'>context_class</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_input'>input</span>)

    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_run'>run</span>(<span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_source'>source</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)
    <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_metadata'>metadata</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='label'>data:</span> <span class='id identifier rubyid_result'>result</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sprockets/processing</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_extend'>extend</span> <span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span><span class='op'>::</span><span class='const'><a href="Sprockets/Processing.html" title="Sprockets::Processing (module)">Processing</a></span>

<span class='id identifier rubyid_register_preprocessor'>register_preprocessor</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>MySprocketsExtension</span></code></pre>

<p>This extension is registered to add a comment <code>/* Hello From my sprockets extension */</code> to the end of a <code>text/css</code> (.css) file.</p>

<p>To understand why all of this is needed, we need to look at the different interfaces for Sprockets 2, 3, and 4.</p>

<p>Sprockets 2 let you register a processor with a class that would be instantiated and the method <code>render</code> called on it you can <a href="https://github.com/rails/sprockets/blob/2199a6012cc2b9cdbcbc0049361e5ee02770dff0/lib/sprockets/context.rb#L194-L202">view the calling code in Sprockets 2.x</a>. It may have looked like this:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Sprockets 2.x interface
</span>
<span class='kw'>class</span> <span class='const'>MySprocketsExtension</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
    <span class='comment'># code
</span>  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_render'>render</span>(<span class='id identifier rubyid_variable'>variable</span><span class='comma'>,</span> <span class='id identifier rubyid_empty_hash_wtf'>empty_hash_wtf</span>)
    <span class='comment'># code
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sprockets/processing</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_extend'>extend</span> <span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span><span class='op'>::</span><span class='const'><a href="Sprockets/Processing.html" title="Sprockets::Processing (module)">Processing</a></span>

<span class='id identifier rubyid_register_preprocessor'>register_preprocessor</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>MySprocketsExtension</span></code></pre>

<p>You can also pass a block to both 2.x and 3.x+ processor interfaces, however the number of args the method takes has changed so it&#39;s very hard to do that method and support multiple processor interfaces.</p>

<p>This Sprockets 2.x <code>render</code> interface is deprecated, instead you should use the <code>call</code> interface which was introduced in Sprockets 3.x. Whatever you pass to the processor can have a <code>call</code> method, it does not need to be a class.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Sprockets 3.x+ interface
</span>
<span class='kw'>module</span> <span class='const'>MySprocketsExtension</span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_input'>input</span>)
    <span class='comment'># code
</span>    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_data'>data</span>] <span class='comment'># :data key holds source
</span>    { <span class='label'>data:</span> <span class='id identifier rubyid_result'>result</span> }
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sprockets/processing</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_extend'>extend</span> <span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span><span class='op'>::</span><span class='const'><a href="Sprockets/Processing.html" title="Sprockets::Processing (module)">Processing</a></span>

<span class='id identifier rubyid_register_preprocessor'>register_preprocessor</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>MySprocketsExtension</span></code></pre>

<p>So if you want 2, 3, and 4 to work you can pass in a class that also has a <code>call</code> method on it as well as a <code>render</code> instance method. To see how this can be done you can reference this <a href="https://github.com/ai/autoprefixer-rails/pull/85">autoprefixer-rails pull request</a>.</p>

<p>This way you&#39;re passing in an object that responds to 3.x&#39;s <code>call</code> interface and 2.x&#39;s <code>new.render</code> interface. In generally we&#39;re recommending people not use Sprockets 2.x and that they upgrade to Sprockets 3+. If it&#39;s easier on you, you can rev a major version and only support the new interface.</p>

<p>There are new hash keys introduced in Sprockets 4. The <code>:source_path</code> key contains the file that will hold the sourcemap of the current asset.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Sprockets 3.x+ interface
</span>
<span class='kw'>module</span> <span class='const'>MySprocketsExtension</span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_input'>input</span>)
    <span class='id identifier rubyid_file_where_source_map_will_end_up'>file_where_source_map_will_end_up</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_source_path'>source_path</span>]
    <span class='comment'># code
</span>    { <span class='label'>data:</span> <span class='id identifier rubyid_result'>result</span> }
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>If your application is making serious modifications to the source file (an example could be a coffee script file generating JS will be significantly different) then you&#39;ll want to calculate and return an appropriate <code>map</code> key in the <code>metadata</code> hash. See the &quot;metadata&quot; section for more info on doing this.</p>

<p>Once you&#39;ve written your processor to run on all 3 versions of Sprockets you will need to register it. This is covered next.</p>

<h3>Registering All Versions of Sprockets in Processors</h3>

<p>In Sprockets 2 and 3 the way you registered a processor was via <code>register_engine</code>. Unfortunately they have different method signatures. In Sprockets 4 you must first explicitly register a mime type and use the appropriate processor directive i.e. <code>register_transformer</code>, <code>register_preprocessor</code>, etc. To register a processor for all 3 versions of sprockets you could do it like this:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Sprockets 2, 3, and 4
</span>
<span class='kw'>if</span> <span class='id identifier rubyid_env'>env</span>.<span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_register_transformer'>register_transformer</span>)
  <span class='id identifier rubyid_env'>env</span>.<span class='id identifier rubyid_register_mime_type'>register_mime_type</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>extensions:</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.css</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span> <span class='label'>charset:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_css'>css</span>
  <span class='id identifier rubyid_env'>env</span>.<span class='id identifier rubyid_register_preprocessor'>register_preprocessor</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>MySprocketsExtension</span>
<span class='kw'>elsif</span> <span class='id identifier rubyid_env'>env</span>.<span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_register_engine'>register_engine</span>)
  <span class='id identifier rubyid_args'>args</span> <span class='op'>=</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>MySprocketsExtension</span>]
  <span class='id identifier rubyid_args'>args</span> <span class='op'>&lt;&lt;</span> { <span class='label'>mime_type:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>silence_deprecation:</span> <span class='kw'>true</span> } <span class='kw'>if</span> <span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span><span class='op'>::</span><span class='const'><a href="Sprockets.html#VERSION-constant" title="Sprockets::VERSION (constant)">VERSION</a></span>.<span class='id identifier rubyid_start_with?'>start_with?</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>3</span><span class='tstring_end'>&quot;</span></span>)
  <span class='id identifier rubyid_env'>env</span>.<span class='id identifier rubyid_register_engine'>register_engine</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
<span class='kw'>end</span></code></pre>

<p>To understand why this is all needed, we can break down the parts. First is how you register an &quot;engine&quot; with Sprockets 3:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Sprockets 3
</span><span class='id identifier rubyid_env'>env</span>.<span class='id identifier rubyid_register_engine'>register_engine</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>MySprocketsExtension</span><span class='comma'>,</span> <span class='label'>mime_type:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>silence_deprecation:</span> <span class='kw'>true</span></code></pre>

<p>The use of <code>register_engine</code> is deprecated in Sprockets 3 and you will get a deprecation warning about it&#39;s use. We can pass in <code>silence_deprecation: true</code> to let Sprockets know that the interface is going away, only do this on code you know works with Sprockets 4.</p>

<p>To get the <code>register_engine</code> code working with Sprockets 2 we have to do some version detection since Sprockets 2 will error if you try to pass a hash into it:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Sprockets 2 &amp; 3
</span><span class='id identifier rubyid_args'>args</span> <span class='op'>=</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>MySprocketsExtension</span>]
<span class='id identifier rubyid_args'>args</span> <span class='op'>&lt;&lt;</span> { <span class='label'>mime_type:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>silence_deprecation:</span> <span class='kw'>true</span> } <span class='kw'>if</span> <span class='const'><a href="Sprockets.html" title="Sprockets (module)">Sprockets</a></span><span class='op'>::</span><span class='const'><a href="Sprockets.html#VERSION-constant" title="Sprockets::VERSION (constant)">VERSION</a></span>.<span class='id identifier rubyid_start_with?'>start_with?</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>3</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_env'>env</span>.<span class='id identifier rubyid_register_engine'>register_engine</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)</code></pre>

<p>Next we see how to do it with Sprockets 4 when <code>register_engine</code> is removed:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Sprockets 4
</span><span class='id identifier rubyid_env'>env</span>.<span class='id identifier rubyid_register_mime_type'>register_mime_type</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>extensions:</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.css</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span> <span class='label'>charset:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_css'>css</span>
<span class='id identifier rubyid_env'>env</span>.<span class='id identifier rubyid_register_preprocessor'>register_preprocessor</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/css</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>MySprocketsExtension</span></code></pre>

<p>In reality you wouldn&#39;t need to add a mime type for JS and CSS assets since they&#39;re already there by default but you will for other filetypes for example <code>.coffee</code> or <code>.scss</code>. The above <code>register_mime_type</code> example is used for example purposes and wouldn&#39;t be required.</p>

<p>Sprockets 4 will not chain asset extensions so <code>.coffee.erb</code> is explicitly registered in addition to <code>.coffee</code>. If your application introduces a new mime/extension combo it will be responsible for registering all combinations.</p>

<h2>WIP</h2>

<p>This guide is a work in progress. There are many different groups of people who interact with Sprockets. Some only need to know directive syntax to put in their asset files, some are building features like the Rails asset pipeline, and some are plugging into Sprockets and writing things like preprocessors. The goal of these guides are to provide task specific guidance to make the expected behavior explicit. If you are using Sprockets and you find missing information in these guides, please consider submitting a pull request with updated information.</p>

<p>These guides live in <a href="/guides">guides</a>.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>