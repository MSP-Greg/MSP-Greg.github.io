<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Source Maps &mdash; Sprockets main</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "source_maps",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Sprockets main</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Source Maps&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>Source Maps</h1>

<p>This is mostly a guide for developers of <a href="Sprockets.html" title="Sprockets (module)"><code>Sprockets</code></a>, contents may change without notice. For a base level description see <a href="https://schneems.com/2017/11/14/wtf-is-a-source-map/">What is a source map</a>.</p>

<h2>What is a source map?</h2>

<p>In production <a href="Sprockets.html" title="Sprockets (module)"><code>Sprockets</code></a> combines files together and minifies them when possible. This makes serving HTTP 1.x traffic faster, but if there is an error in your assets, it becomes very difficult to debug. In Rails asset pipeline it was the convention to not concatenate these files in development, so instead of serving 1 file you might see 10 or so. A source map is a standard that allows assets bundled into one file to declare a &quot;source map&quot; that lets browsers know what code came from what sources.</p>

<ul>
<li><a href="https://docs.google.com/document/d/1U1RGAehQwRypUTovF1KRlpiOFze0b-_2gc6fAH0KY0k/edit">Source Map 3 proposal</a></li>
<li><a href="https://github.com/mozilla/source-map/">Mozilla source-map library</a></li>
</ul>

<p>So if a source map is used, the exact same method of concatenation and minification in production can be used in development. This encourages developers to use standardized tools that are adopted across browsers to debug their assets.</p>

<h2>Source Map Detection</h2>

<p>When an asset is served to the browser it lets the browser know if a source map is available by adding a special comment to the bottom. For javascript files with a the comment starts with</p>

<pre class="code js"><code class="js">//# sourceMappingURL=
</code></pre>

<p>For example a javascript file like application.js was being served from <code>public/assets/application.js</code> then it might have a map file in <code>public/assets/application.js.map</code>. In that case the comment could either be a full path</p>

<pre class="code js"><code class="js">//# sourceMappingURL=/assets/application.js.map
</code></pre>

<p>Or it could be relative to the parent&#39;s directory:</p>

<pre class="code js"><code class="js">//# sourceMappingURL=application.js.map
</code></pre>

<p>Css files have a different comment specification</p>

<pre class="code ruby"><code class="ruby"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>*# sourceMappingURL=application.css.map *</span><span class='regexp_end'>/</span></span></code></pre>

<p>When this comment is served, the browser can make an additional request to that location to get the source map associated with the file</p>

<h2>Encode/Decode Source Map</h2>

<p>Mozilla maintains a node module that can encode and decode source maps. <a href="https://github.com/mozilla/source-map/">Mozilla source-map library</a>. We are considering this the source implementation against which sprockets can be compared.</p>

<p>First you&#39;ll need <code>npm</code> installed, google it.</p>

<p>First we will build a source map using the uglify-js library</p>

<pre class="code ruby"><code class="ruby"><span class='gvar'>$ </span><span class='id identifier rubyid_npm'>npm</span> <span class='id identifier rubyid_install'>install</span> <span class='id identifier rubyid_uglify'>uglify</span><span class='op'>-</span><span class='id identifier rubyid_js'>js</span>
<span class='id identifier rubyid_uglify'>uglify</span><span class='op'>-</span><span class='id identifier rubyid_js'>js</span><span class='ivar'>@</span><span class='float'>2.6</span> <span class='id identifier rubyid_node_modules'>node_modules</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>uglify-js
├── uglify-to-browserify@1.0.2
├── async@0.2.10
├── source-map@0.5.3
└── yargs@3.10.0 (decamelize@1.1.1, window-size@0.1.0, camelcase@1.2.1, cliui@2.1.0)</span></code></pre>

<p>Now we need an original javascript file:</p>

<pre class="code ruby"><code class="ruby"><span class='gvar'>$ </span><span class='id identifier rubyid_cat'>cat</span> <span class='id identifier rubyid_foo'>foo</span>.<span class='id identifier rubyid_js'>js</span>
<span class='id identifier rubyid_var'>var</span> <span class='id identifier rubyid_foo'>foo</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>foo</span><span class='tstring_end'>&quot;</span></span><span class='semicolon'>;</span>
<span class='id identifier rubyid_var'>var</span> <span class='id identifier rubyid_bar'>bar</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&quot;</span></span><span class='semicolon'>;</span></code></pre>

<p>We can run uglifyier on this file to generate a smaller version as well as a source map file by specifying the file name with the <code>--source-map</code> flag.</p>

<pre class="code ruby"><code class="ruby"><span class='gvar'>$ </span><span class='id identifier rubyid_uglifyjs'>uglifyjs</span> <span class='id identifier rubyid_foo'>foo</span>.<span class='id identifier rubyid_js'>js</span> <span class='op'>-</span><span class='op'>-</span><span class='id identifier rubyid_source'>source</span><span class='op'>-</span><span class='id identifier rubyid_map'>map</span> <span class='id identifier rubyid_foo'>foo</span>.<span class='id identifier rubyid_js'>js</span>.<span class='id identifier rubyid_map'>map</span>
<span class='id identifier rubyid_var'>var</span> <span class='id identifier rubyid_foo'>foo</span><span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>foo</span><span class='tstring_end'>&quot;</span></span><span class='semicolon'>;</span><span class='id identifier rubyid_var'>var</span> <span class='id identifier rubyid_bar'>bar</span><span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&quot;</span></span><span class='semicolon'>;</span>
<span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span><span class='comment'># sourceMappingURL=foo.js.map</span></code></pre>

<p>Now you can view this file:</p>

<pre class="code ruby"><code class="ruby"><span class='gvar'>$ </span><span class='id identifier rubyid_cat'>cat</span> <span class='id identifier rubyid_foo'>foo</span>.<span class='id identifier rubyid_js'>js</span>.<span class='id identifier rubyid_map'>map</span>
{
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>version</span><span class='label_end'>&quot;:</span>  <span class='int'>3</span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sources</span><span class='label_end'>&quot;:</span>  [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>foo.js</span><span class='tstring_end'>&quot;</span></span>]<span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>names</span><span class='label_end'>&quot;:</span>    [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>foo</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&quot;</span></span>]<span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>mappings</span><span class='label_end'>&quot;:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>AAAA,GAAIA,KAAM,KACV,IAAIC,KAAM</span><span class='tstring_end'>&quot;</span></span>
}</code></pre>

<p>Next you&#39;ll need to install the <code>source-map</code> library</p>

<pre class="code sh"><code class="sh">$ npm install source-map
source-map@0.5.3 node_modules/source-map
</code></pre>

<p>now we&#39;ll need simple node script that parses this file:</p>

<pre class="code js"><code class="js">var sourceMap = require(&#39;source-map&#39;);
var fs        = require(&#39;fs&#39;);

fs.readFile(&#39;./foo.js.map&#39;, &#39;utf8&#39;, function (err, data) {
  if (err) {
    return console.log(err);
  }
  var smc = new sourceMap.SourceMapConsumer(data);

  smc.eachMapping(function(m) {
    console.log(m);
  });
});
</code></pre>

<p>Save this in <code>read-source-map.js</code> when you run this file:</p>

<pre class="code ruby"><code class="ruby"><span class='gvar'>$ </span><span class='id identifier rubyid_node'>node</span> <span class='id identifier rubyid_read'>read</span><span class='op'>-</span><span class='id identifier rubyid_source'>source</span><span class='op'>-</span><span class='id identifier rubyid_map'>map</span>.<span class='id identifier rubyid_js'>js</span>
{ <span class='label'>source:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo.js</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>generatedLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>generatedColumn:</span> <span class='int'>0</span><span class='comma'>,</span>
  <span class='label'>originalLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>originalColumn:</span> <span class='int'>0</span><span class='comma'>,</span>
  <span class='label'>name:</span> <span class='id identifier rubyid_null'>null</span> }
{ <span class='label'>source:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo.js</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>generatedLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>generatedColumn:</span> <span class='int'>3</span><span class='comma'>,</span>
  <span class='label'>originalLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>originalColumn:</span> <span class='int'>4</span><span class='comma'>,</span>
  <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo</span><span class='tstring_end'>&#39;</span></span> }
{ <span class='label'>source:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo.js</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>generatedLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>generatedColumn:</span> <span class='int'>8</span><span class='comma'>,</span>
  <span class='label'>originalLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>originalColumn:</span> <span class='int'>10</span><span class='comma'>,</span>
  <span class='label'>name:</span> <span class='id identifier rubyid_null'>null</span> }
{ <span class='label'>source:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo.js</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>generatedLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>generatedColumn:</span> <span class='int'>13</span><span class='comma'>,</span>
  <span class='label'>originalLine:</span> <span class='int'>2</span><span class='comma'>,</span>
  <span class='label'>originalColumn:</span> <span class='int'>0</span><span class='comma'>,</span>
  <span class='label'>name:</span> <span class='id identifier rubyid_null'>null</span> }
{ <span class='label'>source:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo.js</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>generatedLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>generatedColumn:</span> <span class='int'>17</span><span class='comma'>,</span>
  <span class='label'>originalLine:</span> <span class='int'>2</span><span class='comma'>,</span>
  <span class='label'>originalColumn:</span> <span class='int'>4</span><span class='comma'>,</span>
  <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&#39;</span></span> }
{ <span class='label'>source:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo.js</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>generatedLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>generatedColumn:</span> <span class='int'>22</span><span class='comma'>,</span>
  <span class='label'>originalLine:</span> <span class='int'>2</span><span class='comma'>,</span>
  <span class='label'>originalColumn:</span> <span class='int'>10</span><span class='comma'>,</span>
  <span class='label'>name:</span> <span class='id identifier rubyid_null'>null</span> }</code></pre>

<p>Each of these correspond to an object in our javascript file. If we look at the <code>foo</code> variable:</p>

<pre class="code ruby"><code class="ruby">{ <span class='label'>source:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo.js</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>generatedLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>generatedColumn:</span> <span class='int'>3</span><span class='comma'>,</span>
  <span class='label'>originalLine:</span> <span class='int'>1</span><span class='comma'>,</span>
  <span class='label'>originalColumn:</span> <span class='int'>4</span><span class='comma'>,</span>
  <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo</span><span class='tstring_end'>&#39;</span></span>
}</code></pre>

<h2>Source Map file</h2>

<p>If we generate a source map for a 1 line javascript file that is not concatenated (it is generated by only one file) we can get a sense of a simple source map. For example if we generate a source map of <code>foo.js</code> which has these contents:</p>

<pre class="code js"><code class="js">var foo;
</code></pre>

<p>Then the resultant <code>foo.js.map</code> will be</p>

<pre class="code js"><code class="js">{
  &quot;version&quot;: 3,
  &quot;sources&quot;: [&quot;foo.js&quot;],
  &quot;names&quot;:   [ ],
  &quot;mappings&quot;: &quot;AAAA,GAAIA&quot;
}
</code></pre>

<ul>
<li><code>version</code> The version of the source map specification we are using. The current is version 3.</li>
<li><code>sources</code> An array of source files, these are the files used to generate <code>foo.js</code> if there were more files concatenated we would be expected to see multiple entries here.</li>
<li><code>names</code> Names of functions if available</li>
<li><code>mappings</code> The secret sauce, this includes a VLQ base 64 encoded string that tells the browser how to map lines and locations in the generated file to files, in our case <code>foo.js</code></li>
</ul>

<h2>Understanding Mappings</h2>

<p>Mappings are encoded from the version 3 spec. They use a <a href="https://en.wikipedia.org/wiki/Variable-length_quantity">Variable Length Quantity</a> of Base 64 encoded strings. This allows us to represent arbitrarily large strings. It works like this:</p>

<h3>VLQ Base 64 bit mappings</h3>

<p>We can represent integers in base64. First we generate an array of valid base64 characters</p>

<pre class="code ruby"><code class="ruby"><span class='const'>BASE64_DIGITS</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>)</code></pre>

<p>Then we can generate a hash of those characters to their corresponding numeric value</p>

<pre class="code ruby"><code class="ruby"><span class='const'>BASE64_VALUES</span> <span class='op'>=</span> (<span class='int'>0</span><span class='op'>...</span><span class='int'>64</span>).<span class='id identifier rubyid_each_with_object'>each_with_object</span>({}) { <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_hash'>hash</span><span class='op'>|</span> <span class='id identifier rubyid_hash'>hash</span>[<span class='const'>BASE64_DIGITS</span>[<span class='id identifier rubyid_i'>i</span>]] <span class='op'>=</span> <span class='id identifier rubyid_i'>i</span> }</code></pre>

<p>So the value of &quot;A&quot; would be <code>0</code> and &quot;9&quot; would be <code>61</code>. So now we can represent numbers 0 up to 64 with only one character. Since we need to go higher than 64 digits, the VLQ lets us use a bit inside of the base64 bit value to determine if we continue or stop. In the spec it says that the base64 digit can contain 6 bits of data. The 6th bit is the &quot;continuation&quot; bit which tells us to either stop or keep going.</p>

<p>We can determine if a continuation bit is set with bit shifting and masking. So if we have 6 bits representing 1: &quot;000001&quot; it would take us 5 shifts to represent &quot;100000&quot; which would be only the continuation bit.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VLQ_BASE_SHIFT</span> <span class='op'>=</span> <span class='int'>5</span></code></pre>

<p>We then shift that position onto 1 to determine our mask</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VLQ_CONTINUATION_BIT</span> <span class='op'>=</span> <span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='const'>VLQ_BASE_SHIFT</span></code></pre>

<p>From the Ruby 2.2.3 docs this will shift the fixnum on the left (1) by the count positions on the right (VLQ_BASE_SHIFT) which is 5. This generates the number 32. We can verify this is our 6th bit with a little inspection</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VLQ_CONTINUATION_BIT</span>.<span class='id identifier rubyid_to_s'>to_s</span>(<span class='int'>2</span>)
<span class='comment'># =&gt; &quot;100000&quot;</span></code></pre>

<p>This works because we <code>to_s</code> accepts a base, by passing in a base of 2 we are returning binary representation.</p>

<p>Now we can determine if an integer has the continuation bit set by bit masking. Using a <a href="http://ruby-doc.org/core-2.2.3/Fixnum.html#method-i-26">bitwise &amp;</a> we mask out all the bits to zero except for the first one. If the result returned is 0 it means that the bit is not set and processing should not be continued:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_digit'>digit</span> <span class='op'>=</span> <span class='const'>BASE64_VALUES</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A</span><span class='tstring_end'>&quot;</span></span>]
<span class='id identifier rubyid_digit'>digit</span> <span class='op'>&amp;</span> <span class='const'>VLQ_CONTINUATION_BIT</span>
<span class='comment'># =&gt; 0</span></code></pre>

<p>So now we know how to detect for continuation bits, but how do we actually use them? In the previous example our mapping returned &quot;AAAA&quot;. Since an &quot;A&quot; maps to zero this would generate an array like</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_vlq_decode'>vlq_decode</span>(<span class='id identifier rubyid_str'>str</span>)
<span class='comment'># =&gt; [0]
</span>
<span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>AAAA</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_vlq_decode'>vlq_decode</span>(<span class='id identifier rubyid_str'>str</span>)
<span class='comment'># =&gt; [0, 0, 0, 0]</span></code></pre>

<p>The first character that has its continuation bit set is lowercase &quot;g&quot;. A lowercase &quot;g&quot; returns a value of <code>32</code>. The value of<code>vlq_decode(&quot;gA&quot;)</code> turns out to be equal to 0. So what would <code>vlq_decode(&quot;gB&quot;)</code> result in? To understand this we need to look a the whole method:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_vlq_decode'>vlq_decode</span>(<span class='id identifier rubyid_str'>str</span>)
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> []
  <span class='id identifier rubyid_chars'>chars</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>while</span> <span class='id identifier rubyid_chars'>chars</span>.<span class='id identifier rubyid_any?'>any?</span>
    <span class='id identifier rubyid_vlq'>vlq</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='id identifier rubyid_shift'>shift</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='id identifier rubyid_continuation'>continuation</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_continuation'>continuation</span>
      <span class='id identifier rubyid_char'>char</span> <span class='op'>=</span> <span class='id identifier rubyid_chars'>chars</span>.<span class='id identifier rubyid_shift'>shift</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Sprockets/ArgumentError.html" title="Sprockets::ArgumentError (class)">ArgumentError</a></span> <span class='kw'>unless</span> <span class='id identifier rubyid_char'>char</span>
      <span class='id identifier rubyid_digit'>digit</span> <span class='op'>=</span> <span class='const'>BASE64_VALUES</span>[<span class='id identifier rubyid_char'>char</span>]
      <span class='id identifier rubyid_continuation'>continuation</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='kw'>if</span> (<span class='id identifier rubyid_digit'>digit</span> <span class='op'>&amp;</span> <span class='const'>VLQ_CONTINUATION_BIT</span>) <span class='op'>==</span> <span class='int'>0</span>
      <span class='id identifier rubyid_digit'>digit</span> <span class='op'>&amp;=</span> <span class='const'>VLQ_BASE_MASK</span>
      <span class='id identifier rubyid_vlq'>vlq</span>   <span class='op'>+=</span> <span class='id identifier rubyid_digit'>digit</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_shift'>shift</span>
      <span class='id identifier rubyid_shift'>shift</span> <span class='op'>+=</span> <span class='const'>VLQ_BASE_SHIFT</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>&lt;&lt;</span> (<span class='id identifier rubyid_vlq'>vlq</span> <span class='op'>&amp;</span> <span class='int'>1</span> <span class='op'>==</span> <span class='int'>1</span> <span class='op'>?</span> <span class='op'>-</span>(<span class='id identifier rubyid_vlq'>vlq</span> <span class='op'>&gt;&gt;</span> <span class='int'>1</span>) <span class='op'>:</span> <span class='id identifier rubyid_vlq'>vlq</span> <span class='op'>&gt;&gt;</span> <span class='int'>1</span>)
  <span class='kw'>end</span>
  <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span></code></pre>

<p>For the first inner loop we would get a digit of <code>32</code> for the character &quot;g&quot;. We see the continuation bit is set, so we keep <code>continuation variable to</code>true<code>. We then mask and set the</code>digit` with <code>VLQ_BASE_MASK</code> which is</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VLQ_BASE_MASK</span> <span class='op'>=</span> <span class='const'>VLQ_BASE</span> <span class='op'>-</span> <span class='int'>1</span>
<span class='comment'># =&gt; 31
</span><span class='int'>31</span>.<span class='id identifier rubyid_to_s'>to_s</span>(<span class='int'>2</span>)
<span class='comment'># =&gt; &quot;111111&quot;</span></code></pre>

<p>So then</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_digit'>digit</span> <span class='op'>&amp;=</span> <span class='const'>VLQ_BASE_MASK</span>
<span class='comment'># =&gt; 0
</span><span class='id identifier rubyid_digit'>digit</span>.<span class='id identifier rubyid_to_s'>to_s</span>(<span class='int'>2</span>)
<span class='comment'># =&gt; &quot;0&quot;
</span><span class='comment'># or &quot;000000&quot;</span></code></pre>

<p>Whe then generate a <code>vl</code> by shifting the digit with the default value of <code>shift</code> which is 0</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_vlq'>vlq</span>   <span class='op'>+=</span> <span class='id identifier rubyid_digit'>digit</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_shift'>shift</span>
<span class='comment'># =&gt; 0</span></code></pre>

<p>So the value for this iteration would be zero.</p>

<p>Finally we update the shift value:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_shift'>shift</span> <span class='op'>+=</span> <span class='const'>VLQ_BASE_SHIFT</span>
<span class='comment'># =&gt; 5</span></code></pre>

<p>Since continuation is set to true, we go on to the next character &quot;B&quot;.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_digit'>digit</span> <span class='op'>=</span> <span class='const'>BASE64_VALUES</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>B</span><span class='tstring_end'>&quot;</span></span>]
<span class='comment'># =&gt; 1
</span><span class='id identifier rubyid_continuation'>continuation</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='kw'>if</span> (<span class='id identifier rubyid_digit'>digit</span> <span class='op'>&amp;</span> <span class='const'>VLQ_CONTINUATION_BIT</span>) <span class='op'>==</span> <span class='int'>0</span>
<span class='comment'># =&gt; false
</span><span class='id identifier rubyid_digit'>digit</span> <span class='op'>&amp;=</span> <span class='const'>VLQ_BASE_MASK</span>
<span class='comment'># =&gt; 1
</span><span class='id identifier rubyid_vlq'>vlq</span>   <span class='op'>+=</span> <span class='id identifier rubyid_digit'>digit</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_shift'>shift</span>
<span class='comment'># =&gt; 32
</span><span class='id identifier rubyid_shift'>shift</span> <span class='op'>+=</span> <span class='const'>VLQ_BASE_SHIFT</span>
<span class='comment'># =&gt; 10</span></code></pre>

<p>Now we have no more characters and continuation is false. We then add to our result. We use the first bit to check for sign so &quot;000001&quot; is a negative number. Since that is not the case, we shift the value of the vlq to the right so 32 which is &quot;100000&quot; becomes &quot;010000&quot; which is:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_vlq'>vlq</span> <span class='op'>&gt;&gt;</span> <span class='int'>1</span>
<span class='comment'># =&gt; [16]</span></code></pre>

<p>This is our result:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_vlq_decode'>vlq_decode</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gC</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; [16]</span></code></pre>

<p>So what would <code>vlq_decode(&quot;gC&quot;)</code> generate? The first iteration will be the same.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_digit'>digit</span> <span class='op'>=</span> <span class='const'>BASE64_VALUES</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>g</span><span class='tstring_end'>&quot;</span></span>]
<span class='comment'># =&gt; 32
</span><span class='id identifier rubyid_continuation'>continuation</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='kw'>if</span> (<span class='id identifier rubyid_digit'>digit</span> <span class='op'>&amp;</span> <span class='const'>VLQ_CONTINUATION_BIT</span>) <span class='op'>==</span> <span class='int'>0</span>
<span class='comment'># continuation does not change, still true
</span><span class='id identifier rubyid_digit'>digit</span> <span class='op'>&amp;=</span> <span class='const'>VLQ_BASE_MASK</span>
<span class='comment'># =&gt; 0
</span><span class='id identifier rubyid_vlq'>vlq</span>   <span class='op'>+=</span> <span class='id identifier rubyid_digit'>digit</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_shift'>shift</span>
<span class='comment'># =&gt; 0
</span><span class='id identifier rubyid_shift'>shift</span> <span class='op'>+=</span> <span class='const'>VLQ_BASE_SHIFT</span>
<span class='comment'># =&gt; 5</span></code></pre>

<p>The second time the only thing that is different with <code>&quot;C&quot;</code> is the digit and vlq:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_digit'>digit</span> <span class='op'>&amp;=</span> <span class='const'>VLQ_BASE_MASK</span>
<span class='comment'># =&gt; 2
</span><span class='id identifier rubyid_vlq'>vlq</span>   <span class='op'>+=</span> <span class='id identifier rubyid_digit'>digit</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_shift'>shift</span>
<span class='comment'># =&gt; 64</span></code></pre>

<p>The vlq <code>64</code> does not have it&#39;s first bit set so it is positive. We shift this right by 1 and since we lose a bit, we get <code>32</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_vlq_decode'>vlq_decode</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gC</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; [32]</span></code></pre>

<p>So our initial output from <code>foo.js</code> is</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_vlq_decode'>vlq_decode</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>AAAA</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'>#=&gt; [0, 0, 0, 0]
</span><span class='id identifier rubyid_vlq_decode'>vlq_decode</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GAAIA</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'>#=&gt; [3, 0, 0, 4, 0]</span></code></pre>

<h2>Sprockets Internal Map support</h2>

<p>Internally sprockets stores maps as hashes that look like this:
We need to be able to generate information like</p>

<pre class="code ruby"><code class="ruby">{
  <span class='symbeg'>:</span><span class='id identifier rubyid_source'>source</span><span class='op'>=&gt;</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>example.coffee</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_generated'>generated</span><span class='op'>=&gt;</span>[<span class='int'>6</span><span class='comma'>,</span> <span class='int'>2</span>]<span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_original'>original</span><span class='op'>=&gt;</span>[<span class='int'>2</span><span class='comma'>,</span> <span class='int'>0</span>]<span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='op'>=&gt;</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>number</span><span class='tstring_end'>&quot;</span></span>
}</code></pre>

<p>This would be for the case where <code>example.coffee</code> has a value called <code>number</code></p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Assignment:
</span><span class='id identifier rubyid_number'>number</span>   <span class='op'>=</span> <span class='int'>42</span></code></pre>

<p>In the original document is on the 2nd line, and it&#39;s first character is on the 1st column, so it starts on the 0th column.</p>

<p>Compiling this file will generate a coffee script file that starts with this:</p>

<pre class="code ruby"><code class="ruby"><span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span> <span class='const'>Generated</span> <span class='id identifier rubyid_by'>by</span> <span class='const'>CoffeeScript</span> <span class='float'>1.8</span>
(<span class='id identifier rubyid_function'>function</span>() {
  <span class='id identifier rubyid_var'>var</span> <span class='id identifier rubyid_cubes'>cubes</span><span class='comma'>,</span> <span class='id identifier rubyid_list'>list</span><span class='comma'>,</span> <span class='id identifier rubyid_math'>math</span><span class='comma'>,</span> <span class='id identifier rubyid_num'>num</span><span class='comma'>,</span> <span class='id identifier rubyid_number'>number</span><span class='comma'>,</span> <span class='id identifier rubyid_opposite'>opposite</span><span class='comma'>,</span> <span class='id identifier rubyid_race'>race</span><span class='comma'>,</span> <span class='id identifier rubyid_square'>square</span><span class='comma'>,</span>
    <span class='id identifier rubyid___slice'>__slice</span> <span class='op'>=</span> [].<span class='id identifier rubyid_slice'>slice</span><span class='semicolon'>;</span>

  <span class='id identifier rubyid_number'>number</span> <span class='op'>=</span> <span class='int'>42</span><span class='semicolon'>;</span>
  <span class='comment'># ...</span></code></pre>

<p>You can see that the generated <code>number</code> variable gets assigned on the 6th line and the first character is on the 3rd column so it starts on the 2nd column.</p>

<h2>Mapping format</h2>

<p>The mapping field contains VLQ encoded strings as well as commas &quot;,&quot; and semicolons &quot;;&quot; that are used as delimiters.</p>

<pre class="code ruby"><code class="ruby"><span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span> <span class='const'>A</span> <span class='id identifier rubyid_single'>single</span> <span class='id identifier rubyid_base'>base</span> <span class='int'>64</span> <span class='id identifier rubyid_digit'>digit</span> <span class='id identifier rubyid_can'>can</span> <span class='id identifier rubyid_contain'>contain</span> <span class='int'>6</span> <span class='id identifier rubyid_bits'>bits</span> <span class='id identifier rubyid_of'>of</span> <span class='id identifier rubyid_data'>data</span>. <span class='const'>For</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_base'>base</span> <span class='int'>64</span> <span class='id identifier rubyid_variable'>variable</span>
<span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span> <span class='id identifier rubyid_length'>length</span> <span class='id identifier rubyid_quantities'>quantities</span> <span class='id identifier rubyid_we'>we</span> <span class='id identifier rubyid_use'>use</span> <span class='kw'>in</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_source'>source</span> <span class='id identifier rubyid_map'>map</span> <span class='id identifier rubyid_spec'>spec</span><span class='comma'>,</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_first'>first</span> <span class='id identifier rubyid_bit'>bit</span> <span class='id identifier rubyid_is'>is</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_sign'>sign</span><span class='comma'>,</span>
<span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span> <span class='id identifier rubyid_the'>the</span> <span class='kw'>next</span> <span class='id identifier rubyid_four'>four</span> <span class='id identifier rubyid_bits'>bits</span> <span class='id identifier rubyid_are'>are</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_actual'>actual</span> <span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='kw'>and</span> <span class='id identifier rubyid_the'>the</span> <span class='int'>6</span><span class='id identifier rubyid_th'>th</span> <span class='id identifier rubyid_bit'>bit</span> <span class='id identifier rubyid_is'>is</span> <span class='id identifier rubyid_the'>the</span>
<span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span> <span class='id identifier rubyid_continuation'>continuation</span> <span class='id identifier rubyid_bit'>bit</span>. <span class='const'>The</span> <span class='id identifier rubyid_continuation'>continuation</span> <span class='id identifier rubyid_bit'>bit</span> <span class='id identifier rubyid_tells'>tells</span> <span class='id identifier rubyid_us'>us</span> <span class='id identifier rubyid_whether'>whether</span> <span class='id identifier rubyid_there'>there</span> <span class='id identifier rubyid_are'>are</span> <span class='id identifier rubyid_more'>more</span>
<span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span> <span class='id identifier rubyid_digits'>digits</span> <span class='kw'>in</span> <span class='id identifier rubyid_this'>this</span> <span class='id identifier rubyid_value'>value</span> <span class='id identifier rubyid_following'>following</span> <span class='id identifier rubyid_this'>this</span> <span class='id identifier rubyid_digit'>digit</span>.
<span class='op'>/</span><span class='op'>/</span>
<span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span>   <span class='const'>Continuation</span>
<span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span>   <span class='op'>|</span>    <span class='const'>Sign</span>
<span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span>   <span class='op'>|</span>    <span class='op'>|</span>
<span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span>   <span class='const'>V</span>    <span class='const'>V</span>
<span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span>   <span class='int'>101011</span></code></pre>

<p>I have no idea</p>

<p>The “mappings” data is broken down as follows:</p>

<ul>
<li>each group representing a line in the generated file is separated by a ”;”</li>
<li>each segment is separated by a “,”</li>
<li>each segment is made up of 1,4 or 5 variable length fields.</li>
</ul>

<p>Confused? I was.</p>

<p>Lots of this is raw notes, take with a grain of salt.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>