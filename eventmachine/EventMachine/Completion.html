<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: EventMachine::Completion &mdash; EventMachine master</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "EventMachine::Completion",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>EventMachine master</a> &raquo; 
      <a href='../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../EventMachine.html" title="EventMachine (module)">EventMachine</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Completion&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: EventMachine::Completion</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="Deferrable.html" title="EventMachine::Deferrable (module)"><code>Deferrable</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="../Object.html" title="Object (class)">Object</a></span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L167'>lib/em/completion.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    <p>An EM::Completion instance is a callback container for various states of
completion. In its most basic form it has a start state and a finish state.</p>

<p>This implementation includes some hold-back from the EM::Deferrable
interface in order to be compatible - but it has a much cleaner
implementation.</p>

<p>In general it is preferred that this implementation be used as a state
callback container than EM::DefaultDeferrable or other classes including
EM::Deferrable. This is because it is generally more sane to keep this level
of state in a dedicated state-back container. This generally leads to more
malleable interfaces and software designs, as well as eradicating nasty bugs
that result from abstraction leakage.</p>

<h3>Basic Usage</h3>

<p>As already mentioned, the basic usage of a <code>Completion</code> is simply for its two
final states, <code>:succeeded</code> and <code>:failed</code>.</p>

<p>An asynchronous operation will complete at some future point in time, and
users often want to react to this event. API authors will want to expose
some common interface to react to these events.</p>

<p>In the following example, the user wants to know when a short lived
connection has completed its exchange with the remote server. The simple
protocol just waits for an ack to its message.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Protocol</span> <span class='op'>&lt;</span> <span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span><span class='op'>::</span><span class='const'><a href="Connection.html" title="EventMachine::Connection (class)">Connection</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span><span class='op'>::</span><span class='const'><a href="../EventMachine.html#P-constant" title="EventMachine::P (constant)">P</a></span><span class='op'>::</span><span class='const'>LineText2</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>)
    <span class='ivar'>@message</span><span class='comma'>,</span> <span class='ivar'>@completion</span> <span class='op'>=</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>
    <span class='ivar'>@completion</span>.<span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span> { <span class='id identifier rubyid_close_connection'><a href="../EventMachine.html#close_connection-class_method" title="EventMachine.close_connection (method)">close_connection</a></span> }
    <span class='ivar'>@completion</span>.<span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="EventMachine::Completion#timeout (method)">timeout</a></span>(<span class='int'>1</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="EventMachine::Completion#timeout (method)">timeout</a></span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='id identifier rubyid_send_data'><a href="../EventMachine.html#send_data-class_method" title="EventMachine.send_data (method)">send_data</a></span>(<span class='ivar'>@message</span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_receive_line'>receive_line</span>(<span class='id identifier rubyid_line'>line</span>)
    <span class='kw'>case</span> <span class='id identifier rubyid_line'>line</span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>ACK</span><span class='regexp_end'>/i</span></span>
      <span class='ivar'>@completion</span>.<span class='id identifier rubyid_succeed'><a href="#succeed-instance_method" title="EventMachine::Completion#succeed (method)">succeed</a></span> <span class='id identifier rubyid_line'>line</span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>ERR</span><span class='regexp_end'>/i</span></span>
      <span class='ivar'>@completion</span>.<span class='id identifier rubyid_fail'><a href="#fail-instance_method" title="EventMachine::Completion#fail (method)">fail</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid_line'>line</span>
    <span class='kw'>else</span>
      <span class='ivar'>@completion</span>.<span class='id identifier rubyid_fail'><a href="#fail-instance_method" title="EventMachine::Completion#fail (method)">fail</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_unknown'>unknown</span><span class='comma'>,</span> <span class='id identifier rubyid_line'>line</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='ivar'>@completion</span>.<span class='id identifier rubyid_fail'><a href="#fail-instance_method" title="EventMachine::Completion#fail (method)">fail</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_disconnected'>disconnected</span> <span class='kw'>unless</span> <span class='ivar'>@completion</span>.<span class='id identifier rubyid_completed?'><a href="#completed%3F-instance_method" title="EventMachine::Completion#completed? (method)">completed?</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>API</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_port'>port</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>example.org</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>8000</span>)
    <span class='ivar'>@host</span><span class='comma'>,</span> <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_request'>request</span>(<span class='id identifier rubyid_message'>message</span>)
    <span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span> <span class='op'>=</span> <span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span><span class='op'>::</span><span class='const'><a href="Deferrable.html" title="EventMachine::Deferrable (module)">Deferrable</a></span><span class='op'>::</span><span class='const'>Completion</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="EventMachine::Completion.new (method)">new</a></span>
    <span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span>.<span class='id identifier rubyid_connect'><a href="../EventMachine.html#connect-class_method" title="EventMachine.connect (method)">connect</a></span>(<span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='const'>Protocol</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>)
    <span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_api'>api</span> <span class='op'>=</span> <span class='const'>API</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="EventMachine::Completion.new (method)">new</a></span>
<span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span> <span class='op'>=</span> <span class='id identifier rubyid_api'>api</span>.<span class='id identifier rubyid_request'>request</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>stuff</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>.<span class='id identifier rubyid_callback'><a href="#callback-instance_method" title="EventMachine::Completion#callback (method)">callback</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API responded with: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_line'>line</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
<span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>.<span class='id identifier rubyid_errback'><a href="#errback-instance_method" title="EventMachine::Completion#errback (method)">errback</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_type'>type</span><span class='comma'>,</span> <span class='id identifier rubyid_line'>line</span><span class='op'>|</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_type'>type</span>
  <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_line'>line</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unknown'>unknown</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API returned unknown response: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_line'>line</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_disconnected'>disconnected</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API server disconnected prematurely</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="EventMachine::Completion#timeout (method)">timeout</a></span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API server did not respond in a timely fashion</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Advanced Usage</h3>

<p>This completion implementation also supports more state callbacks and
arbitrary states (unlike the original Deferrable API). This allows for basic
stateful process encapsulation. One might use this to setup state callbacks
for various states in an exchange like in the basic usage example, except
where the applicaiton could be made to react to &quot;connected&quot; and
&quot;disconnected&quot; states additionally.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Protocol</span> <span class='op'>&lt;</span> <span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span><span class='op'>::</span><span class='const'><a href="Connection.html" title="EventMachine::Connection (class)">Connection</a></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>)
    <span class='ivar'>@response</span> <span class='op'>=</span> []
    <span class='ivar'>@completion</span> <span class='op'>=</span> <span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>
    <span class='ivar'>@completion</span>.<span class='id identifier rubyid_stateback'><a href="#stateback-instance_method" title="EventMachine::Completion#stateback (method)">stateback</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_disconnected'>disconnected</span>) <span class='kw'>do</span>
      <span class='ivar'>@completion</span>.<span class='id identifier rubyid_succeed'><a href="#succeed-instance_method" title="EventMachine::Completion#succeed (method)">succeed</a></span> <span class='ivar'>@response</span>.<span class='id identifier rubyid_join'>join</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_connection_completed'>connection_completed</span>
    <span class='ivar'>@host</span><span class='comma'>,</span> <span class='ivar'>@port</span> <span class='op'>=</span> <span class='const'>Socket</span>.<span class='id identifier rubyid_unpack_sockaddr_in'>unpack_sockaddr_in</span> <span class='id identifier rubyid_get_peername'><a href="../EventMachine.html#get_peername-class_method" title="EventMachine.get_peername (method)">get_peername</a></span>
    <span class='ivar'>@completion</span>.<span class='id identifier rubyid_change_state'><a href="#change_state-instance_method" title="EventMachine::Completion#change_state (method)">change_state</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_connected'>connected</span><span class='comma'>,</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='ivar'>@port</span>)
    <span class='id identifier rubyid_send_data'><a href="../EventMachine.html#send_data-class_method" title="EventMachine.send_data (method)">send_data</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GET http://example.org/ HTTP/1.0\r\n\r\n</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span>(<span class='id identifier rubyid_data'>data</span>)
    <span class='ivar'>@response</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_data'>data</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='ivar'>@completion</span>.<span class='id identifier rubyid_change_state'><a href="#change_state-instance_method" title="EventMachine::Completion#change_state (method)">change_state</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_disconnected'>disconnected</span><span class='comma'>,</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='ivar'>@port</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span> <span class='op'>=</span> <span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span><span class='op'>::</span><span class='const'><a href="Deferrable.html" title="EventMachine::Deferrable (module)">Deferrable</a></span><span class='op'>::</span><span class='const'>Completion</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="EventMachine::Completion.new (method)">new</a></span>
<span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>.<span class='id identifier rubyid_stateback'><a href="#stateback-instance_method" title="EventMachine::Completion#stateback (method)">stateback</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_connected'>connected</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connected to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
<span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>.<span class='id identifier rubyid_stateback'><a href="#stateback-instance_method" title="EventMachine::Completion#stateback (method)">stateback</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_disconnected'>disconnected</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Disconnected from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
<span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>.<span class='id identifier rubyid_callback'><a href="#callback-instance_method" title="EventMachine::Completion#callback (method)">callback</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_response'>response</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_response'>response</span>
<span class='kw'>end</span>

<span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span>.<span class='id identifier rubyid_connect'><a href="../EventMachine.html#connect-class_method" title="EventMachine.connect (method)">connect</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>example.org</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>80</span><span class='comma'>,</span> <span class='const'>Protocol</span><span class='comma'>,</span> <span class='id identifier rubyid_completion'><a href="#completion-instance_method" title="EventMachine::Completion#completion (method)">completion</a></span>)</code></pre>

<h3>Timeout</h3>

<p>The Completion also has a timeout. The timeout is global and is not aware of
states apart from completion states. The timeout is only engaged if #timeout
is called, and it will call fail if it is reached.</p>

<h3>Completion states</h3>

<p>By default there are two completion states, :succeeded and :failed. These
states can be modified by subclassing and overrding the #completion_states
method. Completion states are special, in that callbacks for all completion
states are explcitly cleared when a completion state is entered. This
prevents errors that could arise from accidental unterminated timeouts, and
other such user errors.</p>

<h3>Other notes</h3>

<p>Several APIs have been carried over from EM::Deferrable for compatibility
reasons during a transitionary period. Specifically cancel_errback and
cancel_callback are implemented, but their usage is to be strongly
discouraged. Due to the already complex nature of reaction systems, dynamic
callback deletion only makes the problem much worse. It is always better to
add correct conditionals to the callback code, or use more states, than to
address such implementaiton issues with conditional callbacks.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
  <h3 class='inherited'><a href="Deferrable.html" title="EventMachine::Deferrable (module)"><code>Deferrable</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="Deferrable.html#Pool-constant" title="EventMachine::Deferrable::Pool (constant)">Pool</a>
  </p>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>  &#x21d2; Completion </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#completed%3F-instance_method" title="#completed? (instance method)">#<strong>completed?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Indicates that we&#39;ve reached some kind of completion state, by default this is <code>:succeeded</code> or <code>:failed</code>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#state-instance_method" title="#state (instance method)">#<strong>state</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#value-instance_method" title="#value (instance method)">#<strong>value</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#callback-instance_method" title="#callback (instance method)">#<strong>callback</strong>(*a, &amp;b)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Callbacks are called when you enter (or are in) a <code>:succeeded</code> state.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#cancel_callback-instance_method" title="#cancel_callback (instance method)">#<strong>cancel_callback</strong>(*a, &amp;b)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Remove a callback.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#cancel_errback-instance_method" title="#cancel_errback (instance method)">#<strong>cancel_errback</strong>(*a, &amp;b)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Remove an errback.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#cancel_timeout-instance_method" title="#cancel_timeout (instance method)">#<strong>cancel_timeout</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Disable the timeout.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#change_state-instance_method" title="#change_state (instance method)">#<strong>change_state</strong>(state, *args)  </a>
      (also: #set_deferred_status)
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Enter a new state, setting the result value if given.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#completion-instance_method" title="#completion (instance method)">#<strong>completion</strong>(*a, &amp;b)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Completions are called when you enter (or are in) either a <code>:failed</code> or a <code>:succeeded</code> state.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#completion_states-instance_method" title="#completion_states (instance method)">#<strong>completion_states</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p><code>Completion</code> states simply returns a list of completion states, by default this is <code>:succeeded</code> and <code>:failed</code>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#errback-instance_method" title="#errback (instance method)">#<strong>errback</strong>(*a, &amp;b)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Errbacks are called when you enter (or are in) a <code>:failed</code> state.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#fail-instance_method" title="#fail (instance method)">#<strong>fail</strong>(*args)  </a>
      (also: #set_deferred_failure)
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Enter the <code>:failed</code> state, setting the result value if given.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#set_deferred_failure-instance_method" title="#set_deferred_failure (instance method)">#<strong>set_deferred_failure</strong>(*args)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Alias for <a href="#fail-instance_method" title="EventMachine::Completion#fail (method)">#fail</a>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#set_deferred_status-instance_method" title="#set_deferred_status (instance method)">#<strong>set_deferred_status</strong>(state, *args)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Alias for <a href="#change_state-instance_method" title="EventMachine::Completion#change_state (method)">#change_state</a>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#set_deferred_success-instance_method" title="#set_deferred_success (instance method)">#<strong>set_deferred_success</strong>(*args)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Alias for <a href="#succeed-instance_method" title="EventMachine::Completion#succeed (method)">#succeed</a>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#stateback-instance_method" title="#stateback (instance method)">#<strong>stateback</strong>(state, *a, &amp;b)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Statebacks are called when you enter (or are in) the named state.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#succeed-instance_method" title="#succeed (instance method)">#<strong>succeed</strong>(*args)  </a>
      (also: #set_deferred_success)
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Enter the <code>:succeeded</code> state, setting the result value if given.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#timeout-instance_method" title="#timeout (instance method)">#<strong>timeout</strong>(time, *args)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Schedule a time which if passes before we enter a completion state, this deferrable will be failed with the given arguments.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#clear_dead_callbacks-instance_method" title="#clear_dead_callbacks (instance method)">#<strong>clear_dead_callbacks</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>If we enter a completion state, clear other completion states after all callback chains are completed.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#execute_callbacks-instance_method" title="#execute_callbacks (instance method)">#<strong>execute_callbacks</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Execute all callbacks for the current state.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#execute_state_callbacks-instance_method" title="#execute_state_callbacks (instance method)">#<strong>execute_state_callbacks</strong>(state)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Iterate all callbacks for a given state, and remove then call them.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited'><a href="Deferrable.html" title="EventMachine::Deferrable (module)"><code>Deferrable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#callback-instance_method" title="EventMachine::Deferrable#callback (method)">#callback</a></td>
      <td><div class='inline'><p>Specify a block to be executed if and when the <a href="Deferrable.html" title="EventMachine::Deferrable (module)"><code>Deferrable</code></a> object receives a status of <code>:succeeded</code>.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#cancel_callback-instance_method" title="EventMachine::Deferrable#cancel_callback (method)">#cancel_callback</a></td>
      <td><div class='inline'><p>Cancels an outstanding callback to &amp;block if any.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#cancel_errback-instance_method" title="EventMachine::Deferrable#cancel_errback (method)">#cancel_errback</a></td>
      <td><div class='inline'><p>Cancels an outstanding errback to &amp;block if any.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#cancel_timeout-instance_method" title="EventMachine::Deferrable#cancel_timeout (method)">#cancel_timeout</a></td>
      <td><div class='inline'><p>Cancels an outstanding timeout if any.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#errback-instance_method" title="EventMachine::Deferrable#errback (method)">#errback</a></td>
      <td><div class='inline'><p>Specify a block to be executed if and when the <a href="Deferrable.html" title="EventMachine::Deferrable (module)"><code>Deferrable</code></a> object receives a status of <code>:failed</code>.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#fail-instance_method" title="EventMachine::Deferrable#fail (method)">#fail</a></td>
      <td><div class='inline'><p>Sugar for set_deferred_status(:failed, ...).</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#set_deferred_failure-instance_method" title="EventMachine::Deferrable#set_deferred_failure (method)">#set_deferred_failure</a></td>
      <td><div class='inline'><p>Alias for <a href="Deferrable.html#fail-instance_method" title="EventMachine::Deferrable#fail (method)">Deferrable#fail</a>.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#set_deferred_status-instance_method" title="EventMachine::Deferrable#set_deferred_status (method)">#set_deferred_status</a></td>
      <td><div class='inline'><p>Sets the &quot;disposition&quot; (status) of the <a href="Deferrable.html" title="EventMachine::Deferrable (module)"><code>Deferrable</code></a> object.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#set_deferred_success-instance_method" title="EventMachine::Deferrable#set_deferred_success (method)">#set_deferred_success</a></td>
      <td><div class='inline'><p>Alias for <a href="Deferrable.html#succeed-instance_method" title="EventMachine::Deferrable#succeed (method)">Deferrable#succeed</a>.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#succeed-instance_method" title="EventMachine::Deferrable#succeed (method)">#succeed</a></td>
      <td><div class='inline'><p>Sugar for set_deferred_status(:succeeded, ...).</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Deferrable.html#timeout-instance_method" title="EventMachine::Deferrable#timeout (method)">#timeout</a></td>
      <td><div class='inline'><p>Setting a timeout on a <a href="Deferrable.html" title="EventMachine::Deferrable (module)"><code>Deferrable</code></a> causes it to go into the failed state after the Timeout expires (passing no arguments to the object&#39;s errbacks).</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>  &#x21d2; <code>Completion</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L174-L179'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='174' data-end='179'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 174</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>
  <span class='ivar'>@state</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unknown'>unknown</span>
  <span class='ivar'>@callbacks</span> <span class='op'>=</span> <span class='const'>Hash</span>.<span class='id identifier rubyid_new'>new</span> { <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_h'>h</span>[<span class='id identifier rubyid_k'>k</span>] <span class='op'>=</span> [] }
  <span class='ivar'>@value</span> <span class='op'>=</span> []
  <span class='ivar'>@timeout_timer</span> <span class='op'>=</span> <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="completed?-instance_method">
  <h3 class='signature ro first'>
    #<strong>completed?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Indicates that we&#39;ve reached some kind of completion state, by default
this is <code>:succeeded</code> or <code>:failed</code>. Due to these semantics, the <code>:completed</code>
state is reserved for internal use.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L240-L242'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='240' data-end='242'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 240</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_completed?'>completed?</span>
  <span class='id identifier rubyid_completion_states'><a href="#completion_states-instance_method" title="EventMachine::Completion#completion_states (method)">completion_states</a></span>.<span class='id identifier rubyid_any?'>any?</span> { <span class='op'>|</span><span class='id identifier rubyid_s'>s</span><span class='op'>|</span> <span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span> <span class='op'>==</span> <span class='id identifier rubyid_s'>s</span> }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="state-instance_method">
  <h3 class='signature ro'>
    #<strong>state</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L172-L172'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='172' data-end='172'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 172</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_value'><a href="#value-instance_method" title="EventMachine::Completion#value (method)">value</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="value-instance_method">
  <h3 class='signature ro'>
    #<strong>value</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L172-L172'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='172' data-end='172'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 172</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_value'>value</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="callback-instance_method">
  <h3 class='signature  first'>
    #<strong>callback</strong>(*a, &amp;b)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Callbacks are called when you enter (or are in) a <code>:succeeded</code> state.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L209-L211'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='209' data-end='211'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 209</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_callback'>callback</span>(<span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>)
  <span class='id identifier rubyid_stateback'><a href="#stateback-instance_method" title="EventMachine::Completion#stateback (method)">stateback</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_succeeded'>succeeded</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cancel_callback-instance_method">
  <h3 class='signature '>
    #<strong>cancel_callback</strong>(*a, &amp;b)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Remove a callback. N.B. Some callbacks cannot be deleted. Usage is NOT
recommended, this is an anti-pattern.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L275-L277'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='275' data-end='277'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 275</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cancel_callback'>cancel_callback</span>(<span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>)
  <span class='ivar'>@callbacks</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_succeeded'>succeeded</span>].<span class='id identifier rubyid_delete'>delete</span>(<span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span><span class='op'>::</span><span class='const'><a href="../EventMachine.html#Callback-class_method" title="EventMachine.Callback (method)">Callback</a></span>(<span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>))
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cancel_errback-instance_method">
  <h3 class='signature '>
    #<strong>cancel_errback</strong>(*a, &amp;b)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Remove an errback. N.B. Some errbacks cannot be deleted. Usage is NOT
recommended, this is an anti-pattern.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L269-L271'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='269' data-end='271'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 269</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cancel_errback'>cancel_errback</span>(<span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>)
  <span class='ivar'>@callbacks</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_failed'>failed</span>].<span class='id identifier rubyid_delete'>delete</span>(<span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span><span class='op'>::</span><span class='const'><a href="../EventMachine.html#Callback-class_method" title="EventMachine.Callback (method)">Callback</a></span>(<span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>))
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cancel_timeout-instance_method">
  <h3 class='signature '>
    #<strong>cancel_timeout</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Disable the timeout</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L260-L265'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='260' data-end='265'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 260</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cancel_timeout'>cancel_timeout</span>
  <span class='kw'>if</span> <span class='ivar'>@timeout_timer</span>
    <span class='ivar'>@timeout_timer</span>.<span class='id identifier rubyid_cancel'>cancel</span>
    <span class='ivar'>@timeout_timer</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="change_state-instance_method">
  <h3 class='signature '>
    #<strong>change_state</strong>(state, *args)  
    <span class='aliases'>Also known as: <span class='names'>#set_deferred_status</span></span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Enter a new state, setting the result value if given. If the state is one
of <code>:succeeded</code> or <code>:failed</code>, then <code>:completed</code> callbacks will also be called.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L227-L232'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='227' data-end='232'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 227</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_change_state'>change_state</span>(<span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='ivar'>@value</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span>
  <span class='ivar'>@state</span> <span class='op'>=</span> <span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span>

  <span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span>.<span class='id identifier rubyid_schedule'><a href="../EventMachine.html#schedule-class_method" title="EventMachine.schedule (method)">schedule</a></span> { <span class='id identifier rubyid_execute_callbacks'><a href="#execute_callbacks-instance_method" title="EventMachine::Completion#execute_callbacks (method)">execute_callbacks</a></span> }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="clear_dead_callbacks-instance_method">
  <h3 class='signature priv'>
    #<strong>clear_dead_callbacks</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>If we enter a completion state, clear other completion states after all
callback chains are completed. This means that operation specific
callbacks can&#39;t be dual-called, which is most common user error.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L301-L305'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='301' data-end='305'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 301</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_clear_dead_callbacks'>clear_dead_callbacks</span>
  <span class='id identifier rubyid_completion_states'><a href="#completion_states-instance_method" title="EventMachine::Completion#completion_states (method)">completion_states</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span><span class='op'>|</span>
    <span class='ivar'>@callbacks</span>[<span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span>].<span class='id identifier rubyid_clear'>clear</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="completion-instance_method">
  <h3 class='signature '>
    #<strong>completion</strong>(*a, &amp;b)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Completions are called when you enter (or are in) either a <code>:failed</code> or a
<code>:succeeded</code> state. They are stored as a special (reserved) state called
<code>:completed</code>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L221-L223'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='221' data-end='223'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 221</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_completion'>completion</span>(<span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>)
  <span class='id identifier rubyid_stateback'><a href="#stateback-instance_method" title="EventMachine::Completion#stateback (method)">stateback</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_completed'>completed</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="completion_states-instance_method">
  <h3 class='signature '>
    #<strong>completion_states</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p><code>Completion</code> states simply returns a list of completion states, by default
this is <code>:succeeded</code> and <code>:failed</code>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L246-L248'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='246' data-end='248'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 246</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_completion_states'>completion_states</span>
  [<span class='symbeg'>:</span><span class='id identifier rubyid_succeeded'>succeeded</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_failed'>failed</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="errback-instance_method">
  <h3 class='signature '>
    #<strong>errback</strong>(*a, &amp;b)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Errbacks are called when you enter (or are in) a <code>:failed</code> state.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L214-L216'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='214' data-end='216'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 214</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_errback'>errback</span>(<span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>)
  <span class='id identifier rubyid_stateback'><a href="#stateback-instance_method" title="EventMachine::Completion#stateback (method)">stateback</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_failed'>failed</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="execute_callbacks-instance_method">
  <h3 class='signature priv'>
    #<strong>execute_callbacks</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Execute all callbacks for the current state. If in a completed state, then
call any statebacks associated with the completed state.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L282-L289'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='282' data-end='289'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 282</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_execute_callbacks'>execute_callbacks</span>
  <span class='id identifier rubyid_execute_state_callbacks'><a href="#execute_state_callbacks-instance_method" title="EventMachine::Completion#execute_state_callbacks (method)">execute_state_callbacks</a></span>(<span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_completed?'><a href="#completed%3F-instance_method" title="EventMachine::Completion#completed? (method)">completed?</a></span>
    <span class='id identifier rubyid_execute_state_callbacks'><a href="#execute_state_callbacks-instance_method" title="EventMachine::Completion#execute_state_callbacks (method)">execute_state_callbacks</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_completed'>completed</span>)
    <span class='id identifier rubyid_clear_dead_callbacks'><a href="#clear_dead_callbacks-instance_method" title="EventMachine::Completion#clear_dead_callbacks (method)">clear_dead_callbacks</a></span>
    <span class='id identifier rubyid_cancel_timeout'><a href="#cancel_timeout-instance_method" title="EventMachine::Completion#cancel_timeout (method)">cancel_timeout</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="execute_state_callbacks-instance_method">
  <h3 class='signature priv'>
    #<strong>execute_state_callbacks</strong>(state)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Iterate all callbacks for a given state, and remove then call them.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L292-L296'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='292' data-end='296'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 292</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_execute_state_callbacks'>execute_state_callbacks</span>(<span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span>)
  <span class='kw'>while</span> <span class='id identifier rubyid_callback'><a href="#callback-instance_method" title="EventMachine::Completion#callback (method)">callback</a></span> <span class='op'>=</span> <span class='ivar'>@callbacks</span>[<span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span>].<span class='id identifier rubyid_shift'>shift</span>
    <span class='id identifier rubyid_callback'><a href="#callback-instance_method" title="EventMachine::Completion#callback (method)">callback</a></span>.<span class='id identifier rubyid_call'>call</span>(<span class='op'>*</span><span class='id identifier rubyid_value'><a href="#value-instance_method" title="EventMachine::Completion#value (method)">value</a></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="fail-instance_method">
  <h3 class='signature '>
    #<strong>fail</strong>(*args)  
    <span class='aliases'>Also known as: <span class='names'>#set_deferred_failure</span></span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Enter the <code>:failed</code> state, setting the result value if given.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L189-L191'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='189' data-end='191'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 189</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_fail'>fail</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='id identifier rubyid_change_state'><a href="#change_state-instance_method" title="EventMachine::Completion#change_state (method)">change_state</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_failed'>failed</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="set_deferred_failure-instance_method">
  <h3 class='signature '>
    #<strong>set_deferred_failure</strong>(*args)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Alias for <a href="#fail-instance_method" title="EventMachine::Completion#fail (method)">#fail</a>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L193-L193'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='193' data-end='193'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 193</span></pre>
<pre class='code ruby'>

<span class='kw'>alias</span> <span class='id identifier rubyid_set_deferred_failure'>set_deferred_failure</span> <span class='id identifier rubyid_fail'><a href="#fail-instance_method" title="EventMachine::Completion#fail (method)">fail</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="set_deferred_status-instance_method">
  <h3 class='signature '>
    #<strong>set_deferred_status</strong>(state, *args)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Alias for <a href="#change_state-instance_method" title="EventMachine::Completion#change_state (method)">#change_state</a>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L235-L235'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='235' data-end='235'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 235</span></pre>
<pre class='code ruby'>

<span class='kw'>alias</span> <span class='id identifier rubyid_set_deferred_status'>set_deferred_status</span> <span class='id identifier rubyid_change_state'><a href="#change_state-instance_method" title="EventMachine::Completion#change_state (method)">change_state</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="set_deferred_success-instance_method">
  <h3 class='signature '>
    #<strong>set_deferred_success</strong>(*args)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Alias for <a href="#succeed-instance_method" title="EventMachine::Completion#succeed (method)">#succeed</a>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L186-L186'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='186' data-end='186'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 186</span></pre>
<pre class='code ruby'>

<span class='kw'>alias</span> <span class='id identifier rubyid_set_deferred_success'>set_deferred_success</span> <span class='id identifier rubyid_succeed'><a href="#succeed-instance_method" title="EventMachine::Completion#succeed (method)">succeed</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="stateback-instance_method">
  <h3 class='signature '>
    #<strong>stateback</strong>(state, *a, &amp;b)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Statebacks are called when you enter (or are in) the named state.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L196-L206'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='196' data-end='206'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 196</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_stateback'>stateback</span>(<span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>)
  <span class='comment'># The following is quite unfortunate special casing for :completed
</span>  <span class='comment'># statebacks, but it&#39;s a necessary evil for latent completion
</span>  <span class='comment'># definitions.
</span>
  <span class='kw'>if</span> <span class='symbeg'>:</span><span class='id identifier rubyid_completed'>completed</span> <span class='op'>==</span> <span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span> <span class='op'>||</span> <span class='op'>!</span><span class='id identifier rubyid_completed?'><a href="#completed%3F-instance_method" title="EventMachine::Completion#completed? (method)">completed?</a></span> <span class='op'>||</span> <span class='ivar'>@state</span> <span class='op'>==</span> <span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span>
    <span class='ivar'>@callbacks</span>[<span class='id identifier rubyid_state'><a href="#state-instance_method" title="EventMachine::Completion#state (method)">state</a></span>] <span class='op'>&lt;&lt;</span> <span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span><span class='op'>::</span><span class='const'><a href="../EventMachine.html#Callback-class_method" title="EventMachine.Callback (method)">Callback</a></span>(<span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span>)
  <span class='kw'>end</span>
  <span class='id identifier rubyid_execute_callbacks'><a href="#execute_callbacks-instance_method" title="EventMachine::Completion#execute_callbacks (method)">execute_callbacks</a></span>
  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="succeed-instance_method">
  <h3 class='signature '>
    #<strong>succeed</strong>(*args)  
    <span class='aliases'>Also known as: <span class='names'>#set_deferred_success</span></span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Enter the <code>:succeeded</code> state, setting the result value if given.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L182-L184'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='182' data-end='184'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 182</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_succeed'>succeed</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='id identifier rubyid_change_state'><a href="#change_state-instance_method" title="EventMachine::Completion#change_state (method)">change_state</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_succeeded'>succeeded</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="timeout-instance_method">
  <h3 class='signature '>
    #<strong>timeout</strong>(time, *args)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Schedule a time which if passes before we enter a completion state, this
deferrable will be failed with the given arguments.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/eventmachine/eventmachine/blob/master/lib/em/completion.rb#L252-L257'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='252' data-end='257'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/em/completion.rb', line 252</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_timeout'>timeout</span>(<span class='id identifier rubyid_time'>time</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='id identifier rubyid_cancel_timeout'><a href="#cancel_timeout-instance_method" title="EventMachine::Completion#cancel_timeout (method)">cancel_timeout</a></span>
  <span class='ivar'>@timeout_timer</span> <span class='op'>=</span> <span class='const'><a href="../top-level-namespace.html#EM-constant" title="EM (constant)">EM</a></span><span class='op'>::</span><span class='const'><a href="Timer.html" title="EventMachine::Timer (class)">Timer</a></span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="EventMachine::Completion.new (method)">new</a></span>(<span class='id identifier rubyid_time'>time</span>) <span class='kw'>do</span>
    <span class='id identifier rubyid_fail'><a href="#fail-instance_method" title="EventMachine::Completion#fail (method)">fail</a></span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>) <span class='kw'>unless</span> <span class='id identifier rubyid_completed?'><a href="#completed%3F-instance_method" title="EventMachine::Completion#completed? (method)">completed?</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>