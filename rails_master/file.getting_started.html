<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Getting Started &mdash; Rails main</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "getting_started",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails main</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Getting Started&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1>Getting Started with <a href="Rails.html" title="Rails (module)"><code>Rails</code></a></h1>

<p>This guide covers getting up and running with Ruby on <a href="Rails.html" title="Rails (module)"><code>Rails</code></a>.</p>

<p>After reading this guide, you will know:</p>

<ul>
<li>How to install <a href="Rails.html" title="Rails (module)"><code>Rails</code></a>, create a new <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> application, and connect your
application to a database.</li>
<li>The general layout of a <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> application.</li>
<li>The basic principles of MVC (Model, View, Controller) and RESTful design.</li>
<li>How to quickly generate the starting pieces of a <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> application.</li>
<li>How to deploy your app to production using Kamal.</li>
</ul>

<hr>

<h2>Introduction</h2>

<p>Welcome to Ruby on Rails! In this guide, we&#39;ll walk through the core concepts of
building web applications with <a href="Rails.html" title="Rails (module)"><code>Rails</code></a>. You don&#39;t need any experience with <a href="Rails.html" title="Rails (module)"><code>Rails</code></a>
to follow along with this guide.</p>

<p><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> is a web framework built for the Ruby programming language. <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> takes
advantage of many features of Ruby so we <strong>strongly</strong> recommend learning the
basics of Ruby so that you understand some of the basic terms and vocabulary you
will see in this tutorial.</p>

<ul>
<li><a href="https://www.ruby-lang.org/en/documentation/">Official Ruby Programming Language website</a></li>
<li>[List of Free Programming Books]#ruby)</li>
</ul>

<h2><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> Philosophy</h2>

<p><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> is a web application development framework written in the Ruby programming
language. It is designed to make programming web applications easier by making
assumptions about what every developer needs to get started. It allows you to
write less code while accomplishing more than many other languages and
frameworks. Experienced Rails developers also report that it makes web
application development more fun.</p>

<p><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> is opinionated software. It makes the assumption that there is a &quot;best&quot;
way to do things, and it&#39;s designed to encourage that way - and in some cases to
discourage alternatives. If you learn &quot;The <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> Way&quot; you&#39;ll probably discover a
tremendous increase in productivity. If you persist in bringing old habits from
other languages to your <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> development, and trying to use patterns you
learned elsewhere, you may have a less happy experience.</p>

<p>The Rails philosophy includes two major guiding principles:</p>

<ul>
<li><strong>Don&#39;t Repeat Yourself:</strong> DRY is a principle of software development which
states that &quot;Every piece of knowledge must have a single, unambiguous,
authoritative representation within a system&quot;. By not writing the same
information over and over again, our code is more maintainable, more
extensible, and less buggy.</li>
<li><strong>Convention Over Configuration:</strong> <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> has opinions about the best way to do
many things in a web application, and defaults to this set of conventions,
rather than require that you define them yourself through endless
configuration files.</li>
</ul>

<h2>Creating a New Rails App</h2>

<p>We&#39;re going to build a project called <code>store</code> - a simple e-commerce app that
demonstrates several of Rails&#39; built-in features.</p>

<p>TIP: Any commands prefaced with a dollar sign <code>$</code> should be run in the terminal.</p>

<h3>Prerequisites</h3>

<p>For this project, you will need:</p>

<ul>
<li>Ruby 3.2 or newer</li>
<li><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 8.2.0 or newer</li>
<li>A code editor</li>
</ul>

<p>Follow the <a href="install_ruby_on_rails.html">Install Ruby on <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> Guide</a> if you need
to install Ruby and/or <a href="Rails.html" title="Rails (module)"><code>Rails</code></a>.</p>

<p>Let&#39;s verify the correct version of <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> is installed. To display the current
version, open a terminal and run the following. You should see a version number
printed out:</p>

<pre class="code bash"><code class="bash">$ rails --version
Rails 8.2.0
</code></pre>

<p>The version shown should be Rails 8.2.0 or higher.</p>

<h3>Creating Your First Rails App</h3>

<p>Rails comes with several commands to make life easier. Run <code>rails --help</code> to see
all of the commands.</p>

<p><code>rails new</code> generates the foundation of a fresh Rails application for you, so
let&#39;s start there.</p>

<p>To create our <code>store</code> application, run the following command in your terminal:</p>

<pre class="code bash"><code class="bash">$ rails new store
</code></pre>

<p>NOTE: You can customize the application Rails generates by using flags. To see
these options, run <code>rails new --help</code>.</p>

<p>After your new application is created, switch to its directory:</p>

<pre class="code bash"><code class="bash">$ cd store
</code></pre>

<h3>Directory Structure</h3>

<p>Let&#39;s take a quick glance at the files and directories that are included in a
new Rails application. You can open this folder in your code editor or run
<code>ls -la</code> in your terminal to see the files and directories.</p>

<table><thead>
<tr>
<th>File/Folder</th>
<th>Purpose</th>
</tr>
</thead><tbody>
<tr>
<td>app/</td>
<td>Contains the controllers, models, views, helpers, mailers, jobs, and assets for your application. <strong>You&#39;ll focus mostly on this folder for the remainder of this guide.</strong></td>
</tr>
<tr>
<td>bin/</td>
<td>Contains the <code>rails</code> script that starts your app and can contain other scripts you use to set up, update, deploy, or run your application.</td>
</tr>
<tr>
<td>config/</td>
<td>Contains configuration for your application&#39;s routes, database, and more. This is covered in more detail in <a href="configuring.html">Configuring Rails Applications</a>.</td>
</tr>
<tr>
<td>config.ru</td>
<td><a href="https://rack.github.io">Rack</a> configuration for Rack-based servers used to start the application.</td>
</tr>
<tr>
<td>db/</td>
<td>Contains your current database schema, as well as the database migrations.</td>
</tr>
<tr>
<td>Dockerfile</td>
<td>Configuration file for Docker.</td>
</tr>
<tr>
<td>Gemfile<br>Gemfile.lock</td>
<td>These files allow you to specify what gem dependencies are needed for your Rails application. These files are used by the <a href="https://bundler.io">Bundler</a> gem.</td>
</tr>
<tr>
<td>lib/</td>
<td>Extended modules for your application.</td>
</tr>
<tr>
<td>log/</td>
<td>Application log files.</td>
</tr>
<tr>
<td>public/</td>
<td>Contains static files and compiled assets. When your app is running, this directory will be exposed as-is.</td>
</tr>
<tr>
<td>Rakefile</td>
<td>This file locates and loads tasks that can be run from the command line. The task definitions are defined throughout the components of Rails. Rather than changing <code>Rakefile</code>, you should add your own tasks by adding files to the <code>lib/tasks</code> directory of your application.</td>
</tr>
<tr>
<td>README.md</td>
<td>This is a brief instruction manual for your application. You should edit this file to tell others what your application does, how to set it up, and so on.</td>
</tr>
<tr>
<td>script/</td>
<td>Contains one-off or general purpose <a href="https://github.com/rails/rails/blob/main/railties/lib/rails/generators/rails/script/USAGE">scripts</a> and <a href="https://github.com/rails/rails/blob/main/railties/lib/rails/generators/rails/benchmark/USAGE">benchmarks</a>.</td>
</tr>
<tr>
<td>storage/</td>
<td>Contains SQLite databases and Active Storage files for Disk Service. This is covered in <a href="active_storage_overview.html">Active Storage Overview</a>.</td>
</tr>
<tr>
<td>test/</td>
<td>Unit tests, fixtures, and other test apparatus. These are covered in <a href="testing.html">Testing Rails Applications</a>.</td>
</tr>
<tr>
<td>tmp/</td>
<td>Temporary files (like cache and pid files).</td>
</tr>
<tr>
<td>vendor/</td>
<td>A place for all third-party code. In a typical Rails application this includes vendored gems.</td>
</tr>
<tr>
<td>.dockerignore</td>
<td>This file tells Docker which files it should not copy into the container.</td>
</tr>
<tr>
<td>.gitattributes</td>
<td>This file defines metadata for specific paths in a Git repository. This metadata can be used by Git and other tools to enhance their behavior. See the <a href="https://git-scm.com/docs/gitattributes">gitattributes documentation</a> for more information.</td>
</tr>
<tr>
<td>.git/</td>
<td>Contains Git repository files.</td>
</tr>
<tr>
<td>.github/</td>
<td>Contains GitHub specific files.</td>
</tr>
<tr>
<td>.gitignore</td>
<td>This file tells Git which files (or patterns) it should ignore. See <a href="https://help.github.com/articles/ignoring-files">GitHub - Ignoring files</a> for more information about ignoring files.</td>
</tr>
<tr>
<td>.kamal/</td>
<td>Contains Kamal secrets and deployment hooks.</td>
</tr>
<tr>
<td>.rubocop.yml</td>
<td>This file contains the configuration for RuboCop.</td>
</tr>
<tr>
<td>.ruby-version</td>
<td>This file contains the default Ruby version.</td>
</tr>
</tbody></table>

<h3>Model-View-Controller Basics</h3>

<p>Rails code is organized using the Model-View-Controller (MVC) architecture. With
MVC, we have three main concepts where the majority of our code lives:</p>

<ul>
<li>Model - Manages the data in your application. Typically, your database tables.</li>
<li>View - Handles rendering responses in different formats like HTML, JSON, XML,
etc.</li>
<li>Controller - Handles user interactions and the logic for each request.</li>
</ul>

<p><picture class="flowdiagram">
  <source srcset="images/getting_started/mvc_architecture_dark.jpg" media="(prefers-color-scheme:dark)">
  <img src="images/getting_started/mvc_architecture_light.jpg">
</picture></p>

<p>Now that we&#39;ve got a basic understanding of MVC, let&#39;s see how it&#39;s used in
Rails.</p>

<h2>Hello, Rails!</h2>

<p>Let&#39;s start easy by creating our application&#39;s database and boot up our Rails server for the first time.</p>

<p>In your terminal, run the following commands in the <code>store</code> directory:</p>

<pre class="code bash"><code class="bash">$ bin/rails db:create
</code></pre>

<p>This will initially create the application&#39;s database.</p>

<pre class="code bash"><code class="bash">$ bin/rails server
</code></pre>

<p>NOTE: When we run commands inside an application directory, we should use
<code>bin/rails</code>. This makes sure the application&#39;s version of Rails is used.</p>

<p>This will start up a web server called Puma that will serve static files and
your Rails application:</p>

<pre class="code bash"><code class="bash">=&gt; Booting Puma
=&gt; Rails 8.2.0 application starting in development
=&gt; Run `bin/rails server --help` for more startup options
Puma starting in single mode...
* Puma version: 6.4.3 (ruby 3.3.5-p100) (&quot;The Eagle of Durango&quot;)
*  Min threads: 3
*  Max threads: 3
*  Environment: development
*          PID: 12345
* Listening on http://127.0.0.1:3000
* Listening on http://[::1]:3000
Use Ctrl-C to stop
</code></pre>

<p>To see your Rails application, open <a href="http://localhost:3000">http://localhost:3000</a> in your browser. You
will see the default Rails welcome page:</p>

<p><img src="images/getting_started/rails_welcome.png" alt="Rails welcome page"></p>

<p>It works!</p>

<p>This page is the <em>smoke test</em> for a new Rails application, ensuring that
everything is working behind the scenes to serve a page.</p>

<p>To stop the Rails server anytime, press <code>Ctrl-C</code> in your terminal.</p>

<h3>Autoloading in Development</h3>

<p>Developer happiness is a cornerstone philosophy of Rails and one way of
achieving this is with automatic code reloading in development.</p>

<p>Once you start the Rails server, new files or changes to existing files are
detected and automatically loaded or reloaded as necessary. This allows you to
focus on building without having to restart your Rails server after every
change.</p>

<p>You may also notice that Rails applications rarely use <code>require</code> statements like
you may have seen in other programming languages. Rails uses naming conventions
to require files automatically so you can focus on writing your application
code.</p>

<p>See
<a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</a>
for more details.</p>

<h2>Creating a Database Model</h2>

<p>Active Record is a feature of Rails that maps relational databases to Ruby code.
It helps generate the structured query language (SQL) for interacting with the
database like creating, updating, and deleting tables and records. Our
application is using SQLite which is the default for Rails.</p>

<p>Let&#39;s start by adding a database table to our Rails application to add products
to our simple e-commerce store.</p>

<pre class="code bash"><code class="bash">$ bin/rails generate model Product name:string
</code></pre>

<p>This command tells Rails to generate a model named <code>Product</code> which has a <code>name</code>
column and type of <code>string</code> in the database. Later on, you&#39;ll learn how to add
other column types.</p>

<p>You&#39;ll see the following in your terminal:</p>

<pre class="code bash"><code class="bash">      invoke  active_record
      create    db/migrate/20240426151900_create_products.rb
      create    app/models/product.rb
      invoke    test_unit
      create      test/models/product_test.rb
      create      test/fixtures/products.yml
</code></pre>

<p>This command does several things. It creates...</p>

<ol>
<li>A migration in the <code>db/migrate</code> folder.</li>
<li>An Active Record model in <code>app/models/product.rb</code>.</li>
<li>Tests and test fixtures for this model.</li>
</ol>

<p>NOTE: Model names are <em>singular</em>, because an instantiated model represents a
single record in the database (i.e., You are creating a <em>product</em> to add to the
database.).</p>

<h3>Database Migrations</h3>

<p>A <em>migration</em> is a set of changes we want to make to our database.</p>

<p>By defining migrations, we&#39;re telling Rails how to change the database to add,
change, or remove tables, columns or other attributes of our database. This
helps keep track of changes we make in development (only on our computer) so
they can be deployed to production (live, online!) safely.</p>

<p>In your code editor, open the migration Rails created for us so we can see what
the migration does.</p>

<p>NOTE: As convention we&#39;ll state the filepath as a comment on top of each file</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/&lt;timestamp&gt;_create_products.rb
</span><span class='kw'>class</span> <span class='const'>CreateProducts</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Migration.html" title="ActiveRecord::Migration (class)">Migration</a></span>[<span class='float'>8.2</span>]
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_products'>products</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>

      <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>This migration is telling Rails to create a new database table named <code>products</code>.</p>

<p>NOTE: In contrast to the model above, Rails makes the database table names
<em>plural</em>, because the database holds all of the instances of each model (i.e.,
You are creating a database of <em>products</em>).</p>

<p>The <code>create_table</code> block then defines which columns and types should be defined
in this database table.</p>

<p><code>t.string :name</code> tells Rails to create a column in the <code>products</code> table called
<code>name</code> and set the type as <code>string</code>.</p>

<p><code>t.timestamps</code> is a shortcut for defining two columns on your models:
<code>created_at:datetime</code> and <code>updated_at:datetime</code>. You&#39;ll see these columns on
most Active Record models in Rails and they are automatically set by Active
Record when creating or updating records.</p>

<h3>Running Migrations</h3>

<p>Now that you have defined what changes to make to the database, use the
following command to run the migrations:</p>

<pre class="code bash"><code class="bash">$ bin/rails db:migrate
</code></pre>

<p>This command checks for any new migrations and applies them to your database.
Its output looks like this:</p>

<pre class="code bash"><code class="bash">== 20240426151900 CreateProducts: migrating ===================================
-- create_table(:products)
   -&gt; 0.0030s
== 20240426151900 CreateProducts: migrated (0.0031s) ==========================
</code></pre>

<p>TIP: If you make a mistake, you can run <code>bin/rails db:rollback</code> to undo the last
migration.</p>

<h2>Rails Console</h2>

<p>Now that we have created our products table, we can interact with it in Rails.
Let&#39;s try it out.</p>

<p>For this, we&#39;re going to use a Rails feature called the <em>console</em>. The console
is a helpful, interactive tool for testing our code in our Rails application.</p>

<pre class="code bash"><code class="bash">$ bin/rails console
</code></pre>

<p>You will be presented with a prompt like the following:</p>

<pre class="code irb"><code class="irb">Loading development environment (Rails 8.2.0)
store(dev)&gt;
</code></pre>

<p>Here we can type code that will be executed when we hit <code>Enter</code>. Let&#39;s try
printing out the Rails version:</p>

<pre class="code irb"><code class="irb">store(dev)&gt; Rails.version
=&gt; &quot;8.2.0&quot;
</code></pre>

<p>It works!</p>

<h2>Active Record Model Basics</h2>

<p>When we ran the Rails model generator to create the <code>Product</code> model, it created
a file at <code>app/models/product.rb</code>. This file creates a class that uses Active
Record for interacting with our <code>products</code> database table.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/product.rb
</span><span class='kw'>class</span> <span class='const'>Product</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<p>You might be surprised that there is no code in this class. How does Rails know
what defines this model?</p>

<p>When the <code>Product</code> model is used, Rails will query the database table for the
column names and types and automatically generate code for these attributes.
Rails saves us from writing this boilerplate code and instead takes care of it
for us behind the scenes so we can focus on our application logic instead.</p>

<p>Let&#39;s use the Rails console to see what columns Rails detects for the Product
model.</p>

<p>Run:</p>

<pre class="code irb"><code class="irb">store(dev)&gt; Product.column_names
</code></pre>

<p>And you should see:</p>

<pre class="code irb"><code class="irb">=&gt; [&quot;id&quot;, &quot;name&quot;, &quot;created_at&quot;, &quot;updated_at&quot;]
</code></pre>

<p>Rails asked the database for column information above and used that information
to define attributes on the <code>Product</code> class dynamically so you don&#39;t have to
manually define each of them. This is one example of how Rails makes development
a breeze.</p>

<h3>Creating Records</h3>

<p>We can instantiate a new Product record with the following code:</p>

<pre class="code irb"><code class="irb">store(dev)&gt; product = Product.new(name: &quot;T-Shirt&quot;)
=&gt; #&lt;Product:0x000000012e616c30 id: nil, name: &quot;T-Shirt&quot;, created_at: nil, updated_at: nil&gt;
</code></pre>

<p>The <code>product</code> variable is an instance of <code>Product</code>. It has not been saved to the
database, and so does not have an ID, created_at, or updated_at timestamps.</p>

<p>We can call <code>save</code> to write the record to the database.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; product.save
  TRANSACTION (0.1ms)  BEGIN immediate TRANSACTION /*application=&#39;Store&#39;*/
  Product Create (0.9ms)  INSERT INTO &quot;products&quot; (&quot;name&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (&#39;T-Shirt&#39;, &#39;2024-11-09 16:35:01.117836&#39;, &#39;2024-11-09 16:35:01.117836&#39;) RETURNING &quot;id&quot; /*application=&#39;Store&#39;*/
  TRANSACTION (0.9ms)  COMMIT TRANSACTION /*application=&#39;Store&#39;*/
=&gt; true
</code></pre>

<p>When <code>save</code> is called, Rails takes the attributes in memory and generates an
<code>INSERT</code> SQL query to insert this record into the database.</p>

<p>Rails also updates the object in memory with the database record <code>id</code> along with
the <code>created_at</code> and <code>updated_at</code> timestamps. We can see that by printing out
the <code>product</code> variable.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; product
=&gt; #&lt;Product:0x00000001221f6260 id: 1, name: &quot;T-Shirt&quot;, created_at: &quot;2024-11-09 16:35:01.117836000 +0000&quot;, updated_at: &quot;2024-11-09 16:35:01.117836000 +0000&quot;&gt;
</code></pre>

<p>Similar to <code>save</code>, we can use <code>create</code> to instantiate and save an Active Record
object in a single call.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; Product.create(name: &quot;Pants&quot;)
  TRANSACTION (0.1ms)  BEGIN immediate TRANSACTION /*application=&#39;Store&#39;*/
  Product Create (0.4ms)  INSERT INTO &quot;products&quot; (&quot;name&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (&#39;Pants&#39;, &#39;2024-11-09 16:36:01.856751&#39;, &#39;2024-11-09 16:36:01.856751&#39;) RETURNING &quot;id&quot; /*application=&#39;Store&#39;*/
  TRANSACTION (0.1ms)  COMMIT TRANSACTION /*application=&#39;Store&#39;*/
=&gt; #&lt;Product:0x0000000120485c80 id: 2, name: &quot;Pants&quot;, created_at: &quot;2024-11-09 16:36:01.856751000 +0000&quot;, updated_at: &quot;2024-11-09 16:36:01.856751000 +0000&quot;&gt;
</code></pre>

<h3>Querying Records</h3>

<p>We can also look up records from the database using our Active Record model.</p>

<p>To find all the Product records in the database, we can use the <code>all</code> method.
This is a <em>class</em> method, which is why we can use it on Product (versus an
instance method that we would call on the product instance, like <code>save</code> above).</p>

<pre class="code irb"><code class="irb">store(dev)&gt; Product.all
  Product Load (0.1ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot; /* loading for pp */ LIMIT 11 /*application=&#39;Store&#39;*/
=&gt; [#&lt;Product:0x0000000121845158 id: 1, name: &quot;T-Shirt&quot;, created_at: &quot;2024-11-09 16:35:01.117836000 +0000&quot;, updated_at: &quot;2024-11-09 16:35:01.117836000 +0000&quot;&gt;,
 #&lt;Product:0x0000000121845018 id: 2, name: &quot;Pants&quot;, created_at: &quot;2024-11-09 16:36:01.856751000 +0000&quot;, updated_at: &quot;2024-11-09 16:36:01.856751000 +0000&quot;&gt;]
</code></pre>

<p>This generates a <code>SELECT</code> SQL query to load all records from the <code>products</code>
table. Each record is automatically converted into an instance of our Product
Active Record model so we can easily work with them from Ruby.</p>

<p>TIP: The <code>all</code> method returns an <a href="ActiveRecord/Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a> object which is an
Array-like collection of database records with features to filter, sort, and
execute other database operations.</p>

<h3>Filtering &amp; Ordering Records</h3>

<p>What if we want to filter the results from our database? We can use <code>where</code> to
filter records by a column.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; Product.where(name: &quot;Pants&quot;)
  Product Load (1.5ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot; WHERE &quot;products&quot;.&quot;name&quot; = &#39;Pants&#39; /* loading for pp */ LIMIT 11 /*application=&#39;Store&#39;*/
=&gt; [#&lt;Product:0x000000012184d858 id: 2, name: &quot;Pants&quot;, created_at: &quot;2024-11-09 16:36:01.856751000 +0000&quot;, updated_at: &quot;2024-11-09 16:36:01.856751000 +0000&quot;&gt;]
</code></pre>

<p>This generates a <code>SELECT</code> SQL query but also adds a <code>WHERE</code> clause to filter the
records that have a <code>name</code> matching <code>&quot;Pants&quot;</code>. This also returns an
<a href="ActiveRecord/Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a> because multiple records may have the same name.</p>

<p>We can use <code>order(name: :asc)</code> to sort records by name in ascending alphabetical order.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; Product.order(name: :asc)
  Product Load (0.3ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot; /* loading for pp */ ORDER BY &quot;products&quot;.&quot;name&quot; ASC LIMIT 11 /*application=&#39;Store&#39;*/
=&gt; [#&lt;Product:0x0000000120e02a88 id: 2, name: &quot;Pants&quot;, created_at: &quot;2024-11-09 16:36:01.856751000 +0000&quot;, updated_at: &quot;2024-11-09 16:36:01.856751000 +0000&quot;&gt;,
 #&lt;Product:0x0000000120e02948 id: 1, name: &quot;T-Shirt&quot;, created_at: &quot;2024-11-09 16:35:01.117836000 +0000&quot;, updated_at: &quot;2024-11-09 16:35:01.117836000 +0000&quot;&gt;]
</code></pre>

<h3>Finding Records</h3>

<p>What if we want to find one specific record?</p>

<p>We can do this by using the <code>find</code> class method to look up a single record by
ID. Call the method and pass in the specific ID by using the following code:</p>

<pre class="code irb"><code class="irb">store(dev)&gt; Product.find(1)
  Product Load (0.2ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot; WHERE &quot;products&quot;.&quot;id&quot; = 1 LIMIT 1 /*application=&#39;Store&#39;*/
=&gt; #&lt;Product:0x000000012054af08 id: 1, name: &quot;T-Shirt&quot;, created_at: &quot;2024-11-09 16:35:01.117836000 +0000&quot;, updated_at: &quot;2024-11-09 16:35:01.117836000 +0000&quot;&gt;
</code></pre>

<p>This generates a <code>SELECT</code> query but specifies a <code>WHERE</code> for the <code>id</code> column
matching the ID of <code>1</code> that was passed in. It also adds a <code>LIMIT</code> to only return
a single record.</p>

<p>This time, we get a <code>Product</code> instance instead of an <a href="ActiveRecord/Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a>
since we&#39;re only retrieving a single record from the database.</p>

<h3>Updating Records</h3>

<p>Records can be updated in 2 ways: using <code>update</code> or assigning attributes and
calling <code>save</code>.</p>

<p>We can call <code>update</code> on a Product instance and pass in a Hash of new attributes
to save to the database. This will assign the attributes, run validations, and
save the changes to the database in one method call.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; product = Product.find(1)
store(dev)&gt; product.update(name: &quot;Shoes&quot;)
  TRANSACTION (0.1ms)  BEGIN immediate TRANSACTION /*application=&#39;Store&#39;*/
  Product Update (0.3ms)  UPDATE &quot;products&quot; SET &quot;name&quot; = &#39;Shoes&#39;, &quot;updated_at&quot; = &#39;2024-11-09 22:38:19.638912&#39; WHERE &quot;products&quot;.&quot;id&quot; = 1 /*application=&#39;Store&#39;*/
  TRANSACTION (0.4ms)  COMMIT TRANSACTION /*application=&#39;Store&#39;*/
=&gt; true
</code></pre>

<p>This updated the name of the &quot;T-Shirt&quot; product to &quot;Shoes&quot; in the database.
Confirm this by running <code>Product.all</code> again.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; Product.all
</code></pre>

<p>You will see two products: Shoes and Pants.</p>

<pre class="code irb"><code class="irb">  Product Load (0.3ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot; /* loading for pp */ LIMIT 11 /*application=&#39;Store&#39;*/
=&gt;
[#&lt;Product:0x000000012c0f7300
  id: 1,
  name: &quot;Shoes&quot;,
  created_at: &quot;2024-12-02 20:29:56.303546000 +0000&quot;,
  updated_at: &quot;2024-12-02 20:30:14.127456000 +0000&quot;&gt;,
 #&lt;Product:0x000000012c0f71c0
  id: 2,
  name: &quot;Pants&quot;,
  created_at: &quot;2024-12-02 20:30:02.997261000 +0000&quot;,
  updated_at: &quot;2024-12-02 20:30:02.997261000 +0000&quot;&gt;]
</code></pre>

<p>Alternatively, we can assign attributes and call <code>save</code> when we&#39;re ready to
validate and save changes to the database.</p>

<p>Let&#39;s change the name &quot;Shoes&quot; back to &quot;T-Shirt&quot;.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; product = Product.find(1)
store(dev)&gt; product.name = &quot;T-Shirt&quot;
=&gt; &quot;T-Shirt&quot;
store(dev)&gt; product.save
  TRANSACTION (0.1ms)  BEGIN immediate TRANSACTION /*application=&#39;Store&#39;*/
  Product Update (0.2ms)  UPDATE &quot;products&quot; SET &quot;name&quot; = &#39;T-Shirt&#39;, &quot;updated_at&quot; = &#39;2024-11-09 22:39:09.693548&#39; WHERE &quot;products&quot;.&quot;id&quot; = 1 /*application=&#39;Store&#39;*/
  TRANSACTION (0.0ms)  COMMIT TRANSACTION /*application=&#39;Store&#39;*/
=&gt; true
</code></pre>

<h3>Deleting Records</h3>

<p>The <code>destroy</code> method can be used to delete a record from the database.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; product.destroy
  TRANSACTION (0.1ms)  BEGIN immediate TRANSACTION /*application=&#39;Store&#39;*/
  Product Destroy (0.4ms)  DELETE FROM &quot;products&quot; WHERE &quot;products&quot;.&quot;id&quot; = 1 /*application=&#39;Store&#39;*/
  TRANSACTION (0.1ms)  COMMIT TRANSACTION /*application=&#39;Store&#39;*/
=&gt; #&lt;Product:0x0000000125813d48 id: 1, name: &quot;T-Shirt&quot;, created_at: &quot;2024-11-09 22:39:38.498730000 +0000&quot;, updated_at: &quot;2024-11-09 22:39:38.498730000 +0000&quot;&gt;
</code></pre>

<p>This deleted the T-Shirt product from our database. We can confirm this with
<code>Product.all</code> to see that it only returns Pants.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; Product.all
  Product Load (1.9ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot; /* loading for pp */ LIMIT 11 /*application=&#39;Store&#39;*/
=&gt;
[#&lt;Product:0x000000012abde4c8
  id: 2,
  name: &quot;Pants&quot;,
  created_at: &quot;2024-11-09 22:33:19.638912000 +0000&quot;,
  updated_at: &quot;2024-11-09 22:33:19.638912000 +0000&quot;&gt;]
</code></pre>

<h3>Validations</h3>

<p>Active Record provides <em>validations</em> which allows you to ensure data inserted
into the database adheres to certain rules.</p>

<p>Let&#39;s add a <code>presence</code> validation to the Product model to ensure that all
products must have a <code>name</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/product.rb
</span><span class='kw'>class</span> <span class='const'>Product</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_validates'>validates</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>presence:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>You might remember that Rails automatically reloads changes during development.
However, if the console is running when you make updates to the code, you&#39;ll
need to manually refresh it. So let&#39;s do this now by running &#39;reload!&#39;.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; reload!
Reloading...
</code></pre>

<p>Let&#39;s try to create a Product without a name in the Rails console.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; product = Product.new
store(dev)&gt; product.save
=&gt; false
</code></pre>

<p>This time <code>save</code> returns <code>false</code> because the <code>name</code> attribute wasn&#39;t specified.</p>

<p>Rails automatically runs validations during create, update, and save operations
to ensure valid input. To see a list of errors generated by validations, we can
call <code>errors</code> on the instance.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; product.errors
=&gt; #&lt;ActiveModel::Errors [#&lt;ActiveModel::Error attribute=name, type=blank, options={}&gt;]&gt;
</code></pre>

<p>This returns an <a href="ActiveModel/Errors.html" title="ActiveModel::Errors (class)"><code>::ActiveModel::Errors</code></a> object that can tell us exactly which
errors are present.</p>

<p>It also can generate friendly error messages for us that we can use in our user
interface.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; product.errors.full_messages
=&gt; [&quot;Name can&#39;t be blank&quot;]
</code></pre>

<p>Now let&#39;s build a web interface for our Products.</p>

<p>We are done with the console for now, so you can exit out of it by running
<code>exit</code>.</p>

<h2>A Request&#39;s Journey Through Rails</h2>

<p>To get Rails saying &quot;Hello&quot;, you need to create at minimum a <em>route</em>, a
<em>controller</em> with an <em>action</em>, and a <em>view</em>. A route maps a request to a
controller action. A controller action performs the necessary work to handle the
request, and prepares any data for the view. A view displays data in a desired
format.</p>

<p>In terms of implementation: Routes are rules written in a Ruby
<a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL (Domain-Specific Language)</a>.
Controllers are Ruby classes, and their public methods are actions. And views
are templates, usually written in a mixture of HTML and Ruby.</p>

<p>That&#39;s the short of it, but we’re going to walk through each of these steps in
more detail next.</p>

<h2>Routes</h2>

<p>In Rails, a route is the part of the URL that determines how an incoming HTTP
request is directed to the appropriate controller and action for processing.
First, let&#39;s do a quick refresher on URLs and HTTP Request methods.</p>

<h3>Parts of a URL</h3>

<p>Let&#39;s examine the different parts of a URL:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_https'>https</span><span class='symbeg'>:</span><span class='op'>/</span><span class='op'>/</span><span class='id identifier rubyid_example'>example</span>.<span class='id identifier rubyid_org'>org</span><span class='op'>/</span><span class='id identifier rubyid_products?'>products?</span><span class='id identifier rubyid_sale'>sale</span><span class='op'>=</span><span class='kw'>true</span><span class='op'>&amp;</span><span class='id identifier rubyid_sort'>sort</span><span class='op'>=</span><span class='id identifier rubyid_asc'>asc</span></code></pre>

<p>In this URL, each part has a name:</p>

<ul>
<li><code>https</code> is the <strong>protocol</strong></li>
<li><code>example.org</code> is the <strong>host</strong></li>
<li><code>/products</code> is the <strong>path</strong></li>
<li><code>?sale=true&amp;sort=asc</code> are the <strong>query parameters</strong></li>
</ul>

<h3>HTTP Methods and Their Purpose</h3>

<p>HTTP requests use methods to tell a server what action it should perform for a
given URL. Here are the most common methods:</p>

<ul>
<li>A <code>GET</code> request tells the server to retrieve the data for a given URL (e.g.,
loading a page or fetching a record).</li>
<li>A <code>POST</code> request will submit data to the URL for processing (usually creating
a new record).</li>
<li>A <code>PUT</code> or <code>PATCH</code> request submits data to a URL to update an existing record.</li>
<li>A <code>DELETE</code> request to a URL tells the server to delete a record.</li>
</ul>

<h3>Rails Routes</h3>

<p>A <code>route</code> in Rails refers to a line of code that pairs an HTTP Method and a URL
path. The route also tells Rails which <code>controller</code> and <code>action</code> should respond
to a request.</p>

<p>To define a route in Rails, let&#39;s go back to your code editor and add the
following route to <code>config/routes.rb</code></p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/routes.rb
</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_routes'>routes</span>.<span class='id identifier rubyid_draw'>draw</span> <span class='kw'>do</span>
  <span class='comment'># ...
</span>  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/products</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>products#index</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<p>This route tells Rails to look for GET requests to the <code>/products</code> path. In this
example, we specified <code>&quot;products#index&quot;</code> for where to route the request.</p>

<p>When Rails sees a request that matches, it will send the request to the
<code>ProductsController</code> and the <code>index</code> action inside of that controller. This is
how Rails will process the request and return a response to the browser.</p>

<p>You&#39;ll notice that we don&#39;t need to specify the protocol, domain, or query
params in our routes. That&#39;s basically because the protocol and domain make sure
the request reaches your server. From there, Rails picks up the request and
knows which path to use for responding to the request based on what routes are
defined. The query params are like options that Rails can use to apply to the
request, so they are typically used in the controller for filtering the data.</p>

<p><picture class="flowdiagram">
  <source srcset="images/getting_started/routing_dark.jpg" media="(prefers-color-scheme:dark)">
  <img src="images/getting_started/routing_light.jpg">
</picture></p>

<p>Let&#39;s look at another example. Add this line after the previous route:</p>

<pre class="code ruby#5"><code class="ruby#5"># config/routes.rb
Rails.application.routes.draw do
  # ...
  get &quot;/products&quot;, to: &quot;products#index&quot;
  post &quot;/products&quot;, to: &quot;products#create&quot;
end
</code></pre>

<p>Here, we&#39;ve told Rails to take POST requests to &quot;/products&quot; and process them
with the <code>ProductsController</code> using the <code>create</code> action.</p>

<p>Routes may also need to match URLs with certain patterns. So how does that work?</p>

<pre class="code ruby#4"><code class="ruby#4"># config/routes.rb
Rails.application.routes.draw do
  # ...
  get &quot;/products/:id&quot;, to: &quot;products#show&quot;
end
</code></pre>

<p>This route has <code>:id</code> in it. This is called a <code>parameter</code> and it captures a
portion of the URL to be used later for processing the request.</p>

<p>If a user visits <code>/products/1</code>, the <code>:id</code> param is set to <code>1</code> and can be used in
the controller action to look up and display the Product record with an ID of 1.
<code>/products/2</code> would display Product with an ID of 2 and so on.</p>

<p>Route parameters don&#39;t have to be Integers, either.</p>

<p>For example, you could have a blog with articles and match <code>/blog/hello-world</code>
with the following route:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/routes.rb
</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_routes'>routes</span>.<span class='id identifier rubyid_draw'>draw</span> <span class='kw'>do</span>
  <span class='comment'># ...
</span>  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/blog/:title</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>blog#show</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<p>Rails will capture <code>hello-world</code> out of <code>/blog/hello-world</code> and this can be used
to look up the blog post with the matching title.</p>

<h4>CRUD Routes</h4>

<p>There are 4 common actions you will generally need for a resource: Create, Read,
Update, Delete (CRUD). This translates to 8 typical routes:</p>

<ul>
<li>Index - Shows all the records</li>
<li>New - Renders a form for creating a new record</li>
<li>Create - Processes the new form submission, handling errors and creating the
record</li>
<li>Show - Renders a specific record for viewing</li>
<li>Edit - Renders a form for updating a specific record</li>
<li>Update (full) - Handles the edit form submission, handling errors and updating the entire record, and typically triggered by a PUT request.</li>
<li>Update (partial) - Handles the edit form submission, handling errors and updating specific attributes of the record, and typically triggered by a PATCH request.</li>
<li>Destroy - Handles deleting a specific record</li>
</ul>

<p>We can add routes for these CRUD actions with the following:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/routes.rb
</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_routes'>routes</span>.<span class='id identifier rubyid_draw'>draw</span> <span class='kw'>do</span>
  <span class='comment'># ...
</span>  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/products</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>products#index</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/products/new</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>products#new</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_post'>post</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/products</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>products#create</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/products/:id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>products#show</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/products/:id/edit</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>products#edit</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_patch'>patch</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/products/:id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>products#update</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_put'>put</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/products/:id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>products#update</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_delete'>delete</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/products/:id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>products#destroy</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<h4>Resource Routes</h4>

<p>Typing out these routes every time is redundant, so Rails provides a shortcut
for defining them. To create all of the same CRUD routes, replace the above
routes with this single line:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/routes.rb
</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_routes'>routes</span>.<span class='id identifier rubyid_draw'>draw</span> <span class='kw'>do</span>
  <span class='comment'># ...
</span>  <span class='id identifier rubyid_resources'>resources</span> <span class='symbeg'>:</span><span class='id identifier rubyid_products'>products</span>
<span class='kw'>end</span></code></pre>

<p>TIP: If you don’t want all these CRUD actions, you specify exactly what you
need. Check out the <a href="routing.html">routing guide</a> for details.</p>

<h3>Routes Command</h3>

<p>Rails provides a command that displays all the routes your application responds
to.</p>

<p>In your terminal, run the following command.</p>

<pre class="code bash"><code class="bash">$ bin/rails routes
</code></pre>

<p>You&#39;ll see this in the output which are the routes generated by
<code>resources :products</code></p>

<pre class="code ruby"><code class="ruby">      <span class='const'>Prefix</span> <span class='const'>Verb</span>   <span class='const'>URI</span> <span class='const'>Pattern</span>                  <span class='const'>Controller</span><span class='comment'>#Action
</span>    <span class='id identifier rubyid_products'>products</span> <span class='const'>GET</span>    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>products(.:format)          products#index
             POST   </span><span class='regexp_end'>/products</span></span>(.<span class='symbeg'>:</span><span class='id identifier rubyid_format'>format</span>)          <span class='id identifier rubyid_products'>products</span><span class='comment'>#create
</span> <span class='id identifier rubyid_new_product'>new_product</span> <span class='const'>GET</span>    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>products</span><span class='regexp_end'>/new</span></span>(.<span class='symbeg'>:</span><span class='id identifier rubyid_format'>format</span>)      <span class='id identifier rubyid_products'>products</span><span class='comment'>#new
</span><span class='id identifier rubyid_edit_product'>edit_product</span> <span class='const'>GET</span>    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>products</span><span class='regexp_end'>/</span></span><span class='op'>:</span><span class='id identifier rubyid_id'>id</span><span class='op'>/</span><span class='id identifier rubyid_edit'>edit</span>(.<span class='symbeg'>:</span><span class='id identifier rubyid_format'>format</span>) <span class='id identifier rubyid_products'>products</span><span class='comment'>#edit
</span>     <span class='id identifier rubyid_product'>product</span> <span class='const'>GET</span>    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>products</span><span class='regexp_end'>/</span></span><span class='op'>:</span><span class='id identifier rubyid_id'>id</span>(.<span class='symbeg'>:</span><span class='id identifier rubyid_format'>format</span>)      <span class='id identifier rubyid_products'>products</span><span class='comment'>#show
</span>             <span class='const'>PATCH</span>  <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>products</span><span class='regexp_end'>/</span></span><span class='op'>:</span><span class='id identifier rubyid_id'>id</span>(.<span class='symbeg'>:</span><span class='id identifier rubyid_format'>format</span>)      <span class='id identifier rubyid_products'>products</span><span class='comment'>#update
</span>             <span class='const'>PUT</span>    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>products</span><span class='regexp_end'>/</span></span><span class='op'>:</span><span class='id identifier rubyid_id'>id</span>(.<span class='symbeg'>:</span><span class='id identifier rubyid_format'>format</span>)      <span class='id identifier rubyid_products'>products</span><span class='comment'>#update
</span>             <span class='const'>DELETE</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>products</span><span class='regexp_end'>/</span></span><span class='op'>:</span><span class='id identifier rubyid_id'>id</span>(.<span class='symbeg'>:</span><span class='id identifier rubyid_format'>format</span>)      <span class='id identifier rubyid_products'>products</span><span class='comment'>#destroy</span></code></pre>

<p>You&#39;ll also see routes from other built-in Rails features like health checks.</p>

<h2>Controllers &amp; Actions</h2>

<p>Now that we&#39;ve defined routes for Products, let&#39;s implement the controller and
actions to handle requests to these URLs.</p>

<p>This command will generate a <code>ProductsController</code> with an index action. Since
we&#39;ve already set up routes, we can skip that part of the generator using a
flag.</p>

<pre class="code bash"><code class="bash">$ bin/rails generate controller Products index --skip-routes
      create  app/controllers/products_controller.rb
      invoke  erb
      create    app/views/products
      create    app/views/products/index.html.erb
      invoke  test_unit
      create    test/controllers/products_controller_test.rb
      invoke  helper
      create    app/helpers/products_helper.rb
      invoke    test_unit
</code></pre>

<p>This command generates a handful of files for our controller:</p>

<ul>
<li>The controller itself</li>
<li>A views folder for the controller we generated</li>
<li>A view file for the action we specified when generating the controller</li>
<li>A test file for this controller</li>
<li>A helper file for extracting logic in our views</li>
</ul>

<p>Let&#39;s take a look at the ProductsController defined in
<code>app/controllers/products_controller.rb</code>. It looks like this:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/controllers/products_controller.rb
</span><span class='kw'>class</span> <span class='const'>ProductsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: You may notice the file name <code>products_controller.rb</code> is an underscored
version of the Class this file defines, <code>ProductsController</code>. This pattern helps
Rails to automatically load code without having to use <code>require</code> like you may
have seen in other languages.</p>

<p>The <code>index</code> method here is an Action. Even though it&#39;s an empty method, Rails
will default to rendering a template with the matching name.</p>

<p>The <code>index</code> action will render <code>app/views/products/index.html.erb</code>. If we open
up that file in our code editor, we&#39;ll see the HTML it renders.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/index.html.erb %&gt;
&lt;h1&gt;Products#index&lt;/h1&gt;
&lt;p&gt;Find me in app/views/products/index.html.erb&lt;/p&gt;
</code></pre>

<h3>Making Requests</h3>

<p>Let&#39;s see this in our browser. First, run <code>bin/rails server</code> in your terminal to
start the Rails server. Then open <a href="http://localhost:3000">http://localhost:3000</a> and you will see the
Rails welcome page.</p>

<p>If we open <a href="http://localhost:3000/products">http://localhost:3000/products</a> in the browser, Rails will render the
products index HTML.</p>

<p>Our browser requested <code>/products</code> and Rails matched this route to
<code>products#index</code>. Rails sent the request to the <code>ProductsController</code> and called
the <code>index</code> action. Since this action was empty, Rails rendered the matching
template at <code>app/views/products/index.html.erb</code> and returned that to our
browser. Pretty cool!</p>

<p>If we open <code>config/routes.rb</code>, we can tell Rails the root route should render
the Products index action by adding this line:</p>

<pre class="code ruby#4"><code class="ruby#4"># config/routes.rb
Rails.application.routes.draw do
  # ...
  root &quot;products#index&quot;
  resources :products
end
</code></pre>

<p>Now when you visit <a href="http://localhost:3000">http://localhost:3000</a>, Rails will render Products#index.</p>

<h3>Instance Variables</h3>

<p>Let&#39;s take this a step further and render some records from our database.</p>

<p>In the <code>index</code> action, let&#39;s add a database query and assign it to an instance
variable. Rails uses instance variables (variables that start with an @) to
share data with the views.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/controllers/products_controller.rb
</span><span class='kw'>class</span> <span class='const'>ProductsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
    <span class='ivar'>@products</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_all'>all</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>In <code>app/views/products/index.html.erb</code>, we can replace the HTML with this ERB:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/index.html.erb %&gt;
&lt;%= debug @products %&gt;
</code></pre>

<p>ERB is short for <a href="https://docs.ruby-lang.org/en/master/ERB.html">Embedded Ruby</a>
and allows us to execute Ruby code to dynamically generate HTML with Rails. The
<code>&lt;%= %&gt;</code> tag tells ERB to execute the Ruby code inside and output the return
value. In our case, this takes <code>@products</code>, converts it to YAML, and outputs the
YAML.</p>

<p>Now refresh <a href="http://localhost:3000/">http://localhost:3000/</a> in your browser and you&#39;ll see that the
output has changed. What you&#39;re seeing is the records in your database being
displayed in YAML format.</p>

<p>The <code>debug</code> helper prints out variables in YAML format to help with debugging.
For example, if you weren&#39;t paying attention and typed singular <code>@product</code>
instead of plural <code>@products</code>, the debug helper could help you identify that the
variable was not set correctly in the controller.</p>

<p>TIP: Check out the <a href="action_view_helpers.html">Action View Helpers guide</a> to see
more helpers that are available.</p>

<p>Let&#39;s update <code>app/views/products/index.html.erb</code> to render all of our product
names.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/index.html.erb %&gt;
&lt;h1&gt;Products&lt;/h1&gt;

&lt;div id=&quot;products&quot;&gt;
  &lt;% @products.each do |product| %&gt;
    &lt;div&gt;
      &lt;%= product.name %&gt;
    &lt;/div&gt;
  &lt;% end %&gt;
&lt;/div&gt;
</code></pre>

<p>Using ERB, this code loops through each product in the <code>@products</code>
<a href="ActiveRecord/Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a> object and renders a <code>&lt;div&gt;</code> tag containing the product
name.</p>

<p>We&#39;ve used a new ERB tag this time as well. <code>&lt;% %&gt;</code> evaluates the Ruby code but
does not output the return value. That ignores the output of <code>@products.each</code>
which would output an array that we don&#39;t want in our HTML.</p>

<h3>CRUD Actions</h3>

<p>We need to be able to access individual products. This is the R in CRUD to read
a resource.</p>

<p>We&#39;ve already defined the route for individual products with our
<code>resources :products</code> route. This generates <code>/products/:id</code> as a route that
points to <code>products#show</code>.</p>

<p>Now we need to add that action to the <code>ProductsController</code> and define what
happens when it is called.</p>

<h3>Showing Individual Products</h3>

<p>Open the Products controller and add the <code>show</code> action like this:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/controllers/products_controller.rb
</span><span class='kw'>class</span> <span class='const'>ProductsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
    <span class='ivar'>@products</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_all'>all</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
    <span class='ivar'>@product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The <code>show</code> action here defines the <em>singular</em> <code>@product</code> because it&#39;s loading a
single record from the database, in other words: Show this one product. We use
plural <code>@products</code> in <code>index</code> because we&#39;re loading multiple products.</p>

<p>To query the database, we use <code>params</code> to access the request parameters. In this
case, we&#39;re using the <code>:id</code> from our route <code>/products/:id</code>. When we visit
<code>/products/1</code>, the params hash contains <code>{id: 1}</code> which results in our <code>show</code>
action calling <code>Product.find(1)</code> to load Product with ID of <code>1</code> from the
database.</p>

<p>We need a view for the show action next. Following the Rails naming conventions,
the <code>ProductsController</code> expects views in <code>app/views</code> in a subfolder named
<code>products</code>.</p>

<p>The <code>show</code> action expects a file in <code>app/views/products/show.html.erb</code>. Let&#39;s
create that file in our editor and add the following contents:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/show.html.erb %&gt;
&lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;

&lt;%= link_to &quot;Back&quot;, products_path %&gt;
</code></pre>

<p>It would be helpful for the index page to link to the show page for each product
so we can click on them to navigate. We can update the
<code>app/views/products/index.html.erb</code> view to link to this new page to use an
anchor tag to the path for the <code>show</code> action.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/index.html.erb %&gt;
&lt;h1&gt;Products&lt;/h1&gt;

&lt;div id=&quot;products&quot;&gt;
  &lt;% @products.each do |product| %&gt;
    &lt;div&gt;
      &lt;a href=&quot;/products/&lt;%= product.id %&gt;&quot;&gt;
        &lt;%= product.name %&gt;
      &lt;/a&gt;
    &lt;/div&gt;
  &lt;% end %&gt;
&lt;/div&gt;
</code></pre>

<p>Refresh this page in your browser and you&#39;ll see that this works, but we can do
better.</p>

<p>Rails provides helper methods for generating paths and URLs. When you run
<code>bin/rails routes</code>, you&#39;ll see the Prefix column. This prefix matches the
helpers you can use for generating URLs with Ruby code.</p>

<pre class="code ruby"><code class="ruby">  <span class='const'>Prefix</span> <span class='const'>Verb</span>   <span class='const'>URI</span> <span class='const'>Pattern</span>             <span class='const'>Controller</span><span class='comment'>#Action
</span><span class='id identifier rubyid_products'>products</span> <span class='const'>GET</span>    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>products(.:format)     products#index
 product GET    </span><span class='regexp_end'>/products</span></span><span class='op'>/</span><span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>(.<span class='symbeg'>:</span><span class='id identifier rubyid_format'>format</span>) <span class='id identifier rubyid_products'>products</span><span class='comment'>#show</span></code></pre>

<p>These route prefixes give us helpers like the following:</p>

<ul>
<li><code>products_path</code> generates <code>&quot;/products&quot;</code></li>
<li><code>products_url</code> generates <code>&quot;http://localhost:3000/products&quot;</code></li>
<li><code>product_path(1)</code> generates <code>&quot;/products/1&quot;</code></li>
<li><code>product_url(1)</code> generates <code>&quot;http://localhost:3000/products/1&quot;</code></li>
</ul>

<p><code>_path</code> returns a relative path which the browser understands is for the current
domain.</p>

<p><code>_url</code> returns a full URL including the protocol, host, and port.</p>

<p>URL helpers are useful for rendering emails that will be viewed outside of the
browser.</p>

<p>Combined with the <code>link_to</code> helper, we can generate anchor tags and use the URL
helper to do this cleanly in Ruby. <code>link_to</code> accepts the display content for the
link (<code>product.name</code>) and the path or URL to link to for the <code>href</code> attribute
(<code>product</code>).</p>

<p>Let&#39;s refactor this to use these helpers:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/index.html.erb %&gt;
&lt;h1&gt;Products&lt;/h1&gt;

&lt;div id=&quot;products&quot;&gt;
  &lt;% @products.each do |product| %&gt;
    &lt;div&gt;
      &lt;%= link_to product.name, product_path(product.id) %&gt;
    &lt;/div&gt;
  &lt;% end %&gt;
&lt;/div&gt;
</code></pre>

<h3>Creating Products</h3>

<p>So far we&#39;ve had to create products in the Rails console, but let&#39;s make this
work in the browser.</p>

<p>We need to create two actions for create:</p>

<ol>
<li>The new product form to collect product information</li>
<li>The create action in the controller to save the product and check for errors</li>
</ol>

<p>Let&#39;s start with our controller actions.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/controllers/products_controller.rb
</span><span class='kw'>class</span> <span class='const'>ProductsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
    <span class='ivar'>@products</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_all'>all</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
    <span class='ivar'>@product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>
    <span class='ivar'>@product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The <code>new</code> action instantiates a new <code>Product</code> which we will use for displaying
the form fields.</p>

<p>We can update <code>app/views/products/index.html.erb</code> to link to the new action.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/index.html.erb %&gt;
&lt;h1&gt;Products&lt;/h1&gt;

&lt;%= link_to &quot;New product&quot;, new_product_path %&gt;

&lt;div id=&quot;products&quot;&gt;
  &lt;% @products.each do |product| %&gt;
    &lt;div&gt;
      &lt;%= link_to product.name, product_path(product.id) %&gt;
    &lt;/div&gt;
  &lt;% end %&gt;
&lt;/div&gt;
</code></pre>

<p>Let&#39;s create <code>app/views/products/new.html.erb</code> to render the form for this new
<code>Product</code>.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/new.html.erb %&gt;
&lt;h1&gt;New product&lt;/h1&gt;

&lt;%= form_with model: @product do |form| %&gt;
  &lt;div&gt;
    &lt;%= form.label :name %&gt;
    &lt;%= form.text_field :name %&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;%= form.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;

&lt;%= link_to &quot;Cancel&quot;, products_path %&gt;
</code></pre>

<p>In this view, we are using the Rails <code>form_with</code> helper to generate an HTML form
to create products. This helper uses a <em>form builder</em> to handle things like CSRF
tokens, generating the URL based upon the <code>model:</code> provided, and even tailoring
the submit button text to the model.</p>

<p>If you open this page in your browser and View Source, the HTML for the form
will look like this:</p>

<pre class="code xml"><code class="xml">&lt;form action=&quot;/products&quot; accept-charset=&quot;UTF-8&quot; method=&quot;post&quot;&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;authenticity_token&quot; value=&quot;UHQSKXCaFqy_aoK760zpSMUPy6TMnsLNgbPMABwN1zpW-Jx6k-2mISiF0ulZOINmfxPdg5xMyZqdxSW1UK-H-Q&quot; autocomplete=&quot;off&quot;&gt;

  &lt;div&gt;
    &lt;label for=&quot;product_name&quot;&gt;Name&lt;/label&gt;
    &lt;input type=&quot;text&quot; name=&quot;product[name]&quot; id=&quot;product_name&quot;&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;input type=&quot;submit&quot; name=&quot;commit&quot; value=&quot;Create Product&quot; data-disable-with=&quot;Create Product&quot;&gt;
  &lt;/div&gt;
&lt;/form&gt;
</code></pre>

<p>The form builder has included a CSRF token for security, configured the form for
UTF-8 support, set the input field names and even added a disabled state for the
submit button.</p>

<p>Because we passed a new <code>Product</code> instance to the form builder, it automatically
generated a form configured to send a <code>POST</code> request to <code>/products</code>, which is
the default route for creating a new record.</p>

<p>To handle this, we first need to implement the <code>create</code> action in our
controller.</p>

<pre class="code ruby#15-27"><code class="ruby#15-27"># app/controllers/products_controller.rb
class ProductsController &lt; ApplicationController
  def index
    @products = Product.all
  end

  def show
    @product = Product.find(params[:id])
  end

  def new
    @product = Product.new
  end

  def create
    @product = Product.new(product_params)
    if @product.save
      redirect_to @product
    else
      render :new, status: :unprocessable_entity
    end
  end

  private
    def product_params
      params.expect(product: [ :name ])
    end
end
</code></pre>

<h4>Strong Parameters</h4>

<p>The <code>create</code> action handles the data submitted by the form, but it needs to be
filtered for security. That&#39;s where the <code>product_params</code> method comes into play.</p>

<p>In <code>product_params</code>, we tell Rails to inspect the params and ensure there is a
key named <code>:product</code> with an array of parameters as the value. The only
permitted parameters for products is <code>:name</code> and Rails will ignore any other
parameters. This protects our application from malicious users who might try to
hack our application.</p>

<h4>Handling Errors</h4>

<p>After assigning these params to the new <code>Product</code>, we can try to save it to the
database. <code>@product.save</code> tells Active Record to run validations and save the
record to the database.</p>

<p>If <code>save</code> is successful, we want to redirect to the new product. When
<code>redirect_to</code> is given an Active Record object, Rails generates a path for that
record&#39;s show action.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@product</span></code></pre>

<p>Since <code>@product</code> is a <code>Product</code> instance, Rails pluralizes the model name and
includes the object&#39;s ID in the path to produce <code>&quot;/products/2&quot;</code> for the
redirect.</p>

<p>When <code>save</code> is unsuccessful and the record wasn&#39;t valid, we want to re-render
the form so the user can fix the invalid data. In the <code>else</code> clause, we tell
Rails to <code>render :new</code>. Rails knows we&#39;re in the <code>Products</code> controller, so it
should render <code>app/views/products/new.html.erb</code>. Since we&#39;ve set the <code>@product</code>
variable in <code>create</code>, we can render that template and the form will be populated
with our <code>Product</code> data even though it wasn&#39;t able to be saved in the database.</p>

<p>We also set the HTTP status to 422 Unprocessable Entity to tell the browser this
POST request failed and to handle it accordingly.</p>

<h3>Editing Products</h3>

<p>The process of editing records is very similar to creating records. Instead of
<code>new</code> and <code>create</code> actions, we will have <code>edit</code> and <code>update</code>.</p>

<p>Let&#39;s implement them in the controller with the following:</p>

<pre class="code ruby#24-35"><code class="ruby#24-35"># app/controllers/products_controller.rb
class ProductsController &lt; ApplicationController
  def index
    @products = Product.all
  end

  def show
    @product = Product.find(params[:id])
  end

  def new
    @product = Product.new
  end

  def create
    @product = Product.new(product_params)
    if @product.save
      redirect_to @product
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
    @product = Product.find(params[:id])
  end

  def update
    @product = Product.find(params[:id])
    if @product.update(product_params)
      redirect_to @product
    else
      render :edit, status: :unprocessable_entity
    end
  end

  private
    def product_params
      params.expect(product: [ :name ])
    end
end
</code></pre>

<h4>Extracting Partials</h4>

<p>We&#39;ve already written a form for creating new products. Wouldn&#39;t it be nice if
we could reuse that for edit and update? We can, using a feature called
&quot;partials&quot; that allows you to reuse a view in multiple places.</p>

<p>We can move the form into a file called <code>app/views/products/_form.html.erb</code>. The
filename starts with an underscore to denote this is a partial.</p>

<p>We also want to replace any instance variables with a local variable, which we
can define when we render the partial. We&#39;ll do this by replacing <code>@product</code>
with <code>product</code>.</p>

<p>Let&#39;s also display any errors from the form submission inside the form.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/_form.html.erb %&gt;
&lt;%= form_with model: product do |form| %&gt;
  &lt;% if form.object.errors.any? %&gt;
    &lt;p class=&quot;error&quot;&gt;&lt;%= form.object.errors.full_messages.first %&gt;&lt;/p&gt;
  &lt;% end %&gt;

  &lt;div&gt;
    &lt;%= form.label :name %&gt;
    &lt;%= form.text_field :name %&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;%= form.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>

<p>TIP: Using local variables allows partials to be reused multiple times on the
same page with a different value each time. This comes in handy rendering lists
of items like an index page.</p>

<p>To use this partial in our <code>app/views/products/new.html.erb</code> view, we can
replace the form with a render call:</p>

<pre class="code xml"><code class="xml">&lt;h1&gt;New product&lt;/h1&gt;

&lt;%= render &quot;form&quot;, product: @product %&gt;
&lt;%= link_to &quot;Cancel&quot;, products_path %&gt;
</code></pre>

<p>The edit view becomes almost the exact same thing thanks to the form partial.
Let&#39;s create <code>app/views/products/edit.html.erb</code> with the following:</p>

<pre class="code xml"><code class="xml">&lt;h1&gt;Edit product&lt;/h1&gt;

&lt;%= render &quot;form&quot;, product: @product %&gt;
&lt;%= link_to &quot;Cancel&quot;, @product %&gt;
</code></pre>

<p>To learn more about view partials, check out the
<a href="action_view_overview.html">Action View Guide</a>.</p>

<p>Now we can add an Edit link to <code>app/views/products/show.html.erb</code>:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/new.html.erb %&gt;
&lt;h1&gt;New product&lt;/h1&gt;

&lt;%= render &quot;form&quot;, product: @product %&gt;
&lt;%= link_to &quot;Cancel&quot;, products_path %&gt;
</code></pre>

<p>The edit view becomes almost the exact same thing thanks to the form partial.
Let&#39;s create <code>app/views/products/edit.html.erb</code> with the following:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/edit.html.erb %&gt;
&lt;h1&gt;Edit product&lt;/h1&gt;

&lt;%= render &quot;form&quot;, product: @product %&gt;
&lt;%= link_to &quot;Cancel&quot;, @product %&gt;
</code></pre>

<p>To learn more about view partials, check out the
<a href="action_view_overview.html">Action View Guide</a>.</p>

<p>Now we can add an Edit link to <code>app/views/products/show.html.erb</code>:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/show.html.erb %&gt;
&lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;

&lt;%= link_to &quot;Back&quot;, products_path %&gt;
&lt;%= link_to &quot;Edit&quot;, edit_product_path(@product) %&gt;
</code></pre>

<h4>Before Actions</h4>

<p>Since <code>edit</code> and <code>update</code> require an existing database record like <code>show</code> we can
deduplicate this into a <code>before_action</code>.</p>

<p>A <code>before_action</code> allows you to extract shared code between actions and run it
<em>before</em> the action. In the above controller code,
<code>@product = Product.find(params[:id])</code> is defined in three different methods.
Extracting this query to a before action called <code>set_product</code> cleans up our code
for each action.</p>

<p>This is a good example of the DRY (Don&#39;t Repeat Yourself) philosophy in action.</p>

<pre class="code ruby#3,9-10,25-26,28-34,37-39"><code class="ruby#3,9-10,25-26,28-34,37-39"># app/controllers/products_controller.rb
class ProductsController &lt; ApplicationController
  before_action :set_product, only: %i[ show edit update ]

  def index
    @products = Product.all
  end

  def show
  end

  def new
    @product = Product.new
  end

  def create
    @product = Product.new(product_params)
    if @product.save
      redirect_to @product
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
  end

  def update
    if @product.update(product_params)
      redirect_to @product
    else
      render :edit, status: :unprocessable_entity
    end
  end

  private
    def set_product
      @product = Product.find(params[:id])
    end

    def product_params
      params.expect(product: [ :name ])
    end
end
</code></pre>

<h3>Deleting Products</h3>

<p>The last feature we need to implement is deleting products. We will add a
<code>destroy</code> action to our <code>ProductsController</code> to handle <code>DELETE /products/:id</code>
requests.</p>

<p>Adding <code>destroy</code> to <code>before_action :set_product</code> lets us set the <code>@product</code>
instance variable in the same way we do for the other actions.</p>

<pre class="code ruby#3,36-39"><code class="ruby#3,36-39"># app/controllers/products_controller.rb
class ProductsController &lt; ApplicationController
  before_action :set_product, only: %i[ show edit update destroy ]

  def index
    @products = Product.all
  end

  def show
  end

  def new
    @product = Product.new
  end

  def create
    @product = Product.new(product_params)
    if @product.save
      redirect_to @product
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
  end

  def update
    if @product.update(product_params)
      redirect_to @product
    else
      render :edit, status: :unprocessable_entity
    end
  end

  def destroy
    @product.destroy
    redirect_to products_path
  end

  private
    def set_product
      @product = Product.find(params[:id])
    end

    def product_params
      params.expect(product: [ :name ])
    end
end
</code></pre>

<p>To make this work, we need to add a Delete button to
<code>app/views/products/show.html.erb</code>:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/show.html.erb %&gt;
&lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;

&lt;%= link_to &quot;Back&quot;, products_path %&gt;
&lt;%= link_to &quot;Edit&quot;, edit_product_path(@product) %&gt;
&lt;%= button_to &quot;Delete&quot;, @product, method: :delete, data: { turbo_confirm: &quot;Are you sure?&quot; } %&gt;
</code></pre>

<p><code>button_to</code> generates a form with a single button in it with the &quot;Delete&quot; text.
When this button is clicked, it submits the form which makes a <code>DELETE</code> request
to <code>/products/:id</code> which triggers the <code>destroy</code> action in our controller.</p>

<p>The <code>turbo_confirm</code> data attribute tells the Turbo JavaScript library to ask the
user to confirm before submitting the form. We&#39;ll dig more into that shortly.</p>

<h2>Adding Authentication</h2>

<p>Anyone can edit or delete products which isn&#39;t safe. Let&#39;s add some security by
requiring a user to be authenticated to manage products.</p>

<p>Rails comes with an authentication generator that we can use. It creates User
and Session models and the controllers and views necessary to login to our
application.</p>

<p>Head back to your terminal and run the following command:</p>

<pre class="code bash"><code class="bash">$ bin/rails generate authentication
</code></pre>

<p>Then migrate the database to add the User and Session tables.</p>

<pre class="code bash"><code class="bash">$ bin/rails db:migrate
</code></pre>

<p>Open the Rails console to create a User.</p>

<pre class="code bash"><code class="bash">$ bin/rails console
</code></pre>

<p>Use <code>User.create!</code> method to create a User in the Rails console. Feel free to
use your own email and password instead of the example.</p>

<pre class="code irb"><code class="irb">store(dev)&gt; User.create! email_address: &quot;you@example.org&quot;, password: &quot;s3cr3t&quot;, password_confirmation: &quot;s3cr3t&quot;
</code></pre>

<p>Restart your Rails server so it picks up the <code>bcrypt</code> gem added by the
generator. BCrypt is used for securely hashing passwords for authentication.</p>

<pre class="code bash"><code class="bash">$ bin/rails server
</code></pre>

<p>When you visit any page, Rails will prompt for a username and password. Enter
the email and password you used when creating the User record.</p>

<p>Try it out by visiting <a href="http://localhost:3000/products/new">http://localhost:3000/products/new</a></p>

<p>If you enter the correct username and password, it will allow you through. Your
browser will also store these credentials for future requests so you don&#39;t have
to type it in every page view.</p>

<h3>Adding Log Out</h3>

<p>To log out of the application, we can add a button to the top of
<code>app/views/layouts/application.html.erb</code>. This layout is where you put HTML that
you want to include in every page like a header or footer.</p>

<p>Add a small <code>&lt;nav&gt;</code> section inside the <code>&lt;body&gt;</code> with a link to Home and a Log
out button and wrap <code>yield</code> with a <code>&lt;main&gt;</code> tag.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/layouts/application.html.erb %&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;%# ... %&gt;
  &lt;body&gt;
    &lt;nav&gt;
      &lt;%= link_to &quot;Home&quot;, root_path %&gt;
      &lt;%= button_to &quot;Log out&quot;, session_path, method: :delete if authenticated? %&gt;
    &lt;/nav&gt;

    &lt;main&gt;
      &lt;%= yield %&gt;
    &lt;/main&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>This will display a Log out button only if the user is authenticated. When
clicked, it will send a DELETE request to the session path which will log the
user out.</p>

<h3>Allowing Unauthenticated Access</h3>

<p>However, our store&#39;s product index and show pages should be accessible to
everyone. By default, the Rails authentication generator will restrict all pages
to authenticated users only.</p>

<p>To allow guests to view products, we can allow unauthenticated access in our
controller.</p>

<pre class="code ruby#3"><code class="ruby#3"># app/controllers/products_controller.rb
class ProductsController &lt; ApplicationController
  allow_unauthenticated_access only: %i[ index show ]
  # ...
end
</code></pre>

<p>Log out and visit the products index and show pages to see they&#39;re accessible
without being authenticated.</p>

<h3>Showing Links for Authenticated Users Only</h3>

<p>Since only logged in users can create products, we can modify the
<code>app/views/products/index.html.erb</code> view to only display the new product link if
the user is authenticated.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/index.html.erb %&gt;
&lt;%= link_to &quot;New product&quot;, new_product_path if authenticated? %&gt;
</code></pre>

<p>Click the Log out button and you&#39;ll see the New link is hidden. Log in at
<a href="http://localhost:3000/session/new">http://localhost:3000/session/new</a> and you&#39;ll see the New link on the index page.</p>

<p>Optionally, you can include a link to this route in the navbar to add a Login
link if not authenticated.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/index.html.erb %&gt;
&lt;%= link_to &quot;Login&quot;, new_session_path unless authenticated? %&gt;
</code></pre>

<p>You can also update the Edit and Delete links on the
<code>app/views/products/show.html.erb</code> view to only display if authenticated.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/show.html.erb %&gt;
&lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;

&lt;%= link_to &quot;Back&quot;, products_path %&gt;
&lt;% if authenticated? %&gt;
  &lt;%= link_to &quot;Edit&quot;, edit_product_path(@product) %&gt;
  &lt;%= button_to &quot;Delete&quot;, @product, method: :delete, data: { turbo_confirm: &quot;Are you sure?&quot; } %&gt;
&lt;% end %&gt;
</code></pre>

<h2>Caching Products</h2>

<p>Sometimes caching specific parts of a page can improve performance. Rails
simplifies this process with Solid Cache, a database-backed cache store that
comes included by default.</p>

<p>Using the <code>cache</code> method, we can store HTML in the cache. Let&#39;s cache the header
in <code>app/views/products/show.html.erb</code>.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/show.html.erb %&gt;
&lt;% cache @product do %&gt;
  &lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;
&lt;% end %&gt;
</code></pre>

<p>By passing <code>@product</code> into <code>cache</code>, Rails generates a unique cache key for the
product. Active Record objects have a <code>cache_key</code> method that returns a String
like <code>&quot;products/1&quot;</code>. The <code>cache</code> helper in the views combines this with the
template digest to create a unique key for this HTML.</p>

<p>To enable caching in development, run the following command in your terminal.</p>

<pre class="code bash"><code class="bash">$ bin/rails dev:cache
</code></pre>

<p>When you visit a product&#39;s show action (like <code>/products/2</code>), you&#39;ll see the new
caching lines in your Rails server logs:</p>

<pre class="code bash"><code class="bash">Read fragment views/products/show:a5a585f985894cd27c8b3d49bb81de3a/products/1-20240918154439539125 (1.6ms)
Write fragment views/products/show:a5a585f985894cd27c8b3d49bb81de3a/products/1-20240918154439539125 (4.0ms)
</code></pre>

<p>The first time we open this page, Rails will generate a cache key and ask the
cache store if it exists. This is the <code>Read fragment</code> line.</p>

<p>Since this is the first page view, the cache does not exist so the HTML is
generated and written to the cache. We can see this as the <code>Write fragment</code> line
in the logs.</p>

<p>Refresh the page and you&#39;ll see the logs no longer contain the <code>Write fragment</code>.</p>

<pre class="code bash"><code class="bash">Read fragment views/products/show:a5a585f985894cd27c8b3d49bb81de3a/products/1-20240918154439539125 (1.3ms)
</code></pre>

<p>The cache entry was written by the last request, so Rails finds the cache entry
on the second request. Rails also changes the cache key when records are updated
to ensure that it never renders stale cache data.</p>

<p>Learn more in the <a href="caching_with_rails.html">Caching with Rails</a> guide.</p>

<h2>Rich Text Fields with Action Text</h2>

<p>Many applications need rich text with embeds (i.e. multimedia elements) and
Rails provides this functionality out of the box with Action Text.</p>

<p>To use Action Text, you&#39;ll first run the installer:</p>

<pre class="code bash"><code class="bash">$ bin/rails action_text:install
$ bundle install
$ bin/rails db:migrate
</code></pre>

<p>Restart your Rails server to make sure all the new features are loaded.</p>

<p>Now, let&#39;s add a rich text description field to our product.</p>

<p>First, add the following to the <code>Product</code> model:</p>

<pre class="code ruby#3"><code class="ruby#3"># app/models/product.rb
class Product &lt; ApplicationRecord
  has_rich_text :description
  validates :name, presence: true
end
</code></pre>

<p>The form can now be updated to include a rich text field for editing the
description in <code>app/views/products/_form.html.erb</code> before the submit button.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/_form.html.erb %&gt;
&lt;%= form_with model: product do |form| %&gt;
  &lt;%# ... %&gt;

  &lt;div&gt;
    &lt;%= form.label :description, style: &quot;display: block&quot; %&gt;
    &lt;%= form.rich_textarea :description %&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;%= form.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>

<p>Our controller also needs to permit this new parameter when the form is
submitted, so we&#39;ll update the permitted params to include description in
<code>app/controllers/products_controller.rb</code></p>

<pre class="code ruby#4"><code class="ruby#4"># app/controllers/products_controller.rb
    # Only allow a list of trusted parameters through.
    def product_params
      params.expect(product: [ :name, :description ])
    end
</code></pre>

<p>We also need to update the show view to display the description in
<code>app/views/products/show.html.erb</code>:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/show.html.erb%&gt;
&lt;% cache @product do %&gt;
  &lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;
  &lt;%= @product.description %&gt;
&lt;% end %&gt;
</code></pre>

<p>The cache key generated by Rails also changes when the view is modified. This
makes sure the cache stays in sync with the latest version of the view template.</p>

<p>Create a new product and add a description with bold and italic text. You&#39;ll see
that the show page displays the formatted text and editing the product retains
this rich text in the text area.</p>

<p>Check out the <a href="action_text_overview.html">Action Text Overview</a> to learn more.</p>

<h2>File Uploads with Active Storage</h2>

<p>Action Text is built upon another feature of Rails called Active Storage that
makes it easy to upload files.</p>

<p>Try editing a product and dragging an image into the rich text editor, then
update the record. You&#39;ll see that Rails uploads this image and renders it
inside the rich text editor. Cool, right?!</p>

<p>We can also use Active Storage directly. Let&#39;s add a featured image to the
<code>Product</code> model.</p>

<pre class="code ruby#3"><code class="ruby#3"># app/models/product.rb
class Product &lt; ApplicationRecord
  has_one_attached :featured_image
  has_rich_text :description
  validates :name, presence: true
end
</code></pre>

<p>Then we can add a file upload field to our product form before the submit
button:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/_form.html.erb %&gt;
&lt;%= form_with model: product do |form| %&gt;
  &lt;%# ... %&gt;

  &lt;div&gt;
    &lt;%= form.label :featured_image, style: &quot;display: block&quot; %&gt;
    &lt;%= form.file_field :featured_image, accept: &quot;image/*&quot; %&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;%= form.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>

<p>Add <code>:featured_image</code> as a permitted parameter in
<code>app/controllers/products_controller.rb</code></p>

<pre class="code ruby#4"><code class="ruby#4"># app/controllers/products_controller.rb
    # Only allow a list of trusted parameters through.
    def product_params
      params.expect(product: [ :name, :description, :featured_image ])
    end
</code></pre>

<p>Lastly, we want to display the featured image for our product in
<code>app/views/products/show.html.erb</code>. Add the following to the top.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/show.html.erb %&gt;
&lt;%= image_tag @product.featured_image if @product.featured_image.attached? %&gt;
</code></pre>

<p>Try uploading an image for a product and you&#39;ll see the image displayed on the
show page after saving.</p>

<p>Check out the <a href="active_storage_overview.html">Active Storage Overview</a> for more
details.</p>

<h2>Internationalization (I18n)</h2>

<p>Rails makes it easy to translate your app into other languages.</p>

<p>The <code>translate</code> or <code>t</code> helper in our views looks up a translation by name and
returns the text for the current locale.</p>

<p>In <code>app/views/products/index.html.erb</code>, let&#39;s update the header tag to use a
translation.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/index.html.erb %&gt;
&lt;h1&gt;&lt;%= t &quot;hello&quot; %&gt;&lt;/h1&gt;
</code></pre>

<p>Refreshing the page, we see <code>Hello world</code> is the header text now. Where did that
come from?</p>

<p>Since the default language is in English, Rails looks in <code>config/locales/en.yml</code>
(which was created during <code>rails new</code>) for a matching key under the locale.</p>

<pre class="code yaml"><code class="yaml"># config/locales/en.yml
en:
  hello: &quot;Hello world&quot;
</code></pre>

<p>Let&#39;s create a new locale file in our editor for Spanish and add a translation
in <code>config/locales/es.yml</code>.</p>

<pre class="code yaml"><code class="yaml"># config/locales/es.yml
es:
  hello: &quot;Hola mundo&quot;
</code></pre>

<p>We need to tell Rails which locale to use. The simplest option is to look for a
locale param in the URL. We can do this in
<code>app/controllers/application_controller.rb</code> with the following:</p>

<pre class="code ruby#5,7-10"><code class="ruby#5,7-10"># app/controllers/application_controller.rb
class ApplicationController &lt; ActionController::Base
  # ...

  around_action :switch_locale

  def switch_locale(&amp;action)
    locale = params[:locale] || I18n.default_locale
    I18n.with_locale(locale, &amp;action)
  end
end
</code></pre>

<p>This will run every request and look for <code>locale</code> in the params or fallback to
the default locale. It sets the locale for the request and resets it after it&#39;s
finished.</p>

<ul>
<li>Visit <a href="http://localhost:3000/products?locale=en">http://localhost:3000/products?locale=en</a>, you will see the English
translation.</li>
<li>Visit <a href="http://localhost:3000/products?locale=es">http://localhost:3000/products?locale=es</a>, you will see the Spanish
translation.</li>
<li>Visit <a href="http://localhost:3000/products">http://localhost:3000/products</a> without a locale param, it will fallback
to English.</li>
</ul>

<p>Let&#39;s update the index header to use a real translation instead of
<code>&quot;Hello world&quot;</code>.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/index.html.erb %&gt;
&lt;h1&gt;&lt;%= t &quot;.title&quot; %&gt;&lt;/h1&gt;
</code></pre>

<p>TIP: Notice the <code>.</code> before <code>title</code>? This tells Rails to use a relative locale
lookup. Relative lookups include the controller and action automatically in the
key so you don&#39;t have to type them every time. For <code>.title</code> with the English
locale, it will look up <code>en.products.index.title</code>.</p>

<p>In <code>config/locales/en.yml</code> we want to add the <code>title</code> key under <code>products</code> and
<code>index</code> to match our controller, view, and translation name.</p>

<pre class="code yaml"><code class="yaml"># config/locales/en.yml
en:
  hello: &quot;Hello world&quot;
  products:
    index:
      title: &quot;Products&quot;
</code></pre>

<p>In the Spanish locales file, we can do the same thing:</p>

<pre class="code yaml"><code class="yaml"># config/locales/es.yml
es:
  hello: &quot;Hola mundo&quot;
  products:
    index:
      title: &quot;Productos&quot;
</code></pre>

<p>You&#39;ll now see &quot;Products&quot; when viewing the English locale and &quot;Productos&quot; when
viewing the Spanish locale.</p>

<p>Learn more about the <a href="i18n.html">Rails Internationalization (I18n) API</a>.</p>

<h2>Action Mailer and Email Notifications</h2>

<p>A common feature of e-commerce stores is an email subscription to get notified
when a product is back in stock. Now that we&#39;ve seen the basics of Rails, let&#39;s
add this feature to our store.</p>

<h3>Basic Inventory Tracking</h3>

<p>First, let&#39;s add an inventory count to the Product model so we can keep track of
stock. We can generate this migration using the following command:</p>

<pre class="code bash"><code class="bash">$ bin/rails generate migration AddInventoryCountToProducts inventory_count:integer
</code></pre>

<p>NOTE: Rails infers that <code>AddInventoryCountToProducts</code> targets the <code>products</code>
table because the name matches the <code>add_&lt;columns&gt;_to_&lt;table&gt;</code> convention. That
pattern lets the generator pre-fill <code>add_column :products, ...</code>, so you only
need to supply the column details. Run <code>bin/rails generate migration --help</code> to
see more naming conventions.</p>

<p>This will generate a migration file. Open it and add a default value of <code>0</code> to
ensure <code>inventory_count</code> is never <code>nil</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/&lt;timestamp&gt;_add_inventory_count_to_products.rb
</span><span class='kw'>class</span> <span class='const'>AddInventoryCountToProducts</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Migration.html" title="ActiveRecord::Migration (class)">Migration</a></span>[<span class='float'>8.2</span>]
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_add_column'>add_column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_products'>products</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_inventory_count'>inventory_count</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_integer'>integer</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='int'>0</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Then let&#39;s run the migration.</p>

<pre class="code bash"><code class="bash">$ bin/rails db:migrate
</code></pre>

<p>We&#39;ll need to add the inventory count to the product form in
<code>app/views/products/_form.html.erb</code>.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/_form.html.erb %&gt;
&lt;%= form_with model: product do |form| %&gt;
  &lt;%# ... %&gt;

  &lt;div&gt;
    &lt;%= form.label :inventory_count, style: &quot;display: block&quot; %&gt;
    &lt;%= form.number_field :inventory_count %&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;%= form.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>

<p>The controller also needs <code>:inventory_count</code> added to the permitted parameters.</p>

<pre class="code ruby#3"><code class="ruby#3"># app/controllers/products_controller.rb
    def product_params
      params.expect(product: [ :name, :description, :featured_image, :inventory_count ])
    end
</code></pre>

<p>It would also be helpful to validate that our inventory count is never a
negative number, so let&#39;s also add a validation for that in our model.</p>

<pre class="code ruby#7"><code class="ruby#7"># app/models/product.rb
class Product &lt; ApplicationRecord
  has_one_attached :featured_image
  has_rich_text :description

  validates :name, presence: true
  validates :inventory_count, numericality: { greater_than_or_equal_to: 0 }
end
</code></pre>

<p>With these changes, we can now update the inventory count of products in our
store.</p>

<h3>Adding Subscribers to Products</h3>

<p>In order to notify users that a product is back in stock, we need to keep track
of these subscribers.</p>

<p>Let&#39;s generate a model called Subscriber to store these email addresses and
associate them with the respective product.</p>

<p>NOTE: Here we are not specifying a type for <code>email</code> as rails automatically defaults to a <code>string</code> when a type is not given for migrations.</p>

<pre class="code bash"><code class="bash">$ bin/rails generate model Subscriber product:belongs_to email
</code></pre>

<p>By including <code>product:belongs_to</code> above, we told Rails that subscribers and products have a one-to-many relationship, meaning a Subscriber &quot;belongs to&quot; a single Product instance.</p>

<p>Next, open the generated migration (<code>db/migrate/&lt;timestamp&gt;_create_subscribers.rb</code>) like we did for Product.</p>

<pre class="code ruby#5-6"><code class="ruby#5-6"># db/migrate/&lt;timestamp&gt;_create_subscribers.rb
class CreateSubscribers &lt; ActiveRecord::Migration[8.2]
  def change
    create_table :subscribers do |t|
      t.belongs_to :product, null: false, foreign_key: true
      t.string :email

      t.timestamps
    end
  end
end
</code></pre>

<p>This looks quite similar to the migration for <code>Product</code>, the main new thing is <code>belongs_to</code> which adds a <code>product_id</code> foreign key column.</p>

<p>Then run the new migration:</p>

<pre class="code bash"><code class="bash">$ bin/rails db:migrate
</code></pre>

<p>A Product, however, can have many subscribers, so we then add
<code>has_many :subscribers, dependent: :destroy</code> to our Product model to add the
second part of this association between the two models. This tells Rails how to
join queries between the two database tables.</p>

<pre class="code ruby#2"><code class="ruby#2"># app/models/product.rb
class Product &lt; ApplicationRecord
  has_many :subscribers, dependent: :destroy
  has_one_attached :featured_image
  has_rich_text :description

  validates :name, presence: true
  validates :inventory_count, numericality: { greater_than_or_equal_to: 0 }
end
</code></pre>

<p>Now we need a controller to create these subscribers. Let&#39;s create that in
<code>app/controllers/subscribers_controller.rb</code> with the following code:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/controllers/subscribers_controller.rb
</span><span class='kw'>class</span> <span class='const'>SubscribersController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='id identifier rubyid_allow_unauthenticated_access'>allow_unauthenticated_access</span>
  <span class='id identifier rubyid_before_action'>before_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_set_product'>set_product</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='ivar'>@product</span>.<span class='id identifier rubyid_subscribers'>subscribers</span>.<span class='id identifier rubyid_where'>where</span>(<span class='id identifier rubyid_subscriber_params'>subscriber_params</span>).<span class='id identifier rubyid_first_or_create'>first_or_create</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@product</span><span class='comma'>,</span> <span class='label'>notice:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You are now subscribed.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_set_product'>set_product</span>
      <span class='ivar'>@product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_product_id'>product_id</span>])
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_subscriber_params'>subscriber_params</span>
      <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_expect'>expect</span>(<span class='label'>subscriber:</span> [ <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span> ])
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The <code>redirect_to</code> uses the <code>notice:</code> argument to set a &quot;flash&quot; message to tell
the user they are subscribed.</p>

<p>The <a href="https://api.rubyonrails.org/classes/ActionDispatch/Flash.html">flash</a>
provides a way to pass temporary data between controller actions. Anything you
place in the flash will be available to the very next action and then cleared.
The flash is typically used for setting messages (e.g. notices and alerts) in a
controller action before redirecting to an action that displays the message to
the user.</p>

<p>To display the flash message, let&#39;s add the flash to
<code>app/views/layouts/application.html.erb</code> inside the body:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/layouts/application.html.erb %&gt;
&lt;html&gt;
  &lt;%# ... %&gt;
  &lt;body&gt;
    &lt;div class=&quot;notice&quot;&gt;&lt;%= flash[:notice] %&gt;&lt;/div&gt;
    &lt;div class=&quot;alert&quot;&gt;&lt;%= flash[:alert] %&gt;&lt;/div&gt;
    &lt;%# ... %&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Learn more about the Flash in the <a href="action_controller_overview.html#the-flash">Action Controller Overview</a></p>

<p>To subscribe users to a specific product, we&#39;ll use a nested route so we know
which product the subscriber belongs to. In <code>config/routes.rb</code> change
<code>resources :products</code> to the following:</p>

<pre class="code ruby4-6"><code class="ruby4-6"># config/routes.rb
Rails.application.routes.draw do
  # ...
  resources :products do
    resources :subscribers, only: [ :create ]
  end
end
</code></pre>

<p>On the product show page, we can check if there is inventory and display the
amount in stock. Otherwise, we can display an out of stock message with the
subscribe form to get notified when it is back in stock.</p>

<p>Create a new partial at <code>app/views/products/_inventory.html.erb</code> and add the
following:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/_inventory.html.erb %&gt;
&lt;% if product.inventory_count.positive? %&gt;
  &lt;p&gt;&lt;%= product.inventory_count %&gt; in stock&lt;/p&gt;
&lt;% else %&gt;
  &lt;p&gt;Out of stock&lt;/p&gt;
  &lt;p&gt;Email me when available.&lt;/p&gt;

  &lt;%= form_with model: [product, Subscriber.new] do |form| %&gt;
    &lt;%= form.email_field :email, placeholder: &quot;you@example.com&quot;, required: true %&gt;
    &lt;%= form.submit &quot;Submit&quot; %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;
</code></pre>

<p>Then update <code>app/views/products/show.html.erb</code> to render this partial after the
<code>cache</code> block.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/show.html.erb %&gt;
&lt;%= render &quot;inventory&quot;, product: @product %&gt;
</code></pre>

<h3>In Stock Email Notifications</h3>

<p>Action Mailer is a feature of Rails that allows you to send emails. We&#39;ll use it
to notify subscribers when a product is back in stock.</p>

<p>We can generate a mailer with the following command:</p>

<pre class="code bash"><code class="bash">$ bin/rails g mailer Product in_stock
</code></pre>

<p>This generates a class at <code>app/mailers/product_mailer.rb</code> with an <code>in_stock</code>
method.</p>

<p>Update this method to mail to a subscriber&#39;s email address.</p>

<pre class="code ruby#7-10"><code class="ruby#7-10"># app/mailers/product_mailer.rb
class ProductMailer &lt; ApplicationMailer
  # Subject can be set in your I18n file at config/locales/en.yml
  # with the following lookup:
  #
  #   en.product_mailer.in_stock.subject
  #
  def in_stock
    @product = params[:product]
    mail to: params[:subscriber].email
  end
end
</code></pre>

<p>The mailer generator also generates two email templates in our views folder: one
for HTML and one for Text. We can update those to include a message and link to
the product.</p>

<p>Change <code>app/views/product_mailer/in_stock.html.erb</code> to:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/product_mailer/in_stock.html.erb %&gt;
&lt;h1&gt;Good news!&lt;/h1&gt;

&lt;p&gt;&lt;%= link_to @product.name, product_url(@product) %&gt; is back in stock.&lt;/p&gt;
</code></pre>

<p>And <code>app/views/product_mailer/in_stock.text.erb</code> to:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/product_mailer/in_stock.text.erb %&gt;
Good news!

&lt;%= @product.name %&gt; is back in stock.
&lt;%= product_url(@product) %&gt;
</code></pre>

<p>We use <code>product_url</code> instead of <code>product_path</code> in mailers because email clients
need to know the full URL to open in the browser when the link is clicked.</p>

<p>We can test an email by opening the Rails console and loading a product and
subscriber to send to:</p>

<pre class="code irb"><code class="irb">store(dev)&gt; product = Product.first
store(dev)&gt; subscriber = product.subscribers.find_or_create_by(email: &quot;subscriber@example.org&quot;)
store(dev)&gt; ProductMailer.with(product: product, subscriber: subscriber).in_stock.deliver_later
</code></pre>

<p>You&#39;ll see that it prints out an email in the logs.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>ProductMailer</span><span class='comment'>#in_stock: processed outbound mail in 63.0ms
</span><span class='const'>Delivered</span> <span class='id identifier rubyid_mail'>mail</span> <span class='int'>66</span><span class='id identifier rubyid_a3a9afd5d4a_108b04a4c41443'>a3a9afd5d4a_108b04a4c41443</span><span class='ivar'>@local</span>.<span class='id identifier rubyid_mail'>mail</span> (<span class='float'>33.1</span><span class='id identifier rubyid_ms'>ms</span>)
<span class='const'><a href="Date.html" title="Date (class)">Date</a></span><span class='op'>:</span> <span class='const'>Fri</span><span class='comma'>,</span> <span class='int'>26</span> <span class='const'>Jul</span> <span class='int'>2024</span> <span class='int'>08</span><span class='symbeg'>:</span><span class='int'>50</span><span class='symbeg'>:</span><span class='int'>39</span> <span class='op'>-</span><span class='int'>0500</span>
<span class='const'>From</span><span class='op'>:</span> <span class='id identifier rubyid_from'>from</span><span class='ivar'>@example</span>.<span class='id identifier rubyid_com'>com</span>
<span class='const'>To</span><span class='op'>:</span> <span class='id identifier rubyid_subscriber'>subscriber</span><span class='ivar'>@example</span>.<span class='id identifier rubyid_com'>com</span>
<span class='const'>Message</span><span class='op'>-</span><span class='const'>ID</span><span class='op'>:</span> <span class='op'>&lt;</span><span class='int'>66</span><span class='id identifier rubyid_a3a9afd5d4a_108b04a4c41443'>a3a9afd5d4a_108b04a4c41443</span><span class='ivar'>@local</span>.<span class='id identifier rubyid_mail'>mail</span><span class='op'>&gt;</span>
<span class='const'>Subject</span><span class='op'>:</span> <span class='const'>In</span> <span class='id identifier rubyid_stock'>stock</span>
<span class='const'><a href="Mime.html" title="Mime (module)">Mime</a></span><span class='op'>-</span><span class='const'>Version</span><span class='op'>:</span> <span class='float'>1.0</span>
<span class='const'>Content</span><span class='op'>-</span><span class='const'>Type</span><span class='op'>:</span> <span class='id identifier rubyid_multipart'>multipart</span><span class='op'>/</span><span class='id identifier rubyid_alternative'>alternative</span><span class='semicolon'>;</span>
 <span class='id identifier rubyid_boundary'>boundary</span><span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--==_mimepart_66a3a9afd235e_108b04a4c4136f</span><span class='tstring_end'>&quot;</span></span><span class='semicolon'>;</span>
 <span class='id identifier rubyid_charset'>charset</span><span class='op'>=</span><span class='const'>UTF</span><span class='op'>-</span><span class='int'>8</span>
<span class='const'>Content</span><span class='op'>-</span><span class='const'>Transfer</span><span class='op'>-</span><span class='const'>Encoding</span><span class='op'>:</span> <span class='int'>7</span><span class='id identifier rubyid_bit'>bit</span>


<span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-=</span><span class='op'>=</span><span class='id identifier rubyid__mimepart_66a3a9afd235e_108b04a4c4136f'>_mimepart_66a3a9afd235e_108b04a4c4136f</span>
<span class='const'>Content</span><span class='op'>-</span><span class='const'>Type</span><span class='op'>:</span> <span class='id identifier rubyid_text'>text</span><span class='op'>/</span><span class='id identifier rubyid_plain'>plain</span><span class='semicolon'>;</span>
 <span class='id identifier rubyid_charset'>charset</span><span class='op'>=</span><span class='const'>UTF</span><span class='op'>-</span><span class='int'>8</span>
<span class='const'>Content</span><span class='op'>-</span><span class='const'>Transfer</span><span class='op'>-</span><span class='const'>Encoding</span><span class='op'>:</span> <span class='int'>7</span><span class='id identifier rubyid_bit'>bit</span>

<span class='const'>Good</span> <span class='id identifier rubyid_news!'>news!</span>

<span class='const'>T</span><span class='op'>-</span><span class='const'>Shirt</span> <span class='id identifier rubyid_is'>is</span> <span class='id identifier rubyid_back'>back</span> <span class='kw'>in</span> <span class='id identifier rubyid_stock'>stock</span>.
<span class='id identifier rubyid_http'>http</span><span class='symbeg'>:</span><span class='op'>/</span><span class='op'>/</span><span class='id identifier rubyid_localhost'>localhost</span><span class='symbeg'>:</span><span class='int'>3000</span><span class='op'>/</span><span class='id identifier rubyid_products'>products</span><span class='op'>/</span><span class='int'>1</span>


<span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-=</span><span class='op'>=</span><span class='id identifier rubyid__mimepart_66a3a9afd235e_108b04a4c4136f'>_mimepart_66a3a9afd235e_108b04a4c4136f</span>
<span class='const'>Content</span><span class='op'>-</span><span class='const'>Type</span><span class='op'>:</span> <span class='id identifier rubyid_text'>text</span><span class='op'>/</span><span class='id identifier rubyid_html'>html</span><span class='semicolon'>;</span>
 <span class='id identifier rubyid_charset'>charset</span><span class='op'>=</span><span class='const'>UTF</span><span class='op'>-</span><span class='int'>8</span>
<span class='const'>Content</span><span class='op'>-</span><span class='const'>Transfer</span><span class='op'>-</span><span class='const'>Encoding</span><span class='op'>:</span> <span class='int'>7</span><span class='id identifier rubyid_bit'>bit</span>

<span class='op'>&lt;</span><span class='op'>!</span><span class='op'>-</span><span class='op'>-</span> <span class='kw'>BEGIN</span> <span class='id identifier rubyid_app'>app</span><span class='op'>/</span><span class='id identifier rubyid_views'>views</span><span class='op'>/</span><span class='id identifier rubyid_layouts'>layouts</span><span class='op'>/</span><span class='id identifier rubyid_mailer'>mailer</span>.<span class='id identifier rubyid_html'>html</span>.<span class='id identifier rubyid_erb'>erb</span> <span class='op'>-</span><span class='tlambda'>-&gt;</span><span class='op'>&lt;</span><span class='op'>!</span><span class='const'>DOCTYPE</span> <span class='id identifier rubyid_html'>html</span><span class='op'>&gt;</span>
<span class='op'>&lt;</span><span class='id identifier rubyid_html'>html</span><span class='op'>&gt;</span>
  <span class='op'>&lt;</span><span class='id identifier rubyid_head'>head</span><span class='op'>&gt;</span>
    <span class='op'>&lt;</span><span class='id identifier rubyid_meta'>meta</span> <span class='id identifier rubyid_http'>http</span><span class='op'>-</span><span class='id identifier rubyid_equiv'>equiv</span><span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='id identifier rubyid_content'>content</span><span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/html; charset=utf-8</span><span class='tstring_end'>&quot;</span></span><span class='op'>&gt;</span>
    <span class='op'>&lt;</span><span class='id identifier rubyid_style'>style</span><span class='op'>&gt;</span>
      <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* Email styles need to be inline *</span><span class='regexp_end'>/</span></span>
    <span class='op'>&lt;</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>style&gt;
  &lt;</span><span class='regexp_end'>/head</span></span><span class='op'>&gt;</span>

  <span class='op'>&lt;</span><span class='id identifier rubyid_body'>body</span><span class='op'>&gt;</span>
    <span class='op'>&lt;</span><span class='op'>!</span><span class='op'>-</span><span class='op'>-</span> <span class='kw'>BEGIN</span> <span class='id identifier rubyid_app'>app</span><span class='op'>/</span><span class='id identifier rubyid_views'>views</span><span class='op'>/</span><span class='id identifier rubyid_product_mailer'>product_mailer</span><span class='op'>/</span><span class='id identifier rubyid_in_stock'>in_stock</span>.<span class='id identifier rubyid_html'>html</span>.<span class='id identifier rubyid_erb'>erb</span> <span class='op'>-</span><span class='tlambda'>-&gt;</span><span class='op'>&lt;</span><span class='id identifier rubyid_h1'>h1</span><span class='op'>&gt;</span><span class='const'>Good</span> <span class='id identifier rubyid_news!'>news!</span><span class='op'>&lt;</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>h1&gt;

&lt;p&gt;&lt;a href=&quot;http:</span><span class='regexp_end'>/</span></span><span class='op'>/</span><span class='id identifier rubyid_localhost'>localhost</span><span class='symbeg'>:</span><span class='int'>3000</span><span class='op'>/</span><span class='id identifier rubyid_products'>products</span><span class='op'>/</span><span class='int'>1</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;T-Shirt&lt;/a&gt; is back in stock.&lt;/p&gt;
&lt;!-- END app/views/product_mailer/in_stock.html.erb --&gt;
  &lt;/body&gt;
&lt;/html&gt;
&lt;!-- END app/views/layouts/mailer.html.erb --&gt;
----==_mimepart_66a3a9afd235e_108b04a4c4136f--

Performed ActionMailer::MailDeliveryJob (Job ID: 5e2bd5f2-f54f-4088-ace3-3f6eb15aaf46) from Async(default) in 111.34ms</span></code></pre>

<p>To trigger these emails, we can use a callback in the Product model to send
emails anytime the inventory count changes from 0 to a positive number.</p>

<pre class="code ruby#10-20"><code class="ruby#10-20"># app/models/product.rb
class Product &lt; ApplicationRecord
  has_many :subscribers, dependent: :destroy
  has_one_attached :featured_image
  has_rich_text :description

  validates :name, presence: true
  validates :inventory_count, numericality: { greater_than_or_equal_to: 0 }

  after_update_commit :notify_subscribers, if: :back_in_stock?

  def back_in_stock?
    inventory_count_previously_was.zero? &amp;&amp; inventory_count.positive?
  end

  def notify_subscribers
    subscribers.each do |subscriber|
      ProductMailer.with(product: self, subscriber: subscriber).in_stock.deliver_later
    end
  end
end
</code></pre>

<p><code>after_update_commit</code> is an Active Record callback that is fired after changes
are saved to the database. <code>if: :back_in_stock?</code> tells the callback to run only
if the <code>back_in_stock?</code> method returns true.</p>

<p>Active Record keeps track of changes to attributes so <code>back_in_stock?</code> checks
the previous value of <code>inventory_count</code> using <code>inventory_count_previously_was</code>.
Then we can compare that against the current inventory count to determine if the
product is back in stock.</p>

<p><code>notify_subscribers</code> uses the Active Record association to query the
<code>subscribers</code> table for all subscribers for this specific product and then
queues up the <code>in_stock</code> email to be sent to each of them.</p>

<h3>Extracting a Concern</h3>

<p>The Product model now has a decent amount of code for handling notifications. To
better organize our code, we can extract this to an <a href="ActiveSupport/Concern.html" title="ActiveSupport::Concern (module)"><code>::ActiveSupport::Concern</code></a>. A
Concern is a Ruby module with some syntactic sugar to make using them easier.</p>

<p>First let’s create the Notifications module.</p>

<p>Create a file at <code>app/models/product/notifications.rb</code> with the following:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/product/notifications.rb
</span><span class='kw'>module</span> <span class='const'>Product</span><span class='op'>::</span><span class='const'>Notifications</span>
  <span class='id identifier rubyid_extend'>extend</span> <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/Concern.html" title="ActiveSupport::Concern (module)">Concern</a></span>

  <span class='id identifier rubyid_included'>included</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_subscribers'>subscribers</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_after_update_commit'>after_update_commit</span> <span class='symbeg'>:</span><span class='id identifier rubyid_notify_subscribers'>notify_subscribers</span><span class='comma'>,</span> <span class='label'>if:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_back_in_stock?'>back_in_stock?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_back_in_stock?'>back_in_stock?</span>
    <span class='id identifier rubyid_inventory_count_previously_was'>inventory_count_previously_was</span>.<span class='id identifier rubyid_zero?'>zero?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_inventory_count'>inventory_count</span>.<span class='id identifier rubyid_positive?'>positive?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_notify_subscribers'>notify_subscribers</span>
    <span class='id identifier rubyid_subscribers'>subscribers</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_subscriber'>subscriber</span><span class='op'>|</span>
      <span class='const'>ProductMailer</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>product:</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='label'>subscriber:</span> <span class='id identifier rubyid_subscriber'>subscriber</span>).<span class='id identifier rubyid_in_stock'>in_stock</span>.<span class='id identifier rubyid_deliver_later'>deliver_later</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>When you include a module in a class, any code inside the <code>included</code> block runs
as if it’s part of that class. At the same time, the methods defined in the
module become regular methods you can call on objects (instances) of that class.</p>

<p>Now that the code triggering the notification has been extracted into the
Notifications module, the Product model can be simplified to include the
Notifications module.</p>

<pre class="code ruby#3"><code class="ruby#3"># app/models/product.rb
class Product &lt; ApplicationRecord
  include Notifications

  has_one_attached :featured_image
  has_rich_text :description

  validates :name, presence: true
  validates :inventory_count, numericality: { greater_than_or_equal_to: 0 }
end
</code></pre>

<p>Concerns are a great way to organize features of your Rails application. As you
add more features to the Product, the class will become messy. Instead, we can
use Concerns to extract each feature out into a self-contained module like
<code>Product::Notifications</code> which contains all the functionality for handling
subscribers and how notifications are sent.</p>

<p>Extracting code into concerns also helps make features reusable. For example, we
could introduce a new model that also needs subscriber notifications. This
module could be used in multiple models to provide the same functionality.</p>

<h3>Unsubscribe Links</h3>

<p>A subscriber may want to unsubscribe at some point, so let&#39;s build that next.</p>

<p>First, we need a route for unsubscribing that will be the URL we include in
emails.</p>

<pre class="code ruby#6"><code class="ruby#6"># config/routes.rb
Rails.application.routes.draw do
  # ...
  resources :products do
    resources :subscribers, only: [ :create ]
  end
  resource :unsubscribe, only: [ :show ]
</code></pre>

<p>The unsubscribe route is added at the top level and uses the singular <code>resource</code> in order to handle routes like <code>/unsubscribe?token=xyz</code>.</p>

<p>Active Record has a feature called <code>generates_token_for</code> that can generate
unique tokens to find database records for different purposes. We can use this
for generating a unique unsubscribe token to use in the email&#39;s unsubscribe URL.</p>

<pre class="code ruby#4"><code class="ruby#4"># app/models/subscriber.rb
class Subscriber &lt; ApplicationRecord
  belongs_to :product
  generates_token_for :unsubscribe
end
</code></pre>

<p>Our controller will first look up the Subscriber record from the token in the
URL. Once the subscriber is found, it will destroy the record and redirect to
the homepage. Create <code>app/controllers/unsubscribes_controller.rb</code> and add the
following code:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/controllers/unsubscribes_controller.rb
</span><span class='kw'>class</span> <span class='const'>UnsubscribesController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='id identifier rubyid_allow_unauthenticated_access'>allow_unauthenticated_access</span>
  <span class='id identifier rubyid_before_action'>before_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_set_subscriber'>set_subscriber</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
    <span class='ivar'>@subscriber</span><span class='op'>&amp;.</span><span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_path'>root_path</span><span class='comma'>,</span> <span class='label'>notice:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unsubscribed successfully.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_set_subscriber'>set_subscriber</span>
      <span class='ivar'>@subscriber</span> <span class='op'>=</span> <span class='const'>Subscriber</span>.<span class='id identifier rubyid_find_by_token_for'>find_by_token_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_unsubscribe'>unsubscribe</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_token'>token</span>])
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Last but not least, let&#39;s add the unsubscribe link to our email templates.</p>

<p>In <code>app/views/product_mailer/in_stock.html.erb</code>, add a <code>link_to</code>:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/product_mailer/in_stock.html.erb %&gt;
&lt;h1&gt;Good news!&lt;/h1&gt;

&lt;p&gt;&lt;%= link_to @product.name, product_url(@product) %&gt; is back in stock.&lt;/p&gt;

&lt;%= link_to &quot;Unsubscribe&quot;, unsubscribe_url(token: params[:subscriber].generate_token_for(:unsubscribe)) %&gt;
</code></pre>

<p>In <code>app/views/product_mailer/in_stock.text.erb</code>, add the URL in plain text:</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/product_mailer/in_stock.text.erb %&gt;
Good news!

&lt;%= @product.name %&gt; is back in stock.
&lt;%= product_url(@product) %&gt;

Unsubscribe: &lt;%= unsubscribe_url(token: params[:subscriber].generate_token_for(:unsubscribe)) %&gt;
</code></pre>

<p>When the unsubscribe link is clicked, the subscriber record will be deleted from
the database. The controller also safely handles invalid or expired tokens
without raising any errors.</p>

<p>Use the Rails console to send another email and test the unsubscribe link in the
logs.</p>

<h2>Adding CSS &amp; JavaScript</h2>

<p>CSS &amp; JavaScript are core to building web applications, so let&#39;s learn how to
use them with Rails.</p>

<h3>Propshaft</h3>

<p>Rails&#39; asset pipeline is called Propshaft. It takes your CSS, JavaScript,
images, and other assets and serves them to your browser. In production,
Propshaft keeps track of each version of your assets so they can be cached to
make your pages faster. Check out the
<a href="asset_pipeline.html">Asset Pipeline guide</a> to learn more about how this works.</p>

<p>Let&#39;s modify <code>app/assets/stylesheets/application.css</code> and change our font to
sans-serif.</p>

<pre class="code css"><code class="css">/* app/assets/stylesheets/application.css */
body {
  font-family: Arial, Helvetica, sans-serif;
  padding: 1rem;
}

nav {
  justify-content: flex-end;
  display: flex;
  font-size: 0.875em;
  gap: 0.5rem;
  max-width: 1024px;
  margin: 0 auto;
  padding: 1rem;
}

nav a {
  display: inline-block;
}

main {
  max-width: 1024px;
  margin: 0 auto;
}

.alert,
.error {
  color: red;
}

.notice {
  color: green;
}

section.product {
  display: flex;
  gap: 1rem;
  flex-direction: row;
}

section.product img {
  border-radius: 8px;
  flex-basis: 50%;
  max-width: 50%;
}
</code></pre>

<p>Then we&#39;ll update <code>app/views/products/show.html.erb</code> to use these new styles.</p>

<pre class="code xml"><code class="xml">&lt;%# app/views/products/show.html.erb %&gt;
&lt;p&gt;&lt;%= link_to &quot;Back&quot;, products_path %&gt;&lt;/p&gt;

&lt;section class=&quot;product&quot;&gt;
  &lt;%= image_tag @product.featured_image if @product.featured_image.attached? %&gt;

  &lt;section class=&quot;product-info&quot;&gt;
    &lt;% cache @product do %&gt;
      &lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;
      &lt;%= @product.description %&gt;
    &lt;% end %&gt;

    &lt;%= render &quot;inventory&quot;, product: @product %&gt;

    &lt;% if authenticated? %&gt;
      &lt;%= link_to &quot;Edit&quot;, edit_product_path(@product) %&gt;
      &lt;%= button_to &quot;Delete&quot;, @product, method: :delete, data: { turbo_confirm: &quot;Are you sure?&quot; } %&gt;
    &lt;% end %&gt;
  &lt;/section&gt;
&lt;/section&gt;
</code></pre>

<p>Refresh your page and you&#39;ll see the CSS has been applied.</p>

<h3>Import Maps</h3>

<p>Rails uses import maps for JavaScript by default. This allows you to write
modern JavaScript modules with no build steps.</p>

<p>You can find the JavaScript pins in <code>config/importmap.rb</code>. This file maps the
JavaScript package names with the source file which is used to generate the
importmap tag in the browser.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/importmap.rb
</span><span class='comment'># Pin npm packages by running ./bin/importmap
</span>
<span class='id identifier rubyid_pin'>pin</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>application</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_pin'>pin</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@hotwired/turbo-rails</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>turbo.min.js</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_pin'>pin</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@hotwired/stimulus</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>stimulus.min.js</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_pin'>pin</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@hotwired/stimulus-loading</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>stimulus-loading.js</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_pin_all_from'>pin_all_from</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app/javascript/controllers</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>under:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>controllers</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_pin'>pin</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>trix</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_pin'>pin</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@rails/actiontext</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>actiontext.esm.js</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>TIP: Each pin maps a JavaScript package name (e.g., <code>&quot;@hotwired/turbo-rails&quot;</code>)
to a specific file or URL (e.g., <code>&quot;turbo.min.js&quot;</code>). <code>pin_all_from</code> maps all
files in a directory (e.g., <code>app/javascript/controllers</code>) to a namespace (e.g.,
<code>&quot;controllers&quot;</code>).</p>

<p>Import maps keep the setup clean and minimal, while still supporting modern
JavaScript features.</p>

<p>What are these JavaScript files already in our import map? They are a frontend
framework called Hotwire that Rails uses by default.</p>

<h3>Hotwire</h3>

<p>Hotwire is a JavaScript framework designed to take full advantage of server-side
generated HTML. It is comprised of 3 core components:</p>

<ol>
<li><a href="https://turbo.hotwired.dev/"><strong>Turbo</strong></a> handles navigation, form
submissions, page components, and updates without writing any custom
JavaScript.</li>
<li><a href="https://stimulus.hotwired.dev/"><strong>Stimulus</strong></a> provides a framework for when
you need custom JavaScript to add functionality to the page.</li>
<li><a href="https://native.hotwired.dev/"><strong>Native</strong></a> allows you to make hybrid mobile
apps by embedding your web app and progressively enhancing it with native
mobile features.</li>
</ol>

<p>We haven&#39;t written any JavaScript yet, but we have been using Hotwire on the
frontend. For instance, the form you created to add and edit a product was
powered by Turbo.</p>

<p>Learn more in the <a href="asset_pipeline.html">Asset Pipeline</a> and
<a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a>
guides.</p>

<h2>Testing</h2>

<p>Rails comes with a robust test suite. Let&#39;s write a test to ensure that the
correct number of emails are sent when a product is back in stock.</p>

<h3>Fixtures</h3>

<p>When you generate a model using Rails, it automatically creates a corresponding
fixture file in the <code>test/fixtures</code> directory.</p>

<p>Fixtures are predefined sets of data that populate your test database before
running tests. They allow you to define records with easy-to-remember names,
making it simple to access them in your tests.</p>

<p>This file will be empty by default - you need to populate it with fixtures for
your tests.</p>

<p>Let’s update the product fixtures file at <code>test/fixtures/products.yml</code> with the
following:</p>

<pre class="code yaml"><code class="yaml"># test/fixtures/products.yml
tshirt:
  name: T-Shirt
  inventory_count: 15
</code></pre>

<p>And for subscribers, let&#39;s add these two fixtures to
<code>test/fixtures/subscribers.yml</code>:</p>

<pre class="code yaml"><code class="yaml"># test/fixtures/subscribers.yml
david:
  product: tshirt
  email: david@example.org

chris:
  product: tshirt
  email: chris@example.org
</code></pre>

<p>You&#39;ll notice that we can reference the <code>Product</code> fixture by name here. Rails
associates this automatically for us in the database so we don&#39;t have to manage
record IDs and associations in tests.</p>

<p>These fixtures will be automatically inserted into the database when we run our
test suite.</p>

<h3>Testing Emails</h3>

<p>In <code>test/models/product_test.rb</code>, let&#39;s add a test:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># test/models/product_test.rb
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test_helper</span><span class='tstring_end'>&quot;</span></span>

<span class='kw'>class</span> <span class='const'>ProductTest</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/TestCase.html" title="ActiveSupport::TestCase (class)">TestCase</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="ActionMailer.html" title="ActionMailer (module)">ActionMailer</a></span><span class='op'>::</span><span class='const'><a href="ActionMailer/TestHelper.html" title="ActionMailer::TestHelper (module)">TestHelper</a></span>

  <span class='id identifier rubyid_test'>test</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sends email notifications when back in stock</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_product'>product</span> <span class='op'>=</span> <span class='id identifier rubyid_products'>products</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_tshirt'>tshirt</span>)

    <span class='comment'># Set product out of stock
</span>    <span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>inventory_count:</span> <span class='int'>0</span>)

    <span class='id identifier rubyid_assert_emails'>assert_emails</span> <span class='int'>2</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>inventory_count:</span> <span class='int'>99</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Let&#39;s break down what this test is doing.</p>

<p>First, we include the Action Mailer test helpers so we can monitor emails sent
during the test.</p>

<p>The <code>tshirt</code> fixture is loaded using the <code>products()</code> fixture helper and returns
the Active Record object for that record. Each fixture generates a helper in the
test suite to make it easy to reference fixtures by name since their database
IDs may be different each run.</p>

<p>Then we ensure the tshirt is out of stock by updating it&#39;s inventory to 0.</p>

<p>Next, we use <code>assert_emails</code> to ensure 2 emails were generated by the code
inside the block. To trigger the emails, we update the product&#39;s inventory count
inside the block. This triggers the <code>notify_subscribers</code> callback in the Product
model to send emails. Once that&#39;s done executing, <code>assert_emails</code> counts the
emails and ensures it matches the expected count.</p>

<p>We can run the test suite with <code>bin/rails test</code> or an individual test file by
passing the filename.</p>

<pre class="code bash"><code class="bash">$ bin/rails test test/models/product_test.rb
Running 1 tests in a single process (parallelization threshold is 50)
Run options: --seed 3556

# Running:

.

Finished in 0.343842s, 2.9083 runs/s, 5.8166 assertions/s.
1 runs, 2 assertions, 0 failures, 0 errors, 0 skips
</code></pre>

<p>Our test passes!</p>

<p>Rails also generated an example test for <code>ProductMailer</code> at
<code>test/mailers/product_mailer_test.rb</code>. Let&#39;s update it to make it also pass.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># test/mailers/product_mailer_test.rb
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test_helper</span><span class='tstring_end'>&quot;</span></span>

<span class='kw'>class</span> <span class='const'>ProductMailerTest</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionMailer.html" title="ActionMailer (module)">ActionMailer</a></span><span class='op'>::</span><span class='const'><a href="ActionMailer/TestCase.html" title="ActionMailer::TestCase (class)">TestCase</a></span>
  <span class='id identifier rubyid_test'>test</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>in_stock</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_mail'>mail</span> <span class='op'>=</span> <span class='const'>ProductMailer</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>product:</span> <span class='id identifier rubyid_products'>products</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_tshirt'>tshirt</span>)<span class='comma'>,</span> <span class='label'>subscriber:</span> <span class='id identifier rubyid_subscribers'>subscribers</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_david'>david</span>)).<span class='id identifier rubyid_in_stock'>in_stock</span>
    <span class='id identifier rubyid_assert_equal'>assert_equal</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>In stock</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_mail'>mail</span>.<span class='id identifier rubyid_subject'>subject</span>
    <span class='id identifier rubyid_assert_equal'>assert_equal</span> [ <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>david@example.org</span><span class='tstring_end'>&quot;</span></span> ]<span class='comma'>,</span> <span class='id identifier rubyid_mail'>mail</span>.<span class='id identifier rubyid_to'>to</span>
    <span class='id identifier rubyid_assert_equal'>assert_equal</span> [ <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>from@example.com</span><span class='tstring_end'>&quot;</span></span> ]<span class='comma'>,</span> <span class='id identifier rubyid_mail'>mail</span>.<span class='id identifier rubyid_from'>from</span>
    <span class='id identifier rubyid_assert_match'>assert_match</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Good news!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_mail'>mail</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_encoded'>encoded</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Let&#39;s run the entire test suite now and ensure all the tests pass.</p>

<pre class="code bash"><code class="bash">$ bin/rails test
Running 2 tests in a single process (parallelization threshold is 50)
Run options: --seed 16302

# Running:

..

Finished in 0.665856s, 3.0037 runs/s, 10.5128 assertions/s.
2 runs, 7 assertions, 0 failures, 0 errors, 0 skips
</code></pre>

<p>You can use this as a starting place to continue building out a test suite with
full coverage of the application features.</p>

<p>Learn more about <a href="testing.html">Testing Rails Applications</a></p>

<h2>Consistently Formatted Code with RuboCop</h2>

<p>When writing code we may sometimes use inconsistent formatting. Rails comes with
a linter called RuboCop that helps keep our code formatted consistently.</p>

<p>We can check our code for consistency by running:</p>

<pre class="code bash"><code class="bash">$ bin/rubocop
</code></pre>

<p>This will print out any offenses and tell you what they are.</p>

<pre class="code bash"><code class="bash">Inspecting 53 files
.....................................................

53 files inspected, no offenses detected
</code></pre>

<p>RuboCop can automatically fix offenses using the <code>--autocorrect</code> flag (or its short version <code>-a</code>).</p>

<pre class="code ruby"><code class="ruby"><span class='gvar'>$ </span><span class='id identifier rubyid_bin'>bin</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>rubocop -a</span></code></pre>

<h2>Security</h2>

<p>Rails includes the Brakeman gem for checking security issues with your
application - vulnerabilities that can lead to attacks such as session
hijacking, session fixation, or redirection.</p>

<p>Run <code>bin/brakeman</code> and it will analyze your application and output a report.</p>

<pre class="code bash"><code class="bash">$ bin/brakeman
Loading scanner...
...

== Overview ==

Controllers: 6
Models: 6
Templates: 15
Errors: 0
Security Warnings: 0

== Warning Types ==


No warnings found
</code></pre>

<p>Learn more about <a href="security.html">Securing Rails Applications</a></p>

<h2>Continuous Integration with GitHub Actions</h2>

<p>Rails apps generate a <code>.github</code> folder that includes a prewritten GitHub Actions
configuration that runs rubocop, brakeman, and our test suite.</p>

<p>When we push our code to a GitHub repository with GitHub Actions enabled, it
will automatically run these steps and report back success or failure for each.
This allows us to monitor our code changes for defects and issues and ensure
consistent quality for our work.</p>

<h2>Deploying to Production</h2>

<p>And now the fun part: let’s deploy your app.</p>

<p>Rails comes with a deployment tool called <a href="https://kamal-deploy.org">Kamal</a> that
we can use to deploy our application directly to a server. Kamal uses Docker
containers to run your application and deploy with zero downtime.</p>

<p>By default, Rails comes with a production-ready Dockerfile that Kamal will use
to build the Docker image, creating a containerized version of your application
with all its dependencies and configurations. This Dockerfile uses
<a href="https://github.com/basecamp/thruster">Thruster</a> to compress and serve assets
efficiently in production.</p>

<p>To deploy with Kamal, we need:</p>

<ul>
<li>A server running Ubuntu LTS with 1GB RAM or more. The server should run the
Ubuntu operating system with a Long-Term Support (LTS) version so it receives
regular security and bug fixes. Hetzner, DigitalOcean, and other hosting
services provide servers to get started.</li>
<li>A <a href="https://hub.docker.com">Docker Hub</a> account and access token. Docker Hub
stores the image of the application so it can be downloaded and run on the
server.</li>
</ul>

<p>On Docker Hub, <a href="https://hub.docker.com/repository/create">create a Repository</a>
for your application image. Use &quot;store&quot; as the name for the repository.</p>

<p>Open <code>config/deploy.yml</code> and replace <code>192.168.0.1</code> with your server&#39;s IP address
and <code>your-user</code> with your Docker Hub username.</p>

<pre class="code yaml"><code class="yaml"># config/deploy.yml
# Name of your application. Used to uniquely configure containers.
service: store

# Name of the container image.
image: your-user/store

# Deploy to these servers.
servers:
  web:
    - 192.168.0.1

# Credentials for your image host.
registry:
  # Specify the registry server, if you&#39;re not using Docker Hub
  # server: registry.digitalocean.com / ghcr.io / ...
  username: your-user
</code></pre>

<p>Under the <code>proxy:</code> section, you can add a domain to enable SSL for your
application too. Make sure your DNS record points to the server and Kamal will
use LetsEncrypt to issue an SSL certificate for the domain.</p>

<pre class="code yaml"><code class="yaml"># config/deploy.yml
proxy:
  ssl: true
  host: app.example.com
</code></pre>

<p><a href="https://app.docker.com/settings/personal-access-tokens/create">Create an access token</a>
with Read &amp; Write permissions on Docker&#39;s website so Kamal can push the Docker
image for your application.</p>

<p>Then export the access token in the terminal so Kamal can find it.</p>

<pre class="code bash"><code class="bash">export KAMAL_REGISTRY_PASSWORD=your-access-token
</code></pre>

<p>Run the following command to set up your server and deploy your application for
the first time.</p>

<pre class="code bash"><code class="bash">$ bin/kamal setup
</code></pre>

<p>Congratulations! Your new Rails application is live and in production!</p>

<p>To view your new Rails app in action, open your browser and enter your server&#39;s
IP address. You should see your store up and running.</p>

<p>After this, when you make changes to your app and want to push them to
production, you can run the following:</p>

<pre class="code bash"><code class="bash">$ bin/kamal deploy
</code></pre>

<h3>Adding a User to Production</h3>

<p>To create and edit products in production, we need a User record in the
production database.</p>

<p>You can use Kamal to open a production Rails console.</p>

<pre class="code bash"><code class="bash">$ bin/kamal console
</code></pre>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_store'>store</span>(<span class='id identifier rubyid_prod'>prod</span>)<span class='op'>&gt;</span> <span class='const'>User</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>email_address:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>you@example.org</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>password:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>s3cr3t</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>password_confirmation:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>s3cr3t</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>Now you can log in to production with this email and password and manage
products.</p>

<h3>Background Jobs using Solid Queue</h3>

<p>Background jobs allow you to run tasks asynchronously behind-the-scenes in a
separate process, preventing them from interrupting the user experience. Imagine
sending in stock emails to 10,000 recipients. It could take a while, so we can
offload that task to a background job to keep the Rails app responsive.</p>

<p>In development, Rails uses the <code>:async</code> queue adapter to process background jobs
with ActiveJob. Async stores pending jobs in memory but it will lose pending
jobs on restart. This is great for development, but not production.</p>

<p>To make background jobs more robust, Rails uses <code>solid_queue</code> for production
environments. Solid Queue stores jobs in the database and executes them in a
separate process.</p>

<p>Solid Queue is enabled for our production Kamal deployment using the
<code>SOLID_QUEUE_IN_PUMA: true</code> environment variable to <code>config/deploy.yml</code>. This
tells our web server, Puma, to start and stop the Solid Queue process
automatically.</p>

<p>When emails are sent with Action Mailer&#39;s <code>deliver_later</code>, these emails will be
sent to Active Job for sending in the background so they don&#39;t delay the HTTP
request. With Solid Queue in production, emails will be sent in the background,
automatically retried if they fail to send, and jobs are kept safe in the
database during restarts.</p>

<p><picture class="flowdiagram">
  <source srcset="images/getting_started/background_jobs_dark.jpg" media="(prefers-color-scheme:dark)">
  <img src="images/getting_started/background_jobs_light.jpg">
</picture></p>

<h2>What&#39;s Next?</h2>

<p>Congratulations on building and deploying your first Rails application!</p>

<p>Next, follow the <a href="sign_up_and_settings.html">Sign Up and Settings tutorial</a> to continue learning.</p>

<p>We also recommend learning more by reading other Ruby on Rails Guides:</p>

<ul>
<li><a href="active_record_basics.html">Active Record Basics</a></li>
<li><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></li>
<li><a href="testing.html">Testing Rails Applications</a></li>
<li><a href="debugging_rails_applications.html">Debugging Rails Applications</a></li>
<li><a href="security.html">Securing Rails Applications</a></li>
</ul>

<p>Happy building!</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>