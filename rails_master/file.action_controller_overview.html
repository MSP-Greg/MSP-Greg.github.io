<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Action Controller Overview &mdash; Rails main</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "action_controller_overview",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails main</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Action Controller Overview&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1>Action Controller Overview</h1>

<p>In this guide, you will learn how controllers work and how they fit into the request cycle in your application.</p>

<p>After reading this guide, you will know how to:</p>

<ul>
<li>Follow the flow of a request through a controller.</li>
<li>Access parameters passed to your controller.</li>
<li>Use Strong Parameters and permit values.</li>
<li>Store data in the cookie, the session, and the flash.</li>
<li>Work with action callbacks to execute code during request processing.</li>
<li>Use the Request and Response Objects.</li>
</ul>

<hr>

<h2>Introduction</h2>

<p>Action Controller is the C in the Model View Controller
(<a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">MVC</a>)
pattern. After the <a href="routing.html">router</a> has matched a controller to an
incoming request, the controller is responsible for processing the request and
generating the appropriate output.</p>

<p>For most conventional
<a href="https://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a>
applications, the controller will receive the request, fetch or save data from a
model, and use a view to create HTML output.</p>

<p>You can imagine that a controller sits between models and views. The controller
makes model data available to the view, so that the view can display that data
to the user. The controller also receives user input from the view and saves or
updates model data accordingly.</p>

<h2>Creating a Controller</h2>

<p>A controller is a Ruby class which inherits from <code>ApplicationController</code> and has
methods just like any other class. Once an incoming request is matched to a
controller by the router, <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> creates an instance of that controller class and
calls the method with the same name as the action.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ClientsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Given the above <code>ClientsController</code>, if a user goes to <code>/clients/new</code> in your
application to add a new client, Rails will create an instance of
<code>ClientsController</code> and call its <code>new</code> method. If the <code>new</code> method is empty, Rails
will automatically render the <code>new.html.erb</code> view by default.</p>

<p>NOTE: The <code>new</code> method is an instance method here, called on an instance of <code>ClientsController</code>. This should not be confused with the <code>new</code> class method (i.e., <code>ClientsController.new</code>).</p>

<p>In the <code>new</code> method, the controller would typically create an instance of the
<code>Client</code> model, and make it available as an instance variable called <code>@client</code>
in the view:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: All controllers inherit from <code>ApplicationController</code>, which in turn
inherits from
<a href="https://api.rubyonrails.org/classes/ActionController/Base.html"><a href="ActionController/Base.html" title="ActionController::Base (class)"><code>::ActionController::Base</code></a></a>.
For <a href="https://guides.rubyonrails.org/api_app.html">API only</a> applications <code>ApplicationController</code> inherits from
<a href="https://edgeapi.rubyonrails.org/classes/ActionController/API.html"><a href="ActionController/API.html" title="ActionController::API (class)"><code>::ActionController::API</code></a></a>.</p>

<h3>Controller Naming Convention</h3>

<p>Rails favors making the resource in the controller&#39;s name plural. For example,
<code>ClientsController</code> is preferred over <code>ClientController</code> and
<code>SiteAdminsController</code> over <code>SiteAdminController</code> or <code>SitesAdminsController</code>.
However, the plural names are not strictly required (e.g.
<code>ApplicationController</code>).</p>

<p>Following this naming convention will allow you to use the <a href="routing.html#crud-verbs-and-actions">default route
generators</a> (e.g. <code>resources</code>) without
needing to qualify each with options such as
<a href="routing.html#specifying-a-controller-to-use"><code>:controller</code></a>. The convention
also makes named route helpers consistent throughout your application.</p>

<p>The controller naming convention is different from models. While plural names
are preferred for controller names, the singular form is preferred for <a href="active_record_basics.html#naming-conventions">model
names</a> (e.g. <code>Account</code> vs.
<code>Accounts</code>).</p>

<p>Controller actions should be <code>public</code>, as only <code>public</code> methods are callable as
actions. It is also best practice to lower the visibility of helper methods
(with <code>private</code> or <code>protected</code>) which are <em>not</em> intended to be actions.</p>

<p>WARNING: Some method names are reserved by Action Controller. Accidentally
redefining them could result in <code>SystemStackError</code>. If you limit your
controllers to only RESTful <a href="routing.html#resource-routing-the-rails-default">Resource Routing</a> actions you should not need to
worry about this.</p>

<p>NOTE: If you must use a reserved method as an action name, one workaround is to
use a custom route to map the reserved method name to your non-reserved action
method.</p>

<h2>Parameters</h2>

<p>Data sent by the incoming request is available in your controller in the
<a href="https://api.rubyonrails.org/classes/ActionController/StrongParameters.html#method-i-params"><code>params</code></a> hash. There are two types of parameter data:</p>

<ul>
<li>Query string parameters which are sent as part of the URL (for example, after
the <code>?</code> in <code>http://example.com/accounts?filter=free</code>).</li>
<li>POST parameters which are submitted from an HTML form.</li>
</ul>

<p>Rails does not make a distinction between query string parameters and POST
parameters; both are available in the <code>params</code> hash in your controller. For
example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ClientsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># This action receives query string parameters from an HTTP GET request
</span>  <span class='comment'># at the URL &quot;/clients?status=activated&quot;
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_status'>status</span>] <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>activated</span><span class='tstring_end'>&quot;</span></span>
      <span class='ivar'>@clients</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_activated'>activated</span>
    <span class='kw'>else</span>
      <span class='ivar'>@clients</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_inactivated'>inactivated</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># This action receives parameters from a POST request to &quot;/clients&quot; URL with  form data in the request body.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='ivar'>@client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_client'>client</span>])
    <span class='kw'>if</span> <span class='ivar'>@client</span>.<span class='id identifier rubyid_save'>save</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@client</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_render'>render</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: The <code>params</code> hash is not a plain old Ruby Hash; instead, it is an
<a href="https://api.rubyonrails.org/classes/ActionController/Parameters.html"><a href="ActionController/Parameters.html" title="ActionController::Parameters (class)"><code>::ActionController::Parameters</code></a></a> object. It does not inherit from Hash, but it behaves mostly like Hash.
It provides methods for filtering <code>params</code> and, unlike a Hash, keys <code>:foo</code> and <code>&quot;foo&quot;</code> are considered to be the same.</p>

<h3>Hash and Array Parameters</h3>

<p>The <code>params</code> hash is not limited to one-dimensional keys and values. It can
contain nested arrays and hashes. To send an array of values, append an empty
pair of square brackets <code>[]</code> to the key name:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>GET</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>users?ids[]=1&amp;ids[]=2&amp;ids[]=3</span></code></pre>

<p>NOTE: The actual URL in this example will be encoded as
<code>/users?ids%5b%5d=1&amp;ids%5b%5d=2&amp;ids%5b%5d=3</code> as the <code>[</code> and <code>]</code> characters are
not allowed in URLs. Most of the time you don&#39;t have to worry about this because
the browser will encode it for you, and Rails will decode it automatically, but
if you ever find yourself having to send those requests to the server manually
you should keep this in mind.</p>

<p>The value of <code>params[:ids]</code> will be the array <code>[&quot;1&quot;, &quot;2&quot;, &quot;3&quot;]</code>. Note that
parameter values are always strings; Rails does not attempt to guess or cast the
type.</p>

<p>NOTE: Values such as <code>[nil]</code> or <code>[nil, nil, ...]</code> in <code>params</code> are replaced with
<code>[]</code> for security reasons by default. See <a href="security.html#unsafe-query-generation">Security
Guide</a> for more information.</p>

<p>To send a hash, you include the key name inside the brackets:</p>

<pre class="code xml"><code class="xml">&lt;form accept-charset=&quot;UTF-8&quot; action=&quot;/users&quot; method=&quot;post&quot;&gt;
  &lt;input type=&quot;text&quot; name=&quot;user[name]&quot; value=&quot;Acme&quot; /&gt;
  &lt;input type=&quot;text&quot; name=&quot;user[phone]&quot; value=&quot;12345&quot; /&gt;
  &lt;input type=&quot;text&quot; name=&quot;user[address][postcode]&quot; value=&quot;12345&quot; /&gt;
  &lt;input type=&quot;text&quot; name=&quot;user[address][city]&quot; value=&quot;Carrot City&quot; /&gt;
&lt;/form&gt;
</code></pre>

<p>When this form is submitted, the value of <code>params[:user]</code> will be <code>{ &quot;name&quot; =&gt;
&quot;Acme&quot;, &quot;phone&quot; =&gt; &quot;12345&quot;, &quot;address&quot; =&gt; { &quot;postcode&quot; =&gt; &quot;12345&quot;, &quot;city&quot; =&gt;
&quot;Carrot City&quot; } }</code>. Note the nested hash in <code>params[:user][:address]</code>.</p>

<p>The <code>params</code> object acts like a Hash, but lets you use symbols and strings
interchangeably as keys.</p>

<h3>Composite Key Parameters</h3>

<p><a href="active_record_composite_primary_keys.html">Composite key parameters</a> contain
multiple values in one parameter separated by a delimiter (e.g., an underscore).
Therefore, you will need to extract each value so that you can pass them to
Active Record. You can use the <code>extract_value</code> method to do that.</p>

<p>For example, given the following controller:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>BooksController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
    <span class='comment'># Extract the composite ID value from URL parameters.
</span>    <span class='id identifier rubyid_id'>id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_extract_value'>extract_value</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>)
    <span class='ivar'>@book</span> <span class='op'>=</span> <span class='const'>Book</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_id'>id</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>And this route:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/books/:id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>books#show</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>When a user requests the URL <code>/books/4_2</code>, the controller will extract the
composite key value <code>[&quot;4&quot;, &quot;2&quot;]</code> and pass it to <code>Book.find</code>. The <code>extract_value</code>
method may be used to extract arrays out of any delimited parameters.</p>

<h3>JSON Parameters</h3>

<p>If your application exposes an API, you will likely accept parameters in JSON
format. If the <code>content-type</code> header of your request is set to
<code>application/json</code>, Rails will automatically load your parameters into the
<code>params</code> hash, which you can access as you would normally.</p>

<p>So for example, if you are sending this JSON content:</p>

<pre class="code json"><code class="json">{ &quot;user&quot;: { &quot;name&quot;: &quot;acme&quot;, &quot;address&quot;: &quot;123 Carrot Street&quot; } }
</code></pre>

<p>Your controller will receive:</p>

<pre class="code ruby"><code class="ruby">{ <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>acme</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>address</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>123 Carrot Street</span><span class='tstring_end'>&quot;</span></span> } }</code></pre>

<h4>Configuring Wrap Parameters</h4>

<p>You can use <a href="https://api.rubyonrails.org/classes/ActionController/ParamsWrapper/Options/ClassMethods.html#method-i-wrap_parameters">Wrap Parameters</a>, which automatically add the controller name to
JSON parameters. For example, you can send the below JSON without a root <code>:user</code>
key prefix:</p>

<pre class="code json"><code class="json">{ &quot;name&quot;: &quot;acme&quot;, &quot;address&quot;: &quot;123 Carrot Street&quot; }
</code></pre>

<p>Assuming that you&#39;re sending the above data to the <code>UsersController</code>, the JSON
will be wrapped within the <code>:user</code> key like this:</p>

<pre class="code ruby"><code class="ruby">{ <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>acme</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>address:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>123 Carrot Street</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>user:</span> { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>acme</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>address:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>123 Carrot Street</span><span class='tstring_end'>&quot;</span></span> } }</code></pre>

<p>NOTE: Wrap Parameters adds a clone of the parameters to the hash within a key
that is the same as the controller name. As a result, both the original version
of the parameters and the &quot;wrapped&quot; version of the parameters will exist in the
params hash.</p>

<p>This feature clones and wraps parameters with a key chosen based on your
controller&#39;s name. It is configured to <code>true</code> by default. If you do not want to
wrap parameters you can
<a href="configuring.html#config-action-controller-wrap-parameters-by-default">configure</a>
it to <code>false</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_controller'>action_controller</span>.<span class='id identifier rubyid_wrap_parameters_by_default'>wrap_parameters_by_default</span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>

<p>You can also customize the name of the key or specific parameters you want to
wrap, see the <a href="https://api.rubyonrails.org/classes/ActionController/ParamsWrapper.html">API
documentation</a>
for more.</p>

<h3>Routing Parameters</h3>

<p>Parameters specified as part of a route declaration in the <code>routes.rb</code> file are
also made available in the <code>params</code> hash. For example, we can add a route that
captures the <code>:status</code> parameter for a client:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/clients/:status</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>clients#index</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>foo:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>When a user navigates to <code>/clients/active</code> URL, <code>params[:status]</code> will be set to
&quot;active&quot;. When this route is used, <code>params[:foo]</code> will also be set to &quot;bar&quot;, as
if it were passed in the query string.</p>

<p>Any other parameters defined by the route declaration, such as <code>:id</code>, will also
be available.</p>

<p>NOTE: In the above example, your controller will also receive <code>params[:action]</code>
as &quot;index&quot; and <code>params[:controller]</code> as &quot;clients&quot;. The <code>params</code> hash will always
contain the <code>:controller</code> and <code>:action</code> keys, but it&#39;s recommended to use the
methods <a href="https://api.rubyonrails.org/classes/ActionController/Metal.html#method-i-controller_name"><code>controller_name</code></a> and <a href="https://api.rubyonrails.org/classes/AbstractController/Base.html#method-i-action_name"><code>action_name</code></a> instead to access these
values.</p>

<h3>The <code>default_url_options</code> Method</h3>

<p>You can set global default parameters for <a href="https://api.rubyonrails.org/classes/ActionView/RoutingUrlFor.html#method-i-url_for"><code>url_for</code></a>
by defining a method called <code>default_url_options</code> in your controller. For
example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_default_url_options'>default_url_options</span>
    { <span class='label'>locale:</span> <span class='const'><a href="I18n.html" title="I18n (module)">I18n</a></span>.<span class='id identifier rubyid_locale'>locale</span> }
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The specified defaults will be used as a starting point when generating URLs.
They can be overridden by the options passed to <code>url_for</code> or any path helper
such as <code>posts_path</code>. For example, by setting <code>locale: I18n.locale</code>, Rails will
automatically add the locale to every URL:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_posts_path'>posts_path</span> <span class='comment'># =&gt; &quot;/posts?locale=en&quot;</span></code></pre>

<p>You can still override this default if needed:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_posts_path'>posts_path</span>(<span class='label'>locale:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_fr'>fr</span>) <span class='comment'># =&gt; &quot;/posts?locale=fr&quot;</span></code></pre>

<p>NOTE: Under the hood, <code>posts_path</code> is a shorthand for calling <code>url_for</code> with the
appropriate parameters.</p>

<p>If you define <code>default_url_options</code> in <code>ApplicationController</code>, as in the
example above, these defaults will be used for all URL generation. The method
can also be defined in a specific controller, in which case it only applies to
URLs generated for that controller.</p>

<p>In a given request, the method is not actually called for every single generated
URL. For performance reasons the returned hash is cached per request.</p>

<h2>Strong Parameters</h2>

<p>With Action Controller <a href="https://api.rubyonrails.org/classes/ActionController/StrongParameters.html">Strong
Parameters</a>,
parameters cannot be used in Active Model mass assignments until they have been
explicitly permitted. This means you will need to decide which attributes to
permit for mass update and declare them in the controller. This is a security
practice to prevent users from accidentally updating sensitive model attributes.</p>

<p>In addition, parameters can be marked as required and the request will result in
a 400 Bad Request being returned if not all required parameters are passed in.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>PeopleController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='comment'># This will raise an ActiveModel::ForbiddenAttributesError
</span>  <span class='comment'># because it&#39;s using mass assignment without an explicit permit.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='const'>Person</span>.<span class='id identifier rubyid_create'>create</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_person'>person</span>])
  <span class='kw'>end</span>

  <span class='comment'># This will work as we are using `person_params` helper method, which has the
</span>  <span class='comment'># call to `expect` to allow mass assignment.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_update'>update</span>
    <span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])
    <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_update!'>update!</span>(<span class='id identifier rubyid_person_params'>person_params</span>)
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_person'>person</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># Using a private method to encapsulate the permitted parameters is a good
</span>    <span class='comment'># pattern. You can use the same list for both create and update.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_person_params'>person_params</span>
      <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_expect'>expect</span>(<span class='label'>person:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span>])
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Permitting Values</h3>

<h4><code>expect</code></h4>

<p>The <a href="https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-expect"><code>expect</code></a> method provides a concise and safe way to require and permit
parameters.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_id'>id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_expect'>expect</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>)</code></pre>

<p>The above <code>expect</code> will always return a scalar value and not an array or hash.
Another example is form params, you can use <code>expect</code> to ensure that the root key
is present and the attributes are permitted.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_user_params'>user_params</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_expect'>expect</span>(<span class='label'>user:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_password'>password</span>])
<span class='id identifier rubyid_user_params'>user_params</span>.<span class='id identifier rubyid_has_key?'>has_key?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_username'>username</span>) <span class='comment'># =&gt; true</span></code></pre>

<p>In the above example, if the <code>:user</code> key is not a nested hash with the specified
keys, <code>expect</code> will raise an error and return a 400 Bad Request response.</p>

<p>To require and permit an entire hash of parameters, <a href="https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-expect"><code>expect</code></a> can be used in
this way.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_expect'>expect</span>(<span class='label'>log_entry:</span> {})</code></pre>

<p>This marks the <code>:log_entry</code> parameters hash and any sub-hash of it as permitted
and does not check for permitted scalars, anything is accepted.</p>

<p>WARNING: Extreme care should be taken when calling <code>expect</code> with an empty
hash, as it will allow all current and future model attributes to be
mass-assigned.</p>

<h4><code>permit</code></h4>

<p>Calling <a href="https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-permit"><code>permit</code></a> allows the specified key in <code>params</code> (<code>:id</code> or <code>:admin</code>
below) for inclusion in mass assignment (e.g. via <code>create</code> or <code>update</code>):</p>

<pre class="code irb"><code class="irb">params = ActionController::Parameters.new(id: 1, admin: &quot;true&quot;)
=&gt; #&lt;ActionController::Parameters {&quot;id&quot;=&gt;1, &quot;admin&quot;=&gt;&quot;true&quot;} permitted: false&gt;
params.permit(:id)
=&gt; #&lt;ActionController::Parameters {&quot;id&quot;=&gt;1} permitted: true&gt;
params.permit(:id, :admin)
=&gt; #&lt;ActionController::Parameters {&quot;id&quot;=&gt;1, &quot;admin&quot;=&gt;&quot;true&quot;} permitted: true&gt;
</code></pre>

<p>For the permitted key <code>:id</code>, its value also needs to be one of these permitted
scalar values: <a href="String.html" title="String (class)"><code>String</code></a>, <a href="Symbol.html" title="Symbol (class)"><code>Symbol</code></a>, <a href="NilClass.html" title="NilClass (class)"><code>NilClass</code></a>, <a href="Numeric.html" title="Numeric (class)"><code>Numeric</code></a>, <a href="TrueClass.html" title="TrueClass (class)"><code>TrueClass</code></a>,
<a href="FalseClass.html" title="FalseClass (class)"><code>FalseClass</code></a>, <a href="Date.html" title="Date (class)"><code>Date</code></a>, <a href="Time.html" title="Time (class)"><code>Time</code></a>, <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a>, <code>StringIO</code>, <a href="IO.html" title="IO (class)"><code>IO</code></a>,
<a href="ActionDispatch/Http/UploadedFile.html" title="ActionDispatch::Http::UploadedFile (class)"><code>::ActionDispatch::Http::UploadedFile</code></a>, and <code>Rack::Test::UploadedFile</code>.</p>

<p>If you have not called <code>permit</code> on the key, it will be filtered out. Arrays,
hashes, or any other objects are not injected by default.</p>

<p>To include a value in <code>params</code> that&#39;s an array of one of the permitted scalar
values, you can map the key to an empty array like this:</p>

<pre class="code irb"><code class="irb">params = ActionController::Parameters.new(tags: [&quot;rails&quot;, &quot;parameters&quot;])
=&gt; #&lt;ActionController::Parameters {&quot;tags&quot;=&gt;[&quot;rails&quot;, &quot;parameters&quot;]} permitted: false&gt;
params.permit(tags: [])
=&gt; #&lt;ActionController::Parameters {&quot;tags&quot;=&gt;[&quot;rails&quot;, &quot;parameters&quot;]} permitted: true&gt;
</code></pre>

<p>To include hash values, you can map to an empty hash:</p>

<pre class="code irb"><code class="irb">params = ActionController::Parameters.new(options: { darkmode: true })
=&gt; #&lt;ActionController::Parameters {&quot;options&quot;=&gt;{&quot;darkmode&quot;=&gt;true}} permitted: false&gt;
params.permit(options: {})
=&gt; #&lt;ActionController::Parameters {&quot;options&quot;=&gt;#&lt;ActionController::Parameters {&quot;darkmode&quot;=&gt;true} permitted: true&gt;} permitted: true&gt;
</code></pre>

<p>The above <code>permit</code> call ensures that values in <code>options</code> are permitted scalars
and filters out anything else.</p>

<p>WARNING: The <code>permit</code> with an empty hash is convenient since sometimes it is not
possible or convenient to declare each valid key of a hash parameter or its
internal structure. But note that the above <code>permit</code> with an empty hash opens
the door to arbitrary input.</p>

<h4><code>permit!</code></h4>

<p>There is also <a href="https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-permit-21"><code>permit!</code></a> (with an <code>!</code>) which permits an entire hash of
parameters without checking the values.</p>

<pre class="code irb"><code class="irb">params = ActionController::Parameters.new(id: 1, admin: &quot;true&quot;)
=&gt; #&lt;ActionController::Parameters {&quot;id&quot;=&gt;1, &quot;admin&quot;=&gt;&quot;true&quot;} permitted: false&gt;
params.permit!
=&gt; #&lt;ActionController::Parameters {&quot;id&quot;=&gt;1, &quot;admin&quot;=&gt;&quot;true&quot;} permitted: true&gt;
</code></pre>

<p>WARNING: Extreme care should be taken when using <code>permit!</code>, as it will allow all
current and <em>future</em> model attributes to be mass-assigned.</p>

<h3>Nested Parameters</h3>

<p>You can also use <code>expect</code> (or <code>permit</code>) on nested parameters, like:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Given the example expected params:
</span><span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Parameters.html" title="ActionController::Parameters (class)">Parameters</a></span>.<span class='id identifier rubyid_new'><a href="ActionController/Parameters.html#new-class_method" title="ActionController::Parameters.new (method)">new</a></span>(
  <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Martin</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>emails:</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>me@example.com</span><span class='tstring_end'>&quot;</span></span>]<span class='comma'>,</span>
  <span class='label'>friends:</span> [
    { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>André</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>family:</span> { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RubyGems</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> <span class='label'>hobbies:</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>keyboards</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>card games</span><span class='tstring_end'>&quot;</span></span>] }<span class='comma'>,</span>
    { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Kewe</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>family:</span> { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Baroness</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> <span class='label'>hobbies:</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>video games</span><span class='tstring_end'>&quot;</span></span>] }<span class='comma'>,</span>
  ]
)
<span class='comment'># the following expect will ensure the params are permitted
</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_emails'>emails</span><span class='comma'>,</span> <span class='id identifier rubyid_friends'>friends</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_expect'>expect</span>(
  <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>                 <span class='comment'># permitted scalar
</span>  <span class='label'>emails:</span> []<span class='comma'>,</span>            <span class='comment'># array of permitted scalars
</span>  <span class='label'>friends:</span> [[            <span class='comment'># array of permitted Parameter hashes
</span>    <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>               <span class='comment'># permitted scalar
</span>    <span class='label'>family:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>]<span class='comma'>,</span>     <span class='comment'># family: { name: &quot;permitted scalar&quot; }
</span>    <span class='label'>hobbies:</span> []          <span class='comment'># array of permitted scalars
</span>  ]]
)</code></pre>

<p>This declaration permits the <code>name</code>, <code>emails</code>, and <code>friends</code> attributes and
returns them each. It is expected that <code>emails</code> will be an array of permitted
scalar values, and that <code>friends</code> will be an array of resources (note the new
double array syntax to explicitly require an array) with specific attributes.
These attributes should have a <code>name</code> attribute (any permitted scalar values allowed), a
<code>hobbies</code> attribute as an array of permitted scalar values, and a <code>family</code>
attribute which is restricted to a hash with only a <code>name</code> key and any permitted
scalar value.</p>

<h3>Examples</h3>

<p>Here are some examples of how to use <code>permit</code> for different use cases.</p>

<p><strong>Example 1</strong>: You may want to use the permitted attributes in your <code>new</code> action.
This raises the problem that you can&#39;t use <a href="https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-require"><code>require</code></a> on the root key
because, normally, it does not exist when calling <code>new</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># using `fetch` you can supply a default and use
</span><span class='comment'># the Strong Parameters API from there.
</span><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_blog'>blog</span><span class='comma'>,</span> {}).<span class='id identifier rubyid_permit'>permit</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>)</code></pre>

<p><strong>Example 2</strong>: The model class method <code>accepts_nested_attributes_for</code> allows you to
update and destroy associated records. This is based on the <code>id</code> and <code>_destroy</code>
parameters:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># permit :id and :_destroy
</span><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_expect'>expect</span>(<span class='label'>author:</span> [ <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>books_attributes:</span> [[ <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid__destroy'>_destroy</span> ]] ])</code></pre>

<p><strong>Example 3</strong>: Hashes with integer keys are treated differently, and you can declare
the attributes as if they were direct children. You get these kinds of
parameters when you use <code>accepts_nested_attributes_for</code> in combination with a
<code>has_many</code> association:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># To permit the following data:
</span><span class='comment'># {&quot;book&quot; =&gt; {&quot;title&quot; =&gt; &quot;Some Book&quot;,
</span><span class='comment'>#             &quot;chapters_attributes&quot; =&gt; { &quot;1&quot; =&gt; {&quot;title&quot; =&gt; &quot;First Chapter&quot;},
</span><span class='comment'>#                                        &quot;2&quot; =&gt; {&quot;title&quot; =&gt; &quot;Second Chapter&quot;}}}}
</span>
<span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_expect'>expect</span>(<span class='label'>book:</span> [ <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='label'>chapters_attributes:</span> [[ <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span> ]] ])</code></pre>

<p><strong>Example 4</strong>: Imagine a scenario where you have parameters representing a product
name, and a hash of arbitrary data associated with that product, and you want to
permit the product name attribute and also the whole data hash:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_product_params'>product_params</span>
  <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_expect'>expect</span>(<span class='label'>product:</span> [ <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>data:</span> {} ])
<span class='kw'>end</span></code></pre>

<h2>Cookies</h2>

<p>The concept of a cookie is not specific to Rails. A
<a href="https://en.wikipedia.org/wiki/HTTP_cookie">cookie</a> (also known as an HTTP
cookie or a web cookie) is a small piece of data from the server that is saved
in the user&#39;s browser. The browser may store cookies, create new cookies, modify
existing ones, and send them back to the server with later requests. Cookies
persist data across web requests and therefore enable web applications to
remember user preferences.</p>

<p>Rails provides an easy way to access cookies via the <a href="https://api.rubyonrails.org/classes/ActionController/Cookies.html#method-i-cookies"><code>cookies</code></a> method, which
works like a hash:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CommentsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>
    <span class='comment'># Auto-fill the commenter&#39;s name if it has been stored in a cookie
</span>    <span class='ivar'>@comment</span> <span class='op'>=</span> <span class='const'>Comment</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>author:</span> <span class='id identifier rubyid_cookies'>cookies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_commenter_name'>commenter_name</span>])
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='ivar'>@comment</span> <span class='op'>=</span> <span class='const'>Comment</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_comment_params'>comment_params</span>)
    <span class='kw'>if</span> <span class='ivar'>@comment</span>.<span class='id identifier rubyid_save'>save</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_remember_name'>remember_name</span>]
        <span class='comment'># Save the commenter&#39;s name in a cookie.
</span>        <span class='id identifier rubyid_cookies'>cookies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_commenter_name'>commenter_name</span>] <span class='op'>=</span> <span class='ivar'>@comment</span>.<span class='id identifier rubyid_author'>author</span>
      <span class='kw'>else</span>
        <span class='comment'># Delete cookie for the commenter&#39;s name, if any.
</span>        <span class='id identifier rubyid_cookies'>cookies</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_commenter_name'>commenter_name</span>)
      <span class='kw'>end</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@comment</span>.<span class='id identifier rubyid_article'>article</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_render'>render</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: To delete a cookie, you need to use <code>cookies.delete(:key)</code>. Setting the
<code>key</code> to a <code>nil</code> value does not delete the cookie.</p>

<p>When passed a scalar value, the cookie will be deleted when the user closes their browser.
If you want the cookie to expire at a specific time, pass a hash with the <code>:expires</code> option when setting the cookie.
For example, to set a cookie that expires in 1 hour:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_cookies'>cookies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_login'>login</span>] <span class='op'>=</span> { <span class='label'>value:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>XJ-122</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>expires:</span> <span class='int'>1</span>.<span class='id identifier rubyid_hour'>hour</span> }</code></pre>

<p>If you want to create cookies that never expire use the permanent cookie jar.
This sets the assigned cookies to have an expiration date 20 years from now.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_cookies'>cookies</span>.<span class='id identifier rubyid_permanent'>permanent</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_locale'>locale</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fr</span><span class='tstring_end'>&quot;</span></span></code></pre>

<h3>Encrypted and Signed Cookies</h3>

<p>Since cookies are stored on the client browser, they can be susceptible to
tampering and are not considered secure for storing sensitive data. Rails
provides a signed cookie jar and an encrypted cookie jar for storing sensitive
data. The signed cookie jar appends a cryptographic signature on the cookie
values to protect their integrity. The encrypted cookie jar encrypts the values
in addition to signing them, so that they cannot be read by the user.</p>

<p>Refer to the <a href="https://api.rubyonrails.org/classes/ActionDispatch/Cookies.html">API
documentation</a>
for more details.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CookiesController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_set_cookie'>set_cookie</span>
    <span class='id identifier rubyid_cookies'>cookies</span>.<span class='id identifier rubyid_signed'>signed</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user_id'>user_id</span>] <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span>.<span class='id identifier rubyid_id'>id</span>
    <span class='id identifier rubyid_cookies'>cookies</span>.<span class='id identifier rubyid_encrypted'>encrypted</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_expiration_date'>expiration_date</span>] <span class='op'>=</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span>.<span class='id identifier rubyid_tomorrow'><a href="Date.html#tomorrow-class_method" title="Date.tomorrow (method)">tomorrow</a></span> <span class='comment'># =&gt; Thu, 20 Mar 2024
</span>    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>read_cookie</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_read_cookie'>read_cookie</span>
    <span class='id identifier rubyid_cookies'>cookies</span>.<span class='id identifier rubyid_encrypted'>encrypted</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_expiration_date'>expiration_date</span>] <span class='comment'># =&gt; &quot;2024-03-20&quot;
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>These special cookie jars use a serializer to serialize the cookie values into
strings and deserialize them into Ruby objects when read back. You can specify
which serializer to use via <a href="configuring.html#config-action-dispatch-cookies-serializer"><code>config.action_dispatch.cookies_serializer</code></a>. The
default serializer for new applications is <code>:json</code>.</p>

<p>NOTE: Be aware that JSON has limited support serializing Ruby objects such as
<a href="Date.html" title="Date (class)"><code>Date</code></a>, <a href="Time.html" title="Time (class)"><code>Time</code></a>, and <a href="Symbol.html" title="Symbol (class)"><code>Symbol</code></a>. These will be serialized and deserialized into
<a href="String.html" title="String (class)"><code>String</code></a>s.</p>

<p>If you need to store these or more complex objects, you may need to manually
convert their values when reading them in subsequent requests.</p>

<p>If you use the cookie session store, the above applies to the <code>session</code> and
<code>flash</code> hash as well.</p>

<h2>Session</h2>

<p>While cookies are stored client-side, session data is stored server-side (in
memory, a database, or a cache), and the duration is usually temporary and tied
to the user&#39;s session (e.g. until they close the browser). An example use case
for session is storing sensitive data like user authentication.</p>

<p>In a Rails application, the session is available in the controller and the view.</p>

<h3>Working with the Session</h3>

<p>You can use the <code>session</code> instance method to access the session in your
controllers. Session values are stored as key/value pairs like a hash:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># Look up the key `:current_user_id` in the session and use it to
</span>    <span class='comment'># find the current {User}. This is a common way to handle user login in
</span>    <span class='comment'># a Rails application; logging in sets the session value and
</span>    <span class='comment'># logging out removes it.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_current_user'>current_user</span>
      <span class='ivar'>@current_user</span> <span class='op'>||=</span> <span class='const'>User</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>id:</span> <span class='id identifier rubyid_session'>session</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_current_user_id'>current_user_id</span>]) <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_current_user_id'>current_user_id</span>]
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>To store something in the session, you can assign it to a key similar to adding
a value to a hash. After a user is authenticated, its <code>id</code> is saved in the
session to be used for subsequent requests:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>SessionsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_authenticate_by'>authenticate_by</span>(<span class='label'>email:</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span>]<span class='comma'>,</span> <span class='label'>password:</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_password'>password</span>])
      <span class='comment'># Save the user ID in the session so it can be used in
</span>      <span class='comment'># subsequent requests
</span>      <span class='id identifier rubyid_session'>session</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_current_user_id'>current_user_id</span>] <span class='op'>=</span> <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_id'>id</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>To remove something from the session, delete the key/value pair. Deleting the
<code>current_user_id</code> key from the session is a typical way to log the user out:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>SessionsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_current_user_id'>current_user_id</span>)
    <span class='comment'># Clear the current user as well.
</span>    <span class='ivar'>@current_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_see_other'>see_other</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>It is possible to reset the entire session with <a href="https://api.rubyonrails.org/classes/ActionController/Metal.html#method-i-reset_session"><code>reset_session</code></a>. It is
recommended to use <code>reset_session</code> after logging in to avoid session fixation
attacks. Please refer to the <a href="https://edgeguides.rubyonrails.org/security.html#session-fixation-countermeasures">Security
Guide</a>
for details.</p>

<p>NOTE: Sessions are lazily loaded. If you don&#39;t access sessions in your action&#39;s
code, they will not be loaded. Hence, you will never need to disable sessions -
not accessing them will do the job.</p>

<h3>The Flash</h3>

<p>The <a href="https://api.rubyonrails.org/classes/ActionDispatch/Flash.html">flash</a>
provides a way to pass temporary data between controller actions. Anything you
place in the flash will be available to the very next action and then cleared.
The flash is typically used for setting messages (e.g. notices and alerts) in a
controller action before redirecting to an action that displays the message to
the user.</p>

<p>The flash is accessed via the <a href="https://api.rubyonrails.org/classes/ActionDispatch/Flash/RequestMethods.html#method-i-flash"><code>flash</code></a> method. Similar to the session, the
flash values are stored as key/value pairs.</p>

<p>For example, in the controller action for logging out a user, the controller can
set a flash message which can be displayed to the user on the next request:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>SessionsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_current_user_id'>current_user_id</span>)
    <span class='id identifier rubyid_flash'>flash</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_notice'>notice</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You have successfully logged out.</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_see_other'>see_other</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Displaying a message after a user performs some interactive action in your
application is a good practice to give the user feedback that their action was
successful (or that there were errors).</p>

<p>In addition to <code>:notice</code>, you can also use <code>:alert</code>. These are typically styled
(using CSS) with different colors to indicate their meaning (e.g. green for
notices and orange/red for alerts).</p>

<p>You can also assign a flash message directly within the <code>redirect_to</code> method by
including it as a parameter to <code>redirect_to</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span><span class='comma'>,</span> <span class='label'>notice:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You have successfully logged out.</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span><span class='comma'>,</span> <span class='label'>alert:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>There was an issue.</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>You&#39;re not limited to <code>notice</code> and <code>alert</code>.
You can set any key in a flash (similar to sessions), by assigning it to the <code>:flash</code> argument.
For example, assigning <code>:just_signed_up</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span><span class='comma'>,</span> <span class='label'>flash:</span> { <span class='label'>just_signed_up:</span> <span class='kw'>true</span> }</code></pre>

<p>This will allow you to have the below in the view:</p>

<pre class="code xml"><code class="xml">&lt;% if flash[:just_signed_up] %&gt;
  &lt;p class=&quot;welcome&quot;&gt;Welcome to our site!&lt;/p&gt;
&lt;% end %&gt;
</code></pre>

<p>In the above logout example, the <code>destroy</code> action redirects to the application&#39;s
<code>root_url</code>, where the message is available to be displayed. However, it&#39;s not
displayed automatically. It&#39;s up to the next action to decide what, if anything,
it will do with what the previous action put in the flash.</p>

<h4>Displaying flash messages</h4>

<p>If a previous action <em>has</em> set a flash message, it&#39;s a good idea to display that
to the user. We can accomplish this consistently by adding the HTML for
displaying any flash messages in the application&#39;s default layout. Here&#39;s an
example from <code>app/views/layouts/application.html.erb</code>:</p>

<pre class="code xml"><code class="xml">&lt;html&gt;
  &lt;!-- &lt;head/&gt; --&gt;
  &lt;body&gt;
    &lt;% flash.each do |name, msg| -%&gt;
      &lt;%= content_tag :div, msg, class: name %&gt;
    &lt;% end -%&gt;

    &lt;!-- more content --&gt;
    &lt;%= yield %&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>The <code>name</code> above indicates the type of flash message, such as <code>notice</code> or
<code>alert</code>. This information is normally used to style how the message is displayed
to the user.</p>

<p>TIP: You can filter by <code>name</code> if you want to limit to displaying only <code>notice</code>
and <code>alert</code> in layout. Otherwise, all keys set in the <code>flash</code> will be displayed.</p>

<p>Including the reading and displaying of flash messages in the layout ensures
that your application will display these automatically, without each view having
to include logic to read the flash.</p>

<h4><code>flash.keep</code> and <code>flash.now</code></h4>

<p><a href="https://api.rubyonrails.org/classes/ActionDispatch/Flash/FlashHash.html#method-i-keep"><code>flash.keep</code></a> is used to carry over the flash value through to an additional
request. This is useful when there are multiple redirects.</p>

<p>For example, assume that the <code>index</code> action in the controller below corresponds
to the <code>root_url</code>. And you want all requests here to be redirected to
<code>UsersController#index</code>. If an action sets the flash and redirects to
<code>MainController#index</code>, those flash values will be lost when another redirect
happens, unless you use <code>flash.keep</code> to make the values persist for another
request.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MainController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
    <span class='comment'># Will persist all flash values.
</span>    <span class='id identifier rubyid_flash'>flash</span>.<span class='id identifier rubyid_keep'>keep</span>

    <span class='comment'># You can also use a key to keep only some kind of value.
</span>    <span class='comment'># flash.keep(:notice)
</span>    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_users_url'>users_url</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p><a href="https://api.rubyonrails.org/classes/ActionDispatch/Flash/FlashHash.html#method-i-now"><code>flash.now</code></a> is used to make the flash values available in the same request.
By default, adding values to the flash will make them available to the next
request. For example, if the <code>create</code> action fails to save a resource, and you
render the <code>new</code> template directly, that&#39;s not going to result in a new request,
but you may still want to display a message using the flash. To do this, you can
use <a href="https://api.rubyonrails.org/classes/ActionDispatch/Flash/FlashHash.html#method-i-now"><code>flash.now</code></a> in the same way you use the normal <code>flash</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ClientsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='ivar'>@client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_client_params'>client_params</span>)
    <span class='kw'>if</span> <span class='ivar'>@client</span>.<span class='id identifier rubyid_save'>save</span>
      <span class='comment'># ...
</span>    <span class='kw'>else</span>
      <span class='id identifier rubyid_flash'>flash</span>.<span class='id identifier rubyid_now'>now</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Could not save client</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_render'>render</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Session Stores</h3>

<p>All sessions have a unique ID that represents the session object; these session
IDs are stored in a cookie. The actual session objects use one of the following
storage mechanisms:</p>

<ul>
<li><a href="https://api.rubyonrails.org/classes/ActionDispatch/Session/CookieStore.html"><a href="ActionDispatch/Session/CookieStore.html" title="ActionDispatch::Session::CookieStore (class)"><code>::ActionDispatch::Session::CookieStore</code></a></a> - Stores everything on the client.</li>
<li><a href="https://api.rubyonrails.org/classes/ActionDispatch/Session/CacheStore.html"><a href="ActionDispatch/Session/CacheStore.html" title="ActionDispatch::Session::CacheStore (class)"><code>::ActionDispatch::Session::CacheStore</code></a></a> - Stores the data in the Rails
cache.</li>
<li><a href="https://github.com/rails/activerecord-session_store"><code>ActionDispatch::Session::ActiveRecordStore</code></a> -
Stores the data in a database using Active Record (requires the
<a href="https://github.com/rails/activerecord-session_store"><code>activerecord-session_store</code></a> gem).</li>
<li>A custom store or a store provided by a third party gem.</li>
</ul>

<p>For most session stores, the unique session ID in the cookie is used to look up
session data on the server (e.g. a database table). Rails does not allow you to
pass the session ID in the URL as this is less secure.</p>

<h4><code>CookieStore</code></h4>

<p>The <code>CookieStore</code> is the default and recommended session store. It stores all
session data in the cookie itself (the session ID is still available to you if
you need it). The <code>CookieStore</code> is lightweight and does not require any
configuration to use in a new application.</p>

<p>The <code>CookieStore</code> can store 4 kB of data - much less than the other storage
options - but this is usually enough. Storing large amounts of data in the
session is discouraged. You should especially avoid storing complex objects
(such as model instances) in the session.</p>

<h4><code>CacheStore</code></h4>

<p>You can use the <code>CacheStore</code> if your sessions don&#39;t store critical data or don&#39;t
need to be around for long periods (for instance if you just use the flash for
messaging). This will store sessions using the cache implementation you have
configured for your application. The advantage is that you can use your existing
cache infrastructure for storing sessions without requiring any additional setup
or administration. The downside is that the session storage will be temporary
and they could disappear at any time.</p>

<p>Read more about session storage in the <a href="security.html#sessions">Security Guide</a>.</p>

<h3>Session Storage Options</h3>

<p>There are a few configuration options related to session storage. You can
configure the type of storage in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_session_store'>session_store</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cache_store'>cache_store</span></code></pre>

<p>Rails sets up a session key (the name of the cookie) when signing the session
data. These can also be changed in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_session_store'>session_store</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cookie_store'>cookie_store</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_your_app_session</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>NOTE: Be sure to restart your server when you modify an initializer file.</p>

<p>You can also pass a <code>:domain</code> key and specify the domain name for the cookie:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_session_store'>session_store</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cookie_store'>cookie_store</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_your_app_session</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>domain:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.example.com</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>TIP: See <a href="configuring.html#config-session-store"><code>config.session_store</code></a> in the
configuration guide for more information.</p>

<p>Rails sets up a secret key for <code>CookieStore</code> used for signing the session data
in <code>config/credentials.yml.enc</code>. The credentials can be updated with <code>bin/rails
credentials:edit</code>.</p>

<pre class="code yaml"><code class="yaml"># aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: 492f...
</code></pre>

<p>WARNING: Changing the <code>secret_key_base</code> when using the <code>CookieStore</code> will
invalidate all existing sessions. You&#39;ll need to configure a <a href="https://edgeguides.rubyonrails.org/configuring.html#config-action-dispatch-cookies-rotations">cookie rotator</a>
to rotate existing sessions.</p>

<h2>Controller Callbacks</h2>

<p>Controller callbacks are methods that are defined to automatically run before
and/or after a controller action. A controller callback method can be defined in
a given controller or in the <code>ApplicationController</code>. Since all controllers
inherit from <code>ApplicationController</code>, callbacks defined here will run on every
controller in your application.</p>

<h3><code>before_action</code></h3>

<p>Callback methods registered via <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-before_action"><code>before_action</code></a> run <em>before</em> a controller
action. They may halt the request cycle. A common use case for <code>before_action</code>
is ensuring that a user is logged in:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_action'>before_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_require_login'>require_login</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_require_login'>require_login</span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_logged_in?'>logged_in?</span>
        <span class='id identifier rubyid_flash'>flash</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You must be logged in to access this section</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_new_login_url'>new_login_url</span> <span class='comment'># halts request cycle
</span>      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The method stores an error message in the flash and redirects to the login form
if the user is not already logged in. When a <code>before_action</code> callback renders or
redirects (like in the example above), the original controller action is not
run. If there are additional callbacks registered to run, they are also
cancelled and not run.</p>

<p>In this example, the <code>before_action</code> is defined in <code>ApplicationController</code> so
all controllers in the application inherit it. That implies that all requests in
the application will require the user to be logged in. This is fine except for
the &quot;login&quot; page. The &quot;login&quot; action should succeed even when the user is not
logged in (to allow the user to log in) otherwise the user will never be able to
log in. You can use <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-skip_before_action"><code>skip_before_action</code></a> to allow specified controller
actions to skip a given <code>before_action</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>LoginsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='id identifier rubyid_skip_before_action'>skip_before_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_require_login'>require_login</span><span class='comma'>,</span> <span class='label'>only:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_create'>create</span>]
<span class='kw'>end</span></code></pre>

<p>Now, the <code>LoginsController</code>&#39;s <code>new</code> and <code>create</code> actions will work without
requiring the user to be logged in.</p>

<p>The <code>:only</code> option skips the callback only for the listed actions; there is also
an <code>:except</code> option which works the other way. These options can be used when
registering action callbacks too, to add callbacks which only run for selected
actions.</p>

<p>NOTE: If you register the same action callback multiple times with different
options, the last action callback definition will overwrite the previous ones.</p>

<h3><code>after_action</code> and <code>around_action</code></h3>

<p>You can also define action callbacks to run <em>after</em> a controller action has been
executed with <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-after_action"><code>after_action</code></a>, or to run both before and after with
<a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-around_action"><code>around_action</code></a>.</p>

<p>The <code>after_action</code> callbacks are similar to <code>before_action</code> callbacks, but
because the controller action has already been run they have access to the
response data that&#39;s about to be sent to the client.</p>

<p>NOTE: <code>after_action</code> callbacks are executed only after a successful controller
action, and not if an exception is raised in the request cycle.</p>

<p>The <code>around_action</code> callbacks are useful when you want to execute code before
and after a controller action, allowing you to encapsulate functionality that
affects the action&#39;s execution. They are responsible for running their
associated actions by yielding.</p>

<p>For example, imagine you want to monitor the performance of specific actions.
You could use an <code>around_action</code> to measure how long each action takes to
complete and log this information:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_around_action'>around_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_measure_execution_time'>measure_execution_time</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_measure_execution_time'>measure_execution_time</span>
      <span class='id identifier rubyid_start_time'>start_time</span> <span class='op'>=</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span>
      <span class='kw'>yield</span>  <span class='comment'># This executes the action
</span>      <span class='id identifier rubyid_end_time'>end_time</span> <span class='op'>=</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span>

      <span class='id identifier rubyid_duration'>duration</span> <span class='op'>=</span> <span class='id identifier rubyid_end_time'>end_time</span> <span class='op'>-</span> <span class='id identifier rubyid_start_time'>start_time</span>
      <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Action </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_action_name'>action_name</span><span class='embexpr_end'>}</span><span class='tstring_content'> from controller </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_controller_name'>controller_name</span><span class='embexpr_end'>}</span><span class='tstring_content'> took </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_duration'>duration</span>.<span class='id identifier rubyid_round'>round</span>(<span class='int'>2</span>)<span class='embexpr_end'>}</span><span class='tstring_content'> seconds to execute.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>TIP: Action callbacks receive <code>controller_name</code> and <code>action_name</code> as parameters
you can use, as shown in the example above.</p>

<p>The <code>around_action</code> callback also wraps rendering. In the example above, view
rendering will be included in the <code>duration</code>. The code after the <code>yield</code> in an
<code>around_action</code> is run even when there is an exception in the associated action
and there is an <code>ensure</code> block in the callback. (This is different from
<code>after_action</code> callbacks where an exception in the action cancels the
<code>after_action</code> code.)</p>

<h3>Other Ways to Use Callbacks</h3>

<p>In addition to <code>before_action</code>, <code>after_action</code>, or <code>around_action</code>, there are
two less common ways to register callbacks.</p>

<p>The first is to use a block directly with the <code>*_action</code> methods. The block
receives the controller as an argument. For example, the <code>require_login</code> action
callback from above could be rewritten to use a block:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_action'>before_action</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_controller'>controller</span><span class='op'>|</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_controller'>controller</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_logged_in?'>logged_in?</span>)
      <span class='id identifier rubyid_flash'>flash</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You must be logged in to access this section</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_new_login_url'>new_login_url</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Note that the action callback, in this case, uses <code>send</code> because the
<code>logged_in?</code> method is private, and the action callback does not run in the
scope of the controller. This is not the recommended way to implement this
particular action callback, but in simpler cases, it might be useful.</p>

<p>Specifically for <code>around_action</code>, the block also yields in the <code>action</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_around_action'>around_action</span> { <span class='op'>|</span><span class='id identifier rubyid__controller'>_controller</span><span class='comma'>,</span> <span class='id identifier rubyid_action'>action</span><span class='op'>|</span> <span class='id identifier rubyid_time'>time</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_action'>action</span>) }</code></pre>

<p>The second way is to specify a class (or any object that responds to the
expected methods) for the callback action. This can be useful in cases that are
more complex. As an example, you could rewrite the <code>around_action</code> callback to
measure execution time with a class:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_around_action'>around_action</span> <span class='const'>ActionDurationCallback</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>ActionDurationCallback</span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_around'>around</span>(<span class='id identifier rubyid_controller'>controller</span>)
    <span class='id identifier rubyid_start_time'>start_time</span> <span class='op'>=</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span>
    <span class='kw'>yield</span> <span class='comment'># This executes the action
</span>    <span class='id identifier rubyid_end_time'>end_time</span> <span class='op'>=</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span>

    <span class='id identifier rubyid_duration'>duration</span> <span class='op'>=</span> <span class='id identifier rubyid_end_time'>end_time</span> <span class='op'>-</span> <span class='id identifier rubyid_start_time'>start_time</span>
    <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Action </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_controller'>controller</span>.<span class='id identifier rubyid_action_name'>action_name</span><span class='embexpr_end'>}</span><span class='tstring_content'> from controller </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_controller'>controller</span>.<span class='id identifier rubyid_controller_name'>controller_name</span><span class='embexpr_end'>}</span><span class='tstring_content'> took </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_duration'>duration</span>.<span class='id identifier rubyid_round'>round</span>(<span class='int'>2</span>)<span class='embexpr_end'>}</span><span class='tstring_content'> seconds to execute.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>In the above example, the <code>ActionDurationCallback</code>&#39;s method is not run in the scope
of the controller but gets <code>controller</code> as an argument.</p>

<p>In general, the class being used for a <code>*_action</code> callback must implement a
method with the same name as the action callback. So for the <code>before_action</code>
callback, the class must implement a <code>before</code> method, and so on. Also,
the <code>around</code> method must <code>yield</code> to execute the action.</p>

<h2>The Request and Response Objects</h2>

<p>Every controller has two methods, <a href="https://api.rubyonrails.org/classes/ActionController/Base.html#method-i-request"><code>request</code></a> and <a href="https://api.rubyonrails.org/classes/ActionController/Base.html#method-i-response"><code>response</code></a>, which can be
used to access the request and response objects associated with the
current request cycle. The <code>request</code> method returns an instance of
<a href="https://api.rubyonrails.org/classes/ActionDispatch/Request.html"><a href="ActionDispatch/Request.html" title="ActionDispatch::Request (class)"><code>::ActionDispatch::Request</code></a></a>. The <a href="https://api.rubyonrails.org/classes/ActionController/Base.html#method-i-response"><code>response</code></a> method returns an instance
of <a href="https://api.rubyonrails.org/classes/ActionDispatch/Response.html"><a href="ActionDispatch/Response.html" title="ActionDispatch::Response (class)"><code>::ActionDispatch::Response</code></a></a>, an object representing what is going to be
sent back to the client browser (e.g. from <code>render</code> or <code>redirect</code> in the
controller action).</p>

<h3>The <code>request</code> Object</h3>

<p>The request object contains useful information about the request coming in from
the client. This section describes the purpose of some of the properties of the
<code>request</code> object.</p>

<p>To get a full list of the available methods, refer to the <a href="https://api.rubyonrails.org/classes/ActionDispatch/Request.html">Rails API
documentation</a>
and <a href="https://rack.github.io/rack/main/Rack/Request.html">Rack</a>
documentation.</p>

<table><thead>
<tr>
<th>Property of <code>request</code></th>
<th>Purpose</th>
</tr>
</thead><tbody>
<tr>
<td><code>host</code></td>
<td>The hostname used for this request.</td>
</tr>
<tr>
<td><code>domain(n=2)</code></td>
<td>The hostname&#39;s first <code>n</code> segments, starting from the right (the TLD).</td>
</tr>
<tr>
<td><code>format</code></td>
<td>The content type requested by the client.</td>
</tr>
<tr>
<td><code>method</code></td>
<td>The HTTP method used for the request.</td>
</tr>
<tr>
<td><code>get?</code>, <code>post?</code>, <code>patch?</code>, <code>put?</code>, <code>delete?</code>, <code>head?</code></td>
<td>Returns true if the HTTP method is GET/POST/PATCH/PUT/DELETE/HEAD.</td>
</tr>
<tr>
<td><code>headers</code></td>
<td>Returns a hash containing the headers associated with the request.</td>
</tr>
<tr>
<td><code>port</code></td>
<td>The port number (integer) used for the request.</td>
</tr>
<tr>
<td><code>protocol</code></td>
<td>Returns a string containing the protocol used plus &quot;://&quot;, for example &quot;http://&quot;.</td>
</tr>
<tr>
<td><code>query_string</code></td>
<td>The query string part of the URL, i.e., everything after &quot;?&quot;.</td>
</tr>
<tr>
<td><code>remote_ip</code></td>
<td>The IP address of the client.</td>
</tr>
<tr>
<td><code>url</code></td>
<td>The entire URL used for the request.</td>
</tr>
</tbody></table>

<h4><code>query_parameters</code>, <code>request_parameters</code>, and <code>path_parameters</code></h4>

<p>Rails collects all of the parameters for a given request in the <code>params</code> hash,
including the ones set in the URL as query string parameters, and those sent as
the body of a <code>POST</code> request. The request object has three methods that give you
access to the various parameters.</p>

<ul>
<li><a href="https://api.rubyonrails.org/classes/ActionDispatch/Request.html#method-i-query_parameters"><code>query_parameters</code></a> - contains parameters that were sent as part of the
query string.</li>
<li><a href="https://api.rubyonrails.org/classes/ActionDispatch/Request.html#method-i-request_parameters"><code>request_parameters</code></a> - contains parameters sent as part of the post body.</li>
<li><a href="https://api.rubyonrails.org/classes/ActionDispatch/Http/Parameters.html#method-i-path_parameters"><code>path_parameters</code></a> - contains parameters parsed by the router as being part
of the path leading to this particular controller and action.</li>
</ul>

<h4><code>request.variant</code></h4>

<p>Controllers might need to tailor a response based on context-specific
information in a request. For example, controllers responding to requests from a
mobile platform might need to render different content than requests from a
desktop browser. One strategy to accomplish this is by customizing a request&#39;s
variant. Variant names are arbitrary, and can communicate anything from the
request&#39;s platform (<code>:android</code>, <code>:ios</code>, <code>:linux</code>, <code>:macos</code>, <code>:windows</code>) to its
browser (<code>:chrome</code>, <code>:edge</code>, <code>:firefox</code>, <code>:safari</code>), to the type of user
(<code>:admin</code>, <code>:guest</code>, <code>:user</code>).</p>

<p>You can set the <a href="https://api.rubyonrails.org/classes/ActionDispatch/Http/MimeNegotiation.html#method-i-variant-3D"><code>request.variant</code></a> in a <code>before_action</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_variant'>variant</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tablet'>tablet</span> <span class='kw'>if</span> <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_user_agent'>user_agent</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>iPad</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>Responding with a variant in a controller action is like responding with a format:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/controllers/projects_controller.rb
</span>
<span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
  <span class='comment'># ...
</span>  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
    <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_html'>html</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_html'>html</span><span class='op'>|</span>
      <span class='id identifier rubyid_html'>html</span>.<span class='id identifier rubyid_tablet'>tablet</span>                         <span class='comment'># renders app/views/projects/show.html+tablet.erb
</span>      <span class='id identifier rubyid_html'>html</span>.<span class='id identifier rubyid_phone'>phone</span> { <span class='id identifier rubyid_extra_setup'>extra_setup</span><span class='semicolon'>;</span> <span class='id identifier rubyid_render'>render</span> }  <span class='comment'># renders app/views/projects/show.html+phone.erb
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>A separate template should be created for each format and variant:</p>

<ul>
<li><code>app/views/projects/show.html.erb</code></li>
<li><code>app/views/projects/show.html+tablet.erb</code></li>
<li><code>app/views/projects/show.html+phone.erb</code></li>
</ul>

<p>You can also simplify the variants definition using the inline syntax:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
  <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_html'>html</span>.<span class='id identifier rubyid_tablet'>tablet</span>
  <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_html'>html</span>.<span class='id identifier rubyid_phone'>phone</span>  { <span class='id identifier rubyid_extra_setup'>extra_setup</span><span class='semicolon'>;</span> <span class='id identifier rubyid_render'>render</span> }
<span class='kw'>end</span></code></pre>

<h3>The <code>response</code> Object</h3>

<p>The response object is built up during the execution of the action from
rendering data to be sent back to the client browser. It&#39;s not usually used
directly but sometimes, in an <code>after_action</code> callback for example, it can be
useful to access the response directly. One use case is for setting the content type header:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>application/pdf</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>Another use case is for setting custom response headers:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_headers'>headers</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>X-Custom-Header</span><span class='tstring_end'>&quot;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>some value</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>The <code>headers</code> attribute is a hash which maps header names to header values.
Rails sets some headers automatically but if you need to update a header or add
a custom header, you can use <code>response.headers</code> as in the example above.</p>

<p>NOTE: The <code>headers</code> method can be accessed directly in the controller as well.</p>

<p>Here are some of the properties of the <code>response</code> object:</p>

<table><thead>
<tr>
<th>Property of <code>response</code></th>
<th>Purpose</th>
</tr>
</thead><tbody>
<tr>
<td><code>body</code></td>
<td>This is the string of data being sent back to the client. This is most often HTML.</td>
</tr>
<tr>
<td><code>status</code></td>
<td>The HTTP status code for the response, like 200 for a successful request or 404 for file not found.</td>
</tr>
<tr>
<td><code>location</code></td>
<td>The URL the client is being redirected to, if any.</td>
</tr>
<tr>
<td><code>content_type</code></td>
<td>The content type of the response.</td>
</tr>
<tr>
<td><code>charset</code></td>
<td>The character set being used for the response. Default is &quot;utf-8&quot;.</td>
</tr>
<tr>
<td><code>headers</code></td>
<td>Headers used for the response.</td>
</tr>
</tbody></table>

<p>To get a full list of the available methods, refer to the <a href="https://api.rubyonrails.org/classes/ActionDispatch/Response.html">Rails API
documentation</a>
and <a href="https://rack.github.io/rack/main/Rack/Response.html">Rack
Documentation</a>.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>