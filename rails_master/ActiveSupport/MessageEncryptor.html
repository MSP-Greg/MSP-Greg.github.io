<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: ActiveSupport::MessageEncryptor &mdash; Rails main</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ActiveSupport::MessageEncryptor",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Rails main</a> &raquo; 
      <a href='../_index.html#alpha_M'>Index (M)</a> &raquo; 
        <a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>MessageEncryptor&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: ActiveSupport::MessageEncryptor</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Modules:</div>
      <div class='box_11'>
          <a class='nodoc' href="MessageEncryptor/NullSerializer.html" title="ActiveSupport::MessageEncryptor::NullSerializer (module)"><code>NullSerializer</code></a>      </div>
    </td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Exceptions:</div>
      <div class='box_11'>
          <a href="MessageEncryptor/InvalidMessage.html" title="ActiveSupport::MessageEncryptor::InvalidMessage (class)"><code>InvalidMessage</code></a>      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          <a class='nodoc' href="Messages/Codec.html" title="ActiveSupport::Messages::Codec (class)"><code>Messages::Codec</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a class='nodoc' href="Messages/Rotator.html" title="ActiveSupport::Messages::Rotator (module)"><code>Messages::Rotator</code></a>,
          <a class='nodoc' href="Messages/Codec.html" title="ActiveSupport::Messages::Codec (class)"><code>Messages::Codec</code></a>,
          <a class='nodoc' href="Messages/Metadata.html" title="ActiveSupport::Messages::Metadata (module)"><code>Messages::Metadata</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2 o'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a class='nodoc' href="Messages/Codec.html" title="ActiveSupport::Messages::Codec (class)">ActiveSupport::Messages::Codec</a></span>
        <ul class='fullTree'>
          <li><a href="../Object.html" title="Object (class)"><code>::Object</code></a></li>
          <li class='next'><a class='nodoc' href="Messages/Codec.html" title="ActiveSupport::Messages::Codec (class)">ActiveSupport::Messages::Codec</a></li>
          <li class='next'>ActiveSupport::MessageEncryptor</li>
        </ul>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L90'>activesupport/lib/active_support/message_encryptor.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p><code>MessageEncryptor</code> is a simple way to encrypt values which get stored somewhere you don’t trust.</p>

<p>The cipher text and initialization vector are base64 encoded and returned to you.</p>

<p>This can be used in situations similar to the <a href="MessageVerifier.html" title="ActiveSupport::MessageVerifier (class)"><code>MessageVerifier</code></a>, but where you don’t want users to be able to determine the value of the payload.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_len'>len</span>   <span class='op'>=</span> <span class='const'><a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'>MessageEncryptor</span>.<span class='id identifier rubyid_key_len'><a href="#key_len-class_method" title="ActiveSupport::MessageEncryptor.key_len (method)">key_len</a></span>
<span class='id identifier rubyid_salt'>salt</span>  <span class='op'>=</span> <span class='const'><a href="../SecureRandom.html" title="SecureRandom (module)">SecureRandom</a></span>.<span class='id identifier rubyid_random_bytes'>random_bytes</span>(<span class='id identifier rubyid_len'>len</span>)
<span class='id identifier rubyid_key'>key</span>   <span class='op'>=</span> <span class='const'><a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="KeyGenerator.html" title="ActiveSupport::KeyGenerator (class)">KeyGenerator</a></span>.<span class='id identifier rubyid_new'><a href="KeyGenerator.html#new-class_method" title="ActiveSupport::KeyGenerator.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>password</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_generate_key'><a href="KeyGenerator.html#generate_key-instance_method" title="ActiveSupport::KeyGenerator#generate_key (method)">generate_key</a></span>(<span class='id identifier rubyid_salt'>salt</span><span class='comma'>,</span> <span class='id identifier rubyid_len'>len</span>) <span class='comment'># =&gt; &quot;\x89\xE0\x156\xAC...&quot;
</span><span class='id identifier rubyid_crypt'>crypt</span> <span class='op'>=</span> <span class='const'><a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'>MessageEncryptor</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="ActiveSupport::MessageEncryptor.new (method)">new</a></span>(<span class='id identifier rubyid_key'>key</span>)                            <span class='comment'># =&gt; #&lt;ActiveSupport::MessageEncryptor ...&gt;
</span><span class='id identifier rubyid_encrypted_data'>encrypted_data</span> <span class='op'>=</span> <span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_encrypt_and_sign'><a href="#encrypt_and_sign-instance_method" title="ActiveSupport::MessageEncryptor#encrypt_and_sign (method)">encrypt_and_sign</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my secret data</span><span class='tstring_end'>&#39;</span></span>)                   <span class='comment'># =&gt; &quot;NlFBTTMwOUV5UlA1QlNEN2xkY2d6eThYWWh...&quot;
</span><span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='id identifier rubyid_encrypted_data'>encrypted_data</span>)                                    <span class='comment'># =&gt; &quot;my secret data&quot;</span></code></pre>

<p>The <a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">#decrypt_and_verify</a> method will raise an <a href="MessageEncryptor/InvalidMessage.html" title="ActiveSupport::MessageEncryptor::InvalidMessage (class)"><code>InvalidMessage</code></a> exception if the data provided cannot be decrypted or verified.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>not encrypted data</span><span class='tstring_end'>&#39;</span></span>) <span class='comment'># =&gt; ActiveSupport::MessageEncryptor::InvalidMessage</span></code></pre>

<h3 id="label-Confining+messages+to+a+specific+purpose">Confining messages to a specific purpose</h3>

<p>By default any message can be used throughout your app. But they can also be confined to a specific <code>:purpose</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_token'>token</span> <span class='op'>=</span> <span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_encrypt_and_sign'><a href="#encrypt_and_sign-instance_method" title="ActiveSupport::MessageEncryptor#encrypt_and_sign (method)">encrypt_and_sign</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>this is the chair</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>purpose:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_login'>login</span>)</code></pre>

<p>Then that same purpose must be passed when verifying to get the data back out:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='id identifier rubyid_token'>token</span><span class='comma'>,</span> <span class='label'>purpose:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_login'>login</span>)    <span class='comment'># =&gt; &quot;this is the chair&quot;
</span><span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='id identifier rubyid_token'>token</span><span class='comma'>,</span> <span class='label'>purpose:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_shipping'>shipping</span>) <span class='comment'># =&gt; nil
</span><span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='id identifier rubyid_token'>token</span>)                     <span class='comment'># =&gt; nil</span></code></pre>

<p>Likewise, if a message has no purpose it won’t be returned when verifying with a specific purpose.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_token'>token</span> <span class='op'>=</span> <span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_encrypt_and_sign'><a href="#encrypt_and_sign-instance_method" title="ActiveSupport::MessageEncryptor#encrypt_and_sign (method)">encrypt_and_sign</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>the conversation is lively</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='id identifier rubyid_token'>token</span><span class='comma'>,</span> <span class='label'>purpose:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_scare_tactics'>scare_tactics</span>) <span class='comment'># =&gt; nil
</span><span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='id identifier rubyid_token'>token</span>)                          <span class='comment'># =&gt; &quot;the conversation is lively&quot;</span></code></pre>

<h3 id="label-Making+messages+expire">Making messages expire</h3>

<p>By default messages last forever and verifying one year from now will still return the original value. But messages can be set to expire at a given time with <code>:expires_in</code> or <code>:expires_at</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_encrypt_and_sign'><a href="#encrypt_and_sign-instance_method" title="ActiveSupport::MessageEncryptor#encrypt_and_sign (method)">encrypt_and_sign</a></span>(<span class='id identifier rubyid_parcel'>parcel</span><span class='comma'>,</span> <span class='label'>expires_in:</span> <span class='int'>1</span>.<span class='id identifier rubyid_month'>month</span>)
<span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_encrypt_and_sign'><a href="#encrypt_and_sign-instance_method" title="ActiveSupport::MessageEncryptor#encrypt_and_sign (method)">encrypt_and_sign</a></span>(<span class='id identifier rubyid_doowad'>doowad</span><span class='comma'>,</span> <span class='label'>expires_at:</span> <span class='const'><a href="../Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span>.<span class='id identifier rubyid_end_of_year'>end_of_year</span>)</code></pre>

<p>Then the messages can be verified and returned up to the expire time. Thereafter, verifying returns <code>nil</code>.</p>

<h3 id="label-Rotating+keys">Rotating keys</h3>

<p><code>MessageEncryptor</code> also supports rotating out old configurations by falling back to a stack of encryptors. Call <code>rotate</code> to build and add an encryptor so <a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">#decrypt_and_verify</a> will also try the fallback.</p>

<p>By default any rotated encryptors use the values of the primary encryptor unless specified otherwise.</p>

<p>You’d give your encryptor the new defaults:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_crypt'>crypt</span> <span class='op'>=</span> <span class='const'><a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'>MessageEncryptor</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="ActiveSupport::MessageEncryptor.new (method)">new</a></span>(<span class='ivar'>@secret</span><span class='comma'>,</span> <span class='label'>cipher:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aes-256-gcm</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>Then gradually rotate the old values out by adding them as fallbacks. Any message generated with the old values will then work until the rotation is removed.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_rotate'>rotate</span> <span class='id identifier rubyid_old_secret'>old_secret</span>            <span class='comment'># Fallback to an old secret instead of @secret.
</span><span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_rotate'>rotate</span> <span class='label'>cipher:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aes-256-cbc</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># Fallback to an old cipher instead of aes-256-gcm.</span></code></pre>

<p>Though if both the secret and the cipher was changed at the same time, the above should be combined into:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_crypt'>crypt</span>.<span class='id identifier rubyid_rotate'>rotate</span> <span class='id identifier rubyid_old_secret'>old_secret</span><span class='comma'>,</span> <span class='label'>cipher:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aes-256-cbc</span><span class='tstring_end'>&quot;</span></span></code></pre>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='AUTH_TAG_LENGTH-constant' class='summary_signature nodoc'>AUTH_TAG_LENGTH =</span>
    <span class='nodoc note title'>Internal use only</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L118-L118'># File 'activesupport/lib/active_support/message_encryptor.rb', line 118</a>    <pre class='code ruby'><span class='int'>16</span></pre>
  </li>
  <li>
    <span id='OpenSSLCipherError-constant' class='summary_signature'>OpenSSLCipherError =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L116-L116'># File 'activesupport/lib/active_support/message_encryptor.rb', line 116</a>    <pre class='code ruby'><span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Cipher</span><span class='op'>::</span><span class='const'>CipherError</span></pre>
  </li>
  <li>
    <span id='SEPARATOR-constant' class='summary_signature nodoc'>SEPARATOR =</span>
    <span class='nodoc note title'>Internal use only</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L119-L119'># File 'activesupport/lib/active_support/message_encryptor.rb', line 119</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--</span><span class='tstring_end'>&quot;</span></span></pre>
  </li>
</ul>
  <h3 class='inherited'><a href="Messages/Metadata.html" title="ActiveSupport::Messages::Metadata (module)"><code>Messages::Metadata</code></a> - Included</h3>
  <p  class='inherited'>
    <a class='nodoc' href="Messages/Metadata.html#ENVELOPE_SERIALIZERS-constant" title="ActiveSupport::Messages::Metadata::ENVELOPE_SERIALIZERS (constant)">ENVELOPE_SERIALIZERS</a>, 
    <a class='nodoc' href="Messages/Metadata.html#TIMESTAMP_SERIALIZERS-constant" title="ActiveSupport::Messages::Metadata::TIMESTAMP_SERIALIZERS (constant)">TIMESTAMP_SERIALIZERS</a>
  </p>
</div>

<h2 class='h2_sum' id='class_attribute_summary'>Class Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature rw'>
      <a href="#use_authenticated_message_encryption-class_method" title=".use_authenticated_message_encryption (class method)">.<strong>use_authenticated_message_encryption</strong>  </a>
    </span>
    <span class='note title rw'>rw</span>
  </li>
</ul>

<h3 class='inherited nodoc'><a href="Messages/Codec.html" title="ActiveSupport::Messages::Codec (class)"><code>Messages::Codec</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m rw nodoc' href="Messages/Codec.html#default_serializer-class_method" title="ActiveSupport::Messages::Codec.default_serializer (method)">.default_serializer</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- class_attribute_summary -->

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#key_len-class_method" title=".key_len (class method)">.<strong>key_len</strong>(cipher = default_cipher)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Given a cipher, returns the key length of the cipher to help generate the key of desired size.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(secret, sign_secret = nil, **options)  &#x21d2; MessageEncryptor </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Initialize a new <code>MessageEncryptor</code>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#default_cipher-class_method" title=".default_cipher (class method)">.<strong>default_cipher</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>

<h3 class='inherited nodoc'><a href="Messages/Codec.html" title="ActiveSupport::Messages::Codec (class)"><code>Messages::Codec</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m nodoc' href="Messages/Codec.html#new-class_method" title="ActiveSupport::Messages::Codec.new (method)">.new</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#aead_mode%3F-instance_method" title="#aead_mode? (instance method)">#<strong>aead_mode?</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Alias for <a href="#aead_mode-instance_method" title="ActiveSupport::MessageEncryptor#aead_mode (method)">#aead_mode</a>.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited nodoc'><a href="Messages/Codec.html" title="ActiveSupport::Messages::Codec (class)"><code>Messages::Codec</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro priv nodoc' href="Messages/Codec.html#serializer-instance_method" title="ActiveSupport::Messages::Codec#serializer (method)">#serializer</a>,
        <a class='i_m ro priv nodoc' href="Messages/Codec.html#use_message_serializer_for_metadata%3F-instance_method" title="ActiveSupport::Messages::Codec#use_message_serializer_for_metadata? (method)">#use_message_serializer_for_metadata?</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited nodoc'><a href="Messages/Metadata.html" title="ActiveSupport::Messages::Metadata (module)"><code>Messages::Metadata</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m rw nodoc' href="Messages/Metadata.html#use_message_serializer_for_metadata-instance_method" title="ActiveSupport::Messages::Metadata#use_message_serializer_for_metadata (method)">#use_message_serializer_for_metadata</a>,
        <a class='i_m rw priv nodoc' href="Messages/Metadata.html#use_message_serializer_for_metadata%3F-instance_method" title="ActiveSupport::Messages::Metadata#use_message_serializer_for_metadata? (method)">#use_message_serializer_for_metadata?</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#decrypt_and_verify-instance_method" title="#decrypt_and_verify (instance method)">#<strong>decrypt_and_verify</strong>(message, **options)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Decrypt and verify a message.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#encrypt_and_sign-instance_method" title="#encrypt_and_sign (instance method)">#<strong>encrypt_and_sign</strong>(value, **options)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Encrypt and sign a message.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#aead_mode-instance_method" title="#aead_mode (instance method)">#<strong>aead_mode</strong>  </a>
      (also: #aead_mode?)
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#decrypt-instance_method" title="#decrypt (instance method)">#<strong>decrypt</strong>(encrypted_message)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#encrypt-instance_method" title="#encrypt (instance method)">#<strong>encrypt</strong>(data)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#extract_part-instance_method" title="#extract_part (instance method)">#<strong>extract_part</strong>(encrypted_message, rindex, length)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#extract_parts-instance_method" title="#extract_parts (instance method)">#<strong>extract_parts</strong>(encrypted_message)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#join_parts-instance_method" title="#join_parts (instance method)">#<strong>join_parts</strong>(parts)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#length_after_encode-instance_method" title="#length_after_encode (instance method)">#<strong>length_after_encode</strong>(length_before_encode)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#length_of_encoded_auth_tag-instance_method" title="#length_of_encoded_auth_tag (instance method)">#<strong>length_of_encoded_auth_tag</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#length_of_encoded_iv-instance_method" title="#length_of_encoded_iv (instance method)">#<strong>length_of_encoded_iv</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#new_cipher-instance_method" title="#new_cipher (instance method)">#<strong>new_cipher</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#sign-instance_method" title="#sign (instance method)">#<strong>sign</strong>(data)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#verify-instance_method" title="#verify (instance method)">#<strong>verify</strong>(data)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#create_message-instance_method" title="#create_message (instance method)">#<strong>create_message</strong>(value, **options)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#inspect-instance_method" title="#inspect (instance method)">#<strong>inspect</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#read_message-instance_method" title="#read_message (instance method)">#<strong>read_message</strong>(message, **options)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>

<h3 class='inherited nodoc'><a href="Messages/Rotator.html" title="ActiveSupport::Messages::Rotator (module)"><code>Messages::Rotator</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m nodoc' href="Messages/Rotator.html#fall_back_to-instance_method" title="ActiveSupport::Messages::Rotator#fall_back_to (method)">#fall_back_to</a>,
        <a class='i_m nodoc' href="Messages/Rotator.html#initialize-instance_method" title="ActiveSupport::Messages::Rotator#initialize (method)">#initialize</a>,
        <a class='i_m nodoc' href="Messages/Rotator.html#read_message-instance_method" title="ActiveSupport::Messages::Rotator#read_message (method)">#read_message</a>,
        <a class='i_m nodoc' href="Messages/Rotator.html#rotate-instance_method" title="ActiveSupport::Messages::Rotator#rotate (method)">#rotate</a>,
        <a class='i_m priv nodoc' href="Messages/Rotator.html#build_rotation-instance_method" title="ActiveSupport::Messages::Rotator#build_rotation (method)">#build_rotation</a>,
        <a class='i_m priv nodoc' href="Messages/Rotator.html#catch_rotation_error-instance_method" title="ActiveSupport::Messages::Rotator#catch_rotation_error (method)">#catch_rotation_error</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited nodoc'><a href="Messages/Codec.html" title="ActiveSupport::Messages::Codec (class)"><code>Messages::Codec</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m priv nodoc' href="Messages/Codec.html#catch_and_ignore-instance_method" title="ActiveSupport::Messages::Codec#catch_and_ignore (method)">#catch_and_ignore</a>,
        <a class='i_m priv nodoc' href="Messages/Codec.html#catch_and_raise-instance_method" title="ActiveSupport::Messages::Codec#catch_and_raise (method)">#catch_and_raise</a>,
        <a class='i_m priv nodoc' href="Messages/Codec.html#decode-instance_method" title="ActiveSupport::Messages::Codec#decode (method)">#decode</a>,
        <a class='i_m priv nodoc' href="Messages/Codec.html#deserialize-instance_method" title="ActiveSupport::Messages::Codec#deserialize (method)">#deserialize</a>,
        <a class='i_m priv nodoc' href="Messages/Codec.html#encode-instance_method" title="ActiveSupport::Messages::Codec#encode (method)">#encode</a>,
        <a class='i_m priv nodoc' href="Messages/Codec.html#serialize-instance_method" title="ActiveSupport::Messages::Codec#serialize (method)">#serialize</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited nodoc'><a href="Messages/Metadata.html" title="ActiveSupport::Messages::Metadata (module)"><code>Messages::Metadata</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m priv nodoc' href="Messages/Metadata.html#deserialize_from_json-instance_method" title="ActiveSupport::Messages::Metadata#deserialize_from_json (method)">#deserialize_from_json</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#deserialize_from_json_safe_string-instance_method" title="ActiveSupport::Messages::Metadata#deserialize_from_json_safe_string (method)">#deserialize_from_json_safe_string</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#deserialize_with_metadata-instance_method" title="ActiveSupport::Messages::Metadata#deserialize_with_metadata (method)">#deserialize_with_metadata</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#dual_serialized_metadata_envelope_json%3F-instance_method" title="ActiveSupport::Messages::Metadata#dual_serialized_metadata_envelope_json? (method)">#dual_serialized_metadata_envelope_json?</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#extract_from_metadata_envelope-instance_method" title="ActiveSupport::Messages::Metadata#extract_from_metadata_envelope (method)">#extract_from_metadata_envelope</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#metadata_envelope%3F-instance_method" title="ActiveSupport::Messages::Metadata#metadata_envelope? (method)">#metadata_envelope?</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#parse_expiry-instance_method" title="ActiveSupport::Messages::Metadata#parse_expiry (method)">#parse_expiry</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#pick_expiry-instance_method" title="ActiveSupport::Messages::Metadata#pick_expiry (method)">#pick_expiry</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#serialize_to_json-instance_method" title="ActiveSupport::Messages::Metadata#serialize_to_json (method)">#serialize_to_json</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#serialize_to_json_safe_string-instance_method" title="ActiveSupport::Messages::Metadata#serialize_to_json_safe_string (method)">#serialize_to_json_safe_string</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#serialize_with_metadata-instance_method" title="ActiveSupport::Messages::Metadata#serialize_with_metadata (method)">#serialize_with_metadata</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#wrap_in_metadata_envelope-instance_method" title="ActiveSupport::Messages::Metadata#wrap_in_metadata_envelope (method)">#wrap_in_metadata_envelope</a>,
        <a class='i_m priv nodoc' href="Messages/Metadata.html#wrap_in_metadata_legacy_envelope-instance_method" title="ActiveSupport::Messages::Metadata#wrap_in_metadata_legacy_envelope (method)">#wrap_in_metadata_legacy_envelope</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(secret, sign_secret = nil, **options)  &#x21d2; <code>MessageEncryptor</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Initialize a new <code>MessageEncryptor</code>. <code>secret</code> must be at least as long as the cipher key size. For the default ‘aes-256-gcm’ cipher, this is 256 bits. If you are using a user-entered secret, you can generate a suitable key by using <a href="KeyGenerator.html" title="ActiveSupport::KeyGenerator (class)"><code>KeyGenerator</code></a> or a similar key derivation function.</p>

<p>The first additional parameter is used as the signature key for <a href="MessageVerifier.html" title="ActiveSupport::MessageVerifier (class)"><code>MessageVerifier</code></a>. This allows you to specify keys to encrypt and sign data. Ignored when using an AEAD cipher like ‘aes-256-gcm’.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'>MessageEncryptor</span>.<span class='id identifier rubyid_new'>new</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>secret</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>signature_secret</span><span class='tstring_end'>&#39;</span></span>)</code></pre>

<h4 id="label-Options">Options</h4>
<dl class="rdoc-list label-list"><dt><code>:cipher</code>
<dd>
<p>Cipher to use. Can be any cipher returned by <code>OpenSSL::Cipher.ciphers</code>. Default is ‘aes-256-gcm’.</p>
</dd><dt><code>:digest</code>
<dd>
<p>Digest used for signing. Ignored when using an AEAD cipher like ‘aes-256-gcm’.</p>
</dd><dt><code>:serializer</code>
<dd>
<p>The serializer used to serialize message data. You can specify any object that responds to <code>dump</code> and <code>load</code>, or you can choose from several preconfigured serializers: <code>:marshal</code>, <code>:json_allow_marshal</code>, <code>:json</code>, <code>:message_pack_allow_marshal</code>, <code>:message_pack</code>.</p>

<p>The preconfigured serializers include a fallback mechanism to support multiple deserialization formats. For example, the <code>:marshal</code> serializer will serialize using <code>Marshal</code>, but can deserialize using <code>Marshal</code>, ActiveSupport::JSON, or ActiveSupport::MessagePack. This makes it easy to migrate between serializers.</p>

<p>The <code>:marshal</code>, <code>:json_allow_marshal</code>, and <code>:message_pack_allow_marshal</code> serializers support deserializing using <code>Marshal</code>, but the others do not. Beware that <code>Marshal</code> is a potential vector for deserialization attacks in cases where a message signing secret has been leaked. <em>If possible, choose a serializer that does not support <code>Marshal</code>.</em></p>

<p>The <code>:message_pack</code> and <code>:message_pack_allow_marshal</code> serializers use ActiveSupport::MessagePack, which can roundtrip some Ruby types that are not supported by JSON, and may provide improved performance. However, these require the <code>msgpack</code> gem.</p>

<p>When using Rails, the default depends on <code>config.active_support.message_serializer</code>. Otherwise, the default is <code>:marshal</code>.</p>
</dd><dt><code>:url_safe</code>
<dd>
<p>By default, MessageEncryptor generates RFC 4648 compliant strings which are not URL-safe. In other words, they can contain “+” and “/”. If you want to generate URL-safe strings (in compliance with “Base 64 Encoding with URL and Filename Safe Alphabet” in RFC 4648), you can pass <code>true</code>.</p>
</dd><dt><code>:force_legacy_metadata_serializer</code>
<dd>
<p>Whether to use the legacy metadata serializer, which serializes the message first, then wraps it in an envelope which is also serialized. This was the default in Rails 7.0 and below.</p>

<p>If you don’t pass a truthy value, the default is set using <code>config.active_support.use_message_serializer_for_metadata</code>.</p>
</dd></dl>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L183-L191'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='183' data-end='191'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 183</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_secret'>secret</span><span class='comma'>,</span> <span class='id identifier rubyid_sign_secret'>sign_secret</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>)
  <span class='kw'>super</span>(<span class='op'>**</span><span class='id identifier rubyid_options'>options</span>)
  <span class='ivar'>@secret</span> <span class='op'>=</span> <span class='id identifier rubyid_secret'>secret</span>
  <span class='ivar'>@cipher</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_cipher'>cipher</span>] <span class='op'>||</span> <span class='kw'>self</span>.<span class='id identifier rubyid_class'>class</span>.<span class='id identifier rubyid_default_cipher'><a href="#default_cipher-class_method" title="ActiveSupport::MessageEncryptor.default_cipher (method)">default_cipher</a></span>
  <span class='ivar'>@aead_mode</span> <span class='op'>=</span> <span class='id identifier rubyid_new_cipher'><a href="#new_cipher-instance_method" title="ActiveSupport::MessageEncryptor#new_cipher (method)">new_cipher</a></span>.<span class='id identifier rubyid_authenticated?'>authenticated?</span>
  <span class='ivar'>@verifier</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@aead_mode</span>
    <span class='const'><a href="MessageVerifier.html" title="ActiveSupport::MessageVerifier (class)">MessageVerifier</a></span>.<span class='id identifier rubyid_new'><a href="MessageVerifier.html#new-class_method" title="ActiveSupport::MessageVerifier.new (method)">new</a></span>(<span class='id identifier rubyid_sign_secret'>sign_secret</span> <span class='op'>||</span> <span class='id identifier rubyid_secret'>secret</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='label'>serializer:</span> <span class='const'><a href="MessageEncryptor/NullSerializer.html" title="ActiveSupport::MessageEncryptor::NullSerializer (module)">NullSerializer</a></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Class Attribute Details</h2>
<section class='method_details first' id="use_authenticated_message_encryption-class_method">
  <h3 class='signature rw first'>
    .<strong>use_authenticated_message_encryption</strong>   <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L93-L93'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='93' data-end='93'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 93</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_cattr_accessor'>cattr_accessor</span> <span class='symbeg'>:</span><span class='id identifier rubyid_use_authenticated_message_encryption'>use_authenticated_message_encryption</span><span class='comma'>,</span> <span class='label'>instance_accessor:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='kw'>false</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Class Method Details</h2>
<section class='method_details first' id="default_cipher-class_method">
  <h3 class='signature nodoc first'>
    .<strong>default_cipher</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L96-L102'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='96' data-end='102'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 96</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_default_cipher'>default_cipher</span> <span class='comment'># :nodoc:
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_use_authenticated_message_encryption'><a href="#use_authenticated_message_encryption-class_method" title="ActiveSupport::MessageEncryptor.use_authenticated_message_encryption (method)">use_authenticated_message_encryption</a></span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aes-256-gcm</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aes-256-cbc</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="key_len-class_method">
  <h3 class='signature '>
    .<strong>key_len</strong>(cipher = default_cipher)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Given a cipher, returns the key length of the cipher to help generate the key of desired size</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L252-L254'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='252' data-end='254'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 252</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_key_len'>key_len</span>(<span class='id identifier rubyid_cipher'>cipher</span> <span class='op'>=</span> <span class='id identifier rubyid_default_cipher'><a href="#default_cipher-class_method" title="ActiveSupport::MessageEncryptor.default_cipher (method)">default_cipher</a></span>)
  <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Cipher</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="ActiveSupport::MessageEncryptor.new (method)">new</a></span>(<span class='id identifier rubyid_cipher'>cipher</span>).<span class='id identifier rubyid_key_len'>key_len</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="aead_mode?-instance_method">
  <h3 class='signature ro priv first'>
    #<strong>aead_mode?</strong>   <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Alias for <a href="#aead_mode-instance_method" title="ActiveSupport::MessageEncryptor#aead_mode (method)">#aead_mode</a>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L372-L372'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='372' data-end='372'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 372</span></pre>
<pre class='code ruby'>

<span class='kw'>alias</span> <span class='symbeg'>:</span><span class='id identifier rubyid_aead_mode?'>aead_mode?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_aead_mode'><a href="#aead_mode-instance_method" title="ActiveSupport::MessageEncryptor#aead_mode (method)">aead_mode</a></span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="aead_mode-instance_method">
  <h3 class='signature ro priv first'>
    #<strong>aead_mode</strong>   <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
    <span class='aliases'>Also known as: <span class='names'>#aead_mode?</span></span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L371-L371'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='371' data-end='371'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 371</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_aead_mode'>aead_mode</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="create_message-instance_method">
  <h3 class='signature nodoc'>
    #<strong>create_message</strong>(value, **options)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L256-L258'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='256' data-end='258'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 256</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_create_message'>create_message</span>(<span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>) <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_sign'><a href="#sign-instance_method" title="ActiveSupport::MessageEncryptor#sign (method)">sign</a></span>(<span class='id identifier rubyid_encrypt'><a href="#encrypt-instance_method" title="ActiveSupport::MessageEncryptor#encrypt (method)">encrypt</a></span>(<span class='id identifier rubyid_serialize_with_metadata'>serialize_with_metadata</span>(<span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>)))
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="decrypt-instance_method">
  <h3 class='signature priv'>
    #<strong>decrypt</strong>(encrypted_message)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L295-L318'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='295' data-end='318'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 295</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_decrypt'>decrypt</span>(<span class='id identifier rubyid_encrypted_message'>encrypted_message</span>)
  <span class='id identifier rubyid_cipher'>cipher</span> <span class='op'>=</span> <span class='id identifier rubyid_new_cipher'><a href="#new_cipher-instance_method" title="ActiveSupport::MessageEncryptor#new_cipher (method)">new_cipher</a></span>
  <span class='id identifier rubyid_encrypted_data'>encrypted_data</span><span class='comma'>,</span> <span class='id identifier rubyid_iv'>iv</span><span class='comma'>,</span> <span class='id identifier rubyid_auth_tag'>auth_tag</span> <span class='op'>=</span> <span class='id identifier rubyid_extract_parts'><a href="#extract_parts-instance_method" title="ActiveSupport::MessageEncryptor#extract_parts (method)">extract_parts</a></span>(<span class='id identifier rubyid_encrypted_message'>encrypted_message</span>)

  <span class='comment'># Currently the OpenSSL bindings do not raise an error if auth_tag is
</span>  <span class='comment'># truncated, which would allow an attacker to easily forge it. See
</span>  <span class='comment'># https://github.com/ruby/openssl/issues/63
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_aead_mode?'><a href="#aead_mode%3F-instance_method" title="ActiveSupport::MessageEncryptor#aead_mode? (method)">aead_mode?</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_auth_tag'>auth_tag</span>.<span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>!=</span> <span class='const'><a href="#AUTH_TAG_LENGTH-constant" title="ActiveSupport::MessageEncryptor::AUTH_TAG_LENGTH (constant)">AUTH_TAG_LENGTH</a></span>
    <span class='id identifier rubyid_throw'>throw</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invalid_message_format'>invalid_message_format</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>truncated auth_tag</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_decrypt'>decrypt</span>
  <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='ivar'>@secret</span>
  <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_iv'>iv</span>  <span class='op'>=</span> <span class='id identifier rubyid_iv'>iv</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_aead_mode?'><a href="#aead_mode%3F-instance_method" title="ActiveSupport::MessageEncryptor#aead_mode? (method)">aead_mode?</a></span>
    <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_auth_tag'>auth_tag</span> <span class='op'>=</span> <span class='id identifier rubyid_auth_tag'>auth_tag</span>
    <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_auth_data'>auth_data</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_decrypted_data'>decrypted_data</span> <span class='op'>=</span> <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_update'>update</span>(<span class='id identifier rubyid_encrypted_data'>encrypted_data</span>)
  <span class='id identifier rubyid_decrypted_data'>decrypted_data</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_final'>final</span>
<span class='kw'>rescue</span> <span class='const'><a href="#OpenSSLCipherError-constant" title="ActiveSupport::MessageEncryptor::OpenSSLCipherError (constant)">OpenSSLCipherError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
  <span class='id identifier rubyid_throw'>throw</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invalid_message_format'>invalid_message_format</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="decrypt_and_verify-instance_method">
  <h3 class='signature '>
    #<strong>decrypt_and_verify</strong>(message, **options)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Decrypt and verify a message. We need to verify the message in order to avoid padding attacks. Reference: <a href="https://www.limited-entropy.com/padding-oracle-attacks">www.limited-entropy.com/padding-oracle-attacks</a>/.</p>

<h4 id="label-Options">Options</h4>
<dl class="rdoc-list label-list"><dt><code>:purpose</code>
<dd>
<p>The purpose that the message was generated with. If the purpose does not match, <code>decrypt_and_verify</code> will return <code>nil</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_encrypt_and_sign'><a href="#encrypt_and_sign-instance_method" title="ActiveSupport::MessageEncryptor#encrypt_and_sign (method)">encrypt_and_sign</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>purpose:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greeting</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_decrypt_and_verify'>decrypt_and_verify</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='label'>purpose:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greeting</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># =&gt; &quot;hello&quot;
</span><span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_decrypt_and_verify'>decrypt_and_verify</span>(<span class='id identifier rubyid_message'>message</span>)                      <span class='comment'># =&gt; nil
</span>
<span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_encrypt_and_sign'><a href="#encrypt_and_sign-instance_method" title="ActiveSupport::MessageEncryptor#encrypt_and_sign (method)">encrypt_and_sign</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bye</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_decrypt_and_verify'>decrypt_and_verify</span>(<span class='id identifier rubyid_message'>message</span>)                      <span class='comment'># =&gt; &quot;bye&quot;
</span><span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_decrypt_and_verify'>decrypt_and_verify</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='label'>purpose:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greeting</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># =&gt; nil</span></code></pre>
</dd></dl>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L241-L249'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='241' data-end='249'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 241</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_decrypt_and_verify'>decrypt_and_verify</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>)
  <span class='id identifier rubyid_catch_and_raise'>catch_and_raise</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invalid_message_format'>invalid_message_format</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='const'><a href="MessageEncryptor/InvalidMessage.html" title="ActiveSupport::MessageEncryptor::InvalidMessage (class)">InvalidMessage</a></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_catch_and_raise'>catch_and_raise</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invalid_message_serialization'>invalid_message_serialization</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='const'><a href="MessageEncryptor/InvalidMessage.html" title="ActiveSupport::MessageEncryptor::InvalidMessage (class)">InvalidMessage</a></span> <span class='kw'>do</span>
      <span class='id identifier rubyid_catch_and_ignore'>catch_and_ignore</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invalid_message_content'>invalid_message_content</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_read_message'><a href="#read_message-instance_method" title="ActiveSupport::MessageEncryptor#read_message (method)">read_message</a></span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="encrypt-instance_method">
  <h3 class='signature priv'>
    #<strong>encrypt</strong>(data)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L277-L293'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='277' data-end='293'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 277</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_encrypt'>encrypt</span>(<span class='id identifier rubyid_data'>data</span>)
  <span class='id identifier rubyid_cipher'>cipher</span> <span class='op'>=</span> <span class='id identifier rubyid_new_cipher'><a href="#new_cipher-instance_method" title="ActiveSupport::MessageEncryptor#new_cipher (method)">new_cipher</a></span>
  <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_encrypt'>encrypt</span>
  <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='ivar'>@secret</span>

  <span class='comment'># Rely on OpenSSL for the initialization vector
</span>  <span class='id identifier rubyid_iv'>iv</span> <span class='op'>=</span> <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_random_iv'>random_iv</span>
  <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_auth_data'>auth_data</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_aead_mode?'><a href="#aead_mode%3F-instance_method" title="ActiveSupport::MessageEncryptor#aead_mode? (method)">aead_mode?</a></span>

  <span class='id identifier rubyid_encrypted_data'>encrypted_data</span> <span class='op'>=</span> <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_update'>update</span>(<span class='id identifier rubyid_data'>data</span>)
  <span class='id identifier rubyid_encrypted_data'>encrypted_data</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_final'>final</span>

  <span class='id identifier rubyid_parts'>parts</span> <span class='op'>=</span> [<span class='id identifier rubyid_encrypted_data'>encrypted_data</span><span class='comma'>,</span> <span class='id identifier rubyid_iv'>iv</span>]
  <span class='id identifier rubyid_parts'>parts</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_cipher'>cipher</span>.<span class='id identifier rubyid_auth_tag'>auth_tag</span>(<span class='const'><a href="#AUTH_TAG_LENGTH-constant" title="ActiveSupport::MessageEncryptor::AUTH_TAG_LENGTH (constant)">AUTH_TAG_LENGTH</a></span>) <span class='kw'>if</span> <span class='id identifier rubyid_aead_mode?'><a href="#aead_mode%3F-instance_method" title="ActiveSupport::MessageEncryptor#aead_mode? (method)">aead_mode?</a></span>

  <span class='id identifier rubyid_join_parts'><a href="#join_parts-instance_method" title="ActiveSupport::MessageEncryptor#join_parts (method)">join_parts</a></span>(<span class='id identifier rubyid_parts'>parts</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="encrypt_and_sign-instance_method">
  <h3 class='signature '>
    #<strong>encrypt_and_sign</strong>(value, **options)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Encrypt and sign a message. We need to sign the message in order to avoid padding attacks. Reference: <a href="https://www.limited-entropy.com/padding-oracle-attacks">www.limited-entropy.com/padding-oracle-attacks</a>/.</p>

<h4 id="label-Options">Options</h4>
<dl class="rdoc-list label-list"><dt><code>:expires_at</code>
<dd>
<p>The datetime at which the message expires. After this datetime, verification of the message will fail.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_encrypt_and_sign'>encrypt_and_sign</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>expires_at:</span> <span class='const'><a href="../Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span>.<span class='id identifier rubyid_tomorrow'>tomorrow</span>)
<span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='id identifier rubyid_message'>message</span>) <span class='comment'># =&gt; &quot;hello&quot;
</span><span class='comment'># 24 hours later...
</span><span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='id identifier rubyid_message'>message</span>) <span class='comment'># =&gt; nil</span></code></pre>
</dd><dt><code>:expires_in</code>
<dd>
<p>The duration for which the message is valid. After this duration has elapsed, verification of the message will fail.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_encrypt_and_sign'>encrypt_and_sign</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>expires_in:</span> <span class='int'>24</span>.<span class='id identifier rubyid_hours'>hours</span>)
<span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='id identifier rubyid_message'>message</span>) <span class='comment'># =&gt; &quot;hello&quot;
</span><span class='comment'># 24 hours later...
</span><span class='id identifier rubyid_encryptor'>encryptor</span>.<span class='id identifier rubyid_decrypt_and_verify'><a href="#decrypt_and_verify-instance_method" title="ActiveSupport::MessageEncryptor#decrypt_and_verify (method)">decrypt_and_verify</a></span>(<span class='id identifier rubyid_message'>message</span>) <span class='comment'># =&gt; nil</span></code></pre>
</dd><dt><code>:purpose</code>
<dd>
<p>The purpose of the message. If specified, the same purpose must be specified when verifying the message; otherwise, verification will fail. (See #decrypt_and_verify.)</p>
</dd></dl>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L220-L222'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='220' data-end='222'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 220</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_encrypt_and_sign'>encrypt_and_sign</span>(<span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>)
  <span class='id identifier rubyid_create_message'><a href="#create_message-instance_method" title="ActiveSupport::MessageEncryptor#create_message (method)">create_message</a></span>(<span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="extract_part-instance_method">
  <h3 class='signature priv'>
    #<strong>extract_part</strong>(encrypted_message, rindex, length)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L340-L348'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='340' data-end='348'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 340</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_extract_part'>extract_part</span>(<span class='id identifier rubyid_encrypted_message'>encrypted_message</span><span class='comma'>,</span> <span class='id identifier rubyid_rindex'>rindex</span><span class='comma'>,</span> <span class='id identifier rubyid_length'>length</span>)
  <span class='id identifier rubyid_index'>index</span> <span class='op'>=</span> <span class='id identifier rubyid_rindex'>rindex</span> <span class='op'>-</span> <span class='id identifier rubyid_length'>length</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_encrypted_message'>encrypted_message</span>[<span class='id identifier rubyid_index'>index</span> <span class='op'>-</span> <span class='const'><a href="#SEPARATOR-constant" title="ActiveSupport::MessageEncryptor::SEPARATOR (constant)">SEPARATOR</a></span>.<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='const'><a href="#SEPARATOR-constant" title="ActiveSupport::MessageEncryptor::SEPARATOR (constant)">SEPARATOR</a></span>.<span class='id identifier rubyid_length'>length</span>] <span class='op'>==</span> <span class='const'><a href="#SEPARATOR-constant" title="ActiveSupport::MessageEncryptor::SEPARATOR (constant)">SEPARATOR</a></span>
    <span class='id identifier rubyid_encrypted_message'>encrypted_message</span>[<span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='id identifier rubyid_length'>length</span>]
  <span class='kw'>else</span>
    <span class='id identifier rubyid_throw'>throw</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invalid_message_format'>invalid_message_format</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>missing separator</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="extract_parts-instance_method">
  <h3 class='signature priv'>
    #<strong>extract_parts</strong>(encrypted_message)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L350-L365'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='350' data-end='365'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 350</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_extract_parts'>extract_parts</span>(<span class='id identifier rubyid_encrypted_message'>encrypted_message</span>)
  <span class='id identifier rubyid_parts'>parts</span> <span class='op'>=</span> []
  <span class='id identifier rubyid_rindex'>rindex</span> <span class='op'>=</span> <span class='id identifier rubyid_encrypted_message'>encrypted_message</span>.<span class='id identifier rubyid_length'>length</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_aead_mode?'><a href="#aead_mode%3F-instance_method" title="ActiveSupport::MessageEncryptor#aead_mode? (method)">aead_mode?</a></span>
    <span class='id identifier rubyid_parts'>parts</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_extract_part'><a href="#extract_part-instance_method" title="ActiveSupport::MessageEncryptor#extract_part (method)">extract_part</a></span>(<span class='id identifier rubyid_encrypted_message'>encrypted_message</span><span class='comma'>,</span> <span class='id identifier rubyid_rindex'>rindex</span><span class='comma'>,</span> <span class='id identifier rubyid_length_of_encoded_auth_tag'><a href="#length_of_encoded_auth_tag-instance_method" title="ActiveSupport::MessageEncryptor#length_of_encoded_auth_tag (method)">length_of_encoded_auth_tag</a></span>)
    <span class='id identifier rubyid_rindex'>rindex</span> <span class='op'>-=</span> <span class='const'><a href="#SEPARATOR-constant" title="ActiveSupport::MessageEncryptor::SEPARATOR (constant)">SEPARATOR</a></span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='id identifier rubyid_length_of_encoded_auth_tag'><a href="#length_of_encoded_auth_tag-instance_method" title="ActiveSupport::MessageEncryptor#length_of_encoded_auth_tag (method)">length_of_encoded_auth_tag</a></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_parts'>parts</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_extract_part'><a href="#extract_part-instance_method" title="ActiveSupport::MessageEncryptor#extract_part (method)">extract_part</a></span>(<span class='id identifier rubyid_encrypted_message'>encrypted_message</span><span class='comma'>,</span> <span class='id identifier rubyid_rindex'>rindex</span><span class='comma'>,</span> <span class='id identifier rubyid_length_of_encoded_iv'><a href="#length_of_encoded_iv-instance_method" title="ActiveSupport::MessageEncryptor#length_of_encoded_iv (method)">length_of_encoded_iv</a></span>)
  <span class='id identifier rubyid_rindex'>rindex</span> <span class='op'>-=</span> <span class='const'><a href="#SEPARATOR-constant" title="ActiveSupport::MessageEncryptor::SEPARATOR (constant)">SEPARATOR</a></span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='id identifier rubyid_length_of_encoded_iv'><a href="#length_of_encoded_iv-instance_method" title="ActiveSupport::MessageEncryptor#length_of_encoded_iv (method)">length_of_encoded_iv</a></span>

  <span class='id identifier rubyid_parts'>parts</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_encrypted_message'>encrypted_message</span>[<span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_rindex'>rindex</span>]

  <span class='id identifier rubyid_parts'>parts</span>.<span class='id identifier rubyid_reverse!'>reverse!</span>.<span class='id identifier rubyid_map!'>map!</span> { <span class='op'>|</span><span class='id identifier rubyid_part'>part</span><span class='op'>|</span> <span class='id identifier rubyid_decode'>decode</span>(<span class='id identifier rubyid_part'>part</span>) }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="inspect-instance_method">
  <h3 class='signature nodoc'>
    #<strong>inspect</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L264-L266'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='264' data-end='266'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 264</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_inspect'>inspect</span> <span class='comment'># :nodoc:
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;</span><span class='embexpr_beg'>#{</span><span class='kw'>self</span>.<span class='id identifier rubyid_class'>class</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%#016x</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> (<span class='id identifier rubyid_object_id'>object_id</span> <span class='op'>&lt;&lt;</span> <span class='int'>1</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="join_parts-instance_method">
  <h3 class='signature priv'>
    #<strong>join_parts</strong>(parts)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L336-L338'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='336' data-end='338'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 336</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_join_parts'>join_parts</span>(<span class='id identifier rubyid_parts'>parts</span>)
  <span class='id identifier rubyid_parts'>parts</span>.<span class='id identifier rubyid_map!'>map!</span> { <span class='op'>|</span><span class='id identifier rubyid_part'>part</span><span class='op'>|</span> <span class='id identifier rubyid_encode'>encode</span>(<span class='id identifier rubyid_part'>part</span>) }.<span class='id identifier rubyid_join'>join</span>(<span class='const'><a href="#SEPARATOR-constant" title="ActiveSupport::MessageEncryptor::SEPARATOR (constant)">SEPARATOR</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="length_after_encode-instance_method">
  <h3 class='signature priv'>
    #<strong>length_after_encode</strong>(length_before_encode)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L320-L326'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='320' data-end='326'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 320</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_length_after_encode'>length_after_encode</span>(<span class='id identifier rubyid_length_before_encode'>length_before_encode</span>)
  <span class='kw'>if</span> <span class='ivar'>@url_safe</span>
    (<span class='int'>4</span> <span class='op'>*</span> <span class='id identifier rubyid_length_before_encode'>length_before_encode</span> <span class='op'>/</span> <span class='float'>3.0</span>).<span class='id identifier rubyid_ceil'>ceil</span> <span class='comment'># length without padding
</span>  <span class='kw'>else</span>
    <span class='int'>4</span> <span class='op'>*</span> (<span class='id identifier rubyid_length_before_encode'>length_before_encode</span> <span class='op'>/</span> <span class='float'>3.0</span>).<span class='id identifier rubyid_ceil'>ceil</span> <span class='comment'># length with padding
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="length_of_encoded_auth_tag-instance_method">
  <h3 class='signature priv'>
    #<strong>length_of_encoded_auth_tag</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L332-L334'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='332' data-end='334'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 332</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_length_of_encoded_auth_tag'>length_of_encoded_auth_tag</span>
  <span class='ivar'>@length_of_encoded_auth_tag</span> <span class='op'>||=</span> <span class='id identifier rubyid_length_after_encode'><a href="#length_after_encode-instance_method" title="ActiveSupport::MessageEncryptor#length_after_encode (method)">length_after_encode</a></span>(<span class='const'><a href="#AUTH_TAG_LENGTH-constant" title="ActiveSupport::MessageEncryptor::AUTH_TAG_LENGTH (constant)">AUTH_TAG_LENGTH</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="length_of_encoded_iv-instance_method">
  <h3 class='signature priv'>
    #<strong>length_of_encoded_iv</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L328-L330'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='328' data-end='330'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 328</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_length_of_encoded_iv'>length_of_encoded_iv</span>
  <span class='ivar'>@length_of_encoded_iv</span> <span class='op'>||=</span> <span class='id identifier rubyid_length_after_encode'><a href="#length_after_encode-instance_method" title="ActiveSupport::MessageEncryptor#length_after_encode (method)">length_after_encode</a></span>(<span class='id identifier rubyid_new_cipher'><a href="#new_cipher-instance_method" title="ActiveSupport::MessageEncryptor#new_cipher (method)">new_cipher</a></span>.<span class='id identifier rubyid_iv_len'>iv_len</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="new_cipher-instance_method">
  <h3 class='signature priv'>
    #<strong>new_cipher</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L367-L369'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='367' data-end='369'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 367</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_new_cipher'>new_cipher</span>
  <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Cipher</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="ActiveSupport::MessageEncryptor.new (method)">new</a></span>(<span class='ivar'>@cipher</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_message-instance_method">
  <h3 class='signature nodoc'>
    #<strong>read_message</strong>(message, **options)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L260-L262'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='260' data-end='262'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 260</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_message'>read_message</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>) <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_deserialize_with_metadata'>deserialize_with_metadata</span>(<span class='id identifier rubyid_decrypt'><a href="#decrypt-instance_method" title="ActiveSupport::MessageEncryptor#decrypt (method)">decrypt</a></span>(<span class='id identifier rubyid_verify'><a href="#verify-instance_method" title="ActiveSupport::MessageEncryptor#verify (method)">verify</a></span>(<span class='id identifier rubyid_message'>message</span>))<span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="sign-instance_method">
  <h3 class='signature priv'>
    #<strong>sign</strong>(data)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L269-L271'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='269' data-end='271'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 269</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_sign'>sign</span>(<span class='id identifier rubyid_data'>data</span>)
  <span class='ivar'>@verifier</span> <span class='op'>?</span> <span class='ivar'>@verifier</span>.<span class='id identifier rubyid_create_message'><a href="#create_message-instance_method" title="ActiveSupport::MessageEncryptor#create_message (method)">create_message</a></span>(<span class='id identifier rubyid_data'>data</span>) <span class='op'>:</span> <span class='id identifier rubyid_data'>data</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="verify-instance_method">
  <h3 class='signature priv'>
    #<strong>verify</strong>(data)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activesupport/lib/active_support/message_encryptor.rb#L273-L275'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='273' data-end='275'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activesupport/lib/active_support/message_encryptor.rb', line 273</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_verify'>verify</span>(<span class='id identifier rubyid_data'>data</span>)
  <span class='ivar'>@verifier</span> <span class='op'>?</span> <span class='ivar'>@verifier</span>.<span class='id identifier rubyid_read_message'><a href="#read_message-instance_method" title="ActiveSupport::MessageEncryptor#read_message (method)">read_message</a></span>(<span class='id identifier rubyid_data'>data</span>) <span class='op'>:</span> <span class='id identifier rubyid_data'>data</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>