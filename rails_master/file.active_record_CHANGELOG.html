<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Active Record CHANGELOG &mdash; Rails main</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "active_record_CHANGELOG",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails main</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Active Record CHANGELOG&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<ul>
<li><p>Add replicas to test database parallelization setup.</p>

<p>Setup and configuration of databases for parallel testing now includes replicas.</p>

<p>This fixes an issue when using a replica database, database selector middleware,
and non-transactional tests, where integration tests running in parallel would select
the base test database, i.e. <code>db_test</code>, instead of the numbered parallel worker database,
i.e. <code>db_test_{n}</code>.</p>

<p><em>Adam Maas</em></p></li>
<li><p>Support virtual (not persisted) generated columns on PostgreSQL 18+</p>

<p>PostgreSQL 18 introduces virtual (not persisted) generated columns,
which are now the default unless the <code>stored: true</code> option is explicitly specified on PostgreSQL 18+.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_virtual'>virtual</span> <span class='symbeg'>:</span><span class='id identifier rubyid_lower_name'>lower_name</span><span class='comma'>,</span>  <span class='label'>type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_string'>string</span><span class='comma'>,</span>  <span class='label'>as:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LOWER(name)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>stored:</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_virtual'>virtual</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name_length'>name_length</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_integer'>integer</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LENGTH(name)</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<p><em>Yasuo Honda</em></p></li>
<li><p>Optimize schema dumping to prevent duplicate file generation.</p>

<p><a href="ActiveRecord/Tasks/DatabaseTasks.html#dump_all-instance_method" title="ActiveRecord::Tasks::DatabaseTasks#dump_all (method)">ActiveRecord::Tasks::DatabaseTasks#dump_all</a> now tracks which schema files
have already been dumped and skips dumping the same file multiple times.
This improves performance when multiple database configurations share the
same schema dump path.</p>

<p><em>Mikey Gough</em>, <em>Hartley McGuire</em></p></li>
<li><p>Add structured events for Active Record:</p>

<ul>
<li><code>active_record.strict_loading_violation</code></li>
<li><code>active_record.sql</code></li>
</ul>

<p><em>Gannon McGibbon</em></p></li>
<li><p>Add support for integer shard keys.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Now accepts symbols as shard keys.
</span><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connects_to'><a href="ActiveRecord/ConnectionHandling.html#connects_to-instance_method" title="ActiveRecord::ConnectionHandling#connects_to (method)">connects_to</a></span>(<span class='label'>shards:</span> {
  <span class='int'>1</span><span class='op'>:</span> { <span class='label'>writing:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_shard_one'>primary_shard_one</span><span class='comma'>,</span> <span class='label'>reading:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_shard_one'>primary_shard_one</span> }<span class='comma'>,</span>
  <span class='int'>2</span><span class='op'>:</span> { <span class='label'>writing:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_shard_two'>primary_shard_two</span><span class='comma'>,</span> <span class='label'>reading:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_shard_two'>primary_shard_two</span>}<span class='comma'>,</span>
})

<span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to'><a href="ActiveRecord/ConnectionHandling.html#connected_to-instance_method" title="ActiveRecord::ConnectionHandling#connected_to (method)">connected_to</a></span>(<span class='label'>shard:</span> <span class='int'>1</span>) <span class='kw'>do</span>
  <span class='comment'># ..
</span><span class='kw'>end</span></code></pre>

<p><em>Nony Dutton</em></p></li>
<li><p>Add <code>ActiveRecord::Base.only_columns</code></p>

<p>Similar in use case to <code>ignored_columns</code> but listing columns to consider rather than the ones
to ignore.</p>

<p>Can be useful when working with a legacy or shared database schema, or to make safe schema change
in two deploys rather than three.</p>

<p><em>Anton Kandratski</em></p></li>
<li><p>Use <code>PG::Connection#close_prepared</code> (protocol level Close) to deallocate
prepared statements when available.</p>

<p>To enable its use, you must have pg &gt;= 1.6.0, libpq &gt;= 17, and a PostgreSQL
database version &gt;= 17.</p>

<p><em>Hartley McGuire</em>, <em>Andrew Jackson</em></p></li>
<li><p>Fix query cache for pinned connections in multi threaded transactional tests</p>

<p>When a pinned connection is used across separate threads, they now use a separate cache store
for each thread.</p>

<p>This improve accuracy of system tests, and any test using multiple threads.</p>

<p><em>Heinrich Lee Yu</em>, <em>Jean Boussier</em></p></li>
<li><p>Fix time attribute dirty tracking with timezone conversions.</p>

<p>Time-only attributes now maintain a fixed date of 2000-01-01 during timezone conversions,
preventing them from being incorrectly marked as changed due to date shifts.</p>

<p>This fixes an issue where time attributes would be marked as changed when setting the same time value
due to timezone conversion causing internal date shifts.</p>

<p><em>Prateek Choudhary</em></p></li>
<li><p>Skip calling <code>PG::Connection#cancel</code> in <code>cancel_any_running_query</code>
when using libpq &gt;= 18 with pg &lt; 1.6.0, due to incompatibility.
Rollback still runs, but may take longer.</p>

<p><em>Yasuo Honda</em>, <em>Lars Kanis</em></p></li>
<li><p>Don&#39;t add <code>id_value</code> attribute alias when attribute/column with that name already exists.</p>

<p><em>Rob Lewis</em></p></li>
</ul>

<h2>Rails 8.1.0.beta1 (September 04, 2025)</h2>

<ul>
<li><p>Remove deprecated <code>:unsigned_float</code> and <code>:unsigned_decimal</code> column methods for MySQL.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <code>:retries</code> option for the SQLite3 adapter.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Introduce new database configuration options <code>keepalive</code>, <code>max_age</code>, and
<code>min_connections</code> -- and rename <code>pool</code> to <code>max_connections</code> to match.</p>

<p>There are no changes to default behavior, but these allow for more specific
control over pool behavior.</p>

<p><em>Matthew Draper</em>, <em>Chris AtLee</em>, <em>Rachael Wright-Munn</em></p></li>
<li><p>Move <code>LIMIT</code> validation from query generation to when <code>limit()</code> is called.</p>

<p><em>Hartley McGuire</em>, <em>Shuyang</em></p></li>
<li><p>Add <a href="ActiveRecord/CheckViolation.html" title="ActiveRecord::CheckViolation (class)"><code>::ActiveRecord::CheckViolation</code></a> error class for check constraint violations.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Add <a href="ActiveRecord/ExclusionViolation.html" title="ActiveRecord::ExclusionViolation (class)"><code>::ActiveRecord::ExclusionViolation</code></a> error class for exclusion constraint violations.</p>

<p>When an exclusion constraint is violated in PostgreSQL, the error will now be raised
as <a href="ActiveRecord/ExclusionViolation.html" title="ActiveRecord::ExclusionViolation (class)"><code>::ActiveRecord::ExclusionViolation</code></a> instead of the generic <a href="ActiveRecord/StatementInvalid.html" title="ActiveRecord::StatementInvalid (class)"><code>::ActiveRecord::StatementInvalid</code></a>,
making it easier to handle these specific constraint violations in application code.</p>

<p>This follows the same pattern as other constraint violation error classes like
<code>RecordNotUnique</code> for unique constraint violations and <code>InvalidForeignKey</code> for
foreign key constraint violations.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Attributes filtered by <code>filter_attributes</code> will now also be filtered by <code>filter_parameters</code>
so sensitive information is not leaked.</p>

<p><em>Jill Klang</em></p></li>
<li><p>Add <code>connection.current_transaction.isolation</code> API to check current transaction&#39;s isolation level.</p>

<p>Returns the isolation level if it was explicitly set via the <code>isolation:</code> parameter
or through <a href="ActiveRecord.html#with_transaction_isolation_level-class_method" title="ActiveRecord.with_transaction_isolation_level (method)">ActiveRecord.with_transaction_isolation_level</a>, otherwise returns <code>nil</code>.
Nested transactions return the parent transaction&#39;s isolation level.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Returns nil when no transaction
</span><span class='const'>User</span>.<span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_current_transaction'>current_transaction</span>.<span class='id identifier rubyid_isolation'>isolation</span> <span class='comment'># =&gt; nil
</span>
<span class='comment'># Returns explicitly set isolation level
</span><span class='const'>User</span>.<span class='id identifier rubyid_transaction'>transaction</span>(<span class='label'>isolation:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_serializable'>serializable</span>) <span class='kw'>do</span>
  <span class='const'>User</span>.<span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_current_transaction'>current_transaction</span>.<span class='id identifier rubyid_isolation'>isolation</span> <span class='comment'># =&gt; :serializable
</span><span class='kw'>end</span>

<span class='comment'># Returns nil when isolation not explicitly set
</span><span class='const'>User</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
  <span class='const'>User</span>.<span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_current_transaction'>current_transaction</span>.<span class='id identifier rubyid_isolation'>isolation</span> <span class='comment'># =&gt; nil
</span><span class='kw'>end</span>

<span class='comment'># Nested transactions inherit parent&#39;s isolation
</span><span class='const'>User</span>.<span class='id identifier rubyid_transaction'>transaction</span>(<span class='label'>isolation:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_read_committed'>read_committed</span>) <span class='kw'>do</span>
  <span class='const'>User</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
    <span class='const'>User</span>.<span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_current_transaction'>current_transaction</span>.<span class='id identifier rubyid_isolation'>isolation</span> <span class='comment'># =&gt; :read_committed
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p><em>Kir Shatrov</em></p></li>
<li><p>Fix <code>#merge</code> with <code>#or</code> or <code>#and</code> and a mixture of attributes and SQL strings resulting in an incorrect query.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_base'>base</span> <span class='op'>=</span> <span class='const'>Comment</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span>).<span class='id identifier rubyid_where'>where</span>(<span class='label'>user_id:</span> <span class='int'>1</span>).<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>recent = 1</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_base'>base</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_base'>base</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>draft:</span> <span class='kw'>true</span>).<span class='id identifier rubyid_or'>or</span>(<span class='const'>Post</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>archived:</span> <span class='kw'>true</span>))).<span class='id identifier rubyid_to_sql'>to_sql</span></code></pre>

<p>Before:</p>

<pre class="code SQL"><code class="SQL">SELECT &quot;comments&quot;.* FROM &quot;comments&quot;
INNER JOIN &quot;posts&quot; ON &quot;posts&quot;.&quot;id&quot; = &quot;comments&quot;.&quot;post_id&quot;
WHERE (recent = 1)
AND (
  &quot;comments&quot;.&quot;user_id&quot; = 1
  AND (recent = 1)
  AND &quot;comments&quot;.&quot;draft&quot; = 1
  OR &quot;posts&quot;.&quot;archived&quot; = 1
)
</code></pre>

<p>After:</p>

<pre class="code SQL"><code class="SQL">SELECT &quot;comments&quot;.* FROM &quot;comments&quot;
INNER JOIN &quot;posts&quot; ON &quot;posts&quot;.&quot;id&quot; = &quot;comments&quot;.&quot;post_id&quot;
WHERE &quot;comments&quot;.&quot;user_id&quot; = 1
AND (recent = 1)
AND (
  &quot;comments&quot;.&quot;user_id&quot; = 1
  AND (recent = 1)
  AND &quot;comments&quot;.&quot;draft&quot; = 1
  OR &quot;posts&quot;.&quot;archived&quot; = 1
)
</code></pre>

<p><em>Joshua Young</em></p></li>
<li><p>Make schema dumper to account for <a href="ActiveRecord.html#dump_schemas-class_method" title="ActiveRecord.dump_schemas (method)">ActiveRecord.dump_schemas</a> when dumping in <code>:ruby</code> format.</p>

<p><em>fatkodima</em></p></li>
<li><p>Add <code>:touch</code> option to <code>update_column</code>/<code>update_columns</code> methods.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Will update :updated_at/:updated_on alongside :nice column.
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_update_column'>update_column</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_nice'>nice</span><span class='comma'>,</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>)

<span class='comment'># Will update :updated_at/:updated_on alongside :last_ip column
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_update_columns'>update_columns</span>(<span class='label'>last_ip:</span> <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_remote_ip'>remote_ip</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>)</code></pre>

<p><em>Dmitrii Ivliev</em></p></li>
<li><p>Optimize Active Record batching further when using ranges.</p>

<p>Tested on a PostgreSQL table with 10M records and batches of 10k records, the generation
of relations for the 1000 batches was <code>4.8x</code> faster (<code>6.8s</code> vs. <code>1.4s</code>), used <code>900x</code>
less bandwidth (<code>180MB</code> vs. <code>0.2MB</code>) and allocated <code>45x</code> less memory (<code>490MB</code> vs. <code>11MB</code>).</p>

<p><em>Maxime Réty</em>, <em>fatkodima</em></p></li>
<li><p>Include current character length in error messages for index and table name length validations.</p>

<p><em>Joshua Young</em></p></li>
<li><p>Add <code>rename_schema</code> method for PostgreSQL.</p>

<p><em>T S Vallender</em></p></li>
<li><p>Implement support for deprecating associations:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>deprecated:</span> <span class='kw'>true</span></code></pre>

<p>With that, Active Record will report any usage of the <code>posts</code> association.</p>

<p>Three reporting modes are supported (<code>:warn</code>, <code>:raise</code>, and <code>:notify</code>), and
backtraces can be enabled or disabled. Defaults are <code>:warn</code> mode and
disabled backtraces.</p>

<p>Please, check the docs for further details.</p>

<p><em>Xavier Noria</em></p></li>
<li><p>PostgreSQL adapter create DB now supports <code>locale_provider</code> and <code>locale</code>.</p>

<p><em>Bengt-Ove Hollaender</em></p></li>
<li><p>Use ntuples to populate row_count instead of count for Postgres</p>

<p><em>Jonathan Calvert</em></p></li>
<li><p>Fix checking whether an unpersisted record is <code>include?</code>d in a strictly
loaded <code>has_and_belongs_to_many</code> association.</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Add ability to change transaction isolation for all pools within a block.</p>

<p>This functionality is useful if your application needs to change the database
transaction isolation for a request or action.</p>

<p>Calling <code>ActiveRecord.with_transaction_isolation_level(level) {}</code> in an around filter or
middleware will set the transaction isolation for all pools accessed within the block,
but not for the pools that aren&#39;t.</p>

<p>This works with explicit and implicit transactions:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span>.<span class='id identifier rubyid_with_transaction_isolation_level'><a href="ActiveRecord.html#with_transaction_isolation_level-class_method" title="ActiveRecord.with_transaction_isolation_level (method)">with_transaction_isolation_level</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_read_committed'>read_committed</span>) <span class='kw'>do</span>
  <span class='const'>Tag</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span> <span class='comment'># opens a transaction explicitly
</span>    <span class='const'>Tag</span>.<span class='id identifier rubyid_create!'>create!</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span>.<span class='id identifier rubyid_with_transaction_isolation_level'><a href="ActiveRecord.html#with_transaction_isolation_level-class_method" title="ActiveRecord.with_transaction_isolation_level (method)">with_transaction_isolation_level</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_read_committed'>read_committed</span>) <span class='kw'>do</span>
  <span class='const'>Tag</span>.<span class='id identifier rubyid_create!'>create!</span> <span class='comment'># opens a transaction implicitly
</span><span class='kw'>end</span></code></pre>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Raise <a href="ActiveRecord/MissingRequiredOrderError.html" title="ActiveRecord::MissingRequiredOrderError (class)"><code>::ActiveRecord::MissingRequiredOrderError</code></a> when order dependent finder methods (e.g. <code>#first</code>, <code>#last</code>) are
called without <code>order</code> values on the relation, and the model does not have any order columns (<code>implicit_order_column</code>,
<code>query_constraints</code>, or <code>primary_key</code>) to fall back on.</p>

<p>This change will be introduced with a new framework default for Rails 8.1, and the current behavior of not raising
an error has been deprecated with the aim of removing the configuration option in Rails 8.2.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_raise_on_missing_required_finder_order_columns'>raise_on_missing_required_finder_order_columns</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p><em>Joshua Young</em></p></li>
<li><p><code>:class_name</code> is now invalid in polymorphic <code>belongs_to</code> associations.</p>

<p>Reason is <code>:class_name</code> does not make sense in those associations because
the class name of target records is dynamic and stored in the type column.</p>

<p>Existing polymorphic associations setting this option can just delete it.
While it did not raise, it had no effect anyway.</p>

<p><em>Xavier Noria</em></p></li>
<li><p>Add support for multiple databases to <code>db:migrate:reset</code>.</p>

<p><em>Joé Dupuis</em></p></li>
<li><p>Add <code>affected_rows</code> to <a href="ActiveRecord/Result.html" title="ActiveRecord::Result (class)"><code>::ActiveRecord::Result</code></a>.</p>

<p><em>Jenny Shen</em></p></li>
<li><p>Enable passing retryable SqlLiterals to <code>#where</code>.</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Set default for primary keys in <code>insert_all</code>/<code>upsert_all</code>.</p>

<p>Previously in Postgres, updating and inserting new records in one upsert wasn&#39;t possible
due to null primary key values. <code>nil</code> primary key values passed into <code>insert_all</code>/<code>upsert_all</code>
are now implicitly set to the default insert value specified by adapter.</p>

<p><em>Jenny Shen</em></p></li>
<li><p>Add a load hook <code>active_record_database_configurations</code> for <a href="ActiveRecord/DatabaseConfigurations.html" title="ActiveRecord::DatabaseConfigurations (class)"><code>::ActiveRecord::DatabaseConfigurations</code></a></p>

<p><em>Mike Dalessio</em></p></li>
<li><p>Use <code>TRUE</code> and <code>FALSE</code> for SQLite queries with boolean columns.</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Bump minimum supported SQLite to 3.23.0.</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Allow allocated Active Records to lookup associations.</p>

<p>Previously, the association cache isn&#39;t setup on allocated record objects, so association
lookups will crash. Test frameworks like mocha use allocate to check for stubbable instance
methods, which can trigger an association lookup.</p>

<p><em>Gannon McGibbon</em></p></li>
<li><p>Encryption now supports <code>support_unencrypted_data: true</code> being set per-attribute.</p>

<p>Previously this only worked if <code>ActiveRecord::Encryption.config.support_unencrypted_data == true</code>.
Now, if the global config is turned off, you can still opt in for a specific attribute.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># ActiveRecord::Encryption.config.support_unencrypted_data = true
</span><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>support_unencrypted_data:</span> <span class='kw'>false</span> <span class='comment'># only supports encrypted data
</span>  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span> <span class='comment'># supports encrypted or unencrypted data
</span><span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># ActiveRecord::Encryption.config.support_unencrypted_data = false
</span><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>support_unencrypted_data:</span> <span class='kw'>true</span> <span class='comment'># supports encrypted or unencrypted data
</span>  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span>  <span class='comment'># only supports encrypted data
</span><span class='kw'>end</span></code></pre>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Model generator no longer needs a database connection to validate column types.</p>

<p><em>Mike Dalessio</em></p></li>
<li><p>Allow signed ID verifiers to be configurable via <code>Rails.application.message_verifiers</code></p>

<p>Prior to this change, the primary way to configure signed ID verifiers was
to set <code>signed_id_verifier</code> on each model class:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='op'>=</span> <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/MessageVerifier.html" title="ActiveSupport::MessageVerifier (class)">MessageVerifier</a></span>.<span class='id identifier rubyid_new'><a href="ActiveSupport/MessageVerifier.html#new-class_method" title="ActiveSupport::MessageVerifier.new (method)">new</a></span>(<span class='op'>...</span>)
<span class='const'>Comment</span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='op'>=</span> <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/MessageVerifier.html" title="ActiveSupport::MessageVerifier (class)">MessageVerifier</a></span>.<span class='id identifier rubyid_new'><a href="ActiveSupport/MessageVerifier.html#new-class_method" title="ActiveSupport::MessageVerifier.new (method)">new</a></span>(<span class='op'>...</span>)</code></pre>

<p>And if the developer did not set <code>signed_id_verifier</code>, a verifier would be
instantiated with a secret derived from <code>secret_key_base</code> and the following
options:</p>

<pre class="code ruby"><code class="ruby">{ <span class='label'>digest:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SHA256</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>serializer:</span> <span class='const'>JSON</span><span class='comma'>,</span> <span class='label'>url_safe:</span> <span class='kw'>true</span> }</code></pre>

<p>Thus it was cumbersome to rotate configuration for all verifiers.</p>

<p>This change defines a new Rails config: [<code>config.active_record.use_legacy_signed_id_verifier</code>][].
The default value is <code>:generate_and_verify</code>, which preserves the previous
behavior. However, when set to <code>:verify</code>, signed ID verifiers will use
configuration from <code>Rails.application.message_verifiers</code> (specifically,
<code>Rails.application.message_verifiers["active_record/signed_id"]</code>) to
generate and verify signed IDs, but will also verify signed IDs using the
older configuration.</p>

<p>To avoid complication, the new behavior only applies when <code>signed_id_verifier_secret</code>
is not set on a model class or any of its ancestors. Additionally,
<code>signed_id_verifier_secret</code> is now deprecated. If you are currently setting
<code>signed_id_verifier_secret</code> on a model class, you can set <code>signed_id_verifier</code>
instead:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># BEFORE
</span><span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier_secret'>signed_id_verifier_secret</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my secret</span><span class='tstring_end'>&quot;</span></span>

<span class='comment'># AFTER
</span><span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='op'>=</span> <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/MessageVerifier.html" title="ActiveSupport::MessageVerifier (class)">MessageVerifier</a></span>.<span class='id identifier rubyid_new'><a href="ActiveSupport/MessageVerifier.html#new-class_method" title="ActiveSupport::MessageVerifier.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my secret</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>digest:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SHA256</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>serializer:</span> <span class='const'>JSON</span><span class='comma'>,</span> <span class='label'>url_safe:</span> <span class='kw'>true</span>)</code></pre>

<p>To ease migration, <code>signed_id_verifier</code> has also been changed to behave as a
<code>class_attribute</code> (i.e. inheritable), but <em>only when <code>signed_id_verifier_secret</code>
is not set</em>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># BEFORE
</span><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='op'>=</span> <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/MessageVerifier.html" title="ActiveSupport::MessageVerifier (class)">MessageVerifier</a></span>.<span class='id identifier rubyid_new'><a href="ActiveSupport/MessageVerifier.html#new-class_method" title="ActiveSupport::MessageVerifier.new (method)">new</a></span>(<span class='op'>...</span>)
<span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='op'>==</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='comment'># =&gt; false
</span>
<span class='comment'># AFTER
</span><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='op'>=</span> <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/MessageVerifier.html" title="ActiveSupport::MessageVerifier (class)">MessageVerifier</a></span>.<span class='id identifier rubyid_new'><a href="ActiveSupport/MessageVerifier.html#new-class_method" title="ActiveSupport::MessageVerifier.new (method)">new</a></span>(<span class='op'>...</span>)
<span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='op'>==</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='comment'># =&gt; true
</span>
<span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier_secret'>signed_id_verifier_secret</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my secret</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># =&gt; deprecation warning
</span><span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='op'>==</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='comment'># =&gt; false</span></code></pre>

<p>Note, however, that it is recommended to eventually migrate from
model-specific verifiers to a unified configuration managed by
<code>Rails.application.message_verifiers</code>. <code>ActiveSupport::MessageVerifier#rotate</code>
can facilitate that transition. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># BEFORE
</span><span class='comment'># Generate and verify signed Post IDs using Post-specific configuration
</span><span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='op'>=</span> <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/MessageVerifier.html" title="ActiveSupport::MessageVerifier (class)">MessageVerifier</a></span>.<span class='id identifier rubyid_new'><a href="ActiveSupport/MessageVerifier.html#new-class_method" title="ActiveSupport::MessageVerifier.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>post secret</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='op'>...</span>)

<span class='comment'># AFTER
</span><span class='comment'># Generate and verify signed Post IDs using the unified configuration
</span><span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span>.<span class='id identifier rubyid_dup'>dup</span>
<span class='comment'># Fall back to Post-specific configuration when verifying signed IDs
</span><span class='const'>Post</span>.<span class='id identifier rubyid_signed_id_verifier'>signed_id_verifier</span>.<span class='id identifier rubyid_rotate'>rotate</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>post secret</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='op'>...</span>)</code></pre>

<p>[<code>config.active_record.use_legacy_signed_id_verifier</code>]: <a href="https://guides.rubyonrails.org/v8.1/configuring.html#config-active-record-use-legacy-signed-id-verifier">https://guides.rubyonrails.org/v8.1/configuring.html#config-active-record-use-legacy-signed-id-verifier</a></p>

<p><em>Ali Sepehri</em>, <em>Jonathan Hefner</em></p></li>
<li><p>Prepend <code>extra_flags</code> in postgres&#39; <code>structure_load</code></p>

<p>When specifying <code>structure_load_flags</code> with a postgres adapter, the flags
were appended to the default flags, instead of prepended.
This caused issues with flags not being taken into account by postgres.</p>

<p><em>Alice Loeser</em></p></li>
<li><p>Allow bypassing primary key/constraint addition in <code>implicit_order_column</code></p>

<p>When specifying multiple columns in an array for <code>implicit_order_column</code>, adding
<code>nil</code> as the last element will prevent appending the primary key to order
conditions. This allows more precise control of indexes used by
generated queries. It should be noted that this feature does introduce the risk
of API misbehavior if the specified columns are not fully unique.</p>

<p><em>Issy Long</em></p></li>
<li><p>Allow setting the <code>schema_format</code> via database configuration.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_primary'>primary</span><span class='op'>:</span>
  <span class='id identifier rubyid_schema_format'>schema_format</span><span class='op'>:</span> <span class='id identifier rubyid_ruby'>ruby</span></code></pre>

<p>Useful for multi-database setups when apps require different formats per-database.</p>

<p><em>T S Vallender</em></p></li>
<li><p>Support disabling indexes for MySQL v8.0.0+ and MariaDB v10.6.0+</p>

<p>MySQL 8.0.0 added an option to disable indexes from being used by the query
optimizer by making them &quot;invisible&quot;. This allows the index to still be maintained
and updated but no queries will be permitted to use it. This can be useful for adding
new invisible indexes or making existing indexes invisible before dropping them
to ensure queries are not negatively affected.
See <a href="https://dev.mysql.com/blog-archive/mysql-8-0-invisible-indexes/">https://dev.mysql.com/blog-archive/mysql-8-0-invisible-indexes/</a> for more details.</p>

<p>MariaDB 10.6.0 also added support for this feature by allowing indexes to be &quot;ignored&quot;
in queries. See <a href="https://mariadb.com/kb/en/ignored-indexes/">https://mariadb.com/kb/en/ignored-indexes/</a> for more details.</p>

<p>Active Record now supports this option for MySQL 8.0.0+ and MariaDB 10.6.0+ for
index creation and alteration where the new index option <code>enabled: true/false</code> can be
passed to column and index methods as below:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>enabled:</span> <span class='kw'>false</span>
<span class='id identifier rubyid_enable_index'>enable_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span>
<span class='id identifier rubyid_add_column'>add_column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_dob'>dob</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_string'>string</span><span class='comma'>,</span> <span class='label'>index:</span> { <span class='label'>enabled:</span> <span class='kw'>false</span> }

<span class='id identifier rubyid_change_table'>change_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_index'>index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>enabled:</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_index'>index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_dob'>dob</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_disable_index'>disable_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_dob'>dob</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_column'>column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_string'>string</span><span class='comma'>,</span> <span class='label'>index:</span> { <span class='label'>enabled:</span> <span class='kw'>false</span> }
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_references'>references</span> <span class='symbeg'>:</span><span class='id identifier rubyid_account'>account</span><span class='comma'>,</span> <span class='label'>index:</span> { <span class='label'>enabled:</span> <span class='kw'>false</span> }
<span class='kw'>end</span>

<span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>index:</span> { <span class='label'>enabled:</span> <span class='kw'>false</span> }
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_index'>index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>enabled:</span> <span class='kw'>false</span>
<span class='kw'>end</span></code></pre>

<p><em>Merve Taner</em></p></li>
<li><p>Respect <code>implicit_order_column</code> in <code>ActiveRecord::Relation#reverse_order</code>.</p>

<p><em>Joshua Young</em></p></li>
<li><p>Add column types to <a href="ActiveRecord/Result.html" title="ActiveRecord::Result (class)"><code>::ActiveRecord::Result</code></a> for SQLite3.</p>

<p><em>Andrew Kane</em></p></li>
<li><p>Raise <a href="ActiveRecord/ReadOnlyError.html" title="ActiveRecord::ReadOnlyError (class)"><code>::ActiveRecord::ReadOnlyError</code></a> when pessimistically locking with a readonly role.</p>

<p><em>Joshua Young</em></p></li>
<li><p>Fix using the <code>SQLite3Adapter</code>&#39;s <code>dbconsole</code> method outside of a <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> application.</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Fix migrating multiple databases with <code>ActiveRecord::PendingMigration</code> action.</p>

<p><em>Gannon McGibbon</em></p></li>
<li><p>Enable automatically retrying idempotent association queries on connection
errors.</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Add <code>allow_retry</code> to <code>sql.active_record</code> instrumentation.</p>

<p>This enables identifying queries which queries are automatically retryable on connection errors.</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Better support UPDATE with JOIN for Postgresql and SQLite3</p>

<p>Previously when generating update queries with one or more JOIN clauses,
Active Record would use a sub query which would prevent to reference the joined
tables in the <code>SET</code> clause, for instance:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Comment</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span>).<span class='id identifier rubyid_update_all'>update_all</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title = posts.title</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>This is now supported as long as the relation doesn&#39;t also use a <code>LIMIT</code>, <code>ORDER</code> or
<code>GROUP BY</code> clause. This was supported by the MySQL adapter for a long time.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Introduce a before-fork hook in <a href="ActiveSupport/Testing/Parallelization.html" title="ActiveSupport::Testing::Parallelization (class)"><code>::ActiveSupport::Testing::Parallelization</code></a> to clear existing
connections, to avoid fork-safety issues with the mysql2 adapter.</p>

<p>Fixes #41776</p>

<p><em>Mike Dalessio</em>, <em>Donal McBreen</em></p></li>
<li><p>PoolConfig no longer keeps a reference to the connection class.</p>

<p>Keeping a reference to the class caused subtle issues when combined with reloading in
development. Fixes #54343.</p>

<p><em>Mike Dalessio</em></p></li>
<li><p>Fix SQL notifications sometimes not sent when using async queries.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_async_count'>async_count</span>
<span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/Notifications.html" title="ActiveSupport::Notifications (module)">Notifications</a></span>.<span class='id identifier rubyid_subscribed'><a href="ActiveSupport/Notifications.html#subscribed-class_method" title="ActiveSupport::Notifications.subscribed (method)">subscribed</a></span>(<span class='tlambda'>-&gt;</span>(<span class='op'>*</span>) <span class='tlambeg'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Will never reach here</span><span class='tstring_end'>&quot;</span></span> }) <span class='kw'>do</span>
  <span class='const'>Post</span>.<span class='id identifier rubyid_count'>count</span>
<span class='kw'>end</span></code></pre>

<p>In rare circumstances and under the right race condition, Active Support notifications
would no longer be dispatched after using an asynchronous query.
This is now fixed.</p>

<p><em>Edouard Chin</em></p></li>
<li><p>Eliminate queries loading dumped schema cache on Postgres</p>

<p>Improve resiliency by avoiding needing to open a database connection to load the
type map while defining attribute methods at boot when a schema cache file is
configured on PostgreSQL databases.</p>

<p><em>James Coleman</em></p></li>
<li><p><code>ActiveRecord::Coder::JSON</code> can be instantiated</p>

<p>Options can now be passed to <code>ActiveRecord::Coder::JSON</code> when instantiating the coder. This allows:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_serialize'>serialize</span> <span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span><span class='comma'>,</span> <span class='label'>coder:</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'>Coder</span><span class='op'>::</span><span class='const'>JSON</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>symbolize_names:</span> <span class='kw'>true</span>)</code></pre>

<p><em>matthaigh27</em></p></li>
<li><p>Deprecate using <code>insert_all</code>/<code>upsert_all</code> with unpersisted records in associations.</p>

<p>Using these methods on associations containing unpersisted records will now
show a deprecation warning, as the unpersisted records will be lost after
the operation.</p>

<p><em>Nick Schwaderer</em></p></li>
<li><p>Make column name optional for <code>index_exists?</code>.</p>

<p>This aligns well with <code>remove_index</code> signature as well, where
index name doesn&#39;t need to be derived from the column names.</p>

<p><em>Ali Ismayiliov</em></p></li>
<li><p>Change the payload name of <code>sql.active_record</code> notification for eager
loading from &quot;SQL&quot; to &quot;#<code>model.name</code> Eager Load&quot;.</p>

<p><em>zzak</em></p></li>
<li><p>Enable automatically retrying idempotent <code>#exists?</code> queries on connection
errors.</p>

<p><em>Hartley McGuire</em>, <em>classidied</em></p></li>
<li><p>Deprecate usage of unsupported methods in conjunction with <code>update_all</code>:</p>

<p><code>update_all</code> will now print a deprecation message if a query includes either <code>WITH</code>,
<code>WITH RECURSIVE</code> or <code>DISTINCT</code> statements. Those were never supported and were ignored
when generating the SQL query.</p>

<p>An error will be raised in a future Rails release. This behavior will be consistent
with <code>delete_all</code> which currently raises an error for unsupported statements.</p>

<p><em>Edouard Chin</em></p></li>
<li><p>The table columns inside <code>schema.rb</code> are now sorted alphabetically.</p>

<p>Previously they&#39;d be sorted by creation order, which can cause merge conflicts when two
branches modify the same table concurrently.</p>

<p><em>John Duff</em></p></li>
<li><p>Introduce versions formatter for the schema dumper.</p>

<p>It is now possible to override how schema dumper formats versions information inside the
<code>structure.sql</code> file. Currently, the versions are simply sorted in the decreasing order.
Within large teams, this can potentially cause many merge conflicts near the top of the list.</p>

<p>Now, the custom formatter can be provided with a custom sorting logic (e.g. by hash values
of the versions), which can greatly reduce the number of conflicts.</p>

<p><em>fatkodima</em></p></li>
<li><p>Serialized attributes can now be marked as comparable.</p>

<p>A not rare issue when working with serialized attributes is that the serialized representation of an object
can change over time. Either because you are migrating from one serializer to the other (e.g. YAML to JSON or to msgpack),
or because the serializer used subtly changed its output.</p>

<p>One example is libyaml that used to have some extra trailing whitespaces, and recently fixed that.
When this sorts of thing happen, you end up with lots of records that report being changed even though
they aren&#39;t, which in the best case leads to a lot more writes to the database and in the worst case lead to nasty bugs.</p>

<p>The solution is to instead compare the deserialized representation of the object, however Active Record
can&#39;t assume the deserialized object has a working <code>==</code> method. Hence why this new functionality is opt-in.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_serialize'>serialize</span> <span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Hash.html" title="Hash (class)">Hash</a></span><span class='comma'>,</span> <span class='label'>coder:</span> <span class='const'>JSON</span><span class='comma'>,</span> <span class='label'>comparable:</span> <span class='kw'>true</span></code></pre>

<p><em>Jean Boussier</em></p></li>
<li><p>Fix MySQL default functions getting dropped when changing a column&#39;s nullability.</p>

<p><em>Bastian Bartmann</em></p></li>
<li><p>SQLite extensions can be configured in <code>config/database.yml</code>.</p>

<p>The database configuration option <code>extensions:</code> allows an application to load SQLite extensions
when using <code>sqlite3</code> &gt;= v2.4.0. The array members may be filesystem paths or the names of
modules that respond to <code>.to_path</code>:</p>

<pre class="code yaml"><code class="yaml">development:
  adapter: sqlite3
  extensions:
    - SQLean::UUID                     # module name responding to `.to_path`
    - .sqlpkg/nalgeon/crypto/crypto.so # or a filesystem path
    - &lt;%= AppExtensions.location %&gt;    # or ruby code returning a path
</code></pre>

<p><em>Mike Dalessio</em></p></li>
<li><p><a href="ActiveRecord/Middleware/ShardSelector.html" title="ActiveRecord::Middleware::ShardSelector (class)"><code>::ActiveRecord::Middleware::ShardSelector</code></a> supports granular database connection switching.</p>

<p>A new configuration option, <code>class_name:</code>, is introduced to
<code>config.active_record.shard_selector</code> to allow an application to specify the abstract connection
class to be switched by the shard selection middleware. The default class is
<a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a>.</p>

<p>For example, this configuration tells <code>ShardSelector</code> to switch shards using
<code>AnimalsRecord.connected_to</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_shard_selector'>shard_selector</span> <span class='op'>=</span> { <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>AnimalsRecord</span><span class='tstring_end'>&quot;</span></span> }</code></pre>

<p><em>Mike Dalessio</em></p></li>
<li><p>Reset relations after <code>insert_all</code>/<code>upsert_all</code>.</p>

<p>Bulk insert/upsert methods will now call <code>reset</code> if used on a relation, matching the behavior of <code>update_all</code>.</p>

<p><em>Milo Winningham</em></p></li>
<li><p>Use <code>_N</code> as a parallel tests databases suffixes</p>

<p>Peviously, <code>-N</code> was used as a suffix. This can cause problems for RDBMSes
which do not support dashes in database names.</p>

<p><em>fatkodima</em></p></li>
<li><p>Remember when a database connection has recently been verified (for
two seconds, by default), to avoid repeated reverifications during a
single request.</p>

<p>This should recreate a similar rate of verification as in Rails 7.1,
where connections are leased for the duration of a request, and thus
only verified once.</p>

<p><em>Matthew Draper</em></p></li>
<li><p>Allow to reset cache counters for multiple records.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Aircraft</span>.<span class='id identifier rubyid_reset_counters'>reset_counters</span>([<span class='int'>1</span><span class='comma'>,</span> <span class='int'>2</span><span class='comma'>,</span> <span class='int'>3</span>]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_wheels_count'>wheels_count</span>)</code></pre>

<p>It produces much fewer queries compared to the custom implementation using looping over ids.
Previously: <code>O(ids.size * counters.size)</code> queries, now: <code>O(ids.size + counters.size)</code> queries.</p>

<p><em>fatkodima</em></p></li>
<li><p>Add <code>affected_rows</code> to <code>sql.active_record</code> Notification.</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Fix <code>sum</code> when performing a grouped calculation.</p>

<p><code>User.group(:friendly).sum</code> no longer worked. This is fixed.</p>

<p><em>Edouard Chin</em></p></li>
<li><p>Add support for enabling or disabling transactional tests per database.</p>

<p>A test class can now override the default <code>use_transactional_tests</code> setting
for individual databases, which can be useful if some databases need their
current state to be accessible to an external process while tests are running.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MostlyTransactionalTest</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/TestCase.html" title="ActiveSupport::TestCase (class)">TestCase</a></span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_use_transactional_tests'>use_transactional_tests</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_skip_transactional_tests_for_database'>skip_transactional_tests_for_database</span> <span class='symbeg'>:</span><span class='id identifier rubyid_shared'>shared</span>
<span class='kw'>end</span></code></pre>

<p><em>Matthew Cheetham</em>, <em>Morgan Mareve</em></p></li>
<li><p>Cast <code>query_cache</code> value when using URL configuration.</p>

<p><em>zzak</em></p></li>
<li><p>NULLS NOT DISTINCT works with UNIQUE CONSTRAINT as well as UNIQUE INDEX.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p><code>PG::UnableToSend: no connection to the server</code> is now retryable as a connection-related exception</p>

<p><em>Kazuma Watanabe</em></p></li>
</ul>

<p>Please check [8-0-stable]) for previous changes.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>