<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Active Record CHANGELOG &mdash; Rails main</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "active_record_CHANGELOG",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails main</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Active Record CHANGELOG&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<ul>
<li><p>Pass sql query to query log tags.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_query_log_tags'>query_log_tags</span> <span class='op'>=</span> [
  <span class='label'>sql_length:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_context'>context</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_context'>context</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_sql'>sql</span>].<span class='id identifier rubyid_length'>length</span> }
]</code></pre>

<p><em>fatkodima</em></p></li>
<li><p>Speedup <a href="ActiveRecord/Migration.html#maintain_test_schema!-class_method" title="ActiveRecord::Migration.maintain_test_schema! (method)">ActiveRecord::Migration.maintain_test_schema!</a> when using multiple databases.</p>

<p>Previously, Active Record would inneficiently connect twice to each databases, now it only
connects once per database to reverify the schema.</p>

<p><em>Iliana Hadzhiatanasova</em></p></li>
<li><p>Add <code>unique_by</code> option to <code>insert_all!</code>.</p>

<p><em>Chedli Bourguiba</em></p></li>
<li><p>Fix PostgreSQL schema dumping to handle schema-qualified table names in foreign_key references that span different schemas.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># before
</span><span class='id identifier rubyid_add_foreign_key'>add_foreign_key</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hst.event_log_attributes</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hst.event_logs</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># emits correctly because they&#39;re in the same schema (hst)
</span><span class='id identifier rubyid_add_foreign_key'>add_foreign_key</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hst.event_log_attributes</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hst.usr.user_profiles</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>column:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>created_by_id</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># emits hst.user.* when user.* is expected
</span>
<span class='comment'># after
</span><span class='id identifier rubyid_add_foreign_key'>add_foreign_key</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hst.event_log_attributes</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hst.event_logs</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_add_foreign_key'>add_foreign_key</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hst.event_log_attributes</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>usr.user_profiles</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>column:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>created_by_id</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p><em>Chiperific</em></p></li>
<li><p>Add <code>PostgreSQLAdapter.register_type_mapping</code> for custom SQL type registration.</p>

<p>Third-party gems can now register custom type mappings without prepending
internal methods:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/ConnectionAdapters.html" title="ActiveRecord::ConnectionAdapters (module)">ConnectionAdapters</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/ConnectionAdapters/PostgreSQLAdapter.html" title="ActiveRecord::ConnectionAdapters::PostgreSQLAdapter (class)">PostgreSQLAdapter</a></span>.<span class='id identifier rubyid_register_type_mapping'><a href="ActiveRecord/ConnectionAdapters/PostgreSQLAdapter.html#register_type_mapping-class_method" title="ActiveRecord::ConnectionAdapters::PostgreSQLAdapter.register_type_mapping (method)">register_type_mapping</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_type_map'>type_map</span><span class='op'>|</span>
  <span class='id identifier rubyid_type_map'>type_map</span>.<span class='id identifier rubyid_register_type'>register_type</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>geometry</span><span class='tstring_end'>&quot;</span></span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_oid'>oid</span><span class='comma'>,</span> <span class='id identifier rubyid_fmod'>fmod</span><span class='comma'>,</span> <span class='id identifier rubyid_sql_type'>sql_type</span><span class='op'>|</span>
    <span class='const'>MyGeometryType</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_sql_type'>sql_type</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Callbacks execute in registration order.</p>

<p><em>Abdelkader Boudih</em></p></li>
<li><p>Yield the transaction object to the block when using <code>with_lock</code>.</p>

<p><em>Ngan Pham</em></p></li>
<li><p>Fix bug when <code>current_transaction.isolation</code> would not have been reset in test env.</p>

<p>Additionally, extending the change in <a href="https://github.com/rails/rails/pull/55549">#55549</a>
to handle <code>requires_new: true</code>.</p>

<p><em>Kir Shatrov</em></p></li>
<li><p>Allow <code>schema_dump</code> configuration to be an absolute path.</p>

<p>Previously, the <code>schema_dump</code> configuration was always joined with the
<code>db_dir</code> path. Now, if an absolute path is provided, it will be used as-is.</p>

<p><em>Mike Dalessio</em></p></li>
<li><p>Decode PostgreSQL bytea and money columns when they appear in direct
query results.</p>

<p>bytea columns are now decoded to binary-encoded Strings, and money columns
are decoded to BigDecimal instead of String.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connection'><a href="ActiveRecord/ConnectionHandling.html#connection-instance_method" title="ActiveRecord::ConnectionHandling#connection (method)">connection</a></span>
     .<span class='id identifier rubyid_select_value'>select_value</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>select &#39;\\x48656c6c6f&#39;::bytea</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_encoding'>encoding</span> <span class='comment'>#=&gt; Encoding::BINARY
</span>
<span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connection'><a href="ActiveRecord/ConnectionHandling.html#connection-instance_method" title="ActiveRecord::ConnectionHandling#connection (method)">connection</a></span>
     .<span class='id identifier rubyid_select_value'>select_value</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>select &#39;12.34&#39;::money</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; BigDecimal</span></code></pre>

<p><em>Matthew Draper</em></p></li>
<li><p>Add support for configuring migration strategy on a per-adapter basis.</p>

<p><code>migration_strategy</code> can now be set on individual adapter classes, overriding
the global <a href="ActiveRecord.html#migration_strategy-class_method" title="ActiveRecord.migration_strategy (method)">ActiveRecord.migration_strategy</a>. This allows individual databases to
customize migration execution logic:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CustomPostgresStrategy</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Migration.html" title="ActiveRecord::Migration (class)">Migration</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Migration/DefaultStrategy.html" title="ActiveRecord::Migration::DefaultStrategy (class)">DefaultStrategy</a></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_drop_table'>drop_table</span>(<span class='op'>*</span>)
    <span class='comment'># Custom logic specific to PostgreSQL
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/ConnectionAdapters.html" title="ActiveRecord::ConnectionAdapters (module)">ConnectionAdapters</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/ConnectionAdapters/PostgreSQLAdapter.html" title="ActiveRecord::ConnectionAdapters::PostgreSQLAdapter (class)">PostgreSQLAdapter</a></span>.<span class='id identifier rubyid_migration_strategy'><a href="ActiveRecord/ConnectionAdapters/AbstractAdapter.html#migration_strategy-class_method" title="ActiveRecord::ConnectionAdapters::AbstractAdapter.migration_strategy (method)">migration_strategy</a></span> <span class='op'>=</span> <span class='const'>CustomPostgresStrategy</span></code></pre>

<p><em>Adrianna Chang</em></p></li>
<li><p>Allow either explain format syntax for EXPLAIN queries.</p>

<p>MySQL uses FORMAT=JSON whereas Postgres uses FORMAT JSON. We should be
able to accept both formats as options.</p>

<p><em>Gannon McGibbon</em></p></li>
<li><p>On MySQL parallel test database table reset to use <code>DELETE</code> instead of <code>TRUNCATE</code>.</p>

<p>Truncating on MySQL is very slow even on empty or nearly empty tables.</p>

<p>As a result of this change auto increment counters are now no longer reset between test
runs on MySQL and the <code>SKIP_TEST_DATABASE_TRUNCATE</code> environment variable no longer has
any effect.</p>

<p><em>Donal McBreen</em></p></li>
<li><p>Fix inconsistency in PostgreSQL handling of unbounded time range types</p>

<p>Use <code>-infinity</code> rather than <code>NULL</code> for the lower value of PostgreSQL time
ranges when saving records with a Ruby range that begins with <code>nil</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_products'>products</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_tsrange'>tsrange</span> <span class='symbeg'>:</span><span class='id identifier rubyid_period'>period</span>
<span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Product</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span><span class='semicolon'>;</span> <span class='kw'>end</span>

<span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_utc'>utc</span>(<span class='int'>2000</span>)

<span class='const'>Product</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>period:</span> <span class='id identifier rubyid_t'>t</span><span class='op'>...</span><span class='kw'>nil</span>)
<span class='const'>Product</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>period:</span> <span class='kw'>nil</span><span class='op'>...</span><span class='id identifier rubyid_t'>t</span>)</code></pre>

<p>Previously this would create two records using different values to represent
lower-unbounded and upper-unbounded ranges.</p>

<pre class="code ruby"><code class="ruby">[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>2000-01-01 00:00:00</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='id identifier rubyid_infinity'>infinity</span>)
(<span class='const'>NULL</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>2000-01-01 00:00:00</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>Now both will use <code>-infinity</code>/<code>infinity</code> which are handled differently than
<code>NULL</code> by some PostgreSQL range operators (e.g., <code>lower_inf</code>) and support
both exclusive and inclusive bounds.</p>

<pre class="code ruby"><code class="ruby">[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>2000-01-01 00:00:00</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='id identifier rubyid_infinity'>infinity</span>)
[<span class='op'>-</span><span class='id identifier rubyid_infinity'>infinity</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>2000-01-01 00:00:00</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p><em>Martin-Alexander</em></p></li>
<li><p>Database-specific shard swap prohibition</p>

<p>In #43485 (v7.0.0), shard swapping prohibition was introduced as a global
switch that applied to all databases.</p>

<p>For the use case of a multi-database application, the global prohibition is
overly broad, and so with this change the method <code>prohibit_shard_swapping</code>
will scope the prohibition to the same connection class (i.e.,
<code>connection_specification_name</code>). This allows an application to prohibit
shard swapping on a specific database while allowing it on all others.</p>

<p><em>Mike Dalessio</em></p></li>
<li><p>Fix upsert_all when using repeated timestamp attributes.</p>

<p><em>Gannon McGibbon</em></p></li>
<li><p>PostgreSQL enable drop database FORCE option.</p>

<p>One of the benefits of developing with MySQL is that it allows dropping the
current database without first disconnecting clients. As a result developers
can use <code>bin/rails db:reset</code> and similar, without first shutting down
instances of the app, Rails consoles, background workers, etc. By default
PostgreSQL fails to drop a database when clients are connected and displays
the following error:</p>

<blockquote>
<p>PG::ObjectInUse: ERROR:  database &quot;xyz&quot; is being accessed by other users (PG::ObjectInUse)</p>
</blockquote>

<p>This is frustrating when working in development where the database may be
dropped frequently.</p>

<p>PostgreSQL 13 added the <code>FORCE</code> option to the <code>DROP DATABASE</code> statement
(<a href="https://www.postgresql.org/docs/current/sql-dropdatabase.html">PostgreSQL docs</a>)
which automatically disconnects clients before dropping the database.
This option is automatically enabled for supported PostgreSQL versions.</p>

<p><em>Steven Webb</em></p></li>
<li><p>Raise specific exception when a prohibited shard change is attempted.</p>

<p>The new <code>ShardSwapProhibitedError</code> exception allows applications and
connection-related libraries to more easily recover from this specific
scenario. Previously an <code>ArgumentError</code> was raised, so the new exception
subclasses <code>ArgumentError</code> for backwards compatibility.</p>

<p><em>Mike Dalessio</em></p></li>
<li><p>Fix SQLite3 data loss during table alterations with CASCADE foreign keys.</p>

<p>When altering a table in SQLite3 that is referenced by child tables with
<code>ON DELETE CASCADE</code> foreign keys, ActiveRecord would silently delete all
data from the child tables. This occurred because SQLite requires table
recreation for schema changes, and during this process the original table
is temporarily dropped, triggering CASCADE deletes on child tables.</p>

<p>The root cause was incorrect ordering of operations. The original code
wrapped <code>disable_referential_integrity</code> inside a transaction, but
<code>PRAGMA foreign_keys</code> cannot be modified inside a transaction in SQLite -
attempting to do so simply has no effect. This meant foreign keys remained
enabled during table recreation, causing CASCADE deletes to fire.</p>

<p>The fix reverses the order to follow the official SQLite 12-step ALTER TABLE
procedure: <code>disable_referential_integrity</code> now wraps the transaction instead
of being wrapped by it. This ensures foreign keys are properly disabled
before the transaction starts and re-enabled after it commits, preventing
CASCADE deletes while maintaining data integrity through atomic transactions.</p>

<p><em>Ruy Rocha</em></p></li>
<li><p>Fix negative scopes for enums to include records with <code>nil</code> values.</p>

<p><em>fatkodima</em></p></li>
<li><p>Improve support for SQLite database URIs.</p>

<p>The <code>db:create</code> and <code>db:drop</code> tasks now correctly handle SQLite database URIs, and the
SQLite3Adapter will create the parent directory if it does not exist.</p>

<p><em>Mike Dalessio</em></p></li>
</ul>

<p>Please check [8-1-stable]) for previous changes.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>