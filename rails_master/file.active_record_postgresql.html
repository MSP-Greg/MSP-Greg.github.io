<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Active Record Postgresql &mdash; Rails main</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "active_record_postgresql",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails main</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Active Record Postgresql&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1>Active Record and PostgreSQL</h1>

<p>This guide covers PostgreSQL specific usage of Active Record.</p>

<p>After reading this guide, you will know:</p>

<ul>
<li>How to use PostgreSQL&#39;s datatypes.</li>
<li>How to use UUID primary keys.</li>
<li>How to include non-key columns in indexes.</li>
<li>How to use deferrable foreign keys.</li>
<li>How to use unique constraints.</li>
<li>How to implement exclusion constraints.</li>
<li>How to implement full text search with PostgreSQL.</li>
<li>How to back your Active Record models with database views.</li>
</ul>

<hr>

<p>In order to use the PostgreSQL adapter you need to have at least version 9.3
installed. Older versions are not supported.</p>

<p>To get started with PostgreSQL have a look at the
<a href="configuring.html#configuring-a-postgresql-database">configuring <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> guide</a>.
It describes how to properly set up Active Record for PostgreSQL.</p>

<h2>Datatypes</h2>

<p>PostgreSQL offers a number of specific datatypes. Following is a list of types,
that are supported by the PostgreSQL adapter.</p>

<h3>Bytea</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-binary.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-binarystring.html">functions and operators</a></li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20140207133952_create_documents.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_documents'>documents</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_binary'>binary</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>payload</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/document.rb
</span><span class='kw'>class</span> <span class='const'>Document</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># Usage
</span><span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_read'>read</span>(<span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_root'><a href="Rails.html#root-class_method" title="Rails.root (method)">root</a></span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tmp/output.pdf</span><span class='tstring_end'>&quot;</span></span>)
<span class='const'>Document</span>.<span class='id identifier rubyid_create'>create</span> <span class='label'>payload:</span> <span class='id identifier rubyid_data'>data</span></code></pre>

<h3>Array</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/arrays.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-array.html">functions and operators</a></li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20140207133952_create_books.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tags</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>array:</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_integer'>integer</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ratings</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>array:</span> <span class='kw'>true</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tags'>tags</span><span class='comma'>,</span> <span class='label'>using:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gin</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_ratings'>ratings</span><span class='comma'>,</span> <span class='label'>using:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gin</span><span class='tstring_end'>&quot;</span></span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/book.rb
</span><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># Usage
</span><span class='const'>Book</span>.<span class='id identifier rubyid_create'>create</span> <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Brave New World</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
            <span class='label'>tags:</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fantasy</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fiction</span><span class='tstring_end'>&quot;</span></span>]<span class='comma'>,</span>
            <span class='label'>ratings:</span> [<span class='int'>4</span><span class='comma'>,</span> <span class='int'>5</span>]

<span class='comment'>## Books for a single tag
</span><span class='const'>Book</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;fantasy&#39; = ANY (tags)</span><span class='tstring_end'>&quot;</span></span>)

<span class='comment'>## Books for multiple tags
</span><span class='const'>Book</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tags @&gt; ARRAY[?]::varchar[]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fantasy</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fiction</span><span class='tstring_end'>&quot;</span></span>])

<span class='comment'>## Books with 3 or more ratings
</span><span class='const'>Book</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>array_length(ratings, 1) &gt;= 3</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<h3>Hstore</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/hstore.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/hstore.html#id-1.11.7.26.5">functions and operators</a></li>
</ul>

<p>NOTE: You need to enable the <code>hstore</code> extension to use hstore.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131009135255_create_profiles.rb
</span><span class='kw'>class</span> <span class='const'>CreateProfiles</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Migration.html" title="ActiveRecord::Migration (class)">Migration</a></span>[<span class='float'>8.1</span>]
  <span class='id identifier rubyid_enable_extension'>enable_extension</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hstore</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_extension_enabled?'>extension_enabled?</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hstore</span><span class='tstring_end'>&quot;</span></span>)
  <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_profiles'>profiles</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
    <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_hstore'>hstore</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>settings</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/profile.rb
</span><span class='kw'>class</span> <span class='const'>Profile</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; Profile.create(settings: { &quot;color&quot; =&gt; &quot;blue&quot;, &quot;resolution&quot; =&gt; &quot;800x600&quot; })

irb&gt; profile = Profile.first
irb&gt; profile.settings
=&gt; {&quot;color&quot;=&gt;&quot;blue&quot;, &quot;resolution&quot;=&gt;&quot;800x600&quot;}

irb&gt; profile.settings = {&quot;color&quot; =&gt; &quot;yellow&quot;, &quot;resolution&quot; =&gt; &quot;1280x1024&quot;}
irb&gt; profile.save!

irb&gt; Profile.where(&quot;settings-&gt;&#39;color&#39; = ?&quot;, &quot;yellow&quot;)
=&gt; #&lt;ActiveRecord::Relation [#&lt;Profile id: 1, settings: {&quot;color&quot;=&gt;&quot;yellow&quot;, &quot;resolution&quot;=&gt;&quot;1280x1024&quot;}&gt;]&gt;
</code></pre>

<h3>JSON and JSONB</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-json.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-json.html">functions and operators</a></li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_events.rb
</span><span class='comment'># ... for json datatype:
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_events'>events</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_json'>json</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>payload</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
<span class='comment'># ... or for jsonb datatype:
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_events'>events</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_jsonb'>jsonb</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>payload</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/event.rb
</span><span class='kw'>class</span> <span class='const'>Event</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; Event.create(payload: { kind: &quot;user_renamed&quot;, change: [&quot;jack&quot;, &quot;john&quot;]})

irb&gt; event = Event.first
irb&gt; event.payload
=&gt; {&quot;kind&quot;=&gt;&quot;user_renamed&quot;, &quot;change&quot;=&gt;[&quot;jack&quot;, &quot;john&quot;]}

## Query based on JSON document
# The -&gt; operator returns the original JSON type (which might be an object), whereas -&gt;&gt; returns text
irb&gt; Event.where(&quot;payload-&gt;&gt;&#39;kind&#39; = ?&quot;, &quot;user_renamed&quot;)
</code></pre>

<h3>Range Types</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/rangetypes.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-range.html">functions and operators</a></li>
</ul>

<p>This type is mapped to Ruby <a href="https://docs.ruby-lang.org/en/master/Range.html"><a href="Range.html" title="Range (class)"><code>Range</code></a></a> objects.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20130923065404_create_events.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_events'>events</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_daterange'>daterange</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>duration</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/event.rb
</span><span class='kw'>class</span> <span class='const'>Event</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; Event.create(duration: Date.new(2014, 2, 11)..Date.new(2014, 2, 12))

irb&gt; event = Event.first
irb&gt; event.duration
=&gt; Tue, 11 Feb 2014...Thu, 13 Feb 2014

## All Events on a given date
irb&gt; Event.where(&quot;duration @&gt; ?::date&quot;, Date.new(2014, 2, 12))

## Working with range bounds
irb&gt; event = Event.select(&quot;lower(duration) AS starts_at&quot;).select(&quot;upper(duration) AS ends_at&quot;).first

irb&gt; event.starts_at
=&gt; Tue, 11 Feb 2014
irb&gt; event.ends_at
=&gt; Thu, 13 Feb 2014
</code></pre>

<h3>Composite Types</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/rowtypes.html">type definition</a></li>
</ul>

<p>Currently there is no special support for composite types. They are mapped to
normal text columns:</p>

<pre class="code sql"><code class="sql">CREATE TYPE full_address AS
(
  city VARCHAR(90),
  street VARCHAR(90)
);
</code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20140207133952_create_contacts.rb
</span><span class='id identifier rubyid_execute'>execute</span> <span class='heredoc_beg'>&lt;&lt;-SQL</span>
<span class='tstring_content'>  CREATE TYPE full_address AS
  (
    city VARCHAR(90),
    street VARCHAR(90)
  );
</span><span class='heredoc_end'>SQL
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_contacts'>contacts</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_column'>column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_full_address'>full_address</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/contact.rb
</span><span class='kw'>class</span> <span class='const'>Contact</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; Contact.create address: &quot;(Paris,Champs-Élysées)&quot;
irb&gt; contact = Contact.first
irb&gt; contact.address
=&gt; &quot;(Paris,Champs-Élysées)&quot;
irb&gt; contact.address = &quot;(Paris,Rue Basse)&quot;
irb&gt; contact.save!
</code></pre>

<h3>Enumerated Types</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-enum.html">type definition</a></li>
</ul>

<p>The type can be mapped as a normal text column, or to an <a href="https://api.rubyonrails.org/classes/ActiveRecord/Enum.html"><a href="ActiveRecord/Enum.html" title="ActiveRecord::Enum (module)"><code>::ActiveRecord::Enum</code></a></a>.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_articles.rb
</span><span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
  <span class='id identifier rubyid_create_enum'>create_enum</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_status'>article_status</span><span class='comma'>,</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>draft</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>published</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>archived</span><span class='tstring_end'>&quot;</span></span>]

  <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_articles'>articles</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
    <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_enum'>enum</span> <span class='symbeg'>:</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='label'>enum_type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_status'>article_status</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>draft</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>null:</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>You can also create an enum type and add an enum column to an existing table:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20230113024409_add_status_to_articles.rb
</span><span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
  <span class='id identifier rubyid_create_enum'>create_enum</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_status'>article_status</span><span class='comma'>,</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>draft</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>published</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>archived</span><span class='tstring_end'>&quot;</span></span>]

  <span class='id identifier rubyid_add_column'>add_column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_articles'>articles</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_enum'>enum</span><span class='comma'>,</span> <span class='label'>enum_type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_status'>article_status</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>draft</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>null:</span> <span class='kw'>false</span>
<span class='kw'>end</span></code></pre>

<p>The above migrations are both reversible, but you can define separate <code>#up</code> and <code>#down</code> methods if required. Make sure you remove any columns or tables that depend on the enum type before dropping it:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_down'>down</span>
  <span class='id identifier rubyid_drop_table'>drop_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_articles'>articles</span>

  <span class='comment'># OR: remove_column :articles, :status
</span>  <span class='id identifier rubyid_drop_enum'>drop_enum</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_status'>article_status</span>
<span class='kw'>end</span></code></pre>

<p>Declaring an enum attribute in the model adds helper methods and prevents invalid values from being assigned to instances of the class:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/article.rb
</span><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_enum'>enum</span> <span class='symbeg'>:</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> {
    <span class='label'>draft:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>draft</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>published:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>published</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>archived:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>archived</span><span class='tstring_end'>&quot;</span></span>
  }<span class='comma'>,</span> <span class='label'>prefix:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; article = Article.create
irb&gt; article.status
=&gt; &quot;draft&quot; # default status from PostgreSQL, as defined in migration above

irb&gt; article.status_published!
irb&gt; article.status
=&gt; &quot;published&quot;

irb&gt; article.status_archived?
=&gt; false

irb&gt; article.status = &quot;deleted&quot;
ArgumentError: &#39;deleted&#39; is not a valid status
</code></pre>

<p>To rename the enum you can use <code>rename_enum</code> along with updating any model
usage:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20150718144917_rename_article_status.rb
</span><span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
  <span class='id identifier rubyid_rename_enum'>rename_enum</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_status'>article_status</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span>
<span class='kw'>end</span></code></pre>

<p>To add a new value you can use <code>add_enum_value</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20150720144913_add_new_state_to_articles.rb
</span><span class='kw'>def</span> <span class='id identifier rubyid_up'>up</span>
  <span class='id identifier rubyid_add_enum_value'>add_enum_value</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>archived</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># will be at the end after published
</span>  <span class='id identifier rubyid_add_enum_value'>add_enum_value</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>in review</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>before:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>published</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_add_enum_value'>add_enum_value</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>approved</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>after:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>in review</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_add_enum_value'>add_enum_value</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rejected</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>if_not_exists:</span> <span class='kw'>true</span> <span class='comment'># won&#39;t raise an error if the value already exists
</span><span class='kw'>end</span></code></pre>

<p>NOTE: Enum values can&#39;t be dropped, which also means add_enum_value is irreversible. You can read why <a href="https://www.postgresql.org/message-id/29F36C7C98AB09499B1A209D48EAA615B7653DBC8A@mail2a.alliedtesting.com">here</a>.</p>

<p>To rename a value you can use <code>rename_enum_value</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20150722144915_rename_article_state.rb
</span><span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
  <span class='id identifier rubyid_rename_enum_value'>rename_enum_value</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span><span class='comma'>,</span> <span class='label'>from:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>archived</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>deleted</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<p>Hint: to show all the values of the all enums you have, you can call this query in <code>bin/rails db</code> or <code>psql</code> console:</p>

<pre class="code sql"><code class="sql">SELECT n.nspname AS enum_schema,
       t.typname AS enum_name,
       e.enumlabel AS enum_value
  FROM pg_type t
      JOIN pg_enum e ON t.oid = e.enumtypid
      JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace
</code></pre>

<h3>UUID</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-uuid.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/pgcrypto.html">pgcrypto generator function</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/uuid-ossp.html">uuid-ossp generator functions</a></li>
</ul>

<p>NOTE: If you&#39;re using PostgreSQL earlier than version 13.0 you may need to enable special extensions to use UUIDs. Enable the <code>pgcrypto</code> extension (PostgreSQL &gt;= 9.4) or <code>uuid-ossp</code> extension (for even earlier releases).</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_revisions.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_revisions'>revisions</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_uuid'>uuid</span> <span class='symbeg'>:</span><span class='id identifier rubyid_identifier'>identifier</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/revision.rb
</span><span class='kw'>class</span> <span class='const'>Revision</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; Revision.create identifier: &quot;A0EEBC99-9C0B-4EF8-BB6D-6BB9BD380A11&quot;

irb&gt; revision = Revision.first
irb&gt; revision.identifier
=&gt; &quot;a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11&quot;
</code></pre>

<p>You can use <code>uuid</code> type to define references in migrations:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20150418012400_create_blog.rb
</span><span class='id identifier rubyid_enable_extension'>enable_extension</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pgcrypto</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_extension_enabled?'>extension_enabled?</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pgcrypto</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>id:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uuid'>uuid</span>

<span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='label'>id:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uuid'>uuid</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='comment'># t.belongs_to :post, type: :uuid
</span>  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_references'>references</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uuid'>uuid</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/post.rb
</span><span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/comment.rb
</span><span class='kw'>class</span> <span class='const'>Comment</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span>
<span class='kw'>end</span></code></pre>

<p>See <a href="#uuid-primary-keys">this section</a> for more details on using UUIDs as primary key.</p>

<h3>Bit String Types</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-bit.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-bitstring.html">functions and operators</a></li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_users.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>true</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_column'>column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_settings'>settings</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bit(8)</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/user.rb
</span><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; User.create settings: &quot;01010011&quot;
irb&gt; user = User.first
irb&gt; user.settings
=&gt; &quot;01010011&quot;
irb&gt; user.settings = &quot;0xAF&quot;
irb&gt; user.settings
=&gt; &quot;10101111&quot;
irb&gt; user.save!
</code></pre>

<h3>Network Address Types</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-net-types.html">type definition</a></li>
</ul>

<p>The types <code>inet</code> and <code>cidr</code> are mapped to Ruby
<a href="https://docs.ruby-lang.org/en/master/IPAddr.html"><a href="IPAddr.html" title="IPAddr (class)"><code>IPAddr</code></a></a>
objects. The <code>macaddr</code> type is mapped to normal text.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20140508144913_create_devices.rb
</span><span class='id identifier rubyid_create_table'>create_table</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_devices'>devices</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>true</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_inet'>inet</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ip</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_cidr'>cidr</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>network</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_macaddr'>macaddr</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>address</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/device.rb
</span><span class='kw'>class</span> <span class='const'>Device</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; macbook = Device.create(ip: &quot;192.168.1.12&quot;, network: &quot;192.168.2.0/24&quot;, address: &quot;32:01:16:6d:05:ef&quot;)

irb&gt; macbook.ip
=&gt; #&lt;IPAddr: IPv4:192.168.1.12/255.255.255.255&gt;

irb&gt; macbook.network
=&gt; #&lt;IPAddr: IPv4:192.168.2.0/255.255.255.0&gt;

irb&gt; macbook.address
=&gt; &quot;32:01:16:6d:05:ef&quot;
</code></pre>

<h3>Geometric Types</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-geometric.html">type definition</a></li>
</ul>

<p>All geometric types, with the exception of <code>points</code> are mapped to normal text.
A point is cast to an array containing <code>x</code> and <code>y</code> coordinates.</p>

<h3>Interval</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-datetime.html#DATATYPE-INTERVAL-INPUT">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-datetime.html">functions and operators</a></li>
</ul>

<p>This type is mapped to <a href="https://api.rubyonrails.org/classes/ActiveSupport/Duration.html"><a href="ActiveSupport/Duration.html" title="ActiveSupport::Duration (class)"><code>::ActiveSupport::Duration</code></a></a> objects.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20200120000000_create_events.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_events'>events</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_interval'>interval</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>duration</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/event.rb
</span><span class='kw'>class</span> <span class='const'>Event</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; Event.create(duration: 2.days)

irb&gt; event = Event.first
irb&gt; event.duration
=&gt; 2 days
</code></pre>

<h3>Timestamps</h3>

<ul>
<li><a href="https://www.postgresql.org/docs/current/datatype-datetime.html">Date/Time Types</a></li>
</ul>

<p>Rails migrations with timestamps store the time a model was created or updated. By default and for legacy reasons, the columns use the <code>timestamp without time zone</code> data type.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20241220144913_create_devices.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span><span class='comma'>,</span> <span class='label'>id:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uuid'>uuid</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_datetime'>datetime</span> <span class='symbeg'>:</span><span class='id identifier rubyid_published_at'>published_at</span>
  <span class='comment'># By default, Active Record will set the data type of this column to `timestamp without time zone`.
</span><span class='kw'>end</span></code></pre>

<p>While this works ok, <a href="https://wiki.postgresql.org/wiki/Don&#x27;t_Do_This#Don.27t_use_timestamp_.28without_time_zone.29">PostgreSQL best practices</a> recommend that <code>timestamp with time zone</code> is used instead for timezone-aware timestamps.
This must be configured before it can be used for new migrations.</p>

<p>To configure <code>timestamp with time zone</code> as your new timestamp default data type, place the following configuration in the <code>config/application.rb</code> file.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/application.rb
</span><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span>.<span class='id identifier rubyid_on_load'><a href="ActiveSupport/LazyLoadHooks.html#on_load-instance_method" title="ActiveSupport::LazyLoadHooks#on_load (method)">on_load</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_active_record_postgresqladapter'>active_record_postgresqladapter</span>) <span class='kw'>do</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_datetime_type'>datetime_type</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_timestamptz'>timestamptz</span>
<span class='kw'>end</span></code></pre>

<p>With that configuration in place, generate and apply new migrations, then verify their timestamps use the <code>timestamp with time zone</code> data type.</p>

<h2>UUID Primary Keys</h2>

<p>NOTE: You need to enable the <code>pgcrypto</code> (only PostgreSQL &gt;= 9.4) or <code>uuid-ossp</code>
extension to generate random UUIDs.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_devices.rb
</span><span class='id identifier rubyid_enable_extension'>enable_extension</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pgcrypto</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_extension_enabled?'>extension_enabled?</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pgcrypto</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_devices'>devices</span><span class='comma'>,</span> <span class='label'>id:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uuid'>uuid</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_kind'>kind</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/device.rb
</span><span class='kw'>class</span> <span class='const'>Device</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; device = Device.create
irb&gt; device.id
=&gt; &quot;814865cd-5a1d-4771-9306-4268f188fe9e&quot;
</code></pre>

<p>NOTE: <code>gen_random_uuid()</code> (from <code>pgcrypto</code>) is assumed if no <code>:default</code> option
was passed to <code>create_table</code>.</p>

<p>To use the Rails model generator for a table using UUID as the primary key, pass
<code>--primary-key-type=uuid</code> to the model generator.</p>

<p>For example:</p>

<pre class="code bash"><code class="bash">$ bin/rails generate model Device --primary-key-type=uuid kind:string
</code></pre>

<p>When building a model with a foreign key that will reference this UUID, treat
<code>uuid</code> as the native field type, for example:</p>

<pre class="code bash"><code class="bash">$ bin/rails generate model Case device_id:uuid
</code></pre>

<h2>Indexing</h2>

<ul>
<li><a href="https://www.postgresql.org/docs/current/sql-createindex.html">index creation</a></li>
</ul>

<p>PostgreSQL includes a variety of index options. The following options are
supported by the PostgreSQL adapter in addition to the
<a href="https://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_index">common index options</a></p>

<h3>Include</h3>

<p>When creating a new index, non-key columns can be included with the <code>:include</code> option.
These keys are not used in index scans for searching, but can be read during an index
only scan without having to visit the associated table.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_add_index_users_on_email_include_id.rb
</span>
<span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>include:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span></code></pre>

<p>Multiple columns are supported:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_add_index_users_on_email_include_id_and_created_at.rb
</span>
<span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>include:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_created_at'>created_at</span>]</code></pre>

<h2>Generated Columns</h2>

<p>NOTE: Generated columns are supported since version 12.0 of PostgreSQL.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_users.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_virtual'>virtual</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name_upcased'>name_upcased</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_string'>string</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>upper(name)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>stored:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='comment'># app/models/user.rb
</span><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John</span><span class='tstring_end'>&quot;</span></span>)
<span class='const'>User</span>.<span class='id identifier rubyid_last'>last</span>.<span class='id identifier rubyid_name_upcased'>name_upcased</span> <span class='comment'># =&gt; &quot;JOHN&quot;</span></code></pre>

<h2>Deferrable Foreign Keys</h2>

<ul>
<li><a href="https://www.postgresql.org/docs/current/sql-set-constraints.html">foreign key table constraints</a></li>
</ul>

<p>By default, table constraints in PostgreSQL are checked immediately after each statement. It intentionally does not allow creating records where the referenced record is not yet in the referenced table. It is possible to run this integrity check later on when the transaction is committed by adding <code>DEFERRABLE</code> to the foreign key definition though. To defer all checks by default it can be set to <code>DEFERRABLE INITIALLY DEFERRED</code>. Rails exposes this PostgreSQL feature by adding the <code>:deferrable</code> key to the <code>foreign_key</code> options in the <code>add_reference</code> and <code>add_foreign_key</code> methods.</p>

<p>One example of this is creating circular dependencies in a transaction even if you have created foreign keys:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_reference'>add_reference</span> <span class='symbeg'>:</span><span class='id identifier rubyid_person'>person</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='kw'>alias</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> { <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_deferred'>deferred</span> }
<span class='id identifier rubyid_add_reference'>add_reference</span> <span class='symbeg'>:</span><span class='kw'>alias</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_person'>person</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> { <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_deferred'>deferred</span> }</code></pre>

<p>If the reference was created with the <code>foreign_key: true</code> option, the following transaction would fail when executing the first <code>INSERT</code> statement. It does not fail when the <code>deferrable: :deferred</code> option is set though.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_lease_connection'><a href="ActiveRecord/ConnectionHandling.html#lease_connection-instance_method" title="ActiveRecord::ConnectionHandling#lease_connection (method)">lease_connection</a></span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>id:</span> <span class='const'><a href="SecureRandom.html" title="SecureRandom (module)">SecureRandom</a></span>.<span class='id identifier rubyid_uuid'>uuid</span><span class='comma'>,</span> <span class='label'>alias_id:</span> <span class='const'><a href="SecureRandom.html" title="SecureRandom (module)">SecureRandom</a></span>.<span class='id identifier rubyid_uuid'>uuid</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John Doe</span><span class='tstring_end'>&quot;</span></span>)
  <span class='const'>Alias</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>id:</span> <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_alias_id'>alias_id</span><span class='comma'>,</span> <span class='label'>person_id:</span> <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>jaydee</span><span class='tstring_end'>&quot;</span></span>)
<span class='kw'>end</span></code></pre>

<p>When the <code>:deferrable</code> option is set to <code>:immediate</code>, let the foreign keys keep the default behavior of checking the constraint immediately, but allow manually deferring the checks using <code>set_constraints</code> within a transaction. This will cause the foreign keys to be checked when the transaction is committed:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_lease_connection'><a href="ActiveRecord/ConnectionHandling.html#lease_connection-instance_method" title="ActiveRecord::ConnectionHandling#lease_connection (method)">lease_connection</a></span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
  <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_lease_connection'><a href="ActiveRecord/ConnectionHandling.html#lease_connection-instance_method" title="ActiveRecord::ConnectionHandling#lease_connection (method)">lease_connection</a></span>.<span class='id identifier rubyid_set_constraints'>set_constraints</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_deferred'>deferred</span>)
  <span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>alias_id:</span> <span class='const'><a href="SecureRandom.html" title="SecureRandom (module)">SecureRandom</a></span>.<span class='id identifier rubyid_uuid'>uuid</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John Doe</span><span class='tstring_end'>&quot;</span></span>)
  <span class='const'>Alias</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>id:</span> <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_alias_id'>alias_id</span><span class='comma'>,</span> <span class='label'>person_id:</span> <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>jaydee</span><span class='tstring_end'>&quot;</span></span>)
<span class='kw'>end</span></code></pre>

<p>By default <code>:deferrable</code> is <code>false</code> and the constraint is always checked immediately.</p>

<h2>Unique Constraint</h2>

<ul>
<li><a href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS">unique constraints</a></li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20230422225213_create_items.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_items'>items</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_integer'>integer</span> <span class='symbeg'>:</span><span class='id identifier rubyid_position'>position</span><span class='comma'>,</span> <span class='label'>null:</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_unique_constraint'>unique_constraint</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_position'>position</span>]<span class='comma'>,</span> <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_immediate'>immediate</span>
<span class='kw'>end</span></code></pre>

<p>If you want to change an existing unique index to deferrable, you can use <code>:using_index</code> to create deferrable unique constraints.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_unique_constraint'>add_unique_constraint</span> <span class='symbeg'>:</span><span class='id identifier rubyid_items'>items</span><span class='comma'>,</span> <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_deferred'>deferred</span><span class='comma'>,</span> <span class='label'>using_index:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>index_items_on_position</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>Like foreign keys, unique constraints can be deferred by setting <code>:deferrable</code> to either <code>:immediate</code> or <code>:deferred</code>. By default, <code>:deferrable</code> is <code>false</code> and the constraint is always checked immediately.</p>

<h2>Exclusion Constraints</h2>

<ul>
<li><a href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-EXCLUSION">exclusion constraints</a></li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_products.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_products'>products</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_integer'>integer</span> <span class='symbeg'>:</span><span class='id identifier rubyid_price'>price</span><span class='comma'>,</span> <span class='label'>null:</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_daterange'>daterange</span> <span class='symbeg'>:</span><span class='id identifier rubyid_availability_range'>availability_range</span><span class='comma'>,</span> <span class='label'>null:</span> <span class='kw'>false</span>

  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_exclusion_constraint'>exclusion_constraint</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>price WITH =, availability_range WITH &amp;&amp;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>using:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gist'>gist</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>price_check</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<p>Like foreign keys, exclusion constraints can be deferred by setting <code>:deferrable</code> to either <code>:immediate</code> or <code>:deferred</code>. By default, <code>:deferrable</code> is <code>false</code> and the constraint is always checked immediately.</p>

<h2>Full Text Search</h2>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_documents.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_documents'>documents</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_body'>body</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>to_tsvector(&#39;english&#39;, title || &#39; &#39; || body)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>using:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gin'>gin</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>documents_idx</span><span class='tstring_end'>&quot;</span></span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/document.rb
</span><span class='kw'>class</span> <span class='const'>Document</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># Usage
</span><span class='const'>Document</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cats and Dogs</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>body:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>are nice!</span><span class='tstring_end'>&quot;</span></span>)

<span class='comment'>## all documents matching &#39;cat &amp; dog&#39;
</span><span class='const'>Document</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>to_tsvector(&#39;english&#39;, title || &#39; &#39; || body) @@ to_tsquery(?)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                 <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cat &amp; dog</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>Optionally, you can store the vector as automatically generated column (from PostgreSQL 12.0):</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_documents.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_documents'>documents</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_body'>body</span>

  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_virtual'>virtual</span> <span class='symbeg'>:</span><span class='id identifier rubyid_textsearchable_index_col'>textsearchable_index_col</span><span class='comma'>,</span>
            <span class='label'>type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tsvector'>tsvector</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>to_tsvector(&#39;english&#39;, title || &#39; &#39; || body)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>stored:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_textsearchable_index_col'>textsearchable_index_col</span><span class='comma'>,</span> <span class='label'>using:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gin'>gin</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>documents_idx</span><span class='tstring_end'>&quot;</span></span>

<span class='comment'># Usage
</span><span class='const'>Document</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cats and Dogs</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>body:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>are nice!</span><span class='tstring_end'>&quot;</span></span>)

<span class='comment'>## all documents matching &#39;cat &amp; dog&#39;
</span><span class='const'>Document</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>textsearchable_index_col @@ to_tsquery(?)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cat &amp; dog</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<h2>Database Views</h2>

<ul>
<li><a href="https://www.postgresql.org/docs/current/static/sql-createview.html">view creation</a></li>
</ul>

<p>Imagine you need to work with a legacy database containing the following table:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rails_pg_guide'>rails_pg_guide</span><span class='op'>=</span><span class='comment'># \d &quot;TBL_ART&quot;
</span>                                        <span class='const'>Table</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>public.TBL_ART</span><span class='tstring_end'>&quot;</span></span>
   <span class='const'>Column</span>   <span class='op'>|</span>            <span class='const'>Type</span>             <span class='op'>|</span>                         <span class='const'>Modifiers</span>
<span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span>
 <span class='const'>INT_ID</span>     <span class='op'>|</span> <span class='id identifier rubyid_integer'>integer</span>                     <span class='op'>|</span> <span class='kw'>not</span> <span class='id identifier rubyid_null'>null</span> <span class='id identifier rubyid_default'>default</span> <span class='id identifier rubyid_nextval'>nextval</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;TBL_ART_INT_ID_seq&quot;</span><span class='tstring_end'>&#39;</span></span><span class='op'>::</span><span class='id identifier rubyid_regclass'>regclass</span>)
 <span class='const'>STR_TITLE</span>  <span class='op'>|</span> <span class='id identifier rubyid_character'>character</span> <span class='id identifier rubyid_varying'>varying</span>           <span class='op'>|</span>
 <span class='const'>STR_STAT</span>   <span class='op'>|</span> <span class='id identifier rubyid_character'>character</span> <span class='id identifier rubyid_varying'>varying</span>           <span class='op'>|</span> <span class='id identifier rubyid_default'>default</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>draft</span><span class='tstring_end'>&#39;</span></span><span class='op'>::</span><span class='id identifier rubyid_character'>character</span> <span class='id identifier rubyid_varying'>varying</span>
 <span class='const'>DT_PUBL_AT</span> <span class='op'>|</span> <span class='id identifier rubyid_timestamp'>timestamp</span> <span class='id identifier rubyid_without'>without</span> <span class='id identifier rubyid_time'>time</span> <span class='id identifier rubyid_zone'>zone</span> <span class='op'>|</span>
 <span class='const'>BL_ARCH</span>    <span class='op'>|</span> <span class='id identifier rubyid_boolean'>boolean</span>                     <span class='op'>|</span> <span class='id identifier rubyid_default'>default</span> <span class='kw'>false</span>
<span class='const'>Indexes</span><span class='op'>:</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TBL_ART_pkey</span><span class='tstring_end'>&quot;</span></span> <span class='const'>PRIMARY</span> <span class='const'>KEY</span><span class='comma'>,</span> <span class='id identifier rubyid_btree'>btree</span> (<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT_ID</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>This table does not follow the Rails conventions at all.
Because simple PostgreSQL views are updateable by default,
we can wrap it as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_articles_view.rb
</span><span class='id identifier rubyid_execute'>execute</span> <span class='heredoc_beg'>&lt;&lt;-SQL</span>
<span class='tstring_content'>CREATE VIEW articles AS
  SELECT &quot;INT_ID&quot; AS id,
         &quot;STR_TITLE&quot; AS title,
         &quot;STR_STAT&quot; AS status,
         &quot;DT_PUBL_AT&quot; AS published_at,
         &quot;BL_ARCH&quot; AS archived
  FROM &quot;TBL_ART&quot;
  WHERE &quot;BL_ARCH&quot; = &#39;f&#39;
</span><span class='heredoc_end'>SQL</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/article.rb
</span><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_primary_key'>primary_key</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_archive!'>archive!</span>
    <span class='id identifier rubyid_update_attribute'>update_attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_archived'>archived</span><span class='comma'>,</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; first = Article.create! title: &quot;Winter is coming&quot;, status: &quot;published&quot;, published_at: 1.year.ago
irb&gt; second = Article.create! title: &quot;Brace yourself&quot;, status: &quot;draft&quot;, published_at: 1.month.ago

irb&gt; Article.count
=&gt; 2
irb&gt; first.archive!
irb&gt; Article.count
=&gt; 1
</code></pre>

<p>NOTE: This application only cares about non-archived <code>Articles</code>. A view also
allows for conditions so we can exclude the archived <code>Articles</code> directly.</p>

<h2>Structure Dumps</h2>

<p>If your <code>config.active_record.schema_format</code> is <code>:sql</code>, Rails will call <code>pg_dump</code> to generate a
structure dump.</p>

<p>You can use <a href="ActiveRecord/Tasks/DatabaseTasks.html#structure_dump_flags-class_method" title="ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags (method)">ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags</a> to configure <code>pg_dump</code>.
For example, to exclude comments from your structure dump, add this to an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Tasks.html" title="ActiveRecord::Tasks (module)">Tasks</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Tasks/DatabaseTasks.html" title="ActiveRecord::Tasks::DatabaseTasks (module)">DatabaseTasks</a></span>.<span class='id identifier rubyid_structure_dump_flags'><a href="ActiveRecord/Tasks/DatabaseTasks.html#structure_dump_flags-class_method" title="ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags (method)">structure_dump_flags</a></span> <span class='op'>=</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--no-comments</span><span class='tstring_end'>&quot;</span></span>]</code></pre>

<h2>Explain</h2>

<p>Along with the standard <a href="active_record_querying.html#explain-options"><code>explain</code></a> options, the PostgreSQL adapter supports <a href="https://www.postgresql.org/docs/current/sql-explain.html"><code>buffers</code></a>.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Company</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_owning_companies_ids'>owning_companies_ids</span>).<span class='id identifier rubyid_explain'>explain</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_analyze'>analyze</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_buffers'>buffers</span>)
<span class='comment'>#=&gt; EXPLAIN (ANALYZE, BUFFERS) SELECT &quot;companies&quot;.* FROM &quot;companies&quot;
</span><span class='comment'># ...
</span><span class='comment'># Seq Scan on companies  (cost=0.00..2.21 rows=3 width=64)
</span><span class='comment'># ...</span></code></pre>

<p>See their documentation for more details.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>