<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ActiveRecord::Normalization::ClassMethods &mdash; Rails main</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::Normalization::ClassMethods",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Rails main</a> &raquo; 
      <a href='../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
        <a class='nodoc' href="../Normalization.html" title="ActiveRecord::Normalization (module)">Normalization</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ClassMethods&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: ActiveRecord::Normalization::ClassMethods</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/normalization.rb#L31'>activerecord/lib/active_record/normalization.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#normalize_value_for-instance_method" title="#normalize_value_for (instance method)">#<strong>normalize_value_for</strong>(name, value)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Normalizes a given <code>value</code> using normalizations declared for <code>name</code>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#normalizes-instance_method" title="#normalizes (instance method)">#<strong>normalizes</strong>(*names, with:, apply_to_nil: false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Declares a normalization for one or more attributes.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="normalize_value_for-instance_method">
  <h3 class='signature  first'>
    #<strong>normalize_value_for</strong>(name, value)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Normalizes a given <code>value</code> using normalizations declared for <code>name</code>.</p>

<h4 id="label-Examples">Examples</h4>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_normalizes'><a href="#normalizes-instance_method" title="ActiveRecord::Normalization::ClassMethods#normalizes (method)">normalizes</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>with:</span> <span class='tlambda'>-&gt;</span> <span class='id identifier rubyid_email'>email</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_email'>email</span>.<span class='id identifier rubyid_strip'>strip</span>.<span class='id identifier rubyid_downcase'>downcase</span> }
<span class='kw'>end</span>

<span class='const'>User</span>.<span class='id identifier rubyid_normalize_value_for'>normalize_value_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> CRUISE-CONTROL@EXAMPLE.COM\n</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; &quot;cruise-control@example.com&quot;</span></code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/normalization.rb#L106-L108'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='106' data-end='108'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/normalization.rb', line 106</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_normalize_value_for'>normalize_value_for</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span>)
  <span class='id identifier rubyid_type_for_attribute'>type_for_attribute</span>(<span class='id identifier rubyid_name'>name</span>).<span class='id identifier rubyid_cast'>cast</span>(<span class='id identifier rubyid_value'>value</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="normalizes-instance_method">
  <h3 class='signature '>
    #<strong>normalizes</strong>(*names, with:, apply_to_nil: false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Declares a normalization for one or more attributes. The normalization is applied when the attribute is assigned or updated, and the normalized value will be persisted to the database. The normalization is also applied to the corresponding keyword argument of query methods. This allows a record to be created and later queried using unnormalized values.</p>

<p>However, to prevent confusion, the normalization will not be applied when the attribute is fetched from the database. This means that if a record was persisted before the normalization was declared, the record’s attribute will not be normalized until either it is assigned a new value, or it is explicitly migrated via <a href="../Normalization.html#normalize_attribute-instance_method" title="ActiveRecord::Normalization#normalize_attribute (method)">ActiveRecord::Normalization#normalize_attribute</a>.</p>

<p>Because the normalization may be applied multiple times, it should be <em>idempotent</em>. In other words, applying the normalization more than once should have the same result as applying it only once.</p>

<p>By default, the normalization will not be applied to <code>nil</code> values. This behavior can be changed with the <code>:apply_to_nil</code> option.</p>

<p>Be aware that if your app was created before <a href="../../Rails.html" title="Rails (module)"><code>::Rails</code></a> 7.1, and your app marshals instances of the targeted model (for example, when caching), then you should set <a href="../../ActiveRecord.html#marshalling_format_version-class_method" title="ActiveRecord.marshalling_format_version (method)">ActiveRecord.marshalling_format_version</a> to <code>7.1</code> or higher via either <code>config.load_defaults 7.1</code> or <code>config.active_record.marshalling_format_version = 7.1</code>. Otherwise, <code>Marshal</code> may attempt to serialize the normalization <code>Proc</code> and raise <code>TypeError</code>.</p>

<h4 id="label-Options">Options</h4>
<ul><li>
<p><code>:with</code> - Any callable object that accepts the attribute’s value as its sole argument, and returns it normalized.</p>
</li><li>
<p><code>:apply_to_nil</code> - Whether to apply the normalization to <code>nil</code> values. Defaults to <code>false</code>.</p>
</li></ul>

<h4 id="label-Examples">Examples</h4>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_normalizes'>normalizes</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>with:</span> <span class='tlambda'>-&gt;</span> <span class='id identifier rubyid_email'>email</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_email'>email</span>.<span class='id identifier rubyid_strip'>strip</span>.<span class='id identifier rubyid_downcase'>downcase</span> }
  <span class='id identifier rubyid_normalizes'>normalizes</span> <span class='symbeg'>:</span><span class='id identifier rubyid_phone'>phone</span><span class='comma'>,</span> <span class='label'>with:</span> <span class='tlambda'>-&gt;</span> <span class='id identifier rubyid_phone'>phone</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_phone'>phone</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>^0-9</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_delete_prefix'>delete_prefix</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1</span><span class='tstring_end'>&quot;</span></span>) }
<span class='kw'>end</span>

<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> CRUISE-CONTROL@EXAMPLE.COM\n</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_email'>email</span>                  <span class='comment'># =&gt; &quot;cruise-control@example.com&quot;
</span>
<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\tCRUISE-CONTROL@EXAMPLE.COM </span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_email'>email</span>                  <span class='comment'># =&gt; &quot;cruise-control@example.com&quot;
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_email_before_type_cast'>email_before_type_cast</span> <span class='comment'># =&gt; &quot;cruise-control@example.com&quot;
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\tCRUISE-CONTROL@EXAMPLE.COM </span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_count'>count</span>         <span class='comment'># =&gt; 1
</span><span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>([<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>email = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\tCRUISE-CONTROL@EXAMPLE.COM </span><span class='tstring_end'>&quot;</span></span>]).<span class='id identifier rubyid_count'>count</span> <span class='comment'># =&gt; 0
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_exists?'>exists?</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\tCRUISE-CONTROL@EXAMPLE.COM </span><span class='tstring_end'>&quot;</span></span>)         <span class='comment'># =&gt; true
</span><span class='const'>User</span>.<span class='id identifier rubyid_exists?'>exists?</span>([<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>email = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\tCRUISE-CONTROL@EXAMPLE.COM </span><span class='tstring_end'>&quot;</span></span>]) <span class='comment'># =&gt; false
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_normalize_value_for'><a href="#normalize_value_for-instance_method" title="ActiveRecord::Normalization::ClassMethods#normalize_value_for (method)">normalize_value_for</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_phone'>phone</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+1 (555) 867-5309</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># =&gt; &quot;5558675309&quot;</span></code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/normalization.rb#L88-L94'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='88' data-end='94'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/normalization.rb', line 88</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_normalizes'>normalizes</span>(<span class='op'>*</span><span class='id identifier rubyid_names'>names</span><span class='comma'>,</span> <span class='label'>with:</span><span class='comma'>,</span> <span class='label'>apply_to_nil:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_decorate_attributes'>decorate_attributes</span>(<span class='id identifier rubyid_names'>names</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_cast_type'>cast_type</span><span class='op'>|</span>
    <span class='const'><a href="NormalizedValueType.html" title="ActiveRecord::Normalization::NormalizedValueType (class)">NormalizedValueType</a></span>.<span class='id identifier rubyid_new'><a href="NormalizedValueType.html#new-class_method" title="ActiveRecord::Normalization::NormalizedValueType.new (method)">new</a></span>(<span class='label'>cast_type:</span> <span class='id identifier rubyid_cast_type'>cast_type</span><span class='comma'>,</span> <span class='label'>normalizer:</span> <span class='id identifier rubyid_with'>with</span><span class='comma'>,</span> <span class='label'>normalize_nil:</span> <span class='id identifier rubyid_apply_to_nil'>apply_to_nil</span>)
  <span class='kw'>end</span>

  <span class='kw'>self</span>.<span class='id identifier rubyid_normalized_attributes'>normalized_attributes</span> <span class='op'>+=</span> <span class='id identifier rubyid_names'>names</span>.<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_to_sym'>to_sym</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>