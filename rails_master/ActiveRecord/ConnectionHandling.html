<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ActiveRecord::ConnectionHandling &mdash; Rails main</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::ConnectionHandling",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Rails main</a> &raquo; 
      <a href='../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ConnectionHandling&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: ActiveRecord::ConnectionHandling</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Extended In:</div>
      <div class='box_11'>
        <a href="Base.html" title="ActiveRecord::Base (class)"><code>Base</code></a>
      </div>
    </td></tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L5'>activerecord/lib/active_record/connection_handling.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='DEFAULT_ENV-constant' class='summary_signature'>DEFAULT_ENV =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L7-L7'># File 'activerecord/lib/active_record/connection_handling.rb', line 7</a>    <pre class='code ruby'><span class='comment'>#=&gt; { RAILS_ENV.call || &quot;default_env&quot; }</span></pre>
  </li>
  <li>
    <span id='RAILS_ENV-constant' class='summary_signature'>RAILS_ENV =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L6-L6'># File 'activerecord/lib/active_record/connection_handling.rb', line 6</a>    <pre class='code ruby'><span class='comment'>#=&gt; { (Rails.env if defined?(Rails.env)) || ENV[&quot;RAILS_ENV&quot;].presence || ENV[&quot;RACK_ENV&quot;].presence }</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#connected%3F-instance_method" title="#connected? (instance method)">#<strong>connected?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns <code>true</code> if Active Record is connected.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature rw'>
      <a href="#connection_specification_name-instance_method" title="#connection_specification_name (instance method)">#<strong>connection_specification_name</strong>  </a>
    </span>
    <span class='note title rw'>rw</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the connection specification name from the current class or its parent.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature rw'>
      <a href="#connection_specification_name=-instance_method" title="#connection_specification_name= (instance method)">#<strong>connection_specification_name=</strong>(value)  </a>
    </span>
    <span class='note title rw'>rw</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#shard_swapping_prohibited%3F-instance_method" title="#shard_swapping_prohibited? (instance method)">#<strong>shard_swapping_prohibited?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Determine whether or not shard swapping is currently prohibited.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#primary_class%3F-instance_method" title="#primary_class? (instance method)">#<strong>primary_class?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#clear_query_caches_for_current_thread-instance_method" title="#clear_query_caches_for_current_thread (instance method)">#<strong>clear_query_caches_for_current_thread</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Clears the query cache for all connections associated with the current thread.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#connected_to-instance_method" title="#connected_to (instance method)">#<strong>connected_to</strong>(role: nil, shard: nil, prevent_writes: false, &amp;blk)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Connects to a role (e.g. writing, reading, or a custom role) and/or shard for the duration of the block.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#connected_to%3F-instance_method" title="#connected_to? (instance method)">#<strong>connected_to?</strong>(role:, shard: ActiveRecord::Base.default_shard)  &#x21d2; Boolean </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns true if role is the current connected role and/or current connected shard.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#connected_to_many-instance_method" title="#connected_to_many (instance method)">#<strong>connected_to_many</strong>(*classes, role:, shard: nil, prevent_writes: false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Connects a role and/or shard to the provided connection names.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#connecting_to-instance_method" title="#connecting_to (instance method)">#<strong>connecting_to</strong>(role: default_role, shard: default_shard, prevent_writes: false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Use a specified connection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#connection-instance_method" title="#connection (instance method)">#<strong>connection</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Alias for <a href="#lease_connection-instance_method" title="ActiveRecord::ConnectionHandling#lease_connection (method)">#lease_connection</a>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#connection_db_config-instance_method" title="#connection_db_config (instance method)">#<strong>connection_db_config</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the db_config object from the associated connection:</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#connection_pool-instance_method" title="#connection_pool (instance method)">#<strong>connection_pool</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#connects_to-instance_method" title="#connects_to (instance method)">#<strong>connects_to</strong>(database: {}, shards: {})  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Connects a model to the databases specified.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#establish_connection-instance_method" title="#establish_connection (instance method)">#<strong>establish_connection</strong>(config_or_env = nil)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Establishes the connection to the database.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#lease_connection-instance_method" title="#lease_connection (instance method)">#<strong>lease_connection</strong>  </a>
      (also: #connection)
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the connection currently associated with the class.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#prohibit_shard_swapping-instance_method" title="#prohibit_shard_swapping (instance method)">#<strong>prohibit_shard_swapping</strong>(enabled = true)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Prohibit swapping shards while inside of the passed block.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#release_connection-instance_method" title="#release_connection (instance method)">#<strong>release_connection</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Return the currently leased connection into the pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#remove_connection-instance_method" title="#remove_connection (instance method)">#<strong>remove_connection</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#retrieve_connection-instance_method" title="#retrieve_connection (instance method)">#<strong>retrieve_connection</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#while_preventing_writes-instance_method" title="#while_preventing_writes (instance method)">#<strong>while_preventing_writes</strong>(enabled = true, &amp;block)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Prevent writing to the database regardless of role.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#with_connection-instance_method" title="#with_connection (instance method)">#<strong>with_connection</strong>(&amp;block)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Checkouts a connection from the pool, yield it and then check it back in.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#append_to_connected_to_stack-instance_method" title="#append_to_connected_to_stack (instance method)">#<strong>append_to_connected_to_stack</strong>(entry)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#resolve_config_for_connection-instance_method" title="#resolve_config_for_connection (instance method)">#<strong>resolve_config_for_connection</strong>(config_or_env)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#with_role_and_shard-instance_method" title="#with_role_and_shard (instance method)">#<strong>with_role_and_shard</strong>(role, shard, prevent_writes)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#adapter_class-instance_method" title="#adapter_class (instance method)">#<strong>adapter_class</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#clear_cache!-instance_method" title="#clear_cache! (instance method)">#<strong>clear_cache!</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#schema_cache-instance_method" title="#schema_cache (instance method)">#<strong>schema_cache</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="connected?-instance_method">
  <h3 class='signature ro first'>
    #<strong>connected?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns <code>true</code> if Active Record is connected.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L311-L313'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='311' data-end='313'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 311</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connected?'>connected?</span>
  <span class='id identifier rubyid_connection_handler'>connection_handler</span>.<span class='id identifier rubyid_connected?'>connected?</span>(<span class='id identifier rubyid_connection_specification_name'><a href="#connection_specification_name-instance_method" title="ActiveRecord::ConnectionHandling#connection_specification_name (method)">connection_specification_name</a></span><span class='comma'>,</span> <span class='label'>role:</span> <span class='id identifier rubyid_current_role'>current_role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_current_shard'>current_shard</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connection_specification_name-instance_method">
  <h3 class='signature rw'>
    #<strong>connection_specification_name</strong>   <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the connection specification name from the current class or its parent.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L276-L281'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='276' data-end='281'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 276</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connection_specification_name'>connection_specification_name</span>
  <span class='kw'>if</span> <span class='ivar'>@connection_specification_name</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>return</span> <span class='kw'>self</span> <span class='op'>==</span> <span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span> <span class='op'>?</span> <span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>:</span> <span class='id identifier rubyid_superclass'>superclass</span>.<span class='id identifier rubyid_connection_specification_name'>connection_specification_name</span>
  <span class='kw'>end</span>
  <span class='ivar'>@connection_specification_name</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connection_specification_name=-instance_method">
  <h3 class='signature rw'>
    #<strong>connection_specification_name=</strong>(value)   <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L273-L273'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='273' data-end='273'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 273</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_writer'>attr_writer</span> <span class='symbeg'>:</span><span class='id identifier rubyid_connection_specification_name'><a href="#connection_specification_name-instance_method" title="ActiveRecord::ConnectionHandling#connection_specification_name (method)">connection_specification_name</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="primary_class?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>primary_class?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L283-L285'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='283' data-end='285'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 283</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_primary_class?'>primary_class?</span> <span class='comment'># :nodoc:
</span>  <span class='kw'>self</span> <span class='op'>==</span> <span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span> <span class='op'>||</span> <span class='id identifier rubyid_application_record_class?'>application_record_class?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="shard_swapping_prohibited?-instance_method">
  <h3 class='signature ro'>
    #<strong>shard_swapping_prohibited?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Determine whether or not shard swapping is currently prohibited</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L206-L208'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='206' data-end='208'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 206</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_shard_swapping_prohibited?'>shard_swapping_prohibited?</span>
  <span class='const'><a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="../ActiveSupport/IsolatedExecutionState.html" title="ActiveSupport::IsolatedExecutionState (module)">IsolatedExecutionState</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_active_record_prohibit_shard_swapping'>active_record_prohibit_shard_swapping</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="adapter_class-instance_method">
  <h3 class='signature nodoc first'>
    #<strong>adapter_class</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L298-L300'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='298' data-end='300'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 298</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_adapter_class'>adapter_class</span> <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_connection_pool'><a href="#connection_pool-instance_method" title="ActiveRecord::ConnectionHandling#connection_pool (method)">connection_pool</a></span>.<span class='id identifier rubyid_db_config'>db_config</span>.<span class='id identifier rubyid_adapter_class'>adapter_class</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="append_to_connected_to_stack-instance_method">
  <h3 class='signature priv'>
    #<strong>append_to_connected_to_stack</strong>(entry)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L357-L363'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='357' data-end='363'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 357</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_append_to_connected_to_stack'>append_to_connected_to_stack</span>(<span class='id identifier rubyid_entry'>entry</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_shard_swapping_prohibited?'><a href="#shard_swapping_prohibited%3F-instance_method" title="ActiveRecord::ConnectionHandling#shard_swapping_prohibited? (method)">shard_swapping_prohibited?</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_entry'>entry</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_shard'>shard</span>].<span class='id identifier rubyid_present?'>present?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cannot swap `shard` while shard swapping is prohibited.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_connected_to_stack'>connected_to_stack</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_entry'>entry</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="clear_cache!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>clear_cache!</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L332-L334'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='332' data-end='334'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 332</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_clear_cache!'>clear_cache!</span> <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_connection_pool'><a href="#connection_pool-instance_method" title="ActiveRecord::ConnectionHandling#connection_pool (method)">connection_pool</a></span>.<span class='id identifier rubyid_schema_cache'><a href="#schema_cache-instance_method" title="ActiveRecord::ConnectionHandling#schema_cache (method)">schema_cache</a></span>.<span class='id identifier rubyid_clear!'>clear!</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="clear_query_caches_for_current_thread-instance_method">
  <h3 class='signature '>
    #<strong>clear_query_caches_for_current_thread</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Clears the query cache for all connections associated with the current thread.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L244-L248'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='244' data-end='248'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 244</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_clear_query_caches_for_current_thread'>clear_query_caches_for_current_thread</span>
  <span class='id identifier rubyid_connection_handler'>connection_handler</span>.<span class='id identifier rubyid_each_connection_pool'>each_connection_pool</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pool'>pool</span><span class='op'>|</span>
    <span class='id identifier rubyid_pool'>pool</span>.<span class='id identifier rubyid_clear_query_cache'>clear_query_cache</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connected_to-instance_method">
  <h3 class='signature '>
    #<strong>connected_to</strong>(role: nil, shard: nil, prevent_writes: false, &amp;blk)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Connects to a role (e.g. writing, reading, or a custom role) and/or shard for the duration of the block. At the end of the block the connection will be returned to the original role / shard.</p>

<p>If only a role is passed, Active Record will look up the connection based on the requested role. If a non-established role is requested an <a href="ConnectionNotEstablished.html" title="ActiveRecord::ConnectionNotEstablished (class)"><code>ConnectionNotEstablished</code></a> error will be raised:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to'>connected_to</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_writing'>writing</span>) <span class='kw'>do</span>
  <span class='const'>Dog</span>.<span class='id identifier rubyid_create!'>create!</span> <span class='comment'># creates dog using dog writing connection
</span><span class='kw'>end</span>

<span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to'>connected_to</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span>) <span class='kw'>do</span>
  <span class='const'>Dog</span>.<span class='id identifier rubyid_create!'>create!</span> <span class='comment'># throws exception because we&#39;re on a replica
</span><span class='kw'>end</span></code></pre>

<p>When swapping to a shard, the role must be passed as well. If a non-existent shard is passed, an <a href="ConnectionNotEstablished.html" title="ActiveRecord::ConnectionNotEstablished (class)"><code>ConnectionNotEstablished</code></a> error will be raised.</p>

<p>When a shard and role is passed, Active Record will first lookup the role, and then look up the connection by shard key.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to'>connected_to</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_shard_one_replica'>shard_one_replica</span>) <span class='kw'>do</span>
  <span class='const'>Dog</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># finds first Dog record stored on the shard one replica
</span><span class='kw'>end</span></code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L134-L148'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='134' data-end='148'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 134</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connected_to'>connected_to</span>(<span class='label'>role:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>prevent_writes:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>)
  <span class='kw'>if</span> <span class='kw'>self</span> <span class='op'>!=</span> <span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_abstract_class'>abstract_class</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>calling `connected_to` is only allowed on ActiveRecord::Base or abstract classes.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_connection_class?'>connection_class?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_primary_class?'><a href="#primary_class%3F-instance_method" title="ActiveRecord::ConnectionHandling#primary_class? (method)">primary_class?</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>calling `connected_to` is only allowed on the abstract class that established the connection.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_role'>role</span> <span class='op'>||</span> <span class='id identifier rubyid_shard'>shard</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>must provide a `shard` and/or `role`.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_with_role_and_shard'><a href="#with_role_and_shard-instance_method" title="ActiveRecord::ConnectionHandling#with_role_and_shard (method)">with_role_and_shard</a></span>(<span class='id identifier rubyid_role'>role</span><span class='comma'>,</span> <span class='id identifier rubyid_shard'>shard</span><span class='comma'>,</span> <span class='id identifier rubyid_prevent_writes'>prevent_writes</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connected_to?-instance_method">
  <h3 class='signature '>
    #<strong>connected_to?</strong>(role:, shard: ActiveRecord::Base.default_shard)  &#x21d2; <code>Boolean</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns true if role is the current connected role and/or current connected shard. If no shard is passed, the default will be used.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to'><a href="#connected_to-instance_method" title="ActiveRecord::ConnectionHandling#connected_to (method)">connected_to</a></span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_writing'>writing</span>) <span class='kw'>do</span>
  <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to?'>connected_to?</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_writing'>writing</span>) <span class='comment'>#=&gt; true
</span>  <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to?'>connected_to?</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span>) <span class='comment'>#=&gt; false
</span><span class='kw'>end</span>

<span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to'><a href="#connected_to-instance_method" title="ActiveRecord::ConnectionHandling#connected_to (method)">connected_to</a></span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_shard_one'>shard_one</span>) <span class='kw'>do</span>
  <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to?'>connected_to?</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_shard_one'>shard_one</span>) <span class='comment'>#=&gt; true
</span>  <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to?'>connected_to?</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_default'>default</span>) <span class='comment'>#=&gt; false
</span>  <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to?'>connected_to?</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_writing'>writing</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_shard_one'>shard_one</span>) <span class='comment'>#=&gt; true
</span><span class='kw'>end</span></code></pre>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L239-L241'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='239' data-end='241'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 239</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connected_to?'>connected_to?</span>(<span class='label'>role:</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_default_shard'><a href="Base.html#default_shard-class_method" title="ActiveRecord::Base.default_shard (method)">default_shard</a></span>)
  <span class='id identifier rubyid_current_role'>current_role</span> <span class='op'>==</span> <span class='id identifier rubyid_role'>role</span>.<span class='id identifier rubyid_to_sym'>to_sym</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_current_shard'>current_shard</span> <span class='op'>==</span> <span class='id identifier rubyid_shard'>shard</span>.<span class='id identifier rubyid_to_sym'>to_sym</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connected_to_many-instance_method">
  <h3 class='signature '>
    #<strong>connected_to_many</strong>(*classes, role:, shard: nil, prevent_writes: false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Connects a role and/or shard to the provided connection names. Optionally <code>prevent_writes</code> can be passed to block writes on a connection. <code>reading</code> will automatically set <code>prevent_writes</code> to true.</p>

<p><code>connected_to_many</code> is an alternative to deeply nested <a href="#connected_to-instance_method" title="ActiveRecord::ConnectionHandling#connected_to (method)">#connected_to</a> blocks.</p>

<p>Usage:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to_many'>connected_to_many</span>(<span class='const'>AnimalsRecord</span><span class='comma'>,</span> <span class='const'>MealsRecord</span><span class='comma'>,</span> <span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span>) <span class='kw'>do</span>
  <span class='const'>Dog</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># Read from animals replica
</span>  <span class='const'>Dinner</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># Read from meals replica
</span>  <span class='const'>Person</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># Read from primary writer
</span><span class='kw'>end</span></code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L163-L176'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='163' data-end='176'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 163</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connected_to_many'>connected_to_many</span>(<span class='op'>*</span><span class='id identifier rubyid_classes'>classes</span><span class='comma'>,</span> <span class='label'>role:</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>prevent_writes:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_classes'>classes</span> <span class='op'>=</span> <span class='id identifier rubyid_classes'>classes</span>.<span class='id identifier rubyid_flatten'>flatten</span>

  <span class='kw'>if</span> <span class='kw'>self</span> <span class='op'>!=</span> <span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span> <span class='op'>||</span> <span class='id identifier rubyid_classes'>classes</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>connected_to_many can only be called on ActiveRecord::Base.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_prevent_writes'>prevent_writes</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_role'>role</span> <span class='op'>==</span> <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span>.<span class='id identifier rubyid_reading_role'><a href="../ActiveRecord.html#reading_role-instance_method" title="ActiveRecord#reading_role (method)">reading_role</a></span>

  <span class='id identifier rubyid_append_to_connected_to_stack'><a href="#append_to_connected_to_stack-instance_method" title="ActiveRecord::ConnectionHandling#append_to_connected_to_stack (method)">append_to_connected_to_stack</a></span>(<span class='label'>role:</span> <span class='id identifier rubyid_role'>role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_shard'>shard</span><span class='comma'>,</span> <span class='label'>prevent_writes:</span> <span class='id identifier rubyid_prevent_writes'>prevent_writes</span><span class='comma'>,</span> <span class='label'>klasses:</span> <span class='id identifier rubyid_classes'>classes</span>)
  <span class='kw'>yield</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_connected_to_stack'>connected_to_stack</span>.<span class='id identifier rubyid_pop'>pop</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connecting_to-instance_method">
  <h3 class='signature '>
    #<strong>connecting_to</strong>(role: default_role, shard: default_shard, prevent_writes: false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Use a specified connection.</p>

<p>This method is useful for ensuring that a specific connection is being used. For example, when booting a console in readonly mode.</p>

<p>It is not recommended to use this method in a request since it does not yield to a block like <a href="#connected_to-instance_method" title="ActiveRecord::ConnectionHandling#connected_to (method)">#connected_to</a>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L185-L189'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='185' data-end='189'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 185</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connecting_to'>connecting_to</span>(<span class='label'>role:</span> <span class='id identifier rubyid_default_role'>default_role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_default_shard'>default_shard</span><span class='comma'>,</span> <span class='label'>prevent_writes:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_prevent_writes'>prevent_writes</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_role'>role</span> <span class='op'>==</span> <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span>.<span class='id identifier rubyid_reading_role'><a href="../ActiveRecord.html#reading_role-instance_method" title="ActiveRecord#reading_role (method)">reading_role</a></span>

  <span class='id identifier rubyid_append_to_connected_to_stack'><a href="#append_to_connected_to_stack-instance_method" title="ActiveRecord::ConnectionHandling#append_to_connected_to_stack (method)">append_to_connected_to_stack</a></span>(<span class='label'>role:</span> <span class='id identifier rubyid_role'>role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_shard'>shard</span><span class='comma'>,</span> <span class='label'>prevent_writes:</span> <span class='id identifier rubyid_prevent_writes'>prevent_writes</span><span class='comma'>,</span> <span class='label'>klasses:</span> [<span class='kw'>self</span>])
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connection-instance_method">
  <h3 class='signature '>
    #<strong>connection</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Alias for <a href="#lease_connection-instance_method" title="ActiveRecord::ConnectionHandling#lease_connection (method)">#lease_connection</a>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L259-L259'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='259' data-end='259'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 259</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_alias_method'>alias_method</span> <span class='symbeg'>:</span><span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_lease_connection'><a href="#lease_connection-instance_method" title="ActiveRecord::ConnectionHandling#lease_connection (method)">lease_connection</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connection_db_config-instance_method">
  <h3 class='signature '>
    #<strong>connection_db_config</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the db_config object from the associated connection:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connection_db_config'>connection_db_config</span>
  <span class='comment'>#&lt;ActiveRecord::DatabaseConfigurations::HashConfig:0x00007fd1acbded10 @env_name=&quot;development&quot;,
</span>    <span class='ivar'>@name</span><span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>primary</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@config</span><span class='op'>=</span>{<span class='label'>pool:</span> <span class='int'>5</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='int'>5000</span><span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>storage/development.sqlite3</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>adapter:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sqlite3</span><span class='tstring_end'>&quot;</span></span>}<span class='op'>&gt;</span></code></pre>

<p>Use only for reading.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L294-L296'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='294' data-end='296'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 294</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connection_db_config'>connection_db_config</span>
  <span class='id identifier rubyid_connection_pool'><a href="#connection_pool-instance_method" title="ActiveRecord::ConnectionHandling#connection_pool (method)">connection_pool</a></span>.<span class='id identifier rubyid_db_config'>db_config</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connection_pool-instance_method">
  <h3 class='signature '>
    #<strong>connection_pool</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L302-L304'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='302' data-end='304'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 302</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connection_pool'>connection_pool</span>
  <span class='id identifier rubyid_connection_handler'>connection_handler</span>.<span class='id identifier rubyid_retrieve_connection_pool'>retrieve_connection_pool</span>(<span class='id identifier rubyid_connection_specification_name'><a href="#connection_specification_name-instance_method" title="ActiveRecord::ConnectionHandling#connection_specification_name (method)">connection_specification_name</a></span><span class='comma'>,</span> <span class='label'>role:</span> <span class='id identifier rubyid_current_role'>current_role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_current_shard'>current_shard</span><span class='comma'>,</span> <span class='label'>strict:</span> <span class='kw'>true</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connects_to-instance_method">
  <h3 class='signature '>
    #<strong>connects_to</strong>(database: {}, shards: {})  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Connects a model to the databases specified. The <code>database</code> keyword takes a hash consisting of a <code>role</code> and a <code>database_key</code>.</p>

<p>This will look up the database config using the <code>database_key</code> and establish a connection to that config.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>AnimalsModel</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_abstract_class'>abstract_class</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_connects_to'>connects_to</span> <span class='label'>database:</span> { <span class='label'>writing:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary'>primary</span><span class='comma'>,</span> <span class='label'>reading:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_replica'>primary_replica</span> }
<span class='kw'>end</span></code></pre>

<p><code>connects_to</code> also supports horizontal sharding. The horizontal sharding API supports read replicas as well. You can connect a model to a list of shards like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>AnimalsModel</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_abstract_class'>abstract_class</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_connects_to'>connects_to</span> <span class='label'>shards:</span> {
    <span class='label'>default:</span> { <span class='label'>writing:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary'>primary</span><span class='comma'>,</span> <span class='label'>reading:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_replica'>primary_replica</span> }<span class='comma'>,</span>
    <span class='label'>shard_two:</span> { <span class='label'>writing:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_shard_two'>primary_shard_two</span><span class='comma'>,</span> <span class='label'>reading:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_shard_replica_two'>primary_shard_replica_two</span> }
  }
<span class='kw'>end</span></code></pre>

<p>Returns an array of database connections.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<code>NotImplementedError</code>)</span>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L81-L106'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='81' data-end='106'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 81</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connects_to'>connects_to</span>(<span class='label'>database:</span> {}<span class='comma'>,</span> <span class='label'>shards:</span> {})
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>`connects_to` can only be called on ActiveRecord::Base or abstract classes</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='kw'>self</span> <span class='op'>==</span> <span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span> <span class='op'>||</span> <span class='id identifier rubyid_abstract_class?'>abstract_class?</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_present?'>present?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_shards'>shards</span>.<span class='id identifier rubyid_present?'>present?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>`connects_to` can only accept a `database` or `shards` argument, but not both arguments.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_connections'>connections</span> <span class='op'>=</span> []

  <span class='kw'>if</span> <span class='id identifier rubyid_shards'>shards</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_shards'>shards</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_default'>default</span>] <span class='op'>=</span> <span class='id identifier rubyid_database'>database</span>
  <span class='kw'>end</span>

  <span class='kw'>self</span>.<span class='id identifier rubyid_default_shard'>default_shard</span> <span class='op'>=</span> <span class='id identifier rubyid_shards'>shards</span>.<span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_first'>first</span>

  <span class='id identifier rubyid_shards'>shards</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_shard'>shard</span><span class='comma'>,</span> <span class='id identifier rubyid_database_keys'>database_keys</span><span class='op'>|</span>
    <span class='id identifier rubyid_database_keys'>database_keys</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_role'>role</span><span class='comma'>,</span> <span class='id identifier rubyid_database_key'>database_key</span><span class='op'>|</span>
      <span class='id identifier rubyid_db_config'>db_config</span> <span class='op'>=</span> <span class='id identifier rubyid_resolve_config_for_connection'><a href="#resolve_config_for_connection-instance_method" title="ActiveRecord::ConnectionHandling#resolve_config_for_connection (method)">resolve_config_for_connection</a></span>(<span class='id identifier rubyid_database_key'>database_key</span>)

      <span class='kw'>self</span>.<span class='id identifier rubyid_connection_class'>connection_class</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_connections'>connections</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_connection_handler'>connection_handler</span>.<span class='id identifier rubyid_establish_connection'><a href="#establish_connection-instance_method" title="ActiveRecord::ConnectionHandling#establish_connection (method)">establish_connection</a></span>(<span class='id identifier rubyid_db_config'>db_config</span><span class='comma'>,</span> <span class='label'>owner_name:</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='label'>role:</span> <span class='id identifier rubyid_role'>role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_shard'>shard</span>.<span class='id identifier rubyid_to_sym'>to_sym</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_connections'>connections</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="establish_connection-instance_method">
  <h3 class='signature '>
    #<strong>establish_connection</strong>(config_or_env = nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Establishes the connection to the database. Accepts a hash as input where the <code>:adapter</code> key must be specified with the name of a database adapter (in lower-case) example for regular databases (MySQL, PostgreSQL, etc):</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_establish_connection'>establish_connection</span>(
  <span class='label'>adapter:</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>mysql2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>host:</span>     <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>username:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>myuser</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>password:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>mypass</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>somedatabase</span><span class='tstring_end'>&quot;</span></span>
)</code></pre>

<p>Example for SQLite database:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_establish_connection'>establish_connection</span>(
  <span class='label'>adapter:</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sqlite3</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>path/to/dbfile</span><span class='tstring_end'>&quot;</span></span>
)</code></pre>

<p>Also accepts keys as strings (for parsing from YAML for example):</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_establish_connection'>establish_connection</span>(
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>adapter</span><span class='tstring_end'>&quot;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sqlite3</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>database</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>path/to/dbfile</span><span class='tstring_end'>&quot;</span></span>
)</code></pre>

<p>Or a URL:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_establish_connection'>establish_connection</span>(
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>postgres://myuser:mypass@localhost/somedatabase</span><span class='tstring_end'>&quot;</span></span>
)</code></pre>

<p>In case <code>{ActiveRecord::Base</code>.configurations} is set (Rails automatically loads the contents of config/database.yml into it), a symbol can also be given as argument, representing a key in the configuration hash:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_establish_connection'>establish_connection</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_production'>production</span>)</code></pre>

<p>The exceptions <a href="AdapterNotSpecified.html" title="ActiveRecord::AdapterNotSpecified (class)"><code>AdapterNotSpecified</code></a>, <a href="AdapterNotFound.html" title="ActiveRecord::AdapterNotFound (class)"><code>AdapterNotFound</code></a>, and <code>ArgumentError</code> may be returned on an error.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L50-L54'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='50' data-end='54'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 50</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_establish_connection'>establish_connection</span>(<span class='id identifier rubyid_config_or_env'>config_or_env</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_config_or_env'>config_or_env</span> <span class='op'>||=</span> <span class='const'><a href="#DEFAULT_ENV-constant" title="ActiveRecord::ConnectionHandling::DEFAULT_ENV (constant)">DEFAULT_ENV</a></span>.<span class='id identifier rubyid_call'>call</span>.<span class='id identifier rubyid_to_sym'>to_sym</span>
  <span class='id identifier rubyid_db_config'>db_config</span> <span class='op'>=</span> <span class='id identifier rubyid_resolve_config_for_connection'><a href="#resolve_config_for_connection-instance_method" title="ActiveRecord::ConnectionHandling#resolve_config_for_connection (method)">resolve_config_for_connection</a></span>(<span class='id identifier rubyid_config_or_env'>config_or_env</span>)
  <span class='id identifier rubyid_connection_handler'>connection_handler</span>.<span class='id identifier rubyid_establish_connection'>establish_connection</span>(<span class='id identifier rubyid_db_config'>db_config</span><span class='comma'>,</span> <span class='label'>owner_name:</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='label'>role:</span> <span class='id identifier rubyid_current_role'>current_role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_current_shard'>current_shard</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="lease_connection-instance_method">
  <h3 class='signature '>
    #<strong>lease_connection</strong>  
    <span class='aliases'>Also known as: <span class='names'>#connection</span></span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the connection currently associated with the class. This can also be used to “borrow” the connection to do database work unrelated to any of the specific Active Records. The connection will remain leased for the entire duration of the request or job, or until <a href="#release_connection-instance_method" title="ActiveRecord::ConnectionHandling#release_connection (method)">#release_connection</a> is called.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L255-L257'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='255' data-end='257'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 255</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_lease_connection'>lease_connection</span>
  <span class='id identifier rubyid_connection_pool'><a href="#connection_pool-instance_method" title="ActiveRecord::ConnectionHandling#connection_pool (method)">connection_pool</a></span>.<span class='id identifier rubyid_lease_connection'>lease_connection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="prohibit_shard_swapping-instance_method">
  <h3 class='signature '>
    #<strong>prohibit_shard_swapping</strong>(enabled = true)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Prohibit swapping shards while inside of the passed block.</p>

<p>In some cases you may want to be able to swap shards but not allow a nested call to connected_to or connected_to_many to swap again. This is useful in cases you’re using sharding to provide per-request database isolation.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L197-L203'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='197' data-end='203'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 197</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_prohibit_shard_swapping'>prohibit_shard_swapping</span>(<span class='id identifier rubyid_enabled'>enabled</span> <span class='op'>=</span> <span class='kw'>true</span>)
  <span class='id identifier rubyid_prev_value'>prev_value</span> <span class='op'>=</span> <span class='const'><a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="../ActiveSupport/IsolatedExecutionState.html" title="ActiveSupport::IsolatedExecutionState (module)">IsolatedExecutionState</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_active_record_prohibit_shard_swapping'>active_record_prohibit_shard_swapping</span>]
  <span class='const'><a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="../ActiveSupport/IsolatedExecutionState.html" title="ActiveSupport::IsolatedExecutionState (module)">IsolatedExecutionState</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_active_record_prohibit_shard_swapping'>active_record_prohibit_shard_swapping</span>] <span class='op'>=</span> <span class='id identifier rubyid_enabled'>enabled</span>
  <span class='kw'>yield</span>
<span class='kw'>ensure</span>
  <span class='const'><a href="../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="../ActiveSupport/IsolatedExecutionState.html" title="ActiveSupport::IsolatedExecutionState (module)">IsolatedExecutionState</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_active_record_prohibit_shard_swapping'>active_record_prohibit_shard_swapping</span>] <span class='op'>=</span> <span class='id identifier rubyid_prev_value'>prev_value</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="release_connection-instance_method">
  <h3 class='signature '>
    #<strong>release_connection</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return the currently leased connection into the pool</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L262-L264'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='262' data-end='264'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 262</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_release_connection'>release_connection</span>
  <span class='id identifier rubyid_connection'><a href="#connection-instance_method" title="ActiveRecord::ConnectionHandling#connection (method)">connection</a></span>.<span class='id identifier rubyid_release_connection'>release_connection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="remove_connection-instance_method">
  <h3 class='signature '>
    #<strong>remove_connection</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L315-L326'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='315' data-end='326'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 315</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_connection'>remove_connection</span>
  <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='ivar'>@connection_specification_name</span> <span class='kw'>if</span> <span class='kw'>defined?</span>(<span class='ivar'>@connection_specification_name</span>)

  <span class='comment'># if removing a connection that has a pool, we reset the
</span>  <span class='comment'># connection_specification_name so it will use the parent
</span>  <span class='comment'># pool.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_connection_handler'>connection_handler</span>.<span class='id identifier rubyid_retrieve_connection_pool'>retrieve_connection_pool</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>role:</span> <span class='id identifier rubyid_current_role'>current_role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_current_shard'>current_shard</span>)
    <span class='kw'>self</span>.<span class='id identifier rubyid_connection_specification_name'><a href="#connection_specification_name-instance_method" title="ActiveRecord::ConnectionHandling#connection_specification_name (method)">connection_specification_name</a></span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_connection_handler'>connection_handler</span>.<span class='id identifier rubyid_remove_connection_pool'>remove_connection_pool</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>role:</span> <span class='id identifier rubyid_current_role'>current_role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_current_shard'>current_shard</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="resolve_config_for_connection-instance_method">
  <h3 class='signature priv'>
    #<strong>resolve_config_for_connection</strong>(config_or_env)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L337-L344'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='337' data-end='344'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 337</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_resolve_config_for_connection'>resolve_config_for_connection</span>(<span class='id identifier rubyid_config_or_env'>config_or_env</span>)
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Anonymous class is not allowed.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_connection_name'>connection_name</span> <span class='op'>=</span> <span class='id identifier rubyid_primary_class?'><a href="#primary_class%3F-instance_method" title="ActiveRecord::ConnectionHandling#primary_class? (method)">primary_class?</a></span> <span class='op'>?</span> <span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>:</span> <span class='id identifier rubyid_name'>name</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_connection_specification_name'><a href="#connection_specification_name-instance_method" title="ActiveRecord::ConnectionHandling#connection_specification_name (method)">connection_specification_name</a></span> <span class='op'>=</span> <span class='id identifier rubyid_connection_name'>connection_name</span>

  <span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_configurations'><a href="Base.html#configurations-class_method" title="ActiveRecord::Base.configurations (method)">configurations</a></span>.<span class='id identifier rubyid_resolve'>resolve</span>(<span class='id identifier rubyid_config_or_env'>config_or_env</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="retrieve_connection-instance_method">
  <h3 class='signature '>
    #<strong>retrieve_connection</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L306-L308'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='306' data-end='308'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 306</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_retrieve_connection'>retrieve_connection</span>
  <span class='id identifier rubyid_connection_handler'>connection_handler</span>.<span class='id identifier rubyid_retrieve_connection'>retrieve_connection</span>(<span class='id identifier rubyid_connection_specification_name'><a href="#connection_specification_name-instance_method" title="ActiveRecord::ConnectionHandling#connection_specification_name (method)">connection_specification_name</a></span><span class='comma'>,</span> <span class='label'>role:</span> <span class='id identifier rubyid_current_role'>current_role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_current_shard'>current_shard</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="schema_cache-instance_method">
  <h3 class='signature nodoc'>
    #<strong>schema_cache</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L328-L330'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='328' data-end='330'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 328</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_schema_cache'>schema_cache</span> <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_connection_pool'><a href="#connection_pool-instance_method" title="ActiveRecord::ConnectionHandling#connection_pool (method)">connection_pool</a></span>.<span class='id identifier rubyid_schema_cache'>schema_cache</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="while_preventing_writes-instance_method">
  <h3 class='signature '>
    #<strong>while_preventing_writes</strong>(enabled = true, &amp;block)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Prevent writing to the database regardless of role.</p>

<p>In some cases you may want to prevent writes to the database even if you are on a database that can write. <code>while_preventing_writes</code> will prevent writes to the database for the duration of the block.</p>

<p>This method does not provide the same protection as a readonly user and is meant to be a safeguard against accidental writes.</p>

<p>See <code>READ_QUERY</code> for the queries that are blocked by this method.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L221-L223'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='221' data-end='223'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 221</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_while_preventing_writes'>while_preventing_writes</span>(<span class='id identifier rubyid_enabled'>enabled</span> <span class='op'>=</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_connected_to'><a href="#connected_to-instance_method" title="ActiveRecord::ConnectionHandling#connected_to (method)">connected_to</a></span>(<span class='label'>role:</span> <span class='id identifier rubyid_current_role'>current_role</span><span class='comma'>,</span> <span class='label'>prevent_writes:</span> <span class='id identifier rubyid_enabled'>enabled</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="with_connection-instance_method">
  <h3 class='signature '>
    #<strong>with_connection</strong>(&amp;block)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Checkouts a connection from the pool, yield it and then check it back in. If a connection was already leased via <a href="#connection-instance_method" title="ActiveRecord::ConnectionHandling#connection (method)">#connection</a> or a parent call to <code>#with_connection</code>, that same connection is yieled.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L269-L271'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='269' data-end='271'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 269</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_with_connection'>with_connection</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_connection_pool'><a href="#connection_pool-instance_method" title="ActiveRecord::ConnectionHandling#connection_pool (method)">connection_pool</a></span>.<span class='id identifier rubyid_with_connection'>with_connection</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="with_role_and_shard-instance_method">
  <h3 class='signature priv'>
    #<strong>with_role_and_shard</strong>(role, shard, prevent_writes)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_handling.rb#L346-L355'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='346' data-end='355'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_handling.rb', line 346</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_with_role_and_shard'>with_role_and_shard</span>(<span class='id identifier rubyid_role'>role</span><span class='comma'>,</span> <span class='id identifier rubyid_shard'>shard</span><span class='comma'>,</span> <span class='id identifier rubyid_prevent_writes'>prevent_writes</span>)
  <span class='id identifier rubyid_prevent_writes'>prevent_writes</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_role'>role</span> <span class='op'>==</span> <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span>.<span class='id identifier rubyid_reading_role'><a href="../ActiveRecord.html#reading_role-instance_method" title="ActiveRecord#reading_role (method)">reading_role</a></span>

  <span class='id identifier rubyid_append_to_connected_to_stack'><a href="#append_to_connected_to_stack-instance_method" title="ActiveRecord::ConnectionHandling#append_to_connected_to_stack (method)">append_to_connected_to_stack</a></span>(<span class='label'>role:</span> <span class='id identifier rubyid_role'>role</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='id identifier rubyid_shard'>shard</span><span class='comma'>,</span> <span class='label'>prevent_writes:</span> <span class='id identifier rubyid_prevent_writes'>prevent_writes</span><span class='comma'>,</span> <span class='label'>klasses:</span> [<span class='kw'>self</span>])
  <span class='id identifier rubyid_return_value'>return_value</span> <span class='op'>=</span> <span class='kw'>yield</span>
  <span class='id identifier rubyid_return_value'>return_value</span>.<span class='id identifier rubyid_load'>load</span> <span class='kw'>if</span> <span class='id identifier rubyid_return_value'>return_value</span>.<span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Relation.html" title="ActiveRecord::Relation (class)">Relation</a></span>
  <span class='id identifier rubyid_return_value'>return_value</span>
<span class='kw'>ensure</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_connected_to_stack'>connected_to_stack</span>.<span class='id identifier rubyid_pop'>pop</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>