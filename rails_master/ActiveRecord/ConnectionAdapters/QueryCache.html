<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ActiveRecord::ConnectionAdapters::QueryCache &mdash; Rails main</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::ConnectionAdapters::QueryCache",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Rails main</a> &raquo; 
      <a href='../../_index.html#alpha_Q'>Index (Q)</a> &raquo; 
        <a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
        <a href="../ConnectionAdapters.html" title="ActiveRecord::ConnectionAdapters (module)">ConnectionAdapters</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>QueryCache&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: ActiveRecord::ConnectionAdapters::QueryCache</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Modules:</div>
      <div class='box_11'>
          <a class='nodoc' href="QueryCache/ConnectionPoolConfiguration.html" title="ActiveRecord::ConnectionAdapters::QueryCache::ConnectionPoolConfiguration (module)"><code>ConnectionPoolConfiguration</code></a>      </div>
    </td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a class='nodoc' href="QueryCache/Store.html" title="ActiveRecord::ConnectionAdapters::QueryCache::Store (class)"><code>Store</code></a>      </div>
    </td></tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L7'>activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='DEFAULT_SIZE-constant' class='summary_signature nodoc'>DEFAULT_SIZE =</span>
    <span class='nodoc note title'>Internal use only</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L8-L8'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 8</a>    <pre class='code ruby'><span class='int'>100</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#dirties_query_cache-class_method" title=".dirties_query_cache (class method)">.<strong>dirties_query_cache</strong>(base, *method_names)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#included-class_method" title=".included (class method)">.<strong>included</strong>(base)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature rw'>
      <a href="#query_cache-instance_method" title="#query_cache (instance method)">#<strong>query_cache</strong>  </a>
    </span>
    <span class='note title rw'>rw</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#cache-instance_method" title="#cache (instance method)">#<strong>cache</strong>(&amp;block)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Enable the query cache within the block.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#clear_query_cache-instance_method" title="#clear_query_cache (instance method)">#<strong>clear_query_cache</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Clears the query cache.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#disable_query_cache!-instance_method" title="#disable_query_cache! (instance method)">#<strong>disable_query_cache!</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#enable_query_cache!-instance_method" title="#enable_query_cache! (instance method)">#<strong>enable_query_cache!</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#query_cache_enabled-instance_method" title="#query_cache_enabled (instance method)">#<strong>query_cache_enabled</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#uncached-instance_method" title="#uncached (instance method)">#<strong>uncached</strong>(dirties: true, &amp;block)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Disable the query cache within the block.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#cache_notification_info-instance_method" title="#cache_notification_info (instance method)">#<strong>cache_notification_info</strong>(sql, name, binds)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Database adapters can override this method to provide custom cache information.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#cache_sql-instance_method" title="#cache_sql (instance method)">#<strong>cache_sql</strong>(sql, name, binds)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#lookup_sql_cache-instance_method" title="#lookup_sql_cache (instance method)">#<strong>lookup_sql_cache</strong>(sql, name, binds)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#unset_query_cache!-instance_method" title="#unset_query_cache! (instance method)">#<strong>unset_query_cache!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#select_all-instance_method" title="#select_all (instance method)">#<strong>select_all</strong>(arel, name = nil, binds = [], preparable: nil, async: false, allow_retry: false)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Class Method Details</h2>
<section class='method_details first' id="dirties_query_cache-class_method">
  <h3 class='signature  first'>
    .<strong>dirties_query_cache</strong>(base, *method_names)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L19-L30'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='19' data-end='30'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 19</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_dirties_query_cache'>dirties_query_cache</span>(<span class='id identifier rubyid_base'>base</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_method_names'>method_names</span>)
  <span class='id identifier rubyid_method_names'>method_names</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_method_name'>method_name</span><span class='op'>|</span>
    <span class='id identifier rubyid_base'>base</span>.<span class='id identifier rubyid_class_eval'>class_eval</span> <span class='heredoc_beg'>&lt;&lt;-end_code</span><span class='comma'>,</span> <span class='kw'>__FILE__</span><span class='comma'>,</span> <span class='kw'>__LINE__</span> <span class='op'>+</span> <span class='int'>1</span>
<span class='tstring_content'>      def </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_method_name'>method_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>(...)
        if pool.dirties_query_cache
          ActiveRecord::Base.clear_query_caches_for_current_thread
        end
        super
      end
</span><span class='heredoc_end'>    end_code
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="included-class_method">
  <h3 class='signature nodoc'>
    .<strong>included</strong>(base)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L11-L17'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='11' data-end='17'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 11</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_included'>included</span>(<span class='id identifier rubyid_base'>base</span>) <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_dirties_query_cache'><a href="#dirties_query_cache-class_method" title="ActiveRecord::ConnectionAdapters::QueryCache.dirties_query_cache (method)">dirties_query_cache</a></span> <span class='id identifier rubyid_base'>base</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_exec_query'>exec_query</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_execute'>execute</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_create'>create</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_insert'>insert</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update'>update</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_delete'>delete</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_truncate'>truncate</span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_truncate_tables'>truncate_tables</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_rollback_to_savepoint'>rollback_to_savepoint</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_rollback_db_transaction'>rollback_db_transaction</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_restart_db_transaction'>restart_db_transaction</span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_exec_insert_all'>exec_insert_all</span>

  <span class='id identifier rubyid_base'>base</span>.<span class='id identifier rubyid_set_callback'>set_callback</span> <span class='symbeg'>:</span><span class='id identifier rubyid_checkin'>checkin</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_after'>after</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unset_query_cache!'><a href="#unset_query_cache!-instance_method" title="ActiveRecord::ConnectionAdapters::QueryCache#unset_query_cache! (method)">unset_query_cache!</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="query_cache-instance_method">
  <h3 class='signature rw first'>
    #<strong>query_cache</strong>   <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L165-L165'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='165' data-end='165'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 165</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbeg'>:</span><span class='id identifier rubyid_query_cache'>query_cache</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="cache-instance_method">
  <h3 class='signature  first'>
    #<strong>cache</strong>(&amp;block)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Enable the query cache within the block.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L177-L179'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='177' data-end='179'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 177</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cache'>cache</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_pool'>pool</span>.<span class='id identifier rubyid_enable_query_cache'>enable_query_cache</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cache_notification_info-instance_method">
  <h3 class='signature priv'>
    #<strong>cache_notification_info</strong>(sql, name, binds)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Database adapters can override this method to provide custom cache information.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L273-L282'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='273' data-end='282'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 273</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cache_notification_info'>cache_notification_info</span>(<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span>)
  {
    <span class='label'>sql:</span> <span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span>
    <span class='label'>binds:</span> <span class='id identifier rubyid_binds'>binds</span><span class='comma'>,</span>
    <span class='label'>type_casted_binds:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_type_casted_binds'>type_casted_binds</span>(<span class='id identifier rubyid_binds'>binds</span>) }<span class='comma'>,</span>
    <span class='label'>name:</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
    <span class='label'>connection:</span> <span class='kw'>self</span><span class='comma'>,</span>
    <span class='label'>cached:</span> <span class='kw'>true</span>
  }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cache_sql-instance_method">
  <h3 class='signature priv'>
    #<strong>cache_sql</strong>(sql, name, binds)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L249-L269'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='249' data-end='269'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 249</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cache_sql'>cache_sql</span>(<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span>)
  <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_binds'>binds</span>.<span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>?</span> <span class='id identifier rubyid_sql'>sql</span> <span class='op'>:</span> [<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span>]
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_hit'>hit</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='ivar'>@query_cache</span>.<span class='id identifier rubyid_compute_if_absent'>compute_if_absent</span>(<span class='id identifier rubyid_key'>key</span>) <span class='kw'>do</span>
      <span class='id identifier rubyid_hit'>hit</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='kw'>yield</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_hit'>hit</span>
    <span class='const'><a href="../../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="../../ActiveSupport/Notifications.html" title="ActiveSupport::Notifications (module)">Notifications</a></span>.<span class='id identifier rubyid_instrument'><a href="../../ActiveSupport/Notifications.html#instrument-class_method" title="ActiveSupport::Notifications.instrument (method)">instrument</a></span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sql.active_record</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='id identifier rubyid_cache_notification_info'><a href="#cache_notification_info-instance_method" title="ActiveRecord::ConnectionAdapters::QueryCache#cache_notification_info (method)">cache_notification_info</a></span>(<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span>)
    )
  <span class='kw'>end</span>

  <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_dup'>dup</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="clear_query_cache-instance_method">
  <h3 class='signature '>
    #<strong>clear_query_cache</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Clears the query cache.</p>

<p>One reason you may wish to call this method explicitly is between queries that ask the database to randomize results. Otherwise the cache would see the same SQL query and repeatedly return the same result each time, silently undermining the randomness you were expecting.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L203-L205'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='203' data-end='205'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 203</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_clear_query_cache'>clear_query_cache</span>
  <span class='id identifier rubyid_pool'>pool</span>.<span class='id identifier rubyid_clear_query_cache'>clear_query_cache</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="disable_query_cache!-instance_method">
  <h3 class='signature '>
    #<strong>disable_query_cache!</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L193-L195'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='193' data-end='195'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 193</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_disable_query_cache!'>disable_query_cache!</span>
  <span class='id identifier rubyid_pool'>pool</span>.<span class='id identifier rubyid_disable_query_cache!'>disable_query_cache!</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="enable_query_cache!-instance_method">
  <h3 class='signature '>
    #<strong>enable_query_cache!</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L181-L183'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='181' data-end='183'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 181</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_enable_query_cache!'>enable_query_cache!</span>
  <span class='id identifier rubyid_pool'>pool</span>.<span class='id identifier rubyid_enable_query_cache!'>enable_query_cache!</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="initialize-instance_method">
  <h3 class='signature '>
    #<strong>initialize</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L167-L170'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='167' data-end='170'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 167</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='op'>*</span>)
  <span class='kw'>super</span>
  <span class='ivar'>@query_cache</span> <span class='op'>=</span> <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="lookup_sql_cache-instance_method">
  <h3 class='signature priv'>
    #<strong>lookup_sql_cache</strong>(sql, name, binds)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L231-L247'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='231' data-end='247'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 231</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_lookup_sql_cache'>lookup_sql_cache</span>(<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span>)
  <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_binds'>binds</span>.<span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>?</span> <span class='id identifier rubyid_sql'>sql</span> <span class='op'>:</span> [<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span>]

  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='ivar'>@query_cache</span>[<span class='id identifier rubyid_key'>key</span>]
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_result'>result</span>
    <span class='const'><a href="../../ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="../../ActiveSupport/Notifications.html" title="ActiveSupport::Notifications (module)">Notifications</a></span>.<span class='id identifier rubyid_instrument'><a href="../../ActiveSupport/Notifications.html#instrument-class_method" title="ActiveSupport::Notifications.instrument (method)">instrument</a></span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sql.active_record</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='id identifier rubyid_cache_notification_info'><a href="#cache_notification_info-instance_method" title="ActiveRecord::ConnectionAdapters::QueryCache#cache_notification_info (method)">cache_notification_info</a></span>(<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span>)
    )
  <span class='kw'>end</span>

  <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="query_cache_enabled-instance_method">
  <h3 class='signature '>
    #<strong>query_cache_enabled</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L172-L174'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='172' data-end='174'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 172</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_query_cache_enabled'>query_cache_enabled</span>
  <span class='ivar'>@query_cache</span><span class='op'>&amp;.</span><span class='id identifier rubyid_enabled?'>enabled?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="select_all-instance_method">
  <h3 class='signature nodoc'>
    #<strong>select_all</strong>(arel, name = nil, binds = [], preparable: nil, async: false, allow_retry: false)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L207-L224'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='207' data-end='224'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 207</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_select_all'>select_all</span>(<span class='id identifier rubyid_arel'>arel</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span> <span class='op'>=</span> []<span class='comma'>,</span> <span class='label'>preparable:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>async:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>allow_retry:</span> <span class='kw'>false</span>) <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_arel'>arel</span> <span class='op'>=</span> <span class='id identifier rubyid_arel_from_relation'>arel_from_relation</span>(<span class='id identifier rubyid_arel'>arel</span>)

  <span class='comment'># If arel is locked this is a SELECT ... FOR UPDATE or somesuch.
</span>  <span class='comment'># Such queries should not be cached.
</span>  <span class='kw'>if</span> <span class='ivar'>@query_cache</span><span class='op'>&amp;.</span><span class='id identifier rubyid_enabled?'>enabled?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span>(<span class='id identifier rubyid_arel'>arel</span>.<span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_locked'>locked</span>) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_arel'>arel</span>.<span class='id identifier rubyid_locked'>locked</span>)
    <span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span><span class='comma'>,</span> <span class='id identifier rubyid_preparable'>preparable</span><span class='comma'>,</span> <span class='id identifier rubyid_allow_retry'>allow_retry</span> <span class='op'>=</span> <span class='id identifier rubyid_to_sql_and_binds'>to_sql_and_binds</span>(<span class='id identifier rubyid_arel'>arel</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span><span class='comma'>,</span> <span class='id identifier rubyid_preparable'>preparable</span>)

    <span class='kw'>if</span> <span class='id identifier rubyid_async'>async</span>
      <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_lookup_sql_cache'><a href="#lookup_sql_cache-instance_method" title="ActiveRecord::ConnectionAdapters::QueryCache#lookup_sql_cache (method)">lookup_sql_cache</a></span>(<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span>) <span class='op'>||</span> <span class='kw'>super</span>(<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span><span class='comma'>,</span> <span class='label'>preparable:</span> <span class='id identifier rubyid_preparable'>preparable</span><span class='comma'>,</span> <span class='label'>async:</span> <span class='id identifier rubyid_async'>async</span><span class='comma'>,</span> <span class='label'>allow_retry:</span> <span class='id identifier rubyid_allow_retry'>allow_retry</span>)
      <span class='const'><a href="../FutureResult.html" title="ActiveRecord::FutureResult (class)">FutureResult</a></span>.<span class='id identifier rubyid_wrap'><a href="../FutureResult.html#wrap-class_method" title="ActiveRecord::FutureResult.wrap (method)">wrap</a></span>(<span class='id identifier rubyid_result'>result</span>)
    <span class='kw'>else</span>
      <span class='id identifier rubyid_cache_sql'><a href="#cache_sql-instance_method" title="ActiveRecord::ConnectionAdapters::QueryCache#cache_sql (method)">cache_sql</a></span>(<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span>) { <span class='kw'>super</span>(<span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_binds'>binds</span><span class='comma'>,</span> <span class='label'>preparable:</span> <span class='id identifier rubyid_preparable'>preparable</span><span class='comma'>,</span> <span class='label'>async:</span> <span class='id identifier rubyid_async'>async</span><span class='comma'>,</span> <span class='label'>allow_retry:</span> <span class='id identifier rubyid_allow_retry'>allow_retry</span>) }
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='kw'>super</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="uncached-instance_method">
  <h3 class='signature '>
    #<strong>uncached</strong>(dirties: true, &amp;block)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Disable the query cache within the block.</p>

<p>Set <code>dirties: false</code> to prevent query caches on all connections from being cleared by write operations. (By default, write operations dirty all connections’ query caches in case they are replicas whose cache would now be outdated.)</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L189-L191'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='189' data-end='191'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 189</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_uncached'>uncached</span>(<span class='label'>dirties:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_pool'>pool</span>.<span class='id identifier rubyid_disable_query_cache'>disable_query_cache</span>(<span class='label'>dirties:</span> <span class='id identifier rubyid_dirties'>dirties</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="unset_query_cache!-instance_method">
  <h3 class='signature priv'>
    #<strong>unset_query_cache!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb#L227-L229'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='227' data-end='229'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb', line 227</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_unset_query_cache!'>unset_query_cache!</span>
  <span class='ivar'>@query_cache</span> <span class='op'>=</span> <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>