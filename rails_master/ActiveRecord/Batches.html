<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ActiveRecord::Batches &mdash; Rails main</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::Batches",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Rails main</a> &raquo; 
      <a href='../_index.html#alpha_B'>Index (B)</a> &raquo; 
        <a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Batches&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: ActiveRecord::Batches</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a href="Batches/BatchEnumerator.html" title="ActiveRecord::Batches::BatchEnumerator (class)"><code>BatchEnumerator</code></a>      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Included In:</div>
      <div class='box_11'>
        <a class='nodoc' href="AssociationRelation.html" title="ActiveRecord::AssociationRelation (class)"><code>AssociationRelation</code></a>,
          <a href="Associations/CollectionProxy.html" title="ActiveRecord::Associations::CollectionProxy (class)"><code>Associations::CollectionProxy</code></a>,
          <a class='nodoc' href="DisableJoinsAssociationRelation.html" title="ActiveRecord::DisableJoinsAssociationRelation (class)"><code>DisableJoinsAssociationRelation</code></a>,
          <a href="Relation.html" title="ActiveRecord::Relation (class)"><code>Relation</code></a>
      </div>
    </td></tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2 o'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L7'>activerecord/lib/active_record/relation/batches.rb</a><span class='defines'>,<br /><a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches/batch_enumerator.rb#L4'>activerecord/lib/active_record/relation/batches/batch_enumerator.rb</a></span>
      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='DEFAULT_ORDER-constant' class='summary_signature'>DEFAULT_ORDER =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L9-L9'># File 'activerecord/lib/active_record/relation/batches.rb', line 9</a>    <pre class='code ruby'><span class='symbeg'>:</span><span class='id identifier rubyid_asc'>asc</span></pre>
  </li>
  <li>
    <span id='ORDER_IGNORE_MESSAGE-constant' class='summary_signature'>ORDER_IGNORE_MESSAGE =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L8-L8'># File 'activerecord/lib/active_record/relation/batches.rb', line 8</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Scoped order is ignored, use :cursor with :order to configure custom order.</span><span class='tstring_end'>&quot;</span></span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#find_each-instance_method" title="#find_each (instance method)">#<strong>find_each</strong>(start: nil, finish: nil, batch_size: 1000, error_on_ignore: nil, cursor: primary_key, order: DEFAULT_ORDER, &amp;block)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Looping through a collection of records from the database (using the <a href="Scoping/Named/ClassMethods.html#all-instance_method" title="ActiveRecord::Scoping::Named::ClassMethods#all (method)">Scoping::Named::ClassMethods#all</a> method, for example) is very inefficient since it will try to instantiate all the objects at once.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#find_in_batches-instance_method" title="#find_in_batches (instance method)">#<strong>find_in_batches</strong>(start: nil, finish: nil, batch_size: 1000, error_on_ignore: nil, cursor: primary_key, order: DEFAULT_ORDER)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Yields each batch of records that was found by the find options as an array.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#in_batches-instance_method" title="#in_batches (instance method)">#<strong>in_batches</strong>(of: 1000, start: nil, finish: nil, load: false, error_on_ignore: nil, cursor: primary_key, order: DEFAULT_ORDER, use_ranges: nil, &amp;block)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Yields <a href="Relation.html" title="ActiveRecord::Relation (class)"><code>Relation</code></a> objects to work with a batch of records.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#act_on_ignored_order-instance_method" title="#act_on_ignored_order (instance method)">#<strong>act_on_ignored_order</strong>(error_on_ignore)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#apply_finish_limit-instance_method" title="#apply_finish_limit (instance method)">#<strong>apply_finish_limit</strong>(relation, cursor, finish, batch_orders)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#apply_limits-instance_method" title="#apply_limits (instance method)">#<strong>apply_limits</strong>(relation, cursor, start, finish, batch_orders)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#apply_start_limit-instance_method" title="#apply_start_limit (instance method)">#<strong>apply_start_limit</strong>(relation, cursor, start, batch_orders)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#batch_condition-instance_method" title="#batch_condition (instance method)">#<strong>batch_condition</strong>(relation, cursor, values, operators)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#batch_on_loaded_relation-instance_method" title="#batch_on_loaded_relation (instance method)">#<strong>batch_on_loaded_relation</strong>(relation:, start:, finish:, cursor:, order:, batch_limit:)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#batch_on_unloaded_relation-instance_method" title="#batch_on_unloaded_relation (instance method)">#<strong>batch_on_unloaded_relation</strong>(relation:, start:, finish:, load:, cursor:, order:, use_ranges:, remaining:, batch_limit:)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#build_batch_orders-instance_method" title="#build_batch_orders (instance method)">#<strong>build_batch_orders</strong>(cursor, order)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#compare_values_for_order-instance_method" title="#compare_values_for_order (instance method)">#<strong>compare_values_for_order</strong>(values1, values2, order)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>This is a custom implementation of <code><=></code> operator, which also takes into account how the collection will be ordered.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#ensure_valid_options_for_batching!-instance_method" title="#ensure_valid_options_for_batching! (instance method)">#<strong>ensure_valid_options_for_batching!</strong>(cursor, start, finish, order)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#record_cursor_values-instance_method" title="#record_cursor_values (instance method)">#<strong>record_cursor_values</strong>(record, cursor)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="act_on_ignored_order-instance_method">
  <h3 class='signature priv first'>
    #<strong>act_on_ignored_order</strong>(error_on_ignore)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L369-L377'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='369' data-end='377'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 369</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_act_on_ignored_order'>act_on_ignored_order</span>(<span class='id identifier rubyid_error_on_ignore'>error_on_ignore</span>)
  <span class='id identifier rubyid_raise_error'>raise_error</span> <span class='op'>=</span> (<span class='id identifier rubyid_error_on_ignore'>error_on_ignore</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span>.<span class='id identifier rubyid_error_on_ignored_order'><a href="../ActiveRecord.html#error_on_ignored_order-class_method" title="ActiveRecord.error_on_ignored_order (method)">error_on_ignored_order</a></span> <span class='op'>:</span> <span class='id identifier rubyid_error_on_ignore'>error_on_ignore</span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_raise_error'>raise_error</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span>.<span class='id identifier rubyid_new'>new</span>(<span class='const'><a href="#ORDER_IGNORE_MESSAGE-constant" title="ActiveRecord::Batches::ORDER_IGNORE_MESSAGE (constant)">ORDER_IGNORE_MESSAGE</a></span>)
  <span class='kw'>elsif</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_logger'>logger</span>
    <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_logger'>logger</span>.<span class='id identifier rubyid_warn'>warn</span>(<span class='const'><a href="#ORDER_IGNORE_MESSAGE-constant" title="ActiveRecord::Batches::ORDER_IGNORE_MESSAGE (constant)">ORDER_IGNORE_MESSAGE</a></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_finish_limit-instance_method">
  <h3 class='signature priv'>
    #<strong>apply_finish_limit</strong>(relation, cursor, finish, batch_orders)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L341-L346'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='341' data-end='346'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 341</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_finish_limit'>apply_finish_limit</span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='id identifier rubyid_batch_orders'>batch_orders</span>)
  <span class='id identifier rubyid_operators'>operators</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_orders'>batch_orders</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid__column'>_column</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span><span class='op'>|</span>
    <span class='id identifier rubyid_order'>order</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span> <span class='op'>?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gteq'>gteq</span> <span class='op'>:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_lteq'>lteq</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_batch_condition'><a href="#batch_condition-instance_method" title="ActiveRecord::Batches#batch_condition (method)">batch_condition</a></span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='id identifier rubyid_operators'>operators</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_limits-instance_method">
  <h3 class='signature priv'>
    #<strong>apply_limits</strong>(relation, cursor, start, finish, batch_orders)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L328-L332'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='328' data-end='332'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 328</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_limits'>apply_limits</span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='id identifier rubyid_batch_orders'>batch_orders</span>)
  <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='id identifier rubyid_apply_start_limit'><a href="#apply_start_limit-instance_method" title="ActiveRecord::Batches#apply_start_limit (method)">apply_start_limit</a></span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='id identifier rubyid_batch_orders'>batch_orders</span>) <span class='kw'>if</span> <span class='id identifier rubyid_start'>start</span>
  <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='id identifier rubyid_apply_finish_limit'><a href="#apply_finish_limit-instance_method" title="ActiveRecord::Batches#apply_finish_limit (method)">apply_finish_limit</a></span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='id identifier rubyid_batch_orders'>batch_orders</span>) <span class='kw'>if</span> <span class='id identifier rubyid_finish'>finish</span>
  <span class='id identifier rubyid_relation'>relation</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_start_limit-instance_method">
  <h3 class='signature priv'>
    #<strong>apply_start_limit</strong>(relation, cursor, start, batch_orders)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L334-L339'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='334' data-end='339'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 334</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_start_limit'>apply_start_limit</span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='id identifier rubyid_batch_orders'>batch_orders</span>)
  <span class='id identifier rubyid_operators'>operators</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_orders'>batch_orders</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid__column'>_column</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span><span class='op'>|</span>
    <span class='id identifier rubyid_order'>order</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span> <span class='op'>?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_lteq'>lteq</span> <span class='op'>:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gteq'>gteq</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_batch_condition'><a href="#batch_condition-instance_method" title="ActiveRecord::Batches#batch_condition (method)">batch_condition</a></span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='id identifier rubyid_operators'>operators</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="batch_condition-instance_method">
  <h3 class='signature priv'>
    #<strong>batch_condition</strong>(relation, cursor, values, operators)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L348-L361'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='348' data-end='361'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 348</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_batch_condition'>batch_condition</span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span><span class='comma'>,</span> <span class='id identifier rubyid_operators'>operators</span>)
  <span class='id identifier rubyid_cursor_positions'>cursor_positions</span> <span class='op'>=</span> <span class='id identifier rubyid_cursor'>cursor</span>.<span class='id identifier rubyid_zip'>zip</span>(<span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_values'>values</span>)<span class='comma'>,</span> <span class='id identifier rubyid_operators'>operators</span>)

  <span class='id identifier rubyid_first_clause_column'>first_clause_column</span><span class='comma'>,</span> <span class='id identifier rubyid_first_clause_value'>first_clause_value</span><span class='comma'>,</span> <span class='id identifier rubyid_operator'>operator</span> <span class='op'>=</span> <span class='id identifier rubyid_cursor_positions'>cursor_positions</span>.<span class='id identifier rubyid_pop'>pop</span>
  <span class='id identifier rubyid_where_clause'>where_clause</span> <span class='op'>=</span> <span class='id identifier rubyid_predicate_builder'>predicate_builder</span>[<span class='id identifier rubyid_first_clause_column'>first_clause_column</span><span class='comma'>,</span> <span class='id identifier rubyid_first_clause_value'>first_clause_value</span><span class='comma'>,</span> <span class='id identifier rubyid_operator'>operator</span>]

  <span class='id identifier rubyid_cursor_positions'>cursor_positions</span>.<span class='id identifier rubyid_reverse_each'>reverse_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_column_name'>column_name</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_operator'>operator</span><span class='op'>|</span>
    <span class='id identifier rubyid_where_clause'>where_clause</span> <span class='op'>=</span> <span class='id identifier rubyid_predicate_builder'>predicate_builder</span>[<span class='id identifier rubyid_column_name'>column_name</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_operator'>operator</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_lteq'>lteq</span> <span class='op'>?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_lt'>lt</span> <span class='op'>:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gt'>gt</span>].<span class='id identifier rubyid_or'>or</span>(
      <span class='id identifier rubyid_predicate_builder'>predicate_builder</span>[<span class='id identifier rubyid_column_name'>column_name</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_eq'>eq</span>].<span class='id identifier rubyid_and'>and</span>(<span class='id identifier rubyid_where_clause'>where_clause</span>)
    )
  <span class='kw'>end</span>

  <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_where'>where</span>(<span class='id identifier rubyid_where_clause'>where_clause</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="batch_on_loaded_relation-instance_method">
  <h3 class='signature priv'>
    #<strong>batch_on_loaded_relation</strong>(relation:, start:, finish:, cursor:, order:, batch_limit:)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L379-L406'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='379' data-end='406'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 379</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_batch_on_loaded_relation'>batch_on_loaded_relation</span>(<span class='label'>relation:</span><span class='comma'>,</span> <span class='label'>start:</span><span class='comma'>,</span> <span class='label'>finish:</span><span class='comma'>,</span> <span class='label'>cursor:</span><span class='comma'>,</span> <span class='label'>order:</span><span class='comma'>,</span> <span class='label'>batch_limit:</span>)
  <span class='id identifier rubyid_records'>records</span> <span class='op'>=</span> <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_to_a'>to_a</span>
  <span class='id identifier rubyid_order'>order</span> <span class='op'>=</span> <span class='id identifier rubyid_build_batch_orders'><a href="#build_batch_orders-instance_method" title="ActiveRecord::Batches#build_batch_orders (method)">build_batch_orders</a></span>(<span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>).<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_second'>second</span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_start'>start</span> <span class='op'>||</span> <span class='id identifier rubyid_finish'>finish</span>
    <span class='id identifier rubyid_records'>records</span> <span class='op'>=</span> <span class='id identifier rubyid_records'>records</span>.<span class='id identifier rubyid_filter'>filter</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_record'>record</span><span class='op'>|</span>
      <span class='id identifier rubyid_values'>values</span> <span class='op'>=</span> <span class='id identifier rubyid_record_cursor_values'><a href="#record_cursor_values-instance_method" title="ActiveRecord::Batches#record_cursor_values (method)">record_cursor_values</a></span>(<span class='id identifier rubyid_record'>record</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span>)

      (<span class='id identifier rubyid_start'>start</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_compare_values_for_order'><a href="#compare_values_for_order-instance_method" title="ActiveRecord::Batches#compare_values_for_order (method)">compare_values_for_order</a></span>(<span class='id identifier rubyid_values'>values</span><span class='comma'>,</span> <span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_start'>start</span>)<span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>) <span class='op'>&gt;=</span> <span class='int'>0</span>) <span class='op'>&amp;&amp;</span>
        (<span class='id identifier rubyid_finish'>finish</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_compare_values_for_order'><a href="#compare_values_for_order-instance_method" title="ActiveRecord::Batches#compare_values_for_order (method)">compare_values_for_order</a></span>(<span class='id identifier rubyid_values'>values</span><span class='comma'>,</span> <span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_finish'>finish</span>)<span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>) <span class='op'>&lt;=</span> <span class='int'>0</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_records'>records</span>.<span class='id identifier rubyid_sort!'>sort!</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_record1'>record1</span><span class='comma'>,</span> <span class='id identifier rubyid_record2'>record2</span><span class='op'>|</span>
    <span class='id identifier rubyid_values1'>values1</span> <span class='op'>=</span> <span class='id identifier rubyid_record_cursor_values'><a href="#record_cursor_values-instance_method" title="ActiveRecord::Batches#record_cursor_values (method)">record_cursor_values</a></span>(<span class='id identifier rubyid_record1'>record1</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span>)
    <span class='id identifier rubyid_values2'>values2</span> <span class='op'>=</span> <span class='id identifier rubyid_record_cursor_values'><a href="#record_cursor_values-instance_method" title="ActiveRecord::Batches#record_cursor_values (method)">record_cursor_values</a></span>(<span class='id identifier rubyid_record2'>record2</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span>)
    <span class='id identifier rubyid_compare_values_for_order'><a href="#compare_values_for_order-instance_method" title="ActiveRecord::Batches#compare_values_for_order (method)">compare_values_for_order</a></span>(<span class='id identifier rubyid_values1'>values1</span><span class='comma'>,</span> <span class='id identifier rubyid_values2'>values2</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_records'>records</span>.<span class='id identifier rubyid_each_slice'>each_slice</span>(<span class='id identifier rubyid_batch_limit'>batch_limit</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_subrecords'>subrecords</span><span class='op'>|</span>
    <span class='id identifier rubyid_subrelation'>subrelation</span> <span class='op'>=</span> <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_spawn'>spawn</span>
    <span class='id identifier rubyid_subrelation'>subrelation</span>.<span class='id identifier rubyid_load_records'>load_records</span>(<span class='id identifier rubyid_subrecords'>subrecords</span>)

    <span class='kw'>yield</span> <span class='id identifier rubyid_subrelation'>subrelation</span>
  <span class='kw'>end</span>

  <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="batch_on_unloaded_relation-instance_method">
  <h3 class='signature priv'>
    #<strong>batch_on_unloaded_relation</strong>(relation:, start:, finish:, load:, cursor:, order:, use_ranges:, remaining:, batch_limit:)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L426-L503'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='426' data-end='503'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 426</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_batch_on_unloaded_relation'>batch_on_unloaded_relation</span>(<span class='label'>relation:</span><span class='comma'>,</span> <span class='label'>start:</span><span class='comma'>,</span> <span class='label'>finish:</span><span class='comma'>,</span> <span class='label'>load:</span><span class='comma'>,</span> <span class='label'>cursor:</span><span class='comma'>,</span> <span class='label'>order:</span><span class='comma'>,</span> <span class='label'>use_ranges:</span><span class='comma'>,</span> <span class='label'>remaining:</span><span class='comma'>,</span> <span class='label'>batch_limit:</span>)
  <span class='id identifier rubyid_batch_orders'>batch_orders</span> <span class='op'>=</span> <span class='id identifier rubyid_build_batch_orders'><a href="#build_batch_orders-instance_method" title="ActiveRecord::Batches#build_batch_orders (method)">build_batch_orders</a></span>(<span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>)
  <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_reorder'>reorder</span>(<span class='id identifier rubyid_batch_orders'>batch_orders</span>.<span class='id identifier rubyid_to_h'>to_h</span>).<span class='id identifier rubyid_limit'>limit</span>(<span class='id identifier rubyid_batch_limit'>batch_limit</span>)
  <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='id identifier rubyid_apply_limits'><a href="#apply_limits-instance_method" title="ActiveRecord::Batches#apply_limits (method)">apply_limits</a></span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='id identifier rubyid_batch_orders'>batch_orders</span>)
  <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_skip_query_cache!'>skip_query_cache!</span> <span class='comment'># Retaining the results in the query cache would undermine the point of batching
</span>  <span class='id identifier rubyid_batch_relation'>batch_relation</span> <span class='op'>=</span> <span class='id identifier rubyid_relation'>relation</span>
  <span class='id identifier rubyid_empty_scope'>empty_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_to_sql'>to_sql</span> <span class='op'>==</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_unscoped'>unscoped</span>.<span class='id identifier rubyid_all'>all</span>.<span class='id identifier rubyid_to_sql'>to_sql</span>

  <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_load'>load</span>
      <span class='id identifier rubyid_records'>records</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_relation'>batch_relation</span>.<span class='id identifier rubyid_records'>records</span>
      <span class='id identifier rubyid_values'>values</span> <span class='op'>=</span> <span class='id identifier rubyid_records'>records</span>.<span class='id identifier rubyid_pluck'>pluck</span>(<span class='op'>*</span><span class='id identifier rubyid_cursor'>cursor</span>)
      <span class='id identifier rubyid_values_size'>values_size</span> <span class='op'>=</span> <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_size'>size</span>
      <span class='id identifier rubyid_values_last'>values_last</span> <span class='op'>=</span> <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_last'>last</span>
      <span class='id identifier rubyid_yielded_relation'>yielded_relation</span> <span class='op'>=</span> <span class='id identifier rubyid_where'>where</span>(<span class='id identifier rubyid_cursor'>cursor</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_values'>values</span>)
      <span class='id identifier rubyid_yielded_relation'>yielded_relation</span>.<span class='id identifier rubyid_load_records'>load_records</span>(<span class='id identifier rubyid_records'>records</span>)
    <span class='kw'>elsif</span> (<span class='id identifier rubyid_empty_scope'>empty_scope</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_use_ranges'>use_ranges</span> <span class='op'>!=</span> <span class='kw'>false</span>) <span class='op'>||</span> <span class='id identifier rubyid_use_ranges'>use_ranges</span>
      <span class='comment'># Efficiently peak at the last value for the next batch using offset and limit.
</span>      <span class='id identifier rubyid_values_size'>values_size</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_limit'>batch_limit</span>
      <span class='id identifier rubyid_values_last'>values_last</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_relation'>batch_relation</span>.<span class='id identifier rubyid_offset'>offset</span>(<span class='id identifier rubyid_batch_limit'>batch_limit</span> <span class='op'>-</span> <span class='int'>1</span>).<span class='id identifier rubyid_pick'>pick</span>(<span class='op'>*</span><span class='id identifier rubyid_cursor'>cursor</span>)

      <span class='comment'># If the last value is not found using offset, there is at most one more batch of size &lt; batch_limit.
</span>      <span class='comment'># Retry by getting the whole list of remaining values so that we have the exact size and last value.
</span>      <span class='kw'>unless</span> <span class='id identifier rubyid_values_last'>values_last</span>
        <span class='id identifier rubyid_values'>values</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_relation'>batch_relation</span>.<span class='id identifier rubyid_pluck'>pluck</span>(<span class='op'>*</span><span class='id identifier rubyid_cursor'>cursor</span>)
        <span class='id identifier rubyid_values_size'>values_size</span> <span class='op'>=</span> <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_size'>size</span>
        <span class='id identifier rubyid_values_last'>values_last</span> <span class='op'>=</span> <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_last'>last</span>
      <span class='kw'>end</span>

      <span class='comment'># Finally, build the yielded relation if at least one value found.
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_values_last'>values_last</span>
        <span class='id identifier rubyid_yielded_relation'>yielded_relation</span> <span class='op'>=</span> <span class='id identifier rubyid_apply_finish_limit'><a href="#apply_finish_limit-instance_method" title="ActiveRecord::Batches#apply_finish_limit (method)">apply_finish_limit</a></span>(<span class='id identifier rubyid_batch_relation'>batch_relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_values_last'>values_last</span><span class='comma'>,</span> <span class='id identifier rubyid_batch_orders'>batch_orders</span>)
        <span class='id identifier rubyid_yielded_relation'>yielded_relation</span> <span class='op'>=</span> <span class='id identifier rubyid_yielded_relation'>yielded_relation</span>.<span class='id identifier rubyid_except'>except</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_limit'>limit</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_order'>order</span>)
        <span class='id identifier rubyid_yielded_relation'>yielded_relation</span>.<span class='id identifier rubyid_skip_query_cache!'>skip_query_cache!</span>(<span class='kw'>false</span>)
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_values'>values</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_relation'>batch_relation</span>.<span class='id identifier rubyid_pluck'>pluck</span>(<span class='op'>*</span><span class='id identifier rubyid_cursor'>cursor</span>)
      <span class='id identifier rubyid_values_size'>values_size</span> <span class='op'>=</span> <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_size'>size</span>
      <span class='id identifier rubyid_values_last'>values_last</span> <span class='op'>=</span> <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_last'>last</span>
      <span class='id identifier rubyid_yielded_relation'>yielded_relation</span> <span class='op'>=</span> <span class='id identifier rubyid_where'>where</span>(<span class='id identifier rubyid_cursor'>cursor</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_values'>values</span>)
    <span class='kw'>end</span>

    <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_values_size'>values_size</span> <span class='op'>==</span> <span class='int'>0</span>

    <span class='kw'>if</span> [<span class='id identifier rubyid_values_last'>values_last</span>].<span class='id identifier rubyid_flatten'>flatten</span>.<span class='id identifier rubyid_any?'>any?</span>(<span class='kw'>nil</span>)
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Not all of the batch cursor columns were included in the custom select clause </span><span class='tstring_end'>&quot;</span></span>\
                            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>or some columns contain nil.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='kw'>yield</span> <span class='id identifier rubyid_yielded_relation'>yielded_relation</span>

    <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_values_size'>values_size</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_batch_limit'>batch_limit</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_limit_value'>limit_value</span>
      <span class='id identifier rubyid_remaining'>remaining</span> <span class='op'>-=</span> <span class='id identifier rubyid_values_size'>values_size</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_remaining'>remaining</span> <span class='op'>==</span> <span class='int'>0</span>
        <span class='comment'># Saves a useless iteration when the limit is a multiple of the
</span>        <span class='comment'># batch size.
</span>        <span class='kw'>break</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_remaining'>remaining</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_batch_limit'>batch_limit</span>
        <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_limit'>limit</span>(<span class='id identifier rubyid_remaining'>remaining</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_batch_orders_copy'>batch_orders_copy</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_orders'>batch_orders</span>.<span class='id identifier rubyid_dup'>dup</span>
    <span class='id identifier rubyid__last_column'>_last_column</span><span class='comma'>,</span> <span class='id identifier rubyid_last_order'>last_order</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_orders_copy'>batch_orders_copy</span>.<span class='id identifier rubyid_pop'>pop</span>
    <span class='id identifier rubyid_operators'>operators</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_orders_copy'>batch_orders_copy</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid__column'>_column</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span><span class='op'>|</span>
      <span class='id identifier rubyid_order'>order</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span> <span class='op'>?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_lteq'>lteq</span> <span class='op'>:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gteq'>gteq</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_operators'>operators</span> <span class='op'>&lt;&lt;</span> (<span class='id identifier rubyid_last_order'>last_order</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span> <span class='op'>?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_lt'>lt</span> <span class='op'>:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gt'>gt</span>)

    <span class='id identifier rubyid_cursor_value'>cursor_value</span> <span class='op'>=</span> <span class='id identifier rubyid_values_last'>values_last</span>
    <span class='id identifier rubyid_batch_relation'>batch_relation</span> <span class='op'>=</span> <span class='id identifier rubyid_batch_condition'><a href="#batch_condition-instance_method" title="ActiveRecord::Batches#batch_condition (method)">batch_condition</a></span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor_value'>cursor_value</span><span class='comma'>,</span> <span class='id identifier rubyid_operators'>operators</span>)
  <span class='kw'>end</span>

  <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="build_batch_orders-instance_method">
  <h3 class='signature priv'>
    #<strong>build_batch_orders</strong>(cursor, order)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L363-L367'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='363' data-end='367'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 363</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_build_batch_orders'>build_batch_orders</span>(<span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>)
  <span class='id identifier rubyid_cursor'>cursor</span>.<span class='id identifier rubyid_zip'>zip</span>(<span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_order'>order</span>)).<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_column'>column</span><span class='comma'>,</span> <span class='id identifier rubyid_order_'>order_</span><span class='op'>|</span>
    [<span class='id identifier rubyid_column'>column</span><span class='comma'>,</span> <span class='id identifier rubyid_order_'>order_</span> <span class='op'>||</span> <span class='const'><a href="#DEFAULT_ORDER-constant" title="ActiveRecord::Batches::DEFAULT_ORDER (constant)">DEFAULT_ORDER</a></span>]
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compare_values_for_order-instance_method">
  <h3 class='signature priv'>
    #<strong>compare_values_for_order</strong>(values1, values2, order)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>This is a custom implementation of <code><=></code> operator, which also takes into account how the collection will be ordered.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L414-L424'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='414' data-end='424'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 414</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compare_values_for_order'>compare_values_for_order</span>(<span class='id identifier rubyid_values1'>values1</span><span class='comma'>,</span> <span class='id identifier rubyid_values2'>values2</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>)
  <span class='id identifier rubyid_values1'>values1</span>.<span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_element1'>element1</span><span class='comma'>,</span> <span class='id identifier rubyid_index'>index</span><span class='op'>|</span>
    <span class='id identifier rubyid_element2'>element2</span> <span class='op'>=</span> <span class='id identifier rubyid_values2'>values2</span>[<span class='id identifier rubyid_index'>index</span>]
    <span class='id identifier rubyid_direction'>direction</span> <span class='op'>=</span> <span class='id identifier rubyid_order'>order</span>[<span class='id identifier rubyid_index'>index</span>]
    <span class='id identifier rubyid_comparison'>comparison</span> <span class='op'>=</span> <span class='id identifier rubyid_element1'>element1</span> <span class='op'>&lt;=&gt;</span> <span class='id identifier rubyid_element2'>element2</span>
    <span class='id identifier rubyid_comparison'>comparison</span> <span class='op'>=</span> <span class='op'>-</span><span class='id identifier rubyid_comparison'>comparison</span> <span class='kw'>if</span> <span class='id identifier rubyid_direction'>direction</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_comparison'>comparison</span> <span class='kw'>if</span> <span class='id identifier rubyid_comparison'>comparison</span> <span class='op'>!=</span> <span class='int'>0</span>
  <span class='kw'>end</span>

  <span class='int'>0</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ensure_valid_options_for_batching!-instance_method">
  <h3 class='signature priv'>
    #<strong>ensure_valid_options_for_batching!</strong>(cursor, start, finish, order)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L305-L326'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='305' data-end='326'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 305</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ensure_valid_options_for_batching!'>ensure_valid_options_for_batching!</span>(<span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_start'>start</span> <span class='op'>&amp;&amp;</span> <span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_start'>start</span>).<span class='id identifier rubyid_size'>size</span> <span class='op'>!=</span> <span class='id identifier rubyid_cursor'>cursor</span>.<span class='id identifier rubyid_size'>size</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:start must contain one value per cursor column</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_finish'>finish</span> <span class='op'>&amp;&amp;</span> <span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_finish'>finish</span>).<span class='id identifier rubyid_size'>size</span> <span class='op'>!=</span> <span class='id identifier rubyid_cursor'>cursor</span>.<span class='id identifier rubyid_size'>size</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:finish must contain one value per cursor column</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> (<span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_primary_key'>primary_key</span>) <span class='op'>-</span> <span class='id identifier rubyid_cursor'>cursor</span>).<span class='id identifier rubyid_any?'>any?</span>
    <span class='id identifier rubyid_indexes'>indexes</span> <span class='op'>=</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_schema_cache'>schema_cache</span>.<span class='id identifier rubyid_indexes'>indexes</span>(<span class='id identifier rubyid_table_name'>table_name</span>)
    <span class='id identifier rubyid_unique_index'>unique_index</span> <span class='op'>=</span> <span class='id identifier rubyid_indexes'>indexes</span>.<span class='id identifier rubyid_find'>find</span> { <span class='op'>|</span><span class='id identifier rubyid_index'>index</span><span class='op'>|</span> <span class='id identifier rubyid_index'>index</span>.<span class='id identifier rubyid_unique'>unique</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_index'>index</span>.<span class='id identifier rubyid_where'>where</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> (<span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_index'>index</span>.<span class='id identifier rubyid_columns'>columns</span>) <span class='op'>-</span> <span class='id identifier rubyid_cursor'>cursor</span>).<span class='id identifier rubyid_empty?'>empty?</span> }

    <span class='kw'>unless</span> <span class='id identifier rubyid_unique_index'>unique_index</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:cursor must include a primary key or other unique column(s)</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> (<span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_order'>order</span>) <span class='op'>-</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_asc'>asc</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span>]).<span class='id identifier rubyid_any?'>any?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:order must be :asc or :desc or an array consisting of :asc or :desc, got </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_order'>order</span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="find_each-instance_method">
  <h3 class='signature '>
    #<strong>find_each</strong>(start: nil, finish: nil, batch_size: 1000, error_on_ignore: nil, cursor: primary_key, order: DEFAULT_ORDER, &amp;block)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Looping through a collection of records from the database (using the <a href="Scoping/Named/ClassMethods.html#all-instance_method" title="ActiveRecord::Scoping::Named::ClassMethods#all (method)">Scoping::Named::ClassMethods#all</a> method, for example) is very inefficient since it will try to instantiate all the objects at once.</p>

<p>In that case, batch processing methods allow you to work with the records in batches, thereby greatly reducing memory consumption.</p>

<p>The <code>#find_each</code> method uses <a href="#find_in_batches-instance_method" title="ActiveRecord::Batches#find_in_batches (method)">#find_in_batches</a> with a batch size of 1000 (or as specified by the <code>:batch_size</code> option).</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_find_each'>find_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_do_awesome_stuff'>do_awesome_stuff</span>
<span class='kw'>end</span>

<span class='const'>Person</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>age &gt; 21</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_find_each'>find_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span>
<span class='kw'>end</span></code></pre>

<p>If you do not provide a block to <code>#find_each</code>, it will return an Enumerator for chaining with other methods:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_find_each'>find_each</span>.<span class='id identifier rubyid_with_index'>with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='comma'>,</span> <span class='id identifier rubyid_index'>index</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_award_trophy'>award_trophy</span>(<span class='id identifier rubyid_index'>index</span> <span class='op'>+</span> <span class='int'>1</span>)
<span class='kw'>end</span></code></pre>

<h4 id="label-Options">Options</h4>
<ul><li>
<p><code>:batch_size</code> - Specifies the size of the batch. Defaults to 1000.</p>
</li><li>
<p><code>:start</code> - Specifies the cursor column value to start from, inclusive of the value.</p>
</li><li>
<p><code>:finish</code> - Specifies the cursor column value to end at, inclusive of the value.</p>
</li><li>
<p><code>:error_on_ignore</code> - Overrides the application config to specify if an error should be raised when an order is present in the relation.</p>
</li><li>
<p><code>:cursor</code> - Specifies the column to use for batching (can be a column name or an array of column names). Defaults to primary key.</p>
</li><li>
<p><code>:order</code> - Specifies the cursor column order (can be <code>:asc</code> or <code>:desc</code> or an array consisting of :asc or :desc). Defaults to <code>:asc</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span> <span class='op'>&lt;</span> <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_primary_key'>primary_key</span> <span class='op'>=</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_id_1'>id_1</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id_2'>id_2</span>]
<span class='kw'>end</span>

<span class='const'>Order</span>.<span class='id identifier rubyid_find_each'>find_each</span>(<span class='label'>order:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_asc'>asc</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span>])</code></pre>

<p>In the above code, <code>id_1</code> is sorted in ascending order and <code>id_2</code> in descending order.</p>
</li></ul>

<p>Limits are honored, and if present there is no requirement for the batch size: it can be less than, equal to, or greater than the limit.</p>

<p>The options <code>start</code> and <code>finish</code> are especially useful if you want multiple workers dealing with the same processing queue. You can make worker 1 handle all the records between id 1 and 9999 and worker 2 handle from 10000 and beyond by setting the <code>:start</code> and <code>:finish</code> option on each worker.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># In worker 1, let&#39;s process until 9999 records.
</span><span class='const'>Person</span>.<span class='id identifier rubyid_find_each'>find_each</span>(<span class='label'>finish:</span> <span class='int'>9_999</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span>
<span class='kw'>end</span>

<span class='comment'># In worker 2, let&#39;s process from record 10_000 and onwards.
</span><span class='const'>Person</span>.<span class='id identifier rubyid_find_each'>find_each</span>(<span class='label'>start:</span> <span class='int'>10_000</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: Order can be ascending (:asc) or descending (:desc). It is automatically set to ascending on the primary key (“id ASC”). This also means that this method only works when the cursor column is orderable (e.g. an integer or string).</p>

<p>NOTE: When using custom columns for batching, they should include at least one unique column (e.g. primary key) as a tiebreaker. Also, to reduce the likelihood of race conditions, all columns should be static (unchangeable after it was set).</p>

<p>NOTE: By its nature, batch processing is subject to race conditions if other processes are modifying the database.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L85-L97'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='85' data-end='97'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 85</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_find_each'>find_each</span>(<span class='label'>start:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>finish:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>batch_size:</span> <span class='int'>1000</span><span class='comma'>,</span> <span class='label'>error_on_ignore:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>cursor:</span> <span class='id identifier rubyid_primary_key'>primary_key</span><span class='comma'>,</span> <span class='label'>order:</span> <span class='const'><a href="#DEFAULT_ORDER-constant" title="ActiveRecord::Batches::DEFAULT_ORDER (constant)">DEFAULT_ORDER</a></span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
    <span class='id identifier rubyid_find_in_batches'><a href="#find_in_batches-instance_method" title="ActiveRecord::Batches#find_in_batches (method)">find_in_batches</a></span>(<span class='label'>start:</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='label'>finish:</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='label'>batch_size:</span> <span class='id identifier rubyid_batch_size'>batch_size</span><span class='comma'>,</span> <span class='label'>error_on_ignore:</span> <span class='id identifier rubyid_error_on_ignore'>error_on_ignore</span><span class='comma'>,</span> <span class='label'>cursor:</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='label'>order:</span> <span class='id identifier rubyid_order'>order</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_records'>records</span><span class='op'>|</span>
      <span class='id identifier rubyid_records'>records</span>.<span class='id identifier rubyid_each'>each</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_enum_for'>enum_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_find_each'>find_each</span><span class='comma'>,</span> <span class='label'>start:</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='label'>finish:</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='label'>batch_size:</span> <span class='id identifier rubyid_batch_size'>batch_size</span><span class='comma'>,</span> <span class='label'>error_on_ignore:</span> <span class='id identifier rubyid_error_on_ignore'>error_on_ignore</span><span class='comma'>,</span> <span class='label'>cursor:</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='label'>order:</span> <span class='id identifier rubyid_order'>order</span>) <span class='kw'>do</span>
      <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='kw'>self</span>
      <span class='id identifier rubyid_cursor'>cursor</span> <span class='op'>=</span> <span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_cursor'>cursor</span>)
      <span class='id identifier rubyid_apply_limits'><a href="#apply_limits-instance_method" title="ActiveRecord::Batches#apply_limits (method)">apply_limits</a></span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='id identifier rubyid_build_batch_orders'><a href="#build_batch_orders-instance_method" title="ActiveRecord::Batches#build_batch_orders (method)">build_batch_orders</a></span>(<span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>)).<span class='id identifier rubyid_size'>size</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="find_in_batches-instance_method">
  <h3 class='signature '>
    #<strong>find_in_batches</strong>(start: nil, finish: nil, batch_size: 1000, error_on_ignore: nil, cursor: primary_key, order: DEFAULT_ORDER)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Yields each batch of records that was found by the find options as an array.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>age &gt; 21</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_find_in_batches'>find_in_batches</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_group'>group</span><span class='op'>|</span>
  <span class='id identifier rubyid_sleep'>sleep</span>(<span class='int'>50</span>) <span class='comment'># Make sure it doesn&#39;t get too crowded in there!
</span>  <span class='id identifier rubyid_group'>group</span>.<span class='id identifier rubyid_each'>each</span> { <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span> <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span> }
<span class='kw'>end</span></code></pre>

<p>If you do not provide a block to <code>#find_in_batches</code>, it will return an Enumerator for chaining with other methods:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_find_in_batches'>find_in_batches</span>.<span class='id identifier rubyid_with_index'>with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_group'>group</span><span class='comma'>,</span> <span class='id identifier rubyid_batch'>batch</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Processing group #</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_batch'>batch</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_group'>group</span>.<span class='id identifier rubyid_each'>each</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_recover_from_last_night!'>recover_from_last_night!</span>)
<span class='kw'>end</span></code></pre>

<p>To be yielded each record one by one, use <a href="#find_each-instance_method" title="ActiveRecord::Batches#find_each (method)">#find_each</a> instead.</p>

<h4 id="label-Options">Options</h4>
<ul><li>
<p><code>:batch_size</code> - Specifies the size of the batch. Defaults to 1000.</p>
</li><li>
<p><code>:start</code> - Specifies the cursor column value to start from, inclusive of the value.</p>
</li><li>
<p><code>:finish</code> - Specifies the cursor column value to end at, inclusive of the value.</p>
</li><li>
<p><code>:error_on_ignore</code> - Overrides the application config to specify if an error should be raised when an order is present in the relation.</p>
</li><li>
<p><code>:cursor</code> - Specifies the column to use for batching (can be a column name or an array of column names). Defaults to primary key.</p>
</li><li>
<p><code>:order</code> - Specifies the cursor column order (can be <code>:asc</code> or <code>:desc</code> or an array consisting of :asc or :desc). Defaults to <code>:asc</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span> <span class='op'>&lt;</span> <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_primary_key'>primary_key</span> <span class='op'>=</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_id_1'>id_1</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id_2'>id_2</span>]
<span class='kw'>end</span>

<span class='const'>Order</span>.<span class='id identifier rubyid_find_in_batches'>find_in_batches</span>(<span class='label'>order:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_asc'>asc</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span>])</code></pre>

<p>In the above code, <code>id_1</code> is sorted in ascending order and <code>id_2</code> in descending order.</p>
</li></ul>

<p>Limits are honored, and if present there is no requirement for the batch size: it can be less than, equal to, or greater than the limit.</p>

<p>The options <code>start</code> and <code>finish</code> are especially useful if you want multiple workers dealing with the same processing queue. You can make worker 1 handle all the records between id 1 and 9999 and worker 2 handle from 10000 and beyond by setting the <code>:start</code> and <code>:finish</code> option on each worker.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Let&#39;s process from record 10_000 on.
</span><span class='const'>Person</span>.<span class='id identifier rubyid_find_in_batches'>find_in_batches</span>(<span class='label'>start:</span> <span class='int'>10_000</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_group'>group</span><span class='op'>|</span>
  <span class='id identifier rubyid_group'>group</span>.<span class='id identifier rubyid_each'>each</span> { <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span> <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span> }
<span class='kw'>end</span></code></pre>

<p>NOTE: Order can be ascending (:asc) or descending (:desc). It is automatically set to ascending on the primary key (“id ASC”). This also means that this method only works when the cursor column is orderable (e.g. an integer or string).</p>

<p>NOTE: When using custom columns for batching, they should include at least one unique column (e.g. primary key) as a tiebreaker. Also, to reduce the likelihood of race conditions, all columns should be static (unchangeable after it was set).</p>

<p>NOTE: By its nature, batch processing is subject to race conditions if other processes are modifying the database.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L161-L174'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='161' data-end='174'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 161</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_find_in_batches'>find_in_batches</span>(<span class='label'>start:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>finish:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>batch_size:</span> <span class='int'>1000</span><span class='comma'>,</span> <span class='label'>error_on_ignore:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>cursor:</span> <span class='id identifier rubyid_primary_key'>primary_key</span><span class='comma'>,</span> <span class='label'>order:</span> <span class='const'><a href="#DEFAULT_ORDER-constant" title="ActiveRecord::Batches::DEFAULT_ORDER (constant)">DEFAULT_ORDER</a></span>)
  <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='kw'>self</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_to_enum'>to_enum</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_find_in_batches'>find_in_batches</span><span class='comma'>,</span> <span class='label'>start:</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='label'>finish:</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='label'>batch_size:</span> <span class='id identifier rubyid_batch_size'>batch_size</span><span class='comma'>,</span> <span class='label'>error_on_ignore:</span> <span class='id identifier rubyid_error_on_ignore'>error_on_ignore</span><span class='comma'>,</span> <span class='label'>cursor:</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='label'>order:</span> <span class='id identifier rubyid_order'>order</span>) <span class='kw'>do</span>
      <span class='id identifier rubyid_cursor'>cursor</span> <span class='op'>=</span> <span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_cursor'>cursor</span>)
      <span class='id identifier rubyid_total'>total</span> <span class='op'>=</span> <span class='id identifier rubyid_apply_limits'><a href="#apply_limits-instance_method" title="ActiveRecord::Batches#apply_limits (method)">apply_limits</a></span>(<span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='id identifier rubyid_build_batch_orders'><a href="#build_batch_orders-instance_method" title="ActiveRecord::Batches#build_batch_orders (method)">build_batch_orders</a></span>(<span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>)).<span class='id identifier rubyid_size'>size</span>
      (<span class='id identifier rubyid_total'>total</span> <span class='op'>-</span> <span class='int'>1</span>).<span class='id identifier rubyid_div'>div</span>(<span class='id identifier rubyid_batch_size'>batch_size</span>) <span class='op'>+</span> <span class='int'>1</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_in_batches'><a href="#in_batches-instance_method" title="ActiveRecord::Batches#in_batches (method)">in_batches</a></span>(<span class='label'>of:</span> <span class='id identifier rubyid_batch_size'>batch_size</span><span class='comma'>,</span> <span class='label'>start:</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='label'>finish:</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='label'>load:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>error_on_ignore:</span> <span class='id identifier rubyid_error_on_ignore'>error_on_ignore</span><span class='comma'>,</span> <span class='label'>cursor:</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='label'>order:</span> <span class='id identifier rubyid_order'>order</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_batch'>batch</span><span class='op'>|</span>
    <span class='kw'>yield</span> <span class='id identifier rubyid_batch'>batch</span>.<span class='id identifier rubyid_to_a'>to_a</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="in_batches-instance_method">
  <h3 class='signature '>
    #<strong>in_batches</strong>(of: 1000, start: nil, finish: nil, load: false, error_on_ignore: nil, cursor: primary_key, order: DEFAULT_ORDER, use_ranges: nil, &amp;block)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Yields <a href="Relation.html" title="ActiveRecord::Relation (class)"><code>Relation</code></a> objects to work with a batch of records.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>age &gt; 21</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_in_batches'>in_batches</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_relation'>relation</span><span class='op'>|</span>
  <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_delete_all'>delete_all</span>
  <span class='id identifier rubyid_sleep'>sleep</span>(<span class='int'>10</span>) <span class='comment'># Throttle the delete queries
</span><span class='kw'>end</span></code></pre>

<p>If you do not provide a block to <code>#in_batches</code>, it will return a <a href="Batches/BatchEnumerator.html" title="ActiveRecord::Batches::BatchEnumerator (class)"><code>Batches::BatchEnumerator</code></a> which is enumerable.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_in_batches'>in_batches</span>.<span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_relation'>relation</span><span class='comma'>,</span> <span class='id identifier rubyid_batch_index'>batch_index</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Processing relation #</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_batch_index'>batch_index</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_delete_all'>delete_all</span>
<span class='kw'>end</span></code></pre>

<p>Examples of calling methods on the returned <a href="Batches/BatchEnumerator.html" title="ActiveRecord::Batches::BatchEnumerator (class)"><code>Batches::BatchEnumerator</code></a> object:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_in_batches'>in_batches</span>.<span class='id identifier rubyid_delete_all'>delete_all</span>
<span class='const'>Person</span>.<span class='id identifier rubyid_in_batches'>in_batches</span>.<span class='id identifier rubyid_update_all'>update_all</span>(<span class='label'>awesome:</span> <span class='kw'>true</span>)
<span class='const'>Person</span>.<span class='id identifier rubyid_in_batches'>in_batches</span>.<span class='id identifier rubyid_each_record'>each_record</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_party_all_night!'>party_all_night!</span>)</code></pre>

<h4 id="label-Options">Options</h4>
<ul><li>
<p><code>:of</code> - Specifies the size of the batch. Defaults to 1000.</p>
</li><li>
<p><code>:load</code> - Specifies if the relation should be loaded. Defaults to false.</p>
</li><li>
<p><code>:start</code> - Specifies the cursor column value to start from, inclusive of the value.</p>
</li><li>
<p><code>:finish</code> - Specifies the cursor column value to end at, inclusive of the value.</p>
</li><li>
<p><code>:error_on_ignore</code> - Overrides the application config to specify if an error should be raised when an order is present in the relation.</p>
</li><li>
<p><code>:cursor</code> - Specifies the column to use for batching (can be a column name or an array of column names). Defaults to primary key.</p>
</li><li>
<p><code>:order</code> - Specifies the cursor column order (can be <code>:asc</code> or <code>:desc</code> or an array consisting of :asc or :desc). Defaults to <code>:asc</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span> <span class='op'>&lt;</span> <span class='const'><a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_primary_key'>primary_key</span> <span class='op'>=</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_id_1'>id_1</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id_2'>id_2</span>]
<span class='kw'>end</span>

<span class='const'>Order</span>.<span class='id identifier rubyid_in_batches'>in_batches</span>(<span class='label'>order:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_asc'>asc</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span>])</code></pre>

<p>In the above code, <code>id_1</code> is sorted in ascending order and <code>id_2</code> in descending order.</p>
</li><li>
<p><code>:use_ranges</code> - Specifies whether to use range iteration (id &gt;= x AND id &lt;= y). It can make iterating over the whole or almost whole tables several times faster. Only whole table iterations use this style of iteration by default. You can disable this behavior by passing <code>false</code>. If you iterate over the table and the only condition is, e.g., <code>archived_at: nil</code> (and only a tiny fraction of the records are archived), it makes sense to opt in to this approach.</p>
</li></ul>

<p>Limits are honored, and if present there is no requirement for the batch size, it can be less than, equal, or greater than the limit.</p>

<p>The options <code>start</code> and <code>finish</code> are especially useful if you want multiple workers dealing with the same processing queue. You can make worker 1 handle all the records between id 1 and 9999 and worker 2 handle from 10000 and beyond by setting the <code>:start</code> and <code>:finish</code> option on each worker.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Let&#39;s process from record 10_000 on.
</span><span class='const'>Person</span>.<span class='id identifier rubyid_in_batches'>in_batches</span>(<span class='label'>start:</span> <span class='int'>10_000</span>).<span class='id identifier rubyid_update_all'>update_all</span>(<span class='label'>awesome:</span> <span class='kw'>true</span>)</code></pre>

<p>An example of calling where query method on the relation:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_in_batches'>in_batches</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_relation'>relation</span><span class='op'>|</span>
  <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_update_all'>update_all</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>age = age + 1</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>age &gt; 21</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_update_all'>update_all</span>(<span class='label'>should_party:</span> <span class='kw'>true</span>)
  <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>age &lt;= 21</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_delete_all'>delete_all</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: If you are going to iterate through each record, you should call <code>#each_record</code> on the yielded <a href="Batches/BatchEnumerator.html" title="ActiveRecord::Batches::BatchEnumerator (class)"><code>Batches::BatchEnumerator</code></a>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_in_batches'>in_batches</span>.<span class='id identifier rubyid_each_record'>each_record</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_party_all_night!'>party_all_night!</span>)</code></pre>

<p>NOTE: Order can be ascending (:asc) or descending (:desc). It is automatically set to ascending on the primary key (“id ASC”). This also means that this method only works when the cursor column is orderable (e.g. an integer or string).</p>

<p>NOTE: When using custom columns for batching, they should include at least one unique column (e.g. primary key) as a tiebreaker. Also, to reduce the likelihood of race conditions, all columns should be static (unchangeable after it was set).</p>

<p>NOTE: By its nature, batch processing is subject to race conditions if other processes are modifying the database.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L259-L302'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='259' data-end='302'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 259</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_in_batches'>in_batches</span>(<span class='label'>of:</span> <span class='int'>1000</span><span class='comma'>,</span> <span class='label'>start:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>finish:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>load:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>error_on_ignore:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>cursor:</span> <span class='id identifier rubyid_primary_key'>primary_key</span><span class='comma'>,</span> <span class='label'>order:</span> <span class='const'><a href="#DEFAULT_ORDER-constant" title="ActiveRecord::Batches::DEFAULT_ORDER (constant)">DEFAULT_ORDER</a></span><span class='comma'>,</span> <span class='label'>use_ranges:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_cursor'>cursor</span> <span class='op'>=</span> <span class='const'><a href="../Array.html" title="Array (class)">Array</a></span>(<span class='id identifier rubyid_cursor'>cursor</span>).<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_to_s'>to_s</span>)
  <span class='id identifier rubyid_ensure_valid_options_for_batching!'><a href="#ensure_valid_options_for_batching!-instance_method" title="ActiveRecord::Batches#ensure_valid_options_for_batching! (method)">ensure_valid_options_for_batching!</a></span>(<span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='id identifier rubyid_order'>order</span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_arel'>arel</span>.<span class='id identifier rubyid_orders'>orders</span>.<span class='id identifier rubyid_present?'>present?</span>
    <span class='id identifier rubyid_act_on_ignored_order'><a href="#act_on_ignored_order-instance_method" title="ActiveRecord::Batches#act_on_ignored_order (method)">act_on_ignored_order</a></span>(<span class='id identifier rubyid_error_on_ignore'>error_on_ignore</span>)
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_block'>block</span>
    <span class='kw'>return</span> <span class='const'><a href="Batches/BatchEnumerator.html" title="ActiveRecord::Batches::BatchEnumerator (class)">BatchEnumerator</a></span>.<span class='id identifier rubyid_new'><a href="Batches/BatchEnumerator.html#new-class_method" title="ActiveRecord::Batches::BatchEnumerator.new (method)">new</a></span>(<span class='label'>of:</span> <span class='id identifier rubyid_of'>of</span><span class='comma'>,</span> <span class='label'>start:</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='label'>finish:</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span> <span class='label'>relation:</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='label'>cursor:</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span> <span class='label'>order:</span> <span class='id identifier rubyid_order'>order</span><span class='comma'>,</span> <span class='label'>use_ranges:</span> <span class='id identifier rubyid_use_ranges'>use_ranges</span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_batch_limit'>batch_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_of'>of</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_limit_value'>limit_value</span>
    <span class='id identifier rubyid_remaining'>remaining</span>   <span class='op'>=</span> <span class='id identifier rubyid_limit_value'>limit_value</span>
    <span class='id identifier rubyid_batch_limit'>batch_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_remaining'>remaining</span> <span class='kw'>if</span> <span class='id identifier rubyid_remaining'>remaining</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_batch_limit'>batch_limit</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='kw'>self</span>.<span class='id identifier rubyid_loaded?'>loaded?</span>
    <span class='id identifier rubyid_batch_on_loaded_relation'><a href="#batch_on_loaded_relation-instance_method" title="ActiveRecord::Batches#batch_on_loaded_relation (method)">batch_on_loaded_relation</a></span>(
      <span class='label'>relation:</span> <span class='kw'>self</span><span class='comma'>,</span>
      <span class='label'>start:</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span>
      <span class='label'>finish:</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span>
      <span class='label'>cursor:</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span>
      <span class='label'>order:</span> <span class='id identifier rubyid_order'>order</span><span class='comma'>,</span>
      <span class='label'>batch_limit:</span> <span class='id identifier rubyid_batch_limit'>batch_limit</span><span class='comma'>,</span>
      <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
    )
  <span class='kw'>else</span>
    <span class='id identifier rubyid_batch_on_unloaded_relation'><a href="#batch_on_unloaded_relation-instance_method" title="ActiveRecord::Batches#batch_on_unloaded_relation (method)">batch_on_unloaded_relation</a></span>(
      <span class='label'>relation:</span> <span class='kw'>self</span><span class='comma'>,</span>
      <span class='label'>start:</span> <span class='id identifier rubyid_start'>start</span><span class='comma'>,</span>
      <span class='label'>finish:</span> <span class='id identifier rubyid_finish'>finish</span><span class='comma'>,</span>
      <span class='label'>load:</span> <span class='id identifier rubyid_load'>load</span><span class='comma'>,</span>
      <span class='label'>cursor:</span> <span class='id identifier rubyid_cursor'>cursor</span><span class='comma'>,</span>
      <span class='label'>order:</span> <span class='id identifier rubyid_order'>order</span><span class='comma'>,</span>
      <span class='label'>use_ranges:</span> <span class='id identifier rubyid_use_ranges'>use_ranges</span><span class='comma'>,</span>
      <span class='label'>remaining:</span> <span class='id identifier rubyid_remaining'>remaining</span><span class='comma'>,</span>
      <span class='label'>batch_limit:</span> <span class='id identifier rubyid_batch_limit'>batch_limit</span><span class='comma'>,</span>
      <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
    )
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="record_cursor_values-instance_method">
  <h3 class='signature priv'>
    #<strong>record_cursor_values</strong>(record, cursor)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/main/activerecord/lib/active_record/relation/batches.rb#L408-L410'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='408' data-end='410'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 408</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_record_cursor_values'>record_cursor_values</span>(<span class='id identifier rubyid_record'>record</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor'>cursor</span>)
  <span class='id identifier rubyid_record'>record</span>.<span class='id identifier rubyid_attributes'>attributes</span>.<span class='id identifier rubyid_slice'>slice</span>(<span class='op'>*</span><span class='id identifier rubyid_cursor'>cursor</span>).<span class='id identifier rubyid_values'>values</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>