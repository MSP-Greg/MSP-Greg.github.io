<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Associations &mdash; Mongoid master</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "associations",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Mongoid master</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Associations&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>Associations</h1>

<div class="contents singlecol" markdown="1" local="" backlinks="none" depth="2"></div>

<h2>Referenced Associations</h2>

<p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> supports the <code>has_one</code>, <code>has_many</code>, <code>belongs_to</code> and
<code>has_and_belongs_to_many</code> associations familiar to ActiveRecord users.</p>

<h3>Has One</h3>

<p>Use the <code>has_one</code> macro to declare that the parent has a child stored in
a separate collection. The child is optional by default:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_studio'>studio</span>
<span class='kw'>end</span></code></pre>

<p>When using <code>has_one</code>, the child model must use <code>belongs_to</code> to declare the
association with the parent:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Studio</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
<span class='kw'>end</span></code></pre>

<p>Given the above definitions, every child document contains a reference to
its respective parent document:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>studio:</span> <span class='const'>Studio</span>.<span class='id identifier rubyid_new'>new</span>)
<span class='comment'># =&gt; #&lt;Band _id: 600114fa48966848ad5bd392, &gt;
</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_studio'>studio</span>
<span class='comment'># =&gt; #&lt;Studio _id: 600114fa48966848ad5bd391, band_id: BSON::ObjectId(&#39;600114fa48966848ad5bd392&#39;)&gt;</span></code></pre>

<p>Use validations to require that the child is present:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_studio'>studio</span>

  <span class='id identifier rubyid_validates_presence_of'>validates_presence_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_studio'>studio</span>
<span class='kw'>end</span></code></pre>

<h3>Has Many</h3>

<p>Use the <code>has_many</code> association to declare that the parent has zero or more
children stored in a separate collection:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_members'>members</span>
<span class='kw'>end</span></code></pre>

<p>Like with <code>has_one</code>, the child model must use <code>belongs_to</code> to declare the
association with the parent:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Member</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
<span class='kw'>end</span></code></pre>

<p>Also as with <code>has_one</code>, the child documents contain references to their
respective parents:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>members:</span> [<span class='const'>Member</span>.<span class='id identifier rubyid_new'>new</span>])
<span class='comment'># =&gt; #&lt;Band _id: 6001166d4896684910b8d1c5, &gt;
</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>
<span class='comment'># =&gt; [#&lt;Member _id: 6001166d4896684910b8d1c6, band_id: BSON::ObjectId(&#39;6001166d4896684910b8d1c5&#39;)&gt;]</span></code></pre>

<p>Use validations to require that at least one child is present:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_members'>members</span>

  <span class='id identifier rubyid_validates_presence_of'>validates_presence_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_members'>members</span>
<span class='kw'>end</span></code></pre>

<h4>Queries</h4>

<h5><code>any?</code> [has-many-any]</h5>

<p>Use the <code>any?</code> method on the association to efficiently determine whether
the association contains any documents, without retrieving the entire set
of documents from the database:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_any?'>any?</span></code></pre>

<p><code>any?</code> also implements the <a href="https://ruby-doc.org/core/Enumerable.html#method-i-any-3F">Enumerable#any? API</a>, allowing
filtering with a block:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_any?'>any?</span> { <span class='op'>|</span><span class='id identifier rubyid_member'>member</span><span class='op'>|</span> <span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_instrument'>instrument</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>piano</span><span class='tstring_end'>&#39;</span></span> }</code></pre>

<p>... or by a class name which can be useful for polymorphic associations:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Drummer</span> <span class='op'>&lt;</span> <span class='const'>Member</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_any?'>any?</span>(<span class='const'>Drummer</span>)</code></pre>

<p>If the association is already loaded, <code>any?</code> inspects the loaded
documents and does not query the database:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>
<span class='comment'># Queries the database
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_any?'>any?</span>

<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_to_a'>to_a</span>

<span class='comment'># Does not query the database
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_any?'>any?</span></code></pre>

<p>Note that simply calling <code>any?</code> would <em>not</em> load the association
(since <code>any?</code> only retrieves the _id field of the first matching document).</p>

<h5><code>exists?</code></h5>

<p>The <code>exists?</code> method on the association determines whether there are
any <em>persisted</em> documents in the association. Unlike the <code>any?</code> method:</p>

<ul>
<li>  <code>exists?</code> always queries the database, even if the association is already
loaded.</li>
<li>  <code>exists?</code> does not consider non-persisted documents.</li>
<li>  <code>exists?</code> does not allow filtering in the application like <code>any?</code> does,
and does not take any arguments.</li>
</ul>

<p>The following example illustrates the difference between <code>exists?</code> and
<code>any?</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='comment'># Member is not persisted.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_build'>build</span>

<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_any?'>any?</span>
<span class='comment'># =&gt; true
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_exists?'>exists?</span>
<span class='comment'># =&gt; false
</span>
<span class='comment'># Persist the member.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_save!'>save!</span>)

<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_any?'>any?</span>
<span class='comment'># =&gt; true
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_members'>members</span>.<span class='id identifier rubyid_exists?'>exists?</span>
<span class='comment'># =&gt; true</span></code></pre>

<h3>Belongs To</h3>

<p>Use the <code>belongs_to</code> macro to associate a child with a parent stored in a
separate collection. The <code>_id</code> of the parent (if a parent is associated)
is stored in the child.</p>

<p>By default, if a <code>belongs_to</code> association is defined on a model, it must be
provided a value for a model instance to be saved. Use the <code>optional: true</code>`
option to make the instances persistable without specifying the parent:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_studio'>studio</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Studio</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span><span class='comma'>,</span> <span class='label'>optional:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_studio'>studio</span> <span class='op'>=</span> <span class='const'>Studio</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='comment'># =&gt; #&lt;Studio _id: 600118184896684987aa884f, band_id: nil&gt;</span></code></pre>

<p>To change the default behavior of <code>belongs_to</code> associations to not require
their respective parents globally, set the <code>belongs_to_required_by_default</code>
<code>configuration option &lt;configuration-options&gt;</code> to <code>false</code>.</p>

<p>Although <code>has_one</code> and <code>has_many</code> associations require the
corresponding <code>belongs_to</code> association to be defined on the child,
<code>belongs_to</code> may also be used without a corresponding <code>has_one</code> or
<code>has_many</code> macro. In this case the child is not accessible from the parent
but the parent is accessible from the child:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Studio</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
<span class='kw'>end</span></code></pre>

<p>For clarity it is possible to add the <code>inverse_of: nil</code> option in cases when
the parent does not define the association:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Studio</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='kw'>nil</span>
<span class='kw'>end</span></code></pre>

<h3>Has And Belongs To Many</h3>

<p>Use the <code>has_and_belongs_to_many</code> macro to declare a many-to-many
association:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tags'>tags</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Tag</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_bands'>bands</span>
<span class='kw'>end</span></code></pre>

<p>Both model instances store a list of ids of the associated models, if any:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>tags:</span> [<span class='const'>Tag</span>.<span class='id identifier rubyid_create!'>create!</span>])
<span class='comment'># =&gt; #&lt;Band _id: 60011d554896684b8b910a2a, tag_ids: [BSON::ObjectId(&#39;60011d554896684b8b910a29&#39;)]&gt;
</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_tags'>tags</span>
<span class='comment'># =&gt; [#&lt;Tag _id: 60011d554896684b8b910a29, band_ids: [BSON::ObjectId(&#39;60011d554896684b8b910a2a&#39;)]&gt;]</span></code></pre>

<p>You can create a one-sided <code>has_and_belongs_to_many</code> association to store
the ids only in one document using the <code>inverse_of: nil</code> option:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tags'>tags</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='kw'>nil</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Tag</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>tags:</span> [<span class='const'>Tag</span>.<span class='id identifier rubyid_create!'>create!</span>])
<span class='comment'># =&gt; #&lt;Band _id: 60011dbc4896684bbbaa9255, tag_ids: [BSON::ObjectId(&#39;60011dbc4896684bbbaa9254&#39;)]&gt;
</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_tags'>tags</span>
<span class='comment'># =&gt; [#&lt;Tag _id: 60011dbc4896684bbbaa9254, &gt;]</span></code></pre>

<p>A one-sided <code>has_and_belongs_to_many</code> association is, naturally, only
usable from the model where it is defined.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Given two models, A and B where A <code>has_and_belongs_to_many</code> B,
when adding a document of type B to the HABTM association on a document of
type A, Mongoid will not update the <code>updated_at</code> field for the document of
type A, but will update the <code>updated_at</code> field for the document of type B.</p>

<p></div></p>

<h3>Querying Referenced Associations</h3>

<p>In most cases, efficient queries across referenced associations (and in general
involving data or conditions or multiple collections) are performed using
the aggregation pipeline. Mongoid helpers for constructing aggregation pipeline
queries are described in the <code>aggregation pipeline &lt;aggregation-pipeline&gt;</code>
section.</p>

<p>For simple queries, the use of aggregation pipeline may be avoided and
associations may be queried directly. When querying associations directly,
all conditions must be on that association&#39;s collection only (which typically
means association in question and any associations embedded in it).</p>

<p>For example, given the following models:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tours'>tours</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_awards'>awards</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Tour</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Award</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span></code></pre>

<p>One could retrieve all bands that have toured since 2000 as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band_ids'>band_ids</span> <span class='op'>=</span> <span class='const'>Tour</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>year:</span> {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$gte</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='int'>2000</span>}).<span class='id identifier rubyid_pluck'>pluck</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_band_id'>band_id</span>)
<span class='id identifier rubyid_bands'>bands</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_band_ids'>band_ids</span>)</code></pre>

<p>The conditions on <code>Tour</code> can be arbitrarily complex, but they must all
be on the same <code>Tour</code> document (or documents embedded in <code>Tour</code>).</p>

<p>To find awards for bands that have toured since 2000:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band_ids'>band_ids</span> <span class='op'>=</span> <span class='const'>Tour</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>year:</span> {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$gte</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='int'>2000</span>}).<span class='id identifier rubyid_pluck'>pluck</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_band_id'>band_id</span>)
<span class='id identifier rubyid_awards'>awards</span> <span class='op'>=</span> <span class='const'>Award</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>band_id:</span> {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$in</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_band_ids'>band_ids</span>})</code></pre>

<h2>Embedded Associations</h2>

<p>Thanks to MongoDB&#39;s document model, Mongoid also offers embedded associations
which allow documents of different types to be stored hierarchically
in the same collection. Embedded associations are defined using
<code>embeds_one</code>, <code>embeds_many</code> and <code>embedded_in</code> macros, plus
<code>recursively_embeds_one</code> and <code>recursively_embeds_many</code> for recursive
embedding.</p>

<h3>Embeds One</h3>

<p>One to one associations where the children are embedded in the parent
document are defined using Mongoid&#39;s <code>embeds_one</code> and <code>embedded_in</code> macros.</p>

<h4>Defining</h4>

<p>The parent document of the association should use the <code>embeds_one</code> macro to
indicate is has one embedded child, where the document that is embedded uses
<code>embedded_in</code>. Definitions are required on both sides to the association
in order for it to work properly.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_one'>embeds_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Label</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
<span class='kw'>end</span></code></pre>

<h4>Storage</h4>

<p>Documents that are embedded using the <code>embeds_one</code> macro are stored as a
hash inside the parent in the parent&#39;s database collection.</p>

<pre class="code ruby"><code class="ruby">{
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='const'>ObjectId</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>4d3ed089fb60ab534684b7e9</span><span class='tstring_end'>&quot;</span></span>)<span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>label</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> {
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='const'>ObjectId</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>4d3ed089fb60ab534684b7e0</span><span class='tstring_end'>&quot;</span></span>)<span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Mute</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  }
}</code></pre>

<p>You can optionally tell Mongoid to store the embedded document in a different
attribute other than the name, by providing the <code>:store_as</code> option.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_one'>embeds_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span><span class='comma'>,</span> <span class='label'>store_as:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lab</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<h3>Embeds Many</h3>

<p>One to many relationships where the children are embedded in the parent
document are defined using Mongoid&#39;s <code>embeds_many</code> and <code>embedded_in</code> macros.</p>

<h4>Defining</h4>

<p>The parent document of the association should use the <code>embeds_many</code> macro
to indicate it has many embedded children, where the document that is
embedded uses <code>embedded_in</code>. Definitions are required on both sides of
the association in order for it to work properly.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Album</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
<span class='kw'>end</span></code></pre>

<h4>Storage</h4>

<p>Documents that are embedded using the <code>embeds_many</code> macro are stored as
an array of hashes inside the parent in the parent&#39;s database collection.</p>

<pre class="code ruby"><code class="ruby">{
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='const'>ObjectId</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>4d3ed089fb60ab534684b7e9</span><span class='tstring_end'>&quot;</span></span>)<span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>albums</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> [
    {
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='const'>ObjectId</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>4d3ed089fb60ab534684b7e0</span><span class='tstring_end'>&quot;</span></span>)<span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Violator</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    }
  ]
}</code></pre>

<p>You can optionally tell Mongoid to store the embedded document in a different
attribute other than the name, by providing the <code>:store_as</code> option.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span><span class='comma'>,</span> <span class='label'>store_as:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>albs</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<h3>Recursive Embedding</h3>

<p>A document can recursively embed itself using <code>recursively_embeds_one</code> or
<code>recursively_embeds_many</code>, which provides accessors for the parent and
children via <code>href="">parent</a></code> and <code>href="">child</a></code> methods.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Tag</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_recursively_embeds_many'>recursively_embeds_many</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_root'>root</span> <span class='op'>=</span> <span class='const'>Tag</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>programming</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_child_one'>child_one</span> <span class='op'>=</span> <span class='id identifier rubyid_root'>root</span>.<span class='id identifier rubyid_child_tags'>child_tags</span>.<span class='id identifier rubyid_build'>build</span>
<span class='id identifier rubyid_child_two'>child_two</span> <span class='op'>=</span> <span class='id identifier rubyid_root'>root</span>.<span class='id identifier rubyid_child_tags'>child_tags</span>.<span class='id identifier rubyid_build'>build</span>

<span class='id identifier rubyid_root'>root</span>.<span class='id identifier rubyid_child_tags'>child_tags</span> <span class='comment'># [ child_one, child_two ]
</span><span class='id identifier rubyid_child_one'>child_one</span>.<span class='id identifier rubyid_parent_tag'>parent_tag</span> <span class='comment'># [ root ]
</span><span class='id identifier rubyid_child_two'>child_two</span>.<span class='id identifier rubyid_parent_tag'>parent_tag</span> <span class='comment'># [ root ]
</span>
<span class='kw'>class</span> <span class='const'>Node</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_recursively_embeds_one'>recursively_embeds_one</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_root'>root</span> <span class='op'>=</span> <span class='const'>Node</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_child'>child</span> <span class='op'>=</span> <span class='const'>Node</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_root'>root</span>.<span class='id identifier rubyid_child_node'>child_node</span> <span class='op'>=</span> <span class='id identifier rubyid_child'>child</span>

<span class='id identifier rubyid_root'>root</span>.<span class='id identifier rubyid_child_node'>child_node</span> <span class='comment'># child
</span><span class='id identifier rubyid_child'>child</span>.<span class='id identifier rubyid_parent_node'>parent_node</span> <span class='comment'># root</span></code></pre>

<h3>Referencing Vs Embedding</h3>

<p>While a complete discussion of referencing vs embedding is beyond the scope
of this tutorial, here are some high level considerations for choosing
one over the other.</p>

<p>When an association is embedded, both parent and child documents are stored
in the same collection. This permits efficient persistence and retrieval
when both are used/needed. For example, if the navigation bar on a web site
shows attributes of a user that are stored in documents themselves, it is
often a good idea to use embedded associations.</p>

<p>Using embedded associations allows using MongoDB tools like the
<a href="https://mongodb.com/docs/manual/core/aggregation-pipeline/">aggregation pipeline</a> to query
these documents in a powerful way.</p>

<p>Because embedded documents are stored as part of their parent top-level
documents, it is not possible to persist an embedded document by itself,
nor is it possible to retrieve embedded documents directly. However,
embedded documents can still be efficiently queried and retrieved with the
help of MongoDB projection operation:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_started_on'>started_on</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span>
  <span class='id identifier rubyid_embeds_one'>embeds_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Label</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
<span class='kw'>end</span>

<span class='comment'># Retrieve labels for bands started in the last year.
</span><span class='comment'>#
</span><span class='comment'># Sends a find query like this:
</span><span class='comment'># {&quot;find&quot;=&gt;&quot;bands&quot;,
</span><span class='comment'>#  &quot;filter&quot;=&gt;{&quot;started_on&quot;=&gt;{&quot;$gt&quot;=&gt;2018-07-01 00:00:00 UTC}},
</span><span class='comment'>#  &quot;projection&quot;=&gt;{&quot;_id&quot;=&gt;1, &quot;label&quot;=&gt;1}}
</span><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>started_on:</span> {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$gt</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='int'>1</span>.<span class='id identifier rubyid_year'>year</span>}).<span class='id identifier rubyid_only'>only</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span>).<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span>).<span class='id identifier rubyid_compact'>compact</span>.<span class='id identifier rubyid_uniq'>uniq</span></code></pre>

<h4>Setting Stale Values on Referenced Associations</h4>

<p>Setting a stale value to a referenced association can sometimes result in
a <code>nil</code> value being persisted to the database. Take the following case:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Post</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comment'>comment</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Comment</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comment'>comment</span><span class='comma'>,</span> <span class='label'>optional:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_comment'>comment</span> <span class='op'>=</span> <span class='id identifier rubyid_comment1'>comment1</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_reload'>reload</span></code></pre>

<p>At this point, <code>post.comment</code> is set to <code>comment1</code>, however since a reload
happened, <code>post.comment</code> does not refer to the same object as <code>comment1</code>.
Meaning, updating one object does not implicitly update the other. This matters
for the next operation:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_comment'>comment</span> <span class='op'>=</span> <span class='id identifier rubyid_comment2'>comment2</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_reload'>reload</span></code></pre>

<p>Now, <code>post.comment</code> is set to <code>comment2</code>, and the <code>post_id</code> of the old
comment is set to <code>nil</code>. However, the value that was assigned to
<code>post.comment</code> did not refer to the same object as <code>comment1</code>, therefore,
while the old value of <code>post.comment</code> was updated to have a <code>nil</code>
<code>post_id</code>, <code>comment1</code> still has the <code>post_id</code> set.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_comment'>comment</span> <span class='op'>=</span> <span class='id identifier rubyid_comment1'>comment1</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_reload'>reload</span></code></pre>

<p>Finally, this last assignment attempts to set the <code>post_id</code> on <code>comment1</code>,
which should be <code>nil</code> at this point, but is set to the old <code>post_id</code>.
During this operation, the <code>post_id</code> is cleared from <code>comment2</code>, and the
new <code>post_id</code> is set on <code>comment1</code>. However, since the <code>post_id</code> was
already set on <code>comment1</code>, nothing is persisted, and we end up with both
comments having a <code>nil</code> <code>post_id</code>. At this point, running <code>post.comment</code>
returns <code>nil</code>.</p>

<h3>Querying Embedded Associations</h3>

<p>When querying top-level documents, conditions can be specified on documents
in embedded associations using the dot notation. For example, given the
following models:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tours'>tours</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_awards'>awards</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Tour</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Award</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span></code></pre>

<p>To retrieve bands based on tour attributes, use the dot notation as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Get all bands that have toured since 2000
</span><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>tours.year</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$gte</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='int'>2000</span>})</code></pre>

<p>To retrieve only documents of embedded associations, without retrieving
top-level documents, use the <code>pluck</code> projection method:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Get awards for bands that have toured since 2000
</span><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>tours.year</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$gte</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='int'>2000</span>}).<span class='id identifier rubyid_pluck'>pluck</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_awards'>awards</span>)</code></pre>

<h4>Querying Loaded Associations [embedded-matching]</h4>

<p>Mongoid query methods can be used on embedded associations of documents which
are already loaded in the application. This mechanism is called
&quot;embedded matching&quot; and it is implemented entirely in Mongoid--the queries
are NOT sent to the server.</p>

<p>The following operators are supported:</p>

<ul>
<li>  <code>Comparison operators &lt;/reference/operator/query-comparison/&gt;</code></li>
<li>  <code>Logical operators &lt;/reference/operator/query-logical/&gt;</code></li>
<li>  <code>Array query operators &lt;/reference/operator/query-array/&gt;</code></li>
<li>  <code>$exists &lt;/reference/operator/query/exists/&gt;</code></li>
<li>  <code>$mod &lt;/reference/operator/query/mod/&gt;</code></li>
<li>  <code>$type &lt;/reference/operator/query/type/&gt;</code></li>
<li>  <code>$regex &lt;/reference/operator/query/regex/&gt;</code> (<code>$options</code> field
is only supported when the <code>$regex</code> argument is a string)</li>
<li>  <code>Bitwise operators &lt;/reference/operator/query-bitwise/&gt;</code></li>
<li>  <code>$comment &lt;/reference/operator/query/comment/&gt;</code></li>
</ul>

<p>For example, using the model definitions just given, we could query
tours on a loaded band:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Astral Projection</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_tours'>tours</span> <span class='op'>=</span> <span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_tours'>tours</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>year:</span> {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$gte</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='int'>2000</span>})</code></pre>

<h4>Embedded Matching vs Server Behavior</h4>

<p>Mongoid&#39;s embedded matching aims to support the same functionality and
semantics as native queries on the latest MongoDB server version.
Note the following known limitations:</p>

<ul>
<li>  Embedded matching is not implemented for <code>text search &lt;text-search&gt;</code>,
<code>geospatial query operators &lt;/reference/operator/query-geospatial/&gt;</code>,
operators that execute JavaScript code (<code>$where &lt;/reference/operator/query/where/&gt;</code>)
and operators that are implemented via other server functionality such as
<code>$expr &lt;https://mongodb.com/docs/manual/reference/operator/query/expr/&gt;</code>
and <code>$jsonSchema &lt;https://mongodb.com/docs/manual/reference/operator/query/jsonSchema/&gt;</code>.</li>
<li>  Mongoid DSL expands <code>Range</code> arguments to hashes with <code>$gte</code> and <code>$lte</code>
conditions. <a href="https://jira.mongodb.org/browse/MONGOID-4908">In some cases</a>
this creates bogus queries. Embedded matchers raise the <code>InvalidQuery</code>
exception in these cases. The operators that are known to be affected are
<code>$elemMatch</code>, <code>$eq</code>, <code>$gt</code>, <code>$gte</code>, <code>$lt</code>, <code>$lte</code> and <code>$ne</code>.</li>
<li>  When performing embedded matching with <code>$regex</code>, <a href="https://jira.mongodb.org/browse/MONGOID-4936">it is not currently
possible</a> to specify a
regular expression object as the pattern and also provide options.</li>
<li>  MongoDB Server 4.0 and earlier servers do not validate <code>$type</code> arguments strictly
(for example, allowing invalid arguments like 0). This is validated more strictly on
the client side.</li>
</ul>

<h3>Omitting <code>_id</code> Fields [omit-id]</h3>

<p>By default, Mongoid adds an <code>_id</code> field to each embedded document. This
permits easy referencing of and operations on the embedded documents.</p>

<p>These <code>_id</code> fields may be omitted to save storage space. To do so,
<code>override the _id field definition in the child documents &lt;custom-id&gt;</code>
and remove the default value:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_line_items'>line_items</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>LineItem</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_order'>order</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Object</span>
<span class='kw'>end</span></code></pre>

<p>In the current version of Mongoid the field definition is required, but
without a default value specified no value will be stored in the database.
A future version of Mongoid may allow removing previously defined fields.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Removing the <code>_id</code> field means that embedded documents must be identified
by their content attribute values during queries, updates and deletes.</p>

<p></div></p>

<h3>Deleting</h3>

<p>Mongoid provides three methods for deleting children from <code>embeds_many</code>
associations: <code>clear</code>, <code>destroy_all</code> and <code>delete_all</code>.</p>

<h4><code>clear</code></h4>

<p>The <code>clear</code> method uses the <code>$unset operator
&lt;/reference/operator/update/unset&gt;</code> to remove the entire association from the
host document. It does not run destroy callbacks on the documents being removed,
acting like <code>delete_all</code> in this regard:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_find'>find</span>(<span class='op'>...</span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_tours'>tours</span>.<span class='id identifier rubyid_clear'>clear</span></code></pre>

<p>If <code>clear</code> is called on an association in an unsaved host document, it will
still try to remove the association from the database based on the host
document&#39;s <code>_id</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_find'>find</span>(<span class='op'>...</span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_tours'>tours</span> <span class='op'>&lt;&lt;</span> <span class='const'>Tour</span>.<span class='id identifier rubyid_new'>new</span>(<span class='op'>...</span>)

<span class='id identifier rubyid_unsaved_band'>unsaved_band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>id:</span> <span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>tours:</span> [<span class='const'>Tour</span>.<span class='id identifier rubyid_new'>new</span>])
<span class='comment'># Removes all tours from the persisted band due to _id match.
</span><span class='id identifier rubyid_unsaved_band'>unsaved_band</span>.<span class='id identifier rubyid_tours'>tours</span>.<span class='id identifier rubyid_clear'>clear</span>

<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_tours'>tours</span>
<span class='comment'># =&gt; []</span></code></pre>

<h4><code>delete_all</code></h4>

<p>The <code>delete_all</code> method removes the documents that are in the association
using the <code>$pullAll operator &lt;/reference/operator/update/pullAll&gt;</code>.
Unlike <code>clear</code>, <code>delete_all</code>:</p>

<ul>
<li>  Loads the association, if it wasn&#39;t yet loaded;</li>
<li>  Only removes the documents that exist in the application.</li>
</ul>

<p><code>delete_all</code> does not run destroy callbacks on the documents being removed.</p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_find'>find</span>(<span class='op'>...</span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_tours'>tours</span>.<span class='id identifier rubyid_delete_all'>delete_all</span></code></pre>

<h4><code>destroy_all</code></h4>

<p>The <code>delete_all</code> method removes the documents that are in the association
using the <code>$pullAll operator &lt;/reference/operator/update/pullAll&gt;</code>
while running the destroy callbacks. Like <code>delete_all</code>, <code>destroy_all</code>
loads the entire association if it wasn&#39;t yet loaded and it only removes
documents that exist in the application:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_find'>find</span>(<span class='op'>...</span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_tours'>tours</span>.<span class='id identifier rubyid_destroy_all'>destroy_all</span></code></pre>

<h3>Hash Assignment</h3>

<p>Embedded associations allow the user to assign a <a href="Hash.html" title="Hash (class)"><code>Hash</code></a> instead of a document
to an association. On assignment, this hash is coerced into a document of the
class of the association that it&#39;s being assigned to. Take the following
example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Album</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span> <span class='op'>=</span> [ { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Narrow Stairs</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Transatlanticism</span><span class='tstring_end'>&quot;</span></span> } ]
<span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span>
<span class='comment'># =&gt; [ #&lt;Album _id: 633c71e93282a4357bb608e5, name: &quot;Narrow Stairs&quot;&gt;, #&lt;Album _id: 633c71e93282a4357bb608e6, name: &quot;Transatlanticism&quot;&gt; ]</span></code></pre>

<p>This works for <code>embeds_one</code>, <code>embeds_many</code>, and <code>embedded_in</code> associations.
Note that you cannot assign hashes to referenced associations.</p>

<h2>Common Behavior</h2>

<h3>Extensions</h3>

<p>All associations can have extensions, which provides a way to add application specific
functionality to the association. They are defined by providing a block to the association definition.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_addresses'>addresses</span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_find_by_country'>find_by_country</span>(<span class='id identifier rubyid_country'>country</span>)
      <span class='id identifier rubyid_where'>where</span>(<span class='label'>country:</span> <span class='id identifier rubyid_country'>country</span>).<span class='id identifier rubyid_first'>first</span>
    <span class='kw'>end</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_chinese'>chinese</span>
      <span class='id identifier rubyid__target'>_target</span>.<span class='id identifier rubyid_select'>select</span> { <span class='op'>|</span><span class='id identifier rubyid_address'>address</span><span class='op'>|</span> <span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_country'>country</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>China</span><span class='tstring_end'>&quot;</span></span> }
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_find_by_country'>find_by_country</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Mongolia</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># returns address
</span><span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_chinese'>chinese</span> <span class='comment'># returns [ address ]</span></code></pre>

<h3>Custom Association Names</h3>

<p>You can name your associations whatever you like, but if the class cannot be inferred by
Mongoid from the name, and neither can the opposite side you&#39;ll want to provide the
macro with some additional options to tell Mongoid how to hook them up.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Car</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_one'>embeds_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_engine'>engine</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Motor</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_machine'>machine</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Motor</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_machine'>machine</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Car</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_engine'>engine</span>
<span class='kw'>end</span></code></pre>

<h3>Custom Primary &amp; Foreign Keys</h3>

<p>The fields used when looking up associations can be explicitly specified.
The default is to use <code>id</code> on the &quot;parent&quot; association and <code>#{association_name}_id</code>
on the &quot;child&quot; association, for example with a has_many/belongs_to:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Company</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_emails'>emails</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Email</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_company'>company</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_company'>company</span> <span class='op'>=</span> <span class='const'>Company</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_id'>id</span>)
<span class='comment'># looks up emails where emails.company_id == company.id
</span><span class='id identifier rubyid_company'>company</span>.<span class='id identifier rubyid_emails'>emails</span></code></pre>

<p>Specify a different <code>primary_key</code> to change the field name on the &quot;parent&quot;
association and <code>foreign_key</code> to change the field name on the &quot;child&quot;
association:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Company</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_c'>c</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_emails'>emails</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>c_ref</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>primary_key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>c</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Email</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='comment'># This definition of c_ref is automatically generated by Mongoid:
</span>  <span class='comment'># field :c_ref, type: Object
</span>  <span class='comment'># But the type can also be specified:
</span>  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_c_ref'>c_ref</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_company'>company</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>c_ref</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>primary_key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>c</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_company'>company</span> <span class='op'>=</span> <span class='const'>Company</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_id'>id</span>)
<span class='comment'># looks up emails where emails.c_ref == company.c
</span><span class='id identifier rubyid_company'>company</span>.<span class='id identifier rubyid_emails'>emails</span></code></pre>

<p>With a has_and_belongs_to_many association, since the data is stored on both
sides of the association, there are 4 fields configurable when the association
is defined:</p>

<ul>
<li>  <code>:primary_key</code> is the field on the remote model that contains the value
by which the remote model is looked up.</li>
<li>  <code>:foreign_key</code> is the field on the local model which stores the
<code>:primary_key</code> values.</li>
<li>  <code>:inverse_primary_key</code> is the field on the local model that the remote
model uses to look up the local model documents.</li>
<li>  <code>:inverse_foreign_key</code> is the field on the remote model storing the
values in <code>:inverse_primary_key</code>.</li>
</ul>

<p>An example might make this more clear:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Company</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_c_id'>c_id</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_e_ids'>e_ids</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Array.html" title="Array (class)">Array</a></span>

  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_employees'>employees</span><span class='comma'>,</span>
    <span class='label'>primary_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_e_id'>e_id</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_e_ids'>e_ids</span><span class='comma'>,</span>
    <span class='label'>inverse_primary_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_c_id'>c_id</span><span class='comma'>,</span> <span class='label'>inverse_foreign_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_c_ids'>c_ids</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Employee</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_e_id'>e_id</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_c_ids'>c_ids</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Array.html" title="Array (class)">Array</a></span>

  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_companies'>companies</span><span class='comma'>,</span>
    <span class='label'>primary_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_c_id'>c_id</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_c_ids'>c_ids</span><span class='comma'>,</span>
    <span class='label'>inverse_primary_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_e_id'>e_id</span><span class='comma'>,</span> <span class='label'>inverse_foreign_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_e_ids'>e_ids</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_company'>company</span> <span class='op'>=</span> <span class='const'>Company</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>c_id:</span> <span class='int'>123</span>)
<span class='comment'># =&gt; #&lt;Company _id: 5c565ece026d7c461d8a9d4e, c_id: 123, e_ids: nil&gt;
</span>
<span class='id identifier rubyid_employee'>employee</span> <span class='op'>=</span> <span class='const'>Employee</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>e_id:</span> <span class='int'>456</span>)
<span class='comment'># =&gt; #&lt;Employee _id: 5c565ee8026d7c461d8a9d4f, e_id: 456, c_ids: nil&gt;
</span>
<span class='id identifier rubyid_company'>company</span>.<span class='id identifier rubyid_employees'>employees</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_employee'>employee</span>

<span class='id identifier rubyid_company'>company</span>
<span class='comment'># =&gt; #&lt;Company _id: 5c565ece026d7c461d8a9d4e, c_id: 123, e_ids: [456]&gt;
</span>
<span class='id identifier rubyid_employee'>employee</span>
<span class='comment'># =&gt; #&lt;Employee _id: 5c5883ce026d7c4b9e244c0c, e_id: 456, c_ids: [123]&gt;</span></code></pre>

<p>Note that just like with the default <code>#{association_name}_id</code> field,
Mongoid automatically adds a field for the custom foreign key <code>c_ref</code> to
the model. However, since Mongoid doesn&#39;t know what type of data should be
allowed in the field, the field is created with a type of Object. It is a
good idea to explicitly define the field with the appropriate type.</p>

<h3>Custom Scopes [association-scope]</h3>

<p>You may set a specific scope on an association using the <code>:scope</code> parameter.
The scope is an additional filter that restricts which objects are considered
to be a part of the association - a scoped association will return only
documents which satisfy the scope condition.. The scope may be either:</p>

<ul>
<li>  a <code>Proc</code> with arity zero, or</li>
<li>  a <a href="Symbol.html" title="Symbol (class)"><code>Symbol</code></a> which references a <code>named scope &lt;named-scopes&gt;</code> on the
associated model.</li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Trainer</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pets'>pets</span><span class='comma'>,</span> <span class='label'>scope:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>species:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>dog</span><span class='tstring_end'>&#39;</span></span>) }
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_toys'>toys</span><span class='comma'>,</span> <span class='label'>scope:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_rubber'>rubber</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Pet</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_trainer'>trainer</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Toy</span>
  <span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_rubber'>rubber</span><span class='comma'>,</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>material:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubber</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_trainer'>trainer</span>
<span class='kw'>end</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>It is possible to add documents that do not satisfy an association&#39;s scope
to that association. In this case, such documents will appear associated
in memory, and will be saved to the database, but will not be present when
the association is queried in the future. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_trainer'>trainer</span> <span class='op'>=</span> <span class='const'>Trainer</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_dog'>dog</span> <span class='op'>=</span> <span class='const'>Pet</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>trainer:</span> <span class='id identifier rubyid_trainer'>trainer</span><span class='comma'>,</span> <span class='label'>species:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>dog</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_cat'>cat</span> <span class='op'>=</span> <span class='const'>Pet</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>trainer:</span> <span class='id identifier rubyid_trainer'>trainer</span><span class='comma'>,</span> <span class='label'>species:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>cat</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_trainer'>trainer</span>.<span class='id identifier rubyid_pets'>pets</span> <span class='comment'>#=&gt; [dog, cat]
</span>
<span class='id identifier rubyid_trainer'>trainer</span>.<span class='id identifier rubyid_reload'>reload</span>.<span class='id identifier rubyid_pets'>pets</span> <span class='comment'>#=&gt; [dog]</span></code></pre>

<p></div></p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Mongoid&#39;s syntax for scoped association differs from that of ActiveRecord.
Mongoid uses the <code>:scope</code> keyword argument for consistency with other
association options, whereas in ActiveRecord the scope is a positional
argument.</p>

<p></div></p>

<h3>Validations</h3>

<p>It is important to note that by default, Mongoid will validate the children of any
association that are loaded into memory via a <code>validates_associated</code>. The associations that
this applies to are:</p>

<ul>
<li>  <code>embeds_many</code></li>
<li>  <code>embeds_one</code></li>
<li>  <code>has_many</code></li>
<li>  <code>has_one</code></li>
<li>  <code>has_and_belongs_to_many</code></li>
</ul>

<p>If you do not want this behavior, you may turn it off when defining the association.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_addresses'>addresses</span><span class='comma'>,</span> <span class='label'>validate:</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>validate:</span> <span class='kw'>false</span>
<span class='kw'>end</span></code></pre>

<h3>Polymorphism</h3>

<p>One to one and one to many associations support polymorphism, which is
having a single association potentially contain objects of different classes.
For example, we could model an organization in which departments and teams
have managers as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Department</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_manager'>manager</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unit'>unit</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Team</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_manager'>manager</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unit'>unit</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Manager</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unit'>unit</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_dept'>dept</span> <span class='op'>=</span> <span class='const'>Department</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_team'>team</span> <span class='op'>=</span> <span class='const'>Team</span>.<span class='id identifier rubyid_create!'>create!</span>

<span class='id identifier rubyid_alice'>alice</span> <span class='op'>=</span> <span class='const'>Manager</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>unit:</span> <span class='id identifier rubyid_dept'>dept</span>)
<span class='id identifier rubyid_alice'>alice</span>.<span class='id identifier rubyid_unit'>unit</span> <span class='op'>==</span> <span class='id identifier rubyid_dept'>dept</span>
<span class='comment'># =&gt; true
</span><span class='id identifier rubyid_dept'>dept</span>.<span class='id identifier rubyid_manager'>manager</span> <span class='op'>==</span> <span class='id identifier rubyid_alice'>alice</span>
<span class='comment'># =&gt; true</span></code></pre>

<p>To provide another example, suppose we want to track price history for
products and bundles. This can be achieved via an embedded one to many
polymorphic association:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Product</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_bundles'>bundles</span>

  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_prices'>prices</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_item'>item</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Bundle</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_products'>products</span>

  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_prices'>prices</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_item'>item</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Price</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_pants'>pants</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Pants</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>prices:</span> [<span class='const'>Price</span>.<span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='const'>Price</span>.<span class='id identifier rubyid_new'>new</span>])
<span class='id identifier rubyid_costume'>costume</span> <span class='op'>=</span> <span class='const'>Bundle</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Costume</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>products:</span> [<span class='id identifier rubyid_pants'>pants</span>]<span class='comma'>,</span>
  <span class='label'>prices:</span> [<span class='const'>Price</span>.<span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='const'>Price</span>.<span class='id identifier rubyid_new'>new</span>])</code></pre>

<p>To define a polymorphic association, specify the <code>polymorphic: true</code> option
on the child association and add the <code>as: :association_name</code> option to the
parent association.</p>

<p>Note that Mongoid currently supports polymorphism only in one direction - from
the child to the parent. For example, polymorphism cannot be used to specify
that a bundle may contain other bundles or products:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Bundle</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='comment'># Does not work:
</span>  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_items'>items</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p><code>has_and_belongs_to_many</code> associations do not support polymorphism.</p>

<h3>Cascading Callbacks</h3>

<p>If you want the embedded document callbacks to fire when calling a persistence
operation on its parent, you will need to provide the cascade callbacks option
to the association.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span><span class='comma'>,</span> <span class='label'>cascade_callbacks:</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_embeds_one'>embeds_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span><span class='comma'>,</span> <span class='label'>cascade_callbacks:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_save'>save</span> <span class='comment'># Fires all save callbacks on the band, albums, and label.</span></code></pre>

<h3>Dependent Behavior</h3>

<p>You can provide dependent options to referenced associations to instruct Mongoid
how to handle situations where one side of the association is deleted, or is attempted
to be deleted. The options are as follows:</p>

<ul>
<li>  <code>:delete_all</code>: Delete the child document(s) without running any of the model callbacks.</li>
<li>  <code>:destroy</code>: Destroy the child document(s) and run all of the model callbacks.</li>
<li>  <code>:nullify</code>: Set the foreign key field of the child document to nil. The child may become orphaned if it is ordinarily only referenced via the parent.</li>
<li>  <code>:restrict_with_exception</code>: <code>raise</code> an error if the child is not empty.</li>
<li>  <code>:restrict_with_error</code>: Cancel operation and return false if the child is not empty.</li>
</ul>

<p>If no <code>:dependent</code> option is provided, deleting the parent document leaves the child document unmodified
(in other words, the child document continues to reference the now deleted parent document via the foreign key field).
The child may become orphaned if it is ordinarily only referenced via the parent.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_delete_all'>delete_all</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_nullify'>nullify</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Album</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Label</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_bands'>bands</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_restrict_with_exception'>restrict_with_exception</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_label'>label</span> <span class='op'>=</span> <span class='const'>Label</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_label'>label</span>.<span class='id identifier rubyid_bands'>bands</span>.<span class='id identifier rubyid_push'>push</span>(<span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>)
<span class='id identifier rubyid_label'>label</span>.<span class='id identifier rubyid_delete'>delete</span> <span class='comment'># Raises an error since bands is not empty.
</span>
<span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_destroy'>destroy</span> <span class='comment'># Will delete all associated albums.</span></code></pre>

<h3>Autosaving</h3>

<p>One core difference between Mongoid and ActiveRecord is that Mongoid does not
automatically save associated documents for referenced (i.e., non-embedded)
associations when the parent is saved, for performance reasons.</p>

<p>If autosaving is not used, it is possible to create dangling references
to non-existent documents via associations:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Album</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_album'>album</span> <span class='op'>=</span> <span class='const'>Album</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>band:</span> <span class='id identifier rubyid_band'>band</span>)

<span class='comment'># The band is not persisted at this point.
</span>
<span class='id identifier rubyid_album'>album</span>.<span class='id identifier rubyid_reload'>reload</span>

<span class='id identifier rubyid_album'>album</span>.<span class='id identifier rubyid_band_id'>band_id</span>
<span class='comment'># =&gt; BSON::ObjectId(&#39;6257699753aefe153121a3d5&#39;)
</span>
<span class='comment'># Band does not exist.
</span><span class='id identifier rubyid_album'>album</span>.<span class='id identifier rubyid_band'>band</span>
<span class='comment'># =&gt; nil</span></code></pre>

<p>To make referenced associations save automatically when the parent is saved,
add the <code>:autosave</code> option to the association:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Album</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span><span class='comma'>,</span> <span class='label'>autosave:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_album'>album</span> <span class='op'>=</span> <span class='const'>Album</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>band:</span> <span class='id identifier rubyid_band'>band</span>)

<span class='comment'># The band is persisted at this point.
</span>
<span class='id identifier rubyid_album'>album</span>.<span class='id identifier rubyid_reload'>reload</span>

<span class='id identifier rubyid_album'>album</span>.<span class='id identifier rubyid_band_id'>band_id</span>
<span class='comment'># =&gt; BSON::ObjectId(&#39;62576b4b53aefe178b65b8e3&#39;)
</span>
<span class='id identifier rubyid_album'>album</span>.<span class='id identifier rubyid_band'>band</span>
<span class='comment'># =&gt; #&lt;Band _id: 62576b4b53aefe178b65b8e3, &gt;</span></code></pre>

<p>The autosaving functionality is automatically added to an association when
using <code>accepts_nested_attributes_for</code>, so that the application does not
need to track which associations were modified when processing a form
submission.</p>

<p>Embedded associations always autosave, because they are stored as part of the
parent document.</p>

<p>Some operations on associations always save the parent and the child documents
as part of the operation, regardless of whether autosaving is enabled.
A non-exhaustive list of these operations is as follows:</p>

<ul>
<li><p>Assignment to the association:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Saves the band and the album.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span> <span class='op'>=</span> [<span class='const'>Album</span>.<span class='id identifier rubyid_new'>new</span>]</code></pre></li>
<li><p><code>push</code>, <code><<</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span> <span class='op'>&lt;&lt;</span> <span class='const'>Album</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span>.<span class='id identifier rubyid_push'>push</span>(<span class='const'>Album</span>.<span class='id identifier rubyid_new'>new</span>)</code></pre></li>
</ul>

<h3>Existence Predicates</h3>

<p>All associations have existence predicates on them in the form of <code>name?</code> and <code>has_name?</code>
to check if the association is blank.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_one'>embeds_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_label?'>label?</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_has_label?'>has_label?</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums?'>albums?</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_has_albums?'>has_albums?</span></code></pre>

<h3>Autobuilding</h3>

<p>One to one associations (<code>embeds_one</code>, <code>has_one</code>) have an autobuild option which tells
Mongoid to instantiate a new document when the association is accessed and it is <code>nil</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_one'>embeds_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span><span class='comma'>,</span> <span class='label'>autobuild:</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_producer'>producer</span><span class='comma'>,</span> <span class='label'>autobuild:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_label'>label</span> <span class='comment'># Returns a new empty label.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_producer'>producer</span> <span class='comment'># Returns a new empty producer.</span></code></pre>

<h3>Touching</h3>

<p>Any <code>belongs_to</code> association can take an optional <code>:touch</code> option which
will cause the parent document to be touched whenever the child document is
updated:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The Rolling Stones</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_save!'>save!</span> <span class='comment'># Calls touch on the parent label.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_touch'>touch</span> <span class='comment'># Calls touch on the parent label.</span></code></pre>

<p><code>:touch</code> can also take a string or symbol argument specifying a field to
be touched on the parent association in addition to updated_at:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Label</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_bands_updated_at'>bands_updated_at</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_bands'>bands</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_bands_updated_at'>bands_updated_at</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_label'>label</span> <span class='op'>=</span> <span class='const'>Label</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>label:</span> <span class='id identifier rubyid_label'>label</span>)

<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_touch'>touch</span> <span class='comment'># Updates updated_at and bands_updated_at on the label.</span></code></pre>

<p>When an embedded document is touched, its parents are recursively touched
through the composition root (because all of the parents are necessarily saved
when the embedded document is saved). The <code>:touch</code> attribute therefore is
unnecessary on <code>embedded_in</code> associations.</p>

<p>Mongoid currently <a href="https://jira.mongodb.org/browse/MONGOID-5014">does not support specifying an additional field to be
touched on an embedded_in association</a>.</p>

<p><code>:touch</code> should not be set to <code>false</code> on an <code>embedded_in</code> association,
since composition hierarchy is always updated upon a touch of an embedded
document. This is currently not enforced but enforcement is <a href="https://jira.mongodb.org/browse/MONGOID-5016">intended in the
future</a>.</p>

<h3>The counter_cache Option</h3>

<p>As with ActiveRecord, the <code>:counter_cache</code> option can be used on an association
to make finding the number of belonging objects more efficient. Also similar
to ActiveRecord, you must take into account that there will be an extra
attribute on the associated model. This means that with Mongoid,
you need to include <a href="Mongoid/Attributes/Dynamic.html" title="Mongoid::Attributes::Dynamic (module)"><code>::Mongoid::Attributes::Dynamic</code></a> on the associated model.
For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_customer'>customer</span><span class='comma'>,</span> <span class='label'>counter_cache:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Customer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Attributes.html" title="Mongoid::Attributes (module)">Attributes</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Attributes/Dynamic.html" title="Mongoid::Attributes::Dynamic (module)">Dynamic</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_orders'>orders</span>
<span class='kw'>end</span></code></pre>

<h3>Association Proxies</h3>

<p>Associations employ transparent proxies to the target objects. This can
cause surprising behavior in some situations.</p>

<p>The method visibility may be lost when methods on association targets are
accessed, depending on the association:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_customer'>customer</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_internal_status'>internal_status</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>new</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Customer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_orders'>orders</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_internal_id'>internal_id</span>
    <span class='int'>42</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_order'>order</span> <span class='op'>=</span> <span class='const'>Order</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_customer'>customer</span> <span class='op'>=</span> <span class='const'>Customer</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>orders:</span> [<span class='id identifier rubyid_order'>order</span>])

<span class='comment'># has_many does not permit calling private methods on the target
</span><span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_orders'>orders</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_internal_status'>internal_status</span>
<span class='comment'># NoMethodError (private method `internal_status&#39; called for #&lt;Order:0x000055af2ec46c50&gt;)
</span>
<span class='comment'># belongs_to permits calling private methods on the target
</span><span class='id identifier rubyid_order'>order</span>.<span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_internal_id'>internal_id</span>
<span class='comment'># =&gt; 42</span></code></pre>

<h2>Association Metadata</h2>

<p>All associations in Mongoid contain metadata that holds information about the association in
question, and is a valuable tool for third party developers to use to extend Mongoid.</p>

<p>You can access the association metadata of the association in a few different ways.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Get the metadata for a named association from the class or document.
</span><span class='const'>Model</span>.<span class='id identifier rubyid_reflect_on_association'>reflect_on_association</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_association_name'>association_name</span>)
<span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_reflect_on_association'>reflect_on_association</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_association_name'>association_name</span>)

<span class='comment'># Get the metadata with a specific association itself on a specific
</span><span class='comment'># document.
</span><span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_associations'>associations</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_association_name'>association_name</span>]</code></pre>

<h3>Attributes</h3>

<p>All associations contain a <code>_target</code>, which is the proxied document or documents, a <code>_base</code>
which is the document the association hangs off, and <code>_association</code> which provides information
about the association.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_addresses'>addresses</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_addresses'>addresses</span> <span class='op'>=</span> [ <span class='id identifier rubyid_address'>address</span> ]
<span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid__target'>_target</span> <span class='comment'># returns [ address ]
</span><span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid__base'>_base</span> <span class='comment'># returns person
</span><span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid__association'>_association</span> <span class='comment'># returns the association metadata</span></code></pre>

<h3>The Association Object</h3>

<p>The association object itself contains more information than one might know what to do
with, and is useful for developers of extensions to Mongoid.</p>

<table><thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code>Association#as</code></td>
<td>Returns the name of the parent to a polymorphic child.</td>
</tr>
<tr>
<td><code>Association#as?</code></td>
<td>Returns whether or not an as option exists.</td>
</tr>
<tr>
<td><code>Association#autobuilding?</code></td>
<td>Returns whether or not the association is autobuilding.</td>
</tr>
<tr>
<td><code>Association#autosaving?</code></td>
<td>Returns whether or not the association is autosaving.</td>
</tr>
<tr>
<td><code>Association#cascading_callbacks?</code></td>
<td>Returns whether the association has callbacks cascaded down from the parent.</td>
</tr>
<tr>
<td><code>Association#class_name</code></td>
<td>Returns the class name of the proxied document.</td>
</tr>
<tr>
<td><code>Association#cyclic?</code></td>
<td>Returns whether the association is a cyclic association.</td>
</tr>
<tr>
<td><code>Association#dependent</code></td>
<td>Returns the association&#39;s dependent option.</td>
</tr>
<tr>
<td><code>Association#destructive?</code></td>
<td>Returns true if the association has a dependent delete or destroy.</td>
</tr>
<tr>
<td><code>Association#embedded?</code></td>
<td>Returns whether the association is embedded in another document.</td>
</tr>
<tr>
<td><code>Association#forced_nil_inverse?</code></td>
<td>Returns whether the association has a nil inverse defined.</td>
</tr>
<tr>
<td><code>Association#foreign_key</code></td>
<td>Returns the name of the foreign key field.</td>
</tr>
<tr>
<td><code>Association#foreign_key_check</code></td>
<td>Returns the name of the foreign key field dirty check method.</td>
</tr>
<tr>
<td><code>Association#foreign_key_setter</code></td>
<td>Returns the name of the foreign key field setter.</td>
</tr>
<tr>
<td><code>Association#indexed?</code></td>
<td>Returns whether the foreign key is auto indexed.</td>
</tr>
<tr>
<td><code>Association#inverses</code></td>
<td>Returns the names of all inverse association.</td>
</tr>
<tr>
<td><code>Association#inverse</code></td>
<td>Returns the name of a single inverse association.</td>
</tr>
<tr>
<td><code>Association#inverse_class_name</code></td>
<td>Returns the class name of the association on the inverse side.</td>
</tr>
<tr>
<td><code>Association#inverse_foreign_key</code></td>
<td>Returns the name of the foreign key field on the inverse side.</td>
</tr>
<tr>
<td><code>Association#inverse_klass</code></td>
<td>Returns the class of the association on the inverse side.</td>
</tr>
<tr>
<td><code>Association#inverse_association</code></td>
<td>Returns the metadata of the association on the inverse side.</td>
</tr>
<tr>
<td><code>Association#inverse_of</code></td>
<td>Returns the explicitly defined name of the inverse association.</td>
</tr>
<tr>
<td><code>Association#inverse_setter</code></td>
<td>Returns the name of the method used to set the inverse.</td>
</tr>
<tr>
<td><code>Association#inverse_type</code></td>
<td>Returns the name for the polymorphic type field of the inverse.</td>
</tr>
<tr>
<td><code>Association#inverse_type_setter</code></td>
<td>Returns the name for the polymorphic type field setter of the inverse.</td>
</tr>
<tr>
<td><code>Association#key</code></td>
<td>Returns the name of the field in the attributes hash to use to get the association.</td>
</tr>
<tr>
<td><code>Association#klass</code></td>
<td>Returns the class of the proxied documents in the association.</td>
</tr>
<tr>
<td><code>Association#name</code></td>
<td>Returns the association name.</td>
</tr>
<tr>
<td><code>Association#options</code></td>
<td>Returns self, for API compatibility with ActiveRecord.</td>
</tr>
<tr>
<td><code>Association#order</code></td>
<td>Returns the custom sorting options on the association.</td>
</tr>
<tr>
<td><code>Association#polymorphic?</code></td>
<td>Returns whether the association is polymorphic.</td>
</tr>
<tr>
<td><code>Association#setter</code></td>
<td>Returns the name of the field to set the association.</td>
</tr>
<tr>
<td><code>Association#store_as</code></td>
<td>Returns the name of the attribute to store an embedded association in.</td>
</tr>
<tr>
<td><code>Association#touchable?</code></td>
<td>Returns whether or not the association has a touch option.</td>
</tr>
<tr>
<td><code>Association#type</code></td>
<td>Returns the name of the field to get the polymorphic type.</td>
</tr>
<tr>
<td><code>Association#type_setter</code></td>
<td>Returns the name of the field to set the polymorphic type.</td>
</tr>
<tr>
<td><code>Association#validate?</code></td>
<td>Returns whether the association has an associated validation.</td>
</tr>
</tbody></table>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>