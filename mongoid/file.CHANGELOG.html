<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: CHANGELOG &mdash; Mongoid master</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "CHANGELOG",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Mongoid master</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: CHANGELOG&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>Overview</h1>

<p>For instructions on upgrading to newer versions, visit
<a href="http://mongoid.org/en/mongoid/docs/upgrading.html">mongoid.org</a>.</p>

<h3>As of version 5.0.2, please refer to the github releases for change logs.</h3>

<h2>5.0.1</h2>

<h3>Resolved Issues</h3>

<ul>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3020">MONGOID-3020</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3025">MONGOID-3025</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3061">MONGOID-3061</a> No longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3073">MONGOID-3073</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3085">MONGOID-3085</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3101">MONGOID-3101</a> No longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3160">MONGOID-3160</a> No longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3176">MONGOID-3176</a> No longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3214">MONGOID-3214</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3296">MONGOID-3296</a> Add update callback for counter_cache.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3326">MONGOID-3326</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3361">MONGOID-3361</a> No longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3365">MONGOID-3365</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3402">MONGOID-3402</a> Apply persistence options to parent.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3524">MONGOID-3524</a> No longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3529">MONGOID-3529</a> Test exists already showing it&#39;s not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3543">MONGOID-3543</a> Test exists already showing it&#39;s not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3611">MONGOID-3611</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3650">MONGOID-3650</a> No longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3826">MONGOID-3826</a>, <a href="https://jira.mongodb.org/browse/MONGOID-4109">MONGOID-4109</a> Fix Timelessness leaks.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3946">MONGOID-3946</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3969">MONGOID-3969</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3971">MONGOID-3971</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3979">MONGOID-3979</a> Not an issue, tests exist already.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3985">MONGOID-3985</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4078">MONGOID-4078</a> Behavior is intended.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4079">MONGOID-4079</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4088">MONGOID-4088</a> Account for sub-document dot notation with #pluck results.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4098">MONGOID-4098</a> Fixed by a change to the Ruby driver. See RUBY-1029.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4101">MONGOID-4101</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4106">MONGOID-4106</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4110">MONGOID-4110</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4119">MONGOID-4119</a> Ensure that criteria selector becomes pipeline operator value.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4121">MONGOID-4121</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4123">MONGOID-4123</a> Fixed as a result of MONGOID-4159.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4125">MONGOID-4125</a> Make sure none scopes referenced in procs are applied.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4132">MONGOID-4132</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4157">MONGOID-4157</a> Fixed by version 2.1.2 of the Ruby driver.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4162">MONGOID-4162</a> Adapt index option mappings to new driver. (@Nielsomat)</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3737">MONGOID-3737</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3621">MONGOID-3621</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3551">MONGOID-3551</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3696">MONGOID-3696</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3858">MONGOID-3858</a> Test added to show it&#39;s no longer an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-3672">MONGOID-3672</a> Not an issue.</li>
<li><a href="https://jira.mongodb.org/browse/MONGOID-4172">MONGOID-4172</a> Use positional operator only on 1 level deep nesting.</li>
<li>Added public cert to repo and sign gem if private key is present</li>
</ul>

<h2>5.0.0</h2>

<h3>Major Changes (Backwards Incompatible)</h3>

<ul>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now uses the official Mongo Ruby Driver 2.x instead of Moped.</p></li>
<li><p>Most driver specific configuration options have changed, please see <a href="https://www.mongodb.com/docs/ecosystem/tutorial/ruby-driver-tutorial/#ruby-options">here</a> for the new options.</p></li>
<li><p>All references to <code>session</code> are now replaced with <code>client</code>. This includes the mongoid.yml configuration, <code>store_in</code> options, and all exceptions and modules with <code>Session</code> in the name.</p></li>
<li><p><code>find_and_modify</code> has been removed and replaced with 3 options: <code>find_one_and_update</code>, <code>find_one_and_delete</code> and <code>find_one_and_replace</code>.</p></li>
<li><p><code>text_search</code> has been removed as it is now a <code>$text</code> option in a query from 2.6 on.</p></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> no longer supports MongoDB 2.2 - support is now for only 2.4 and higher.</p></li>
<li><p>#3768 <code>first</code> and <code>last</code> no longer add an <code>_id</code> sort when no sorting options have been provided. In order to guarantee that a document is the first or last, it needs to now contain an explicit sort.</p></li>
<li><p><code>Document#deleted?</code> alias has been removed, please continue to use <code>Document#destroyed?</code>.</p></li>
</ul>

<h3>New Features</h3>

<ul>
<li><p>#4016 Allow private and protected setters on fields for atomic operations. (Rob Smith)</p></li>
<li><p>#3985 Return nil when using <code>{upsert: true}</code> in <code>find_and_modify</code> (Adrien Siami)</p></li>
<li><p>#3963 Allow extended JSON object ids to be passed to <code>find</code>.</p></li>
<li><p>#3846 Allow #pluck when none is used in criteria. (Braulio Martinez)</p></li>
</ul>

<h3>Resolved Issues</h3>

<ul>
<li><p>#4091 Use subclass context when calling a scope defined in a superclass. (Edgars Beigarts)</p></li>
<li><p>#4075 Made remove index logging specific to each index that was actually getting removed.</p></li>
<li><p>#4071 Fixed loading of enumerable relation to check the added documents when iterating.</p></li>
<li><p>#4077 Many relations now include Enumerable.</p></li>
<li><p>#4052 Fixed uniqueness validation on localized fields with no value.</p></li>
<li><p>#4033 Removed all uses of the $ positional operator in atomic updates.</p></li>
<li><p>#4030 Dup/clone exceptions auto-include dynamic attributes.</p></li>
<li><p>#4005 Fixed inclusion of mongoid with <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> components that don&#39;t have the <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> environment.</p></li>
<li><p>#3993 Fixes issue where <code>dup</code>/<code>clone</code> fails for embedded documents that use store_as without using Mongoid::Attributes::Dynamic</p></li>
<li><p>#3991 Fixed embedded documents not flagging as changed after calling #changed? and modifying the
child elements.</p></li>
<li><p>#3874 Adding snapshot option to context.</p></li>
<li><p>#3868 Loading models in rake tasks now expands the rails path.</p></li>
<li><p>#3764 Fixed case statement check for enumerable targets.</p></li>
<li><p>#3740 Fixes <code>Missing attribute: &#39;_id&#39;</code> error when using methods only or without (dx7)</p></li>
<li><p>#3631 Fixes issue where <code>before_save</code> callback can get called twice after a child create</p></li>
<li><p>#3599 Fixed application of default scopes from superclass in subclasses.</p></li>
<li><p>#3104 Fixed enumerable targets to check first/last in proper order.</p></li>
</ul>

<h2>4.0.2</h2>

<h3>New Features</h3>

<ul>
<li><p>#3931 Add #find_or_create_by! method to many associations. (Tom Beynon)</p></li>
<li><p>#3731 Add find_by! method. (Guillermo Iguaran)</p></li>
</ul>

<h3>Resolved Issues</h3>

<ul>
<li><p>#3722 Use the right database name when combining #store_in and #with. (Arthur Neves)</p></li>
<li><p>#3934 Dont apply sort when doing a find_by. (Arthur Neves)</p></li>
<li><p>#3935 fix multiple fields sorting on contextual memory. (chamnap)</p></li>
<li><p>#3904 BSON::Document#symbolize_keys should return keys as symbols. (Arthur Neves)</p></li>
<li><p>#3948 Fix remove_undefined_indexes on rails 4.2, to symbolize right the Document keys. (Adam Wróbel)</p></li>
<li><p>#3626 Document#to_key, needs to return a ObjectId as <a href="String.html" title="String (class)"><code>String</code></a> so we can query back using that id. (Arthur Neves)</p></li>
<li><p>#3888 raise UnknownAttributeError when &#39;set&#39; is called on non existing field and Mongoid::Attributes::Dynamic is not included in model. (Shweta Kale)</p></li>
<li><p>#3889 &#39;set&#39; will allow to set value of non existing field when Mongoid::Attributes::Dynamic is included in model. (Shweta Kale)</p></li>
<li><p>#3812 Fixed validation context when saving (Yaroslav Zemlyanuhin)</p></li>
</ul>

<h2>4.0.1</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#3911 Fix relations named &quot;parent&quot;. (nkriege)</p></li>
<li><p>#3792/#3881 Fix many internal calls to #_id instead of #id to avoid issues
when overloading #id (Gauthier Delacroix)</p></li>
<li><p>#3847 Fix &#39;QueryCache#get_more&#39; result, when collection has more documents than first query batch. (Angelica Korsun)</p></li>
<li><p>#3684 Dont raise MissingAttributeError, when using a only() scope. (Arthur Neves)</p></li>
<li><p>#3703 pluck method should not compact the values. (Arthur Neves)</p></li>
<li><p>#3773 Use nanoseconds for cache_key timestamp instead of plain seconds. (Máximo Mussini)</p></li>
</ul>

<h2>4.0.0</h2>

<h3>Major Changes (Backwards Incompatible)</h3>

<ul>
<li><p>#3320 Remove Rails dependencies on database rake tasks. (Arthur Neves)</p>

<p>All db:* rake tasks should work as before when using Rails.
When not in a Rails, just load the database tasks using:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_load'>load</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mongoid/tasks/database.rake</span><span class='tstring_end'>&#39;</span></span></code></pre></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 4 now only supports MongoDB 2.4.0 and higher.</p></li>
<li><p><code>Document#metadata</code> has been renamed to <code>Document#relation_metadata</code> to
avoid common conflicts. Relation proxies also have this renamed to the
same as well.</p></li>
<li><p>Scopes and default scopes must now all be defined within lambdas or procs.</p></li>
<li><p><code>skip_version_check</code> config option was removed.</p></li>
<li><p>IdentityMap removed. (Arthur Neves)</p></li>
<li><p>Eager load rework. Eager load now doesnt need the identity map to load
related documents. A set of preloaders can eager load the associations
passed to .includes method. (Arthur Neves)</p></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now supports the new read preferences that the core drivers
provide. These include:</p>

<ul>
<li><code>:primary</code>: Will always read from a primary node. (default)</li>
<li><code>:primary_preferred</code>: Attempt a primary first, then secondary if none available.</li>
<li><code>:secondary</code>: Will always read from a secondary node.</li>
<li><code>:secondary_preferred</code>: Attempt a secondary first, then primary if none available.</li>
<li><code>:nearest</code>: Attempt to read from the node with the lowest latency.</li>
</ul>

<p>Sample syntax:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>read:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_secondary'>secondary</span>).<span class='id identifier rubyid_first'>first</span></code></pre>

<p>The <code>:consistency</code> option is no longer valid, use the <code>:read</code> option now.</p></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now defaults all writes to propagate (formerly &quot;safe mode&quot;) and now
has different propagate semantics:</p>

<ul>
<li><code>{ w: -1 }</code>: Don&#39;t verify writes and raise no network errors.</li>
<li><code>{ w: 0 }</code>: Don&#39;t verify writes and raise network errors.</li>
<li><code>{ w: 1 }</code>: Verify writes on the primary node. (default)</li>
<li><code>{ w: n }</code>: Verify writes on n number of nodes.</li>
<li><code>{ w: &quot;majority&quot; }</code>: Verify writes on a majority of nodes.</li>
</ul>

<p>Sample syntax:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>write:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>}).<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>The <code>:safe</code> option is no longer valid use the <code>:write</code> option now.</p></li>
<li><p>#3230 <a href="Array.html" title="Array (class)"><code>Array</code></a> and <a href="Hash.html" title="Hash (class)"><code>Hash</code></a> fields now validate that the correct types are
getting set, instead of allowing any value. (Rodrigo Saito)</p></li>
<li><p>#3043/#2949 Rework on the internals of persistence options. (Arthur Neves)</p></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now requires Active Model 4 or higher.</p></li>
<li><p><code>Document#set</code> now accepts multiple attributes in the form of a hash,
instead of the previous <code>(field, value)</code> args. Field aliases and typecasting
are also now supported in this operation.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_set'>set</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Photek</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>likes:</span> <span class='int'>10000</span>)</code></pre></li>
<li><p><code>Document#rename</code> now accepts multiple attributes in the form of a hash,
instead of the previous <code>(field, value)</code> args. Field aliases are supported.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_rename'>rename</span>(<span class='label'>first_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fn</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>last_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ln</span><span class='tstring_end'>&quot;</span></span>)</code></pre></li>
<li><p><code>Document#inc</code> now accepts multiple attributes in the form of a hash, instead
of previously only being able to increment one value at a time. Aliases and
serialization is supported.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_inc'>inc</span>(<span class='label'>score:</span> <span class='int'>10</span><span class='comma'>,</span> <span class='label'>place:</span> <span class='op'>-</span><span class='int'>1</span><span class='comma'>,</span> <span class='label'>lives:</span> <span class='op'>-</span><span class='int'>10</span>)</code></pre></li>
<li><p><code>Document#pop</code> now accepts multiple attributes in the form of a hash, instead
of previously only being able to pop one value at a time. Aliases and
serialization is supported.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_pop'>pop</span>(<span class='label'>names:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>aliases:</span> <span class='op'>-</span><span class='int'>1</span>)</code></pre></li>
<li><p><code>Document#bit</code> now accepts multiple attributes in the form of a hash, instead
of previously only being able to apply one set of operations at a time.
Aliases and serialization are supported.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_bit'>bit</span>(<span class='label'>age:</span> { <span class='label'>and:</span> <span class='int'>13</span> }<span class='comma'>,</span> <span class='label'>score:</span> { <span class='label'>or:</span> <span class='int'>13</span> })</code></pre></li>
<li><p><code>Document#pull</code> now accepts multiple attributes in the form of a hash, instead
of previously only being able to pull one value at a time. Aliases and
serialization is supported.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_pull'>pull</span>(<span class='label'>names:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>James</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>aliases:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>007</span><span class='tstring_end'>&quot;</span></span>)</code></pre></li>
<li><p><code>Document#pull_all</code> now accepts multiple attributes in the form of a hash,
instead of previously only being able to pull one value at a time. Aliases and
serialization is supported.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_pull_all'>pull_all</span>(<span class='label'>names:</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>James</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Bond</span><span class='tstring_end'>&quot;</span></span>]<span class='comma'>,</span> <span class='label'>aliases:</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>007</span><span class='tstring_end'>&quot;</span></span>])</code></pre></li>
<li><p><code>Document#push_all</code> has been removed since it was deprecated in MongoDB 2.4.
Use <code>Document.push</code> instead.</p></li>
<li><p><code>Document#push</code> now accepts multiple attributes in the form of a hash, and
can handle the pushing of single values or multiple values to the field via
$push with $each. Aliases and serialization is supported.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_push'>push</span>(<span class='label'>names:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>James</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>aliases:</span> [ <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>007</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Jim</span><span class='tstring_end'>&quot;</span></span> ])</code></pre></li>
<li><p><code>Document#add_to_set</code> now accepts multiple attributes in the form of a hash,
and now aliases and serialization are supported.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_add_to_set'>add_to_set</span>(<span class='label'>names:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>James</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>aliases:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>007</span><span class='tstring_end'>&quot;</span></span>)</code></pre></li>
<li><p>Criteria atomic operations API is now changed to match the changes in the
single document atomic API, for example:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_inc'>inc</span>(<span class='label'>likes:</span> <span class='int'>10</span><span class='comma'>,</span> <span class='label'>followers:</span> <span class='int'>20</span>)</code></pre></li>
<li><p>#3399 #create and #create! on relations can now take an array of attributes as
the first parameter to create multiple documents at once.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_create'>create</span>([{ <span class='label'>street:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Bond</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> { <span class='label'>street:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Upper</span><span class='tstring_end'>&quot;</span></span> }])
<span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_create!'>create!</span>([{ <span class='label'>street:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Bond</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> { <span class='label'>street:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Upper</span><span class='tstring_end'>&quot;</span></span> }])</code></pre></li>
<li><p>#3141 <code>rake db:test:prepare</code> now sets up all defined indexes if <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> is the
only ODM/ORM in the environment.</p></li>
<li><p>#3138 <code>update_attributes</code> can now be accessed simply by calling <code>update</code>.</p></li>
<li><p>#3083 A new rake task: <code>rake db:mongoid:remove_undefined_indexes</code> has been added to
remove indexes from the database that are not explicitly defined in the models.
(Aidan Feldman)</p></li>
<li><p>#3029 The <code>relation_field</code> field that is added for a single use case with polymorphic
relations has been removed. So where the following would work before:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Eye</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_eyeable'>eyeable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Face</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_left_eye'>left_eye</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Eye</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_eyeable'>eyeable</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_right_eye'>right_eye</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Eye</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_eyeable'>eyeable</span>
<span class='kw'>end</span></code></pre>

<p>This would now need to be modeled as (with the appropriate migration):</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Eye</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_left_socket'>left_socket</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Face</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_left_eye'>left_eye</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_right_socket'>right_socket</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Face</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_right_eye'>right_eye</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Face</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_left_eye'>left_eye</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Eye</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_left_socket'>left_socket</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_right_eye'>right_eye</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Eye</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_right_socket'>right_socket</span>
<span class='kw'>end</span></code></pre></li>
<li><p>#3075 <code>update_attribute</code> now properly calls the setter method instead of
using <code>write_attribute</code>.</p></li>
<li><p>#3060 Allow atomically blocks to allow multiple calls of the same type.
(Brian Norton)</p></li>
<li><p>#3037 Model indexes are no longer stored in an <code>index_options</code> hash on the
model class. Instead, an array named <code>index_specifications</code> now exists on the
class which contains a list of <code>Indexable::Specification</code> objects. This is so
we could properly handle the case of indexes with the same keys but different
order.</p></li>
<li><p>#2956 Caching on queries now only happens when <code>cache</code> is specifically
called. (Arthur Neves)</p></li>
<li><p>#2659 <code>Mongoid::Railtie</code> now properly uses only one initializer and
the name has changed to <code>mongoid.load-config</code>.</p></li>
<li><p>#2656 <code>rake db:reseed</code> is now <code>rake db:reset</code> (Arthur Neves)</p></li>
<li><p>#2648 <code>Boolean</code> becomes <a href="Mongoid/Boolean.html" title="Mongoid::Boolean (class)"><code>::Mongoid::Boolean</code></a> to avoid polluting the global
namespace with a commonly used class by other libraries.</p></li>
<li><p>#2603 Return values from setters are now always the set value, regardless
of calling the setter or using send.</p></li>
<li><p>#2597 <code>Mongoid::Observer</code> was removed in line with <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 4.</p></li>
<li><p>#2563 The <code>allow_dynamic_fields</code> configuration option has been removed as
dynamic fields are now allowed on a per-model level. In order to allow a
model to use dynamic fields, simply include the module in each.
(Josh Martin)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Attributes.html" title="Mongoid::Attributes (module)">Attributes</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Attributes/Dynamic.html" title="Mongoid::Attributes::Dynamic (module)">Dynamic</a></span>
<span class='kw'>end</span></code></pre></li>
<li><p>#2497 Calling <code>to_json</code> no longer tampers with the return value from the
driver, and proper returns <code>{ &quot;$oid&quot; : object_id.to_s }</code> instead of just
the string representation previously.</p></li>
<li><p>#2433 <code>Mongoid::Paranoia</code> has been removed.</p></li>
<li><p>#2432 <code>Mongoid::Versioning</code> has been removed.</p></li>
<li><p>#2218 Creating or instantiating documents that have default scopes will now
apply the default scope to the document, if the scope is not complex.</p></li>
<li><p>#2200 Mass assignment security now mirrors <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 4&#39;s behavior.
<code>without_protection</code> option was also removed.
<code>attr_accessible</code> class method was removed.
Mongoid and Strong parameters should work fine for mass assignment protection.</p></li>
<li><p><code>delete_all</code> and <code>destroy_all</code> no longer take a <code>:conditions</code> hash but
just the raw attributes.</p></li>
<li><p>#1908 Documents now loaded from criteria using <code>#only</code> or <code>#without</code> will now
raise an error when attempting to save, update, or delete these records.
Additionally fields excluded from the fields retrieved from the database will
also raise an exception when trying to access them.</p></li>
<li><p>#1344 Atomic updates can now be executed in an <code>atomically</code> block, which will
delay any atomic updates on the document the block was called on until the
block is complete.</p>

<p>Update calls can be executed as normal in the block:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_atomically'>atomically</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_inc'>inc</span>(<span class='label'>likes:</span> <span class='int'>10</span>)
  <span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_bit'>bit</span>(<span class='label'>members:</span> { <span class='label'>and:</span> <span class='int'>10</span> })
  <span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_set'>set</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Photek</span><span class='tstring_end'>&quot;</span></span>)
<span class='kw'>end</span></code></pre>

<p>The document is also yielded to the block:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_atomically'>atomically</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_doc'>doc</span><span class='op'>|</span>
  <span class='id identifier rubyid_doc'>doc</span>.<span class='id identifier rubyid_inc'>inc</span>(<span class='label'>likes:</span> <span class='int'>10</span>)
  <span class='id identifier rubyid_doc'>doc</span>.<span class='id identifier rubyid_bit'>bit</span>(<span class='label'>members:</span> { <span class='label'>and:</span> <span class='int'>10</span> })
  <span class='id identifier rubyid_doc'>doc</span>.<span class='id identifier rubyid_set'>set</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Photek</span><span class='tstring_end'>&quot;</span></span>)
<span class='kw'>end</span></code></pre>

<p>The atomic commands are have a fluid interface:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_atomically'>atomically</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_doc'>doc</span><span class='op'>|</span>
  <span class='id identifier rubyid_doc'>doc</span>.<span class='id identifier rubyid_inc'>inc</span>(<span class='label'>likes:</span> <span class='int'>10</span>).<span class='id identifier rubyid_bit'>bit</span>(<span class='label'>members:</span> { <span class='label'>and:</span> <span class='int'>10</span> }).<span class='id identifier rubyid_set'>set</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Photek</span><span class='tstring_end'>&quot;</span></span>)
<span class='kw'>end</span></code></pre>

<p>If the fluid interface is leveraged without the <code>atomically</code> block, the
operations will persist in individual calls. For example, the following
would hit the database 3 times without the block provided:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_doc'>doc</span>.<span class='id identifier rubyid_inc'>inc</span>(<span class='label'>likes:</span> <span class='int'>10</span>).<span class='id identifier rubyid_bit'>bit</span>(<span class='label'>members:</span> { <span class='label'>and:</span> <span class='int'>10</span> }).<span class='id identifier rubyid_set'>set</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Photek</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>The block is only good for 1 document at a time, so embedded and root
document updates cannot be mixed at this time.</p></li>
</ul>

<h3>New Features</h3>

<ul>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now uses ActiveSupport::LogSubscriber to subscribe logs, and
ActiveSupport::Notifications to send operation logs. (Arthur Neves)
Example of log subscription:</p>

<p>ActiveSupport::Notifications.subscribe(&#39;query.moped&#39;) do |event|
  ..
end</p></li>
<li><p>Field types can now use symbols as well as class names. See:
<a href="https://github.com/mongoid/mongoid/blob/master/lib/mongoid/fields.rb#L16">https://github.com/mongoid/mongoid/blob/master/lib/mongoid/fields.rb#L16</a>
for the available mappings.</p></li>
<li><p>#3580 Fields can now be reset to their default values, with the methods:</p>

<p>document.reset_name_to_default!</p></li>
<li><p>#3513 Documents now have a <code>#destroy!</code> method that will raise a
<a href="Mongoid/Errors/DocumentNotDestroyed.html" title="Mongoid::Errors::DocumentNotDestroyed (class)"><code>::Mongoid::Errors::DocumentNotDestroyed</code></a> error if a destroy callback returns
a false value.</p></li>
<li><p>#3496 Added class level and criteria level <code>find_or_create_by!</code>.</p></li>
<li><p>#3479 Map/reduce now respects criteria no timeout options if output is not
inline.</p></li>
<li><p>#3478 Criteria objects now have a #none method that will cause the criteria to
never hit the database and always have zero documents.</p>

<p>Band.none
Band.none.where(name: &quot;Tool&quot;) # Always has zero documents.</p></li>
<li><p>#3410 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now has a query cache that can be used as a middleware in
Rack applications. (Arthur Neves)</p>

<p>For Rails:</p>

<p>config.middleware.use(Mongoid::QueryCache::Middleware)</p></li>
<li><p>#3319 Counters can now be reset from a document instance:</p>

<p>document.reset_counters(:relation)</p></li>
<li><p>#3310 embedded_in relations now accept a <code>touch</code> option to update parents.</p></li>
<li><p>#3302 Aliasing using <code>alias_attribute</code> now properly handles aliases in criteria.</p></li>
<li><p>#3155 Range field will persist the exclude_end when provided.
(Daniel Libanori)</p></li>
<li><p>#3146 Adding <code>:overwrite</code> field option, when it`s true, it wont check duplicates.
(Daniel Libanori)</p></li>
<li><p>#3002 Reloading the <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> console will also now clear Mongoid&#39;s identity map.</p></li>
<li><p>#2938 A configuration option <code>duplicate_fields_exception</code> has been added that
when set to <code>true</code> will raise an exception when defining a field that will
override an existing method. (Arthur Neves)</p></li>
<li><p>#2924 MongoDB 2.4 beta text search now has a DSL provided by <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a>. Like
other queries, text searches are lazy evaluated, and available off the class
or criteria level.</p>

<p>Note that any 3rd party gem that provides a <code>text_search</code> method will now no
longer work with Mongoid, and will need to change its syntax. Examples:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_text_search'>text_search</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>mode</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_project'>project</span>(<span class='label'>name:</span> <span class='int'>1</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_doc'>doc</span><span class='op'>|</span>
  <span class='comment'># ...
</span><span class='kw'>end</span>

<span class='const'>Band</span>.<span class='id identifier rubyid_limit'>limit</span>(<span class='int'>10</span>).<span class='id identifier rubyid_text_search'>text_search</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>phase</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_language'>language</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>latin</span><span class='tstring_end'>&quot;</span></span>)
<span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_likes'>likes</span>.<span class='id identifier rubyid_gt'>gt</span> <span class='op'>=&gt;</span> <span class='int'>1000</span>).<span class='id identifier rubyid_text_search'>text_search</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lucy</span><span class='tstring_end'>&quot;</span></span>)</code></pre></li>
<li><p>#2855 Multiple extensions can now be supplied to relations. (Daniel Libanori)</p></li>
</ul>

<h3>Resolved Issues</h3>

<ul>
<li><p>#3676 Make pluck work with embedded associations
(Arthur Neves)</p></li>
<li><p>#2898 Dirty attribute methods now properly handle field aliases.
(Niels Ganser)</p></li>
<li><p>#3620 Add ActiveModel module instance methods to prohibited_methods list.
(Arthur Neves)</p></li>
<li><p>#3610 Don&#39;t allow atomic operations on read-only attributes
(Frederico Araujo)</p></li>
<li><p>#3619 Don&#39;t validate documents that are flagged for destruction.
(Christopher J. Bottaro)</p></li>
<li><p>#3617 Don&#39;t skip index creation on cyclic documents. (shaiker)</p></li>
<li><p>#3568 Fixed missing attributes error on present localized fields.</p></li>
<li><p>#3514 Fixed query cache to work on first/last calls.</p></li>
<li><p>#3383/#3495 Fix has_and_belongs_to_many eager load. (Arthur Neves)</p></li>
<li><p>#3492 $rename operations should not mongoize values. (Vladislav Melanitskiy)</p></li>
<li><p>#3490 Allow localized fields to work with boolean <code>false</code> values.</p></li>
<li><p>#3487 Map Boolean to <a href="Mongoid/Boolean.html" title="Mongoid::Boolean (class)"><code>::Mongoid::Boolean</code></a> in field definitions. (Arthur Neves)</p></li>
<li><p>#3449 Touch needs to work for create and update. (Greggory Rothmeier)</p></li>
<li><p>#3347 Creating documents off of scopes for embedded relations now properly
sets the parent document on the created children.</p></li>
<li><p>#3432 Fixed mongoization of <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> losing precision.</p></li>
<li><p>#3397 Fixed $ne matcher for embedded documents to match server behavior.</p></li>
<li><p>#3352 Allow named scopes named &quot;open&quot; to work through 1-n relations.</p></li>
<li><p>#3348 Fixing compounded indexes having the same keys with
different directions. (Arthur Neves)</p></li>
<li><p>#2701 Fixing extra query on belongs_to binding. (Arthur Neves)</p></li>
<li><p>#3089 Allow demongoization of strings to floats (Daniel Libanori)</p></li>
<li><p>#3278 Counter cache should update the document in memory too. (Arthur Neves)</p></li>
<li><p>#3242 Has_many relation must use the inverse foreign_key. (Arthur Neves)</p></li>
<li><p>#3233 Don&#39;t double call validation callbacks when cascading children and
relation validation is turned on.</p></li>
<li><p>#3197 Improvements in the calls to <code>aggregates</code> on root and embedded
collections. (Wojciech Piekutowski)</p></li>
<li><p>#3144/#3219 Fixing name collision on @_children ivar. (Arthur Neves)</p></li>
<li><p>#3088 Range field can accept a hash, which could be the attribute from the db.
(Daniel Libanori)</p></li>
<li><p>#3116 Relations instance variables are now all prefixed with <code>_</code>.</p></li>
<li><p>#3093 Only flatten 1 level when atomically pushing arrays.</p></li>
<li><p>#3063 <code>Document#becomes</code> now properly sets base object on errors.
(Adam Ross Cohen)</p></li>
<li><p>#3019 Atomic operations will no longer attempt to persist if the document
is not persisted.</p></li>
<li><p>#2903 Removed unused string <code>to_a</code> extension.</p></li>
</ul>

<h2>3.1.7</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#3465 Fixed ambiguous relation errors where inverse_of is set to nil.</p></li>
<li><p>#3414 Backport skip and limit options on aggregation. (Wojciech Piekutowski)</p></li>
<li><p>#3469 Fix RegexpError: failed to allocate memory: /./ on .hash_dot_syntax?  (Dmitry Krasnoukhov)</p></li>
</ul>

<h2>3.1.6</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#3337 Ensure localized fields map is cloned with inheritance.</p></li>
<li><p>#3262 Fixed atomic array operations on HABTM foreign key fields from turning
single elements into arrays.</p></li>
<li><p>#3282 Fixed .timeless option to use a thread local instead of a class attribute.
Also remove the timeless methods from all docs, and only add to timestamps docs.
(Arthur Neves)</p></li>
</ul>

<h2>3.1.5</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#3231 Allow evolution of proxy documents to work in criteria.</p></li>
<li><p>#3247 Bump dependency on tzinfo to 0.3.29.</p></li>
<li><p>#3203 Fixed <code>index: true</code> specification for polymorphic relations.</p></li>
<li><p>#3192 Fixed aliased fields + localized fields combinations with
validation. (Johnny Shields)</p></li>
<li><p>#3173 Fixed issues around many to many relations with custom primary keys.
(Bowen Sun)</p></li>
<li><p>#3159 Upserting now properly flags documents as persisted.</p></li>
<li><p>#3137 Allow multiple <code>belongs_to</code> sets in a row with ids.</p></li>
<li><p>#3079 Embedded docs with paranoia parents were losing the _id when
reloading from db, as they didnt have the right persisted? value. (Arthur Neves)</p></li>
<li><p>#3081 Criteria&#39;s <code>method_missing</code> now checks if an array responds to the provided
method before calling entries in order to not hit the database if a <code>NoMethodError</code>
was to get raised.</p></li>
<li><p>#3068 Fixed spec runs on non standard MongoDB ports if <code>MONGOID_SPEC_PORT</code> is
set.</p></li>
<li><p>#3047 Ensure <code>blank?</code> and <code>empty?</code> don&#39;t fall through method missing on criteria.</p></li>
<li><p>Include updated_at on cache_key even when is a short timestamp (Arthur Neves)</p></li>
</ul>

<h2>3.1.4</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#3044 Ensure enumerable targets match arrays in case statements.</p></li>
<li><p>#3034 <code>first_or_create</code> on criterion now properly passes the block to create
instead of calling after the document was created.</p></li>
<li><p>#3021 Removed <code>mongoid.yml</code> warning from initializer, this is now handled by
the session configuration options.</p></li>
<li><p>#3018 Uniqueness validator now properly serializes values in its check.
(Jerry Clinesmith)</p></li>
<li><p>#3011 Fixed aliased field support for uniqueness validation. (Johnny Shields)</p></li>
<li><p>#3008 Fixed subclasses not being able to inherit scopes properly when scope
is added post class load. (Mike Dillon)</p></li>
<li><p>#2991 <code>Document.timeless</code> now properly scopes to the instance and not thread.</p></li>
<li><p>#2980 Dynamic fields now properly handle in place editing of hashes and
arrays. (Matthew Widmann)</p></li>
<li><p>#2979 <code>pluck</code> no longer modifies the context in place. (Brian Goff)</p></li>
<li><p>#2970 Fixed counter cache to properly use the name of the relation if available
then the inverse class name second if not.</p></li>
<li><p>#2959 Nested attributes will now respect <code>autosave: false</code> if defined on the
relation.</p></li>
<li><p>#2944 Fixed uniqueness validation for localized fields when case insensitive
is true. (Vladimir Zhukov)</p></li>
</ul>

<h2>3.1.3</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>Dont duplicate embedded documents when saving after calling becomes method.
(Arthur Neves)</p></li>
<li><p>#2961 Reloading a mongoid.yml configuration now properly clears previously
configured sessions.</p></li>
<li><p>#2937 Counts can now take a <code>true</code> argument to factor in skip and limit.
(Arthur Neves)</p></li>
<li><p>#2921 Don&#39;t use type in identity map selection if inheritance is not
in play. (Arthur Neves)</p></li>
<li><p>#2893 Removed memoization of collection name and database name so lambdas
with <code>store_in</code> work properly when changing.</p></li>
<li><p>#2911 The <code>_destroy</code> attribute on 1-n relations when processing nested
attributes can now be a string or symbol when passed an array.</p></li>
<li><p>#2886 Fixed namespacing issue with <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> generators.</p></li>
<li><p>#2885 Fixed touch for aliased fields. (Niels Ganser)</p></li>
<li><p>#2883 Allow cyclic relations to not raise mixed relation errors.</p></li>
<li><p>#2867 <code>pluck</code> now properly handles aliased fields.</p></li>
<li><p>#2862 Autosaving no longer performs extra unnecessary queries.
(Arthur Neves)</p></li>
</ul>

<h2>3.1.2</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2851 Fixed BigDecimal demongoization of NaN values. (nkem)</p></li>
<li><p>#2848 Fixed <code>touch</code> to work when usinng short timestamps. (Arthur Neves)</p></li>
<li><p>#2840 Fixed end-to-end <code>no_timeout</code> option handling.</p></li>
<li><p>#2826 Dynamic fields are now properly mongoized.</p></li>
<li><p>#2822 Marshal load of relations now properly reapplies extensions.</p></li>
</ul>

<h2>3.1.1</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2839 Validations fixed to use the type cast value with the exception
of the numericality validator. (Lailson Bandeira)</p></li>
<li><p>#2838 <code>store_in</code> options now properly merge instead of override.
(Colin MacKenzie)</p></li>
</ul>

<h2>3.1.0</h2>

<h3>New Features</h3>

<ul>
<li><p>The minimum MongoDB requirement is now raised to 2.2, since we now
depend on the aggregation framework.</p></li>
<li><p>The minimum Active Model and Active Support dependencies have been
raised to 3.2.</p></li>
<li><p>#2809 Relations can now specify a primary key to use instead of the
id on foreign keys.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cats'>cats</span><span class='comma'>,</span> <span class='label'>primary_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>username</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Cat</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_person'>person</span><span class='comma'>,</span> <span class='label'>primary_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>username</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre></li>
<li><p>#2804 $geoNear support has now been added to criteria.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Bar</span>.<span class='id identifier rubyid_where'>where</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_likes'>likes</span>.<span class='id identifier rubyid_gt'>gt</span> <span class='op'>=&gt;</span> <span class='int'>1000</span>).<span class='id identifier rubyid_geo_near'>geo_near</span>([ <span class='int'>52</span><span class='comma'>,</span> <span class='int'>13</span> ])
<span class='const'>Bar</span>.<span class='id identifier rubyid_geo_near'>geo_near</span>([ <span class='int'>52</span><span class='comma'>,</span> <span class='int'>13</span> ]).<span class='id identifier rubyid_max_distance'>max_distance</span>(<span class='float'>0.5</span>).<span class='id identifier rubyid_spherical'>spherical</span></code></pre></li>
<li><p>#2799 Criteria#map can now accept a symbol of a field name as well as
a block to perform a more optimized <code>map</code>. (Gosha Arinich)</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_likes'>likes</span>.<span class='id identifier rubyid_gt'>gt</span> <span class='op'>=&gt;</span> <span class='int'>1000</span>).<span class='id identifier rubyid_map'>map</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>)</code></pre></li>
<li><p>#2798 Aggregations (<code>sum</code>, <code>min</code>, <code>max</code>, <code>avg</code>) now use the
aggregation framework instead of map/reduce. (Gosha Arinich)</p></li>
<li><p>#2776 MongoDB 2.4.x new index types are now supported: &quot;2dsphere&quot;,
&quot;text&quot;, and &quot;hashed&quot;. (Irakli Janiashvili)</p></li>
<li><p>#2767 $maxScan support from Origin is now supported. (Jonathan Hyman)</p></li>
<li><p>#2701 Cleanup up extra excessive database queries with 1-1 relations.</p></li>
<li><p>#2693 Custom collection names can be passed to the model generator.
(Subhash Bhushan)</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rails'>rails</span> <span class='id identifier rubyid_g'>g</span> <span class='id identifier rubyid_model'>model</span> <span class='id identifier rubyid_band'>band</span> <span class='op'>-</span><span class='op'>-</span><span class='id identifier rubyid_collection'>collection</span><span class='op'>=</span><span class='id identifier rubyid_artists'>artists</span></code></pre></li>
<li><p>#2688 <code>Model.create</code> and <code>Model.create!</code> now can take an array of
attributes hashes to create multiple documents at once. If an array
of attributes is provided then an array of documents is returned.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_create'>create</span>([{ <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Placebo</span><span class='tstring_end'>&quot;</span></span> }])
<span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>([{ <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Placebo</span><span class='tstring_end'>&quot;</span></span> }])</code></pre></li>
<li><p>#2670 Unsetting fields now accepts multiple fields instead of only 1.
(Arthur Neves)</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_unset'>unset</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_founded'>founded</span>)
<span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Placebo</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_unset'>unset</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_members'>members</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_origin'>origin</span>)</code></pre></li>
<li><p>#2669 Passing a block to <code>Criteria#new</code> now properly sends the
block through to the model&#39;s constructor. (Arthur Neves)</p></li>
<li><p>#2667 <code>exists?</code> no longer hits the database in cases where we have
the necessary information in memory.</p></li>
<li><p>#2665 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now supports a counter cache for <code>belongs_to</code>
relations. (Arthur Neves)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span><span class='comma'>,</span> <span class='label'>counter_cache:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>b_count</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Album</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_band'>band</span><span class='comma'>,</span> <span class='label'>counter_cache:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre></li>
<li><p>#2662 Embedded documents that have <code>belongs_to</code> relations may now
eager load them.</p></li>
<li><p>#2657 Logger getter and setter convenience methods have been
added to the <code>Config</code> module. (Arthur Neves)</p></li>
<li><p>#2615 Index options can now take a specific database name if the
indexes are only to exist in a database other than the default.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_index'>index</span> <span class='label'>name:</span> <span class='int'>1</span><span class='comma'>,</span> { <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>another_db</span><span class='tstring_end'>&quot;</span></span> }
<span class='kw'>end</span></code></pre></li>
<li><p>#2613 Procs can now be provided as values to <code>store_in</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_store_in'>store_in</span> <span class='label'>database:</span> <span class='tlambda'>-&gt;</span><span class='tlambeg'>{</span> <span class='const'>Thread</span>.<span class='id identifier rubyid_current'>current</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span>] }
<span class='kw'>end</span></code></pre></li>
<li><p>#2609 Pass through batch_size option to query. (Martin Mauch)</p></li>
<li><p>#2555 Passing hashes to <code>find</code> when the documents id is of type hash
now properly works. (Szymon Kurcab)</p></li>
<li><p>#2545 The <code>$</code> positional operator is used for update selectors on
embedded documents that are nested 1 level deep, when appropriate.</p></li>
<li><p>#2539 <code>Mongoid.models</code> now tracks all models in the application for more
accurate determination of models for things such as indexing rake tasks.
(Ara Howard)</p></li>
<li><p>#2525 Added the ability to have short timestamped fields with aliases. This
sets timestamp fields as <code>c_at</code> and <code>u_at</code> that are also aliased as
<code>created_at</code> and <code>updated_at</code> for convenience. (Rodrigo Saito)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Short.html" title="Mongoid::Timestamps::Short (module)">Short</a></span> <span class='comment'># For c_at and u_at.
</span><span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Created.html" title="Mongoid::Timestamps::Created (module)">Created</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Created/Short.html" title="Mongoid::Timestamps::Created::Short (module)">Short</a></span> <span class='comment'># For c_at only.
</span><span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Updated.html" title="Mongoid::Timestamps::Updated (module)">Updated</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Updated/Short.html" title="Mongoid::Timestamps::Updated::Short (module)">Short</a></span> <span class='comment'># For u_at only.
</span><span class='kw'>end</span></code></pre></li>
<li><p>#2465 Documents now have an <code>attribute_before_type_cast</code> for proper
handling of validations. (Gerad Suyderhoud)</p></li>
<li><p>#2443 <code>expire_after_seconds</code> is now a valid index option
(<a href="https://www.mongodb.com/docs/manual/core/indexes/#ttl-indexes">https://www.mongodb.com/docs/manual/core/indexes/#ttl-indexes</a>,
<a href="https://www.mongodb.com/docs/manual/tutorial/expire-data/">https://www.mongodb.com/docs/manual/tutorial/expire-data/</a>).</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Event</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_created_at'>created_at</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="DateTime.html" title="DateTime (class)">DateTime</a></span>
  <span class='id identifier rubyid_index'>index</span>({ <span class='label'>created_at:</span> <span class='int'>1</span> }<span class='comma'>,</span> { <span class='label'>expire_after_seconds:</span> <span class='int'>3600</span> })
<span class='kw'>end</span></code></pre></li>
<li><p>#2373 Relations with the <code>touch: true</code> option will now be automatically
touched when the child document is created or destroyed.</p></li>
<li><p>Added <code>Document.first_or_create!</code> and <code>Criteria#first_or_create!</code>. This
raises a validations error if creation fails validation.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_first_or_create!'>first_or_create!</span>
<span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_first_or_create!'>first_or_create!</span>(<span class='label'>active:</span> <span class='kw'>true</span>)</code></pre></li>
<li><p>Added <code>Document.first_or_initialize</code> and <code>Criteria#first_or_initialize</code>.
This is the same as <code>first_or_create</code> but initializes a new (unpersisted)
document if none is found.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_first_or_initialize'>first_or_initialize</span>
<span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_first_or_initialize'>first_or_initialize</span>(<span class='label'>active:</span> <span class='kw'>true</span>)</code></pre></li>
<li><p>Added <code>Model.pluck</code> and <code>Criteria#pluck</code> similar to Active Record&#39;s, which
returns an array of values for the provided field. (Jason Lee)</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_pluck'>pluck</span>(<span class='symbeg'>:</span><span class='id identifier rubyid__id'>_id</span>)
<span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_pluck'>pluck</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_likes'>likes</span>)</code></pre></li>
<li><p>#2324 Embeds many relations now properly handle <code>delete_if</code>.</p></li>
<li><p>#2317 Added <code>Document.first_or_create</code> and <code>Criteria#first_or_create</code>.
This will return the first matching document or create one with additional
attributes if one does not exist. (incorvia)</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_first_or_create'>first_or_create</span>
<span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_first_or_create'>first_or_create</span>(<span class='label'>active:</span> <span class='kw'>true</span>)</code></pre></li>
<li><p>#2292 Added <code>Model.each_with_index</code>.</p></li>
<li><p>#2285 <code>Config.load_configuration</code> is now public for those who want to instantiate
settings directly from a hash.</p></li>
<li><p>#2275 Added rake task <code>db:mongoid:purge</code> that will drop all collections with
the exception of the system collections in the default database.</p></li>
<li><p>#2257 <code>after_find</code> callbacks have been added for when documents are returned
from the database.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_after_find'>after_find</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_doc'>doc</span><span class='op'>|</span>
    <span class='comment'># Some logic here.
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre></li>
<li><p>#2223 Allow to find documents by javascript with parameters that are
protected from javascript injection via <code>Model.for_js</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_for_js'>for_js</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>this.name = param</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>param:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>)
<span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_likes'>likes</span>.<span class='id identifier rubyid_gt'>gt</span> <span class='op'>=&gt;</span> <span class='int'>1000</span>).<span class='id identifier rubyid_for_js'>for_js</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>this.likes &lt; this.follows</span><span class='tstring_end'>&quot;</span></span>)</code></pre></li>
<li><p>#2197 When providing session configuration with no ports, <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> will now
default these to 27017.</p></li>
<li><p>#2180 1-n and n-n relations now support before/after add/remove callbacks.
(Rodrigo Saito)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span><span class='comma'>,</span> <span class='label'>after_add:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_notify_labels'>notify_labels</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_followers'>followers</span><span class='comma'>,</span> <span class='label'>before_remove:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_band'>band</span><span class='comma'>,</span> <span class='id identifier rubyid_follower'>follower</span>)<span class='tlambeg'>{</span> <span class='id identifier rubyid_notify_unfollow'>notify_unfollow</span>(<span class='id identifier rubyid_follower'>follower</span>) }
<span class='kw'>end</span></code></pre></li>
<li><p>#2157 <code>Criteria#update</code> and <code>Criteria#update_all</code> now serialize values
according to their field type, if a field is defined.</p></li>
<li><p>#2022 Custom callbacks can now register themselves for use with observers
by using the <code>observable</code> macro.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_define_model_callbacks'>define_model_callbacks</span> <span class='symbeg'>:</span><span class='id identifier rubyid_notification'>notification</span>
  <span class='id identifier rubyid_observable'>observable</span> <span class='symbeg'>:</span><span class='id identifier rubyid_notification'>notification</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>BandObserver</span> <span class='op'>&lt;</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'>Observer</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_before_notification'>before_notification</span>(<span class='id identifier rubyid_band'>band</span>)
    <span class='comment'>#...
</span>  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_after_notification'>after_notification</span>(<span class='id identifier rubyid_band'>band</span>)
    <span class='comment'>#...
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre></li>
<li><p>#1766 Many to many relations will not touch the database if the foreign key
is an empty array.</p></li>
<li><p>#1564 Many to many foreign keys now have the default set lazily only if the
relation has been accessed. This avoids storing empty arrays if the relation
has not been touched.</p></li>
</ul>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2730 Calling sort on a context properly updates the context&#39;s criteria.
(Arthur Neves)</p></li>
<li><p>#2719 <code>distinct</code> is now available at the class level.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_distinct'>distinct</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>)</code></pre></li>
<li><p>#2714 Overriding sessions when the new session has a different database will
now properly switch the database at runtime as well.</p></li>
<li><p>#2697 Eager loading fixed when including multiple models that inherit from
the same class. (Kirill Lazarev)</p></li>
<li><p>#2664 In memory sorting of embedded documents now properly works when
multiple fields are provided. (Neer Friedman)</p></li>
</ul>

<h2>3.0.24</h2>

<h3>Resolved Issues</h3>

<ul>
<li>#2879 <code>remove_attribute</code> on new documents no longer creates an unnecessary
$unset operation.</li>
</ul>

<h2>3.0.23</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2851 Fixed BigDecimal demongoization of NaN values. (nkem)</p></li>
<li><p>#2841 Calling <code>delete_all</code> or <code>destroy_all</code> on an embeds many when in the
middle of a parent update will now properly execute the deletion.
(Arthur Neves)</p></li>
<li><p>#2835 Fixed clearing of persistence options in uniqueness validator.</p></li>
<li><p>#2826 Dynamic fields are now properly mongoized.</p></li>
<li><p>#2822 Marshal load of relations now properly reapplies extensions.</p></li>
<li><p>#2821 Autosaved relations should be duped in inheriting classes.</p></li>
</ul>

<h2>3.0.22</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2812 Fixed criteria on many to many relations when the base document is
destroyed and the foreign key has not yet been lazy evaluated.</p></li>
<li><p>#2796 Don&#39;t cascade changes on has_many relations when assigning with
a delete.</p></li>
<li><p>#2795 Fix precision on time conversions. (Tom de Bruijn)</p></li>
<li><p>#2794 Don&#39;t autobuild when reading a relation for validation.</p></li>
<li><p>#2790 <code>becomes</code> now copies embedded documents even if they were protected
by mass assignment.</p></li>
<li><p>#2787 Allow <code>becomes</code> to replace the document in the identity map.</p></li>
<li><p>#2786 Fixed regressed cascading callbacks on destroy not firing.</p></li>
<li><p>#2784 Fixed uniqueness validation properly getting added to subclasses.
(Takeshi Akima)</p></li>
</ul>

<h2>3.0.21</h2>

<h3>Resolved Issues</h3>

<ul>
<li>#2781 / * #2777 - Fixed issue with serialization of <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> that was
only present in Rails environments.</li>
</ul>

<h2>3.0.20</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2774 Ensure validations macros for uniqueness, presence, and associated
are also available at the instance level.</p></li>
<li><p>#2772 Localized fields are now properly handled when cloning a document.</p></li>
<li><p>#2758 <code>Mongoid.create_indexes</code> does not fail when cannot constantize class.
(Arthur Neves)</p></li>
<li><p>#2743 Persistence options are no longer cleared when loading revisions.
(Arthur Neves)</p></li>
<li><p>#2741 Fix time mongoization usec rounding errors on MRI and JRuby.</p></li>
<li><p>#2740 Support integer keys in hash fields when using <code>read_attribute</code> with
dot notation.</p></li>
<li><p>#2739 Ensure integer deserialization properly casts to integers.</p></li>
<li><p>#2733 Many to many relations with <code>inverse_of: nil</code> do not persist the
inverse relation on <code>&lt;&lt;</code> or <code>push</code> if the document is already persisted.</p></li>
<li><p>#2705 Fixed logic around when children can be added to the cascading
callbacks list.</p></li>
</ul>

<h2>3.0.19</h2>

<h3>Resolved Issues</h3>

<ul>
<li>Released to revert the changes in #2703.</li>
</ul>

<h2>3.0.18</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2707 Calling <code>find_or_create_by</code> or <code>find_by_initialize_by</code> off a relation
with a chained criteria or scope now properly keeps the relations intact on
the new or found document.</p></li>
<li><p>#2699 Resetting a field now removes the name from the changed attributes
list. (Subhash Bhushan)</p></li>
<li><p>#2683 Aliased fields are now supported when executing atomic operations from
criteria. (Arthur Neves)</p></li>
<li><p>#2678 Calling <code>Criteria#sum</code> with no matching documents returns <code>0</code> instead
of <code>nil</code>.</p></li>
<li><p>#2671 Matchers now correctly handle symbol keys. (Jonathan Hyman)</p></li>
</ul>

<h2>3.0.17</h2>

<h3>Resolved Issues</h3>

<ul>
<li>#2686 Fixed the broken Moped dependency - Moped now must be at least at
version 1.2.0.</li>
</ul>

<h2>3.0.16</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2661 Implement instance level <code>model_name</code> for documents.</p></li>
<li><p>#2651 Ensure <code>Criteria#type</code> works properly with both symbol and string
keys in the selector.</p></li>
<li><p>#2647 Ensure <code>deleted?</code> and <code>destroyed?</code> on paranoid documents return the
same value.</p></li>
<li><p>#2646 <a href="Set.html" title="Set (class)"><code>Set</code></a> unloaded doc in memory on enumerable targets before yielding to
the block.</p></li>
<li><p>#2645 Take caching into consideration when asking for counts.
(Arthur Nogueira Neves)</p></li>
<li><p>#2642 Don&#39;t batch push empty arrays on embedded documents. (Laszlo Bacsi)</p></li>
<li><p>#2639 Avoid extra unnecesary queries on new records when building relations
off of them.</p></li>
<li><p>#2638 When a criteria is eager loading, calling <code>first</code> or <code>last</code> then
iterating the entire results properly eager loads the full request.</p></li>
<li><p>#2618 Validating uniqueness now always uses string consistency by default.</p></li>
<li><p>#2564 Fixed infinite recursion for cases where a relation getter was
overridden and called the setter from that method.</p></li>
<li><p>#2554 Ensure <code>unscoped</code> on an <code>embeds_many</code> does not include documents
flagged for destruction.</p></li>
</ul>

<h2>3.0.15</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2630 Fix cascading when the metadata exists but no cascade defined.</p></li>
<li><p>#2625 Fix <code>Marshal.dump</code> and <code>Marshal.load</code> of proxies and criteria
objects.</p></li>
<li><p>#2619 Fixed the classes returned by <code>observed_classes</code> on an observer
when it is observing custom models.</p></li>
<li><p>#2612 <code>DocumentNotFound</code> errors now expose the class in the error
instance.</p></li>
<li><p>#2610 Ensure calling <code>first</code> after a <code>last</code> that had sorting options resets
the sort.</p></li>
<li><p>#2604 Check pulls and pushes for conflicting updates. (Lucas Souza)</p></li>
<li><p>#2600 Instantiate the proper class type for attributes when using
multi parameter attributes. (xxswingxx)</p></li>
<li><p>#2598 Fixed sorting on localized fields with embedded docs.</p></li>
<li><p>#2588 Block defining methods for dynamic attributes that would be invalid
ruby methods. (Matt Sanford)</p></li>
<li><p>#2587 Fix method clash with <code>belongs_to</code> proxies when resetting relation
unloaded criteria.</p></li>
<li><p>#2585 Ensure session configuration options get passed to Moped as symbols.</p></li>
<li><p>#2584 Allow map/reduce to operate on secondaries if output is set to <code>inline</code>.</p></li>
<li><p>#2582 Ensure <code>nil</code> session override can never cause to access a session with
name <code>nil</code>.</p></li>
<li><p>#2581 Use strong consistency when reloading documents. (Mark Kremer)</p></li>
</ul>

<h2>3.0.14</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2575 Prevent end of month times from rounding up since floats are not
precise enough to handle usec. (Steve Valaitis)</p></li>
<li><p>#2573 Don&#39;t use i18n for inspection messages.</p></li>
<li><p>#2571 Remove blank error message from locales. (Jordan Elver)</p></li>
<li><p>#2568 Fix uniqueness validation for localized fields when a scope is also
provided.</p></li>
<li><p>#2552 Ensure <code>InvalidPath</code> errors are raised when embedded documents try to
get paths from a root selector.</p></li>
</ul>

<h2>3.0.13</h2>

<h3>Resolved Issues</h3>

<ul>
<li>#2548 Fix error when generating config file with a fresh app with Unicorn in
the gemset.</li>
</ul>

<h2>3.0.12</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2542 Allow embedded documents using <code>store_as</code> to properly alias in
criteria.</p></li>
<li><p>#2541 Ensure that the type change is correct when upcasting/downcasting a
document via <code>Document#becomes</code> (Łukasz Bandzarewicz)</p></li>
<li><p>#2529 Fields on subclasses that override fields in the parent where both have
defaults with procs now properly override the default in the subclass.</p></li>
<li><p>#2528 Aliased fields need to be duped when subclassing.</p></li>
<li><p>#2527 Ensure removal of docs in a <code>has_many</code> does a multi update when setting
to an empty array.</p></li>
</ul>

<h2>3.0.11</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2522 Fixed <code>Criteria#with</code> to return the criteria and not the class.</p></li>
<li><p>#2518 Fix unit of work call for the identity map when using Passenger.</p></li>
<li><p>#2512 Ensure nested attributes destroy works with the delayed destroys
introduced in 3.0.10 when multiple levels deep.</p></li>
<li><p>#2509 Don&#39;t hit identity map an extra time when the returned value is an
empty hash. (Douwe Maan)</p></li>
</ul>

<h2>3.0.10</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2507 Ensure no extra db hits when eager loading has a mix of parents
with and without docs. (Douwe Maan)</p></li>
<li><p>#2505 Ensure <code>update</code> and <code>update_all</code> from criteria properly handle
aliased fields. (Dmitry Krasnoukhov)</p></li>
<li><p>#2504 <code>Model#becomes</code> properly keeps the same id.</p></li>
<li><p>#2498 Criteria now properly pass provided blocks though <code>method_missing</code>.</p></li>
<li><p>#2496 Embedded documents that were previously stored without ids now
properly update and get assigned ids from within Mongoid.</p></li>
<li><p>#2494 All explicit atomic operations now properly respect aliased fields.</p></li>
<li><p>#2493 Use <code>Class#name</code> instead of <code>Class#model_name</code> when setting
polymorphic types in case <code>model_name</code> has been overridden.</p></li>
<li><p>#2491 Removed unnecessary merge call in cascadable children.</p></li>
<li><p>#2485 Removing indexes now always uses strong consistency.</p></li>
<li><p>#2483 Versioning now handles localized fields. (Lawrence Curtis)</p></li>
<li><p>#2482 Store find parameters in the <code>DocumentNotFound</code> error.</p></li>
<li><p>#2481 Map/reduce aggregations now properly handle Mongo&#39;s batching of
reduce jobs in groups of 100 with the state being passed through on the
count.</p></li>
<li><p>#2476 Handle skip and limit outside of range on embeds_many relations
gracefully.</p></li>
<li><p>#2474 Correctly detach 1-1 relations when the child is not yet loaded.
(Kostyantyn Stepanyuk)</p></li>
<li><p>#2451 <code>relation.deleted</code> on embedded paranoid documents now works properly
again.</p></li>
<li><p>#2472 Ensure <code>update_all</code> on embedded relations works properly when nothing
is actually going to be updated.</p></li>
<li><p>#2469 Nullified documents on relations are now able to be re-added with the
same in memory instance.</p></li>
<li><p>#2454 <code>Model#as_document</code> properly allows changes from having a relation to
the relation being removed. (James Almond)</p></li>
<li><p>#2445 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> middleware now properly supports both normal and streamed
responses and properly clears the identity map for either.</p></li>
<li><p>#2367 Embedded documents that are to be deleted via nested attributes no
longer become immediately removed from the relation in case the parent
validation fails. Instead, they get flagged for destruction and then the
removal occurs upon the parent passing validation and going to persist.</p></li>
</ul>

<p>Note this is a behavior change, but since the API does not change and
  the previous behavior was incorrect and did not match AR this was able
  to go into a point release.</p>

<h2>3.0.9</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2463 Fixed the broken <code>rails g mongoid:config</code> from a fresh repo.</p></li>
<li><p>#2456 The descendants cache is now reset when the document is inherited
again. (Kostyantyn Stepanyuk)</p></li>
<li><p>#2453 <code>Model#write_attribute</code> now properly works with aliased fields.
(Campbell Allen)</p></li>
<li><p>#2444 Removed extra dirty methods creation call. (Kostyantyn Stepanyuk)</p></li>
<li><p>#2440/#2435 Pass mass assignment options down to children when setting via
nested attributes or embedded documents.</p></li>
<li><p>#2439 Fixed memory leak in threaded selection of returned fields.
(Tim Olsen)</p></li>
<li><p>mongoid/moped#82 Aliased fields now work with <code>Criteria#distinct</code>.</p></li>
<li><p>#2423 Fixed embedded document&#39;s <code>update_all</code> to perform the correct $set
when using off a criteria.</p></li>
<li><p>#2414 Index definitions now respect aliased fields.</p></li>
<li><p>#2413 Enumerable targets now properly return enumerators when no blocks
are provided. (Andrew Smith)</p></li>
<li><p>#2411 BigDecimal fields are properly stored as strings when mongoizing
integers and floats.</p></li>
<li><p>#2409 Don&#39;t warn about missing mongoid.yml if configured programmatically.</p></li>
<li><p>#2403 Return false on <code>update_all</code> of an embeds many with no documents.</p></li>
<li><p>#2401 Bring back the ability to merge a criteria with a hash.</p></li>
<li><p>#2399 Reject blank id values on has_many <code>Model#object_ids=</code>.
(Tiago Rafael Godinho)</p></li>
<li><p>#2393 Ensure <code>inverse_of</code> is respected when using polymorphic relations.</p></li>
<li><p>#2388 Map/reduce properly uses <code>sort</code> instead of <code>orderby</code> in the execution
of the command. (Alex Tsibulya)</p></li>
<li><p>#2386 Allow geo haystack and bits parameters in indexes. (Bradley Rees)</p></li>
<li><p>#2380 <code>Model#becomes</code> now properly copies over dirty attributes.</p></li>
<li><p>#2331 Don&#39;t double push child documents when extra saves are called in an
after_create callback.</p></li>
</ul>

<h2>3.0.8 (Yanked)</h2>

<h2>3.0.6</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2375 Uniqueness validation scoping now works with aliased fields.</p></li>
<li><p>#2372 Ensure that all atomic operations mongoize values before executing.</p></li>
<li><p>#2370 Paranoid documents now properly don&#39;t get deleted when using
<code>dependent: :restrict</code> and an exception is raised.</p></li>
<li><p>#2365 Don&#39;t do anything when trying to replace an embeds_one with the same
document.</p></li>
<li><p>#2362 Don&#39;t store inverse of field values in the database when they are not
needed. (When there is not more than one polymorphic parent defined on the
same class).</p></li>
<li><p>#2360 Cloning documents should ignore mass assignment protection rules.</p></li>
<li><p>#2356 When limiting fields returned in queries via <code>only</code> ensure that the
limitation is scoped to the model.</p></li>
<li><p>#2353 Allow <code>update_attribute</code> to properly handle aliased fields.</p></li>
<li><p>#2348 Conversion of strings to times should raise an argument error if the
string is invalid. (Campbell Allen)</p></li>
<li><p>#2346 Ensure <code>belongs_to</code> relations are evolvable when passed the proxy and
not the document.</p></li>
<li><p>#2334 Fixed aggregation map/reduce when fields sometimes do not exist.
(James McKinney)</p></li>
<li><p>#2330 Fixed inconsistency of #size and #length on criteria when the documents
have been iterated over with a limit applied.</p></li>
<li><p>#2328 Ensure ordering is applied on all relation criteria if defined.</p></li>
<li><p>#2327 Don&#39;t execute callbacks from base document if the document cannot execute
them.</p></li>
<li><p>#2318 Ensure setting any numeric on a <a href="Float.html" title="Float (class)"><code>Float</code></a> field actually sets it as a float,
even if the number provided is an integer.</p></li>
</ul>

<h2>3.0.5</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2313 Fixed deserialization of <code>nil</code> <code>TimeWithZone</code> fields. (nagachika)</p></li>
<li><p>#2311 <code>Document#changes</code> no longer returns <code>nil</code> values for <a href="Array.html" title="Array (class)"><code>Array</code></a> and <a href="Hash.html" title="Hash (class)"><code>Hash</code></a>
fields that were only accessed and didn&#39;t actually change. Regression from 2.4.x.</p></li>
<li><p>#2310 Setting a many to many duplicate successively in memory no longer clears
the inverse foreign keys.</p></li>
<li><p>#2309 Allow embeds_one relations to be set with hashes more than just the
initial set.</p></li>
<li><p>#2308 Ensure documents retrieved via <code>#find</code> on <code>has_many</code> and
<code>has_and_belongs_to_many</code> relations are kept in memory.</p></li>
<li><p>#2304 Default scopes now properly merge instead of overwrite when more
than one is defined as per expectations with AR.  (Kirill Maksimov)</p></li>
<li><p>#2300 Ensure reloading refreshes the document in the identity map.</p></li>
<li><p>#2298 Protect against many to many relations pulling a null set of ids.
(Jonathan Hyman)</p></li>
<li><p>#2291 Fixed touch operations only to update the timestamp and the optional
field, no matter what the other changes on the document are.</p></li>
<li><p>#1091 Allow presence validation to pass if the value is <code>false</code>.</p></li>
</ul>

<h2>3.0.4</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2280 Fix synchronization of many-to-many relations when an ordering default
scope exists on either side of the association.</p></li>
<li><p>#2278 <code>Criteria#update</code> now properly updates only the first matching document,
where <code>Criteria#update_all</code> will update all matching documents. (no flag vs multi).</p></li>
<li><p>#2274 When loading models, warn if error is raised but continue processing.</p></li>
<li><p>#2272 Don&#39;t wipe selectors or options when removing the default scope for
actual nil values. Must check if key exists as well.</p></li>
<li><p>#2266 Restored paranoid documents are no longer flagged as destroyed.
(Mario Uher)</p></li>
<li><p>#2263 Ensure casting of non object id foreign keys on many to many relations
happens in the initial set, not at validation time.</p></li>
</ul>

<h2>3.0.3</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2259 Ensure subclassed documents can not be pulled from the identity map
via an id of another document in the same collection with a parent or
sibeling type.</p></li>
<li><p>#2254 $inc operations no longer convert all values to floats.</p></li>
<li><p>#2252 Don&#39;t fire autosave when before callbacks have terminated.</p></li>
<li><p>#2248 Improved the performance of <code>exists?</code> on criteria and relations.
(Jonathan Hyman)</p></li>
</ul>

<h2>3.0.2</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2244 Get rid of id mass assignment warnings in nested attributes.</p></li>
<li><p>#2242 Fix eager loading not to load all documents when calling first or
last.</p></li>
<li><p>#2241 Map/reduce operations now always use strong consistency since they
have the potential to write to collections, most of the time.</p></li>
<li><p>#2238 Ensure n-n foreign key fields are flagged as resizable to prevent
<code>nil</code> -&gt; <code>[]</code> changes when using <code>#only</code> and updating.</p></li>
<li><p>#2236 Keep the instance of the document in the validations exception
accessible via <code>document</code> or <code>record</code>.</p></li>
<li><p>#2234 Ensure validations when document is getting persisted with custom
options work properly with custom options, and do not clear them out if
validation passes.</p></li>
<li><p>#2224 <code>Model#inc</code> now accepts <code>BigDecimal</code> values.</p></li>
<li><p>#2216 Fixed assignment of metadata on embeds one relations when setting
multiple times in a row.</p></li>
<li><p>#2212 Ensure errors are cleared after a save with <code>validate: false</code> in all
situations.</p></li>
<li><p>#2207 When eager loading ids the query must be duped to avoid multiple
iteration problems not getting the required fields.</p></li>
<li><p>#2204 Raise an <code>InvalidIncludes</code> error when passing arguments to
<code>Criteria.includes</code> that are invalid (not relations, or more than 1 level.)</p></li>
<li><p>#2203 Map/Reduce now works properly in conjunction with <code>Model#with</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.
  <span class='id identifier rubyid_with'>with</span>(<span class='label'>session:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>secondary</span><span class='tstring_end'>&quot;</span></span>).
  <span class='id identifier rubyid_where'>where</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_likes'>likes</span>.<span class='id identifier rubyid_gt'>gt</span> <span class='op'>=&gt;</span> <span class='int'>100</span>).
  <span class='id identifier rubyid_map_reduce'>map_reduce</span>(<span class='id identifier rubyid_map'>map</span><span class='comma'>,</span> <span class='id identifier rubyid_reduce'>reduce</span>).
  <span class='id identifier rubyid_out'>out</span>(<span class='label'>inline:</span> <span class='int'>1</span>)</code></pre></li>
<li><p>#2199 Autosave false is now respected when automatically adding
presence validation. (John Nishinaga)</p></li>
</ul>

<h2>3.0.1</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2191 Ensure proper visibility (private) for error message generation
methods.</p></li>
<li><p>#2187 Ensure all levels of nested documents are serialized in json.</p></li>
<li><p>#2184 Allow names of relations that conflict with ruby core kernel
methods to pass existence checks.</p></li>
<li><p>#2181 Ensure <code>.first</code> criteria sort by ascending ids, if no other
sorting criteria was provided.</p></li>
</ul>

<h2>3.0.0</h2>

<h3>New Features</h3>

<ul>
<li><p>#2151 When asking for metadata before persistence, <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> will now
raise a <a href="Mongoid/Errors/NoMetadata.html" title="Mongoid::Errors::NoMetadata (class)"><code>::Mongoid::Errors::NoMetadata</code></a> error if the metadata is not
present.</p></li>
<li><p>#2147 <code>Model#becomes</code> now copies over the embedded documents.</p></li>
<li><p>A new callback has been introduced: <code>upsert</code>, which runs when calling
<code>document.upsert</code> since Mongoid does not know if the document is to be
treated as new or persisted. With this come the model callbacks:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_before_upsert'>before_upsert</span>
<span class='id identifier rubyid_after_upsert'>after_upsert</span>
<span class='id identifier rubyid_around_upsert'>around_upsert</span></code></pre></li>
<li><p>#2080/#2087 The database or session that <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> persists to can now be
overridden on a global level for cases where <code>Model#with</code> is not a viable
option.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_override_database'>override_database</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_secondary'>secondary</span>)
<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_override_session'>override_session</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_secondary'>secondary</span>)

<span class='const'>Band</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Placebo</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'>#=&gt; Persists to secondary.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span>.<span class='id identifier rubyid_create'>create</span> <span class='comment'>#=&gt; Persists to secondary.</span></code></pre>

<p>Note that this option is global and overrides for all models on the current
thread. It is the developer&#39;s responsibility to remember to set this back
to nil if you no longer want the override to happen.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_override_database'>override_database</span>(<span class='kw'>nil</span>)
<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_override_session'>override_session</span>(<span class='kw'>nil</span>)</code></pre></li>
<li><p>#1989 Criteria <code>count</code>, <code>size</code> and <code>length</code> now behave as Active Record
with regards to database access.</p>

<p><code>Criteria#count</code> will always hit the database to get the count.</p>

<p><code>Criteria#length</code> and <code>Criteria#size</code> will hit the database once if the
criteria has not been loaded, and subsequent calls will return the
cached value.</p>

<p>If the criteria has been iterated over or loaded, <code>length</code> and <code>size</code>
will never hit the db.</p></li>
<li><p>#1976 Eager loading no longer produces queries when the base query returns
zero results.</p></li>
<li><p><code>Model.find_by</code> now accepts a block and will yield to the found document if
it is not nil.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_band'>band</span><span class='op'>|</span>
  <span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_likes'>likes</span> <span class='op'>=</span> <span class='int'>100</span>
<span class='kw'>end</span></code></pre></li>
<li><p>#1958/#1798 Documents and <code>belongs_to</code> relations now support touch.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Updated.html" title="Mongoid::Timestamps::Updated (module)">Updated</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>Update the document&#39;s updated_at timestamp to the current time. This
will also update any touchable relation&#39;s timestamp as well.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_touch'>touch</span></code></pre>

<p>Update a specific time field along with the updated_at.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_touch'>touch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_founded'>founded</span>)</code></pre>

<p>This fires no validations or callbacks.</p></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now supports MongoDB&#39;s $findAndModify command.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_find_and_modify'>find_and_modify</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$inc</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='label'>likes:</span> <span class='int'>1</span> })

<span class='const'>Band</span>.<span class='id identifier rubyid_desc'>desc</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>).<span class='id identifier rubyid_only'>only</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>).<span class='id identifier rubyid_find_and_modify'>find_and_modify</span>(
  { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$inc</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='label'>likes:</span> <span class='int'>1</span> }}<span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span>
)</code></pre></li>
<li><p>#1906 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> will retrieve documents from the identity map when
providing multiple ids to find. (Hans Hasselberg)</p></li>
<li><p>#1903 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> raises an error if provided a javascript expression
to a where clause on an embedded collection. (Sebastien Azimi)</p></li>
<li><p>Aggregations now adhere to both a <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> API and their enumerable
counterparts where applicable.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_min'>min</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_likes'>likes</span>)
<span class='const'>Band</span>.<span class='id identifier rubyid_min'>min</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span><span class='op'>|</span>
  <span class='id identifier rubyid_a'>a</span>.<span class='id identifier rubyid_likes'>likes</span> <span class='op'>&lt;=&gt;</span> <span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_likes'>likes</span>
<span class='kw'>end</span>

<span class='const'>Band</span>.<span class='id identifier rubyid_max'>max</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_likes'>likes</span>)
<span class='const'>Band</span>.<span class='id identifier rubyid_max'>max</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span><span class='op'>|</span>
  <span class='id identifier rubyid_a'>a</span>.<span class='id identifier rubyid_likes'>likes</span> <span class='op'>&lt;=&gt;</span> <span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_likes'>likes</span>
<span class='kw'>end</span></code></pre>

<p>Note that when providing a field name and no block, a single numeric
value will be returned, but when providing a block, a document will
be returned which has the min/max value. This is since Ruby&#39;s
Enumerable API dictates when providing a block, the matching element
is returned.</p>

<p>When providing a block, all documents will be loaded into memory.
When providing a symbol, the execution is handled via map/reduce on
the server.</p></li>
<li><p>A kitchen sink aggregation method is now provided, to get everything in
in a single call for a field.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_aggregates'>aggregates</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_likes'>likes</span>)
<span class='comment'># =&gt;
</span><span class='comment'>#   {
</span><span class='comment'>#     &quot;count&quot; =&gt; 2.0,
</span><span class='comment'>#     &quot;max&quot; =&gt; 1000.0,
</span><span class='comment'>#     &quot;min&quot; =&gt; 500.0,
</span><span class='comment'>#     &quot;sum&quot; =&gt; 1500.0,
</span><span class='comment'>#     &quot;avg&quot; =&gt; 750.0
</span><span class='comment'>#   }</span></code></pre></li>
<li><p>A DSL off the criteria API is now provided for map/reduce operations
as a convenience.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_map_reduce'>map_reduce</span>(<span class='id identifier rubyid_map'>map</span><span class='comma'>,</span> <span class='id identifier rubyid_reduce'>reduce</span>).<span class='id identifier rubyid_out'>out</span>(<span class='label'>inline:</span> <span class='int'>1</span>)
<span class='const'>Band</span>.<span class='id identifier rubyid_map_reduce'>map_reduce</span>(<span class='id identifier rubyid_map'>map</span><span class='comma'>,</span> <span class='id identifier rubyid_reduce'>reduce</span>).<span class='id identifier rubyid_out'>out</span>(<span class='label'>replace:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>coll-name</span><span class='tstring_end'>&quot;</span></span>)
<span class='const'>Band</span>.<span class='id identifier rubyid_map_reduce'>map_reduce</span>(<span class='id identifier rubyid_map'>map</span><span class='comma'>,</span> <span class='id identifier rubyid_reduce'>reduce</span>).<span class='id identifier rubyid_out'>out</span>(<span class='label'>inline:</span> <span class='int'>1</span>).<span class='id identifier rubyid_finalize'>finalize</span>(<span class='id identifier rubyid_finalize'>finalize</span>)</code></pre></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now uses Origin for its Criteria API. See the Origin repo
and API docs for the documentation.</p></li>
<li><p>#1861 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now raises an <code>AmbiguousRelationship</code> error when it
cannot determine the inverse of a relation and there are multiple
potential candidates. (Hans Hasselberg)</p></li>
<li><p>You can now perform an explain directly from criteria.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_explain'>explain</span></code></pre></li>
<li><p>#1856 Push on one to many relations can now be chained.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span>.<span class='id identifier rubyid_push'>push</span>(<span class='id identifier rubyid_undertow'>undertow</span>).<span class='id identifier rubyid_push'>push</span>(<span class='id identifier rubyid_aenima'>aenima</span>)</code></pre></li>
<li><p>#1842 MultiParameterAttributes now supported aliased fields.
(Anton Orel)</p></li>
<li><p>#1833 If an embedded document is attempted to be saved with no
parent defined, Mongoid now will raise a <a href="Mongoid/Errors/NoParent.html" title="Mongoid::Errors::NoParent (class)"><code>::Mongoid::Errors::NoParent</code></a>
exception.</p></li>
<li><p>Added an ORM-agnostic way to get the field names</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span>

<span class='const'>Band</span>.<span class='id identifier rubyid_attribute_names'>attribute_names</span></code></pre></li>
<li><p>#1831 <code>find_or_create_by</code> on relations now takes mass assignment
and type options. (Tatsuya Ono)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span>.<span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span>({ <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>101</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> <span class='const'>LP</span>)</code></pre></li>
<li><p>#1818 Add capability to choose the key where your <code>embeds_many</code> relation
is stores. (Cyril Mougel)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_prefs'>prefs</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Preference</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>store_as:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my_preferences</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_prefs'>prefs</span>.<span class='id identifier rubyid_build'>build</span>(<span class='label'>value:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_save'>save</span>
<span class='comment'># document saves in MongoDB as:
</span><span class='comment'># { &quot;name&quot; =&gt; &quot;foo&quot;, &quot;my_preferences&quot; =&gt; [{ &quot;value&quot; =&gt; &quot;ok&quot; }]}</span></code></pre></li>
<li><p>#1806 <code>Model.find_or_create_by</code> and <code>Model.find_or_initialize_by</code> can now
take documents as parameters for belongs_to relations.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_first'>first</span>
<span class='const'>Game</span>.<span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span>(<span class='label'>person:</span> <span class='id identifier rubyid_person'>person</span>)</code></pre></li>
<li><p>#1774 Relations now have a <code>:restrict</code> option for dependent relations
which will raise an error when attempting to delete a parent that
still has children on it. (Hans Hasselberg)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_restrict'>restrict</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span> <span class='op'>&lt;&lt;</span> <span class='const'>Albums</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_delete'>delete</span> <span class='comment'># Raises DeleteRestriction error.</span></code></pre></li>
<li><p>#1764 Add method to check if field differs from the default value.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>New</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_name_changed_from_default?'>name_changed_from_default?</span></code></pre></li>
<li><p>#1759 Invalid fields error messages have been updated to show the
source and location of the original method. The new message is:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Problem</span><span class='op'>:</span>
  <span class='const'>Defining</span> <span class='id identifier rubyid_a'>a</span> <span class='id identifier rubyid_field'>field</span> <span class='id identifier rubyid_named'>named</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>crazy_method</span><span class='tstring_end'>&#39;</span></span> <span class='id identifier rubyid_is'>is</span> <span class='kw'>not</span> <span class='id identifier rubyid_allowed'>allowed</span>.
<span class='const'>Summary</span><span class='op'>:</span>
  <span class='const'>Defining</span> <span class='id identifier rubyid_this'>this</span> <span class='id identifier rubyid_field'>field</span> <span class='id identifier rubyid_would'>would</span> <span class='id identifier rubyid_override'>override</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_method'>method</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>crazy_method</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='id identifier rubyid_which'>which</span> <span class='id identifier rubyid_would'>would</span> <span class='id identifier rubyid_cause'>cause</span> <span class='id identifier rubyid_issues'>issues</span> <span class='id identifier rubyid_with'>with</span> <span class='id identifier rubyid_expectations'>expectations</span> <span class='id identifier rubyid_around'>around</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_original'>original</span>
  <span class='id identifier rubyid_method'>method</span> <span class='kw'>and</span> <span class='id identifier rubyid_cause'>cause</span> <span class='id identifier rubyid_extremely'>extremely</span> <span class='id identifier rubyid_hard'>hard</span> <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_issues'>issues</span>.
  <span class='const'>The</span> <span class='id identifier rubyid_original'>original</span> <span class='id identifier rubyid_method'>method</span> <span class='id identifier rubyid_was'>was</span> <span class='id identifier rubyid_defined'>defined</span> <span class='label'>in:</span>
    <span class='label'>Object:</span> <span class='const'>MyModule</span>
    <span class='const'>File</span><span class='op'>:</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>path</span><span class='regexp_end'>/to</span></span><span class='op'>/</span><span class='id identifier rubyid_my'>my</span><span class='op'>/</span><span class='kw'>module</span>.<span class='id identifier rubyid_rb'>rb</span>
    <span class='const'>Line</span><span class='op'>:</span> <span class='int'>8</span>
<span class='const'>Resolution</span><span class='op'>:</span>
  <span class='const'>Use</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_destructive_fields'>destructive_fields</span> <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_see'>see</span> <span class='id identifier rubyid_what'>what</span> <span class='id identifier rubyid_names'>names</span> <span class='id identifier rubyid_are'>are</span>
  <span class='kw'>not</span> <span class='id identifier rubyid_allowed'>allowed</span><span class='comma'>,</span> <span class='kw'>and</span> <span class='id identifier rubyid_don'>don</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>t use these names. These include names
  that also conflict with core Ruby methods on Object, Module,
  Enumerable, or included gems that inject methods into these
  or Mongoid internals.</span></code></pre></li>
<li><p>#1753/#1649 A setter and getter for has_many relations to set its
children is now provided. (Piotr Jakubowski)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Album</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_engineers'>engineers</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Engineer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_album'>album</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_album'>album</span> <span class='op'>=</span> <span class='const'>Album</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_engineer'>engineer</span> <span class='op'>=</span> <span class='const'>Engineer</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_album'>album</span>.<span class='id identifier rubyid_engineer_ids'>engineer_ids</span> <span class='op'>=</span> [ <span class='id identifier rubyid_engineer'>engineer</span>.<span class='id identifier rubyid_id'>id</span> ]
<span class='id identifier rubyid_album'>album</span>.<span class='id identifier rubyid_engineer_ids'>engineer_ids</span> <span class='comment'># Returns the ids of the engineers.</span></code></pre></li>
<li><p>#1741 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now provides a rake task to force remove indexes for
environments where Mongoid manages the index definitions and the
removal should be automated. (Hans Hasselberg)</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rake'>rake</span> <span class='label'>db:</span><span class='id identifier rubyid_force_remove_indexes'>force_remove_indexes</span>
<span class='id identifier rubyid_rake'>rake</span> <span class='label'>db:</span><span class='label'>mongoid:</span><span class='id identifier rubyid_force_remove_indexes'>force_remove_indexes</span></code></pre></li>
<li><p>#1726 <code>Mongoid.load!</code> now accepts an optional second argument for the
environment to load. This takes precedence over any environment variable
that is set if provided.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_load!'>load!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/path/to/mongoid.yml</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_development'>development</span>)</code></pre></li>
<li><p>#1724 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now supports regex fields.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Rule</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pattern'>pattern</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Regexp.html" title="Regexp (class)">Regexp</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[^abc]</span><span class='regexp_end'>/</span></span>
<span class='kw'>end</span></code></pre></li>
<li><p>#1714/#1706 Added better logging on index creation. (Hans Hasselberg)</p>

<p>When an index is present on a root document model:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Creating</span> <span class='id identifier rubyid_indexes'>indexes</span> <span class='label'>on:</span> <span class='const'>Model</span> <span class='label'>for:</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_dob'>dob</span>.</code></pre>

<p>When an index is defined on an embedded model:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Index</span> <span class='id identifier rubyid_ignored'>ignored</span> <span class='label'>on:</span> <span class='const'>Address</span><span class='comma'>,</span> <span class='id identifier rubyid_please'>please</span> <span class='id identifier rubyid_define'>define</span> <span class='kw'>in</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_root'>root</span> <span class='id identifier rubyid_model'>model</span>.</code></pre>

<p>When no index is defined, nothing is logged, and if a bad index is
defined an error is raised.</p></li>
<li><p>#1710 For cases when you don&#39;t want <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> to auto-protect the id
and type attributes, you can set a configuration option to turn this
off.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_protect_sensitive_fields'>protect_sensitive_fields</span> <span class='op'>=</span> <span class='kw'>false</span></code></pre></li>
<li><p>#1685 Belongs to relations now have build_ and create_ methods.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Comment</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_comment'>comment</span> <span class='op'>=</span> <span class='const'>Comment</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_comment'>comment</span>.<span class='id identifier rubyid_build_user'>build_user</span> <span class='comment'># Build a new user object
</span><span class='id identifier rubyid_comment'>comment</span>.<span class='id identifier rubyid_create_user'>create_user</span> <span class='comment'># Create a new user object</span></code></pre></li>
<li><p>#1684 Raise a <a href="Mongoid/Errors/InverseNotFound.html" title="Mongoid::Errors::InverseNotFound (class)"><code>::Mongoid::Errors::InverseNotFound</code></a> when attempting to
set a child on a relation without the proper inverse_of definitions
due to Mongoid not being able to determine it.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Car</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_one'>embeds_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_engine'>engine</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Motor</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Motor</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_machine'>machine</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Car</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_car'>car</span> <span class='op'>=</span> <span class='const'>Car</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_car'>car</span>.<span class='id identifier rubyid_engine'>engine</span> <span class='op'>=</span> <span class='const'>Motor</span>.<span class='id identifier rubyid_new'>new</span> <span class='comment'># raises an InverseNotFound error.</span></code></pre></li>
<li><p>#1680 Polymorphic relations now use <code>*_type</code> keys in lookup queries.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_commentable'>commentable</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Comment</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_commentable'>commentable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_id'>id</span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_comments'>comments</span> <span class='comment'># Uses user.id and type &quot;User&quot; in the query.</span></code></pre></li>
<li><p>#1677 Support for parent separable polymorphic relations to the same
parent class is now available. This only works if set from the parent
side in order to know which relation the children belong to.
(Douwe Maan)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Face</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_left_eye'>left_eye</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Eye</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_visible'>visible</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_right_eye'>right_eye</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Eye</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_visible'>visible</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Eye</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_visible'>visible</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_face'>face</span> <span class='op'>=</span> <span class='const'>Face</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_right_eye'>right_eye</span> <span class='op'>=</span> <span class='const'>Eye</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_left_eye'>left_eye</span> <span class='op'>=</span> <span class='const'>Eye</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_face'>face</span>.<span class='id identifier rubyid_right_eye'>right_eye</span> <span class='op'>=</span> <span class='id identifier rubyid_right_eye'>right_eye</span>
<span class='id identifier rubyid_face'>face</span>.<span class='id identifier rubyid_left_eye'>left_eye</span> <span class='op'>=</span> <span class='id identifier rubyid_left_eye'>left_eye</span>
<span class='id identifier rubyid_right_eye'>right_eye</span>.<span class='id identifier rubyid_visible'>visible</span> <span class='op'>=</span> <span class='id identifier rubyid_face'>face</span> <span class='comment'># Will raise an error.</span></code></pre></li>
<li><p>#1650 Objects that respond to <code>to_criteria</code> can now be merged into
existing criteria objects.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Filter</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_to_criteria'>to_criteria</span>
    <span class='comment'># return a Criteria object.
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_criteria'>criteria</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Sir</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_criteria'>criteria</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_filter'>filter</span>)</code></pre></li>
<li><p>#1635 All exceptions now provide more comprehensive errors, including
the problem that occurred, a detail summary of why it happened, and
potential resolutions. Example:</p>

<pre class="code ruby"><code class="ruby">(<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Errors.html" title="Mongoid::Errors (module)">Errors</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Errors/DocumentNotFound.html" title="Mongoid::Errors::DocumentNotFound (class)">DocumentNotFound</a></span>)
<span class='const'>Problem</span><span class='op'>:</span>
  <span class='const'>Document</span> <span class='kw'>not</span> <span class='id identifier rubyid_found'>found</span> <span class='kw'>for</span> <span class='kw'>class</span> <span class='const'>Town</span> <span class='id identifier rubyid_with'>with</span>
  <span class='id identifier rubyid_id'>id</span>(<span class='id identifier rubyid_s'>s</span>) [<span class='const'><a href="BSON.html" title="BSON (module)">BSON</a></span><span class='op'>::</span><span class='const'><a href="BSON/ObjectId.html" title="BSON::ObjectId (class)">ObjectId</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>4f35781b8ad54812e1000001</span><span class='tstring_end'>&#39;</span></span>)].
<span class='const'>Summary</span><span class='op'>:</span>
  <span class='const'>When</span> <span class='id identifier rubyid_calling'>calling</span> <span class='const'>Town</span>.<span class='id identifier rubyid_find'>find</span> <span class='id identifier rubyid_with'>with</span> <span class='id identifier rubyid_an'>an</span> <span class='id identifier rubyid_id'>id</span> <span class='kw'>or</span> <span class='id identifier rubyid_array'>array</span> <span class='id identifier rubyid_of'>of</span> <span class='id identifier rubyid_ids'>ids</span><span class='comma'>,</span>
  <span class='id identifier rubyid_each'>each</span> <span class='id identifier rubyid_parameter'>parameter</span> <span class='id identifier rubyid_must'>must</span> <span class='id identifier rubyid_match'>match</span> <span class='id identifier rubyid_a'>a</span> <span class='id identifier rubyid_document'>document</span> <span class='kw'>in</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_database'>database</span>
<span class='kw'>  or</span> <span class='id identifier rubyid_this'>this</span> <span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_will'>will</span> <span class='id identifier rubyid_be'>be</span> <span class='id identifier rubyid_raised'>raised</span>.
<span class='const'>Resolution</span><span class='op'>:</span>
  <span class='const'>Search</span> <span class='kw'>for</span> <span class='id identifier rubyid_an'>an</span> <span class='id identifier rubyid_id'>id</span> <span class='id identifier rubyid_that'>that</span> <span class='id identifier rubyid_is'>is</span> <span class='kw'>in</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_database'>database</span> <span class='kw'>or</span> <span class='id identifier rubyid_set'>set</span> <span class='id identifier rubyid_the'>the</span>
  <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_raise_not_found_error'>raise_not_found_error</span> <span class='id identifier rubyid_configuration'>configuration</span> <span class='id identifier rubyid_option'>option</span> <span class='id identifier rubyid_to'>to</span>
  <span class='kw'>false</span><span class='comma'>,</span> <span class='id identifier rubyid_which'>which</span> <span class='id identifier rubyid_will'>will</span> <span class='id identifier rubyid_cause'>cause</span> <span class='id identifier rubyid_a'>a</span> <span class='kw'>nil</span> <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_be'>be</span> <span class='id identifier rubyid_returned'>returned</span> <span class='id identifier rubyid_instead'>instead</span>
  <span class='id identifier rubyid_of'>of</span> <span class='id identifier rubyid_raising'>raising</span> <span class='id identifier rubyid_this'>this</span> <span class='id identifier rubyid_error'>error</span>.</code></pre></li>
<li><p>#1616 <code>Model.find_by</code> added which takes a hash of arguments to search
for in the database. If no single document is returned a DocumentNotFound
error is raised. (Piotr Jakubowski)</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>)</code></pre></li>
<li><p>#1606 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now enables autosave, like Active Record, when adding
an accepts_nested_attributes_for to a relation.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'>accepts_nested_attributes_for</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span> <span class='comment'># This enables the autosave.
</span><span class='kw'>end</span></code></pre></li>
<li><p>#1477 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now automatically protects the id and type attributes
from mass assignment. You can override this (not recommended) by redefining
them as accessible.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_attr_accessible'>attr_accessible</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid__type'>_type</span>
<span class='kw'>end</span></code></pre></li>
<li><p>#1459 The identity map can be disabled now for specific code execution
by passing options to the unit of work.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_unit_of_work'>unit_of_work</span>(<span class='label'>disable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_all'>all</span>) <span class='kw'>do</span>
  <span class='comment'># Disables the identity map on all threads for the block.
</span><span class='kw'>end</span>

<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_unit_of_work'>unit_of_work</span>(<span class='label'>disable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_current'>current</span>) <span class='kw'>do</span>
  <span class='comment'># Disables the identity map on the current thread for the block.
</span><span class='kw'>end</span>

<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_unit_of_work'>unit_of_work</span> <span class='kw'>do</span>
  <span class='comment'># Business as usual.
</span><span class='kw'>end</span></code></pre></li>
<li><p>#1355 Associations now can have safety options provided to them on single
document persistence operations.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>safe:</span> <span class='kw'>true</span>).<span class='id identifier rubyid_push'>push</span>(<span class='id identifier rubyid_album'>album</span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>safe:</span> <span class='kw'>true</span>).<span class='id identifier rubyid_create'>create</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Smiths</span><span class='tstring_end'>&quot;</span></span>)

<span class='id identifier rubyid_album'>album</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>safe:</span> <span class='kw'>true</span>).<span class='id identifier rubyid_create_producer'>create_producer</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Flood</span><span class='tstring_end'>&quot;</span></span>)</code></pre></li>
<li><p>#1348 Eager loading is now supported on many-to-many relations.</p></li>
<li><p>#1292 Remove attribute now unsets the attribute when the document is
saved instead of setting to nil.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_id'>id</span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_remove_attribute'>remove_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span>) <span class='comment'># Uses $unset when the document is saved.</span></code></pre></li>
<li><p>#1291 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> database sessions are now connected to lazily, and are
completely thread safe. If a new thread is created, then a new database
session will be created for it.</p></li>
<li><p>#1291 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now supports any number of database connections as defined in
the mongoid.yml. For example you could have a local single server db, a
multi availability zone replica set, and a shard cluster all in the same
application environment. Mongoid can connect to any session at any point in
time.</p></li>
<li><p>#1291 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now allows you to persist to whatever database or collection
you like at runtime, on a per-query or persistence operation basis by using
<code>with</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>collection:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>artists</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_create'>create</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>secondary).save!
Band.with(collection: </span><span class='tstring_end'>&quot;</span></span><span class='id identifier rubyid_artists'>artists</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>).where(name: </span><span class='tstring_end'>&quot;</span></span><span class='const'>Depeche</span> <span class='const'>Mode</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>)</span></code></pre></li>
<li><p>#1291 You can now configure on a per-model basis where its documents are
stored with the new and improved <code>store_in</code> macro.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_store_in'>store_in</span> <span class='label'>collection:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>artists</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>secondary</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>session:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>replica</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<p>This can be overridden, of course, at runtime via the <code>with</code> method.</p></li>
<li><p>#1212 Embedded documents can now be popped off a relation with persistence.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span>.<span class='id identifier rubyid_pop'>pop</span> <span class='comment'># Pop 1 document and persist the removal.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums'>albums</span>.<span class='id identifier rubyid_pop'>pop</span>(<span class='int'>3</span>) <span class='comment'># Pop 3 documents and persist the removal.</span></code></pre></li>
<li><p>#1188 Relations now have existence predicates for simplified checking if the
relation is blank or not. (Andy Morris)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_albums'>albums</span>
  <span class='id identifier rubyid_embeds_one'>embeds_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_albums?'>albums?</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_has_albums?'>has_albums?</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_label?'>label?</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_has_label?'>has_label?</span></code></pre></li>
<li><p>#1188 1-1 relations now have an <code>:autobuild</code> option to indicate if the
relation should automatically be build with empty attributes upon access
where the relation currently does not exist. Works on embeds_one,
embedded_in, has_one, belongs_to. (Andy Morris)</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span><span class='comma'>,</span> <span class='label'>autobuild:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_label'>label</span> <span class='comment'># Returns a new label with empty attributes.</span></code></pre>

<p>When using existence checks, autobuilding will not execute.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_label?'>label?</span> <span class='comment'># Returns false, does not autobuild on a check.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_has_label?'>has_label?</span> <span class='comment'># Returns false, does not autobuild on a check.</span></code></pre></li>
<li><p>#1081 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> indexes both id and type as a compound index when providing
<code>index: true</code> to a polymorphic belongs_to.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Comment</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='comment'># Indexes commentable_id and commentable_type as a compound index.
</span>  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_commentable'>commentable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre></li>
<li><p>#1053 Raise a <a href="Mongoid/Errors/UnknownAttribute.html" title="Mongoid::Errors::UnknownAttribute (class)"><code>::Mongoid::Errors::UnknownAttribute</code></a> instead of no method
when attempting to set a field that is not defined and allow dynamic
fields is false. (Cyril Mougel)</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_allow_dynamic_fields'>allow_dynamic_fields</span> <span class='op'>=</span> <span class='kw'>false</span>

<span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span>

<span class='const'>Person</span>.<span class='id identifier rubyid_new'>new</span>.<span class='id identifier rubyid_age'>age</span> <span class='op'>=</span> <span class='int'>50</span> <span class='comment'># raises the UnknownAttribute error.</span></code></pre></li>
<li><p>#772 Fields can now be flagged as readonly, which will only let their
values be set when the document is new.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_genre'>genre</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>

  <span class='id identifier rubyid_attr_readonly'>attr_readonly</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_genre'>genre</span>
<span class='kw'>end</span></code></pre>

<p>Readonly values are ignored when attempting to set them on persisted
  documents, with the exception of update_attribute and remove_attribute,
  where errors will get raised.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_update_attribute'>update_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Smiths</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># Raises ReadonlyAttribute error.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_remove_attribute'>remove_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>) <span class='comment'># Raises ReadonlyAttribute error.</span></code></pre></li>
</ul>

<h3>Major Changes (Backwards Incompatible)</h3>

<ul>
<li>Polymorphic relations can not have ids other than object ids. This is
because Mongoid cannot properly figure out in an optimized way what the
various classes on the other side of the relation store their ids as, as
they could potentially all be different.</li>
</ul>

<p>This was not allowed before, but nowhere was it explicitly stated.</p>

<ul>
<li><p>#2039 Validating presence of a relation now checks both the relation and
the foreign key value.</p></li>
<li><p>Indexing syntax has changed. The first parameter is now a hash of
name/direction pairs with an optional second hash parameter for
additional options.</p>

<p>Normal indexing with options, directions are either 1 or -1:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>

  <span class='id identifier rubyid_index'>index</span>({ <span class='label'>name:</span> <span class='int'>1</span> }<span class='comma'>,</span> { <span class='label'>unique:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>background:</span> <span class='kw'>true</span> })
<span class='kw'>end</span></code></pre>

<p>Geospacial indexing needs &quot;2d&quot; as its direction.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Venue</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_location'>location</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Array.html" title="Array (class)">Array</a></span>

  <span class='id identifier rubyid_index'>index</span> <span class='label'>location:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>2d</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre></li>
<li><p>Custom serializable fields have revamped. Your object no longer should
include <code>Mongoid::Fields::Serializable</code> - instead it only needs to
implement 3 methods: <code>#mongoize</code>, <code>.demongoize</code> and <code>.evolve</code>.</p>

<p><code>#mongoize</code> is an instance method that transforms your object into
  a mongo-friendly value.</p>

<p><code>.demongoize</code> is a class method, that can take some data from mongo
  and instantiate and object of your custom type.</p>

<p><code>.evolve</code> is a class method, that can take any object, and
  transform it for use in a <a href="Mongoid/Criteria.html" title="Mongoid::Criteria (class)"><code>::Mongoid::Criteria</code></a>.</p>

<p>An example of an implementation of this for <code>Range</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Range</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_mongoize'>mongoize</span>
    { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>min</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_first'>first</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>max</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_last'>last</span> }
  <span class='kw'>end</span>

  <span class='kw'>class</span> <span class='op'>&lt;&lt;</span> <span class='kw'>self</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_demongoize'>demongoize</span>(<span class='id identifier rubyid_object'>object</span>)
      <span class='const'>Range</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_object'>object</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>min</span><span class='tstring_end'>&quot;</span></span>]<span class='comma'>,</span> <span class='id identifier rubyid_object'>object</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>max</span><span class='tstring_end'>&quot;</span></span>])
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_evolve'>evolve</span>(<span class='id identifier rubyid_object'>object</span>)
      { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$gte</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_object'>object</span>.<span class='id identifier rubyid_first'>first</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$lte</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_object'>object</span>.<span class='id identifier rubyid_last'>last</span> }
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre></li>
<li><p><code>Document#changes</code> is no longer a hash with indifferent access.</p></li>
<li><p><code>after_initialize</code> callbacks no longer cascade to children if the option
is set.</p></li>
<li><p>#1865 <code>count</code> on the memory and mongo contexts now behave exactly the
same as Ruby&#39;s <code>count</code> on enumerable, and can take an object or a block.
This is optimized on the mongo context not to load everything in memory
with the exception of passing a block.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_count'>count</span>
<span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_count'>count</span>(<span class='id identifier rubyid_tool'>tool</span>) <span class='comment'># redundant.
</span><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_doc'>doc</span><span class='op'>|</span>
  <span class='id identifier rubyid_doc'>doc</span>.<span class='id identifier rubyid_likes'>likes</span> <span class='op'>&gt;</span> <span class='int'>0</span>
<span class='kw'>end</span></code></pre>

<p>Note that although the signatures are the same for both the memory and
mongo contexts, it&#39;s recommended you only use the block syntax for the
memory context since the embedded documents are already loaded into
memory.</p>

<p>Also note that passing a boolean to take skip and limit into account
is no longer supported, as this is not necessarily a useful feature.</p></li>
<li><p>The <code>autocreate_indexes</code> configuration option has been removed.</p></li>
<li><p><code>Model.defaults</code> no longer exists. You may get all defaults with a
combination of <code>Model.pre_processed_defaults</code> and
<code>Model.post_processed_defaults</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_pre_processed_defaults'>pre_processed_defaults</span>
<span class='const'>Band</span>.<span class='id identifier rubyid_post_processed_defaults'>post_processed_defaults</span></code></pre></li>
<li><p><code>Model.identity</code> and <code>Model.key</code> have been removed. For custom ids,
users must now override the _id field.</p>

<p>When the default value is a proc, the default is applied <em>after</em> all
other attributes are set.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tlambda'>-&gt;</span><span class='tlambeg'>{</span> <span class='id identifier rubyid_name'>name</span> }
<span class='kw'>end</span></code></pre>

<p>To have the default applied <em>before</em> other attributes, set <code>:pre_processed</code>
to true.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span>
    <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span>
    <span class='label'>pre_processed:</span> <span class='kw'>true</span><span class='comma'>,</span>
    <span class='label'>default:</span> <span class='tlambda'>-&gt;</span><span class='tlambeg'>{</span> <span class='const'><a href="BSON.html" title="BSON (module)">BSON</a></span><span class='op'>::</span><span class='const'><a href="BSON/ObjectId.html" title="BSON::ObjectId (class)">ObjectId</a></span>.<span class='id identifier rubyid_new'>new</span>.<span class='id identifier rubyid_to_s'>to_s</span> }
<span class='kw'>end</span></code></pre></li>
<li><p>Custom application exceptions in various languages has been removed,
along with the <code>Mongoid.add_language</code> feature.</p></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> no longer supports 1.8. MRI 1.9.3 and higher, or JRuby 1.6 and
higher in 1.9 mode are only supported.</p></li>
<li><p>#1734 When searching for documents via <code>Model.find</code> with multiple ids,
Mongoid will raise an error if not <em>all</em> ids are found, and tell you
what the missing ones were. Previously the error only got raised if
nothing was returned.</p></li>
<li><p>#1675 Adding presence validation on a relation now enables autosave.
This is to ensure that when a new parent object is saved with a new
child and marked is valid, both are persisted to ensure a correct
state in the database.</p></li>
<li><p>#1491 Ensure empty translations returns an empty hash on access.</p></li>
<li><p>#1484 <code>Model#has_attribute?</code> now behaves the same as Active Record.</p></li>
<li><p>#1471 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> no longer strips any level of precision off of times.</p></li>
<li><p>#1475 Active support&#39;s time zone is now used by default in time
serialization if it is defined.</p></li>
<li><p>#1342 <code>Model.find</code> and <code>model.relation.find</code> now only take a single or
multiple ids. The first/last/all with a conditions hash has been removed.</p></li>
<li><p>#1291 The mongoid.yml has been revamped completely, and upgrading
existing applications will greet you with some lovely Mongoid specific
configuration errors. You can re-generate a new mongoid.yml via the
existing rake task, which is commented to an insane degree to help you
with all the configuration possibilities.</p></li>
<li><p>#1291 The <code>persist_in_safe_mode</code> configuration option has been removed.
You must now tell a database session in the mongoid.yml whether or not
it should persist in safe mode by default.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_production'>production</span><span class='op'>:</span>
  <span class='id identifier rubyid_sessions'>sessions</span><span class='op'>:</span>
    <span class='id identifier rubyid_default'>default</span><span class='op'>:</span>
      <span class='id identifier rubyid_database'>database</span><span class='op'>:</span> <span class='id identifier rubyid_my_app_prod'>my_app_prod</span>
      <span class='id identifier rubyid_hosts'>hosts</span><span class='op'>:</span>
        <span class='op'>-</span> <span class='id identifier rubyid_db'>db</span>.<span class='id identifier rubyid_app'>app</span>.<span class='id identifier rubyid_com'>com</span><span class='symbeg'>:</span><span class='int'>27018</span>
        <span class='op'>-</span> <span class='id identifier rubyid_db'>db</span>.<span class='id identifier rubyid_app'>app</span>.<span class='id identifier rubyid_com'>com</span><span class='symbeg'>:</span><span class='int'>27019</span>
      <span class='id identifier rubyid_options'>options</span><span class='op'>:</span>
        <span class='id identifier rubyid_consistency'>consistency</span><span class='op'>:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_eventual'>eventual</span>
        <span class='id identifier rubyid_safe'>safe</span><span class='op'>:</span> <span class='kw'>true</span></code></pre></li>
<li><p>#1291 <code>safely</code> and <code>unsafely</code> have been removed. Please now use <code>with</code>
to provide safe mode options at runtime.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>safe:</span> <span class='kw'>true</span>).<span class='id identifier rubyid_create'>create</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>safe:</span> { <span class='label'>w:</span> <span class='int'>3</span> }).<span class='id identifier rubyid_save!'>save!</span>
<span class='const'>Band</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>safe:</span> <span class='kw'>false</span>).<span class='id identifier rubyid_create!'>create!</span></code></pre></li>
<li><p>#1270 Relation macros have been changed to match their AR counterparts:
only :has_one, :has_many, :has_and_belongs_to_many, and :belongs_to
exist now.</p></li>
<li><p>#1268 <code>Model#new?</code> has been removed, developers must now always use
<code>Model#new_record?</code>.</p></li>
<li><p>#1182 A reload is no longer required to refresh a relation after setting
the value of the foreign key field for it. Note this behaves exactly as
Active Record.</p>

<p>If the id is set, but the document for it has not been persisted, accessing
the relation will return empty results.</p>

<p>If the id is set and its document is persisted, accessing the relation
will return the document.</p>

<p>If the id is set, but the base document is not saved afterwards, then
reloading will return the document to its original state.</p></li>
<li><p>#1093 Field serialization strategies have changed on <a href="Array.html" title="Array (class)"><code>Array</code></a>, <a href="Hash.html" title="Hash (class)"><code>Hash</code></a>, <a href="Integer.html" title="Integer (class)"><code>Integer</code></a>
and Boolean to be more consistent and match AR where appropriate.</p>

<p>Serialization of arrays calls <code>Array.wrap(object)</code>
Serialization of hashes calls <code>Hash[object]</code> (to_hash on the object)
Serialization of integers always returns an int via <code>to_i</code>
Serialization of booleans defaults to false instead of nil.</p></li>
<li><p>#933 <code>:field.size</code> has been renamed to <code>:field.count</code> in criteria for
$size not to conflict with Symbol&#39;s size method.</p></li>
<li><p>#829/#797 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> scoping code has been completely rewritten, and now
matches the Active Record API. With this backwards incompatible change,
some methods have been removed or renamed.</p>

<p>Criteria#as_conditions and Criteria#fuse no longer exist.</p>

<p>Criteria#merge now only accepts another object that responds to
<code>to_criteria</code>.</p>

<p>Criteria#merge! now merges in another object without creating a new
criteria object.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_merge!'>merge!</span>(<span class='id identifier rubyid_criteria'>criteria</span>)</code></pre>

<p>Named scopes and default scopes no longer take hashes as parameters.
From now on only criteria and procs wrapping criteria will be
accepted, and an error will be raised if the arguments are incorrect.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_default_scope'>default_scope</span> <span class='tlambda'>-&gt;</span><span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>active:</span> <span class='kw'>true</span>) }
  <span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_inactive'>inactive</span><span class='comma'>,</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>active:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invalid'>invalid</span><span class='comma'>,</span> <span class='label'>where:</span> { <span class='label'>valid:</span> <span class='kw'>false</span> } <span class='comment'># This will raise an error.
</span><span class='kw'>end</span></code></pre>

<p>The &#39;named_scope&#39; macro has been removed, from now on only use &#39;scope&#39;.</p>

<p>Model.unscoped now accepts a block which will not allow default scoping
to be applied for any calls inside the block.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_unscoped'>unscoped</span> <span class='kw'>do</span>
  <span class='const'>Band</span>.<span class='id identifier rubyid_scoped'>scoped</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Ministry</span><span class='tstring_end'>&quot;</span></span>)
<span class='kw'>end</span></code></pre>

<p>Model.scoped now takes options that will be set directly on the criteria
options hash.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_scoped'>scoped</span>(<span class='label'>skip:</span> <span class='int'>10</span><span class='comma'>,</span> <span class='label'>limit:</span> <span class='int'>20</span>)</code></pre></li>
<li><p>#463 <code>Document#upsert</code> is no longer aliased to <code>Document#save</code> and now
actually performs a proper MongoDB upsert command when called. If you
were using this method before and want the same behavior, please switch
to <code>save</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_upsert'>upsert</span> <span class='comment'>#=&gt; Inserts the document in the database.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Placebo</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_upsert'>upsert</span> <span class='comment'>#=&gt; Updates the existing document.</span></code></pre></li>
</ul>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2166 <code>Criteria#from_map_or_db</code> strips type selection when eager loading
since it will check if the type is correct after.</p></li>
<li><p>#2129 Fixed sorting for all fields on embeds many relations.</p></li>
<li><p>#2124 Fixed default scope and deleted scope on paranoid documents.</p></li>
<li><p>#2122 Allow embedded documents to sort on boolean fields.</p></li>
<li><p>#2119 Allow <code>Criteria#update_all</code> to accept atomic ops and normal sets.</p></li>
<li><p>#2118 Don&#39;t strip any precision during <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> -&gt; <a href="Time.html" title="Time (class)"><code>Time</code></a> conversions.</p></li>
<li><p>#2117 Ensure embeds one relations have callbacks run when using nested
attributes.</p></li>
<li><p>#2110 <code>Model#touch</code> now works properly on embedded documents.</p></li>
<li><p>#2100 Allow atomic operations to properly execute on paranoid documents
that have a deleted_at set.</p></li>
<li><p>#2089 Allow proper separation of mongoization and evolving with respect to
foreign keys.</p></li>
<li><p>#2088 Allow finds by string ids to pull from the identity map if the ids
are stored as object ids.</p></li>
<li><p>#2085 Allow demongoization of floats and ints to big decimals.</p></li>
<li><p>#2084 Don&#39;t cascade if metadata does not exist.</p></li>
<li><p>#2078 Calling <code>Model#clone</code> or <code>Model#dup</code> now properly sets attributes
as dirty.</p></li>
<li><p>#2070 Allow for updated_at to be overridden manually for new documents that
also have a created_at.</p></li>
<li><p>#2041 Don&#39;t hit the database multiple times on relation access after an
eager load returned zero documents.</p></li>
<li><p>#1997 Cascading callbacks should be able to halt the callback chain when
terminating.</p></li>
<li><p>#1972 <code>added</code>, <code>loaded</code>, and <code>unloaded</code> can now be valid scope names on a
document that is part of a 1-n relation.</p></li>
<li><p>#1952/#1950 <code>#all_in</code> behavior on embedded documents now properly matches
root documents when passing an empty array. (Hans Hasselberg)</p></li>
<li><p>#1941/#1939 <code>Model.find_by</code> now returns nil if raise not found error is
set to false. (Hans Hasselberg)</p></li>
<li><p>#1859/#1860 <code>Model#remove_attribute</code> now properly unsets on embedded
documents. (Anton Onyshchenko)</p></li>
<li><p>#1852 Ensure no infinite recursion on cascading callbacks. (Ara Howard)</p></li>
<li><p>#1823 <code>Relation#includes?</code> now properly works with identity map enabled.</p></li>
<li><p>#1810 <code>Model#changed?</code> no longer returns true when hash and array fields
have only been accessed.</p></li>
<li><p>#1876/#1782 Allow dot notation in embeds many criteria queries.
(Cyril Mougel)</p></li>
<li><p>#1745 Fixed batch clear to work within attribute setting.</p></li>
<li><p>#1718 Ensure consistency of #first/#last in relations - they now always
match first/last in the database, but opts for in memory first.</p></li>
<li><p>#1692/#1376 <code>Model#updateattributes</code> and <code>Model#update_attributes!</code> now
accept assignment options. (Hans Hasselberg)</p></li>
<li><p>#1688/#1207 Don&#39;t require namespacing when providing class name on
relation macros inside the namespace. (Hans Hasselberg)</p></li>
<li><p>#1665/#1672 Expand complex criteria in nested criteria selectors, like
#matches. (Hans Hasselberg)</p></li>
<li><p>#1335 Don&#39;t add id sorting criteria to first/last is there is already
sorting options on the criteria.</p></li>
<li><p>#1321 Referenced many enumerable targets are now hash-backed, preventing
duplicates in a more efficient manner.</p></li>
<li><p>#1135 DateTimes now properly get time zones on deserialization.</p></li>
<li><p>#1031 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now serializes values in <a href="Array.html" title="Array (class)"><code>Array</code></a> fields to their proper
Mongo-friendly values when possible.</p></li>
<li><p>#685 Attempting to use versioning with embedded documents will now
raise a proper error alerting the developer this is not allowed.</p></li>
</ul>

<h2>2.6.0</h2>

<h3>New Features</h3>

<ul>
<li>#2709 Backported the <code>touch</code> functionality from <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 3.</li>
</ul>

<h2>2.5.2</h2>

<h3>Resolved Issues</h3>

<ul>
<li>#2502 Fixed cache key to properly handle when the document does not
include <a href="Mongoid/Timestamps/Updated.html" title="Mongoid::Timestamps::Updated (module)"><code>::Mongoid::Timestamps::Updated</code></a>. (Arthur Nogueira Neves)</li>
</ul>

<h2>2.5.1</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2492 Backport cascading callbacks performance and memory fixes from
3.0.0-stable.</p></li>
<li><p>#2464 Backport the nested attributes fix for keeping many relations in
memory when updating attributes. (Chris Thompson)</p></li>
</ul>

<h2>2.5.0</h2>

<h3>New Features</h3>

<ul>
<li>This is a release to support the 1.7.0 and higher Mongo and <a href="BSON.html" title="BSON (module)"><code>BSON</code></a> gems and
resolves issues that kept the 2.4.x series locked below 1.6.2</li>
</ul>

<h2>2.4.12</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2178 Ensure destroy callbacks are run post replacement of an embeds one
relation.</p></li>
<li><p>#2169 Allow saves to pass when documents are destroyed after the save
in a callback.</p></li>
<li><p>#2144 Uniqueness validation on paranoid documents now properly scopes.</p></li>
<li><p>#2127 Don&#39;t unbind parents of embedded documents mid nested
attributes deletion.</p></li>
</ul>

<h2>2.4.11</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>This release forces a cap on the mongo driver version at 1.6.2 due to
changes in the <code>Mongo::Connection.from_uri</code> API not allowing valid
connection options anymore.</p></li>
<li><p>#2040 Fixed bad interpolation for locale presence validation.</p></li>
<li><p>#2038 Allow inverse relations to be determined by foreign keys alone
if defined on both sides, not just an inverse_of declaration.</p></li>
<li><p>#2023 Allow serialization of dynamic types that conflict with core
Ruby methods to still be serialized.</p></li>
<li><p>#2008 Presence validation should hit the db to check validity if the
relation in memory is blank.</p></li>
<li><p>#2006 Allow excluding only the _id field post execution of an #only call.</p></li>
</ul>

<h2>2.4.10</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#2003 Don&#39;t fail on document generation when an embedded document was
stored as nil in the database.</p></li>
<li><p>#1997 Don&#39;t delete paranoid embedded docs via nested attributes when
a before_destroy callback returns false.</p></li>
<li><p>#1994 <code>dependent: :delete</code> only hits the database once now for one to
many and many to many relations instead of once for each document.</p></li>
<li><p>#1987 Don&#39;t double-insert documents into identity map when eager loading
twice inside the unit of work.</p></li>
<li><p>#1953 Uniqueness validation now works on localized fields.</p></li>
<li><p>#1936 Allow setting n levels deep embedded documents atomically without
conflicting mods when not using nested attributes or documents themselves
in an update call from the parent.</p></li>
<li><p>#1957/#1954 Ensure database name is set with inheritance.
(Hans Hasselberg)</p></li>
</ul>

<h2>2.4.9</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1943 Ensure numericality validation works for big decimals.</p></li>
<li><p>#1938 Length validation now works with localized fields.</p></li>
<li><p>#1936 Conflicting pushes with other pushes is now properly handled.</p></li>
<li><p>#1933 <code>Proxy#extend</code> should delegate through to the target, where
extending the proxy itself is now handled through <code>Proxy#proxy_extend</code>.</p></li>
<li><p>#1930 Ensure complex criteria are expanded in all where clauses.
(Hans Hasselberg)</p></li>
<li><p>#1928 Deletion of embedded documents via nested attributes now performs
a $pull with id match criteria instead of a $pullAll to cover all cases.
Previously newly added defaults to documents that had already persisted
could not be deleted in this matter since the doc did not match what was
in the database.</p></li>
<li><p>#1924/#1917 Fix pushing to embedded relations with default scopes not
scoping on the new document. (Hans Hasselberg)</p></li>
<li><p>#1922/#1919 Dropping collections unmemoizes the internally wrapped
collection, in order to ensure when defining capped collections that
they are always recreated as capped. (Hans Hasselberg)</p></li>
<li><p>#1916/#1913 Uniqueness validation no longer is affected by the default
scope. (Hans Hasselberg)</p></li>
<li><p>#1943 Ensure numericality validation works for big decimals.</p></li>
</ul>

<h2>2.4.8</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1892 When getting not master operation error, <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> should reconnect
before retrying the operation.</p></li>
<li><p>#1887 Don&#39;t cascade callbacks to children that don&#39;t have the callback
defined.</p></li>
<li><p>#1882 Don&#39;t expand duplicate id criterion into an $and with duplicate
selections.</p></li>
<li><p>#1878 Fixed default application values not to apply in certain <code>only</code>
or <code>without</code> selection on iteration, not just <code>first</code> and <code>last</code>.</p></li>
<li><p>#1874 Fixed the reject all blank proc constant to handle values
properly with a destroy non blank value. (Stefan Daschek)</p></li>
<li><p>#1869/#1868 Delayed atomic sets now uses the atomic path instead of
the metadata name to fix multiple level embedding issues.
(Chris Micacchi provided specs)</p></li>
<li><p>#1866 Post processed defaults (procs) should be applied post binding
of the child in a relation.build.</p></li>
</ul>

<h2>2.4.7</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>Ensure reloading of embedded documents retains reference to the parent.</p></li>
<li><p>#1837 Always pass symbol options to the driver.</p></li>
<li><p>#1836 Ensure relation counts pick up persisted document that have not
had the foreign key link persisted.</p></li>
<li><p>#1820 Destroying embedded documents in an embeds_many should also
removed the document from the underlying _unscoped target and reindex
the relation.</p></li>
<li><p>#1814 Don&#39;t cascade callbacks on after_initialize.</p></li>
<li><p>#1800 Invalid options for the Mongo connection are now filtered out.</p></li>
<li><p>#1785 Case equality has been fixed to handle instance checks properly.</p></li>
</ul>

<h2>2.4.6</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1772 Allow skip and limit to convert strings to integers. (Jean Boussier)</p></li>
<li><p>#1767 Model#update_attributes accepts mass assignment options again.
(Hans Hasselberg)</p></li>
<li><p>#1762 Criteria#any_of now properly handles localized fields.</p></li>
<li><p>#1758 Metadata now returns self on options for external library support.</p></li>
<li><p>#1757 Ensure serialization converts any attribute types to the type
defined by the field.</p></li>
<li><p>#1756 Serializable hash options should pass through to embedded docs.</p></li>
</ul>

<h2>2.4.5</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1751 Mongoid&#39;s logger now responds to level for Ruby logging API
compatibility.</p></li>
<li><p>#1744/#1750 Sorting works now for localized fields in embedded documents
using the criteria API. (Hans Hasselberg)</p></li>
<li><p>#1746 Presence validation now shows which locales were empty for
localized fields. (Cyril Mougel)</p></li>
<li><p>#1727 Allow dot notation in embedded criteria to work on both embeds one
and embeds many. (Lyle Underwood)</p></li>
<li><p>#1723 Initialize callbacks should cascade through children without needing
to determine if the child is changed.</p></li>
<li><p>#1715 Serializable hashes are now consistent on inclusion of embedded
documents per or post save.</p></li>
<li><p>#1713 Fixing === checks when comparing a class with an instance of a
subclass.</p></li>
<li><p>#1495 Callbacks no longer get the &#39;super called outside of method` errors on
busted 1.8.7 rubies.</p></li>
</ul>

<h2>2.4.4</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1705 Allow changing the order of many to many foreign keys.</p></li>
<li><p>#1703 Updated at is now versioned again. (Lucas Souza)</p></li>
<li><p>#1686 <a href="Set.html" title="Set (class)"><code>Set</code></a> the base metadata on unbind as well as bind for belongs to
relations.</p></li>
<li><p>#1681 Attempt to create indexes for models without namespacing if the
namespace does not exist for the subdirectory.</p></li>
<li><p>#1676 Allow eager loading to work as a default scope.</p></li>
<li><p>#1665/#1672 Expand complex criteria in nested criteria selectors, like
#matches. (Hans Hasselberg)</p></li>
<li><p>#1668 Ensure Mongoid logger exists before calling warn. (Rémy Coutable)</p></li>
<li><p>#1661 Ensure uniqueness validation works on cloned documents.</p></li>
<li><p>#1659 Clear delayed atomic sets when resetting the same embedded relation.</p></li>
<li><p>#1656/#1657 Don&#39;t hit database for uniqueness validation if BOTH scope
and attribute hasn&#39;t changed. (priyaaank)</p></li>
<li><p>#1205/#1642 When limiting fields returned from the database via
<code>Criteria#only</code> and <code>Criteria#without</code> and then subsequently saving
the document. Default values no longer override excluded fields.</p></li>
</ul>

<h2>2.4.3</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1647 <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> serialization when already in UTC does not convert to
local time.</p></li>
<li><p>#1641/#1639 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a>.observer.disable <code>:all</code> now behaves as AR does.</p></li>
<li><p>#1640 Update consumers should be tied to the name of the collection
they persist to, not the name of the class.</p></li>
<li><p>#1637/#1636 Scopes no longer modify parent class scopes when subclassing.
(Hans Hasselberg)</p></li>
<li><p>#1629 $all and $in criteria on embedded many relations now properly
handles regex searches and elements of varying length. (Douwe Maan)</p></li>
<li><p>#1623/#1634 Default scopes no longer break Mongoid::Versioning.
(Hans Hasselberg)</p></li>
<li><p>#1605 Fix regression of rescue responses, <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 3.2</p></li>
</ul>

<h2>2.4.2</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1628 _type field can once again be included in serialization to json
or xml as a global option with <code>include_type_for_serialization</code>.
(Roman Shterenzon)</p></li>
<li><p>#1627 Validating format now works properly with localized fields.
(Douwe Maan)</p></li>
<li><p>#1617 Relation proxy methods now show up in Mongoid&#39;s list of
prohibited fields.</p></li>
<li><p>#1615 Allow a single configuration of host and port for all spec runs,
overridden by setting MONGOID_SPEC_HOST and MONGOID_SPEC_PORT env vars.</p></li>
<li><p>#1610 When versioning paranoid documents and max version is set, hard
delete old versions from the embedded relation.</p></li>
<li><p>#1609 Allow connection retry during cursor iteration as well as all other
operations.</p></li>
<li><p>#1608 Guard against no method errors when passing ids in nested attributes
and the documents do not exist.</p></li>
<li><p>#1605 Remove deprecation warning on rescue responses, <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 3.2</p></li>
<li><p>#1602 Preserve structure of $and and $or queries when typecasting.</p></li>
<li><p>#1600 Uniqueness validation no longer errors when provided a relation.</p></li>
<li><p>#1599 Make sure enumerable targets yield to what is in memory first when
performing #each, not always the unloaded first.</p></li>
<li><p>#1597 Fix the ability to change the order of array fields with the same
elements.</p></li>
<li><p>#1590 Allow proper serialization of boolean values in criteria where the
field is nested inside an array.</p></li>
</ul>

<h2>2.4.1</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1593 Arrays on embedded documents now properly atomically update when
modified from original version.</p></li>
<li><p>#1592 Don&#39;t swallow exceptions from index generation in the create_indexes
rake task.</p></li>
<li><p>#1589 Allow assignment of empty array to HABTM when no documents are yet
loaded into memory.</p></li>
<li><p>#1587 When a previous value for an array field was an explicit nil, it can
now be reset atomically with new values.</p></li>
<li><p>#1585 <code>Model#respond_to?</code> returns true now for the setter when allowing
dynamic fields.</p></li>
<li><p>#1582 Allow nil values to be set in arrays.</p></li>
<li><p>#1580 Allow arrays to be set to nil post save, and not just empty.</p></li>
<li><p>#1579 Don&#39;t call #to_a on individual set field elements in criterion.</p></li>
<li><p>#1576 Don&#39;t hit database on uniqueness validation if the field getting
validated has not changed.</p></li>
<li><p>#1571 Aliased fields get all the dirty attribute methods and all getters and
setters for both the original name and the alias. (Hans Hasselberg)</p></li>
<li><p>#1568 Fallback to development environment with warning when no env configured.</p></li>
<li><p>#1565 For fields and foreign keys with non-standard Ruby or database names,
use define_method instead of class_eval for creating the accessors and
dirty methods.</p></li>
<li><p>#1557 Internal strategy class no longer conflicts with models.</p></li>
<li><p>#1551 Parent documents now return <code>true</code> for <code>Model#changed?</code> if only child
(embedded) documents have changed.</p></li>
<li><p>#1547 Resetting persisted children from a parent save when new waits until post
callbacks, mirroring update functionality.</p></li>
<li><p>#1536 Eager loading now happens when calling <code>first</code> or <code>last</code> on a
criteria if inclusions are specified.</p></li>
</ul>

<h2>2.4.0</h2>

<h3>New Features</h3>

<ul>
<li><p>Ranges can now be passed to #where criteria to create a $gte/$lte query under the
covers. <code>Person.where(dob: start_date...end_date)</code></p></li>
<li><p>Custom serializable fields can now override #selection to provide
customized serialization for criteria queries.</p></li>
<li><p>#1544 Internals use <code>Array.wrap</code> instead of <code>to_a</code> now where possible.</p></li>
<li><p>#1511 Presence validation now supports localized fields. (Tiago Rafael Godinho)</p></li>
<li><p>#1506 <code>Model.set</code> will now accept false and nil values. (Marten Veldthuis)</p></li>
<li><p>#1505 <code>Model.delete_all/destroy_all</code> now take either a <code>:conditions</code> hash or
the attributes directly.</p></li>
<li><p>#1504 <code>Model.recursively_embeds_many</code> now accepts a <code>:cascade_callbacks</code>
option. (Pavel Pravosud)</p></li>
<li><p>#1496 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now casts strings back to symbols for symbol fields that
get saved as strings by another application.</p></li>
<li><p>#1454, #900 Associations now have an <code>after_build</code> callback that gets
executed after <code>.build</code> or <code>build_</code> methods are called.
(Jeffrey Jones, Ryan Townsend)</p></li>
<li><p>#1451 Ranges can now be any range value, not just numbers. (aupajo)</p></li>
<li><p>#1448 Localization is now used when sorting. (Hans Hasselberg)</p></li>
<li><p>#1422 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> raises an error at yaml load if no environment is found.
(Tom Stuart)</p></li>
<li><p>#1413 $not support added to criteria symbol methods. (Marc Weil)</p></li>
<li><p>#1403 Added configuration option <code>scope_overwrite_exception</code> which defaults to
false for raising an error when defining a named scope with the same name of
an existing method. (Christoph Grabo)</p></li>
<li><p>#1388 <code>model.add_to_set</code> now supports adding multiple values and performs an
$addToSet with $each under the covers. (Christian Felder)</p></li>
<li><p>#1387 Added <code>Model#cache_key</code> for use in <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> caching. (Seivan Heidari)</p></li>
<li><p>#1380 Calling Model.find(id) will now properly convert to and from any type
based on the type of the _id field.</p></li>
<li><p>#1363 Added fallbacks and default support to localized fields, and added
ability to get and set all translations at once.</p></li>
<li><p>#1362 Aliased fields now properly typecast in criteria.</p></li>
<li><p>#1337 <a href="Array.html" title="Array (class)"><code>Array</code></a> fields, including HABTM many foreign keys now have smarter dirty
checking and no longer perform a simple $set if the array has changed. If
items have only been added to the array, it performs a $pushAll. If items
have only been removed, it performs a $pullAll. If both additions and
removals have occurred it performs a $set to avoid conflicting mods.</p></li>
</ul>

<h3>Resolved Issues</h3>

<ul>
<li><p>Calling <code>Document#as_document</code> on a frozen document on Rubinius returns the
attributes instead of nil.</p></li>
<li><p>#1554 Split application of default values into proc/non-procs, where
non-procs get executed immediately during instantiation, and procs get
executed after all other values are set.</p></li>
<li><p>#1553 Combinations of adding and removing values from an array use a $set
on the current contents of the array, not the new values.</p></li>
<li><p>#1546 Dirty changes should be returned in a hash with indifferent access.</p></li>
<li><p>#1542 Eager loading now respects the options (ie skip, limit) provided to
the criteria when fetch the associations.</p></li>
<li><p>#1530 Don&#39;t duplicate added values to arrays via dirty tracking if the
array is a foreign key field.</p></li>
<li><p>#1529 Calling <code>unscoped</code> on relational associations now works properly.</p></li>
<li><p>#1524 Allow access to relations in overridden field setters by pre-setting
foreign key default values.</p></li>
<li><p>#1523 Allow disabling of observers via <code>disable</code>. (Jonas Schneider)</p></li>
<li><p>#1522 Fixed create indexes rake task for <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 3.2. (Gray Manley)</p></li>
<li><p>#1517 Fix Mongoid documents to properly work with RSpec&#39;s stub_model.
(Tiago Rafael Godinho)</p></li>
<li><p>#1516 Don&#39;t duplicate relational many documents on bind.</p></li>
<li><p>#1515 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> no longer attempts to serialize custom fields on complex
criteria by default.</p></li>
<li><p>#1503 Has many relation substitution now handles any kind of mix of existing
and new docs.</p></li>
<li><p>#1502 Nested attributes on embedded documents respects if the child is
paranoid.</p></li>
<li><p>#1497 Use provided message on failing uniqueness validation. (Justin Etheredge)</p></li>
<li><p>#1491 Return nil when no default set on localized fields. (Tiago Rafael Godinho)</p></li>
<li><p>#1483 Sending module includes at runtime which add new fields to a parent
document, also have the fields added to subclasses.</p></li>
<li><p>#1482 Applying new sorting options does not merge into previously
chained criteria. (Gerad Suyderhoud)</p></li>
<li><p>#1481 Fix invalid query when accessing many-to-many relations before
defaults are set.</p></li>
<li><p>#1480 Mongoid&#39;s internal serialized field types renamespaced to Internal in order
to not conflict with ruby core classes in custom serializable types.</p></li>
<li><p>#1479 Don&#39;t duplicate ids on many-to-many when using create or create!</p></li>
<li><p>#1469 When extract_id returns nil, get the document out of the identity map
by the criteria selector.</p></li>
<li><p>#1467 Defining a field named metadata now properly raises an invalid field
error.</p></li>
<li><p>#1463 Batch insert consumers are now scoped to collection to avoid persistence
of documents to other collections in callbacks going to the wrong place.</p></li>
<li><p>#1462 Assigning has many relations via nested attributes <code>*_attributes=</code> does
not autosave the relation.</p></li>
<li><p>#1461 Fixed serialization of foreign key fields in complex criteria not to
escape the entire hash.</p></li>
<li><p>#1458 Versioning no longer skips fields that have been protected from mass
assignment.</p></li>
<li><p>#1455, #1456 Calling destroy on any document now temporarily marks it as
flagged for destroy until the operation is complete. (Nader Akhnoukh)</p></li>
<li><p>#1453 <code>Model#to_key</code> should return a value when the document is destroyed.</p></li>
<li><p>#1449 New documents no longer get persisted when replaced on a has one as
a side effect. (jasonsydes)</p></li>
<li><p>#1439 embedded? should return true when relation defined as cyclic.</p></li>
<li><p>#1433 Polymorphic nested attributes for embedded and relational 1-1 now
update properly.</p></li>
<li><p>#1426 Frozen documents can now be cloned. (aagrawal2001)</p></li>
<li><p>#1382 Raise proper error when creating indexes via rake task if index
definition is incorrect. (Mathieu Ravaux)</p></li>
<li><p>#1381, #1371 The identity map now functions properly with inherited
documents. (Paul Canavese)</p></li>
<li><p>#1370 Split concat on embedded arrays into its own method to handle the
batch processing due to after callback run execution issues.</p></li>
<li><p>#1366 <a href="Array.html" title="Array (class)"><code>Array</code></a> and hash values now get deep copied for dirty tracking.</p></li>
<li><p>#1359 Provide ability to not have default scope applied to all named
scopes via using lambdas.</p></li>
<li><p>#1333 Fixed errors with custom types that exist in namespaces. (Peter Gumeson)</p></li>
<li><p>#1259 Default values are treated as dirty if they differ from the database
state.</p></li>
<li><p>#1255 Ensure embedded documents respect the defined default scope.</p></li>
</ul>

<h2>2.3.4</h2>

<ul>
<li><p>#1445 Prevent duplicate documents in the loaded array on the target
enumerable for relational associations.</p></li>
<li><p>#1442 When using create_ methods for has one relations, the appropriate
destructive methods now get called when replacing an existing document.</p></li>
<li><p>#1431 Enumerable context should add to the loaded array post yield, so
that methods like #any? that short circuit based on the value of the block
dont falsely have extra documents.</p></li>
<li><p>#1418 Documents being loaded from the database for revision purposes
no longer get placed in the identity map.</p></li>
<li><p>#1399 Allow conversion of strings to integers in foreign keys where the
id is defined as an int.</p></li>
<li><p>#1397 Don&#39;t add default sorting criteria on first if they sort criteria
already exists.</p></li>
<li><p>#1394 Fix exists? to work when count is greater than 1. (Nick Hoffman)</p></li>
<li><p>#1392 Return 0 on aggregation functions where field is nonexistent.</p></li>
<li><p>#1391 Uniqueness validation now works properly on embedded documents that are
using primary key definitions.</p></li>
<li><p>#1390 When _type field is lower case class camelize before constantizing.</p></li>
<li><p>#1383 Fix cast on read for serializable fields that are subclassed.</p></li>
<li><p>#1357 Delayed atomic sets from update_attributes on embedded documents
multiple levels deep now properly persist.</p></li>
<li><p>#1326 Ensure base document on HABTM gets its keys saved after saving a newly
build child document.</p></li>
<li><p>#1301 Don&#39;t overwrite base metadata on embedded in relations if already set.</p></li>
<li><p>#1221 HABTM with inverse nil is allowed again on embedded documents.</p></li>
<li><p>#1208 Don&#39;t auto-persist child documents via the setter when setting from
an embedded_in.</p></li>
<li><p>#791 Root document updates its timestamps when only embedded documents have
changed.</p></li>
</ul>

<h2>2.3.3</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1386 Lowered mongo/bson dependency to 1.3</p></li>
<li><p>#1377 Fix aggregation functions to properly handle nil or undefined values.
(Maxime Garcia)</p></li>
<li><p>#1373 Warn if a scope overrides another scope.</p></li>
<li><p>#1372 Never persist when binding inside of a read attribute for validation.</p></li>
<li><p>#1364 Fixed reloading of documents with non bson object id ids.</p></li>
<li><p>#1360 Fixed performance of Mongoid&#39;s observer instantiation by hooking into
Active Support&#39;s load hooks, a la AR.</p></li>
<li><p>#1358 Fixed type error on many to many synchronization when inverse_of is
set to nil.</p></li>
<li><p>#1356 $in criteria can now be chained to non-complex criteria on the same
key without error.</p></li>
<li><p>#1350, #1351 Fixed errors in the string conversions of double quotes and
tilde when parametrizing keys.</p></li>
<li><p>#1349 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> documents should not blow up when including Enumerable.
(Jonas Nicklas)</p></li>
</ul>

<h2>2.3.2</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1347 Fix embedded matchers when provided a hash value that does not have a
modifier as a key.</p></li>
<li><p>#1346 Dup default sorting criteria when calling first/last on a criteria.</p></li>
<li><p>#1343 When passing no arguments to <code>Criteria#all_of</code> return all documents.
(Chris Leishman)</p></li>
<li><p>#1339 Ensure destroy callbacks are run on cascadable children when deleting via
nested attributes.</p></li>
<li><p>#1324 Setting <code>inverse_of: nil</code> on a many-to-many referencing the same class
returns nil for the inverse foreign key.</p></li>
<li><p>#1323 Allow both strings and symbols as ids in the attributes array for
nested attributes. (Michael Wood)</p></li>
<li><p>#1312 Setting a logger on the config now accepts anything that quacks like a
logger.</p></li>
<li><p>#1297 Don&#39;t hit the database when accessing relations if the base is new.</p></li>
<li><p>#1239 Allow appending of referenced relations in create blocks, post default set.</p></li>
<li><p>#1236 Ensure all models are loaded in rake tasks, so even in threadsafe mode
all indexes can be created.</p></li>
<li><p>#736 Calling #reload on embedded documents now works properly.</p></li>
</ul>

<h2>2.3.1</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1338 Calling #find on a scope or relation checks that the document in the
identity map actually matches other scope parameters.</p></li>
<li><p>#1321 HABTM no longer allows duplicate entries or keys, instead of the previous
inconsistencies.</p></li>
<li><p>#1320 Fixed errors in perf benchmark.</p></li>
<li><p>#1316 Added a separate Rake task &quot;db:mongoid:drop&quot; so <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> and AR can coexist.
(Daniel Vartanov)</p></li>
<li><p>#1311 Fix issue with custom field serialization inheriting from hash.</p></li>
<li><p>#1310 The referenced many enumerable target no longer duplicates loaded and
added documents when the identity map is enabled.</p></li>
<li><p>#1295 Fixed having multiple includes only execute the eager loading of the first.</p></li>
<li><p>#1287 Fixed max versions limitation with versioning.</p></li>
<li><p>#1277 attribute_will_change! properly flags the attribute even if no change occurred.</p></li>
<li><p>#1063 Paranoid documents properly run destroy callbacks on soft destroy.</p></li>
<li><p>#1061 Raise <a href="Mongoid/Errors/InvalidTime.html" title="Mongoid::Errors::InvalidTime (class)"><code>::Mongoid::Errors::InvalidTime</code></a> when time serialization fails.</p></li>
<li><p>#1002 Check for legal bson ids when attempting conversion.</p></li>
<li><p>#920 Allow relations to be named target.</p></li>
<li><p>#905 Return normalized class name in metadata if string was defined with a
prefixed ::.</p></li>
<li><p>#861 accepts_nested_attributes_for is no longer needed to set embedded documents
via a hash or array of hashes directly.</p></li>
<li><p>#857 Fixed cascading of dependent relations when base document is paranoid.</p></li>
<li><p>#768 Fixed class_attribute definitions module wide.</p></li>
<li><p>#408 Embedded documents can now be soft deleted via <code>Mongoid::Paranoia</code>.</p></li>
</ul>

<h2>2.3.0</h2>

<h3>New Features</h3>

<ul>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now supports basic localized fields, storing them under the covers as a
hash of locale =&gt; value pairs. <code>field :name, localize: true</code></p></li>
<li><p>#1275 For applications that default safe mode to true, you can now tell a
single operation to persist without safe mode via #unsafely:
<code>person.unsafely.save</code>, <code>Person.unsafely.create</code>. (Matt Sanders)</p></li>
<li><p>#1256 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now can create indexes for models in <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> engines. (Caio Filipini)</p></li>
<li><p>#1228 Allow pre formatting of composite keys by passing a block to #key.
(Ben Hundley)</p></li>
<li><p>#1222 Scoped mass assignment is now supported. (Andrew Shaydurov)</p></li>
<li><p>#1196 Timestamps can now be turned off on a call-by-call basis via the use
of #timeless: <code>person.timeless.save</code>, <code>Person.timeless.create(:title =&gt; &quot;Sir&quot;)</code>.</p></li>
<li><p>#1103 Allow developers to create their own custom complex criteria. (Ryan Ong)</p></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now includes all defined fields in <code>serializable_hash</code> and <code>to_json</code>
results even if the fields have no values to make serialized documents easier
to use by ActiveResource clients.</p></li>
<li><p>Support for MongoDB&#39;s $and operator is now available in the form of:
<code>Criteria#all_of(*args)</code> where args is multiple hash expressions.</p></li>
<li><p>#1250, #1058 Embedded documents now can have their callbacks fired on a parent
save by setting <code>:cascade_callbacks =&gt; true</code> on the relation.
(pyromanic, Paul Rosania, Jak Charlton)</p></li>
</ul>

<h3>Major Changes</h3>

<ul>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now depends on Active Model 3.1 and higher.</p></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now depends on the Mongo Ruby Driver 1.4 and higher.</p></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> requires MongoDB 2.0.0 and higher.</p></li>
</ul>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1308 Fixed scoping of HABTM finds.</p></li>
<li><p>#1300 Namespaced models should handle recursive embedding properly.</p></li>
<li><p>#1299 Self referenced documents with versioning no longer fail when inverse_of
is not defined on all relations.</p></li>
<li><p>#1296 Renamed internal building method to _building.</p></li>
<li><p>#1288, #1289 _id and updated_at should not be part of versioned attributes.</p></li>
<li><p>#1273 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a>.preload_models now checks if preload configuration option is set,
where Mongoid.load_models always loads everything. (Ryan McGeary)</p></li>
<li><p>#1244 Has one relations now adhere to default dependant behavior.</p></li>
<li><p>#1225 Fixed delayed persistence of embedded documents via $set.</p></li>
<li><p>#1166 Don&#39;t load config in Railtie if no env variables defined. (Terence Lee)</p></li>
<li><p>#1052 <code>alias_attribute</code> now works again as expected.</p></li>
<li><p>#939 Apply default attributes when upcasting via #becomes. (Christos Pappas)</p></li>
<li><p>#932 Fixed casting of integer fields with leading zeros.</p></li>
<li><p>#948 Reset version number on clone if versions existed.</p></li>
<li><p>#763 Don&#39;t merge $in criteria arrays when chaining named scopes.</p></li>
<li><p>#730 Existing models that have relations added post persistence of originals
can now have new relations added with no migrations.</p></li>
<li><p>#726 Embedded documents with compound keys not validate uniqueness correctly.</p></li>
<li><p>#582 Cyclic non embedded relations now validate uniqueness correctly.</p></li>
<li><p>#484 Validates uniqueness with multiple scopes of all types now work properly.</p></li>
<li><p>Deleting versions created with <code>Mongoid::Versioning</code> no longer fires off
dependent cascading on relations.</p></li>
</ul>

<h2>2.2.5</h2>

<ul>
<li>This was a small patch release to address 2.2.x Heroku errors during asset
compilation.</li>
</ul>

<h2>2.2.4</h2>

<ul>
<li><p>#1377 Fix aggregation functions to properly handle nil or undefined values.
(Maxime Garcia)</p></li>
<li><p>#1373 Warn if a scope overrides another scope.</p></li>
<li><p>#1372 Never persist when binding inside of a read attribute for validation.</p></li>
<li><p>#1358 Fixed type error on many to many synchronization when inverse_of is
set to nil.</p></li>
<li><p>#1356 $in criteria can now be chained to non-complex criteria on the same
key without error.</p></li>
<li><p>#1350, #1351 Fixed errors in the string conversions of double quotes and
tilde when parameterizing keys.</p></li>
<li><p>#1349 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> documents should not blow up when including Enumerable.
(Jonas Nicklas)</p></li>
</ul>

<h2>2.2.3</h2>

<ul>
<li><p>#1295 Fixed having multiple includes only execute the eager loading of the first.</p></li>
<li><p>#1225 Fixed delayed persistence of embedded documents via $set.</p></li>
<li><p>#1002 Fix BSON object id conversion to check if legal first.</p></li>
</ul>

<h2>2.2.2</h2>

<ul>
<li>This release removes the restriction of a dependency on 1.3.x of the mongo
ruby driver. Users may now use 1.3.x through 1.4.x.</li>
</ul>

<h2>2.2.1</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1210, #517 Allow embedded document relation queries to use dot notation.
(Scott Ellard)</p></li>
<li><p>#1198 Enumerable target should use criteria count if loaded has no docs.</p></li>
<li><p>#1164 Get rid of remaining no method in_memory errors.</p></li>
<li><p>#1070 Allow custom field serializers to have their own constructors.</p></li>
<li><p>#1176 Allow access to parent documents from embedded docs in after_destroy
callbacks.</p></li>
<li><p>#1191 Context group methods (min, max, sum) no longer return NaN but instead
return nil if field doesn&#39;t exist or have values.</p></li>
<li><p>#1193, #1271 Always return Integers for integer fields with .000 precisions,
not floats.</p></li>
<li><p>#1199 Fixed performance issues of hash and array field access when reading
multiple times.</p></li>
<li><p>#1218 Fixed issues with relations referencing models with integer foreign keys.</p></li>
<li><p>#1219 Fixed various conflicting modifications issues when pushing and pulling
from the same embedded document in a single call.</p></li>
<li><p>#1220 Metadata should not get overwritten by nil on binding.</p></li>
<li><p>#1231 Renamed Mongoid&#39;s atomic set class to Sets to avoid conflicts with Ruby&#39;s
native Set after document inclusion.</p></li>
<li><p>#1232 Fix access to related models during before_destroy callbacks when
cascading.</p></li>
<li><p>#1234 Fixed HABTM foreign key synchronization issues when destroying
documents.</p></li>
<li><p>#1243 Polymorphic relations dont convert to object ids when querying if the
ids are defined as strings.</p></li>
<li><p>#1247 Force Model.first to sort by ascending id to guarantee first document.</p></li>
<li><p>#1248 Added #unscoped to embedded many relations.</p></li>
<li><p>#1249 Destroy flags in nested attributes now actually destroy the document
for has_many instead of just breaking the relation.</p></li>
<li><p>#1272 Don&#39;t modify configuration options in place when creating replica set
connections.</p></li>
</ul>

<h2>2.2.0</h2>

<h3>New Features</h3>

<ul>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now contains eager loading in the form of <code>Criteria#includes(*args)</code>.
This works on has_one, has_many, belongs_to associations and requires the identity map to
be enabled in order to function. Set <code>identity_map_enabled: true</code> in your
<code>mongoid.yml</code>. Ex: <code>Person.where(title: &quot;Sir&quot;).includes(:posts, :game)</code></p></li>
<li><p>Relations can now take a module as a value to the <code>:extend</code> option. (Roman
Shterenzon)</p></li>
<li><p>Capped collections can be created by passing the options to the <code>#store_in</code>
macro: <code>Person.store_in :people, capped: true, max: 1000000</code></p></li>
<li><p>Mongoid::Collection now supports <code>collection.find_and_modify</code></p></li>
<li><p><code>Document#has_attribute?</code> now aliases to <code>Document#attribute_present?</code></p></li>
<li><p>#930 You can now turn off the <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> logger via the mongoid.yml by
doing <code>logger: false</code></p></li>
<li><p>#909 We now raise a <a href="Mongoid/Errors/Callback.html" title="Mongoid::Errors::Callback (class)"><code>::Mongoid::Errors::Callback</code></a> exception if persisting with
a bang method and a callback returns false, instead of the uninformative
validations error from before.</p></li>
</ul>

<h3>Major Changes</h3>

<ul>
<li><p>#1173 has_many relations no longer delete all documents on a set of the relation
(= [ doc_one, doc_two ]) but look to the dependent option to determine what
behavior should occur. :delete and :destroy will behave as before, :nullify and
no option specified will both nullify the old documents without deleting.</p></li>
<li><p>#1142, #767 Embedded relations no longer immediately persist atomically
when accessed via a parent attributes set. This includes nested attributes setting
and <code>attributes=</code> or <code>write_attributes</code>. The child changes then remain dirty and
atomically update when save is called on them or the parent document.</p></li>
</ul>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1190 Fixed the gemspec errors due to changing README and CHANGELOG to markdown.</p></li>
<li><p>#1180, #1084, #955 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now checks the field types rather than if the name
contains <code>/id/</code> when trying to convert to object ids on criteria.</p></li>
<li><p>#1176 Enumerable targets should always return the in memory documents first,
when calling <code>#first</code></p></li>
<li><p>#1175 Make sure both sides of many to many relations are in sync during a create.</p></li>
<li><p>#1172 Referenced enumerable relations now properly handle <code>#to_json</code>
(Daniel Doubrovkine)</p></li>
<li><p>#1040 Increased performance of class load times by removing all delegate calls
to self.class.</p></li>
</ul>

<h2>2.1.9</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1159 Fixed build blocks not to cancel out each other when nested.</p></li>
<li><p>#1154 Don&#39;t delete many-to-many documents on empty array set.</p></li>
<li><p>#1153 Retain parent document reference in after callbacks.</p></li>
<li><p>#1151 Fix associated validation infinite loop on self referencing documents.</p></li>
<li><p>#1150 Validates associated on <code>belongs_to</code> is <code>false</code> by default.</p></li>
<li><p>#1149 Fixed metadata setting on <code>belongs_to</code> relations.</p></li>
<li><p>#1145 Metadata inverse should return <code>nil</code> if <code>inverse_of</code> was set as <code>nil</code>.</p></li>
<li><p>#1139 Enumerable targets now quack like arrays.</p></li>
<li><p>#1136 Setting <code>belongs_to</code> parent to <code>nil</code> no longer deletes the parent.</p></li>
<li><p>#1120 Don&#39;t call <code>in_memory</code> on relations if they don&#39;t respond to it.</p></li>
<li><p>#1075 <a href="Set.html" title="Set (class)"><code>Set</code></a> <code>self</code> in default procs to the document instance.</p></li>
<li><p>#1072 Writing attributes for nested documents can take a hash or array of hashes.</p></li>
<li><p>#990 Embedded documents can use a single <code>embedded_in</code> with multiple parent definitions.</p></li>
</ul>

<h2>2.1.8</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1148 Fixed <code>respond_to?</code> on all relations to return properly.</p></li>
<li><p>#1146 Added back the <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> destructive fields check when defining fields.</p></li>
<li><p>#1141 Fixed conversions of <code>nil</code> values in criteria.</p></li>
<li><p>#1131 Verified Mongoid/Kaminari paginating correctly.</p></li>
<li><p>#1105 Fixed atomic update consumer to be scoped to class.</p></li>
<li><p>#1075 <code>self</code> in default lambdas and procs now references the document instance.</p></li>
<li><p>#740 Removed <code>embedded_object_id</code> configuration parameter.</p></li>
<li><p>#661 Fixed metadata caching on embedded documents.</p></li>
<li><p>#595 Fixed relation reload flagging.</p></li>
<li><p>#410 Moving documents from one relation to another now works as expected.</p></li>
</ul>

<h2>2.1.7</h2>

<p>This was a specific release to fix MRI 1.8.7 breakages introduced by 2.1.6.</p>

<h2>2.1.6</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1126 Fix setting of relations with other relation proxies.</p></li>
<li><p>#1122 <a href="Hash.html" title="Hash (class)"><code>Hash</code></a> and array fields now properly flag as dirty on access and change.</p></li>
<li><p>#656 Fixed reload breaking relations on unsetting of already loaded associations.</p></li>
<li><p>#647 Prefer <code>#unset</code> to <code>#remove_attribute</code> for removing values.</p></li>
<li><p>#290 Verify pushes into deeply embedded documents.</p></li>
</ul>

<h2>2.1.5</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1116 Embedded children retain reference to parent in destroy callbacks.</p></li>
<li><p>#1110, #1115 Don&#39;t memoize metadata related helpers on documents.</p></li>
<li><p>#1112 <code>db:create_indexes</code> no longer indexes subclasses multiple times.</p></li>
<li><p>#1111, #1098 Don&#39;t set <code>_id</code> in <code>$set</code> operations.</p></li>
<li><p>#1007 Update attribute properly tracks array changes.</p></li>
</ul>

<h2>2.1.4</h2>

<p>This was a specific release to get a Psych generated gemspec so no more parse errors would occur on those rubies that were using the new YAML parser.</p>

<h2>2.1.3</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1109 Fixed validations not loading one to ones into memory.</p></li>
<li><p>#1107 <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> no longer wants required <code>mongoid/railtie</code> in <code>application.rb</code>.</p></li>
<li><p>#1102 Fixed nested attributes deletion.</p></li>
<li><p>#1097 Reload now runs <code>after_initialize</code> callbacks.</p></li>
<li><p>#1079 Embeds many no longer duplicates documents.</p></li>
<li><p>#1078 Fixed array criteria matching on embedded documents.</p></li>
<li><p>#1028 Implement scoped on one-to-many and many-to-many relations.</p></li>
<li><p>#988 Many-to-many clear no longer deletes the child documents.</p></li>
<li><p>#977 Autosaving relations works also through nested attributes.</p></li>
<li><p>#972 Recursive embedding now handles namespacing on generated names.</p></li>
<li><p>#943 Don&#39;t override <code>Document#attributes</code>.</p></li>
<li><p>#893 Verify count is not caching on many to many relations.</p></li>
<li><p>#815 Verify <code>after_initialize</code> is run in the correct place.</p></li>
<li><p>#793 Verify <code>any_of</code> scopes chain properly with any other scope.</p></li>
<li><p>#776 Fixed mongoid case quality when dealing with subclasses.</p></li>
<li><p>#747 Fixed complex criteria using its keys to render its string value.</p></li>
<li><p>#721 <code>#safely</code> now properly raises validation errors when they occur.</p></li>
</ul>

<h2>2.1.2</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1082 Alias <code>size</code> and <code>length</code> to <code>count</code> on criteria. (Adam Greene)</p></li>
<li><p>#1044 When multiple relations are defined for the same class, always return the default inverse first if <code>inverse_of</code> is not defined.</p></li>
<li><p>#710 Nested attributes accept both <code>id</code> and <code>_id</code> in hashes or arrays.</p></li>
<li><p>#1047 Ignore <code>nil</code> values passed to <code>embeds_man</code> pushes and substitution. (Derick Bailey)</p></li>
</ul>

<h2>2.1.1</h2>

<h3>Resolved Issues</h3>

<ul>
<li><p>#1021, #719 Many to many relations dont trigger extra database queries when pushing new documents.</p></li>
<li><p>#607 Calling <code>create</code> on large associations does not load the entire relation.</p></li>
<li><p>#1064 <code>Mongoid::Paranoia</code> should respect <code>unscoped</code> and <code>scoped</code>.</p></li>
<li><p>#1026 <code>model#update_attribute</code> now can update booleans to <code>false</code>.</p></li>
<li><p>#618 Crack XML library breaks <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> by adding <code>#attributes</code> method to the <a href="String.html" title="String (class)"><code>String</code></a> class. (Stephen McGinty)</p></li>
</ul>

<h2>2.1.0</h2>

<h3>Major Changes</h3>

<ul>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now requires MongoDB 1.8.x in order to properly support the <code>#bit</code> and <code>#rename</code> atomic operations.</p></li>
<li><p>Traditional slave support has been removed from <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a>. Replica sets should be used in place of traditional master and slave setups.</p></li>
<li><p>Custom field serialization has changed. Please see <a href="https://github.com/mongoid/mongoid/blob/master/lib/mongoid/fields/serializable.rb">serializable</a> for changes.</p></li>
<li><p>The dirty attribute tracking has been switched to use ActiveModel, this brings many bug fixes and changes:</p>

<ul>
<li>#756 After callbacks and observers see what was changed instead of changes just made being in previous_changes</li>
<li>#434 Documents now are flagged as dirty when brand new or the state on instantiation differs from the database state. This is consistent with ActiveRecord.</li>
<li>#323 Mongoid now supports [field]_will_change! from ActiveModel::Dirty</li>
</ul></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> model preloading in development mode now defaults to <code>false</code>.</p></li>
<li><p><code>:autosave =&gt; true</code> on relational associations now saves on update as well as create.</p></li>
<li><p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> now has an identity map for simple <code>find_by_id</code> queries. See the website for documentation.</p></li>
</ul>

<h3>New Features</h3>

<ul>
<li><p>#1067 Fields now accept a <code>:versioned</code> attribute to be able to disable what fields are versioned with <code>Mongoid::Versioning</code>. (Jim Benton)</p></li>
<li><p>#587 Added order preference to many and many to many associations. (Gregory Man)</p></li>
<li><p>Added ability to chain <code>order_by</code> statements. (Gregory Man)</p></li>
<li><p>#961 Allow arbitrary <code>Mongo::Connection</code> options to pass through <code>Mongoid::Config::Database</code> object. (Morgan Nelson)</p></li>
<li><p>Enable <code>autosave</code> for many to many references. (Dave Krupinski)</p></li>
<li><p>The following explicit atomic operations have been added: <code>Model#bit</code>, <code>Model#pop</code>, <code>Model#pull</code>, <code>Model#push_all</code>, <code>Model#rename</code>, <code>Model#unset</code>.</p></li>
<li><p>Added exception translations for Hindi. (Sukeerthi Adiga)</p></li>
</ul>

<h3>Resolved Issues</h3>

<ul>
<li><p>#974 Fix <code>attribute_present?</code> to work correctly then attribute value is <code>false</code>, thanks to @nickhoffman. (Gregory Man)</p></li>
<li><p>#960 create indexes rake task is not recognizing a lot of mongoid models because it has problems guessing their model names from filenames. (Tobias Schlottke)</p></li>
<li><p>#874 Deleting from a M-M reference is one-sided. (nickhoffman, davekrupinski)</p></li>
<li><p>Replace deprecated <code>class_inheritable_hash</code> dropped in <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 3.1+. (Konstantin Shabanov)</p></li>
<li><p>Fix inconsistent state when replacing an entire many to many relation.</p></li>
<li><p>Don&#39;t clobber inheritable attributes when adding subclass field inheritance. (Dave Krupinski)</p></li>
<li><p>#914 Querying embedded documents with <code>$or</code> selector. (Max Golovnia)</p></li>
<li><p>#514 Fix marshaling of documents with relation extensions. (Chris Griego)</p></li>
<li><p><code>Metadata#extension</code> now returns a <code>Module</code>, instead of a <code>Proc</code>, when an extension is defined.</p></li>
<li><p>#837 When <code>allow_dynamic_fields</code> is set to <code>false</code> and loading an embedded document with an unrecognized field, an exception is raised.</p></li>
<li><p>#963 Initializing array of embedded documents via hash regressed (Chris Griego, Morgan Nelson)</p></li>
<li><p><code>Mongoid::Config.reset</code> resets the options to their default values.</p></li>
<li><p><code>Mongoid::Fields.defaults</code> is memoized for faster instantiation of models.</p></li>
</ul>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>