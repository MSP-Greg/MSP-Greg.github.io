<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Configuration &mdash; Mongoid master</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "configuration",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Mongoid master</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Configuration&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>Configuration</h1>

<div class="contents singlecol" markdown="1" local="" backlinks="none" depth="2"></div>

<p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> is customarily configured through a <code>mongoid.yml</code> file that specifies
options and clients. The simplest configuration is as follows, which configures
<a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> to talk to a MongoDB server at &quot;localhost:27017&quot; and use the database
named &quot;mongoid&quot;.</p>

<pre class="code yaml"><code class="yaml">development:
  clients:
    default:
      database: mongoid
      hosts:
        - localhost:27017
</code></pre>

<p>The top level key in the configuration file, <code>development</code> in the above
example, refers to the environment name which the application is executing in,
i.e. <code>development</code>, <code>test</code> or <code>production</code>. The third level key,
<code>default</code> in the above example, refers to the Mongo client name.
Most applications will use a single client named <code>default</code>.</p>

<h2>Generating Default Configuration</h2>

<p>If you are using Ruby on Rails, you can have Mongoid generate a default
configuration file for you by running the following command:</p>

<pre class="code bash"><code class="bash">rails g mongoid:config
</code></pre>

<p>The configuration file will be placed in <code>config/mongoid.yml</code>. An
initializer will also be created and placed in
<code>config/initializers/mongoid.rb</code>. It is recommended that all configuration
be specified in <code>config/mongoid.yml</code>, but if you prefer, the <code>mongoid.rb</code>
initializer may also be used to set configuration options. Note, though, that
settings in <code>mongoid.yml</code> always take precedence over settings in the
initializer.</p>

<p>If you are not using Ruby on Rails, you can copy the minimal configuration
given above and save it as <code>config/mongoid.yml</code>.</p>

<h2>Loading Mongoid Configuration</h2>

<p>If you are using Ruby on Rails, Mongoid configuration is automatically loaded
for the current environment as stored in <code>Rails.env</code> when the application
loads.</p>

<p>You may need to configure the ORM for your application to be Mongoid by
adding the following to <code>application.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_generators'>generators</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_g'>g</span><span class='op'>|</span>
  <span class='id identifier rubyid_g'>g</span>.<span class='id identifier rubyid_orm'>orm</span> <span class='symbeg'>:</span><span class='id identifier rubyid_mongoid'>mongoid</span>
<span class='kw'>end</span></code></pre>

<p>If you are not using Ruby on Rails, Mongoid configuration must be loaded
manually. This can be done via the <code>Mongoid.load!</code> method, which takes
the configuration file path as its argument, as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Use automatically detected environment name
</span><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_load!'>load!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>path/to/your/mongoid.yml</span><span class='tstring_end'>&quot;</span></span>)

<span class='comment'># Specify environment name manually
</span><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_load!'>load!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>path/to/your/mongoid.yml</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_production'>production</span>)</code></pre>

<p>When Mongoid is asked to automatically detect the environment name,
it does so by examining the following sources, in order:</p>

<ul>
<li>  If <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> top level constant is defined, <code>Rails.env</code>.</li>
<li>  If <code>Sinatra</code> top level constant is defined, <code>Sinatra::Base.environment</code>.</li>
<li>  The <code>RACK_ENV</code> environment variable.</li>
<li>  The <code>MONGOID_ENV</code> environment variable.</li>
</ul>

<p>It is also possible to configure Mongoid directly in Ruby, without using
a configuration file. This configuration style does not support the concept
of environments - whatever configuration is provided, it is applied to the
current environment - but it does support defining multiple clients.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_configure'><a href="Mongoid.html#configure-instance_method" title="Mongoid#configure (method)">configure</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_default'>default</span> <span class='op'>=</span> {
    <span class='label'>hosts:</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>localhost:27017</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my_db</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  }

  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_log_level'>log_level</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_warn'>warn</span>
<span class='kw'>end</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Mongoid must be configured <em>before</em> any component of it is used or referenced.
Once a component is used or referenced, changing configuration may not apply
changes to already instantiated components.</p>

<p></div></p>

<h2>Mongoid Configuration Options [configuration-options]</h2>

<p>The following annotated example <code>mongoid.yml</code> demonstrates how Mongoid
can be configured.</p>

<p>Mongoid delegates to the Ruby driver for client configuration. Please review
<a href="https://mongodb.com/docs/ruby-driver/current/reference/create-client/">the driver documentation</a>
for details on driver options.</p>

<pre class="code yaml"><code class="yaml">development:
  # Configure available database clients. (required)
  clients:
    # Defines the default client. (required)
    default:
      # Mongoid can connect to a URI accepted by the driver:
      # uri: mongodb://user:password@mongodb.domain.com:27017/my_db_development

      # Otherwise define the parameters separately.
      # This defines the name of the default database that Mongoid can connect to.
      # (required).
      database: my_db_development
      # Provides the hosts the default client can connect to. Must be an array
      # of host:port pairs. (required)
      hosts:
        - localhost:27017
      options:
        # Note that all options listed below are Ruby driver client options (the mongo gem).
        # Please refer to the driver documentation of the version of the mongo gem you are using
        # for the most up-to-date list of options.

        # Change the default write concern. (default = { w: 1 })
        # write:
        #   w: 1

        # Change the default read preference. Valid options for mode are: :secondary,
        # :secondary_preferred, :primary, :primary_preferred, :nearest
        # (default: primary)
        # read:
        #   mode: :secondary_preferred
        #   tag_sets:
        #     - use: web

        # The name of the user for authentication.
        # user: &#39;user&#39;

        # The password of the user for authentication.
        # password: &#39;password&#39;

        # The user&#39;s database roles.
        # roles:
        #   - &#39;dbOwner&#39;

        # Change the default authentication mechanism. Valid options include:
        # :scram, :scram256, :mongodb_cr, :mongodb_x509, :gssapi, :aws, :plain.
        # MongoDB Server defaults to :scram, which will use &quot;SCRAM-SHA-256&quot; if available,
        # otherwise fallback to &quot;SCRAM-SHA-1&quot; (:scram256 will always use &quot;SCRAM-SHA-256&quot;.)
        # This setting is handled by the MongoDB Ruby Driver. Please refer to:
        # https://mongodb.com/docs/ruby-driver/current/reference/authentication/
        # auth_mech: :scram

        # The database or source to authenticate the user against.
        # (default: the database specified above or admin)
        # auth_source: admin

        # Force a the driver cluster to behave in a certain manner instead of auto-
        # discovering. Can be one of: :direct, :replica_set, :sharded. Set to :direct
        # when connecting to hidden members of a replica set.
        # connect: :direct

        # Changes the default time in seconds the server monitors refresh their status
        # via hello commands. (default: 10)
        # heartbeat_frequency: 10

        # The time in seconds for selecting servers for a near read preference. (default: 0.015)
        # local_threshold: 0.015

        # The timeout in seconds for selecting a server for an operation. (default: 30)
        # server_selection_timeout: 30

        # The maximum number of connections in the connection pool. (default: 5)
        # max_pool_size: 5

        # The minimum number of connections in the connection pool. (default: 1)
        # min_pool_size: 1

        # The time to wait, in seconds, in the connection pool for a connection
        # to be checked in before timing out. (default: 5)
        # wait_queue_timeout: 5

        # The time to wait to establish a connection before timing out, in seconds.
        # (default: 10)
        # connect_timeout: 10

        # How long to wait for a response for each operation sent to the
        # server. This timeout should be set to a value larger than the
        # processing time for the longest operation that will be executed
        # by the application. Note that this is a client-side timeout;
        # the server may continue executing an operation after the client
        # aborts it with the SocketTimeout exception.
        # (default: nil, meaning no timeout)
        # socket_timeout: 5

        # The name of the replica set to connect to. Servers provided as seeds that do
        # not belong to this replica set will be ignored.
        # replica_set: name

        # Compressors to use for wire protocol compression. (default is to not use compression)
        # &quot;zstd&quot; requires zstd-ruby gem. &quot;snappy&quot; requires snappy gem.
        # Refer to: https://www.mongodb.com/docs/ruby-driver/current/reference/create-client/#compression
        # compressors: [&quot;zstd&quot;, &quot;snappy&quot;, &quot;zlib&quot;]

        # Whether to connect to the servers via ssl. (default: false)
        # ssl: true

        # The certificate file used to identify the connection against MongoDB.
        # ssl_cert: /path/to/my.cert

        # The private keyfile used to identify the connection against MongoDB.
        # Note that even if the key is stored in the same file as the certificate,
        # both need to be explicitly specified.
        # ssl_key: /path/to/my.key

        # A passphrase for the private key.
        # ssl_key_pass_phrase: password

        # Whether to do peer certification validation. (default: true)
        # ssl_verify: true

        # The file containing concatenated certificate authority certificates
        # used to validate certs passed from the other end of the connection.
        # ssl_ca_cert: /path/to/ca.cert

        # Whether to truncate long log lines. (default: true)
        # truncate_logs: true

  # Configure Mongoid-specific options. (optional)
  options:
    # Allow BSON::Decimal128 to be parsed and returned directly in
    # field values. When BSON 5 is present and the this option is set to false
    # (the default), BSON::Decimal128 values in the database will be returned
    # as BigDecimal.
    #
    # @note this option only has effect when BSON 5+ is present. Otherwise,
    #   the setting is ignored.
    # allow_bson5_decimal128: false

    # Application name that is printed to the MongoDB logs upon establishing
    # a connection. Note that the name cannot exceed 128 bytes in length.
    # It is also used as the database name if the database name is not
    # explicitly defined. (default: nil)
    # app_name: nil

    # When this flag is false, callbacks for embedded documents will not be
    # called. This is the default in 9.0.
    #
    # Setting this flag to true restores the pre-9.0 behavior, where callbacks
    # for embedded documents are called. This may lead to stack overflow errors
    # if there are more than cicrca 1000 embedded documents in the root
    # document&#39;s dependencies graph.
    # See https://jira.mongodb.org/browse/MONGOID-5658 for more details.
    # around_callbacks_for_embeds: false

    # Sets the async_query_executor for the application. By default the thread pool executor
    # is set to `:immediate`. Options are:
    #
    #   - :immediate - Initializes a single +Concurrent::ImmediateExecutor+
    #   - :global_thread_pool - Initializes a single +Concurrent::ThreadPoolExecutor+
    #      that uses the +async_query_concurrency+ for the +max_threads+ value.
    # async_query_executor: :immediate

    # Mark belongs_to associations as required by default, so that saving a
    # model with a missing belongs_to association will trigger a validation
    # error.
    # belongs_to_required_by_default: true

    # Set the global discriminator key.
    # discriminator_key: &quot;_type&quot;

    # Raise an exception when a field is redefined.
    # duplicate_fields_exception: false

    # Defines how many asynchronous queries can be executed concurrently.
    # This option should be set only if `async_query_executor` is set
    # to `:global_thread_pool`.
    # global_executor_concurrency: nil

    # When this flag is true, any attempt to change the _id of a persisted
    # document will raise an exception ({Errors::ImmutableAttribute}).
    # This is the default in 9.0. Setting this flag to false restores the
    # pre-9.0 behavior, where changing the _id of a persisted
    # document might be ignored, or it might work, depending on the situation.
    # immutable_ids: true

    # Include the root model name in json serialization.
    # include_root_in_json: false

    # # Include the _type field in serialization.
    # include_type_for_serialization: false

    # Whether to join nested persistence contexts for atomic operations
    # to parent contexts by default.
    # join_contexts: false

    # When this flag is false (the default as of Mongoid 9.0), a document that
    # is created or loaded will remember the storage options that were active
    # when it was loaded, and will use those same options by default when
    # saving or reloading itself.
    #
    # When this flag is true you&#39;ll get pre-9.0 behavior, where a document will
    # not remember the storage options from when it was loaded/created, and
    # subsequent updates will need to explicitly set up those options each time.
    #
    # For example:
    #
    #    record = Model.with(collection: &#39;other_collection&#39;) { Model.first }
    #
    # This will try to load the first document from &#39;other_collection&#39; and
    # instantiate it as a Model instance. Pre-9.0, the record object would
    # not remember that it came from &#39;other_collection&#39;, and attempts to
    # update it or reload it would fail unless you first remembered to
    # explicitly specify the collection every time.
    #
    # As of Mongoid 9.0, the record will remember that it came from
    # &#39;other_collection&#39;, and updates and reloads will automatically default
    # to that collection, for that record object.
    # legacy_persistence_context_behavior: false

    # When this flag is false, a document will become read-only only once the
    # #readonly! method is called, and an error will be raised on attempting
    # to save or update such documents, instead of just on delete. When this
    # flag is true, a document is only read-only if it has been projected
    # using #only or #without, and read-only documents will not be
    # deletable/destroyable, but they will be savable/updatable.
    # When this feature flag is turned on, the read-only state will be reset on
    # reload, but when it is turned off, it won&#39;t be.
    # legacy_readonly: false

    # The log level.
    #
    # It must be set prior to referencing clients or Mongo.logger,
    # changes to this option are not be propagated to any clients and
    # loggers that already exist.
    #
    # Additionally, only when the clients are configured via the
    # configuration file is the log level given by this option honored.
    # log_level: :info

    # Store BigDecimals as Decimal128s instead of strings in the db.
    # map_big_decimal_to_decimal128: true

    # Preload all models in development, needed when models use inheritance.
    # preload_models: false

    # When this flag is true, callbacks for every embedded document will be
    # called only once, even if the embedded document is embedded in multiple
    # documents in the root document&#39;s dependencies graph.
    # This is the default in 9.0. Setting this flag to false restores the
    # pre-9.0 behavior, where callbacks are called for every occurrence of an
    # embedded document. The pre-9.0 behavior leads to a problem that for multi
    # level nested documents callbacks are called multiple times.
    # See https://jira.mongodb.org/browse/MONGOID-5542
    # prevent_multiple_calls_of_embedded_callbacks: true

    # Raise an error when performing a #find and the document is not found.
    # raise_not_found_error: true

    # Raise an error when defining a scope with the same name as an
    # existing method.
    # scope_overwrite_exception: false

    # Return stored times as UTC.
    # use_utc: false

  # Configure Driver-specific options. (optional)
  driver_options:
    # When this flag is off, an aggregation done on a view will be executed over
    # the documents included in that view, instead of all documents in the
    # collection. When this flag is on, the view filter is ignored.
    # broken_view_aggregate: true

    # When this flag is set to false, the view options will be correctly
    # propagated to readable methods.
    # broken_view_options: true

    # When this flag is set to true, the update and replace methods will
    # validate the parameters and raise an error if they are invalid.
    # validate_update_replace: false
</code></pre>

<h2>Version Based Defaults [load-defaults]</h2>

<p>Mongoid supports setting the configuration options to the defaults for specific
versions. This is useful for upgrading to a new Mongoid version. When upgrading
your Mongoid version, the following should be set on <a href="Mongoid/Config.html" title="Mongoid::Config (module)"><code>::Mongoid::Config</code></a>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_configure'><a href="Mongoid.html#configure-instance_method" title="Mongoid#configure (method)">configure</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_load_defaults'>load_defaults</span> <span class='op'>&lt;</span><span class='const'>OLD</span> <span class='const'>VERSION</span><span class='op'>&gt;</span>
<span class='kw'>end</span></code></pre>

<p>This way, when upgrading to a new version of Mongoid, your code will run with
the configuration options from the previous version of Mongoid. Then,
one-by-one, you can change the feature flags for the new version, and test that
your code still acts as expected. Once all of the new feature flags have been
accounted for, the call to <code>load_defaults</code> may be changed to take in the <em>new</em>
version, and all of the changed feature flags may be removed.</p>

<p>For example, suppose we&#39;re upgrading from 7.5 to 8.0. Between these two versions,
two feature flags were added: <code>legacy_attributes</code> and <code>map_big_decimal_to_decimal128</code>.
Before upgrading to Mongoid 8, add the following to your <a href="Mongoid/Config.html" title="Mongoid::Config (module)"><code>::Mongoid::Config</code></a>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_configure'><a href="Mongoid.html#configure-instance_method" title="Mongoid#configure (method)">configure</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_load_defaults'>load_defaults</span> <span class='float'>7.5</span>
<span class='kw'>end</span></code></pre>

<p>After upgrading to Mongoid 8.0 in your <code>Gemfile</code>, any feature flags will
remain set to their 7.5 default behavior: <code>legacy_attributes: true, map_big_decimal_to_decimal128: false</code>. You may then flip these feature flags
one-by-one to their 8.0 behavior:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_configure'><a href="Mongoid.html#configure-instance_method" title="Mongoid#configure (method)">configure</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_load_defaults'>load_defaults</span> <span class='float'>7.5</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_legacy_attributes'>legacy_attributes</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='comment'># config.map_big_decimal_to_decimal128 = true
</span><span class='kw'>end</span></code></pre>

<p>We recommend do these one at a time, so in the example above we leave the
second flag commented out. After verifying your code works as expected with the
<code>legacy_attributes</code> flag turned off, the <code>map_big_decimal_to_decimal128</code>
setting can be uncommented. Once that functionality is verified as well, both
of those lines can be removed and the <code>load_defaults</code> replaced with:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_configure'><a href="Mongoid.html#configure-instance_method" title="Mongoid#configure (method)">configure</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_load_defaults'>load_defaults</span> <span class='float'>8.0</span>
<span class='kw'>end</span></code></pre>

<h2>ERb Preprocessing</h2>

<p>When loading a configuration file, Mongoid processes it with ERb before
parsing it as YAML. This allows, for example, constructing the contents of
the configuration file at runtime based on environment variables:</p>

<pre class="code yaml"><code class="yaml">development:
  clients:
    default:
      uri: &quot;&lt;%= ENV[&#39;MONGODB_URI&#39;] %&gt;&quot;
</code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>When outputting values from ERb, ensure the values are valid YAML and
escape them as needed.</p>

<p></div></p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Since ERb rendering is performed prior to YAML parsing, all ERb directives
in the configuration file are evaluated, including those occurring in YAML
comments.</p>

<p></div></p>

<h2>Logging</h2>

<p>When configuring logging, it is important to keep in mind that Mongoid
provides a model layer on top of the MongoDB Ruby driver, and the driver
dispatches the CRUD operations to the MongoDB deployment. Therefore, some
of the logging output in an application using Mongoid comes from Mongoid
itself, and some comes from the driver.</p>

<p>The Mongo client is a Ruby driver client instance, therefore
the logger of a Mongo client is the Ruby driver logger, not the Mongoid
logger. In other words:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Ruby driver logger, not Mongoid logger
</span><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_client'><a href="Mongoid.html#client-instance_method" title="Mongoid#client (method)">client</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_default'>default</span>).<span class='id identifier rubyid_logger'>logger</span></code></pre>

<p>Depending on whether Mongoid is used in a Ruby on Rails application, and how
both Mongoid and Ruby driver are configured, they may use the same logger
instance or different instances, potentially with different configurations.</p>

<h3>In Ruby on Rails Application</h3>

<p>When used in a Ruby on Rails application, Mongoid by default inherits
the logger and the log level from Rails, and sets the driver&#39;s logger
to the same logger instance:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'>logger</span> <span class='op'>===</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_logger'><a href="Mongoid/Loggable.html#logger-instance_method" title="Mongoid::Loggable#logger (method)">logger</a></span>
<span class='comment'># =&gt; true
</span>
<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_logger'><a href="Mongoid/Loggable.html#logger-instance_method" title="Mongoid::Loggable#logger (method)">logger</a></span> <span class='op'>===</span> <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>Logger</span>.<span class='id identifier rubyid_logger'>logger</span>
<span class='comment'># =&gt; true</span></code></pre>

<p>To change the log level, use <a href="https://guides.rubyonrails.org/debugging_rails_applications.html#log-levels">standard Rails configuration</a>.
Place the following in one of environment configuration files, such as
<code>config/environments/production.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'>application</span>.<span class='id identifier rubyid_configure'>configure</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_log_level'>log_level</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_debug'>debug</span>
<span class='kw'>end</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>The <code>log_level</code> Mongoid configuration option is not used when Mongoid operates
in a Rails application, because Mongoid inherits Rails&#39; log level in this case.</p>

<p></div></p>

<p>To configure either Mongoid or driver logger differently from the Rails logger,
use an initializer as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'>application</span>.<span class='id identifier rubyid_configure'>configure</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_after_initialize'>after_initialize</span> <span class='kw'>do</span>
    <span class='comment'># Change Mongoid log destination and/or level
</span>    <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_logger'><a href="Mongoid/Loggable.html#logger-instance_method" title="Mongoid::Loggable#logger (method)">logger</a></span> <span class='op'>=</span> <span class='const'>Logger</span>.<span class='id identifier rubyid_new'>new</span>(<span class='const'>STDERR</span>).<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_logger'>logger</span><span class='op'>|</span>
      <span class='id identifier rubyid_logger'>logger</span>.<span class='id identifier rubyid_level'>level</span> <span class='op'>=</span> <span class='const'>Logger</span><span class='op'>::</span><span class='const'>DEBUG</span>
    <span class='kw'>end</span>

    <span class='comment'># Change driver log destination and/or level
</span>    <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>Logger</span>.<span class='id identifier rubyid_logger'>logger</span> <span class='op'>=</span> <span class='const'>Logger</span>.<span class='id identifier rubyid_new'>new</span>(<span class='const'>STDERR</span>).<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_logger'>logger</span><span class='op'>|</span>
      <span class='id identifier rubyid_logger'>logger</span>.<span class='id identifier rubyid_level'>level</span> <span class='op'>=</span> <span class='const'>Logger</span><span class='op'>::</span><span class='const'>DEBUG</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>There is currently no provision in the Ruby standard library <code>Logger</code>
to return the log device (i.e. the <code>IO</code> object) that a logger is using.
To have, for example, Mongoid and/or the Ruby driver log to the
standard Rails log file (e.g. <code>log/development.log</code>) but with a
different level from standard Rails logger (<code>Rails.logger</code>), the
file must be opened separately and the resulting <code>IO</code> object passed to
the <code>Logger</code> constructor.</p>

<p></div></p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Since by default Mongoid sets its own logger and the driver&#39;s logger to the
same instance as the Rails logger, modifying any of the instances affects
all of them. For example the following changes log level for all three
loggers, unless the application assigned a separate <code>Logger</code> instance
to <code>Mongo::Logger.logger</code> as described above:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'>Logger</span>.<span class='id identifier rubyid_logger'>logger</span>.<span class='id identifier rubyid_level'>level</span> <span class='op'>=</span> <span class='const'>Logger</span><span class='op'>::</span><span class='const'>DEBUG</span></code></pre>

<p></div></p>

<h3>Standalone</h3>

<p>When not loaded in a Ruby on Rails application, Mongoid respects the
<code>log_level</code> top level configuration option. It can be given in the
configuration file as follows:</p>

<pre class="code yaml"><code class="yaml">development:
  clients:
    default:
      # ...
  options:
    log_level: :debug
</code></pre>

<p>... or when configuring Mongoid inline:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_configure'><a href="Mongoid.html#configure-instance_method" title="Mongoid#configure (method)">configure</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_log_level'>log_level</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_debug'>debug</span>
<span class='kw'>end</span></code></pre>

<p>The default log destination in Mongoid 7.1 and higher is standard error.
The default log destination in Mongoid 7.0 and lower is standard output.
To change the log destination, create a new logger instance as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_logger'><a href="Mongoid/Loggable.html#logger-instance_method" title="Mongoid::Loggable#logger (method)">logger</a></span> <span class='op'>=</span> <span class='const'>Logger</span>.<span class='id identifier rubyid_new'>new</span>(<span class='const'>STDERR</span>).<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_logger'>logger</span><span class='op'>|</span>
  <span class='id identifier rubyid_logger'>logger</span>.<span class='id identifier rubyid_level'>level</span> <span class='op'>=</span> <span class='const'>Logger</span><span class='op'>::</span><span class='const'>DEBUG</span>
<span class='kw'>end</span></code></pre>

<p>To change the Ruby driver log level or destination:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Mongo</span><span class='op'>::</span><span class='const'>Logger</span>.<span class='id identifier rubyid_logger'>logger</span> <span class='op'>=</span> <span class='const'>Logger</span>.<span class='id identifier rubyid_new'>new</span>(<span class='const'>STDERR</span>).<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_logger'>logger</span><span class='op'>|</span>
  <span class='id identifier rubyid_logger'>logger</span>.<span class='id identifier rubyid_level'>level</span> <span class='op'>=</span> <span class='const'>Logger</span><span class='op'>::</span><span class='const'>DEBUG</span>
<span class='kw'>end</span></code></pre>

<p>To set the driver logger to be the same as the Mongoid logger:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Mongo</span><span class='op'>::</span><span class='const'>Logger</span>.<span class='id identifier rubyid_logger'>logger</span> <span class='op'>=</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_logger'><a href="Mongoid/Loggable.html#logger-instance_method" title="Mongoid::Loggable#logger (method)">logger</a></span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Mongoid does not alter the driver&#39;s logger when running in
standalone mode.</p>

<p></div></p>

<h2>Time Zones</h2>

<p>Mongoid uses ActiveSupport&#39;s time zone functionality, which is far
more robust than Ruby&#39;s standard library. Importantly, ActiveSupport
allows configuration of <code>Time.zone</code>, a thread-global variable which
provides context for working with date and time values.</p>

<p>While a thorough treatment of time zones in Ruby is outside the scope
of this tutorial, the easiest and most reliable way of achieving correct
time zone handling is as follows:</p>

<ol>
<li> Set the operating system&#39;s time zone to UTC. For example, on Linux:</li>
</ol>

<pre class="code bash"><code class="bash">cp /usr/share/zoneinfo/UTC /etc/localtime
</code></pre>

<ol>
<li> Set your application default time zone to UTC:</li>
</ol>

<pre class="code ruby"><code class="ruby"><span class='comment'># If using Rails, in application.rb:
</span><span class='kw'>class</span> <span class='const'>Application</span> <span class='op'>&lt;</span> <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span><span class='op'>::</span><span class='const'>Application</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_time_zone'>time_zone</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UTC</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='comment'># If not using Rails:
</span><span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_zone'>zone</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UTC</span><span class='tstring_end'>&#39;</span></span></code></pre>

<ol>
<li> In each controller and job class, set the appropriate time zone in a
<code>before_filter</code> at the earliest possible stage. As an example,
if each user of your application can set their own time zone,
you may wish to do:</li>
</ol>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'>ActionController</span><span class='op'>::</span><span class='const'>Base</span>
  <span class='id identifier rubyid_before_filter'>before_filter</span> <span class='symbeg'>:</span><span class='id identifier rubyid_fetch_user'>fetch_user</span><span class='comma'>,</span>
                <span class='symbeg'>:</span><span class='id identifier rubyid_set_time_zone'>set_time_zone</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_set_time_zone'>set_time_zone</span>
    <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_zone'>zone</span> <span class='op'>=</span> <span class='ivar'>@user</span>.<span class='id identifier rubyid_time_zone'>time_zone</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<ol>
<li> From here, you may work with times naturally in the local time zone.
For example, in a view:</li>
</ol>

<pre class="code ruby"><code class="ruby"><span class='const'>Turned</span> <span class='id identifier rubyid_into'>into</span> <span class='id identifier rubyid_a'>a</span> <span class='id identifier rubyid_pumpkin'>pumpkin</span> <span class='id identifier rubyid_after'>after</span> <span class='op'>&lt;</span><span class='tstring'><span class='tstring_beg'>%=</span><span class='tstring_content'> cinderella.updated_at.seconds_after_midnight %&gt; seconds!</span></code></pre>

<ol>
<li> Use ActiveSupport methods instead of the Ruby standard library.</li>
</ol>

<pre class="code ruby"><code class="ruby"><span class='op'>-</span>   {<span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_zone'>zone</span>.<span class='id identifier rubyid_now'>now</span>} <span class='kw'>or</span> <span class='op'>&lt;</span><span class='id identifier rubyid_span'>span</span> <span class='kw'>class</span><span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title-ref</span><span class='tstring_end'>&quot;</span></span><span class='op'>&gt;</span><span class='CHAR'>\</span><span class='backtick'>`</span><span class='tstring_content'>Time.current&lt;/span&gt; instead of {Time.now}
-   {Date.current} instead of {Date.today}

Critically, note that the latter Ruby standard library methods reference
your system time zone (e.g. UTC) and not the value of {Time.zone}.
As it is very easy to mistake these similarly named methods, we recommend to
use [Rubocop&#39;s Rails/TimeZone cop](https://docs.rubocop.org/rubocop-rails/cops_rails.html#railstimezone) in your CI.</span></code></pre>

<h3>Setting time zone on data loaded from MongoDB</h3>

<p>MongoDB stores all times in UTC without time zone information.
Mongoid models load and returns time values as instances of
<a href="ActiveSupport/TimeWithZone.html" title="ActiveSupport::TimeWithZone (class)"><code>::ActiveSupport::TimeWithZone</code></a>. You may set the <code>use_utc</code> option
to control how Mongoid sets the time zone when loading from the database:</p>

<ul>
<li>  If false (default), Mongoid will use <code>Time.zone</code> to set the time
zone of time values are loaded from database.</li>
<li>  If true, Mongoid will always set the time zone as UTC on loaded
time values.</li>
</ul>

<p><code>use_utc</code> only affects how data is loaded, and does not affect
how data is persisted. For example, if you assign a <a href="Time.html" title="Time (class)"><code>Time</code></a> or
<a href="ActiveSupport/TimeWithZone.html" title="ActiveSupport::TimeWithZone (class)"><code>::ActiveSupport::TimeWithZone</code></a> instance to a time field, the time
zone information of the assigned instance always will be used
irrespective of the <code>use_utc</code> setting. Alternatively, if you
assign a string value to a time field, any time zone information
in the string will be used if present. If the string does not include
time zone information it will be parsed according to <code>Time.zone</code>.
To illustrate:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_use_zone'>use_zone</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Asia/Kolkata</span><span class='tstring_end'>&quot;</span></span>) <span class='kw'>do</span>

  <span class='comment'># String does not include time zone, so &quot;Asia/Kolkata&quot; will be used
</span>  <span class='id identifier rubyid_ghandi'>ghandi</span>.<span class='id identifier rubyid_born_at'>born_at</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1869-10-02 7:10 PM</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Time zone in string (-0600) will be used
</span>  <span class='id identifier rubyid_amelia'>amelia</span>.<span class='id identifier rubyid_born_at'>born_at</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1897-07-24 11:30 -0600</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<h2>Configuring <code>SSLContext</code></h2>

<p>It may be desirable to further configure TLS options in your application, for
example by enabling or disabling certain ciphers.</p>

<p>This can be done by setting TLS context hooks on the Ruby driver -- TLS context
hooks are user-provided <code>Proc</code>(s) that will be invoked before any TLS socket
connection in the driver and can be used to modify the underlying
<code>OpenSSL::SSL::SSLContext</code> object used by the socket.</p>

<p>To set TLS context hooks, add <code>Proc</code>(s) to the <code>Mongo.tls_context_hooks</code>
array. This can be done in an initializer. The example below adds a hook
that only enables the &quot;AES256-SHA&quot; cipher.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Mongo</span>.<span class='id identifier rubyid_tls_context_hooks'>tls_context_hooks</span>.<span class='id identifier rubyid_push'>push</span>(
  <span class='const'>Proc</span>.<span class='id identifier rubyid_new'>new</span> { <span class='op'>|</span><span class='id identifier rubyid_context'>context</span><span class='op'>|</span>
    <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_ciphers'>ciphers</span> <span class='op'>=</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>AES256-SHA</span><span class='tstring_end'>&quot;</span></span>]
  }
)

<span class='comment'># Only the AES256-SHA cipher will be enabled from this point forward</span></code></pre>

<p>Every <code>Proc</code> in <code>Mongo.tls_context_hooks</code> will be passed an
<code>OpenSSL::SSL::SSLContext</code> object as its sole argument. These procs will
be executed sequentially during socket creation.</p>

<div class="warning" markdown="1">

<div class="title" markdown="1">

Warning

</div>

<p>TLS context hooks are global and will affect all <code>Mongo::Client</code> instances
in an application.</p>

<p></div></p>

<p>For more information about TLS context hooks, including best practices for
assigning and removing them, see <a href="https://mongodb.com/docs/ruby-driver/current/reference/create-client/#modifying-sslcontext">the Ruby driver documentation</a>.</p>

<h2>Network Compression</h2>

<p>Mongoid supports compression of messages to and from MongoDB servers. This functionality is provided by
the Ruby driver, which implements the three algorithms that are supported by MongoDB servers:</p>

<ul>
<li>  <a href="https://google.github.io/snappy/">Snappy</a>: <code>snappy</code> compression
can be used when connecting to MongoDB servers starting with the 3.4 release,
and requires the <a href="https://rubygems.org/gems/snappy">snappy</a> library to be
installed.</li>
<li>  <a href="https://zlib.net/">Zlib</a>: <code>zlib</code> compression can be used when
connecting to MongoDB servers starting with the 3.6 release.</li>
<li>  <a href="https://facebook.github.io/zstd/">Zstandard</a>: <code>zstd</code> compression can be
used when connecting to MongoDB servers starting with the 4.2 release, and
requires the <a href="https://rubygems.org/gems/zstd-ruby">zstd-ruby</a> library to
be installed.</li>
</ul>

<p>To use wire protocol compression, configure the Ruby driver options within <code>mongoid.yml</code>:</p>

<pre class="code yaml"><code class="yaml">development:
  # Configure available database clients. (required)
  clients:
    # Define the default client. (required)
    default:
      # ...
      options:
        # These options are Ruby driver options, documented in
        # https://mongodb.com/docs/ruby-driver/current/reference/create-client/
        # ...
        # Compressors to use. (default is to not use compression)
        # Valid values are zstd, zlib or snappy - or any combination of the three
        compressors: [&quot;zstd&quot;, &quot;snappy&quot;]
</code></pre>

<p>If no compressors are explicitly requested, the driver will not use compression,
even if the required dependencies for one or more compressors are present on the
system.</p>

<p>The driver chooses the first compressor of the ones requested that is also supported
by the server. The <code>zstd</code> compressor is recommended as it produces the highest
compression at the same CPU consumption compared to the other compressors.</p>

<p>For maximum server compatibility all three compressors can be specified, e.g.
as <code>compressors: [&quot;zstd&quot;, &quot;snappy&quot;, &quot;zlib&quot;]</code>.</p>

<h2>Client-Side Encryption</h2>

<p>When loading the configuration file, Mongoid permits the file to contain
<a href="BSON/Binary.html" title="BSON::Binary (class)"><code>::BSON::Binary</code></a> instances which are used for specifying <code>keyId</code> in
the schema map for <a href="https://www.mongodb.com/docs/ruby-driver/current/reference/in-use-encryption/client-side-encryption/">client-side encryption</a>,
as the following example shows:</p>

<pre class="code yaml"><code class="yaml">development:
  clients:
    default:
      database: blog_development
      hosts: [localhost:27017]
      options:
        auto_encryption_options:
          key_vault_namespace: &#39;keyvault.datakeys&#39;
          kms_providers:
            local:
              key: &quot;z7iYiYKLuYymEWtk4kfny1ESBwwFdA58qMqff96A8ghiOcIK75lJGPUIocku8LOFjQuEgeIP4xlln3s7r93FV9J5sAE7zg8U&quot;
          schema_map:
            blog_development.comments:
              properties:
                message:
                  encrypt:
                    keyId:
                      - !ruby/object:BSON::Binary
                        data: !binary |-
                          R/AgNcxASFiiJWKXqWGo5w==
                        type: :uuid
                    bsonType: &quot;string&quot;
                    algorithm: &quot;AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic&quot;
              bsonType: &quot;object&quot;
</code></pre>

<h2>Usage with Forking Servers</h2>

<p>When using Mongoid with a forking web server such as Puma, Unicorn or
Passenger, it is recommended to not perform any operations on Mongoid models
in the parent process prior to the fork.</p>

<p>When a process forks, Ruby threads are not transferred to the child processes
and the Ruby driver Client objects lose their background monitoring. The
application will typically seem to work just fine until the deployment
state changes (for example due to network errors, a maintenance event) at
which point the application is likely to start getting <code>NoServerAvailable</code>
exception when performing MongoDB operations.</p>

<p>If the parent process needs to perform operations on the MongoDB database,
reset all clients in the workers after they forked. How to do so depends
on the web server being used.</p>

<p>If the parent process does not need to perform operations on the MongoDB
database after child processes are forked, close the clients in the parent
prior to forking children. If the parent process performs operations on a Mongo
client and does not close it, the parent process will continue consuming a
connection slot in the cluster and will continue monitoring the cluster for
as long as the parent remains alive.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>The close/reconnect pattern described here should be used with Ruby driver
version 2.6.2 or higher. Previous driver versions did not recreate
monitoring threads when reconnecting.</p>

<p></div></p>

<h3>Puma</h3>

<p>Use the <code>on_worker_boot</code> hook to reconnect clients in the workers and
the <code>before_fork</code> hook to close clients in the parent process
(<a href="https://puma.io/puma/">Puma documentation</a>):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_on_worker_boot'>on_worker_boot</span> <span class='kw'>do</span>
  <span class='kw'>if</span> <span class='kw'>defined?</span>(<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>)
    <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Clients.html" title="Mongoid::Clients (module)">Clients</a></span>.<span class='id identifier rubyid_clients'><a href="Mongoid/Clients.html#clients-class_method" title="Mongoid::Clients.clients (method)">clients</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_client'>client</span><span class='op'>|</span>
      <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_close'>close</span>
      <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_reconnect'>reconnect</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Mongoid is not loaded. You may have forgotten to enable app preloading.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_before_fork'>before_fork</span> <span class='kw'>do</span>
  <span class='kw'>if</span> <span class='kw'>defined?</span>(<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>)
    <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_disconnect_clients'><a href="Mongoid.html#disconnect_clients-instance_method" title="Mongoid#disconnect_clients (method)">disconnect_clients</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Unicorn</h3>

<p>Use the <code>after_fork</code> hook to reconnect clients in the workers and
the <code>before_fork</code> hook to close clients in the parent process
(<a href="https://yhbt.net/unicorn/Unicorn/Configurator.html">Unicorn documentation</a>):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_after_fork'>after_fork</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_worker'>worker</span><span class='op'>|</span>
  <span class='kw'>if</span> <span class='kw'>defined?</span>(<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>)
    <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Clients.html" title="Mongoid::Clients (module)">Clients</a></span>.<span class='id identifier rubyid_clients'><a href="Mongoid/Clients.html#clients-class_method" title="Mongoid::Clients.clients (method)">clients</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_client'>client</span><span class='op'>|</span>
      <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_close'>close</span>
      <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_reconnect'>reconnect</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Mongoid is not loaded. You may have forgotten to enable app preloading.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_before_fork'>before_fork</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_worker'>worker</span><span class='op'>|</span>
  <span class='kw'>if</span> <span class='kw'>defined?</span>(<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>)
    <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_disconnect_clients'><a href="Mongoid.html#disconnect_clients-instance_method" title="Mongoid#disconnect_clients (method)">disconnect_clients</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Passenger</h3>

<p>Use the <code>starting_worker_process</code> hook to reconnect clients in the workers
(<a href="https://www.phusionpassenger.com/library/indepth/ruby/spawn_methods/#unintentional-file-descriptor-sharing">Passenger documentation</a>).
Passenger does not appear to have a hook that is invoked in the parent process
before the workers are forked.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>if</span> <span class='kw'>defined?</span>(<span class='const'>PhusionPassenger</span>)
  <span class='const'>PhusionPassenger</span>.<span class='id identifier rubyid_on_event'>on_event</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_starting_worker_process'>starting_worker_process</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_forked'>forked</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_forked'>forked</span>
      <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Clients.html" title="Mongoid::Clients (module)">Clients</a></span>.<span class='id identifier rubyid_clients'><a href="Mongoid/Clients.html#clients-class_method" title="Mongoid::Clients.clients (method)">clients</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_client'>client</span><span class='op'>|</span>
        <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_close'>close</span>
        <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_reconnect'>reconnect</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h2>Query Cache Middleware</h2>

<h3>Enabling Query Cache for Rack Web Requests</h3>

<p>The MongoDB Ruby Driver provides a Rack middleware which enables the <code>Query Cache
&lt;query-cache&gt;</code> for the duration of each web request. Below is an example of
how to enable the Query Cache Middleware in a Ruby on Rails application:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/application.rb
</span>
<span class='comment'># Add Mongo::QueryCache::Middleware at the bottom of the middleware stack
</span><span class='comment'># or before other middleware that queries MongoDB.
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_middleware'>middleware</span>.<span class='id identifier rubyid_use'>use</span> <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>QueryCache</span><span class='op'>::</span><span class='const'>Middleware</span></code></pre>

<p>Please refer to the <a href="https://guides.rubyonrails.org/rails_on_rack.html#configuring-middleware-stack">Rails on Rack guide</a>
for more information about using Rack middleware in Rails applications.</p>

<h3>Enabling Query Cache for ActiveJob</h3>

<p>The MongoDB Ruby Driver also provides Query Cache middleware for ActiveJob.
You may enable it for all jobs in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/initializers/active_job.rb
</span>
<span class='comment'># Enable Mongo driver query cache for ActiveJob
</span><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span>.<span class='id identifier rubyid_on_load'>on_load</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_active_job'>active_job</span>) <span class='kw'>do</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>QueryCache</span><span class='op'>::</span><span class='const'>Middleware</span><span class='op'>::</span><span class='const'>ActiveJob</span>
<span class='kw'>end</span></code></pre>

<p>Or for a specific job class:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MyJob</span> <span class='op'>&lt;</span> <span class='const'>ActiveJob</span><span class='op'>::</span><span class='const'>Base</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>QueryCache</span><span class='op'>::</span><span class='const'>Middleware</span><span class='op'>::</span><span class='const'>ActiveJob</span>
<span class='kw'>end</span></code></pre>

<h2>Development Configuration</h2>

<p>Driver&#39;s default configuration is suitable for production deployment.
In development, some settings can be adjusted to provide a better developer
experience.</p>

<ul>
<li>  <code>:server_selection_timeout</code>: set this to a low value (e.g., <code>1</code>)
if your MongoDB server is running locally and you start it manually. A low
server selection timeout will cause the driver to fail quickly when there is
no server running.</li>
</ul>

<p>Sample recommended development configuration:</p>

<pre class="code yaml"><code class="yaml">development:
  clients:
    default:
      database: mongoid
      hosts:
        - localhost:27017
      options:
        server_selection_timeout: 1
</code></pre>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>