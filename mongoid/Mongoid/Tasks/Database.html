<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: Mongoid::Tasks::Database &mdash; Mongoid master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongoid::Tasks::Database",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongoid master</a> &raquo; 
      <a href='../../_index.html#alpha_D'>Index (D)</a> &raquo; 
        <a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a> &raquo; 
        <a href="../Tasks.html" title="Mongoid::Tasks (module)">Tasks</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Database&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: Mongoid::Tasks::Database</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L9'>lib/mongoid/tasks/database.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Utility module to manage database collections, indexes, sharding, etc. Invoked from Rake tasks.</p>

  </div>
</div>
</div>
<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#create_collections-instance_method" title="#create_collections (instance method)">#<strong>create_collections</strong>(models = ::Mongoid.models, force: false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Create collections for each model given the provided globs and the class is not embedded.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#create_indexes-instance_method" title="#create_indexes (instance method)">#<strong>create_indexes</strong>(models = ::Mongoid.models)  &#x21d2; Array&lt;Class&gt; </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Create indexes for each model given the provided globs and the class is not embedded.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#create_search_indexes-instance_method" title="#create_search_indexes (instance method)">#<strong>create_search_indexes</strong>(models = ::Mongoid.models, wait: true)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Submit requests for the search indexes to be created.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#remove_indexes-instance_method" title="#remove_indexes (instance method)">#<strong>remove_indexes</strong>(models = ::Mongoid.models)  &#x21d2; Array&lt;Class&gt; </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Remove indexes for each model given the provided globs and the class is not embedded.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#remove_search_indexes-instance_method" title="#remove_search_indexes (instance method)">#<strong>remove_search_indexes</strong>(models = ::Mongoid.models)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Remove all search indexes from the given models.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#remove_undefined_indexes-instance_method" title="#remove_undefined_indexes (instance method)">#<strong>remove_undefined_indexes</strong>(models = ::Mongoid.models)  &#x21d2; Hash{Class =&gt; Array(Hash)} </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Remove indexes that exist in the database but aren’t specified on the models.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#shard_collections-instance_method" title="#shard_collections (instance method)">#<strong>shard_collections</strong>(models = ::Mongoid.models)  &#x21d2; Array&lt;Class&gt; </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Shard collections for models that declare shard keys.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#undefined_indexes-instance_method" title="#undefined_indexes (instance method)">#<strong>undefined_indexes</strong>(models = ::Mongoid.models)  &#x21d2; Array&lt;Hash&gt; </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Return the list of indexes by model that exist in the database but aren’t specified on the models.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#logger-instance_method" title="#logger (instance method)">#<strong>logger</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#wait_for_search_indexes-instance_method" title="#wait_for_search_indexes (instance method)">#<strong>wait_for_search_indexes</strong>(models)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Waits for the search indexes to be built on the given models.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="create_collections-instance_method">
  <h3 class='signature  first'>
    #<strong>create_collections</strong>(models = ::Mongoid.models, force: false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Create collections for each model given the provided globs and the class is not embedded.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>models.</span>
    <span class='type'>(<a href="../../Array.html" title="Array (class)">Array</a>&lt;<a href="../Document.html" title="Mongoid::Document (module)">Mongoid::Document</a>&gt;)</span>
&mdash;    <div class='inline'>
<p><a href="../../Array.html" title="Array (class)"><code>::Array</code></a> of document classes for which collections should be created. Defaulted to all document classes in the application.</p>
</div>
  </li>
  <li>
    <span class='name'>force</span>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>If true, the method will drop existing collections before creating new ones. If false, the method will create only new collection (that do not exist in the database).</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L21-L33'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='21' data-end='33'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/tasks/database.rb', line 21</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_create_collections'>create_collections</span>(<span class='id identifier rubyid_models'>models</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_models'>models</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_models'>models</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_model'>model</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_embedded?'>embedded?</span> <span class='op'>||</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_cyclic?'>cyclic?</span>
      <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_create_collection'>create_collection</span>(<span class='label'>force:</span> <span class='id identifier rubyid_force'>force</span>)
      <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: Created collection for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>else</span>
      <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: collection options ignored on: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_content'>, please define in the root model.</span><span class='tstring_end'>&quot;</span></span>)
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'>Exception</span>
    <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error while creating collection for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="create_indexes-instance_method">
  <h3 class='signature '>
    #<strong>create_indexes</strong>(models = ::Mongoid.models)  &#x21d2; <a href="../../Array.html" title="Array (class)">Array</a>&lt;<code>Class</code>&gt; 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Create indexes for each model given the provided globs and the class is not embedded.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Create all the indexes.</p>
</div></p>
      <pre class='example code ruby'><code><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="../Tasks.html" title="Mongoid::Tasks (module)">Tasks</a></span><span class='op'>::</span><span class='const'>Database</span>.<span class='id identifier rubyid_create_indexes'>create_indexes</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../../Array.html" title="Array (class)">Array</a>&lt;<code>Class</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The indexed models.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L42-L57'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='42' data-end='57'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/tasks/database.rb', line 42</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_create_indexes'>create_indexes</span>(<span class='id identifier rubyid_models'>models</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_models'>models</span>)
  <span class='id identifier rubyid_models'>models</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_model'>model</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_index_specifications'>index_specifications</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_embedded?'>embedded?</span> <span class='op'>||</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_cyclic?'>cyclic?</span>
      <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_create_indexes'>create_indexes</span>
      <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: Created indexes on </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span>)
      <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_index_specifications'>index_specifications</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_spec'>spec</span><span class='op'>|</span>
        <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: Index: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_spec'>spec</span>.<span class='id identifier rubyid_key'>key</span><span class='embexpr_end'>}</span><span class='tstring_content'>, Options: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_spec'>spec</span>.<span class='id identifier rubyid_options'>options</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>end</span>
      <span class='id identifier rubyid_model'>model</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: Index ignored on: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_content'>, please define in the root model.</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>nil</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>.<span class='id identifier rubyid_compact'>compact</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="create_search_indexes-instance_method">
  <h3 class='signature '>
    #<strong>create_search_indexes</strong>(models = ::Mongoid.models, wait: true)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Submit requests for the search indexes to be created. This will happen asynchronously. If “wait” is true, the method will block while it waits for the indexes to be created.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>models</span>
    <span class='type'>(<a href="../../Array.html" title="Array (class)">Array</a>&lt;<a href="../Document.html" title="Mongoid::Document (module)">Mongoid::Document</a>&gt;)</span>
    <em class='default'>(defaults to: <tt>::Mongoid.models</tt>)</em>
&mdash;    <div class='inline'>
<p>the models to build search indexes for.</p>
</div>
  </li>
  <li>
    <span class='name'>wait</span>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>whether to wait for the indexes to be built.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L67-L77'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='67' data-end='77'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/tasks/database.rb', line 67</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_create_search_indexes'>create_search_indexes</span>(<span class='id identifier rubyid_models'>models</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_models'>models</span><span class='comma'>,</span> <span class='label'>wait:</span> <span class='kw'>true</span>)
  <span class='id identifier rubyid_searchable'>searchable</span> <span class='op'>=</span> <span class='id identifier rubyid_models'>models</span>.<span class='id identifier rubyid_select'>select</span> { <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='id identifier rubyid_m'>m</span>.<span class='id identifier rubyid_search_index_specs'>search_index_specs</span>.<span class='id identifier rubyid_any?'>any?</span> }

  <span class='comment'># queue up the search index creation requests
</span>  <span class='id identifier rubyid_index_names_by_model'>index_names_by_model</span> <span class='op'>=</span> <span class='id identifier rubyid_searchable'>searchable</span>.<span class='id identifier rubyid_each_with_object'>each_with_object</span>({}) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_model'>model</span><span class='comma'>,</span> <span class='id identifier rubyid_obj'>obj</span><span class='op'>|</span>
    <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: Creating search indexes on </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span>)
    <span class='id identifier rubyid_obj'>obj</span>[<span class='id identifier rubyid_model'>model</span>] <span class='op'>=</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_create_search_indexes'>create_search_indexes</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_wait_for_search_indexes'><a href="#wait_for_search_indexes-instance_method" title="Mongoid::Tasks::Database#wait_for_search_indexes (method)">wait_for_search_indexes</a></span>(<span class='id identifier rubyid_index_names_by_model'>index_names_by_model</span>) <span class='kw'>if</span> <span class='id identifier rubyid_wait'>wait</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="logger-instance_method">
  <h3 class='signature priv'>
    #<strong>logger</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L247-L249'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='247' data-end='249'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/tasks/database.rb', line 247</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_logger'>logger</span>
  <span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_logger'><a href="../Loggable.html#logger-instance_method" title="Mongoid::Loggable#logger (method)">logger</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="remove_indexes-instance_method">
  <h3 class='signature '>
    #<strong>remove_indexes</strong>(models = ::Mongoid.models)  &#x21d2; <a href="../../Array.html" title="Array (class)">Array</a>&lt;<code>Class</code>&gt; 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Remove indexes for each model given the provided globs and the class is not embedded.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Remove all the indexes.</p>
</div></p>
      <pre class='example code ruby'><code><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="../Tasks.html" title="Mongoid::Tasks (module)">Tasks</a></span><span class='op'>::</span><span class='const'>Database</span>.<span class='id identifier rubyid_remove_indexes'>remove_indexes</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../../Array.html" title="Array (class)">Array</a>&lt;<code>Class</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The un-indexed models.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L139-L149'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='139' data-end='149'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/tasks/database.rb', line 139</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_indexes'>remove_indexes</span>(<span class='id identifier rubyid_models'>models</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_models'>models</span>)
  <span class='id identifier rubyid_models'>models</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_model'>model</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_embedded?'>embedded?</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_remove_indexes'>remove_indexes</span>
    <span class='kw'>rescue</span> <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>Error</span><span class='op'>::</span><span class='const'>OperationFailure</span>
      <span class='kw'>next</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_model'>model</span>
  <span class='kw'>end</span>.<span class='id identifier rubyid_compact'>compact</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="remove_search_indexes-instance_method">
  <h3 class='signature '>
    #<strong>remove_search_indexes</strong>(models = ::Mongoid.models)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Remove all search indexes from the given models.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L155-L160'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='155' data-end='160'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/tasks/database.rb', line 155</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_search_indexes'>remove_search_indexes</span>(<span class='id identifier rubyid_models'>models</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_models'>models</span>)
  <span class='id identifier rubyid_models'>models</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_model'>model</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_embedded?'>embedded?</span>
    <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_remove_search_indexes'>remove_search_indexes</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="remove_undefined_indexes-instance_method">
  <h3 class='signature '>
    #<strong>remove_undefined_indexes</strong>(models = ::Mongoid.models)  &#x21d2; <a href="../../Hash.html" title="Hash (class)">Hash</a>{<code>Class</code> =&gt; <a href="../../Array.html" title="Array (class)">Array</a>(<a href="../../Hash.html" title="Hash (class)">Hash</a>)} 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Remove indexes that exist in the database but aren’t specified on the models.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Remove undefined indexes.</p>
</div></p>
      <pre class='example code ruby'><code><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="../Tasks.html" title="Mongoid::Tasks (module)">Tasks</a></span><span class='op'>::</span><span class='const'>Database</span>.<span class='id identifier rubyid_remove_undefined_indexes'>remove_undefined_indexes</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../../Hash.html" title="Hash (class)">Hash</a>{<code>Class</code> =&gt; <a href="../../Array.html" title="Array (class)">Array</a>(<a href="../../Hash.html" title="Hash (class)">Hash</a>)})</span>
&mdash;    <div class='inline'>
<p>The list of indexes that were removed by model.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L118-L130'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='118' data-end='130'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/tasks/database.rb', line 118</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_undefined_indexes'>remove_undefined_indexes</span>(<span class='id identifier rubyid_models'>models</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_models'>models</span>)
  <span class='id identifier rubyid_undefined_indexes'><a href="#undefined_indexes-instance_method" title="Mongoid::Tasks::Database#undefined_indexes (method)">undefined_indexes</a></span>(<span class='id identifier rubyid_models'>models</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_model'>model</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='op'>|</span>
    <span class='id identifier rubyid_indexes'>indexes</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_index'>index</span><span class='op'>|</span>
      <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_index'>index</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>key</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_symbolize_keys'>symbolize_keys</span>
      <span class='id identifier rubyid_collection'>collection</span> <span class='op'>=</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>
      <span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_indexes'>indexes</span>(<span class='label'>session:</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:</span><span class='id identifier rubyid__session'>_session</span>)).<span class='id identifier rubyid_drop_one'>drop_one</span>(<span class='id identifier rubyid_key'>key</span>)
      <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: Removed index &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_index'>index</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span>]<span class='embexpr_end'>}</span><span class='tstring_content'>&#39; on collection </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; in database &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span>
      )
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="shard_collections-instance_method">
  <h3 class='signature '>
    #<strong>shard_collections</strong>(models = ::Mongoid.models)  &#x21d2; <a href="../../Array.html" title="Array (class)">Array</a>&lt;<code>Class</code>&gt; 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Shard collections for models that declare shard keys.</p>

<p>Returns the model classes that have had their collections sharded, including model classes whose collections had already been sharded prior to the invocation of this method.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Shard all collections</p>
</div></p>
      <pre class='example code ruby'><code><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="../Tasks.html" title="Mongoid::Tasks (module)">Tasks</a></span><span class='op'>::</span><span class='const'>Database</span>.<span class='id identifier rubyid_shard_collections'>shard_collections</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../../Array.html" title="Array (class)">Array</a>&lt;<code>Class</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The sharded models</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L172-L243'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='172' data-end='243'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/tasks/database.rb', line 172</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_shard_collections'>shard_collections</span>(<span class='id identifier rubyid_models'>models</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_models'>models</span>)
  <span class='id identifier rubyid_models'>models</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_model'>model</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_shard_config'>shard_config</span>.<span class='id identifier rubyid_nil?'>nil?</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_embedded?'>embedded?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_cyclic?'>cyclic?</span>
      <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_warn'>warn</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_content'> has shard config but is embedded</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>next</span>
    <span class='kw'>end</span>

    <span class='kw'>unless</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_sharded?'>sharded?</span>
      <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_warn'>warn</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_content'> has shard config but is not persisted in a sharded cluster: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_summary'>summary</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>next</span>
    <span class='kw'>end</span>

    <span class='comment'># Database of the collection must exist in order to run collStats.
</span>    <span class='comment'># Depending on server version, the collection itself must also
</span>    <span class='comment'># exist.
</span>    <span class='comment'># MongoDB does not have a command to create the database; the best
</span>    <span class='comment'># approximation of it is to create the collection we want.
</span>    <span class='comment'># On older servers, creating a collection that already exists is
</span>    <span class='comment'># an error.
</span>    <span class='comment'># Additionally, 3.6 and potentially older servers do not provide
</span>    <span class='comment'># the error code when they are asked to collStats a non-existent
</span>    <span class='comment'># collection (https://jira.mongodb.org/browse/SERVER-50070).
</span>    <span class='kw'>begin</span>
      <span class='id identifier rubyid_stats'>stats</span> <span class='op'>=</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_command'>command</span>(<span class='label'>collStats:</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_name'>name</span>).<span class='id identifier rubyid_first'>first</span>
    <span class='kw'>rescue</span> <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>Error</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_exc'>exc</span>
      <span class='comment'># Code 26 is database does not exist.
</span>      <span class='comment'># Code 8 is collection does not exist, as of 4.0.
</span>      <span class='comment'># On 3.6 and earlier match the text of exception message.
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_code'>code</span> <span class='op'>==</span> <span class='int'>26</span> <span class='op'>||</span> <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_code'>code</span> <span class='op'>==</span> <span class='int'>8</span> <span class='op'>||</span>
        <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_code'>code</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_message'>message</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>not found</span><span class='regexp_end'>/</span></span>
      <span class='kw'>then</span>
        <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_create'>create</span>

        <span class='id identifier rubyid_stats'>stats</span> <span class='op'>=</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_command'>command</span>(<span class='label'>collStats:</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_name'>name</span>).<span class='id identifier rubyid_first'>first</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_raise'>raise</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_stats'>stats</span> <span class='op'>=</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_command'>command</span>(<span class='label'>collStats:</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_name'>name</span>).<span class='id identifier rubyid_first'>first</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_stats'>stats</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_sharded'>sharded</span>]
      <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_namespace'>namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'> is already sharded for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>next</span> <span class='id identifier rubyid_model'>model</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_admin_db'>admin_db</span> <span class='op'>=</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_client'><a href="../../Mongoid.html#client-instance_method" title="Mongoid#client (method)">client</a></span>.<span class='id identifier rubyid_use'>use</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_admin'>admin</span>).<span class='id identifier rubyid_database'>database</span>

    <span class='kw'>begin</span>
      <span class='id identifier rubyid_admin_db'>admin_db</span>.<span class='id identifier rubyid_command'>command</span>(<span class='label'>enableSharding:</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_name'>name</span>)
    <span class='kw'>rescue</span> <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>Error</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_exc'>exc</span>
      <span class='comment'># Server 2.6 fails if sharding is already enabled
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_code'>code</span> <span class='op'>==</span> <span class='int'>23</span> <span class='op'>||</span> <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_code'>code</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_message'>message</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>already enabled</span><span class='regexp_end'>/</span></span>
        <span class='comment'># Nothing
</span>      <span class='kw'>else</span>
        <span class='id identifier rubyid_raise'>raise</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>begin</span>
      <span class='id identifier rubyid_admin_db'>admin_db</span>.<span class='id identifier rubyid_command'>command</span>(<span class='label'>shardCollection:</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_namespace'>namespace</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_shard_config'>shard_config</span>)
    <span class='kw'>rescue</span> <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>Error</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_error'>error</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: Failed to shard collection </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_namespace'>namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'> for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>next</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: Sharded collection </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_namespace'>namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'> for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)

    <span class='id identifier rubyid_model'>model</span>
  <span class='kw'>end</span>.<span class='id identifier rubyid_compact'>compact</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="undefined_indexes-instance_method">
  <h3 class='signature '>
    #<strong>undefined_indexes</strong>(models = ::Mongoid.models)  &#x21d2; <a href="../../Array.html" title="Array (class)">Array</a>&lt;<a href="../../Hash.html" title="Hash (class)">Hash</a>&gt; 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return the list of indexes by model that exist in the database but aren’t specified on the models.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Return the list of unused indexes.</p>
</div></p>
      <pre class='example code ruby'><code><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="../Tasks.html" title="Mongoid::Tasks (module)">Tasks</a></span><span class='op'>::</span><span class='const'>Database</span>.<span class='id identifier rubyid_undefined_indexes'>undefined_indexes</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../../Array.html" title="Array (class)">Array</a>&lt;<a href="../../Hash.html" title="Hash (class)">Hash</a>&gt;)</span>
&mdash;    <div class='inline'>
<p>The list of undefined indexes by model.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L86-L109'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='86' data-end='109'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/tasks/database.rb', line 86</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_undefined_indexes'>undefined_indexes</span>(<span class='id identifier rubyid_models'>models</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_models'>models</span>)
  <span class='id identifier rubyid_undefined_by_model'>undefined_by_model</span> <span class='op'>=</span> {}

  <span class='id identifier rubyid_models'>models</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_model'>model</span><span class='op'>|</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_embedded?'>embedded?</span>
      <span class='kw'>begin</span>
        <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_indexes'>indexes</span>(<span class='label'>session:</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:</span><span class='id identifier rubyid__session'>_session</span>)).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_index'>index</span><span class='op'>|</span>
          <span class='comment'># ignore default index
</span>          <span class='kw'>unless</span> <span class='id identifier rubyid_index'>index</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>_id_</span><span class='tstring_end'>&#39;</span></span>
            <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_index'>index</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>key</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_symbolize_keys'>symbolize_keys</span>
            <span class='id identifier rubyid_spec'>spec</span> <span class='op'>=</span> <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_index_specification'>index_specification</span>(<span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_index'>index</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span>])
            <span class='kw'>unless</span> <span class='id identifier rubyid_spec'>spec</span>
              <span class='comment'># index not specified
</span>              <span class='id identifier rubyid_undefined_by_model'>undefined_by_model</span>[<span class='id identifier rubyid_model'>model</span>] <span class='op'>||=</span> []
              <span class='id identifier rubyid_undefined_by_model'>undefined_by_model</span>[<span class='id identifier rubyid_model'>model</span>] <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_index'>index</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>rescue</span> <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>Error</span><span class='op'>::</span><span class='const'>OperationFailure</span><span class='semicolon'>;</span> <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_undefined_by_model'>undefined_by_model</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="wait_for_search_indexes-instance_method">
  <h3 class='signature priv'>
    #<strong>wait_for_search_indexes</strong>(models)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Waits for the search indexes to be built on the given models.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>models</span>
    <span class='type'>(<a href="../../Hash.html" title="Hash (class)">Hash</a>&lt;<a href="../Document.html" title="Mongoid::Document (module)">Mongoid::Document</a>, <a href="../../Array.html" title="Array (class)">Array</a>&lt;<a href="../../String.html" title="String (class)">String</a>&gt;&gt;)</span>
&mdash;    <div class='inline'>
<p>a mapping of index names for each model</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/tasks/database.rb#L255-L274'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='255' data-end='274'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/tasks/database.rb', line 255</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_for_search_indexes'>wait_for_search_indexes</span>(<span class='id identifier rubyid_models'>models</span>)
  <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>MONGOID: Waiting for search indexes to be created</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>MONGOID: Press ctrl-c to skip the wait and let the indexes be created in the background</span><span class='tstring_end'>&#39;</span></span>)

  <span class='id identifier rubyid_models'>models</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_model'>model</span><span class='comma'>,</span> <span class='id identifier rubyid_names'>names</span><span class='op'>|</span>
    <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_wait_for_search_indexes'>wait_for_search_indexes</span>(<span class='id identifier rubyid_names'>names</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_status'>status</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_ready?'>ready?</span>
        <span class='id identifier rubyid_puts'>puts</span>
        <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MONGOID: Search indexes on </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model'>model</span><span class='embexpr_end'>}</span><span class='tstring_content'> are READY</span><span class='tstring_end'>&quot;</span></span>)
      <span class='kw'>else</span>
        <span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.</span><span class='tstring_end'>&#39;</span></span>
        <span class='gvar'>$stdout</span>.<span class='id identifier rubyid_flush'>flush</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='const'>Interrupt</span>
  <span class='comment'># ignore ctrl-C here; we assume it is meant only to skip
</span>  <span class='comment'># the wait, and that subsequent tasks ought to continue.
</span>  <span class='id identifier rubyid_logger'><a href="#logger-instance_method" title="Mongoid::Tasks::Database#logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>MONGOID: Skipping the wait for search indexes; they will be created in the background</span><span class='tstring_end'>&#39;</span></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>