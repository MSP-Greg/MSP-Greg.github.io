<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: Mongoid::Positional &mdash; Mongoid master</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongoid::Positional",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Mongoid master</a> &raquo; 
      <a href='../_index.html#alpha_P'>Index (P)</a> &raquo; 
        <a href="../Mongoid.html" title="Mongoid (module)">Mongoid</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Positional&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: Mongoid::Positional</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Included In:</div>
      <div class='box_11'>
        <a href="Association/Embedded/Batchable.html" title="Mongoid::Association::Embedded::Batchable (module)"><code>Association::Embedded::Batchable</code></a>,
          <a href="Association/Embedded/EmbedsMany/Proxy.html" title="Mongoid::Association::Embedded::EmbedsMany::Proxy (class)"><code>Association::Embedded::EmbedsMany::Proxy</code></a>,
          <a href="Composable.html" title="Mongoid::Composable (module)"><code>Composable</code></a>,
          <a href="Contextual/Memory.html" title="Mongoid::Contextual::Memory (class)"><code>Contextual::Memory</code></a>,
          <a href="Document.html" title="Mongoid::Document (module)"><code>Document</code></a>,
          <a href="GlobalDiscriminatorKeyAssignment/InvalidFieldHost.html" title="Mongoid::GlobalDiscriminatorKeyAssignment::InvalidFieldHost (class)"><code>GlobalDiscriminatorKeyAssignment::InvalidFieldHost</code></a>,
          <a href="Persistable.html" title="Mongoid::Persistable (module)"><code>Persistable</code></a>
      </div>
    </td></tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/positional.rb#L8'>lib/mongoid/positional.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>This module is responsible for taking update selectors and switching out the indexes for the $ positional operator where appropriate.</p>

  </div>
</div>
</div>
<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#positionally-instance_method" title="#positionally (instance method)">#<strong>positionally</strong>(selector, operations, processed = {})  &#x21d2; Hash </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Takes the provided selector and atomic operations and replaces the indexes of the embedded documents with the positional operator when needed.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#process_operations-instance_method" title="#process_operations (instance method)">#<strong>process_operations</strong>(keys, operations, processed)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#process_updates-instance_method" title="#process_updates (instance method)">#<strong>process_updates</strong>(keys, update, updates = {})  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#replace_index-instance_method" title="#replace_index (instance method)">#<strong>replace_index</strong>(keys, position)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="positionally-instance_method">
  <h3 class='signature  first'>
    #<strong>positionally</strong>(selector, operations, processed = {})  &#x21d2; <a href="../Hash.html" title="Hash (class)">Hash</a> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>The only time we can accurately know when to use the positional operator is at the exact time we are going to persist something. So we can tell by the selector that we are sending if it is actually possible to use the positional operator at all. For example, if the selector is: { “_id” =&gt; 1 }, then we could not use the positional operator for updating embedded documents since there would never be a match - we base whether we can based on the number of levels deep the selector goes, and if the id values are not nil.</p>
</div>
  </div>


<p>Takes the provided selector and atomic operations and replaces the indexes of the embedded documents with the positional operator when needed.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Process the operations.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_positionally'>positionally</span>(
  { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>addresses._id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>2</span> }<span class='comma'>,</span>
  { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>addresses.0.street</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hobrecht</span><span class='tstring_end'>&quot;</span></span> }}
)</code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>selector</span>
    <span class='type'>(<a href="../Hash.html" title="Hash (class)">Hash</a>)</span>
&mdash;    <div class='inline'>
<p>The selector.</p>
</div>
  </li>
  <li>
    <span class='name'>operations</span>
    <span class='type'>(<a href="../Hash.html" title="Hash (class)">Hash</a>)</span>
&mdash;    <div class='inline'>
<p>The update operations.</p>
</div>
  </li>
  <li>
    <span class='name'>processed</span>
    <span class='type'>(<a href="../Hash.html" title="Hash (class)">Hash</a>)</span>
    <em class='default'>(defaults to: <tt>{}</tt>)</em>
&mdash;    <div class='inline'>
<p>The processed update operations.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Hash.html" title="Hash (class)">Hash</a>)</span>
&mdash;    <div class='inline'>
<p>The new operations.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/positional.rb#L34-L41'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='34' data-end='41'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/positional.rb', line 34</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_positionally'>positionally</span>(<span class='id identifier rubyid_selector'>selector</span><span class='comma'>,</span> <span class='id identifier rubyid_operations'>operations</span><span class='comma'>,</span> <span class='id identifier rubyid_processed'>processed</span> <span class='op'>=</span> {})
  <span class='kw'>if</span> <span class='id identifier rubyid_selector'>selector</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>==</span> <span class='int'>1</span> <span class='op'>||</span> <span class='id identifier rubyid_selector'>selector</span>.<span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_any?'>any?</span> { <span class='op'>|</span><span class='id identifier rubyid_val'>val</span><span class='op'>|</span> <span class='id identifier rubyid_val'>val</span>.<span class='id identifier rubyid_nil?'>nil?</span> }
    <span class='kw'>return</span> <span class='id identifier rubyid_operations'>operations</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_keys'>keys</span> <span class='op'>=</span> <span class='id identifier rubyid_selector'>selector</span>.<span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_map'>map</span>{ <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='id identifier rubyid_m'>m</span>.<span class='id identifier rubyid_sub'>sub</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>._id</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>) } <span class='op'>-</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&#39;</span></span>]
  <span class='id identifier rubyid_keys'>keys</span> <span class='op'>=</span> <span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_sort_by'>sort_by</span> { <span class='op'>|</span><span class='id identifier rubyid_s'>s</span><span class='op'>|</span> <span class='id identifier rubyid_s'>s</span>.<span class='id identifier rubyid_length'>length</span><span class='op'>*</span><span class='op'>-</span><span class='int'>1</span> }
  <span class='id identifier rubyid_process_operations'><a href="#process_operations-instance_method" title="Mongoid::Positional#process_operations (method)">process_operations</a></span>(<span class='id identifier rubyid_keys'>keys</span><span class='comma'>,</span> <span class='id identifier rubyid_operations'>operations</span><span class='comma'>,</span> <span class='id identifier rubyid_processed'>processed</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="process_operations-instance_method">
  <h3 class='signature priv'>
    #<strong>process_operations</strong>(keys, operations, processed)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/positional.rb#L45-L50'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='45' data-end='50'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/positional.rb', line 45</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_process_operations'>process_operations</span>(<span class='id identifier rubyid_keys'>keys</span><span class='comma'>,</span> <span class='id identifier rubyid_operations'>operations</span><span class='comma'>,</span> <span class='id identifier rubyid_processed'>processed</span>)
  <span class='id identifier rubyid_operations'>operations</span>.<span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_operation'>operation</span><span class='comma'>,</span> <span class='id identifier rubyid_update'>update</span><span class='op'>|</span>
    <span class='id identifier rubyid_processed'>processed</span>[<span class='id identifier rubyid_operation'>operation</span>] <span class='op'>=</span> <span class='id identifier rubyid_process_updates'><a href="#process_updates-instance_method" title="Mongoid::Positional#process_updates (method)">process_updates</a></span>(<span class='id identifier rubyid_keys'>keys</span><span class='comma'>,</span> <span class='id identifier rubyid_update'>update</span>)
  <span class='kw'>end</span>
  <span class='id identifier rubyid_processed'>processed</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="process_updates-instance_method">
  <h3 class='signature priv'>
    #<strong>process_updates</strong>(keys, update, updates = {})   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/positional.rb#L52-L57'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='52' data-end='57'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/positional.rb', line 52</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_process_updates'>process_updates</span>(<span class='id identifier rubyid_keys'>keys</span><span class='comma'>,</span> <span class='id identifier rubyid_update'>update</span><span class='comma'>,</span> <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> {})
  <span class='id identifier rubyid_update'>update</span>.<span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_position'>position</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
    <span class='id identifier rubyid_updates'>updates</span>[<span class='id identifier rubyid_replace_index'><a href="#replace_index-instance_method" title="Mongoid::Positional#replace_index (method)">replace_index</a></span>(<span class='id identifier rubyid_keys'>keys</span><span class='comma'>,</span> <span class='id identifier rubyid_position'>position</span>)] <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_updates'>updates</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="replace_index-instance_method">
  <h3 class='signature priv'>
    #<strong>replace_index</strong>(keys, position)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongoid/blob/master/lib/mongoid/positional.rb#L59-L71'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='59' data-end='71'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongoid/positional.rb', line 59</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_replace_index'>replace_index</span>(<span class='id identifier rubyid_keys'>keys</span><span class='comma'>,</span> <span class='id identifier rubyid_position'>position</span>)
  <span class='comment'># replace index with $ only if that key is in the selector and it is only
</span>  <span class='comment'># nested a single level deep.
</span>  <span class='id identifier rubyid_matches'>matches</span> <span class='op'>=</span> <span class='id identifier rubyid_position'>position</span>.<span class='id identifier rubyid_scan'>scan</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\.\d+\.</span><span class='regexp_end'>/</span></span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_matches'>matches</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_kk'>kk</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_position'>position</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_kk'>kk</span><span class='embexpr_end'>}</span><span class='tstring_content'>\.\d+\.(.*)\z</span><span class='regexp_end'>/</span></span>
        <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_kk'>kk</span><span class='embexpr_end'>}</span><span class='tstring_content'>.$.</span><span class='embexpr_beg'>#{</span><span class='backref'>$1</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_position'>position</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>