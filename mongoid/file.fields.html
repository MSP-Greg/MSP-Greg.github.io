<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Field Definition [fields] &mdash; Mongoid master</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "fields",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Mongoid master</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Field Definition [fields]&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>Field Definition [fields]</h1>

<div class="contents singlecol" markdown="1" local="" backlinks="none" depth="2"></div>

<h2>Field Types</h2>

<p>MongoDB stores underlying document data using
<a href="https://mongodb.com/docs/manual/reference/bson-types/">BSON types</a>, and
<a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> converts <a href="BSON.html" title="BSON (module)"><code>BSON</code></a> types to Ruby types at runtime in your application.
For example, a field defined with <code>type: :float</code> will use the Ruby <a href="Float.html" title="Float (class)"><code>Float</code></a>
class in-memory and will persist in the database as the the <a href="BSON.html" title="BSON (module)"><code>BSON</code></a> <code>double</code> type.</p>

<p>Field type definitions determine how <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> behaves when constructing queries
and retrieving/writing fields from/to the database. Specifically:</p>

<ol>
<li> When assigning values to fields at runtime, the values are converted to the
specified type.</li>
<li> When persisting data to MongoDB, the data is sent in an appropriate
type, permitting richer data manipulation within MongoDB or by other
tools.</li>
<li> When querying documents, query parameters are converted to the specified
type before being sent to MongoDB.</li>
<li> When retrieving documents from the database, field values are converted
to the specified type.</li>
</ol>

<p>Changing the field definitions in a model class does not alter data already stored in
MongoDB. To update type or contents of fields of existing documents,
the field must be re-saved to the database. Note that, due to <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a>
tracking which attributes on a model change and only saving the changed ones,
it may be necessary to explicitly write a field value when changing the
type of an existing field without changing the stored values.</p>

<p>Consider a simple class for modeling a person in an application. A person may
have a name, date_of_birth, and weight. We can define these attributes
on a person by using the <code>field</code> macro.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_date_of_birth'>date_of_birth</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_weight'>weight</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Float.html" title="Float (class)">Float</a></span>
<span class='kw'>end</span></code></pre>

<p>The valid types for fields are as follows:</p>

<ul>
<li>  <a href="Array.html" title="Array (class)"><code>Array</code></a></li>
<li>  <a href="BSON/Binary.html" title="BSON::Binary (class)"><code>::BSON::Binary</code></a></li>
<li>  <code>BigDecimal &lt;field-type-big-decimal&gt;</code></li>
<li>  <a href="Mongoid/Boolean.html" title="Mongoid::Boolean (class)"><code>::Mongoid::Boolean</code></a>, which may be specified simply as <code>Boolean</code> in the
scope of a class which included <a href="Mongoid/Document.html" title="Mongoid::Document (module)"><code>::Mongoid::Document</code></a>.</li>
<li>  <code>Date &lt;field-type-date&gt;</code></li>
<li>  <code>DateTime &lt;field-type-date-time&gt;</code></li>
<li>  <a href="Float.html" title="Float (class)"><code>Float</code></a></li>
<li>  <code>Hash &lt;field-type-hash&gt;</code></li>
<li>  <a href="Integer.html" title="Integer (class)"><code>Integer</code></a></li>
<li>  <code>Object &lt;untyped-fields&gt;</code></li>
<li>  <a href="BSON/ObjectId.html" title="BSON::ObjectId (class)"><code>::BSON::ObjectId</code></a></li>
<li>  <code>Range</code></li>
<li>  <code>Regexp &lt;field-type-regexp&gt;</code></li>
<li>  <a href="Set.html" title="Set (class)"><code>Set</code></a></li>
<li>  <a href="String.html" title="String (class)"><code>String</code></a></li>
<li>  <code>Mongoid::StringifiedSymbol &lt;field-type-stringified-symbol&gt;</code>,
which may be specified simply as <code>StringifiedSymbol</code> in the scope of a
class which included <a href="Mongoid/Document.html" title="Mongoid::Document (module)"><code>::Mongoid::Document</code></a>.</li>
<li>  <code>Symbol &lt;field-type-stringified-symbol&gt;</code></li>
<li>  <code>Time &lt;field-type-time&gt;</code></li>
<li>  <a href="ActiveSupport/TimeWithZone.html" title="ActiveSupport::TimeWithZone (class)"><code>::ActiveSupport::TimeWithZone</code></a></li>
</ul>

<p>Mongoid also recognizes the string <code>&quot;Boolean&quot;</code> as an alias for the
<a href="Mongoid/Boolean.html" title="Mongoid::Boolean (class)"><code>::Mongoid::Boolean</code></a> class.</p>

<p>To define custom field types, refer to <code>Custom Field Types &lt;custom-field-types&gt;</code> below.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Using the <code>BSON::Int64</code> and <code>BSON::Int32</code> types as field types is unsupported.
Saving these types to the database will work as expected, however, querying them
will return the native Ruby <a href="Integer.html" title="Integer (class)"><code>Integer</code></a> type. Querying fields of type
<a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a> will return values of type <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a> in
BSON &lt;=4 and values of type <code>BigDecimal</code> in BSON 5+.</p>

<p></div></p>

<h3>Untyped Fields</h3>

<p>Not specifying a type for a field is the same as specifying the <code>Object</code>
type. Such fields are untyped:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Product</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_properties'>properties</span>
  <span class='comment'># Equivalent to:
</span>  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_properties'>properties</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Object</span>
<span class='kw'>end</span></code></pre>

<p>An untyped field can store values of any type which is directly serializable
to BSON. This is useful when a field may contain values of different types
(i.e. it is a variant type field), or when the type of values is not known
ahead of time:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_product'>product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>properties:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>color=white,size=large</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_properties'>properties</span>
<span class='comment'># =&gt; &quot;color=white,size=large&quot;
</span>
<span class='id identifier rubyid_product'>product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>properties:</span> {<span class='label'>color:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>white</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>size:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>large</span><span class='tstring_end'>&quot;</span></span>})
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_properties'>properties</span>
<span class='comment'># =&gt; {:color=&gt;&quot;white&quot;, :size=&gt;&quot;large&quot;}</span></code></pre>

<p>When values are assigned to the field, Mongoid still performs mongoization but
uses the class of the value rather than the field type for mongoization logic.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_product'>product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>properties:</span> <span class='int'>0</span><span class='op'>..</span><span class='int'>10</span>)
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_properties'>properties</span>
<span class='comment'># The range 0..10, mongoized:
</span><span class='comment'># =&gt; {&quot;min&quot;=&gt;0, &quot;max&quot;=&gt;10}</span></code></pre>

<p>When reading data from the database, Mongoid does not perform any type
conversions on untyped fields. For this reason, even though it is possible
to write any BSON-serializable value into an untyped fields, values which
require special handling on the database reading side will generally not work
correctly in an untyped field. Among field types supported by Mongoid,
values of the following types should not be stored in untyped fields:</p>

<ul>
<li>  <a href="Date.html" title="Date (class)"><code>Date</code></a> (values will be returned as <a href="Time.html" title="Time (class)"><code>Time</code></a>)</li>
<li>  <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> (values will be returned as <a href="Time.html" title="Time (class)"><code>Time</code></a>)</li>
<li>  <code>Range</code> (values will be returned as <a href="Hash.html" title="Hash (class)"><code>Hash</code></a>)</li>
</ul>

<h3>Field Type: StringifiedSymbol [field-type-stringified-symbol]</h3>

<p>The <code>StringifiedSymbol</code> field type is the recommended field type for storing
values that should be exposed as symbols to Ruby applications. When using the <a href="Symbol.html" title="Symbol (class)"><code>Symbol</code></a> field type,
Mongoid defaults to storing values as BSON symbols. For more information on the
BSON symbol type, see <code>here &lt;field-type-symbol&gt;</code>.
However, the BSON symbol type is deprecated and is difficult to work with in programming languages
without native symbol types, so the <code>StringifiedSymbol</code> type allows the use of symbols
while ensuring interoperability with other drivers. The <code>StringifiedSymbol</code> type stores all data
on the database as strings, while exposing values to the application as symbols.</p>

<p>An example usage is shown below:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Post</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>StringifiedSymbol</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_post'>post</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>status:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_hello'>hello</span>)
<span class='comment'># status is stored as &quot;hello&quot; on the database, but returned as a Symbol
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_status'>status</span>
<span class='comment'># =&gt; :hello
</span>
<span class='comment'># String values can be assigned also:
</span><span class='id identifier rubyid_post'>post</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># status is stored as &quot;hello&quot; on the database, but returned as a Symbol
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_status'>status</span>
<span class='comment'># =&gt; :hello</span></code></pre>

<p>All non-string values will be stringified upon being sent to the database (via <code>to_s</code>), and
all values will be converted to symbols when returned to the application. Values that cannot be
converted directly to symbols, such as integers and arrays, will first be converted to strings and
then symbols before being returned to the application.</p>

<p>For example, setting an integer as <code>status</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_post'>post</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>status:</span> <span class='int'>42</span>)
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_status'>status</span>
<span class='comment'># =&gt; :&quot;42&quot;</span></code></pre>

<p>If the <code>StringifiedSymbol</code> type is applied to a field that contains BSON symbols, the values
will be stored as strings instead of BSON symbols on the next save. This permits transparent lazy
migration from fields that currently store either strings or BSON symbols in the database to the
<code>StringifiedSymbol</code> field type.</p>

<h3>Field Type: Symbol</h3>

<p>New applications should use the <code>StringifiedSymbol field type &lt;field-type-stringified-symbol&gt;</code>
to store Ruby symbols in the database. The <code>StringifiedSymbol</code> field type
provides maximum compatibility with other applications and programming languages
and has the same behavior in all circumstances.</p>

<p>Mongoid also provides the deprecated <a href="Symbol.html" title="Symbol (class)"><code>Symbol</code></a> field type for serializing
Ruby symbols to BSON symbols. Because the BSON specification deprecated the
BSON symbol type, the <code>bson</code> gem will serialize Ruby symbols into BSON strings
when used on its own. However, in order to maintain backwards compatibility
with older datasets, the <code>mongo</code> gem overrides this behavior to serialize Ruby
symbols as BSON symbols. This is necessary to be able to specify queries for
documents which contain BSON symbols as fields.</p>

<p>To override the default behavior and configure the <code>mongo</code> gem (and thereby
Mongoid as well) to encode symbol values as strings, include the following code
snippet in your project:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'><a href="Symbol.html" title="Symbol (class)">Symbol</a></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_bson_type'>bson_type</span>
    <span class='const'><a href="BSON.html" title="BSON (module)">BSON</a></span><span class='op'>::</span><span class='const'><a href="String.html" title="String (class)">String</a></span><span class='op'>::</span><span class='const'>BSON_TYPE</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Field Type: Hash</h3>

<p>When using a field of type Hash, be wary of adhering to the
<a href="https://www.mongodb.com/docs/manual/reference/limits/#naming-restrictions">legal key names for mongoDB</a>,
or else the values will not store properly.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_first_name'>first_name</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Hash.html" title="Hash (class)">Hash</a></span>

  <span class='comment'># will update the fields properly and save the values
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_vals'>set_vals</span>
    <span class='kw'>self</span>.<span class='id identifier rubyid_first_name'>first_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Daniel</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>self</span>.<span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>home_page</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>http://www.homepage.com</span><span class='tstring_end'>&#39;</span></span>}
    <span class='id identifier rubyid_save'>save</span>
  <span class='kw'>end</span>

  <span class='comment'># all data will fail to save due to the illegal hash key
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_vals_fail'>set_vals_fail</span>
    <span class='kw'>self</span>.<span class='id identifier rubyid_first_name'>first_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Daniel</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>self</span>.<span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>home.page</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>http://www.homepage.com</span><span class='tstring_end'>&#39;</span></span>}
    <span class='id identifier rubyid_save'>save</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Field Type: Time</h3>

<p><a href="Time.html" title="Time (class)"><code>Time</code></a> fields store values as <a href="Time.html" title="Time (class)"><code>Time</code></a> instances in the <code>configured
time zone &lt;time-zones&gt;</code>.</p>

<p><a href="Date.html" title="Date (class)"><code>Date</code></a> and <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> instances are converted to <a href="Time.html" title="Time (class)"><code>Time</code></a> instances upon
assignment to a <a href="Time.html" title="Time (class)"><code>Time</code></a> field:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Voter</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_registered_at'>registered_at</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>
<span class='kw'>end</span>

<span class='const'>Voter</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>registered_at:</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span>.<span class='id identifier rubyid_today'>today</span>)
<span class='comment'># =&gt; #&lt;Voter _id: 5fdd80392c97a618f07ba344, registered_at: 2020-12-18 05:00:00 UTC&gt;</span></code></pre>

<p>In the above example, the value was interpreted as the beginning of today in
local time, because the application was not configured to use UTC times.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>When the database contains a string value for a <a href="Time.html" title="Time (class)"><code>Time</code></a> field, Mongoid
parses the string value using <code>Time.parse</code> which considers values without
time zones to be in local time.</p>

<p></div></p>

<h3>Field Type: Date</h3>

<p>Mongoid allows assignment of values of several types to <a href="Date.html" title="Date (class)"><code>Date</code></a> fields:</p>

<ul>
<li>  <a href="Date.html" title="Date (class)"><code>Date</code></a> - the provided date is stored as is.</li>
<li>  <a href="Time.html" title="Time (class)"><code>Time</code></a>, <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a>, <a href="ActiveSupport/TimeWithZone.html" title="ActiveSupport::TimeWithZone (class)"><code>::ActiveSupport::TimeWithZone</code></a> - the date component
of the value is taken in the value&#39;s time zone.</li>
<li>  <a href="String.html" title="String (class)"><code>String</code></a> - the date specified in the string is used.</li>
<li>  <a href="Integer.html" title="Integer (class)"><code>Integer</code></a>, <a href="Float.html" title="Float (class)"><code>Float</code></a> - the value is taken to be a UTC timestamp which is
converted to the <code>configured time zone &lt;time-zones&gt;</code> (note that
<code>Mongoid.use_utc</code> has no effect on this conversion), then the date is
taken from the resulting time.</li>
</ul>

<p>In other words, if a date is specified in the value, that date is used without
first converting the value to the configured time zone.</p>

<p>As a date &amp; time to date conversion is lossy (it discards the time component),
especially if an application operates with times in different time zones it is
recommended to explicitly convert <a href="String.html" title="String (class)"><code>String</code></a>, <a href="Time.html" title="Time (class)"><code>Time</code></a> and <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a>
objects to <a href="Date.html" title="Date (class)"><code>Date</code></a> objects before assigning the values to fields of type
<a href="Date.html" title="Date (class)"><code>Date</code></a>.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>When the database contains a string value for a <a href="Date.html" title="Date (class)"><code>Date</code></a> field, Mongoid
parses the string value using <code>Time.parse</code>, discards the time portion of
the resulting <a href="Time.html" title="Time (class)"><code>Time</code></a> object and uses the date portion. <code>Time.parse</code>
considers values without time zones to be in local time.</p>

<p></div></p>

<h3>Field Type: DateTime [field-type-date-time]</h3>

<p>MongoDB stores all times as UTC timestamps. When assigning a value to a
<a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> field, or when querying a <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> field, Mongoid
converts the passed in value to a UTC <a href="Time.html" title="Time (class)"><code>Time</code></a> before sending it to the
MongoDB server.</p>

<p><a href="Time.html" title="Time (class)"><code>Time</code></a>, <a href="ActiveSupport/TimeWithZone.html" title="ActiveSupport::TimeWithZone (class)"><code>::ActiveSupport::TimeWithZone</code></a> and <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> objects embed
time zone information, and the value persisted is the specified moment in
time, in UTC. When the value is retrieved, the time zone in which it is
returned is defined by the <code>configured time zone settings &lt;time-zones&gt;</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Ticket</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opened_at'>opened_at</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="DateTime.html" title="DateTime (class)">DateTime</a></span>
<span class='kw'>end</span>

<span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_zone'>zone</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Berlin</span><span class='tstring_end'>&#39;</span></span>

<span class='id identifier rubyid_ticket'>ticket</span> <span class='op'>=</span> <span class='const'>Ticket</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>opened_at:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>2018-02-18 07:00:08 -0500</span><span class='tstring_end'>&#39;</span></span>)

 <span class='id identifier rubyid_ticket'>ticket</span>.<span class='id identifier rubyid_opened_at'>opened_at</span>
 <span class='comment'># =&gt; Sun, 18 Feb 2018 13:00:08 +0100
</span> <span class='id identifier rubyid_ticket'>ticket</span>
 <span class='comment'># =&gt; #&lt;Ticket _id: 5c13d4b9026d7c4e7870bb2f, opened_at: 2018-02-18 12:00:08 UTC&gt;
</span>
 <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_zone'>zone</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>America/New_York</span><span class='tstring_end'>&#39;</span></span>
 <span class='id identifier rubyid_ticket'>ticket</span>.<span class='id identifier rubyid_opened_at'>opened_at</span>
 <span class='comment'># =&gt; Sun, 18 Feb 2018 07:00:08 -0500
</span>
 <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_use_utc'>use_utc</span> <span class='op'>=</span> <span class='kw'>true</span>
 <span class='id identifier rubyid_ticket'>ticket</span>.<span class='id identifier rubyid_opened_at'>opened_at</span>
 <span class='comment'># =&gt; Sun, 18 Feb 2018 12:00:08 +0000</span></code></pre>

<p>Mongoid also supports casting integers and floats to <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a>. When
doing so, the integers/floats are assumed to be Unix timestamps (in UTC):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_ticket'>ticket</span>.<span class='id identifier rubyid_opened_at'>opened_at</span> <span class='op'>=</span> <span class='int'>1544803974</span>
<span class='id identifier rubyid_ticket'>ticket</span>.<span class='id identifier rubyid_opened_at'>opened_at</span>
<span class='comment'># =&gt; Fri, 14 Dec 2018 16:12:54 +0000</span></code></pre>

<p>If a string is used as a <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> field value, the behavior depends on
whether the string includes a time zone. If no time zone is specified,
the <code>default Mongoid time zone &lt;time-zones&gt;</code> is used:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_zone'>zone</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>America/New_York</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_ticket'>ticket</span>.<span class='id identifier rubyid_opened_at'>opened_at</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mar 4, 2018 10:00:00</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_ticket'>ticket</span>.<span class='id identifier rubyid_opened_at'>opened_at</span>
<span class='comment'># =&gt; Sun, 04 Mar 2018 15:00:00 +0000</span></code></pre>

<p>If a time zone is specified, it is respected:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_ticket'>ticket</span>.<span class='id identifier rubyid_opened_at'>opened_at</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mar 4, 2018 10:00:00 +01:00</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_ticket'>ticket</span>.<span class='id identifier rubyid_opened_at'>opened_at</span>
<span class='comment'># =&gt; Sun, 04 Mar 2018 09:00:00 +0000</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>When the database contains a string value for a <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a> field, Mongoid
parses the string value using <code>Time.parse</code> which considers values without
time zones to be in local time.</p>

<p></div></p>

<h3>Field Type: Regexp</h3>

<p>MongoDB supports storing regular expressions in documents, and querying using
regular expressions. Note that MongoDB uses
<a href="http://pcre.org/">Perl-compatible regular expressions (PCRE)</a>
and Ruby uses <a href="https://github.com/k-takata/Onigmo">Onigmo</a>, which is a
fork of <a href="https://github.com/kkos/oniguruma">Oniguruma regular expression engine</a>.
The two regular expression implementations generally provide equivalent
functionality but have several important syntax differences.</p>

<p>When a field is declared to be of type Regexp, Mongoid converts Ruby regular
expressions to BSON regular expressions and stores the result in MongoDB.
Retrieving the field from the database produces a <code>BSON::Regexp::Raw</code>
instance:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Token</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pattern'>pattern</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Regexp.html" title="Regexp (class)">Regexp</a></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_token'>token</span> <span class='op'>=</span> <span class='const'>Token</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>pattern:</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>hello.world</span><span class='regexp_end'>/m</span></span>)
<span class='id identifier rubyid_token'>token</span>.<span class='id identifier rubyid_pattern'>pattern</span>
<span class='comment'># =&gt; /hello.world/m
</span>
<span class='id identifier rubyid_token'>token</span>.<span class='id identifier rubyid_reload'>reload</span>
<span class='id identifier rubyid_token'>token</span>.<span class='id identifier rubyid_pattern'>pattern</span>
<span class='comment'># =&gt; #&lt;BSON::Regexp::Raw:0x0000555f505e4a20 @pattern=&quot;hello.world&quot;, @options=&quot;ms&quot;&gt;</span></code></pre>

<p>Use <code>#compile</code> method on <code>BSON::Regexp::Raw</code> to get back the Ruby regular
expression:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_token'>token</span>.<span class='id identifier rubyid_pattern'>pattern</span>.<span class='id identifier rubyid_compile'>compile</span>
<span class='comment'># =&gt; /hello.world/m</span></code></pre>

<p>Note that, if the regular expression was not originally a Ruby one, calling
<code>#compile</code> on it may produce a different regular expression. For example,
the following is a PCRE matching a string that ends in &quot;hello&quot;:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="BSON.html" title="BSON (module)">BSON</a></span><span class='op'>::</span><span class='const'><a href="Regexp.html" title="Regexp (class)">Regexp</a></span><span class='op'>::</span><span class='const'>Raw</span>.<span class='id identifier rubyid_new'>new</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello$</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>s</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># =&gt; #&lt;BSON::Regexp::Raw:0x0000555f51441640 @pattern=&quot;hello$&quot;, @options=&quot;s&quot;&gt;</span></code></pre>

<p>Compiling this regular expression produces a Ruby regular expression that
matches strings containing &quot;hello&quot; before a newline, besides strings ending in
&quot;hello&quot;:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="BSON.html" title="BSON (module)">BSON</a></span><span class='op'>::</span><span class='const'><a href="Regexp.html" title="Regexp (class)">Regexp</a></span><span class='op'>::</span><span class='const'>Raw</span>.<span class='id identifier rubyid_new'>new</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello$</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>s</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_compile'>compile</span> <span class='op'>=~</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello\nworld</span><span class='tstring_end'>&quot;</span></span>
<span class='comment'># =&gt; 0</span></code></pre>

<p>This is because the meaning of <code>$</code> is different between PCRE and Ruby
regular expressions.</p>

<h3>BigDecimal Fields [field-type-big-decimal]</h3>

<p>The <code>BigDecimal</code> field type is used to store numbers with increased precision.</p>

<p>The <code>BigDecimal</code> field type stores its values in two different ways in the
database, depending on the value of the <code>Mongoid.map_big_decimal_to_decimal128</code>
global config option. If this flag is set to false (which is the default),
the <code>BigDecimal</code> field will be stored as a string, otherwise it will be stored
as a <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a>.</p>

<p>The <code>BigDecimal</code> field type has some limitations when converting to and from
a <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a>:</p>

<ul>
<li>  <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a> has a limited range and precision, while <code>BigDecimal</code>
has no restrictions in terms of range and precision. <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a> has
a max value of approximately <code>10^6145</code> and a min value of approximately
<code>-10^6145</code>, and has a maximum of 34 bits of precision. When attempting to
store values that don&#39;t fit into a <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a>, it is recommended to
have them stored as a string instead of a <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a>. You can do
that by setting <code>Mongoid.map_big_decimal_to_decimal128</code> to <code>false</code>. If a
value that does not fit in a <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a> is attempted to be stored
as one, an error will be raised.</li>
<li>  <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a> is able to accept signed <code>NaN</code> values, while
<code>BigDecimal</code> is not. When retrieving signed <code>NaN</code> values from
the database using the <code>BigDecimal</code> field type, the <code>NaN</code> will be
unsigned.</li>
<li>  <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a> maintains trailing zeroes when stored in the database.
<code>BigDecimal</code>, however, does not maintain trailing zeroes, and therefore
retrieving <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a> values using the <code>BigDecimal</code> field type
may result in a loss of precision.</li>
</ul>

<p>There is an additional caveat when storing a <code>BigDecimal</code> in a field with no
type (i.e. a dynamically typed field) and <code>Mongoid.map_big_decimal_to_decimal128</code>
is <code>false</code>. In this case, the <code>BigDecimal</code> is stored as a string, and since a
dynamic field is being used, querying for that field with a <code>BigDecimal</code> will
not find the string for that <code>BigDecimal</code>, since the query is looking for a
<code>BigDecimal</code>. In order to query for that string, the <code>BigDecimal</code> must
first be converted to a string with <code>to_s</code>. Note that this is not a problem
when the field has type <code>BigDecimal</code>.</p>

<p>If you wish to avoid using <code>BigDecimal</code> altogether, you can set the field
type to <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a>. This will allow you to keep track of trailing
zeroes and signed <code>NaN</code> values.</p>

<h4>Migration to <code>decimal128</code>-backed <code>BigDecimal</code> Field</h4>

<p>In a future major version of Mongoid, the <code>Mongoid.map_big_decimal_to_decimal128</code>
global config option will be defaulted to <code>true</code>. When this flag is turned on,
<code>BigDecimal</code> values in queries will not match to the strings that are already
stored in the database; they will only match to <code>decimal128</code> values that are
in the database. If you have a <code>BigDecimal</code> field that is backed by strings,
you have three options:</p>

<ol>
<li><p>The <code>Mongoid.map_big_decimal_to_decimal128</code> global config option can be
set to <code>false</code>, and you can continue storing your <code>BigDecimal</code> values as
strings. Note that you are surrendering the advantages of storing <code>BigDecimal</code>
values as a <code>decimal128</code>, like being able to do queries and aggregations
based on the numerical value of the field.</p></li>
<li><p>The <code>Mongoid.map_big_decimal_to_decimal128</code> global config option can be
set to <code>true</code>, and you can convert all values for that field from strings to
<code>decimal128</code> values in the database. You should do this conversion before
setting the global config option to true. An example query to accomplish this
is as follows:</p>

<pre class="code javascript"><code class="javascript">db.bands.updateMany({
  &quot;field&quot;: { &quot;$exists&quot;: true }
}, [
  {
    &quot;$set&quot;: {
      &quot;field&quot;: { &quot;$toDecimal&quot;: &quot;$field&quot; }
    }
  }
])
</code></pre>

<p>This query updates all documents that have the given field, setting that
field to its corresponding <code>decimal128</code> value. Note that this query only
works in MongoDB 4.2+.</p></li>
<li><p>The <code>Mongoid.map_big_decimal_to_decimal128</code> global config option can be
set to <code>true</code>, and you can have both strings and <code>decimal128</code> values for
that field. This way, only <code>decimal128</code> values will be inserted into and
updated to the database going forward. Note that you still don&#39;t get the
full advantages of using only <code>decimal128</code> values, but your dataset is
slowly migrating to all <code>decimal128</code> values, as old string values are
updated to <code>decimal128</code> and new <code>decimal128</code> values are added. With this
setup, you can still query for <code>BigDecimal</code> values as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_map_big_decimal_to_decimal128'>map_big_decimal_to_decimal128</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='id identifier rubyid_big_decimal'>big_decimal</span> <span class='op'>=</span> <span class='const'>BigDecimal</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>2E9</span><span class='tstring_end'>&#39;</span></span>)
<span class='const'>Band</span>.<span class='id identifier rubyid_in'>in</span>(<span class='label'>sales:</span> [<span class='id identifier rubyid_big_decimal'>big_decimal</span><span class='comma'>,</span> <span class='id identifier rubyid_big_decimal'>big_decimal</span>.<span class='id identifier rubyid_to_s'>to_s</span>]).<span class='id identifier rubyid_to_a'>to_a</span></code></pre>

<p>This query will find all values that are either a <code>decimal128</code> value or
a string that match that value.</p></li>
</ol>

<h3>Using Symbols Or Strings Instead Of Classes</h3>

<p>Mongoid permits using symbols or strings instead of classes to specify the
type of fields, for example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_integer'>integer</span>
  <span class='comment'># Equivalent to:
</span>  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>integer</span><span class='tstring_end'>&quot;</span></span>
  <span class='comment'># Equivalent to:
</span>  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
<span class='kw'>end</span></code></pre>

<p>Only standard field types as listed below can be specified using symbols or
strings in this manner. Mongoid recognizes the following expansions:</p>

<ul>
<li>  <code>:array</code> =&gt; <a href="Array.html" title="Array (class)"><code>Array</code></a></li>
<li>  <code>:big_decimal</code> =&gt; <code>BigDecimal</code></li>
<li>  <code>:binary</code> =&gt; <a href="BSON/Binary.html" title="BSON::Binary (class)"><code>::BSON::Binary</code></a></li>
<li>  <code>:boolean</code> =&gt; <a href="Mongoid/Boolean.html" title="Mongoid::Boolean (class)"><code>::Mongoid::Boolean</code></a></li>
<li>  <code>:date</code> =&gt; <a href="Date.html" title="Date (class)"><code>Date</code></a></li>
<li>  <code>:date_time</code> =&gt; <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a></li>
<li>  <code>:float</code> =&gt; <a href="Float.html" title="Float (class)"><code>Float</code></a></li>
<li>  <code>:hash</code> =&gt; <a href="Hash.html" title="Hash (class)"><code>Hash</code></a></li>
<li>  <code>:integer</code> =&gt; <a href="Integer.html" title="Integer (class)"><code>Integer</code></a></li>
<li>  <code>:object_id</code> =&gt; <a href="BSON/ObjectId.html" title="BSON::ObjectId (class)"><code>::BSON::ObjectId</code></a></li>
<li>  <code>:range</code> =&gt; <code>Range</code></li>
<li>  <code>:regexp</code> =&gt; <a href="Regexp.html" title="Regexp (class)"><code>Regexp</code></a></li>
<li>  <code>:set</code> =&gt; <a href="Set.html" title="Set (class)"><code>Set</code></a></li>
<li>  <code>:string</code> =&gt; <a href="String.html" title="String (class)"><code>String</code></a></li>
<li>  <code>:stringified_symbol</code> =&gt; <code>StringifiedSymbol</code></li>
<li>  <code>:symbol</code> =&gt; <a href="Symbol.html" title="Symbol (class)"><code>Symbol</code></a></li>
<li>  <code>:time</code> =&gt; <a href="Time.html" title="Time (class)"><code>Time</code></a></li>
</ul>

<h3>Specifying Field Default Values [field-default-values]</h3>

<p>A field can be configured to have a default value. The default value can be
fixed, as in the following example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>created</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></code></pre>

<p>The default value can also be specified as a <code>Proc</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Order</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_fulfill_by'>fulfill_by</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tlambda'>-&gt;</span><span class='tlambeg'>{</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='int'>3</span>.<span class='id identifier rubyid_days'>days</span> }
<span class='kw'>end</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Default values that are not <code>Proc</code> instances are evaluated at class load
time, meaning the following two definitions are not equivalent:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_submitted_at'>submitted_at</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span>
<span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_submitted_at'>submitted_at</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tlambda'>-&gt;</span><span class='tlambeg'>{</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span> }</code></pre>

<p>The second definition is most likely the desired one, which causes the
time of submission to be set to the current time at the moment of
document instantiation.</p>

<p></div></p>

<p>To set a default which depends on the document&#39;s state, use <code>self</code>
inside the <code>Proc</code> instance which would evaluate to the document instance
being operated on:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_fulfill_by'>fulfill_by</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tlambda'>-&gt;</span><span class='tlambeg'>{</span>
  <span class='comment'># Order should be fulfilled in 2 business hours.
</span>  <span class='kw'>if</span> (<span class='int'>7</span><span class='op'>..</span><span class='int'>8</span>).<span class='id identifier rubyid_include?'>include?</span>(<span class='kw'>self</span>.<span class='id identifier rubyid_submitted_at'>submitted_at</span>.<span class='id identifier rubyid_hour'>hour</span>)
    <span class='kw'>self</span>.<span class='id identifier rubyid_submitted_at'>submitted_at</span> <span class='op'>+</span> <span class='int'>4</span>.<span class='id identifier rubyid_hours'>hours</span>
  <span class='kw'>elsif</span> (<span class='int'>9</span><span class='op'>..</span><span class='int'>3</span>).<span class='id identifier rubyid_include?'>include?</span>(<span class='kw'>self</span>.<span class='id identifier rubyid_submitted_at'>submitted_at</span>.<span class='id identifier rubyid_hour'>hour</span>)
    <span class='kw'>self</span>.<span class='id identifier rubyid_submitted_at'>submitted_at</span> <span class='op'>+</span> <span class='int'>2</span>.<span class='id identifier rubyid_hours'>hours</span>
  <span class='kw'>else</span>
    (<span class='kw'>self</span>.<span class='id identifier rubyid_submitted_at'>submitted_at</span> <span class='op'>+</span> <span class='int'>1</span>.<span class='id identifier rubyid_day'>day</span>).<span class='id identifier rubyid_change'>change</span>(<span class='label'>hour:</span> <span class='int'>11</span>)
  <span class='kw'>end</span>
}</code></pre>

<p>When defining a default value as a <code>Proc</code>, Mongoid will apply the default
after all other attributes are set and associations are initialized.
To have the default be applied before the other attributes are set,
use the <code>pre_processed: true</code> field option:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_fulfill_by'>fulfill_by</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tlambda'>-&gt;</span><span class='tlambeg'>{</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='int'>3</span>.<span class='id identifier rubyid_days'>days</span> }<span class='comma'>,</span>
  <span class='label'>pre_processed:</span> <span class='kw'>true</span></code></pre>

<p>The <code>pre_processed: true</code> option is also necessary when specifying a custom
default value via a <code>Proc</code> for the <code>_id</code> field, to ensure the <code>_id</code>
is set correctly via associations:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span> <span class='label'>pre_processed:</span> <span class='kw'>true</span></code></pre>

<h3>Specifying Storage Field Names [storage-field-names]</h3>

<p>One of the drawbacks of having a schemaless database is that MongoDB must
store all field information along with every document, meaning that it
takes up a lot of storage space in RAM and on disk. A common pattern to limit
this is to alias fields to a small number of characters, while keeping the
domain in the application expressive. Mongoid allows you to do this and
reference the fields in the domain via their long names in getters, setters,
and criteria while performing the conversion for you.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Placebo</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_attributes'>attributes</span> <span class='comment'># { &quot;n&quot; =&gt; &quot;Placebo&quot; }
</span>
<span class='id identifier rubyid_criteria'>criteria</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Placebo</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_criteria'>criteria</span>.<span class='id identifier rubyid_selector'>selector</span> <span class='comment'># { &quot;n&quot; =&gt; &quot;Placebo&quot; }</span></code></pre>

<h3>Field Aliases</h3>

<p>It is possible to define field aliases. The value will be stored in the
destination field but can be accessed from either the destination field or
from the aliased field:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_alias_attribute'>alias_attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>n:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Astral Projection</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># =&gt; #&lt;Band _id: 5fc1c1ee2c97a64accbeb5e1, name: &quot;Astral Projection&quot;&gt;
</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_attributes'>attributes</span>
<span class='comment'># =&gt; {&quot;_id&quot;=&gt;BSON::ObjectId(&#39;5fc1c1ee2c97a64accbeb5e1&#39;), &quot;name&quot;=&gt;&quot;Astral Projection&quot;}
</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_n'>n</span>
<span class='comment'># =&gt; &quot;Astral Projection&quot;</span></code></pre>

<p>Aliases can be removed from model classes using the <code>unalias_attribute</code>
method.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_unalias_attribute'>unalias_attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_n'>n</span>
<span class='kw'>end</span></code></pre>

<h4>Unaliasing <code>id</code> [unalias-id]</h4>

<p><code>unalias_attribute</code> can be used to remove the predefined <code>id</code> alias.
This is useful for storing different values in <code>id</code> and <code>_id</code> fields:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_unalias_attribute'>unalias_attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span>

<span class='const'>Band</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>id:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>42</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># =&gt; #&lt;Band _id: 5fc1c3f42c97a6590684046c, id: &quot;42&quot;&gt;</span></code></pre>

<h3>Reserved Names</h3>

<p>Attempting to define a field on a document that conflicts with a reserved
method name in Mongoid will raise an error. The list of reserved names can
be obtained by invoking the <code>Mongoid.destructive_fields</code> method.</p>

<h3>Field Redefinition</h3>

<p>By default Mongoid allows redefining fields on a model. To raise an error
when a field is redefined, set the <code>duplicate_fields_exception</code>
<code>configuration option &lt;configuration-options&gt;</code> to <code>true</code>.</p>

<p>With the option set to true, the following example will raise an error:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span></code></pre>

<p>To define the field anyway, use the <code>overwrite: true</code> option:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span> <span class='label'>overwrite:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<h3>Custom IDs [custom-id]</h3>

<p>By default, Mongoid defines the <code>_id</code> field on documents to contain a
<a href="BSON/ObjectId.html" title="BSON::ObjectId (class)"><code>::BSON::ObjectId</code></a> value which is automatically generated by Mongoid.</p>

<p>It is possible to replace the <code>_id</code> field definition to change the type
of the <code>_id</code> values or have different default values:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tlambda'>-&gt;</span><span class='tlambeg'>{</span> <span class='id identifier rubyid_name'>name</span> }
<span class='kw'>end</span></code></pre>

<p>It is possible to omit the default entirely:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span></code></pre>

<p>If the default on <code>_id</code> is omitted, and no <code>_id</code> value is provided by
your application, Mongoid will persist the document without the <code>_id</code>
value. In this case, if the document is a top-level document, an <code>_id</code>
value will be assigned by the server; if the document is an embedded document,
no <code>_id</code> value will be assigned. Mongoid will not automatically retrieve
this value, if assigned, when the document is persisted - you
must obtain the persisted value (and the complete persisted document) using
other means:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='op'>=&gt;</span> <span class='comment'>#&lt;Band _id: , &gt;
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_id'>id</span>
<span class='op'>=&gt;</span> <span class='kw'>nil</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_reload'>reload</span>
<span class='comment'># raises Mongoid::Errors::DocumentNotFound
</span><span class='const'>Band</span>.<span class='id identifier rubyid_last'>last</span>
<span class='op'>=&gt;</span> <span class='comment'>#&lt;Band _id: 5fc681c22c97a6791f324b99, &gt;</span></code></pre>

<p>Omitting <code>_id</code> fields is more common in <code>embedded documents &lt;omit-id&gt;</code>.</p>

<p>Mongoid also defines the <code>id</code> field aliased to <code>_id</code>. The <code>id</code>
alias can <code>be removed &lt;unalias-id&gt;</code> if desired (such as to integrate
with systems that use the <code>id</code> field to store value different from <code>_id</code>.</p>

<h3>Uncastable Values</h3>

<p>In Mongoid 8, Mongoid has standardized the treatment of the assignment and
reading of &quot;uncastable&quot; values. A value is considered &quot;uncastable&quot; when it
cannot be coerced to the type of its field. For example, an array would be an
&quot;uncastable&quot; value to an Integer field.</p>

<h4>Assigning Uncastable Values</h4>

<p>The assignment of uncastable values has been standardized to assign <code>nil</code> by
default. Consider the following example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
<span class='kw'>end</span>

<span class='const'>User</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>name:</span> [ <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&quot;</span></span> ])</code></pre>

<p>Assigning an array to a field of type Integer doesn&#39;t work since an array can&#39;t
be coerced to an Integer. The assignment of uncastable values to a field will
cause a <code>nil</code> to be written:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>name:</span> [ <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Mike</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Trout</span><span class='tstring_end'>&quot;</span></span> ])
<span class='comment'># =&gt; #&lt;User _id: 62b222d43282a47bf73e3264, name: nil&gt;</span></code></pre>

<p>Note that the original uncastable values will be stored in the
<code>attributes_before_type_cast</code> hash with their field names:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_attributes_before_type_cast'>attributes_before_type_cast</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span>]
<span class='comment'># =&gt; [&quot;Mike&quot;, &quot;Trout&quot;]</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Note that for numeric fields, any class that defines <code>to_i</code> for Integer
fields, <code>to_f</code> for Floats, and <code>to_d</code> for BigDecimals, is castable.
Strings are the exception and will only call the corresponding <code>href="">to</a>*</code>
method if the string is numeric. If a class only defines <code>to_i</code> and not
<code>to_f</code> and is being assigned to a Float field, this is uncastable, and Mongoid
will not perform a two-step conversion (i.e. <code>to_i</code> and then <code>to_f</code>).</p>

<p></div></p>

<h4>Reading Uncastable Values</h4>

<p>When documents in the database contain values of different types than their
representations in Mongoid, if Mongoid cannot coerce them into the correct type,
it will replace the value with <code>nil</code>. Consider the following model and document in the
database:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby">{ <span class='label'>_id:</span> <span class='op'>...</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='op'>:</span> [ <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Mike</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Trout</span><span class='tstring_end'>&quot;</span></span> ] }</code></pre>

<p>Reading this document from the database will result in the model&#39;s name field
containing <code>nil</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_name'>name</span>
<span class='comment'># =&gt; nil</span></code></pre>

<p>The database value of type array cannot be stored in the attribute, since the
array can&#39;t be coerced to an Integer. Note that the original uncastable values
will be stored in the <code>attributes_before_type_cast</code> hash with their field
names:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_attributes_before_type_cast'>attributes_before_type_cast</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span>]
<span class='comment'># =&gt; [&quot;Mike&quot;, &quot;Trout&quot;]</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>The <code>demongoize</code> methods on container objects (i.e. Hash, Array) have not
been changed to permit automatic persistence of mutated container attributes.
See <a href="https://jira.mongodb.org/browse/MONGOID-2951">MONGOID-2951</a> for a
longer discussion of this topic.</p>

<p></div></p>

<h2>Customizing Field Behavior</h2>

<p>Mongoid offers several ways to customize the behavior of fields.</p>

<h3>Custom Getters And Setters</h3>

<p>You may override getters and setters for fields to modify the values
when they are being accessed or written. The getters and setters use the
same name as the field. Use <code>read_attribute</code> and <code>write_attribute</code>
methods inside the getters and setters to operate on the raw attribute
values.</p>

<p>For example, Mongoid provides the <code>:default</code> field option to write a
default value into the field. If you wish to have a field default value
in your application but do not wish to persist it, you can override the
getter as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>DistanceMeasurement</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Float.html" title="Float (class)">Float</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unit'>unit</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unit'>unit</span>
    <span class='id identifier rubyid_read_attribute'>read_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_unit'>unit</span>) <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>m</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_to_s'>to_s</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_unit'>unit</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_measurement'>measurement</span> <span class='op'>=</span> <span class='const'>DistanceMeasurement</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>value:</span> <span class='int'>2</span>)
<span class='id identifier rubyid_measurement'>measurement</span>.<span class='id identifier rubyid_to_s'>to_s</span>
<span class='comment'># =&gt; &quot;2.0 m&quot;
</span><span class='id identifier rubyid_measurement'>measurement</span>.<span class='id identifier rubyid_attributes'>attributes</span>
<span class='comment'># =&gt; {&quot;_id&quot;=&gt;BSON::ObjectId(&#39;613fa0b0a15d5d61502f3447&#39;), &quot;value&quot;=&gt;2.0}</span></code></pre>

<p>To give another example, a field which converts empty strings to nil values
may be implemented as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>DistanceMeasurement</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Float.html" title="Float (class)">Float</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unit'>unit</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unit='>unit=</span>(<span class='id identifier rubyid_value'>value</span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_blank?'>blank?</span>
      <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_write_attribute'>write_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_unit'>unit</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_measurement'>measurement</span> <span class='op'>=</span> <span class='const'>DistanceMeasurement</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>value:</span> <span class='int'>2</span><span class='comma'>,</span> <span class='label'>unit:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_measurement'>measurement</span>.<span class='id identifier rubyid_attributes'>attributes</span>
<span class='comment'># =&gt; {&quot;_id&quot;=&gt;BSON::ObjectId(&#39;613fa15aa15d5d617216104c&#39;), &quot;value&quot;=&gt;2.0, &quot;unit&quot;=&gt;nil}</span></code></pre>

<h3>Custom Field Types</h3>

<p>You can define custom types in Mongoid and determine how they are serialized
and deserialized. In this example, we define a new field type <code>Point</code>, which we
can use in our model class as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Profile</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_location'>location</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Point</span>
<span class='kw'>end</span></code></pre>

<p>Then make a Ruby class to represent the type. This class must define methods
used for MongoDB serialization and deserialization as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Point</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_y'>y</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_y'>y</span>)
    <span class='ivar'>@x</span><span class='comma'>,</span> <span class='ivar'>@y</span> <span class='op'>=</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_y'>y</span>
  <span class='kw'>end</span>

  <span class='comment'># Converts an object of this instance into a database friendly value.
</span>  <span class='comment'># In this example, we store the values in the database as array.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_mongoize'>mongoize</span>
    [ <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_y'>y</span> ]
  <span class='kw'>end</span>

  <span class='kw'>class</span> <span class='op'>&lt;&lt;</span> <span class='kw'>self</span>

    <span class='comment'># Takes any possible object and converts it to how it would be
</span>    <span class='comment'># stored in the database.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_mongoize'>mongoize</span>(<span class='id identifier rubyid_object'>object</span>)
      <span class='kw'>case</span> <span class='id identifier rubyid_object'>object</span>
      <span class='kw'>when</span> <span class='const'>Point</span> <span class='kw'>then</span> <span class='id identifier rubyid_object'>object</span>.<span class='id identifier rubyid_mongoize'>mongoize</span>
      <span class='kw'>when</span> <span class='const'><a href="Hash.html" title="Hash (class)">Hash</a></span> <span class='kw'>then</span> <span class='const'>Point</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_object'>object</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_x'>x</span>]<span class='comma'>,</span> <span class='id identifier rubyid_object'>object</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_y'>y</span>]).<span class='id identifier rubyid_mongoize'>mongoize</span>
      <span class='kw'>else</span> <span class='id identifier rubyid_object'>object</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Get the object as it was stored in the database, and instantiate
</span>    <span class='comment'># this custom class from it.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_demongoize'>demongoize</span>(<span class='id identifier rubyid_object'>object</span>)
      <span class='const'>Point</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_object'>object</span>[<span class='int'>0</span>]<span class='comma'>,</span> <span class='id identifier rubyid_object'>object</span>[<span class='int'>1</span>])
    <span class='kw'>end</span>

    <span class='comment'># Converts the object that was supplied to a criteria and converts it
</span>    <span class='comment'># into a query-friendly form.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_evolve'>evolve</span>(<span class='id identifier rubyid_object'>object</span>)
      <span class='kw'>case</span> <span class='id identifier rubyid_object'>object</span>
      <span class='kw'>when</span> <span class='const'>Point</span> <span class='kw'>then</span> <span class='id identifier rubyid_object'>object</span>.<span class='id identifier rubyid_mongoize'>mongoize</span>
      <span class='kw'>else</span> <span class='id identifier rubyid_object'>object</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The instance method <code>mongoize</code> takes an instance of your custom type object, and
converts it into a representation of how it will be stored in the database, i.e. to pass
to the MongoDB Ruby driver. In our example above, we want to store our <code>Point</code>
object as an <a href="Array.html" title="Array (class)"><code>Array</code></a> in the form <code>[ x, y ]</code>.</p>

<p>The class method <code>mongoize</code> is similar to the instance method, however it must handle
objects of all possible types as inputs. The <code>mongoize</code> method is used when calling the
setter methods for fields of your custom type.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_point'>point</span> <span class='op'>=</span> <span class='const'>Point</span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>12</span><span class='comma'>,</span> <span class='int'>24</span>)
<span class='id identifier rubyid_venue'>venue</span> <span class='op'>=</span> <span class='const'>Venue</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>location:</span> <span class='id identifier rubyid_point'>point</span>) <span class='comment'># This uses the Point#mongoize instance method.
</span><span class='id identifier rubyid_venue'>venue</span> <span class='op'>=</span> <span class='const'>Venue</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>location:</span> [ <span class='int'>12</span><span class='comma'>,</span> <span class='int'>24</span> ]) <span class='comment'># This uses the Point.mongoize class method.</span></code></pre>

<p>The class method <code>demongoize</code> does the inverse of <code>mongoize</code>. It takes the raw object
from the MongoDB Ruby driver and converts it to an instance of your custom type.
In this case, the database driver returns an <a href="Array.html" title="Array (class)"><code>Array</code></a> and we instantiate a <code>Point</code> from it.
The <code>demongoize</code> method is used when calling the getters of fields for your custom type.
Note that in the example above, since <code>demongoize</code> calls <code>Point.new</code>, a new instance of
<code>Point</code> will be generated on each call to the getter.</p>

<p>Mongoid will always call the <code>demongoize</code> method on values that were
retrieved from the database, but applications may, in theory, call
<code>demongoize</code> with arbitrary input. It is recommended that applications add
handling for arbitrary input in their <code>demongoize</code> methods. We can rewrite
<code>Point</code>&#39;s demongoize method as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_demongoize'>demongoize</span>(<span class='id identifier rubyid_object'>object</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_object'>object</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="Array.html" title="Array (class)">Array</a></span>) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_object'>object</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>2</span>
    <span class='const'>Point</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_object'>object</span>[<span class='int'>0</span>]<span class='comma'>,</span> <span class='id identifier rubyid_object'>object</span>[<span class='int'>1</span>])
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Notice that <code>demongoize</code> will only create a new <code>Point</code> if given an array
of length 2, and will return <code>nil</code> otherwise. Both the <code>mongoize</code> and
<code>demongoize</code> methods should be prepared to receive arbitrary input and should
return <code>nil</code> on values that are uncastable to your custom type. See the
section on <code>Uncastable Values &lt;uncastable-values&gt;</code> for more details.</p>

<p>Lastly, the class method <code>evolve</code> is similar to <code>mongoize</code>, however it is used
when transforming objects for use in Mongoid query criteria.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_point'>point</span> <span class='op'>=</span> <span class='const'>Point</span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>12</span><span class='comma'>,</span> <span class='int'>24</span>)
<span class='const'>Venue</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>location:</span> <span class='id identifier rubyid_point'>point</span>) <span class='comment'># This uses Point.evolve</span></code></pre>

<p>The <code>evolve</code> method should also be prepared to receive arbitrary input,
however, unlike the <code>mongoize</code> and <code>demongoize</code> methods, it should return
the inputted value on values that are uncastable to your custom type. See the
section on <code>Uncastable Values &lt;uncastable-values&gt;</code> for more details.</p>

<h4>Phantom Custom Field Types</h4>

<p>The custom field type may perform conversions from user-visible attribute
values to the values stored in the database when the user-visible attribute
value type is different from the declared field type. For example, this
can be used to implement a mapping from one enumeration to another, to
have more descriptive values in the application and more compact values stored
in the database:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ColorMapping</span>

  <span class='const'>MAPPING</span> <span class='op'>=</span> {
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>black</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='int'>0</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>white</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='comma'>,</span>
  }.<span class='id identifier rubyid_freeze'>freeze</span>

  <span class='const'>INVERSE_MAPPING</span> <span class='op'>=</span> <span class='const'>MAPPING</span>.<span class='id identifier rubyid_invert'>invert</span>.<span class='id identifier rubyid_freeze'>freeze</span>

  <span class='kw'>class</span> <span class='op'>&lt;&lt;</span> <span class='kw'>self</span>

    <span class='comment'># Takes application-scope value and converts it to how it would be
</span>    <span class='comment'># stored in the database. Converts invalid values to nil.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_mongoize'>mongoize</span>(<span class='id identifier rubyid_object'>object</span>)
      <span class='const'>MAPPING</span>[<span class='id identifier rubyid_object'>object</span>]
    <span class='kw'>end</span>

    <span class='comment'># Get the value as it was stored in the database, and convert to
</span>    <span class='comment'># application-scope value. Converts invalid values to nil.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_demongoize'>demongoize</span>(<span class='id identifier rubyid_object'>object</span>)
      <span class='const'>INVERSE_MAPPING</span>[<span class='id identifier rubyid_object'>object</span>]
    <span class='kw'>end</span>

    <span class='comment'># Converts the object that was supplied to a criteria and converts it
</span>    <span class='comment'># into a query-friendly form. Returns invalid values as is.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_evolve'>evolve</span>(<span class='id identifier rubyid_object'>object</span>)
      <span class='const'>MAPPING</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='id identifier rubyid_object'>object</span><span class='comma'>,</span> <span class='id identifier rubyid_object'>object</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Profile</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_color'>color</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>ColorMapping</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_profile'>profile</span> <span class='op'>=</span> <span class='const'>Profile</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>color:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>white</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_profile'>profile</span>.<span class='id identifier rubyid_color'>color</span>
<span class='comment'># =&gt; &quot;white&quot;
</span>
<span class='comment'># Writes 0 to color field
</span><span class='id identifier rubyid_profile'>profile</span>.<span class='id identifier rubyid_save!'>save!</span></code></pre>

<h3>Custom Field Options</h3>

<p>You may define custom options for the <code>field</code> macro function
which extend its behavior at the your time model classes are loaded.</p>

<p>As an example, we will define a <code>:max_length</code> option which will add a length
validator for the field. First, declare the new field option in an initializer,
specifying its handler function as a block:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># in /config/initializers/mongoid_custom_fields.rb
</span>
<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Fields.html" title="Mongoid::Fields (module)">Fields</a></span>.<span class='id identifier rubyid_option'><a href="Mongoid/Fields.html#option-class_method" title="Mongoid::Fields.option (method)">option</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_max_length'>max_length</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_model'>model</span><span class='comma'>,</span> <span class='id identifier rubyid_field'>field</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
  <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_validates_length_of'>validates_length_of</span> <span class='id identifier rubyid_field'>field</span>.<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>maximum:</span> <span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span></code></pre>

<p>Then, use it your model class:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span> <span class='label'>max_length:</span> <span class='int'>10</span>
<span class='kw'>end</span></code></pre>

<p>Note that the handler function will be invoked whenever the option is used
in the field definition, even if the option&#39;s value is false or nil.</p>

<h2>Dynamic Fields</h2>

<p>By default, Mongoid requires all fields that may be set on a document to
be explicitly defined using <code>field</code> declarations. Mongoid also supports
creating fields on the fly from an arbitrary hash or documents stored in
the database. When a model uses fields not explicitly defined, such fields
are called <em>dynamic fields</em>.</p>

<p>To enable dynamic fields, include <a href="Mongoid/Attributes/Dynamic.html" title="Mongoid::Attributes::Dynamic (module)"><code>::Mongoid::Attributes::Dynamic</code></a> module
in the model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Attributes.html" title="Mongoid::Attributes (module)">Attributes</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Attributes/Dynamic.html" title="Mongoid::Attributes::Dynamic (module)">Dynamic</a></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_bob'>bob</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Bob</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>age:</span> <span class='int'>42</span>)
<span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_name'>name</span>
<span class='comment'># =&gt; &quot;Bob&quot;</span></code></pre>

<p>It is possible to use <code>field</code> declarations and dynamic fields in the same
model class. Attributes for which there is a <code>field</code> declaration will be
treated according to the <code>field</code> declaration, with remaining attributes
being treated as dynamic fields.</p>

<p>Attribute values in the dynamic fields must initially be set by either
passing the attribute hash to the constructor, mass assignment via
<code>attributes=</code>, mass assignment via <code>[]=</code>, using <code>write_attribute</code>,
or they must already be present in the database.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># OK
</span><span class='id identifier rubyid_bob'>bob</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Bob</span><span class='tstring_end'>&#39;</span></span>)

<span class='comment'># OK
</span><span class='id identifier rubyid_bob'>bob</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_attributes'>attributes</span> <span class='op'>=</span> {<span class='label'>age:</span> <span class='int'>42</span>}

<span class='comment'># OK
</span><span class='id identifier rubyid_bob'>bob</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_bob'>bob</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>age</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='int'>42</span>

<span class='comment'># Raises NoMethodError: undefined method age=
</span><span class='id identifier rubyid_bob'>bob</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_age'>age</span> <span class='op'>=</span> <span class='int'>42</span>

<span class='comment'># OK
</span><span class='id identifier rubyid_bob'>bob</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_new'>new</span>
<span class='comment'># OK - string access
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_write_attribute'>write_attribute</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>age</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>42</span>)
<span class='comment'># OK - symbol access
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_write_attribute'>write_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Bob</span><span class='tstring_end'>&#39;</span></span>)

<span class='comment'># OK, initializes attributes from whatever is in the database
</span><span class='id identifier rubyid_bob'>bob</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_find'>find</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>123</span><span class='tstring_end'>&#39;</span></span>)</code></pre>

<p>If an attribute is not present in a particular model instance&#39;s attributes
hash, both the reader and the writer for the corresponding field are not
defined, and invoking them raises <code>NoMethodError</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bob'>bob</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_attributes'>attributes</span> <span class='op'>=</span> {<span class='label'>age:</span> <span class='int'>42</span>}

<span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_age'>age</span>
<span class='comment'># =&gt; 42
</span>
<span class='comment'># raises NoMethodError
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_name'>name</span>

<span class='comment'># raises NoMethodError
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Bob</span><span class='tstring_end'>&#39;</span></span>

<span class='comment'># OK
</span><span class='id identifier rubyid_bob'>bob</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Bob</span><span class='tstring_end'>&#39;</span></span>

<span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_name'>name</span>
<span class='comment'># =&gt; &quot;Bob&quot;</span></code></pre>

<p>Attributes can always be read using mass attribute access or <code>read_attribute</code>
(this applies to models not using dynamic fields as well):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bob'>bob</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>age:</span> <span class='int'>42</span>)

<span class='comment'># OK - string access
</span><span class='id identifier rubyid_bob'>bob</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span>]
<span class='comment'># =&gt; nil
</span>
<span class='comment'># OK - symbol access
</span><span class='id identifier rubyid_bob'>bob</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>]
<span class='comment'># =&gt; nil
</span>
<span class='comment'># OK - string access
</span><span class='id identifier rubyid_bob'>bob</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>age</span><span class='tstring_end'>&#39;</span></span>]
<span class='comment'># =&gt; 42
</span>
<span class='comment'># OK - symbol access
</span><span class='id identifier rubyid_bob'>bob</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span>]
<span class='comment'># =&gt; 42
</span>
<span class='comment'># OK
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_attributes'>attributes</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span>]
<span class='comment'># =&gt; nil
</span>
<span class='comment'># OK
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_attributes'>attributes</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>age</span><span class='tstring_end'>&#39;</span></span>]
<span class='comment'># =&gt; 42
</span>
<span class='comment'># Returns nil - keys are always strings
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_attributes'>attributes</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span>]
<span class='comment'># =&gt; nil
</span>
<span class='comment'># OK
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_read_attribute'>read_attribute</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># =&gt; nil
</span>
<span class='comment'># OK
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_read_attribute'>read_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>)
<span class='comment'># =&gt; nil
</span>
<span class='comment'># OK - string access
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_read_attribute'>read_attribute</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>age</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># =&gt; 42
</span>
<span class='comment'># OK - symbol access
</span><span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_read_attribute'>read_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span>)
<span class='comment'># =&gt; 42</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>The values returned from the <code>read_attribute</code> method, and those stored in
the <code>attributes</code> hash, are the <code>mongoized</code> values.</p>

<p></div></p>

<h3>Special Characters in Field Names</h3>

<p>Mongoid permits dynamic field names to include spaces and punctuation:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bob'>bob</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_new'>new</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello world</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>MDB</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_send'>send</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello world</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># =&gt; &quot;MDB&quot;
</span>
<span class='id identifier rubyid_bob'>bob</span>.<span class='id identifier rubyid_write_attribute'>write_attribute</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello%world</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>MDB</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_bob'>bob</span>[<span class='symbeg'>:&quot;</span><span class='tstring_content'>hello%world</span><span class='tstring_end'>&quot;</span></span>]
<span class='comment'># =&gt; &quot;MDB&quot;</span></code></pre>

<h2>Localized Fields</h2>

<p>Mongoid supports localized fields via the <a href="https://github.com/ruby-i18n/i18n">I18n gem</a>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Product</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_description'>description</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span> <span class='label'>localize:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>By telling the field to <code>localize</code>, Mongoid will under the covers store the field
as a hash of locale/value pairs, but normal access to it will behave like a string.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>I18n</span>.<span class='id identifier rubyid_default_locale'>default_locale</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_en'>en</span>
<span class='id identifier rubyid_product'>product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description'>description</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Marvelous!</span><span class='tstring_end'>&quot;</span></span>
<span class='const'>I18n</span>.<span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_de'>de</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description'>description</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Fantastisch!</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_attributes'>attributes</span>
<span class='comment'># { &quot;description&quot; =&gt; { &quot;en&quot; =&gt; &quot;Marvelous!&quot;, &quot;de&quot; =&gt; &quot;Fantastisch!&quot; }</span></code></pre>

<p>You can get and set all the translations at once by using the corresponding <code>_translations</code> method.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description_translations'>description_translations</span>
<span class='comment'># { &quot;en&quot; =&gt; &quot;Marvelous!&quot;, &quot;de&quot; =&gt; &quot;Fantastisch!&quot; }
</span><span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description_translations'>description_translations</span> <span class='op'>=</span>
  { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>en</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Marvelous!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>de</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Wunderbar!</span><span class='tstring_end'>&quot;</span></span> }</code></pre>

<p>Localized fields can be used with any field type. For example, they can be used
with float fields for differences with currency:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Product</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_price'>price</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Float.html" title="Float (class)">Float</a></span><span class='comma'>,</span> <span class='label'>localize:</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_currency'>currency</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span> <span class='label'>localize:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>By creating the model in this way, we can separate the price from the currency
type, which allows you to use all of the number-related functionalities on the
price when querying or aggregating that field (provided that you index into the
stored translations hash). We can create an instance of this model as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_product'>product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_new'>new</span>
<span class='const'>I18n</span>.<span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_en'>en</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_price'>price</span> <span class='op'>=</span> <span class='float'>1.00</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_currency'>currency</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$</span><span class='tstring_end'>&quot;</span></span>
<span class='const'>I18n</span>.<span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_he'>he</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_price'>price</span> <span class='op'>=</span> <span class='float'>3.24</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_currency'>currency</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>₪</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_attributes'>attributes</span>
<span class='comment'># =&gt; { &quot;price&quot; =&gt; { &quot;en&quot; =&gt; 1.0, &quot;he&quot; =&gt; 3.24 }, &quot;currency&quot; =&gt; { &quot;en&quot; =&gt; &quot;$&quot;, &quot;he&quot; =&gt; &quot;₪&quot;  } }</span></code></pre>

<h3>Localize <code>:present</code> Field Option [present-fields]</h3>

<p>Mongoid supports the <code>:present</code> option when creating a localized field:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Product</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_description'>description</span><span class='comma'>,</span> <span class='label'>localize:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_present'>present</span>
<span class='kw'>end</span></code></pre>

<p>This option automatically removes <code>blank</code> values (i.e. those that return true
for the <code>blank?</code> method) from the <code>_translations</code> hash:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>I18n</span>.<span class='id identifier rubyid_default_locale'>default_locale</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_en'>en</span>
<span class='id identifier rubyid_product'>product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description'>description</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Marvelous!</span><span class='tstring_end'>&quot;</span></span>
<span class='const'>I18n</span>.<span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_de'>de</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description'>description</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Fantastisch!</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description_translations'>description_translations</span>
<span class='comment'># { &quot;en&quot; =&gt; &quot;Marvelous!&quot;, &quot;de&quot; =&gt; &quot;Fantastisch!&quot; }
</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description'>description</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description_translations'>description_translations</span>
<span class='comment'># { &quot;en&quot; =&gt; &quot;Marvelous!&quot; }</span></code></pre>

<p>When the empty string is written for the <code>:de</code> locale, the <code>&quot;de&quot;</code> key is
removed from the <code>_translations</code> hash instead of writing the empty string.</p>

<h3>Fallbacks</h3>

<p>Mongoid integrates with
<a href="https://github.com/ruby-i18n/i18n/wiki/Fallbacks">i18n fallbacks</a>.
To use the fallbacks, the respective functionality must be explicitly enabled.</p>

<p>In a Rails application, set the <code>config.i18n.fallbacks</code> configuration setting
to <code>true</code> in your environment and specify the fallback languages:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_i18n'>i18n</span>.<span class='id identifier rubyid_fallbacks'>fallbacks</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_after_initialize'>after_initialize</span> <span class='kw'>do</span>
  <span class='const'>I18n</span>.<span class='id identifier rubyid_fallbacks'>fallbacks</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_de'>de</span>] <span class='op'>=</span> [ <span class='symbeg'>:</span><span class='id identifier rubyid_en'>en</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_es'>es</span> ]
<span class='kw'>end</span></code></pre>

<p>In a non-Rails application, include the fallbacks module into the I18n backend
you are using and specify the fallback languages:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>i18n/backend/fallbacks</span><span class='tstring_end'>&quot;</span></span>
<span class='const'>I18n</span><span class='op'>::</span><span class='const'>Backend</span><span class='op'>::</span><span class='const'>Simple</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_include'>include</span><span class='comma'>,</span> <span class='const'>I18n</span><span class='op'>::</span><span class='const'>Backend</span><span class='op'>::</span><span class='const'>Fallbacks</span>)
<span class='const'>I18n</span>.<span class='id identifier rubyid_fallbacks'>fallbacks</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_de'>de</span>] <span class='op'>=</span> [ <span class='symbeg'>:</span><span class='id identifier rubyid_en'>en</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_es'>es</span> ]</code></pre>

<p>When fallbacks are enabled, if a translation is not present in the active
language, translations will be looked up in the fallback languages:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_product'>product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_new'>new</span>
<span class='const'>I18n</span>.<span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_en'>en</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description'>description</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Marvelous!</span><span class='tstring_end'>&quot;</span></span>
<span class='const'>I18n</span>.<span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_de'>de</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description'>description</span> <span class='comment'># &quot;Marvelous!&quot;</span></code></pre>

<p>Mongoid also defines a <code>:fallbacks</code> option on fields, which can be used to
disable fallback functionality on a specific field:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Product</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_description'>description</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span><span class='comma'>,</span> <span class='label'>localize:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>fallbacks:</span> <span class='kw'>false</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_product'>product</span> <span class='op'>=</span> <span class='const'>Product</span>.<span class='id identifier rubyid_new'>new</span>
<span class='const'>I18n</span>.<span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_en'>en</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description'>description</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Marvelous!</span><span class='tstring_end'>&quot;</span></span>
<span class='const'>I18n</span>.<span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_de'>de</span>
<span class='id identifier rubyid_product'>product</span>.<span class='id identifier rubyid_description'>description</span> <span class='comment'># nil</span></code></pre>

<p>Note that this option defaults to <code>true</code>.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>In i18n 1.1, the behavior of fallbacks <a href="https://github.com/ruby-i18n/i18n/pull/415">changed</a>
to always require an explicit list of fallback locales rather than falling
back to the default locale when no fallback locales have been provided.</p>

<p></div></p>

<h3>Querying</h3>

<p>When querying for localized fields using Mongoid&#39;s criteria API, Mongoid will automatically
alter the criteria to match the current locale.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Match all products with Marvelous as the description. Locale is en.
</span><span class='const'>Product</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>description:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Marvelous!</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># The resulting MongoDB query filter: { &quot;description.en&quot; : &quot;Marvelous!&quot; }</span></code></pre>

<h3>Indexing</h3>

<p>If you plan to be querying extensively on localized fields, you should index each of the
locales that you plan on searching on.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Product</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_description'>description</span><span class='comma'>,</span> <span class='label'>localize:</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_index'>index</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>description.de</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>1</span>
  <span class='id identifier rubyid_index'>index</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>description.en</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>1</span>
<span class='kw'>end</span></code></pre>

<h2>Read-Only Attributes [read-only]</h2>

<p>You can tell Mongoid that certain attributes are read-only. This will allow
documents to be created with these attributes, but changes to them will be
ignored when using mass update methods such as <code>update_attributes</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_origin'>origin</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>

  <span class='id identifier rubyid_attr_readonly'>attr_readonly</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_origin'>origin</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Placebo</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_update_attributes'>update_attributes</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># Filters out the name change.</span></code></pre>

<p>If you explicitly try to update or remove a read-only attribute by itself,
a <code>ReadonlyAttribute</code> exception will be raised:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_update_attribute'>update_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tool</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># Raises the error.
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_remove_attribute'>remove_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>) <span class='comment'># Raises the error.</span></code></pre>

<p>Assignments to read-only attributes using their setters will be ignored:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_b'>b</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The Rolling Stones</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; #&lt;Band _id: 6287a3d5d1327a5292535383, name: &quot;The Rolling Stones&quot;, origin: nil&gt;
</span><span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The Smashing Pumpkins</span><span class='tstring_end'>&quot;</span></span>
<span class='comment'># =&gt; &quot;The Smashing Pumpkins&quot;
</span><span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_name'>name</span>
<span class='comment'># =&gt; &quot;The Rolling Stones&quot;</span></code></pre>

<p>Calls to atomic persistence operators, like <code>bit</code> and <code>inc</code>, will persist
changes to read-only fields.</p>

<h2>Timestamp Fields</h2>

<p>Mongoid supplies a timestamping module in <a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)"><code>::Mongoid::Timestamps</code></a> which
can be included to get basic behavior for <code>created_at</code> and
<code>updated_at</code> fields.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span>
<span class='kw'>end</span></code></pre>

<p>You may also choose to only have specific timestamps for creation or
modification.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Created.html" title="Mongoid::Timestamps::Created (module)">Created</a></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Updated.html" title="Mongoid::Timestamps::Updated (module)">Updated</a></span>
<span class='kw'>end</span></code></pre>

<p>If you want to turn off timestamping for specific calls, use the timeless
method:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_timeless'>timeless</span>.<span class='id identifier rubyid_save'>save</span>
<span class='const'>Person</span>.<span class='id identifier rubyid_timeless'>timeless</span>.<span class='id identifier rubyid_create!'>create!</span></code></pre>

<p>If you&#39;d like shorter timestamp fields with aliases on them to save space,
you can include the short versions of the modules.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Short.html" title="Mongoid::Timestamps::Short (module)">Short</a></span> <span class='comment'># For c_at and u_at.
</span><span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Created.html" title="Mongoid::Timestamps::Created (module)">Created</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Created/Short.html" title="Mongoid::Timestamps::Created::Short (module)">Short</a></span> <span class='comment'># For c_at only.
</span><span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Updated.html" title="Mongoid::Timestamps::Updated (module)">Updated</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps/Updated/Short.html" title="Mongoid::Timestamps::Updated::Short (module)">Short</a></span> <span class='comment'># For u_at only.
</span><span class='kw'>end</span></code></pre>

<h2>Field Names with Dots/Periods (<code>.</code>) and Dollar Signs (<code>$</code>) [field-names-with-periods-and-dollar-signs]</h2>

<p>Using dots/periods (<code>.</code>) in fields names and starting a field name with
a dollar sign (<code>$</code>) is not recommended, as Mongoid provides limited support
for retrieving and operating on the documents stored in those fields.</p>

<p>Both Mongoid and MongoDB query language (MQL) generally use the dot/period
character (<code>.</code>) to separate field names in a field path that traverses
embedded documents, and words beginning with the dollar sign (<code>$</code>) as
operators. MongoDB provides <a href="https://www.mongodb.com/docs/manual/core/dot-dollar-considerations/#std-label-crud-concepts-dot-dollar-considerations">limited support</a>
for using field names containing dots and starting with the dollar sign
for interoperability with other software,
however, due to this support being confined to specific operators
(e.g. <code>getField &lt;/reference/operator/aggregation/getField/&gt;</code>,
<code>setField &lt;/reference/operator/aggregation/setField/&gt;</code>) and
requiring the usage of the aggregation pipeline for both queries and updates,
applications should avoid using dots in field names and starting field names
with the dollar sign if possible.</p>

<p>Mongoid, starting in version 8, now allows users to access fields that begin with
dollar signs and that contain dots/periods. They can be accessed using the <code>send</code>
method as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:&quot;</span><span class='tstring_content'>first.last</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:&quot;</span><span class='tstring_content'>$_amount</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:&quot;</span><span class='tstring_content'>first.last</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; Mike.Trout
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:&quot;</span><span class='tstring_content'>$_amount</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; 42650000</span></code></pre>

<p>It is also possible to use <code>read_attribute</code> to access these fields:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_read_attribute'>read_attribute</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>first.last</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; Mike.Trout</span></code></pre>

<p>Due to <a href="https://www.mongodb.com/docs/manual/core/dot-dollar-considerations/">server limitations</a>,
updating and replacing fields containing dots and dollars requires using special
operators. For this reason, calling setters on these fields is prohibited and
will raise an error:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:&quot;</span><span class='tstring_content'>first.last</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:&quot;</span><span class='tstring_content'>$_amount</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:&quot;</span><span class='tstring_content'>first.last=</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Shohei.Ohtani</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># raises a InvalidDotDollarAssignment error
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:&quot;</span><span class='tstring_content'>$_amount=</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>8500000</span>)
<span class='comment'># raises a InvalidDotDollarAssignment error</span></code></pre>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>