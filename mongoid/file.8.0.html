<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Mongoid 8.0 &mdash; Mongoid master</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "8.0",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Mongoid master</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Mongoid 8.0&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 8.0</h1>

<div class="contents singlecol" markdown="1" local="" backlinks="none" depth="2"></div>

<p>This page describes significant changes and improvements in <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 8.0.
The complete list of releases is available <a href="https://github.com/mongodb/mongoid/releases">on GitHub</a> and <a href="https://jira.mongodb.org/projects/MONGOID?selectedItem=com.atlassian.jira.jira-projects-plugin:release-page">in JIRA</a>;
please consult GitHub releases for detailed release notes and JIRA for
the complete list of issues fixed in each release, including bug fixes.</p>

<h2>Support for MongoDB 3.4 and Earlier Servers Dropped</h2>

<p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 8 requires MongoDB 3.6 or newer. Earlier server versions are not
supported.</p>

<h2>Support for Ruby 2.5 Dropped</h2>

<p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 8 requires Ruby 2.6 or newer. Earlier Ruby versions are not supported.</p>

<h2>Support for Rails 5.1 Dropped</h2>

<p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 8 requires <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 5.2 or newer. Earlier Rails versions are not supported.</p>

<h2>Default Option Values Changed</h2>

<p><strong>Breaking change:</strong> The following options have had their default values
changed in <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 8.0:</p>

<ul>
<li>  <code>:broken_aggregables</code> =&gt; <code>false</code></li>
<li>  <code>:broken_alias_handling</code> =&gt; <code>false</code></li>
<li>  <code>:broken_and</code> =&gt; <code>false</code></li>
<li>  <code>:broken_scoping</code> =&gt; <code>false</code></li>
<li>  <code>:broken_updates</code> =&gt; <code>false</code></li>
<li>  <code>:compare_time_by_ms</code> =&gt; <code>true</code></li>
<li>  <code>:legacy_attributes</code> =&gt; <code>false</code></li>
<li>  <code>:legacy_pluck_distinct</code> =&gt; <code>false</code></li>
<li>  <code>:legacy_triple_equals</code> =&gt; <code>false</code></li>
<li>  <code>:object_id_as_json_oid</code> =&gt; <code>false</code></li>
<li>  <code>:overwrite_chained_operators</code> =&gt; <code>false</code></li>
</ul>

<p>Please refer to <code>configuration option &lt;configuration-options&gt;</code> for
the description and effects of each of these options.</p>

<h2><code>Decimal128</code>-backed <code>BigDecimal</code> Fields</h2>

<p><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 8 introduces the <code>map_big_decimal_to_decimal128</code> feature flag, which
allows values assigned to a field of type <code>BigDecimal</code> to be stored as type
<a href="String.html" title="String (class)"><code>String</code></a> in the database for compatibility with <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 7 and earlier. In
<a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 8 by default (with this feature flag turned on), values assigned to
fields of type <code>BigDecimal</code> are stored in the database as type
<a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a>. In Mongoid 7 and earlier, and in <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 8 with this
feature flag turned off, values assigned to fields of type <code>BigDecimal</code> are
stored as Strings. See the section on <code>BigDecimal Fields &lt;field-type-big-decimal&gt;</code>
for more details.</p>

<h2>Storing/Retrieving/Evolving Uncastable Values</h2>

<p><strong>Breaking change:</strong> In Mongoid 8, <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> standardizes the storing, retrieving
and evolving of &quot;uncastable values.&quot; On attempting to read or write an
uncastable value, a <code>nil</code> is returned or written instead. When attempting to
evolve an uncastable value, the inputted value is returned. See the section on
<code>Uncastable Values &lt;uncastable-values&gt;</code> for more details.</p>

<p>Some <code>mongoize</code>, <code>demongoize</code> and <code>evolve</code> methods were also changed to
perform consistently with rails and the other <code>mongoize</code>, <code>demongoize</code> and
<code>evolve</code> methods. The following table shows the changes in functionality:</p>

<table style="width:100%;">
<colgroup>
<col style="width: 14%" />
<col style="width: 28%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>Field Type</th>
<th>Situation</th>
<th>Previous Functionality</th>
<th>New Functionality</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div class="line-block">Boolean</div></td>
<td><div class="line-block">When a non-boolean string is assigned: "bogus value"</div></td>
<td><div class="line-block">return <code>false</code></div></td>
<td><div class="line-block">return <code>nil</code></div></td>
</tr>
<tr class="even">
<td>Array/Hash</td>
<td>When a value that is not an array or hash is assigned</td>
<td>raise <code>InvalidValue</code> error</td>
<td>return <code>nil</code></td>
</tr>
<tr class="odd">
<td><div class="line-block">Set</div></td>
<td><div class="line-block">When a value that is not a set is assigned: 1</div></td>
<td><div class="line-block">raise <code>NoMethodError</code> Exception: undefined method <code>to_a</code> for 1:Integer</div></td>
<td><div class="line-block">return <code>nil</code></div></td>
</tr>
<tr class="even">
<td>Regexp</td>
<td>When persisting and reading a <a href="Regexp.html" title="Regexp (class)"><code>Regexp</code></a> from the database</td>
<td>return a <code>BSON::Regexp::Raw</code></td>
<td>return a <a href="Regexp.html" title="Regexp (class)"><code>Regexp</code></a></td>
</tr>
<tr class="odd">
<td><div class="line-block">Time/DateTime</div></td>
<td><div class="line-block">When assigning a bogus value: <code>:bogus</code></div></td>
<td><div class="line-block">raise <code>NoMethodError</code> Exception: undefined method <code>to_i</code> for :bogus:Symbol</div></td>
<td><div class="line-block">return <code>nil</code></div></td>
</tr>
<tr class="even">
<td><p>Time/DateTime</p></td>
<td><p>When demongoizing a non-Time value: "bogus", <code>Date.today</code></p></td>
<td><p>raise <code>NoMethodError</code> Exception: undefined method <code>getlocal</code> for "bogus":String</p></td>
<td><p>"bogus": return <code>nil</code></p>
<p><code>Date.today</code>: return <code>Time/DateTime</code></p></td>
</tr>
<tr class="odd">
<td><div class="line-block">Date</div></td>
<td><div class="line-block">When assigning or demongoizing a bogus value: :bogus</div></td>
<td><div class="line-block">raise <code>NoMethodError</code> Exception: undefined method <code>year</code> for :bogus:Symbol</div></td>
<td><div class="line-block">return <code>nil</code></div></td>
</tr>
<tr class="even">
<td>Time/DateTime/Date</td>
<td>When demongoizing a valid string: "2022-07-14 14:45:51 -0400"</td>
<td>raise <code>NoMethodError</code> Exception: undefined method <code>getlocal</code> for "2022-07-14 14:45:51 -0400":String</td>
<td>return a <code>Time/DateTime/Date</code></td>
</tr>
<tr class="odd">
<td><div class="line-block">All Types</div></td>
<td><div class="line-block">When an uncastable value is assigned or demongoized</div></td>
<td><div class="line-block">undefined behavior, occasionally raise <code>NoMethodError</code></div></td>
<td><div class="line-block">return <code>nil</code></div></td>
</tr>
<tr class="even">
<td>All Types</td>
<td>When an uncastable value is evolved</td>
<td>undefined behavior, occasionally raise <code>NoMethodError</code></td>
<td>return inputted value</td>
</tr>
</tbody>
</table>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>The <code>demongoize</code> methods on container objects (i.e. <a href="Hash.html" title="Hash (class)"><code>Hash</code></a>, <a href="Array.html" title="Array (class)"><code>Array</code></a>) have not
changed to prevent bugs when modifying and saving those objects. See
<a href="https://jira.mongodb.org/browse/MONGOID-2951">https://jira.mongodb.org/browse/MONGOID-2951</a> for a longer discussion on these
bugs.</p>

<p></div></p>

<h2>Changes to the <code>attributes_before_type_cast</code> Hash</h2>

<p>The <code>attributes_before_type_cast</code> hash has been changed to function more like
ActiveRecord:</p>

<ul>
<li>  On instantiation of a new model (without parameters), the
<code>attributes_before_type_cast</code> hash has the same contents as the
<code>attributes</code> hash. If parameters are passed to the initializer, those
values will be stored in the <code>attributes_before_type_cast</code> hash before
they are <code>mongoized</code>.</li>
<li>  When assigning a value to the model, the <code>mongoized</code> value (i.e. when
assiging &#39;1&#39; to an Integer field, it is <code>mongoized</code> to 1) is stored in
the <code>attributes</code> hash, whereas the raw value (i.e. &#39;1&#39;) is stored in the
<code>attributes_before_type_cast</code> hash.</li>
<li>  When saving, creating (i.e. using the <code>create!</code> method), or reloading the
model, the <code>attributes_before_type_cast</code> hash is reset to have the same
contents as the <code>attributes</code> hash.</li>
<li>  When reading a document from the database, the <code>attributes_before_type_cast</code>
hash contains the attributes as they appear in the database, as opposed to
their <code>demongoized</code> form.</li>
</ul>

<h2>Order of Callback Invocation</h2>

<p><strong>Breaking change:</strong> <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 8.0 changes the order of _create and _save callback
invocation for documents with associations.</p>

<p>Referenced associations (<code>has_one</code> and <code>has_many</code>):</p>

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Mongoid 8.0</th>
<th>Mongoid 7</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div class="line-block">Parent :before_save</div></td>
<td><div class="line-block">Parent :before_save</div></td>
</tr>
<tr class="even">
<td>Parent :around_save_open</td>
<td>Parent :around_save_open</td>
</tr>
<tr class="odd">
<td><div class="line-block">Parent :before_create</div></td>
<td><div class="line-block">Parent :before_create</div></td>
</tr>
<tr class="even">
<td>Parent :around_create_open</td>
<td>Parent :around_create_open</td>
</tr>
<tr class="odd">
<td><div class="line-block"><strong>Parent persisted in MongoDB</strong></div></td>
<td><div class="line-block"><strong>Parent persisted in MongoDB</strong></div></td>
</tr>
<tr class="even">
<td>Child :before_save</td>
<td>Parent :around_create_close</td>
</tr>
<tr class="odd">
<td><div class="line-block">Child :around_save_open</div></td>
<td><div class="line-block">Parent :after_create</div></td>
</tr>
<tr class="even">
<td>Child :before_create</td>
<td>Child :before_save</td>
</tr>
<tr class="odd">
<td><div class="line-block">Child :around_create_open</div></td>
<td><div class="line-block">Child :around_save_open</div></td>
</tr>
<tr class="even">
<td></td>
<td>Child :before_create</td>
</tr>
<tr class="odd">
<td><div class="line-block"></div></td>
<td><div class="line-block">Child :around_create_open</div></td>
</tr>
<tr class="even">
<td><strong>Child persisted in MongoDB</strong></td>
<td><strong>Child persisted in MongoDB</strong></td>
</tr>
<tr class="odd">
<td><div class="line-block">Child :around_create_close</div></td>
<td><div class="line-block">Child :around_create_close</div></td>
</tr>
<tr class="even">
<td>Child :after_create</td>
<td>Child :after_create</td>
</tr>
<tr class="odd">
<td><div class="line-block">Child :around_save_close</div></td>
<td><div class="line-block">Child :around_save_close</div></td>
</tr>
<tr class="even">
<td>Child :after_save</td>
<td>Child :after_save</td>
</tr>
<tr class="odd">
<td><div class="line-block">Parent :around_create_close</div></td>
<td><div class="line-block">Parent :around_save_close</div></td>
</tr>
<tr class="even">
<td>Parent :after_create</td>
<td>Parent :after_save</td>
</tr>
<tr class="odd">
<td><div class="line-block">Parent :around_save_close</div></td>
<td><div class="line-block"></div></td>
</tr>
<tr class="even">
<td>Parent :after_save</td>
<td></td>
</tr>
</tbody>
</table>

<p>Embedded associations (<code>embeds_one</code> and <code>embeds_many</code>):</p>

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Mongoid 8.0</th>
<th>Mongoid 7</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div class="line-block">Parent :before_save</div></td>
<td><div class="line-block">Child :before_save</div></td>
</tr>
<tr class="even">
<td>Parent :around_save_open</td>
<td>Child :around_save_open</td>
</tr>
<tr class="odd">
<td><div class="line-block">Parent :before_create</div></td>
<td><div class="line-block">Child :around_save_close</div></td>
</tr>
<tr class="even">
<td>Parent :around_create_open</td>
<td>Child :after_save</td>
</tr>
<tr class="odd">
<td><div class="line-block">Child :before_save</div></td>
<td><div class="line-block">Parent :before_save</div></td>
</tr>
<tr class="even">
<td>Child :around_save_open</td>
<td>Parent :around_save_open</td>
</tr>
<tr class="odd">
<td><div class="line-block">Child :before_create</div></td>
<td><div class="line-block">Child :before_create</div></td>
</tr>
<tr class="even">
<td>Child :around_create_open</td>
<td>Child :around_create_open</td>
</tr>
<tr class="odd">
<td><div class="line-block"></div></td>
<td><div class="line-block">Child :around_create_close</div></td>
</tr>
<tr class="even">
<td></td>
<td>Child :after_create</td>
</tr>
<tr class="odd">
<td><div class="line-block"></div></td>
<td><div class="line-block">Parent :before_create</div></td>
</tr>
<tr class="even">
<td></td>
<td>Parent :around_create_open</td>
</tr>
<tr class="odd">
<td><div class="line-block"><strong>Document persisted in MongoDB</strong></div></td>
<td><div class="line-block"><strong>Document persisted in MongoDB</strong></div></td>
</tr>
<tr class="even">
<td>Child :around_create_close</td>
<td></td>
</tr>
<tr class="odd">
<td><div class="line-block">Child :after_create</div></td>
<td><div class="line-block"></div></td>
</tr>
<tr class="even">
<td>Child :around_save_close</td>
<td></td>
</tr>
<tr class="odd">
<td><div class="line-block">Child :after_save</div></td>
<td><div class="line-block"></div></td>
</tr>
<tr class="even">
<td>Parent :around_create_close</td>
<td>Parent :around_create_close</td>
</tr>
<tr class="odd">
<td><div class="line-block">Parent :after_create</div></td>
<td><div class="line-block">Parent :after_create</div></td>
</tr>
<tr class="even">
<td>Parent :around_save_close</td>
<td>Parent :around_save_close</td>
</tr>
<tr class="odd">
<td><div class="line-block">Parent :after_save</div></td>
<td><div class="line-block">Parent :after_save</div></td>
</tr>
</tbody>
</table>

<h2><code>Changeable</code> Module Behavior Made Compatible With <code>ActiveModel::Dirty</code></h2>

<p>When updating documents, it is now possible to get updated attribute values
in <code>href="">after</a>*</code> callbacks. This follows ActiveRecord/ActiveModel behavior.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Cat</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>

  <span class='id identifier rubyid_after_save'>after_save</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_p'>p</span> <span class='kw'>self</span>
    <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_attribute_was'>attribute_was</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='const'>Cat</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_a'>a</span>.<span class='id identifier rubyid_age'>age</span> <span class='op'>=</span> <span class='int'>2</span>
<span class='id identifier rubyid_a'>a</span>.<span class='id identifier rubyid_save!'>save!</span></code></pre>

<p>Mongoid 8.0 output:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'>#&lt;Cat _id: 60aef1652c97a617438dc9bb, age: 2&gt;
</span><span class='int'>2</span></code></pre>

<p>Mongoid 7 output:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'>#&lt;Cat _id: 60aef1652c97a617438dc9bb, age: 2&gt;
</span><span class='kw'>nil</span></code></pre>

<p>Notice that in 7 <code>attribute_was(:age)</code> returns the old attribute value,
while in 8.0 <code>attribute_was(:age)</code> returns the new value.</p>

<h2><code>*_previously_was</code>, <code>previously_new_record?</code>, and <code>previously_persisted?</code> helpers</h2>

<p>Mongoid 8.0 introduces ActiveModel-compatible <code>*_previously_was</code> helpers,
as well as ActiveRecord-compatible <code>previously_new_record?</code> and
<code>previously_persisted?</code> helpers:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Sam</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>age:</span> <span class='int'>18</span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_previously_new_record?'>previously_new_record?</span>     <span class='comment'># =&gt; true
</span>
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Nick</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_save!'>save!</span>
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_name_previously_was'>name_previously_was</span>        <span class='comment'># =&gt; &quot;Sam&quot;
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_age_previously_was'>age_previously_was</span>         <span class='comment'># =&gt; 18
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_previously_new_record?'>previously_new_record?</span>     <span class='comment'># =&gt; false
</span>
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_destroy'>destroy</span>
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_previously_persisted?'>previously_persisted?</span>   <span class='comment'># =&gt; true</span></code></pre>

<h2>Unknown Field Type Symbols/Strings Prohibited</h2>

<p><strong>Breaking change:</strong> Mongoid 8 prohibits using symbols and strings as field
types when these symbols and strings do not map to a known type. Previously
such usage would create a field of type <code>Object</code>.</p>

<p>Mongoid 8 behavior:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_bogus'>bogus</span>
  <span class='comment'># =&gt; raises Mongoid::Errors::InvalidFieldType
</span><span class='kw'>end</span></code></pre>

<p>Mongoid 7 behavior:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_bogus'>bogus</span>
  <span class='comment'># Equivalent to:
</span>  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>
<span class='kw'>end</span></code></pre>

<h2><code>any_of</code> Adds Multiple Arguments As Top-Level Conditions</h2>

<p><strong>Breaking change:</strong> When <code>any_of</code> is invoked with multiple conditions, the
conditions are now added to the top level of the criteria, same as when
<code>any_of</code> is invoked with a single condition. Previously when multiple
conditions were provided, and the criteria already had an <code>$or</code> operator,
the new conditions would be added to the existing <code>$or</code> as an additional
branch.</p>

<p>Mongoid 8.0 behavior:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_any_of'>any_of</span>({<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The Rolling Stones</span><span class='tstring_end'>&#39;</span></span>}<span class='comma'>,</span> {<span class='label'>founded:</span> <span class='int'>1990</span>}).
  <span class='id identifier rubyid_any_of'>any_of</span>({<span class='label'>members:</span> <span class='int'>2</span>}<span class='comma'>,</span> {<span class='label'>last_tour:</span> <span class='int'>1995</span>})
<span class='comment'># =&gt;
</span><span class='comment'># #&lt;Mongoid::Criteria
</span><span class='comment'>#   selector: {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;The Rolling Stones&quot;}, {&quot;founded&quot;=&gt;1990}],
</span><span class='comment'>#     &quot;$and&quot;=&gt;[{&quot;$or&quot;=&gt;[{&quot;members&quot;=&gt;2}, {&quot;last_tour&quot;=&gt;1995}]}]}
</span><span class='comment'>#   options:  {}
</span><span class='comment'>#   class:    Band
</span><span class='comment'>#   embedded: false&gt;
</span>
<span class='const'>Band</span>.<span class='id identifier rubyid_any_of'>any_of</span>({<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The Rolling Stones</span><span class='tstring_end'>&#39;</span></span>}<span class='comma'>,</span> {<span class='label'>founded:</span> <span class='int'>1990</span>}).<span class='id identifier rubyid_any_of'>any_of</span>({<span class='label'>members:</span> <span class='int'>2</span>})
<span class='comment'># =&gt;
</span><span class='comment'># #&lt;Mongoid::Criteria
</span><span class='comment'>#   selector: {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;The Rolling Stones&quot;}, {&quot;founded&quot;=&gt;1990}], &quot;members&quot;=&gt;2}
</span><span class='comment'>#   options:  {}
</span><span class='comment'>#   class:    Band
</span><span class='comment'>#   embedded: false&gt;</span></code></pre>

<p>Mongoid 7 behavior:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_any_of'>any_of</span>({<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The Rolling Stones</span><span class='tstring_end'>&#39;</span></span>}<span class='comma'>,</span> {<span class='label'>founded:</span> <span class='int'>1990</span>}).
  <span class='id identifier rubyid_any_of'>any_of</span>({<span class='label'>members:</span> <span class='int'>2</span>}<span class='comma'>,</span> {<span class='label'>last_tour:</span> <span class='int'>1995</span>})
<span class='comment'># =&gt;
</span><span class='comment'># #&lt;Mongoid::Criteria
</span><span class='comment'>#   selector: {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;The Rolling Stones&quot;}, {&quot;founded&quot;=&gt;1990},
</span><span class='comment'>#     {&quot;members&quot;=&gt;2}, {&quot;last_tour&quot;=&gt;1995}]}
</span><span class='comment'>#   options:  {}
</span><span class='comment'>#   class:    Band
</span><span class='comment'>#   embedded: false&gt;
</span>
<span class='const'>Band</span>.<span class='id identifier rubyid_any_of'>any_of</span>({<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The Rolling Stones</span><span class='tstring_end'>&#39;</span></span>}<span class='comma'>,</span> {<span class='label'>founded:</span> <span class='int'>1990</span>}).<span class='id identifier rubyid_any_of'>any_of</span>({<span class='label'>members:</span> <span class='int'>2</span>})
<span class='comment'># =&gt;
</span><span class='comment'># #&lt;Mongoid::Criteria
</span><span class='comment'>#   selector: {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;The Rolling Stones&quot;}, {&quot;founded&quot;=&gt;1990}], &quot;members&quot;=&gt;2}
</span><span class='comment'>#   options:  {}
</span><span class='comment'>#   class:    Band
</span><span class='comment'>#   embedded: false&gt;</span></code></pre>

<h2><code>#pluck</code> on Embedded Criteria Returns <code>nil</code> Values</h2>

<p>Mongoid 8 fixes a bug where calling <code>#pluck</code> on a Mongoid::Criteria
for embedded documents discarded nil values. This behavior was
inconsistent with both the <code>#pluck</code> method in ActiveSupport and
with how <code>#pluck</code> works when reading documents from the database.</p>

<p>Mongoid 8.0 behavior:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Address</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_mall'>mall</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_street'>street</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Mall</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_addresses'>addresses</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_mall'>mall</span> <span class='op'>=</span> <span class='const'>Mall</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_mall'>mall</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>street:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Elm Street</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_mall'>mall</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>street:</span> <span class='kw'>nil</span>)

<span class='comment'># Pluck from embedded document criteria
</span><span class='id identifier rubyid_mall'>mall</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_all'>all</span>.<span class='id identifier rubyid_pluck'>pluck</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_street'>street</span>)
  <span class='comment'>#=&gt; [&#39;Elm Street&#39;, nil]</span></code></pre>

<p>Mongoid 7 behavior, given the same setup:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Pluck from embedded document criteria
</span><span class='id identifier rubyid_mall'>mall</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_all'>all</span>.<span class='id identifier rubyid_pluck'>pluck</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_street'>street</span>)
  <span class='comment'>#=&gt; [&#39;Elm Street&#39;]</span></code></pre>

<p>For clarity, the following behavior is unchanged from Mongoid 7 to Mongoid 8.0:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Pluck from database
</span><span class='const'>Mall</span>.<span class='id identifier rubyid_all'>all</span>.<span class='id identifier rubyid_pluck'>pluck</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>addresses.street</span><span class='tstring_end'>&#39;</span></span>)
  <span class='comment'>#=&gt; [ [&#39;Elm Street&#39;, nil] ]
</span>
<span class='comment'># Pluck using ActiveSupport Array#pluck
</span><span class='id identifier rubyid_mall'>mall</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_pluck'>pluck</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_street'>street</span>)
  <span class='comment'>#=&gt; [&#39;Elm Street&#39;, nil]</span></code></pre>

<h2>Replaced <code>Mongoid::Criteria#geo_spacial</code> with <code>#geo_spatial</code></h2>

<p>The previously deprecated <code>Mongoid::Criteria#geo_spacial</code> method has been
removed in Mongoid 8. It has been replaced one-for-one with <code>#geo_spatial</code>
which was added in Mongoid 7.2.0.</p>

<h2>Implemented <code>.tally</code> method on <code>Mongoid#Criteria</code></h2>

<p>Mongoid 8 implements the <code>.tally</code> method on <code>Mongoid#Criteria</code>. <code>tally</code>
takes a field name as a parameter and returns a mapping from values to their
counts. For example, take the following model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span>
<span class='kw'>end</span></code></pre>

<p>and the following documents in the database:</p>

<pre class="code ruby"><code class="ruby">{ <span class='label'>_id:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>age:</span> <span class='int'>21</span> }
{ <span class='label'>_id:</span> <span class='int'>2</span><span class='comma'>,</span> <span class='label'>age:</span> <span class='int'>21</span> }
{ <span class='label'>_id:</span> <span class='int'>3</span><span class='comma'>,</span> <span class='label'>age:</span> <span class='int'>22</span> }</code></pre>

<p>Calling <code>tally</code> on the age field yields the following:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_tally'>tally</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>age</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; { 21 =&gt; 2, 22 =&gt; 1 }</span></code></pre>

<p>The <code>tally</code> method accepts the dot notation and field aliases. It also
allows for tallying localized fields.</p>

<h2>Implemented <code>.pick</code> method on <code>Mongoid#Criteria</code></h2>

<p>Mongoid 8 implements the <code>.pick</code> method on <code>Mongoid#Criteria</code>. <code>pick</code>
takes one or more field names as a parameter and returns the values for those
fields from one document. Consider the following model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span>
<span class='kw'>end</span></code></pre>

<p>and the following documents in the database:</p>

<pre class="code ruby"><code class="ruby">{ <span class='label'>_id:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>age:</span> <span class='int'>21</span> }
{ <span class='label'>_id:</span> <span class='int'>2</span><span class='comma'>,</span> <span class='label'>age:</span> <span class='int'>21</span> }
{ <span class='label'>_id:</span> <span class='int'>3</span><span class='comma'>,</span> <span class='label'>age:</span> <span class='int'>22</span> }</code></pre>

<p>Calling <code>pick</code> on the age field yields the following:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_pick'>pick</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span>)
<span class='comment'># =&gt; 21</span></code></pre>

<p>This method does not apply a sort to the documents, so it will not necessarily
return the values from the first document.</p>

<p>The <code>pick</code> method accepts the dot notation and field aliases. It also
allows for picking localized fields.</p>

<h2><code>find</code> delegates to <code>Enumerable#find</code> when given a block</h2>

<p>When given a block, without <code>_id</code> arguments, <code>find</code> delegates to
<code>Enumerable#find</code>. Consider the following model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Band</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
<span class='kw'>end</span>

<span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>)
<span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The Rolling Stones</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>Calling <code>find</code> with a block returns the first document for which the block
returns <code>true</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_find'>find</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_b'>b</span><span class='op'>|</span>
  <span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Depeche Mode</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
<span class='comment'># =&gt; #&lt;Band _id: 62c58e383282a4cbe82bd74b, name: &quot;Depeche Mode&quot;&gt;</span></code></pre>

<h2>No Longer Persisting Documents with Invalid <code>belongs_to</code> Associations</h2>

<p>In Mongoid 8, if an invalid document is assigned to a <code>belongs_to</code> association,
and the base document is saved, if the <code>belongs_to</code> association had the
option <code>optional: false</code> or <code>optional</code> is unset and the global flag
<code>belongs_to_required_by_default</code> is true, neither the document nor the
associated document will be persisted. For example, given the following
models:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Parent</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_child'>child</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_validates'>validates</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>presence:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Child</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_parent'>parent</span><span class='comma'>,</span> <span class='label'>autosave:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>validate:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>optional:</span> <span class='kw'>false</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_child'>child</span> <span class='op'>=</span> <span class='const'>Child</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_parent'>parent</span> <span class='op'>=</span> <span class='const'>Parent</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_child'>child</span>.<span class='id identifier rubyid_parent'>parent</span> <span class='op'>=</span> <span class='id identifier rubyid_parent'>parent</span> <span class='comment'># parent is invalid, it does not have a name
</span><span class='id identifier rubyid_child'>child</span>.<span class='id identifier rubyid_save'>save</span></code></pre>

<p>In this case, both the child and the parent will not be persisted.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>If <code>save!</code> were called, a validation error would be raised.</p>

<p></div></p>

<p>If optional is false, then the Child will be persisted with a parent_id, but the
parent will not be persisted:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_child'>child</span> <span class='op'>=</span> <span class='const'>Child</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_parent'>parent</span> <span class='op'>=</span> <span class='const'>Parent</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_child'>child</span>.<span class='id identifier rubyid_parent'>parent</span> <span class='op'>=</span> <span class='id identifier rubyid_parent'>parent</span> <span class='comment'># parent is invalid, it does not have a name
</span><span class='id identifier rubyid_child'>child</span>.<span class='id identifier rubyid_save'>save</span>

<span class='id identifier rubyid_p'>p</span> <span class='const'>Child</span>.<span class='id identifier rubyid_first'>first</span>
<span class='comment'># =&gt; &lt;Child _id: 629a50b0d1327aad89d214d2, parent_id: BSON::ObjectId(&#39;629a50b0d1327aad89d214d3&#39;)&gt;
</span><span class='id identifier rubyid_p'>p</span> <span class='const'>Parent</span>.<span class='id identifier rubyid_first'>first</span>
<span class='comment'># =&gt; nil</span></code></pre>

<p>If you want the functionality of neither document being persisted in Mongoid 7 or 8
and earlier, the <code>validate: true</code> option can be set on the association. If
you want the functionality of only the Child being persisted, the <code>validate: false</code> option can be set on the association.</p>

<h2>Update Local HABTM Association Correctly</h2>

<p>In Mongoid 8, when pushing persisted elements to a HABTM association, the
association will now update correctly without requiring a reload.
For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_user1'>user1</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_user2'>user2</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_create!'>create!</span>

<span class='id identifier rubyid_post'>post</span> <span class='op'>=</span> <span class='id identifier rubyid_user1'>user1</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_create!'>create!</span>

<span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_users'>users</span>.<span class='id identifier rubyid_length'>length</span>
<span class='comment'># =&gt; 1
</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_users'>users</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_user2'>user2</span>

<span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_users'>users</span>.<span class='id identifier rubyid_length'>length</span>
<span class='comment'># =&gt; 1 in Mongoid 7, 2 in Mongoid 8
</span>
<span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_reload'>reload</span>.<span class='id identifier rubyid_users'>users</span>.<span class='id identifier rubyid_length'>length</span>
<span class='comment'># =&gt; 2</span></code></pre>

<p>As you can see from this example, after pushing <code>user2</code> to the users array,
Mongoid 8 correctly updates the number of elements without requiring a reload.</p>

<h2>Repaired Storing Strings in BSON::Binary fields</h2>

<p><strong>Breaking change:</strong> In Mongoid 8, storing a String in a field of type
<a href="BSON/Binary.html" title="BSON::Binary (class)"><code>::BSON::Binary</code></a> will be stored in and returned from the database as a
<a href="BSON/Binary.html" title="BSON::Binary (class)"><code>::BSON::Binary</code></a>. Prior to Mongoid 8 it was stored and returned as a String:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Registry</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_data'>data</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="BSON.html" title="BSON (module)">BSON</a></span><span class='op'>::</span><span class='const'><a href="BSON/Binary.html" title="BSON::Binary (class)">Binary</a></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_registry'>registry</span> <span class='op'>=</span> <span class='const'>Registry</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>data:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data!</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_registry'>registry</span>.<span class='id identifier rubyid_data'>data</span>
<span class='comment'># =&gt; Mongoid 7: &quot;data!&quot;
</span><span class='comment'># =&gt; Mongoid 8: &lt;BSON::Binary:0x2580 type=generic data=0x6461746121...&gt;
</span>
<span class='id identifier rubyid_registry'>registry</span> <span class='op'>=</span> <span class='const'>Registry</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_registry'>registry</span>.<span class='id identifier rubyid_id'>id</span>)
<span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_registry'>registry</span>.<span class='id identifier rubyid_data'>data</span>
<span class='comment'># =&gt; Mongoid 7: &quot;data!&quot;
</span><span class='comment'># =&gt; Mongoid 8: &lt;BSON::Binary:0x2600 type=generic data=0x6461746121...&gt;</span></code></pre>

<h2>Removed <code>Document#to_a</code> Method</h2>

<p>The previously deprecated <code>Document#to_a</code> method has been removed in
Mongoid 8.</p>

<h2>Removed <code>:drop_dups</code> Option from Indexes</h2>

<p>The <code>:drop_dups</code> option has been removed from the <code>index</code> macro. This option
was specific to MongoDB server 2.6 and earlier, which Mongoid no longer supports.</p>

<h2>Removed <code>Mongoid::Errors::EagerLoad</code> Exception Class</h2>

<p>The previously deprecated <code>Mongoid::Errors::EagerLoad</code> exception class
has been removed in Mongoid 8. It has not been used by Mongoid since
version 7.1.1 when eager loading for polymorphic <code>belongs_to</code> associations
was implemented.</p>

<h2>Removed Deprecated Constants</h2>

<p>Mongoid 8 removes the following deprecated constants that are not expected
to have been used outside of Mongoid:</p>

<ul>
<li>  <code>Mongoid::Extensions::Date::EPOCH</code></li>
<li>  <code>Mongoid::Extensions::Time::EPOCH</code></li>
<li>  <code>Mongoid::Factory::TYPE</code></li>
</ul>

<h2>Removed <code>Array#update_values</code> and <code>Hash#update_values</code> methods</h2>

<p>The previously deprecated <code>Array#update_values</code> and <code>Hash#update_values</code>
methods have been removed in Mongoid 8.</p>

<h2>Deprecated the <code>geoHaystack</code>, <code>geoSearch</code> Options</h2>

<p>The <code>geoHaystack</code> and <code>geoSearch</code> options on indexes have been deprecated.</p>

<h2><code>:id_sort</code> Option on <code>#first/last</code> Removed</h2>

<p>Support for the <code>:id_sort</code> option on the <code>#first</code> and <code>#last</code> options has
been dropped. These methods now only except a limit as a positional argument.</p>

<h2>Mongoid::Criteria Cache Removed</h2>

<p>Support for individually caching criteria objects has been dropped in Mongoid 8.</p>

<p>In order to get caching functionality, enable the Mongoid Query Cache. See the
section on <code>Query Cache &lt;query-cache&gt;</code> for more details.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>