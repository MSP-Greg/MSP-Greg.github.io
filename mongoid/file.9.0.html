<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Mongoid 9.0 &mdash; Mongoid master</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "9.0",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Mongoid master</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Mongoid 9.0&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1><a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 9.0</h1>

<div class="contents singlecol" markdown="1" local="" backlinks="none" depth="2"></div>

<p>This page describes significant changes and improvements in <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 9.0.
The complete list of releases is available <a href="https://github.com/mongodb/mongoid/releases">on GitHub</a> and <a href="https://jira.mongodb.org/projects/MONGOID?selectedItem=com.atlassian.jira.jira-projects-plugin:release-page">in JIRA</a>;
please consult GitHub releases for detailed release notes and JIRA for
the complete list of issues fixed in each release, including bug fixes.</p>

<h2>Railsmdb for Mongoid</h2>

<p>To coincide with the release of <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> 9.0 a new command-line utility for creating,
updating, managing, and maintaining <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> applications has also
been made generally available!</p>

<p><code>railsmdb</code> makes it easier to work with MongoDB from the command line through
common generators that Ruby on <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> developers are already familiar with.</p>

<p>For example, you can use <code>railsmdb</code> to generate stubs for new <a href="Mongoid.html" title="Mongoid (module)"><code>Mongoid</code></a> models:</p>

<pre class="code sh"><code class="sh">$ bin/railsmdb generate model person
</code></pre>

<p>This will create a new model at <code>app/models/person.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'>Timestamp</span>
<span class='kw'>end</span></code></pre>

<p>You can specify the fields of the model as well:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># bin/railsmdb generate model person name:string birth:date
</span>
<span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'>Timestamp</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="String.html" title="String (class)">String</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_birth'>birth</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span>
<span class='kw'>end</span></code></pre>

<p>You can instruct the generator to make the new model a subclass of another,
by passing the <code>--parent</code> option:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># bin/railsmdb generate model student --parent=person
</span>
<span class='kw'>class</span> <span class='const'>Student</span> <span class='op'>&lt;</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'>Timestamp</span>
<span class='kw'>end</span></code></pre>

<p>And if you need to store your models in a different collection than can be
inferred from the model name, you can specify <code>--collection</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># bin/railsmdb generate model course --collection=classes
</span>
<span class='kw'>class</span> <span class='const'>Course</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'>Timestamp</span>
  <span class='id identifier rubyid_store_in'>store_in</span> <span class='label'>collection:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>classes</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></code></pre>

<p>For more information see the <a href="https://github.com/mongodb/mongoid-railsmdb">GitHub Repository</a>.</p>

<h2>Support for Ruby 2.6 and JRuby 9.3 Dropped</h2>

<p>Mongoid 9 requires Ruby 2.7 or newer or JRuby 9.4. Earlier Ruby and JRuby
versions are not supported.</p>

<h2>Support for Rails 5 Dropped</h2>

<p>Mongoid 9 requires Rails 6.0 or newer. Earlier Rails versions are not supported.</p>

<h2>Deprecated class <code>Mongoid::Errors::InvalidStorageParent</code> removed</h2>

<p>The deprecated class <code>Mongoid::Errors::InvalidStorageParent</code> has been removed.</p>

<h2><code>href="">around</a>*</code> callbacks for embedded documents are now ignored</h2>

<p>Mongoid 8.x and older allows user to define <code>href="">around</a>*</code> callbacks for embedded
documents. Starting from 9.0 these callbacks are ignored and will not be executed.
A warning will be printed to the console if such callbacks are defined.</p>

<p>If you want to restore the old behavior, you can set
<code>Mongoid.around_embedded_document_callbacks</code> to true in your application.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Enabling <code>href="">around</a>*</code> callbacks for embedded documents is not recommended
as it may cause <code>SystemStackError</code> exceptions when a document has many
embedded documents. See <a href="https://jira.mongodb.org/browse/MONGOID-5658">MONGOID-5658</a>
for more details.</p>

<p></div></p>

<h2><code>for_js</code> method is deprecated</h2>

<p>The <code>for_js</code> method is deprecated and will be removed in Mongoid 10.0.</p>

<h2>Deprecated options removed</h2>

<p><strong>Breaking change:</strong> The following config options are removed in Mongoid 9.0.
Please ensure you have removed all references to these from your app.
If you were using <code>config.load_defaults 8.1</code> prior to upgrading, you will not
experience any behavior change. Refer to earlier release notes for the meaning
of each option.</p>

<ul>
<li>  <code>:use_activesupport_time_zone</code></li>
<li>  <code>:broken_aggregables</code></li>
<li>  <code>:broken_alias_handling</code></li>
<li>  <code>:broken_and</code></li>
<li>  <code>:broken_scoping</code></li>
<li>  <code>:broken_updates</code></li>
<li>  <code>:compare_time_by_ms</code></li>
<li>  <code>:legacy_attributes</code></li>
<li>  <code>:legacy_pluck_distinct</code></li>
<li>  <code>:legacy_triple_equals</code></li>
<li>  <code>:object_id_as_json_oid</code></li>
<li>  <code>:overwrite_chained_operators</code></li>
</ul>

<p>In addition, support for <code>config.load_defaults</code> versions 7.5 and
prior has been dropped (you must use a minimum of version 8.0.)</p>

<h2>Deprecated functionality removed</h2>

<p><strong>Breaking change:</strong> The following deprecated functionality is now removed:</p>

<ul>
<li>  The <code>Mongoid::QueryCache</code> module has been removed. Please replace any usages 1-for-1 with <code>Mongo::QueryCache</code>.
The method <code>Mongoid::QueryCache#clear_cache</code> should be replaced with <code>Mongo::QueryCache#clear</code>.
All other methods and submodules are identically named. Refer to the <a href="https://mongodb.com/docs/ruby-driver/current/reference/query-cache/">driver query cache documentation</a> for more details.</li>
<li>  <code>Object#blank_criteria?</code> method is removed (was previously deprecated.)</li>
<li>  <code>Document#as_json :compact</code> option is removed. Please call `<code>#compact</code> on the
returned <a href="Hash.html" title="Hash (class)"><code>Hash</code></a> object instead.</li>
<li>  The deprecated class <code>Mongoid::Errors::InvalidStorageParent</code> has been removed.</li>
</ul>

<h2><code>touch</code> method now clears changed state</h2>

<p>In Mongoid 8.x and older <code>touch</code> method leaves models in the changed state:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Mongoid 8.x behaviour
</span><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_touch'>touch</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_changed?'>changed?</span> <span class='comment'># =&gt; true
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_changes'>changes</span> <span class='comment'># =&gt; {&quot;updated_at&quot;=&gt;[2023-01-30 13:12:57.477191135 UTC, 2023-01-30 13:13:11.482975646 UTC]}</span></code></pre>

<p>Starting from 9.0 Mongoid now correctly clears changed state after using <code>touch</code>
method.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Mongoid 9.0 behaviour
</span><span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_touch'>touch</span>
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_changed?'>changed?</span> <span class='comment'># =&gt; false
</span><span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_changes'>changes</span> <span class='comment'># =&gt; {}</span></code></pre>

<h2>Sandbox Mode for Rails Console</h2>

<p>Mongoid now supports Rails console sandbox mode. If the Rails console started
with <code>--sandbox</code> flag, Mongoid starts a transaction on the <code>:default</code> client
before opening the console. This transaction won&#39;t be committed; therefore, all
the commands executed in the console using the <code>:default</code> client won&#39;t
be persisted in the database.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>If you execute commands in the sandbox mode <em>using any other client than default</em>,
these changes will be persisted as usual.</p>

<p></div></p>

<h2>New Transactions API</h2>

<p>Mongoid 9.0 introduces new transactions API that is inspired by ActiveRecord:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
  <span class='const'>Band</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Led Zeppelin</span><span class='tstring_end'>&#39;</span></span>)
<span class='kw'>end</span>

<span class='id identifier rubyid_band'>band</span> <span class='op'>=</span> <span class='const'>Band</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Deep Purple</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_active'>active</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_band'>band</span>.<span class='id identifier rubyid_save!'>save!</span>
<span class='kw'>end</span></code></pre>

<p>Please consult <code>transactions documentation &lt;transactions&gt;</code> for more details.</p>

<h2>Embedded Documents Always Use Parent Persistence Context</h2>

<p>Mongoid 8.x and older allows user to specify persistence context for an
embedded document (using <code>store_in</code> macro). In Mongoid 9.0 these settings are
ignored for embedded documents; an embedded document now always uses the persistence
context of its parent.</p>

<h2>Support for Passing Raw Values into Queries</h2>

<p>When performing queries, it is now possible skip Mongoid&#39;s type coercion logic
using the <a href="Mongoid/RawValue.html" title="Mongoid::RawValue (class)"><code>::Mongoid::RawValue</code></a> wrapper class. This can be useful when legacy
data in the database is of a different type than the field definition.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Integer.html" title="Integer (class)">Integer</a></span>
<span class='kw'>end</span>

<span class='comment'># Query for the string &quot;42&quot;, not the integer 42
</span><span class='const'>Person</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>age:</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/RawValue.html" title="Mongoid::RawValue (class)">RawValue</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>42</span><span class='tstring_end'>&quot;</span></span>))</code></pre>

<h2>Raise AttributeNotLoaded error when accessing fields omitted from query projection</h2>

<p>When attempting to access a field on a model instance which was
excluded with the <code>.only</code> or <code>.without</code> query projections methods
when the instance was loaded, Mongoid will now raise a
<a href="Mongoid/Errors/AttributeNotLoaded.html" title="Mongoid::Errors::AttributeNotLoaded (class)"><code>::Mongoid::Errors::AttributeNotLoaded</code></a> error.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Band</span>.<span class='id identifier rubyid_only'>only</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>).<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_label'>label</span>
<span class='comment'>#=&gt; raises Mongoid::Errors::AttributeNotLoaded
</span>
<span class='const'>Band</span>.<span class='id identifier rubyid_without'>without</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span>).<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_label'>label</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Sub Pop Records</span><span class='tstring_end'>&#39;</span></span>
<span class='comment'>#=&gt; raises Mongoid::Errors::AttributeNotLoaded</span></code></pre>

<p>In earlier Mongoid versions, the same conditions would raise an
<code>ActiveModel::MissingAttributeError</code>. Please check your code for
any Mongoid-specific usages of this class, and change them to
<a href="Mongoid/Errors/AttributeNotLoaded.html" title="Mongoid::Errors::AttributeNotLoaded (class)"><code>::Mongoid::Errors::AttributeNotLoaded</code></a>. Note additionally that
<code>AttributeNotLoaded</code> inherits from <a href="Mongoid/Errors/MongoidError.html" title="Mongoid::Errors::MongoidError (class)"><code>::Mongoid::Errors::MongoidError</code></a>,
while <code>ActiveModel::MissingAttributeError</code> does not.</p>

<h2>Use configured time zone to typecast Date to Time in queries</h2>

<p>When querying for a Time field using a Date value, Mongoid now correctly
considers <code>Time.zone</code> to perform type conversion.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Magazine</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_published_at'>published_at</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>
<span class='kw'>end</span>

<span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_zone'>zone</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Asia/Tokyo</span><span class='tstring_end'>&#39;</span></span>

<span class='const'>Magazine</span>.<span class='id identifier rubyid_gte'>gte</span>(<span class='label'>published_at:</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>2022-09-26</span><span class='tstring_end'>&#39;</span></span>))
<span class='comment'>#=&gt; will return all results on or after Sept 26th, 2022
</span><span class='comment'>#   at 0:00 in Asia/Tokyo time zone.</span></code></pre>

<p>In prior Mongoid versions, the above code would ignore the <code>Time.zone</code>
(irrespective of the now-removed <code>:use_activesupport_time_zone</code>
setting) and always using the system time zone to perform the type conversion.</p>

<p>Note that in prior Mongoid versions, typecasting Date to Time during
persistence operations was already correctly using time zone.</p>

<h2><span class="title-ref"><code>#touch</code> method on embedded documents correctly handles </span><span class="title-ref">touch: false</span>` option</h2>

<p>When the <code>touch: false</code> option is set on an <code>embedded_in</code> relation,
calling the <code>#touch</code> method on an embedded child document will not
invoke <code>#touch</code> on its parent document.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Address</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span>

  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_mall'>mall</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>false</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Mall</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span>

  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_addresses'>addresses</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_mall'>mall</span> <span class='op'>=</span> <span class='const'>Mall</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_address'>address</span> <span class='op'>=</span> <span class='id identifier rubyid_mall'>mall</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_create!'>create!</span>

<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_touch'>touch</span>
<span class='comment'>#=&gt; updates address.updated_at but not mall.updated_at</span></code></pre>

<p>In addition, the <code>#touch</code> method has been optimized to perform one
persistence operation per parent document, even when using multiple
levels of nested embedded documents.</p>

<h2><code>embedded_in</code> associations now default to <code>touch: true</code></h2>

<p>Updating an embedded subdocument will now automatically touch the parent,
unless you explicitly set <code>touch: false</code> on the relation:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Address</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Timestamps.html" title="Mongoid::Timestamps (module)">Timestamps</a></span>

  <span class='id identifier rubyid_embedded_in'>embedded_in</span> <span class='symbeg'>:</span><span class='id identifier rubyid_mall'>mall</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>false</span>
<span class='kw'>end</span></code></pre>

<p>For all other associations, the default remains <code>touch: false</code>.</p>

<h2>Flipped default for <code>:replace</code> option in <code>#upsert</code></h2>

<p>Mongoid 8.1 added the <code>:replace</code> option to the <code>#upsert</code> method. This
option was used to specify whether or not the existing document should be
updated or replaced.</p>

<p>Mongoid 9.0 flips the default of this flag from <code>true</code> =&gt; <code>false</code>.</p>

<p>This means that, by default, Mongoid 9 will update the existing document and
will not replace it.</p>

<h2>The immutability of the <code>_id</code> field is now enforced</h2>

<p>Prior to Mongoid 9.0, mutating the <code>_id</code> field behaved inconsistently
depending on whether the document was top-level or embedded, and depending on
how the update was performed. As of 9.0, changing the <code>_id</code> field will now
raise an exception when the document is saved, if the document had been
previously persisted.</p>

<p>Mongoid 9.0 also introduces a new feature flag, <code>immutable_ids</code>, which
defaults to <code>true</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Config.html" title="Mongoid::Config (module)">Config</a></span>.<span class='id identifier rubyid_immutable_ids'>immutable_ids</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>When set to false, the older, inconsistent behavior is restored.</p>

<h2>Support Field Aliases on Index Options</h2>

<p>Support has been added to use aliased field names in the following options
of the <code>index</code> macro: <code>partial_filter_expression</code>, <code>weights</code>,
<code>wildcard_projection</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span>
  <span class='id identifier rubyid_index'>index</span>({ <span class='label'>age:</span> <span class='int'>1</span> }<span class='comma'>,</span> { <span class='label'>partial_filter_expression:</span> { <span class='label'>age:</span> { <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$gte</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='int'>20</span> } })
<span class='kw'>end</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>The expansion of field name aliases in index options such as
<code>partial_filter_expression</code> is performed according to the behavior of MongoDB
server 6.0. Future server versions may change how they interpret these options,
and Mongoid&#39;s functionality may not support such changes.</p>

<p></div></p>

<h2>BSON 5 and BSON::Decimal128 Fields</h2>

<p>When BSON 4 or earlier is present, any field declared as BSON::Decimal128 will
return a BSON::Decimal128 value. When BSON 5 is present, however, any field
declared as BSON::Decimal128 will return a BigDecimal value by default.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Model</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbeg'>:</span><span class='id identifier rubyid_decimal_field'>decimal_field</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="BSON.html" title="BSON (module)">BSON</a></span><span class='op'>::</span><span class='const'><a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)">Decimal128</a></span>
<span class='kw'>end</span>

<span class='comment'># under BSON &lt;= 4
</span><span class='const'>Model</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_decimal_field'>decimal_field</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; BSON::Decimal128
</span>
<span class='comment'># under BSON &gt;= 5
</span><span class='const'>Model</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_decimal_field'>decimal_field</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; BigDecimal</span></code></pre>

<p>If you need literal BSON::Decimal128 values with BSON 5, you may instruct
Mongoid to allow literal BSON::Decimal128 fields:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Model</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_decimal_field'>decimal_field</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; BigDecimal
</span>
<span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_allow_bson5_decimal128'>allow_bson5_decimal128</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='const'>Model</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_decimal_field'>decimal_field</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; BSON::Decimal128</span></code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>The <code>allow_bson5_decimal128</code> option only has any effect under
BSON 5 and later. BSON 4 and earlier ignore the setting entirely.</p>

<p></div></p>

<h2>Search Index Management with MongoDB Atlas</h2>

<p>When connected to MongoDB Atlas, Mongoid now supports creating and removing
search indexes. You may do so programmatically, via the Mongoid::SearchIndexable
API:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>SearchablePerson</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span><span class='op'>::</span><span class='const'><a href="Mongoid/Document.html" title="Mongoid::Document (module)">Document</a></span>

  <span class='id identifier rubyid_search_index'>search_index</span> { <span class='op'>...</span> } <span class='comment'># define the search index here
</span><span class='kw'>end</span>

<span class='comment'># create the declared search indexes; this returns immediately, but the
</span><span class='comment'># search indexes may take several minutes before they are available.
</span><span class='const'>SearchablePerson</span>.<span class='id identifier rubyid_create_search_indexes'>create_search_indexes</span>

<span class='comment'># query the available search indexes
</span><span class='const'>SearchablePerson</span>.<span class='id identifier rubyid_search_indexes'>search_indexes</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_index'>index</span><span class='op'>|</span>
  <span class='comment'># ...
</span><span class='kw'>end</span>

<span class='comment'># remove all search indexes from the model&#39;s collection
</span><span class='const'>SearchablePerson</span>.<span class='id identifier rubyid_remove_search_indexes'>remove_search_indexes</span></code></pre>

<p>If you are not connected to MongoDB Atlas, the search index definitions are
ignored. Trying to create, enumerate, or remove search indexes will result in
an error.</p>

<p>There are also rake tasks available, for convenience:</p>

<pre class="code bash"><code class="bash"># create search indexes for all models; waits for indexes to be created
# and shows progress on the terminal.
$ rake mongoid:db:create_search_indexes

# as above, but returns immediately and lets the indexes be created in the
# background
$ rake WAIT_FOR_SEARCH_INDEXES=0 mongoid:db:create_search_indexes

# removes search indexes from all models
$ rake mongoid:db:remove_search_indexes
</code></pre>

<h2><code>Time.configured</code> has been removed</h2>

<p><code>Time.configured</code> returned either the time object wrapping the configured
time zone, or the standard Ruby <a href="Time.html" title="Time (class)"><code>Time</code></a> class. This allowed you to query
a time value even if no time zone had been configured.</p>

<p>Mongoid now requires that you set a time zone if you intend to do
anything with time values (including using timestamps in your documents).
Any uses of <code>Time.configured</code> must be replaced with <code>Time.zone</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># before:
</span><span class='id identifier rubyid_puts'>puts</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_configured'>configured</span>.<span class='id identifier rubyid_now'>now</span>

<span class='comment'># after:
</span><span class='id identifier rubyid_puts'>puts</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_zone'>zone</span>.<span class='id identifier rubyid_now'>now</span>

<span class='comment'># or, better for finding the current Time specifically:
</span><span class='id identifier rubyid_puts'>puts</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_current'>current</span></code></pre>

<p>If you do not set a time zone, you will see errors in your code related
to <code>nil</code> values. If you are using Rails, the default time zone is already
set to UTC. If you are not using Rails, you may set a time zone at the start
of your program like this:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_zone'>zone</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UTC</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>This will set the time zone to UTC. You can see all available time zone names
by running the following command:</p>

<pre class="code bash"><code class="bash">$ ruby -ractive_support/values/time_zone \
  -e &#39;puts ActiveSupport::TimeZone::MAPPING.keys&#39;
</code></pre>

<h2>Records now remember the persistence context in which they were loaded/created</h2>

<p>Consider the following code:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_record'>record</span> <span class='op'>=</span> <span class='const'>Model</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>collection:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>other_collection</span><span class='tstring_end'>&#39;</span></span>) { <span class='const'>Model</span>.<span class='id identifier rubyid_first'>first</span> }
<span class='id identifier rubyid_record'>record</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>field:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>value</span><span class='tstring_end'>&#39;</span></span>)</code></pre>

<p>Prior to Mongoid 9.0, this could would silently fail to execute the update,
because the storage options (here, the specification of an alternate
collection for the model) would not be remembered by the record. Thus, the
record would be loaded from &quot;other_collection&quot;, but when updated, would attempt
to look for and update the document in the default collection for Model. To
make this work, you would have had to specify the collection explicitly for
every update.</p>

<p>As of Mongoid 9.0, records that are created or loaded under explicit storage
options, will remember those options (including a named client,
a different database, or a different collection).</p>

<p>If you need the legacy (pre-9.0) behavior, you can enable it with the following
flag:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongoid.html" title="Mongoid (module)">Mongoid</a></span>.<span class='id identifier rubyid_legacy_persistence_context_behavior'>legacy_persistence_context_behavior</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>This flag defaults to false in Mongoid 9.</p>

<h2>Bug Fixes and Improvements</h2>

<p>This section will be for smaller bug fixes and improvements:</p>

<ul>
<li>  The <code>.unscoped</code> method now also clears scopes declared using <code>.with_scope</code>
<a href="https://jira.mongodb.org/browse/MONGOID-5214">MONGOID-5214</a>.</li>
<li>  When evolving a <a href="String.html" title="String (class)"><code>String</code></a> to a <code>BigDecimal</code> (i.e. when querying a
<code>BigDecimal</code> field with a <a href="String.html" title="String (class)"><code>String</code></a> object), if the
<code>map_big_decimal_to_decimal128</code> flag set to true, the conversion will
return a <a href="BSON/Decimal128.html" title="BSON::Decimal128 (class)"><code>::BSON::Decimal128</code></a> and not a <a href="String.html" title="String (class)"><code>String</code></a>
<a href="https://jira.mongodb.org/browse/MONGOID-5484">MONGOID-5484</a>.</li>
<li>  Created new error <a href="Mongoid/Errors/InvalidEstimatedCountCriteria.html" title="Mongoid::Errors::InvalidEstimatedCountCriteria (class)"><code>::Mongoid::Errors::InvalidEstimatedCountCriteria</code></a> for
when calling <code>estimated_document_count</code> on a document class with a
default scope
<a href="https://jira.mongodb.org/browse/MONGOID-4960">MONGOID-4960</a>.</li>
<li>  Mongoid now uses primary reads for validations in all cases
<a href="https://jira.mongodb.org/browse/MONGOID-5150">MONGOID-5150</a>.</li>
<li>  Added support for symbol keys in localized field translation hashes
<a href="https://jira.mongodb.org/browse/MONGOID-5334">MONGOID-5334</a>.</li>
<li>  Added index wildcard option
<a href="https://jira.mongodb.org/browse/MONGOID-5388">MONGOID-5388</a>.</li>
<li>  With the <code>map_big_decimal_to_decimal128</code> flag set to false, <code>demongoizing</code>
a non-numeric, non-string value that implements <code>:to_d</code> will return a string
rather than a <code>BigDecimal</code>
<a href="https://jira.mongodb.org/browse/MONGOID-5507">MONGOID-5507</a>.</li>
<li>  Added support for serializing and deserializing BSON::ObjectId values
when passed as ActiveJob arguments
<a href="https://jira.mongodb.org/browse/MONGOID-5611">MONGOID-5611</a>.</li>
</ul>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>