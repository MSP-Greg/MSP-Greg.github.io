<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: SyntaxSuggest::AroundBlockScan &mdash; syntax_suggest  Ruby-master dev</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "SyntaxSuggest::AroundBlockScan",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Ruby-master</a> &raquo; 
      <a href='../'>syntax_suggest</a> &raquo; 
      <a href='../_index.html#alpha_A'>Index (A)</a> &raquo; 
        <a href="../SyntaxSuggest.html" title="SyntaxSuggest (module)">SyntaxSuggest</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>AroundBlockScan&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: SyntaxSuggest::AroundBlockScan</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L29'>lib/syntax_suggest/around_block_scan.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>This class is useful for exploring contents before and after a block</p>

<p>It searches above and below the passed in block to match for whatever criteria you give it:</p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_dog'>dog</span>         <span class='comment'># 1
</span>  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bark</span><span class='tstring_end'>&quot;</span></span>   <span class='comment'># 2
</span>  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bark</span><span class='tstring_end'>&quot;</span></span>   <span class='comment'># 3
</span><span class='kw'>end</span>             <span class='comment'># 4
</span>
<span class='id identifier rubyid_scan'>scan</span> <span class='op'>=</span> <span class='const'>AroundBlockScan</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="SyntaxSuggest::AroundBlockScan.new (method)">new</a></span>(
  <span class='label'>code_lines:</span> <span class='id identifier rubyid_code_lines'>code_lines</span>
  <span class='id identifier rubyid_block'>block</span><span class='op'>:</span> <span class='const'><a href="CodeBlock.html" title="SyntaxSuggest::CodeBlock (class)">CodeBlock</a></span>.<span class='id identifier rubyid_new'><a href="CodeBlock.html#new-class_method" title="SyntaxSuggest::CodeBlock.new (method)">new</a></span>(<span class='label'>lines:</span> <span class='id identifier rubyid_code_lines'>code_lines</span>[<span class='int'>1</span>])
)

<span class='id identifier rubyid_scan'>scan</span>.<span class='id identifier rubyid_scan_while'><a href="#scan_while-instance_method" title="SyntaxSuggest::AroundBlockScan#scan_while (method)">scan_while</a></span> { <span class='kw'>true</span> }

<span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_scan'>scan</span>.<span class='id identifier rubyid_before_index'>before_index</span> <span class='comment'># =&gt; 0
</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_scan'>scan</span>.<span class='id identifier rubyid_after_index'>after_index</span>  <span class='comment'># =&gt; 3</span></code></pre>

  </div>
</div>
</div>
<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(code_lines:, block:)  &#x21d2; AroundBlockScan </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#code_block-instance_method" title="#code_block (instance method)">#<strong>code_block</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Return the currently matched lines as a <a href="CodeBlock.html" title="SyntaxSuggest::CodeBlock (class)"><code>CodeBlock</code></a></p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#force_add_empty-instance_method" title="#force_add_empty (instance method)">#<strong>force_add_empty</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>When using this flag, <a href="#scan_while-instance_method" title="SyntaxSuggest::AroundBlockScan#scan_while (method)">#scan_while</a> will bypass the block it’s given and always add a line that responds truthy to <a href="CodeLine.html#empty%3F-instance_method" title="SyntaxSuggest::CodeLine#empty? (method)">CodeLine#empty?</a></p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#force_add_hidden-instance_method" title="#force_add_hidden (instance method)">#<strong>force_add_hidden</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>When using this flag, <a href="#scan_while-instance_method" title="SyntaxSuggest::AroundBlockScan#scan_while (method)">#scan_while</a> will bypass the block it’s given and always add a line that responds truthy to <a href="CodeLine.html#hidden%3F-instance_method" title="SyntaxSuggest::CodeLine#hidden? (method)">CodeLine#hidden?</a></p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#inspect-instance_method" title="#inspect (instance method)">#<strong>inspect</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Manageable rspec errors.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#lines-instance_method" title="#lines (instance method)">#<strong>lines</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the lines matched by the current scan as an array of CodeLines.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#lookahead_balance_one_line-instance_method" title="#lookahead_balance_one_line (instance method)">#<strong>lookahead_balance_one_line</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Scanning is intentionally conservative because we have no way of rolling back an aggressive block (at this time).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#scan_adjacent_indent-instance_method" title="#scan_adjacent_indent (instance method)">#<strong>scan_adjacent_indent</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Scan blocks based on indentation of next line above/below block.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#scan_neighbors_not_empty-instance_method" title="#scan_neighbors_not_empty (instance method)">#<strong>scan_neighbors_not_empty</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Finds code lines at the same or greater indentation and adds them to the block.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#scan_while-instance_method" title="#scan_while (instance method)">#<strong>scan_while</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Main work method.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#stop_after_kw-instance_method" title="#stop_after_kw (instance method)">#<strong>stop_after_kw</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Tells <a href="#scan_while-instance_method" title="SyntaxSuggest::AroundBlockScan#scan_while (method)">#scan_while</a> to look for mismatched keyword/end-s.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(code_lines:, block:)  &#x21d2; <code>AroundBlockScan</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L30-L40'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='30' data-end='40'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 30</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='label'>code_lines:</span><span class='comma'>,</span> <span class='label'>block:</span>)
  <span class='ivar'>@code_lines</span> <span class='op'>=</span> <span class='id identifier rubyid_code_lines'>code_lines</span>
  <span class='ivar'>@orig_indent</span> <span class='op'>=</span> <span class='id identifier rubyid_block'>block</span>.<span class='id identifier rubyid_current_indent'>current_indent</span>

  <span class='ivar'>@stop_after_kw</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@force_add_empty</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@force_add_hidden</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@target_indent</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='ivar'>@scanner</span> <span class='op'>=</span> <span class='const'><a href="ScanHistory.html" title="SyntaxSuggest::ScanHistory (class)">ScanHistory</a></span>.<span class='id identifier rubyid_new'><a href="ScanHistory.html#new-class_method" title="SyntaxSuggest::ScanHistory.new (method)">new</a></span>(<span class='label'>code_lines:</span> <span class='id identifier rubyid_code_lines'>code_lines</span><span class='comma'>,</span> <span class='label'>block:</span> <span class='id identifier rubyid_block'>block</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="code_block-instance_method">
  <h3 class='signature  first'>
    #<strong>code_block</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return the currently matched lines as a <a href="CodeBlock.html" title="SyntaxSuggest::CodeBlock (class)"><code>CodeBlock</code></a></p>

<p>When a <a href="CodeBlock.html" title="SyntaxSuggest::CodeBlock (class)"><code>CodeBlock</code></a> is created it will gather metadata about itself, so this is not a free conversion. Avoid allocating more CodeBlock’s than needed</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L217-L219'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='217' data-end='219'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 217</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_code_block'>code_block</span>
  <span class='const'><a href="CodeBlock.html" title="SyntaxSuggest::CodeBlock (class)">CodeBlock</a></span>.<span class='id identifier rubyid_new'><a href="CodeBlock.html#new-class_method" title="SyntaxSuggest::CodeBlock.new (method)">new</a></span>(<span class='label'>lines:</span> <span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::AroundBlockScan#lines (method)">lines</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="force_add_empty-instance_method">
  <h3 class='signature '>
    #<strong>force_add_empty</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>When using this flag, <a href="#scan_while-instance_method" title="SyntaxSuggest::AroundBlockScan#scan_while (method)">#scan_while</a> will bypass the block it’s given and always add a line that responds truthy to <a href="CodeLine.html#empty%3F-instance_method" title="SyntaxSuggest::CodeLine#empty? (method)">CodeLine#empty?</a></p>

<p>Empty lines contain no code, only whitespace such as leading spaces a newline.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L60-L63'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='60' data-end='63'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 60</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_force_add_empty'>force_add_empty</span>
  <span class='ivar'>@force_add_empty</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="force_add_hidden-instance_method">
  <h3 class='signature '>
    #<strong>force_add_hidden</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>When using this flag, <a href="#scan_while-instance_method" title="SyntaxSuggest::AroundBlockScan#scan_while (method)">#scan_while</a> will bypass the block it’s given and always add a line that responds truthy to <a href="CodeLine.html#hidden%3F-instance_method" title="SyntaxSuggest::CodeLine#hidden? (method)">CodeLine#hidden?</a></p>

<p>Lines are hidden when they’ve been evaluated by the parser as part of a block and found to contain valid code.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L49-L52'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='49' data-end='52'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 49</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_force_add_hidden'>force_add_hidden</span>
  <span class='ivar'>@force_add_hidden</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="inspect-instance_method">
  <h3 class='signature '>
    #<strong>inspect</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Manageable rspec errors</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L228-L230'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='228' data-end='230'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 228</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_inspect'>inspect</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;</span><span class='embexpr_beg'>#{</span><span class='kw'>self</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>:0x0000123843lol &gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="lines-instance_method">
  <h3 class='signature '>
    #<strong>lines</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the lines matched by the current scan as an array of CodeLines</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L223-L225'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='223' data-end='225'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 223</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_lines'>lines</span>
  <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_lines'>lines</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="lookahead_balance_one_line-instance_method">
  <h3 class='signature '>
    #<strong>lookahead_balance_one_line</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Scanning is intentionally conservative because we have no way of rolling back an aggressive block (at this time)</p>

<p>If a block was stopped for some trivial reason, (like an empty line) but the next line would have caused it to be balanced then we can check that condition and grab just one more line either up or down.</p>

<p>For example, below if we’re scanning up, line 2 might cause the scanning to stop. This is because empty lines might denote logical breaks where the user intended to chunk code which is a good place to stop and check validity. Unfortunately it also means we might have a “dangling” keyword or end.</p>

<pre class="code ruby"><code class="ruby"><span class='int'>1</span> <span class='kw'>def</span> <span class='id identifier rubyid_bark'>bark</span>
<span class='int'>2</span>
<span class='int'>3</span> <span class='kw'>end</span></code></pre>

<p>If lines 2 and 3 are in the block, then when this method is run it would see it is unbalanced, but that acquiring line 1 would make it balanced, so that’s what it does.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L141-L184'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='141' data-end='184'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 141</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_lookahead_balance_one_line'>lookahead_balance_one_line</span>
  <span class='id identifier rubyid_kw_count'>kw_count</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_end_count'>end_count</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::AroundBlockScan#lines (method)">lines</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span>
    <span class='id identifier rubyid_kw_count'>kw_count</span> <span class='op'>+=</span> <span class='int'>1</span> <span class='kw'>if</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_is_kw?'>is_kw?</span>
    <span class='id identifier rubyid_end_count'>end_count</span> <span class='op'>+=</span> <span class='int'>1</span> <span class='kw'>if</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_is_end?'>is_end?</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='kw'>self</span> <span class='kw'>if</span> <span class='id identifier rubyid_kw_count'>kw_count</span> <span class='op'>==</span> <span class='id identifier rubyid_end_count'>end_count</span> <span class='comment'># nothing to balance
</span>
  <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_commit_if_changed'>commit_if_changed</span> <span class='comment'># Rollback point if we don&#39;t find anything to optimize
</span>
  <span class='comment'># Try to eat up empty lines
</span>  <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_scan'>scan</span>(
    <span class='label'>up:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_line'>line</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_hidden?'>hidden?</span> <span class='op'>||</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_empty?'>empty?</span> }<span class='comma'>,</span>
    <span class='label'>down:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_line'>line</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_hidden?'>hidden?</span> <span class='op'>||</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_empty?'>empty?</span> }
  )

  <span class='comment'># More ends than keywords, check if we can balance expanding up
</span>  <span class='id identifier rubyid_next_up'>next_up</span> <span class='op'>=</span> <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_next_up'>next_up</span>
  <span class='id identifier rubyid_next_down'>next_down</span> <span class='op'>=</span> <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_next_down'>next_down</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_end_count'>end_count</span> <span class='op'>-</span> <span class='id identifier rubyid_kw_count'>kw_count</span>
  <span class='kw'>when</span> <span class='int'>1</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_next_up'>next_up</span><span class='op'>&amp;.</span><span class='id identifier rubyid_is_kw?'>is_kw?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_next_up'>next_up</span>.<span class='id identifier rubyid_indent'>indent</span> <span class='op'>&gt;=</span> <span class='ivar'>@target_indent</span>
      <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_scan'>scan</span>(
        <span class='label'>up:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_line'>line</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_line'>line</span> <span class='op'>==</span> <span class='id identifier rubyid_next_up'>next_up</span> }<span class='comma'>,</span>
        <span class='label'>down:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_line'>line</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span>) <span class='tlambeg'>{</span> <span class='kw'>false</span> }
      )
      <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_commit_if_changed'>commit_if_changed</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='op'>-</span><span class='int'>1</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_next_down'>next_down</span><span class='op'>&amp;.</span><span class='id identifier rubyid_is_end?'>is_end?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_next_down'>next_down</span>.<span class='id identifier rubyid_indent'>indent</span> <span class='op'>&gt;=</span> <span class='ivar'>@target_indent</span>
      <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_scan'>scan</span>(
        <span class='label'>up:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_line'>line</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span>) <span class='tlambeg'>{</span> <span class='kw'>false</span> }<span class='comma'>,</span>
        <span class='label'>down:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_line'>line</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_line'>line</span> <span class='op'>==</span> <span class='id identifier rubyid_next_down'>next_down</span> }
      )
      <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_commit_if_changed'>commit_if_changed</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'># Rollback any uncommitted changes
</span>  <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_stash_changes'>stash_changes</span>

  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="scan_adjacent_indent-instance_method">
  <h3 class='signature '>
    #<strong>scan_adjacent_indent</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Scan blocks based on indentation of next line above/below block</p>

<p>Determines indentaion of the next line above/below the current block.</p>

<p>Normally this is called when a block has expanded to capture all “neighbors” at the same (or greater) indentation and needs to expand out. For example the <code>def/end</code> lines surrounding a method.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L200-L210'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='200' data-end='210'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 200</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_scan_adjacent_indent'>scan_adjacent_indent</span>
  <span class='id identifier rubyid_before_after_indent'>before_after_indent</span> <span class='op'>=</span> []

  <span class='id identifier rubyid_before_after_indent'>before_after_indent</span> <span class='op'>&lt;&lt;</span> (<span class='ivar'>@scanner</span>.<span class='id identifier rubyid_next_up'>next_up</span><span class='op'>&amp;.</span><span class='id identifier rubyid_indent'>indent</span> <span class='op'>||</span> <span class='int'>0</span>)
  <span class='id identifier rubyid_before_after_indent'>before_after_indent</span> <span class='op'>&lt;&lt;</span> (<span class='ivar'>@scanner</span>.<span class='id identifier rubyid_next_down'>next_down</span><span class='op'>&amp;.</span><span class='id identifier rubyid_indent'>indent</span> <span class='op'>||</span> <span class='int'>0</span>)

  <span class='ivar'>@target_indent</span> <span class='op'>=</span> <span class='id identifier rubyid_before_after_indent'>before_after_indent</span>.<span class='id identifier rubyid_min'>min</span>
  <span class='id identifier rubyid_scan_while'><a href="#scan_while-instance_method" title="SyntaxSuggest::AroundBlockScan#scan_while (method)">scan_while</a></span> { <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_not_empty?'>not_empty?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_indent'>indent</span> <span class='op'>&gt;=</span> <span class='ivar'>@target_indent</span> }

  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="scan_neighbors_not_empty-instance_method">
  <h3 class='signature '>
    #<strong>scan_neighbors_not_empty</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Finds code lines at the same or greater indentation and adds them to the block</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L188-L191'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='188' data-end='191'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 188</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_scan_neighbors_not_empty'>scan_neighbors_not_empty</span>
  <span class='ivar'>@target_indent</span> <span class='op'>=</span> <span class='ivar'>@orig_indent</span>
  <span class='id identifier rubyid_scan_while'><a href="#scan_while-instance_method" title="SyntaxSuggest::AroundBlockScan#scan_while (method)">scan_while</a></span> { <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_not_empty?'>not_empty?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_indent'>indent</span> <span class='op'>&gt;=</span> <span class='ivar'>@target_indent</span> }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="scan_while-instance_method">
  <h3 class='signature '>
    #<strong>scan_while</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Main work method</p>

<p>The scan_while method takes a block that yields lines above and below the block. If the yield returns true, the @before_index or @after_index are modified to include the matched line.</p>

<p>In addition to yielding individual lines, the internals of this object give a mini DSL to handle common situations such as stopping if we’ve found a keyword/end mis-match in one direction or the other.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L88-L118'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='88' data-end='118'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 88</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_scan_while'>scan_while</span>
  <span class='id identifier rubyid_stop_next_up'>stop_next_up</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_stop_next_down'>stop_next_down</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='ivar'>@scanner</span>.<span class='id identifier rubyid_scan'>scan</span>(
    <span class='label'>up:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_line'>line</span><span class='comma'>,</span> <span class='id identifier rubyid_kw_count'>kw_count</span><span class='comma'>,</span> <span class='id identifier rubyid_end_count'>end_count</span>) <span class='tlambeg'>{</span>
      <span class='kw'>next</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='id identifier rubyid_stop_next_up'>stop_next_up</span>
      <span class='kw'>next</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='ivar'>@force_add_hidden</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_hidden?'>hidden?</span>
      <span class='kw'>next</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='ivar'>@force_add_empty</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_empty?'>empty?</span>

      <span class='kw'>if</span> <span class='ivar'>@stop_after_kw</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_kw_count'>kw_count</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_end_count'>end_count</span>
        <span class='id identifier rubyid_stop_next_up'>stop_next_up</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>end</span>

      <span class='kw'>yield</span> <span class='id identifier rubyid_line'>line</span>
    }<span class='comma'>,</span>
    <span class='label'>down:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_line'>line</span><span class='comma'>,</span> <span class='id identifier rubyid_kw_count'>kw_count</span><span class='comma'>,</span> <span class='id identifier rubyid_end_count'>end_count</span>) <span class='tlambeg'>{</span>
      <span class='kw'>next</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='id identifier rubyid_stop_next_down'>stop_next_down</span>
      <span class='kw'>next</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='ivar'>@force_add_hidden</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_hidden?'>hidden?</span>
      <span class='kw'>next</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='ivar'>@force_add_empty</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_empty?'>empty?</span>

      <span class='kw'>if</span> <span class='ivar'>@stop_after_kw</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_end_count'>end_count</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_kw_count'>kw_count</span>
        <span class='id identifier rubyid_stop_next_down'>stop_next_down</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>end</span>

      <span class='kw'>yield</span> <span class='id identifier rubyid_line'>line</span>
    }
  )

  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="stop_after_kw-instance_method">
  <h3 class='signature '>
    #<strong>stop_after_kw</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Tells <a href="#scan_while-instance_method" title="SyntaxSuggest::AroundBlockScan#scan_while (method)">#scan_while</a> to look for mismatched keyword/end-s</p>

<p>When scanning up, if we see more keywords then end-s it will stop. This might happen when scanning outside of a method body. the first scan line up would be a keyword and this setting would trigger a stop.</p>

<p>When scanning down, stop if there are more end-s than keywords.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/master/lib/syntax_suggest/around_block_scan.rb#L73-L76'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='73' data-end='76'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/around_block_scan.rb', line 73</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_stop_after_kw'>stop_after_kw</span>
  <span class='ivar'>@stop_after_kw</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>