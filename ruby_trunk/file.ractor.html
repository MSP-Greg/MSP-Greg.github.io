<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Ractor &mdash; Ruby-master</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ractor",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Ruby-master</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Ractor&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="file_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>Ractor - Ruby&#39;s Actor-like concurrency abstraction</h1>

<p>Ractors are designed to provide parallel execution of Ruby code without thread-safety concerns.</p>

<h2>Summary</h2>

<h3>Multiple Ractors in a ruby process</h3>

<p>You can create multiple Ractors which can run ruby code in parallel with each other.</p>

<ul>
<li><code>Ractor.new{ expr }</code> creates a new Ractor and <code>expr</code> can run in parallel with other ractors on a multi-core computer.</li>
<li>Ruby processes start with one ractor (called the <em>main ractor</em>).</li>
<li>If the main ractor terminates, all other ractors receive termination requests, similar to how threads behave.</li>
<li>Each Ractor contains one or more <code>Thread</code>s.

<ul>
<li>Threads within the same ractor share a ractor-wide global lock (GVL in MRI terminology), so they can&#39;t run in parallel with each other (without releasing the GVL explicitly in C extensions). Threads in different ractors can run in parallel.</li>
<li>The overhead of creating a ractor is slightly above the overhead of creating a thread.</li>
</ul></li>
</ul>

<h3>Limited sharing between Ractors</h3>

<p>Ractors don&#39;t share all objects, unlike threads which can access any object other than objects stored in another thread&#39;s thread-locals.</p>

<ul>
<li>Most objects are <em>unshareable objects</em>. Unshareable objects can only be used by the ractor that instantiated them, so you don&#39;t need to worry about thread-safety issues resulting from using the object concurrently across ractors.</li>
<li>Some objects are <em>shareable objects</em>. Here is an incomplete list to give you an idea:

<ul>
<li><code>i = 123</code>: All <code>Integer</code>s are shareable.</li>
<li><code>s = &quot;str&quot;.freeze</code>: Frozen strings are shareable if they have no instance variables that refer to unshareable objects.</li>
<li><code>a = [1, [2], 3].freeze</code>: <code>a</code> is not a shareable object because <code>a</code> refers to the unshareable object <code>[2]</code> (this Array is not frozen).</li>
<li><code>h = {c: Object}.freeze</code>: <code>h</code> is shareable because <code>Symbol</code>s and <code>Class</code>es are shareable, and the Hash is frozen.</li>
<li>Class/Module objects are always shareable, even if they refer to unshareable objects.</li>
<li>Special shareable objects</li>
<li>Ractor objects themselves are shareable.</li>
<li>And more...</li>
</ul></li>
</ul>

<h3>Communication between Ractors with <code>Ractor::Port</code></h3>

<p>Ractors communicate with each other and synchronize their execution by exchanging messages. The <code>Ractor::Port</code> class provides this communication mechanism.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>Port</span>.<span class='id identifier rubyid_new'>new</span>

<span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_port'>port</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_port'>port</span><span class='op'>|</span>
  <span class='comment'># Other ractors can send to the port
</span>  <span class='id identifier rubyid_port'>port</span> <span class='op'>&lt;&lt;</span> <span class='int'>42</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_port'>port</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='comment'># get a message from the port. Only the ractor that created the Port can receive from it.
</span><span class='comment'>#=&gt; 42</span></code></pre>

<p>All Ractors have a default port, which <code>Ractor#send</code>, <code>Ractor.receive</code> (etc) will use.</p>

<h3>Copy &amp; Move semantics when sending objects</h3>

<p>To send unshareable objects to another ractor, objects are either copied or moved.</p>

<ul>
<li>Copy: deep-copies the object to the other ractor. All unshareable objects will be <code>Kernel#clone</code>ed.</li>
<li>Move: moves membership to another ractor.

<ul>
<li>The sending ractor can not access the moved object after it moves.</li>
<li>There is a guarantee that only one ractor can access an unshareable object at once.</li>
</ul></li>
</ul>

<h3>Thread-safety</h3>

<p>Ractors help to write thread-safe, concurrent programs. They allow sharing of data only through explicit message passing for
unshareable objects. Shareable objects are guaranteed to work correctly across ractors, even if the ractors are running in parallel.
This guarantee, however, only applies across ractors. You still need to use <code>Mutex</code>es and other thread-safety tools within a ractor if
you&#39;re using multiple ruby <code>Thread</code>s.</p>

<ul>
<li>Most objects are unshareable. You can&#39;t create data-races across ractors due to the inability to use these objects across ractors.</li>
<li>Shareable objects are protected by locks (or otherwise don&#39;t need to be) so they can be used by more than one ractor at once.</li>
</ul>

<h2>Creation and termination</h2>

<h3><code>Ractor.new</code></h3>

<ul>
<li><code>Ractor.new { expr }</code> creates a Ractor.</li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='comment'># Ractor.new with a block creates a new Ractor
</span><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='comment'># This block can run in parallel with other ractors
</span><span class='kw'>end</span>

<span class='comment'># You can name a Ractor with a `name:` argument.
</span><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my-first-ractor</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_name'>name</span> <span class='comment'>#=&gt; &#39;my-first-ractor&#39;</span></code></pre>

<h3>Block isolation</h3>

<p>The Ractor executes <code>expr</code> in the given block.
The given block will be isolated from its outer scope. To prevent sharing objects between ractors, outer variables, <code>self</code> and other information is isolated from the block.</p>

<p>This isolation occurs at Ractor creation time (when <code>Ractor.new</code> is called). If the given block is not able to be isolated because of outer variables or <code>self</code>, an error will be raised.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>begin</span>
  <span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_a'>a</span> <span class='comment'>#=&gt; ArgumentError because this block accesses outer variable `a`.
</span>  <span class='kw'>end</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span> <span class='comment'># wait for ractor to finish
</span><span class='kw'>rescue</span> <span class='const'>ArgumentError</span>
<span class='kw'>end</span></code></pre>

<ul>
<li>The <code>self</code> of the given block is the <code>Ractor</code> object itself.</li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_p'>p</span> <span class='kw'>self</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; Ractor
</span>  <span class='kw'>self</span>.<span class='id identifier rubyid_object_id'>object_id</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='op'>==</span> <span class='kw'>self</span>.<span class='id identifier rubyid_object_id'>object_id</span> <span class='comment'>#=&gt; false</span></code></pre>

<p>Arguments passed to <code>Ractor.new()</code> become block parameters for the given block. However, Ruby does not pass the objects themselves, but sends them as messages (see below for details).</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='comment'>#=&gt; &#39;ok&#39;
</span><span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; &#39;ok&#39;</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># similar to the last example
</span><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
  <span class='id identifier rubyid_msg'>msg</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; &#39;ok&#39;</span></code></pre>

<h3>The execution result of the given block</h3>

<p>The return value of the given block becomes an outgoing message (see below for details).</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; `ok`</span></code></pre>

<p>An error in the given block will be propagated to the consumer of the outgoing message.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># exception will be transferred to the consumer
</span><span class='kw'>end</span>

<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span>
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>RemoteError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_cause'>cause</span>.<span class='id identifier rubyid_class'>class</span>   <span class='comment'>#=&gt; RuntimeError
</span>  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_cause'>cause</span>.<span class='id identifier rubyid_message'>message</span> <span class='comment'>#=&gt; &#39;ok&#39;
</span>  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_ractor'>ractor</span>        <span class='comment'>#=&gt; r
</span><span class='kw'>end</span></code></pre>

<h2>Communication between Ractors</h2>

<p>Communication between ractors is achieved by sending and receiving messages. There are two ways to communicate:</p>

<ul>
<li>(1) Sending and receiving messages via <code>Ractor::Port</code></li>
<li>(2) Using shareable container objects. For example, the Ractor::TVar gem (<a href="https://github.com/ko1/ractor-tvar">ko1/ractor-tvar</a>)</li>
</ul>

<p>Users can control program execution timing with (1), but should not control with (2) (only perform critical sections).</p>

<p>For sending and receiving messages, these are the fundamental APIs:</p>

<ul>
<li>send/receive via <code>Ractor::Port</code>.

<ul>
<li><code>Ractor::Port#send(obj)</code> (<code>Ractor::Port#<<(obj)</code> is an alias) sends a message to the port. Ports are connected to an infinite size incoming queue so sending will never block the caller.</li>
<li><code>Ractor::Port#receive</code> dequeues a message from its own incoming queue. If the incoming queue is empty, <code>Ractor::Port#receive</code> will block the execution of the current Thread until a message is sent.</li>
<li><code>Ractor#send</code> and <code>Ractor.receive</code> use ports (their default port) internally, so are conceptually similar to the above.</li>
</ul></li>
<li>You can close a <code>Ractor::Port</code> by <code>Ractor::Port#close</code>. A port can only be closed by the ractor that created it.

<ul>
<li>If a port is closed, you can&#39;t <code>send</code> to it. Doing so raises an exception.</li>
<li>When a ractor is terminated, the ractor&#39;s ports are automatically closed.</li>
</ul></li>
<li>You can wait for a ractor&#39;s termination and receive its return value with <code>Ractor#value</code>. This is similar to <code>Thread#value</code>.</li>
</ul>

<p>There are 3 ways to send an object as a message:</p>

<p>1) Send a reference: sending a shareable object sends only a reference to the object (fast).</p>

<p>2) Copy an object: sending an unshareable object through copying it deeply (can be slow). Note that you can not send an object this way which does not support deep copy. Some <code>T_DATA</code> objects (objects whose class is defined in a C extension, such as <code>StringIO</code>) are not supported.</p>

<p>3) Move an object: sending an unshareable object across ractors with a membership change. The sending Ractor can not access the moved object after moving it, otherwise an exception will be raised. Implementation note: <code>T_DATA</code> objects are not supported.</p>

<p>You can choose between &quot;Copy&quot; and &quot;Move&quot; by the <code>move:</code> keyword, <code>Ractor#send(obj, move: true/false)</code>. The default is <code>false</code> (&quot;Copy&quot;). However, if the object is shareable it will automatically use <code>move</code>.</p>

<h3>Wait for multiple Ractors with <code>Ractor.select</code></h3>

<p>You can wait for messages on multiple ports at once.
The return value of <code>Ractor.select()</code> is <code>[port, msg]</code> where <code>port</code> is a ready port and <code>msg</code> is the received message.</p>

<p>To make it convenient, <code>Ractor.select</code> can also accept ractors. In this case, it waits for their termination.
The return value of <code>Ractor.select()</code> is <code>[r, msg]</code> where <code>r</code> is a terminated Ractor and <code>msg</code> is the value of the ractor&#39;s block.</p>

<p>Wait for a single ractor (same as <code>Ractor#value</code>):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r1'>r1</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span>{<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r1</span><span class='tstring_end'>&#39;</span></span>}

<span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='id identifier rubyid_r1'>r1</span>)
<span class='id identifier rubyid_r'>r</span> <span class='op'>==</span> <span class='id identifier rubyid_r1'>r1</span> <span class='kw'>and</span> <span class='id identifier rubyid_obj'>obj</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r1</span><span class='tstring_end'>&#39;</span></span> <span class='comment'>#=&gt; true</span></code></pre>

<p>Wait for two ractors:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r1'>r1</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span>{<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r1</span><span class='tstring_end'>&#39;</span></span>}
<span class='id identifier rubyid_r2'>r2</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span>{<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r2</span><span class='tstring_end'>&#39;</span></span>}
<span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> [<span class='id identifier rubyid_r1'>r1</span><span class='comma'>,</span> <span class='id identifier rubyid_r2'>r2</span>]
<span class='id identifier rubyid_values'>values</span> <span class='op'>=</span> []

<span class='kw'>while</span> <span class='id identifier rubyid_rs'>rs</span>.<span class='id identifier rubyid_any?'>any?</span>
  <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span>)
  <span class='id identifier rubyid_rs'>rs</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_r'>r</span>)
  <span class='id identifier rubyid_values'>values</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_obj'>obj</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_sort'>sort</span> <span class='op'>==</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r2</span><span class='tstring_end'>&#39;</span></span>] <span class='comment'>#=&gt; true</span></code></pre>

<p>NOTE: Using <code>Ractor.select()</code> on a very large number of ractors has the same issue as <code>select(2)</code> currently.</p>

<h3>Closing ports</h3>

<ul>
<li><code>Ractor::Port#close</code> closes the port (similar to <code>Queue#close</code>).

<ul>
<li><code>port.send(obj)</code> will raise an exception when the port is closed.</li>
<li>When the queue connected to the port is empty and port is closed, <code>Ractor::Port#receive</code> raises an exception. If the queue is not empty, it dequeues an object without exceptions.</li>
</ul></li>
<li>When a Ractor terminates, the ports are closed automatically.</li>
</ul>

<p>Example (try to get a result from closed ractor):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>finish</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span> <span class='comment'># success (wait for the termination)
</span><span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'># success (will return &#39;finish&#39;)
</span>
<span class='comment'># The ractor&#39;s termination value has already been given to another ractor
</span><span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; Ractor::Error
</span><span class='kw'>end</span>.<span class='id identifier rubyid_join'>join</span></code></pre>

<p>Example (try to send to closed port):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span> <span class='comment'># wait for termination, closes default port
</span>
<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span>(<span class='int'>1</span>)
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>ClosedError</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></code></pre>

<h3>Send a message by copying</h3>

<p><code>Ractor::Port#send(obj)</code> copies <code>obj</code> deeply if <code>obj</code> is an unshareable object.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>str</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_dup'>dup</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_obj'>obj</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span>
  <span class='comment'># return received msg&#39;s object_id
</span>  <span class='id identifier rubyid_msg'>msg</span>.<span class='id identifier rubyid_object_id'>object_id</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_obj'>obj</span>.<span class='id identifier rubyid_object_id'>object_id</span> <span class='op'>==</span> <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; false</span></code></pre>

<p>Some objects do not support copying, and raise an exception.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='const'>Thread</span>.<span class='id identifier rubyid_new'>new</span>{}
<span class='kw'>begin</span>
  <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_obj'>obj</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span>
    <span class='id identifier rubyid_msg'>msg</span>
  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='const'>TypeError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span> <span class='comment'>#=&gt; #&lt;TypeError: allocator undefined for Thread&gt;
</span><span class='kw'>end</span></code></pre>

<h3>Send a message by moving</h3>

<p><code>Ractor::Port#send(obj, move: true)</code> moves <code>obj</code> to the destination Ractor.
If the source ractor uses the moved object (for example, calls a method like <code>obj.foo()</code>), it will raise an error.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
  <span class='id identifier rubyid_obj'>obj</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> world</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_dup'>dup</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_str'>str</span><span class='comma'>,</span> <span class='label'>move:</span> <span class='kw'>true</span>
<span class='comment'># str is now moved, and accessing str from this ractor is prohibited
</span><span class='id identifier rubyid_modified'>modified</span> <span class='op'>=</span> <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; &#39;hello world&#39;
</span>

<span class='kw'>begin</span>
  <span class='comment'># Error because it uses moved str.
</span>  <span class='id identifier rubyid_str'>str</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> exception</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># raise Ractor::MovedError
</span><span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>MovedError</span>
  <span class='id identifier rubyid_modified'>modified</span> <span class='comment'>#=&gt; &#39;hello world&#39;
</span><span class='kw'>end</span></code></pre>

<p>Some objects do not support moving, and an exception will be raised.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span>(<span class='const'>Thread</span>.<span class='id identifier rubyid_new'>new</span>{}<span class='comma'>,</span> <span class='label'>move:</span> <span class='kw'>true</span>) <span class='comment'>#=&gt; allocator undefined for Thread (TypeError)</span></code></pre>

<p>Once an object has been moved, the source object&#39;s class is changed to <code>Ractor::MovedObject</code>.</p>

<h3>Shareable objects</h3>

<p>The following is an inexhaustive list of shareable objects:</p>

<ul>
<li><code>Integer</code>, <code>Float</code>, <code>Complex</code>, <code>Rational</code></li>
<li><code>Symbol</code>, frozen <code>String</code> objects that don&#39;t refer to unshareables, <code>true</code>, <code>false</code>, <code>nil</code></li>
<li><code>Regexp</code> objects, if they have no instance variables or their instance variables refer only to shareables</li>
<li><code>Class</code> and <code>Module</code> objects</li>
<li><code>Ractor</code> and other special objects which deal with synchronization</li>
</ul>

<p>To make objects shareable, <code>Ractor.make_shareable(obj)</code> is provided. It tries to make the object shareable by freezing <code>obj</code> and recursively traversing its references to freeze them all. This method accepts the <code>copy:</code> keyword (default value is false). <code>Ractor.make_shareable(obj, copy: true)</code> tries to make a deep copy of <code>obj</code> and make the copied object shareable. <code>Ractor.make_shareable(copy: false)</code> has no effect on an already shareable object. If the object cannot be made shareable, a <code>Ractor::Error</code> exception will be raised.</p>

<h2>Language changes to limit sharing between Ractors</h2>

<p>To isolate unshareable objects across ractors, we introduced additional language semantics for multi-ractor Ruby programs.</p>

<p>Note that when not using ractors, these additional semantics are not needed (100% compatible with Ruby 2).</p>

<h3>Global variables</h3>

<p>Only the main Ractor can access global variables.</p>

<pre class="code ruby"><code class="ruby"><span class='gvar'>$gv</span> <span class='op'>=</span> <span class='int'>1</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='gvar'>$gv</span>
<span class='kw'>end</span>

<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>RemoteError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_cause'>cause</span>.<span class='id identifier rubyid_message'>message</span> <span class='comment'>#=&gt; &#39;can not access global variables from non-main Ractors&#39;
</span><span class='kw'>end</span></code></pre>

<p>Note that some special global variables, such as <code>$stdin</code>, <code>$stdout</code> and <code>$stderr</code> are local to each ractor. See <a href="https://bugs.ruby-lang.org/issues/17268">[Bug #17268]</a> for more details.</p>

<h3>Instance variables of shareable objects</h3>

<p>Instance variables of classes/modules can be accessed from non-main ractors only if their values are shareable objects.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>C</span>
  <span class='ivar'>@iv</span> <span class='op'>=</span> <span class='int'>1</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='kw'>class</span> <span class='const'>C</span>
     <span class='ivar'>@iv</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; 1</span></code></pre>

<p>Otherwise, only the main Ractor can access instance variables of shareable objects.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>C</span>
  <span class='ivar'>@iv</span> <span class='op'>=</span> [] <span class='comment'># unshareable object
</span><span class='kw'>end</span>

<span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='kw'>class</span> <span class='const'>C</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_p'>p</span> <span class='ivar'>@iv</span>
    <span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>IsolationError</span>
      <span class='id identifier rubyid_p'>p</span> <span class='gvar'>$!</span>.<span class='id identifier rubyid_message'>message</span>
      <span class='comment'>#=&gt; &quot;can not get unshareable values from instance variables of classes/modules from non-main Ractors&quot;
</span>    <span class='kw'>end</span>

    <span class='kw'>begin</span>
      <span class='ivar'>@iv</span> <span class='op'>=</span> <span class='int'>42</span>
    <span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>IsolationError</span>
      <span class='id identifier rubyid_p'>p</span> <span class='gvar'>$!</span>.<span class='id identifier rubyid_message'>message</span>
      <span class='comment'>#=&gt; &quot;can not set instance variables of classes/modules by non-main Ractors&quot;
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>.<span class='id identifier rubyid_join'>join</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_shared'>shared</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span>{}
<span class='id identifier rubyid_shared'>shared</span>.<span class='id identifier rubyid_instance_variable_set'>instance_variable_set</span>(<span class='symbeg'>:</span><span class='ivar'>@iv</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>str</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_shared'>shared</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_shared'>shared</span><span class='op'>|</span>
  <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_shared'>shared</span>.<span class='id identifier rubyid_instance_variable_get'>instance_variable_get</span>(<span class='symbeg'>:</span><span class='ivar'>@iv</span>)
<span class='kw'>end</span>

<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>RemoteError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_cause'>cause</span>.<span class='id identifier rubyid_message'>message</span> <span class='comment'>#=&gt; can not access instance variables of shareable objects from non-main Ractors (Ractor::IsolationError)
</span><span class='kw'>end</span></code></pre>

<h3>Class variables</h3>

<p>Only the main Ractor can access class variables.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>C</span>
  <span class='cvar'>@@cv</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>str</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='kw'>class</span> <span class='const'>C</span>
    <span class='id identifier rubyid_p'>p</span> <span class='cvar'>@@cv</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>


<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; Ractor::IsolationError
</span><span class='kw'>end</span></code></pre>

<h3>Constants</h3>

<p>Only the main Ractor can read constants which refer to an unshareable object.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>C</span>
  <span class='const'>CONST</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>str</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_dup'>dup</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='const'>C</span><span class='op'>::</span><span class='const'>CONST</span>
<span class='kw'>end</span>
<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; Ractor::IsolationError
</span><span class='kw'>end</span></code></pre>

<p>Only the main Ractor can define constants which refer to an unshareable object.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>C</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='const'>C</span><span class='op'>::</span><span class='const'>CONST</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>str</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_dup'>dup</span>
<span class='kw'>end</span>
<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; Ractor::IsolationError
</span><span class='kw'>end</span></code></pre>

<p>When creating/updating a library to support ractors, constants should only refer to shareable objects if they are to be used by non-main ractors.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>TABLE</span> <span class='op'>=</span> {<span class='label'>a:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>b:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko2</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>c:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko3</span><span class='tstring_end'>&#39;</span></span>}</code></pre>

<p>In this case, <code>TABLE</code> refers to an unshareable Hash object. In order for other ractors to use <code>TABLE</code>, we need to make it shareable. We can use <code>Ractor.make_shareable()</code> like so:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>TABLE</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_make_shareable'>make_shareable</span>( {<span class='label'>a:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>b:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko2</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>c:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko3</span><span class='tstring_end'>&#39;</span></span>} )</code></pre>

<p>To make it easy, Ruby 3.0 introduced a new <code>shareable_constant_value</code> file directive.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># shareable_constant_value: literal
</span>
<span class='const'>TABLE</span> <span class='op'>=</span> {<span class='label'>a:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>b:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko2</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>c:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko3</span><span class='tstring_end'>&#39;</span></span>}
<span class='comment'>#=&gt; Same as: TABLE = Ractor.make_shareable( {a: &#39;ko1&#39;, b: &#39;ko2&#39;, c: &#39;ko3&#39;} )</span></code></pre>

<p>The <code>shareable_constant_value</code> directive accepts the following modes (descriptions use the example: <code>CONST = expr</code>):</p>

<ul>
<li>none: Do nothing. Same as: <code>CONST = expr</code></li>
<li>literal:

<ul>
<li>if <code>expr</code> consists of literals, replaced to <code>CONST = Ractor.make_shareable(expr)</code>.</li>
<li>otherwise: replaced to <code>CONST = expr.tap{|o| raise unless Ractor.shareable?(o)}</code>.</li>
</ul></li>
<li>experimental_everything: replaced to <code>CONST = Ractor.make_shareable(expr)</code>.</li>
<li>experimental_copy: replaced to <code>CONST = Ractor.make_shareable(expr, copy: true)</code>.</li>
</ul>

<p>Except for the <code>none</code> mode (default), it is guaranteed that these constants refer only to shareable objects.</p>

<p>See <a href="../syntax/comments.rdoc">syntax/comments.rdoc</a> for more details.</p>

<h3>Shareable procs</h3>

<p>Procs and lambdas are unshareable objects, even when they are frozen. To create an unshareable Proc, you must use <code>Ractor.shareable_proc { expr }</code>. Much like during Ractor creation, the proc&#39;s block is isolated from its outer environment, so it cannot access variables from the outside scope. <code>self</code> is also changed within the Proc to be <code>nil</code> by default, although a <code>self:</code> keyword can be provided if you want to customize the value to a different shareable object.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_p'>p</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_shareable_proc'>shareable_proc</span> { <span class='id identifier rubyid_p'>p</span> <span class='kw'>self</span> }
<span class='id identifier rubyid_p'>p</span>.<span class='id identifier rubyid_call'>call</span> <span class='comment'>#=&gt; nil</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='kw'>begin</span>
  <span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='int'>1</span>
  <span class='id identifier rubyid_pr'>pr</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_shareable_proc'>shareable_proc</span> { <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_a'>a</span> }
  <span class='id identifier rubyid_pr'>pr</span>.<span class='id identifier rubyid_call'>call</span> <span class='comment'># never gets here
</span><span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>IsolationError</span>
<span class='kw'>end</span></code></pre>

<p>In order to dynamically define a method with <code>Module#define_method</code> that can be used from different ractors, you must define it with a shareable proc. Alternatively, you can use <code>Module#class_eval</code> or <code>Module#module_eval</code> with a String. Even though the shareable proc&#39;s <code>self</code> is initially bound to <code>nil</code>, <code>define_method</code> will bind <code>self</code> to the correct value in the method.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>A</span>
  <span class='id identifier rubyid_define_method'>define_method</span> <span class='symbeg'>:</span><span class='id identifier rubyid_testing'>testing</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='const'>Ractor</span>.<span class='id identifier rubyid_shareable_proc'>shareable_proc</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_p'>p</span> <span class='kw'>self</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
<span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='const'>A</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_a'>a</span>.<span class='id identifier rubyid_testing'>testing</span> <span class='comment'>#=&gt; #&lt;A:0x0000000101acfe10&gt;
</span><span class='kw'>end</span>.<span class='id identifier rubyid_join'>join</span></code></pre>

<p>This isolation must be done to prevent the method from accessing and assigning captured outer variables across ractors.</p>

<h3>Ractor-local storage</h3>

<p>You can store any object (even unshareables) in ractor-local storage.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_values'>values</span> <span class='op'>=</span> []
  <span class='const'>Ractor</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_threads'>threads</span>] <span class='op'>=</span> []
  <span class='int'>3</span>.<span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='const'>Ractor</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_threads'>threads</span>] <span class='op'>&lt;&lt;</span> <span class='const'>Thread</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_values'>values</span> <span class='op'>&lt;&lt;</span> [<span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>+</span><span class='int'>1</span>] <span class='comment'># Ractor.receive blocks the current thread in the current ractor until it receives a message
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='const'>Ractor</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_threads'>threads</span>].<span class='id identifier rubyid_each'>each</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_join'>join</span>)
  <span class='id identifier rubyid_values'>values</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r'>r</span> <span class='op'>&lt;&lt;</span> <span class='int'>1</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>&lt;&lt;</span> <span class='int'>2</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>&lt;&lt;</span> <span class='int'>3</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; [[1,1],[2,2],[3,3]] (the order can change with each run)</span></code></pre>

<h2>Examples</h2>

<h3>Traditional Ring example in Actor-model</h3>

<pre class="code ruby"><code class="ruby"><span class='const'>RN</span> <span class='op'>=</span> <span class='int'>1_000</span>
<span class='const'>CR</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>

<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
  <span class='const'>CR</span> <span class='op'>&lt;&lt;</span> <span class='symbeg'>:</span><span class='id identifier rubyid_fin'>fin</span>
<span class='kw'>end</span>

<span class='const'>RN</span>.<span class='id identifier rubyid_times'>times</span>{
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_next_r'>next_r</span><span class='op'>|</span>
    <span class='id identifier rubyid_next_r'>next_r</span> <span class='op'>&lt;&lt;</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
  <span class='kw'>end</span>
}

<span class='id identifier rubyid_p'>p</span> <span class='symbeg'>:</span><span class='id identifier rubyid_setup_ok'>setup_ok</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>&lt;&lt;</span> <span class='int'>1</span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span></code></pre>

<h3>Fork-join</h3>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_fib'>fib</span> <span class='id identifier rubyid_n'>n</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_n'>n</span> <span class='op'>&lt;</span> <span class='int'>2</span>
    <span class='int'>1</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_fib'>fib</span>(<span class='id identifier rubyid_n'>n</span><span class='op'>-</span><span class='int'>2</span>) <span class='op'>+</span> <span class='id identifier rubyid_fib'>fib</span>(<span class='id identifier rubyid_n'>n</span><span class='op'>-</span><span class='int'>1</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>RN</span> <span class='op'>=</span> <span class='int'>10</span>
<span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> (<span class='int'>1</span><span class='op'>..</span><span class='const'>RN</span>).<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    [<span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_fib'>fib</span>(<span class='id identifier rubyid_i'>i</span>)]
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>until</span> <span class='id identifier rubyid_rs'>rs</span>.<span class='id identifier rubyid_empty?'>empty?</span>
  <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span>)
  <span class='id identifier rubyid_rs'>rs</span>.<span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_r'>r</span>
  <span class='id identifier rubyid_p'>p</span> <span class='label'>answer:</span> <span class='id identifier rubyid_v'>v</span>
<span class='kw'>end</span></code></pre>

<h3>Worker pool</h3>

<p>(1) One ractor has a pool</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>prime</span><span class='tstring_end'>&#39;</span></span>

<span class='const'>N</span> <span class='op'>=</span> <span class='int'>1000</span>
<span class='const'>RN</span> <span class='op'>=</span> <span class='int'>10</span>

<span class='comment'># make RN workers
</span><span class='id identifier rubyid_workers'>workers</span> <span class='op'>=</span> (<span class='int'>1</span><span class='op'>..</span><span class='const'>RN</span>).<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span>
  <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span> <span class='op'>|</span><span class='semicolon'>;</span> <span class='id identifier rubyid_result_port'>result_port</span><span class='op'>|</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result_port'>result_port</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
      <span class='id identifier rubyid_result_port'>result_port</span> <span class='op'>&lt;&lt;</span> [<span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_n'>n</span>.<span class='id identifier rubyid_prime?'>prime?</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>]
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_result_port'>result_port</span> <span class='op'>=</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>Port</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_results'>results</span> <span class='op'>=</span> []

(<span class='int'>1</span><span class='op'>..</span><span class='const'>N</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_workers'>workers</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'># receive a result
</span>    <span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_w'>w</span> <span class='op'>=</span> <span class='id identifier rubyid_result_port'>result_port</span>.<span class='id identifier rubyid_receive'>receive</span>
    <span class='id identifier rubyid_results'>results</span> <span class='op'>&lt;&lt;</span> [<span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span>]
  <span class='kw'>else</span>
    <span class='id identifier rubyid_w'>w</span> <span class='op'>=</span> <span class='id identifier rubyid_workers'>workers</span>.<span class='id identifier rubyid_pop'>pop</span>
  <span class='kw'>end</span>

  <span class='comment'># send a task to the idle worker ractor
</span>  <span class='id identifier rubyid_w'>w</span> <span class='op'>&lt;&lt;</span> [<span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_result_port'>result_port</span>]
<span class='kw'>end</span>

<span class='comment'># receive a result
</span><span class='kw'>while</span> <span class='id identifier rubyid_results'>results</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>!=</span> <span class='const'>N</span>
  <span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid__w'>_w</span> <span class='op'>=</span> <span class='id identifier rubyid_result_port'>result_port</span>.<span class='id identifier rubyid_receive'>receive</span>
  <span class='id identifier rubyid_results'>results</span> <span class='op'>&lt;&lt;</span> [<span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span>]
<span class='kw'>end</span>

<span class='id identifier rubyid_pp'>pp</span> <span class='id identifier rubyid_results'>results</span>.<span class='id identifier rubyid_sort_by'>sort_by</span>{<span class='op'>|</span><span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='op'>|</span> <span class='id identifier rubyid_n'>n</span>}</code></pre>

<h3>Pipeline</h3>

<pre class="code ruby"><code class="ruby"><span class='comment'># pipeline with send/receive
</span>
<span class='id identifier rubyid_r3'>r3</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cr'>cr</span><span class='op'>|</span>
  <span class='id identifier rubyid_cr'>cr</span>.<span class='id identifier rubyid_send'>send</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r3</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r2'>r2</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r3'>r3</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r3'>r3</span><span class='op'>|</span>
  <span class='id identifier rubyid_r3'>r3</span>.<span class='id identifier rubyid_send'>send</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r2</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r1'>r1</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r2'>r2</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r2'>r2</span><span class='op'>|</span>
  <span class='id identifier rubyid_r2'>r2</span>.<span class='id identifier rubyid_send'>send</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r1</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r1'>r1</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='comment'>#=&gt; &quot;r0r1r2r3&quot;</span></code></pre>

<h3>Supervise</h3>

<pre class="code ruby"><code class="ruby"><span class='comment'># ring example again
</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>
(<span class='int'>1</span><span class='op'>..</span><span class='int'>10</span>).<span class='id identifier rubyid_map'>map</span>{<span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
}

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='comment'>#=&gt; &quot;r0r10r9r8r7r6r5r4r3r2r1&quot;</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># ring example with an error
</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>
<span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> (<span class='int'>1</span><span class='op'>..</span><span class='int'>10</span>).<span class='id identifier rubyid_map'>map</span>{<span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>e</span><span class='regexp_end'>/</span></span> <span class='op'>=~</span> <span class='id identifier rubyid_msg'>msg</span>
      <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
}

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='comment'>#=&gt; &quot;r0r10r9r8r7r6r5r4r3r2r1&quot;
</span><span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>) <span class='comment'>#=&gt; [:receive, &quot;r0r10r9r8r7r6r5r4r3r2r1&quot;]
</span><span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>e0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>)
<span class='comment'>#=&gt;
</span><span class='comment'># &lt;Thread:0x000056262de28bd8 run&gt; terminated with exception (report_on_exception is true):
</span><span class='comment'># Traceback (most recent call last):
</span><span class='comment'>#         2: from /home/ko1/src/ruby/trunk/test.rb:7:in `block (2 levels) in &lt;main&gt;&#39;
</span><span class='comment'>#         1: from /home/ko1/src/ruby/trunk/test.rb:7:in `loop&#39;
</span><span class='comment'># /home/ko1/src/ruby/trunk/test.rb:9:in `block (3 levels) in &lt;main&gt;&#39;: unhandled exception
</span><span class='comment'># Traceback (most recent call last):
</span><span class='comment'>#         2: from /home/ko1/src/ruby/trunk/test.rb:7:in `block (2 levels) in &lt;main&gt;&#39;
</span><span class='comment'>#         1: from /home/ko1/src/ruby/trunk/test.rb:7:in `loop&#39;
</span><span class='comment'># /home/ko1/src/ruby/trunk/test.rb:9:in `block (3 levels) in &lt;main&gt;&#39;: unhandled exception
</span><span class='comment'>#         1: from /home/ko1/src/ruby/trunk/test.rb:21:in `&lt;main&gt;&#39;
</span><span class='comment'># &lt;internal:ractor&gt;:69:in `select&#39;: thrown by remote Ractor. (Ractor::RemoteError)</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># resend non-error message
</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>
<span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> (<span class='int'>1</span><span class='op'>..</span><span class='int'>10</span>).<span class='id identifier rubyid_map'>map</span>{<span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>e</span><span class='regexp_end'>/</span></span> <span class='op'>=~</span> <span class='id identifier rubyid_msg'>msg</span>
      <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
}

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='comment'>#=&gt; &quot;r0r10r9r8r7r6r5r4r3r2r1&quot;
</span><span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>)
[<span class='symbeg'>:</span><span class='id identifier rubyid_receive'>receive</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0r10r9r8r7r6r5r4r3r2r1</span><span class='tstring_end'>&quot;</span></span>]
<span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>e0</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_msg'>msg</span>
  <span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>)
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>RemoteError</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>retry</span>
<span class='kw'>end</span>

<span class='comment'>#=&gt; &lt;internal:ractor&gt;:100:in `send&#39;: The incoming-port is already closed (Ractor::ClosedError)
</span><span class='comment'># because r == r[-1] is terminated.</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># ring example with supervisor and re-start
</span>
<span class='kw'>def</span> <span class='id identifier rubyid_make_ractor'>make_ractor</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span>
  <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>e</span><span class='regexp_end'>/</span></span> <span class='op'>=~</span> <span class='id identifier rubyid_msg'>msg</span>
      <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>
<span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> (<span class='int'>1</span><span class='op'>..</span><span class='int'>10</span>).<span class='id identifier rubyid_map'>map</span>{<span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='id identifier rubyid_make_ractor'>make_ractor</span>(<span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span>)
}

<span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>e0</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># error causing message
</span><span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_msg'>msg</span>
  <span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>)
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>RemoteError</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='id identifier rubyid_rs'>rs</span>[<span class='op'>-</span><span class='int'>1</span>] <span class='op'>=</span> <span class='id identifier rubyid_make_ractor'>make_ractor</span>(<span class='id identifier rubyid_rs'>rs</span>[<span class='op'>-</span><span class='int'>2</span>]<span class='comma'>,</span> <span class='id identifier rubyid_rs'>rs</span>.<span class='id identifier rubyid_size'>size</span><span class='op'>-</span><span class='int'>1</span>)
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>x0</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>retry</span>
<span class='kw'>end</span>

<span class='comment'>#=&gt; [:receive, &quot;x0r9r9r8r7r6r5r4r3r2r1&quot;]</span></code></pre>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>