<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Ractor &mdash; Ruby-master</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ractor",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Ruby-master</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Ractor&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="file_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>Ractor - Ruby&#39;s Actor-like concurrent abstraction</h1>

<p>Ractor is designed to provide a parallel execution feature of Ruby without thread-safety concerns.</p>

<h2>Summary</h2>

<h3>Multiple Ractors in an interpreter process</h3>

<p>You can make multiple Ractors and they run in parallel.</p>

<ul>
<li><code>Ractor.new{ expr }</code> creates a new Ractor and <code>expr</code> is run in parallel on a parallel computer.</li>
<li>Interpreter invokes with the first Ractor (called <em>main Ractor</em>).</li>
<li>If the main Ractor terminates, all other Ractors receive termination requests, similar to how threads behave. (if main thread (first invoked Thread), Ruby interpreter sends all running threads to terminate execution).</li>
<li>Each Ractor contains one or more Threads.

<ul>
<li>Threads within the same Ractor share a Ractor-wide global lock like GIL (GVL in MRI terminology), so they can&#39;t run in parallel (without releasing GVL explicitly in C-level). Threads in different ractors run in parallel.</li>
<li>The overhead of creating a Ractor is similar to overhead of one Thread creation.</li>
</ul></li>
</ul>

<h3>Limited sharing between multiple ractors</h3>

<p>Ractors don&#39;t share everything, unlike threads.</p>

<ul>
<li>Most objects are <em>Unshareable objects</em>, so you don&#39;t need to care about thread-safety problems which are caused by sharing.</li>
<li>Some objects are <em>Shareable objects</em>.

<ul>
<li>Immutable objects: frozen objects which don&#39;t refer to unshareable-objects.</li>
<li><code>i = 123</code>: <code>i</code> is an immutable object.</li>
<li><code>s = &quot;str&quot;.freeze</code>: <code>s</code> is an immutable object.</li>
<li><code>a = [1, [2], 3].freeze</code>: <code>a</code> is not an immutable object because <code>a</code> refers unshareable-object <code>[2]</code> (which is not frozen).</li>
<li><code>h = {c: Object}.freeze</code>: <code>h</code> is an immutable object because <code>h</code> refers Symbol <code>:c</code> and shareable <code>Object</code> class object which is not frozen.</li>
<li>Class/Module objects</li>
<li>Special shareable objects</li>
<li>Ractor object itself.</li>
<li>And more...</li>
</ul></li>
</ul>

<h3>Communication between Ractors with <code>Ractor::Port</code></h3>

<p>Ractors communicate with each other and synchronize the execution by message exchanging between Ractors. <code>Ractor::Port</code> is provided for this communication.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>Port</span>.<span class='id identifier rubyid_new'>new</span>

<span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_port'>port</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_port'>port</span><span class='op'>|</span>
  <span class='comment'># Other ractors can send to the port
</span>  <span class='id identifier rubyid_port'>port</span> <span class='op'>&lt;&lt;</span> <span class='int'>42</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_port'>port</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='comment'># get a message to the port. Only the creator Ractor can receive from the port
</span><span class='comment'>#=&gt; 42</span></code></pre>

<p>Ractors have its own default port and <code>Ractor#send</code>, <code>Ractor.receive</code> will use it.</p>

<h3>Copy &amp; Move semantics to send messages</h3>

<p>To send unshareable objects as messages, objects are copied or moved.</p>

<ul>
<li>Copy: use deep-copy.</li>
<li>Move: move membership.

<ul>
<li>Sender can not access the moved object after moving the object.</li>
<li>Guarantee that at least only 1 Ractor can access the object.</li>
</ul></li>
</ul>

<h3>Thread-safety</h3>

<p>Ractor helps to write a thread-safe concurrent program, but we can make thread-unsafe programs with Ractors.</p>

<ul>
<li>GOOD: Sharing limitation

<ul>
<li>Most objects are unshareable, so we can&#39;t make data-racy and race-conditional programs.</li>
<li>Shareable objects are protected by an interpreter or locking mechanism.</li>
</ul></li>
<li>BAD: Class/Module can violate this assumption

<ul>
<li>To make it compatible with old behavior, classes and modules can introduce data-race and so on.</li>
<li>Ruby programmers should take care if they modify class/module objects on multi Ractor programs.</li>
</ul></li>
<li>BAD: Ractor can&#39;t solve all thread-safety problems

<ul>
<li>There are several blocking operations (waiting send) so you can make a program which has dead-lock and live-lock issues.</li>
<li>Some kind of shareable objects can introduce transactions (STM, for example). However, misusing transactions will generate inconsistent state.</li>
</ul></li>
</ul>

<p>Without Ractor, we need to trace all state-mutations to debug thread-safety issues.
With Ractor, you can concentrate on suspicious code which are shared with Ractors.</p>

<h2>Creation and termination</h2>

<h3><code>Ractor.new</code></h3>

<ul>
<li><code>Ractor.new{ expr }</code> generates another Ractor.</li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='comment'># Ractor.new with a block creates new Ractor
</span><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='comment'># This block will be run in parallel with other ractors
</span><span class='kw'>end</span>

<span class='comment'># You can name a Ractor with `name:` argument.
</span><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test-name</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
<span class='kw'>end</span>

<span class='comment'># and Ractor#name returns its name.
</span><span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_name'>name</span> <span class='comment'>#=&gt; &#39;test-name&#39;</span></code></pre>

<h3>Given block isolation</h3>

<p>The Ractor executes given <code>expr</code> in a given block.
Given block will be isolated from outer scope by the <code>Proc#isolate</code> method (not exposed yet for Ruby users). To prevent sharing unshareable objects between ractors, block outer-variables, <code>self</code> and other information are isolated.</p>

<p><code>Proc#isolate</code> is called at Ractor creation time (when <code>Ractor.new</code> is called). If given Proc object is not able to isolate because of outer variables and so on, an error will be raised.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>begin</span>
  <span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_a'>a</span> <span class='comment'>#=&gt; ArgumentError because this block accesses `a`.
</span>  <span class='kw'>end</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span> <span class='comment'># see later
</span><span class='kw'>rescue</span> <span class='const'>ArgumentError</span>
<span class='kw'>end</span></code></pre>

<ul>
<li>The <code>self</code> of the given block is the <code>Ractor</code> object itself.</li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_p'>p</span> <span class='kw'>self</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; Ractor
</span>  <span class='kw'>self</span>.<span class='id identifier rubyid_object_id'>object_id</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='op'>==</span> <span class='kw'>self</span>.<span class='id identifier rubyid_object_id'>object_id</span> <span class='comment'>#=&gt; false</span></code></pre>

<p>Passed arguments to <code>Ractor.new()</code> becomes block parameters for the given block. However, an interpreter does not pass the parameter object references, but send them as messages (see below for details).</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='comment'>#=&gt; &#39;ok&#39;
</span><span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; &#39;ok&#39;</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># almost similar to the last example
</span><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
  <span class='id identifier rubyid_msg'>msg</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; &#39;ok&#39;</span></code></pre>

<h3>An execution result of given block</h3>

<p>Return value of the given block becomes an outgoing message (see below for details).</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; `ok`</span></code></pre>

<p>Error in the given block will be propagated to the receiver of an outgoing message.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># exception will be transferred to the receiver
</span><span class='kw'>end</span>

<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span>
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>RemoteError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_cause'>cause</span>.<span class='id identifier rubyid_class'>class</span>   <span class='comment'>#=&gt; RuntimeError
</span>  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_cause'>cause</span>.<span class='id identifier rubyid_message'>message</span> <span class='comment'>#=&gt; &#39;ok&#39;
</span>  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_ractor'>ractor</span>        <span class='comment'>#=&gt; r
</span><span class='kw'>end</span></code></pre>

<h2>Communication between Ractors</h2>

<p>Communication between Ractors is achieved by sending and receiving messages. There are two ways to communicate with each other.</p>

<ul>
<li>(1) Message sending/receiving via <code>Ractor::Port</code></li>
<li>(2) Using shareable container objects

<ul>
<li>Ractor::TVar gem (<a href="https://github.com/ko1/ractor-tvar">ko1/ractor-tvar</a>)</li>
<li>more?</li>
</ul></li>
</ul>

<p>Users can control program execution timing with (1), but should not control with (2) (only manage as critical section).</p>

<p>For message sending and receiving, there are two types of APIs: push type and pull type.</p>

<ul>
<li>(1) send/receive via <code>Ractor::Port</code>.

<ul>
<li><code>Ractor::Port#send(obj)</code> (<code>Ractor::Port#<<(obj)</code> is an alias) send a message to the port. Ports are connected to the infinite size incoming queue so <code>Ractor::Port#send</code> will never block.</li>
<li><code>Ractor::Port#receive</code> dequeue a message from its own incoming queue. If the incoming queue is empty, <code>Ractor::Port#receive</code> calling will block the execution of a thread.</li>
</ul></li>
<li><code>Ractor.select()</code> can wait for the success of <code>Ractor::Port#receive</code>.</li>
<li>You can close <code>Ractor::Port</code> by <code>Ractor::Port#close</code> only by the creator Ractor of the port.

<ul>
<li>If the port is closed, you can&#39;t <code>send</code> to the port. If <code>Ractor::Port#receive</code> is blocked for the closed port, then it will raise an exception.</li>
<li>When a Ractor is terminated, the Ractor&#39;s ports are closed.</li>
</ul></li>
<li>There are 3 ways to send an object as a message

<ul>
<li>(1) Send a reference: Sending a shareable object, send only a reference to the object (fast)</li>
<li>(2) Copy an object: Sending an unshareable object by copying an object deeply (slow). Note that you can not send an object which does not support deep copy. Some <code>T_DATA</code> objects (objects whose class is defined in a C extension, such as <code>StringIO</code>) are not supported.</li>
<li>(3) Move an object: Sending an unshareable object reference with a membership. Sender Ractor can not access moved objects anymore (raise an exception) after moving it. Current implementation makes new object as a moved object for receiver Ractor and copies references of sending object to moved object. <code>T_DATA</code> objects are not supported.</li>
<li>You can choose &quot;Copy&quot; and &quot;Move&quot; by the <code>move:</code> keyword, <code>Ractor#send(obj, move: true/false)</code> and <code>Ractor.yield(obj, move: true/false)</code> (default is <code>false</code> (COPY)).</li>
</ul></li>
</ul>

<h3>Wait for multiple Ractors with <code>Ractor.select</code></h3>

<p>You can wait multiple Ractor port&#39;s receiving.
The return value of <code>Ractor.select()</code> is <code>[port, msg]</code> where <code>port</code> is a ready port and <code>msg</code> is received message.</p>

<p>To make convenient, <code>Ractor.select</code> can also accept Ractors to wait the termination of Ractors.
The return value of <code>Ractor.select()</code> is <code>[r, msg]</code> where <code>r</code> is a terminated Ractor and <code>msg</code> is the value of Ractor&#39;s block.</p>

<p>Wait for a single ractor (same as <code>Ractor#value</code>):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r1'>r1</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span>{<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r1</span><span class='tstring_end'>&#39;</span></span>}

<span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='id identifier rubyid_r1'>r1</span>)
<span class='id identifier rubyid_r'>r</span> <span class='op'>==</span> <span class='id identifier rubyid_r1'>r1</span> <span class='kw'>and</span> <span class='id identifier rubyid_obj'>obj</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r1</span><span class='tstring_end'>&#39;</span></span> <span class='comment'>#=&gt; true</span></code></pre>

<p>Waiting for two ractors:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r1'>r1</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span>{<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r1</span><span class='tstring_end'>&#39;</span></span>}
<span class='id identifier rubyid_r2'>r2</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span>{<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r2</span><span class='tstring_end'>&#39;</span></span>}
<span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> [<span class='id identifier rubyid_r1'>r1</span><span class='comma'>,</span> <span class='id identifier rubyid_r2'>r2</span>]
<span class='id identifier rubyid_as'>as</span> <span class='op'>=</span> []

<span class='comment'># Wait for r1 or r2&#39;s Ractor.yield
</span><span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span>)
<span class='id identifier rubyid_rs'>rs</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_r'>r</span>)
<span class='id identifier rubyid_as'>as</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_obj'>obj</span>

<span class='comment'># Second try (rs only contain not-closed ractors)
</span><span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span>)
<span class='id identifier rubyid_rs'>rs</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_r'>r</span>)
<span class='id identifier rubyid_as'>as</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_obj'>obj</span>
<span class='id identifier rubyid_as'>as</span>.<span class='id identifier rubyid_sort'>sort</span> <span class='op'>==</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r2</span><span class='tstring_end'>&#39;</span></span>] <span class='comment'>#=&gt; true</span></code></pre>

<p>TODO: Current <code>Ractor.select()</code> has the same issue of <code>select(2)</code>, so this interface should be refined.</p>

<p>TODO: <code>select</code> syntax of go-language uses round-robin technique to make fair scheduling. Now <code>Ractor.select()</code> doesn&#39;t use it.</p>

<h3>Closing Ractor&#39;s ports</h3>

<ul>
<li><code>Ractor::Port#close</code> close the ports (similar to <code>Queue#close</code>).

<ul>
<li><code>port.send(obj)</code> where <code>port</code> is closed, will raise an exception.</li>
<li>When the queue connected to the port is empty and port is closed, <code>Ractor::Port#receive</code> raises an exception. If the queue is not empty, it dequeues an object without exceptions.</li>
</ul></li>
<li>When a Ractor terminates, the ports are closed automatically.</li>
</ul>

<p>Example (try to get a result from closed Ractor):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>finish</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span> <span class='comment'># success (wait for the termination)
</span><span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'># success (will return &#39;finish&#39;)
</span>
<span class='comment'># the first Ractor which success the {Ractor#value} can get the result
</span><span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; Ractor::Error
</span><span class='kw'>end</span></code></pre>

<p>Example (try to send to closed (terminated) Ractor):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span> <span class='comment'># wait terminate
</span>
<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span>(<span class='int'>1</span>)
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>ClosedError</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>else</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ng</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></code></pre>

<h3>Send a message by copying</h3>

<p><code>Ractor::Port#send(obj)</code> copy <code>obj</code> deeply if <code>obj</code> is an unshareable object.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>str</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_dup'>dup</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_obj'>obj</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span>
  <span class='comment'># return received msg&#39;s object_id
</span>  <span class='id identifier rubyid_msg'>msg</span>.<span class='id identifier rubyid_object_id'>object_id</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_obj'>obj</span>.<span class='id identifier rubyid_object_id'>object_id</span> <span class='op'>==</span> <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; false</span></code></pre>

<p>Some objects are not supported to copy the value, and raise an exception.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='const'>Thread</span>.<span class='id identifier rubyid_new'>new</span>{}
<span class='kw'>begin</span>
  <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_obj'>obj</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span>
    <span class='id identifier rubyid_msg'>msg</span>
  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='const'>TypeError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span> <span class='comment'>#=&gt; #&lt;TypeError: allocator undefined for Thread&gt;
</span><span class='kw'>else</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ng</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># unreachable here
</span><span class='kw'>end</span></code></pre>

<h3>Send a message by moving</h3>

<p><code>Ractor::Port#send(obj, move: true)</code> moves <code>obj</code> to the destination Ractor.
If the source Ractor touches the moved object (for example, call the method like <code>obj.foo()</code>), it will be an error.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># move with Ractor#send
</span><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
  <span class='id identifier rubyid_obj'>obj</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> world</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_str'>str</span><span class='comma'>,</span> <span class='label'>move:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_modified'>modified</span> <span class='op'>=</span> <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; &#39;hello world&#39;
</span>
<span class='comment'># str is moved, and accessing str from this Ractor is prohibited
</span>
<span class='kw'>begin</span>
  <span class='comment'># Error because it touches moved str.
</span>  <span class='id identifier rubyid_str'>str</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> exception</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># raise Ractor::MovedError
</span><span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>MovedError</span>
  <span class='id identifier rubyid_modified'>modified</span> <span class='comment'>#=&gt; &#39;hello world&#39;
</span><span class='kw'>else</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unreachable</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></code></pre>

<p>Some objects are not supported to move, and an exception will be raised.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span>(<span class='const'>Thread</span>.<span class='id identifier rubyid_new'>new</span>{}<span class='comma'>,</span> <span class='label'>move:</span> <span class='kw'>true</span>) <span class='comment'>#=&gt; allocator undefined for Thread (TypeError)</span></code></pre>

<p>To achieve the access prohibition for moved objects, <em>class replacement</em> technique is used to implement it.</p>

<h3>Shareable objects</h3>

<p>The following objects are shareable.</p>

<ul>
<li>Immutable objects

<ul>
<li>Small integers, some symbols, <code>true</code>, <code>false</code>, <code>nil</code> (a.k.a. <code>SPECIAL_CONST_P()</code> objects in internal)</li>
<li>Frozen native objects</li>
<li>Numeric objects: <code>Float</code>, <code>Complex</code>, <code>Rational</code>, big integers (<code>T_BIGNUM</code> in internal)</li>
<li>All Symbols.</li>
<li>Frozen <code>String</code> and <code>Regexp</code> objects (their instance variables should refer only shareable objects)</li>
</ul></li>
<li>Class, Module objects (<code>T_CLASS</code>, <code>T_MODULE</code> and <code>T_ICLASS</code> in internal)</li>
<li><code>Ractor</code> and other special objects which care about synchronization.</li>
</ul>

<p>Implementation: Now shareable objects (<code>RVALUE</code>) have <code>FL_SHAREABLE</code> flag. This flag can be added lazily.</p>

<p>To make shareable objects, <code>Ractor.make_shareable(obj)</code> method is provided. In this case, try to make shareable by freezing <code>obj</code> and recursively traversable objects. This method accepts <code>copy:</code> keyword (default value is false).<code>Ractor.make_shareable(obj, copy: true)</code> tries to make a deep copy of <code>obj</code> and make the copied object shareable.</p>

<h2>Language changes to isolate unshareable objects between Ractors</h2>

<p>To isolate unshareable objects between Ractors, we introduced additional language semantics on multi-Ractor Ruby programs.</p>

<p>Note that without using Ractors, these additional semantics is not needed (100% compatible with Ruby 2).</p>

<h3>Global variables</h3>

<p>Only the main Ractor (a Ractor created at starting of interpreter) can access global variables.</p>

<pre class="code ruby"><code class="ruby"><span class='gvar'>$gv</span> <span class='op'>=</span> <span class='int'>1</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='gvar'>$gv</span>
<span class='kw'>end</span>

<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>RemoteError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_cause'>cause</span>.<span class='id identifier rubyid_message'>message</span> <span class='comment'>#=&gt; &#39;can not access global variables from non-main Ractors&#39;
</span><span class='kw'>end</span></code></pre>

<p>Note that some special global variables, such as <code>$stdin</code>, <code>$stdout</code> and <code>$stderr</code> are Ractor-local. See <a href="https://bugs.ruby-lang.org/issues/17268">[Bug #17268]</a> for more details.</p>

<h3>Instance variables of shareable objects</h3>

<p>Instance variables of classes/modules can be get from non-main Ractors if the referring values are shareable objects.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>C</span>
  <span class='ivar'>@iv</span> <span class='op'>=</span> <span class='int'>1</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='kw'>class</span> <span class='const'>C</span>
     <span class='ivar'>@iv</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>.<span class='id identifier rubyid_value'>value</span> <span class='comment'>#=&gt; 1</span></code></pre>

<p>Otherwise, only the main Ractor can access instance variables of shareable objects.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>C</span>
  <span class='ivar'>@iv</span> <span class='op'>=</span> [] <span class='comment'># unshareable object
</span><span class='kw'>end</span>

<span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='kw'>class</span> <span class='const'>C</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_p'>p</span> <span class='ivar'>@iv</span>
    <span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>IsolationError</span>
      <span class='id identifier rubyid_p'>p</span> <span class='gvar'>$!</span>.<span class='id identifier rubyid_message'>message</span>
      <span class='comment'>#=&gt; &quot;can not get unshareable values from instance variables of classes/modules from non-main Ractors&quot;
</span>    <span class='kw'>end</span>

    <span class='kw'>begin</span>
      <span class='ivar'>@iv</span> <span class='op'>=</span> <span class='int'>42</span>
    <span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>IsolationError</span>
      <span class='id identifier rubyid_p'>p</span> <span class='gvar'>$!</span>.<span class='id identifier rubyid_message'>message</span>
      <span class='comment'>#=&gt; &quot;can not set instance variables of classes/modules by non-main Ractors&quot;
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>.<span class='id identifier rubyid_join'>join</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_shared'>shared</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span>{}
<span class='id identifier rubyid_shared'>shared</span>.<span class='id identifier rubyid_instance_variable_set'>instance_variable_set</span>(<span class='symbeg'>:</span><span class='ivar'>@iv</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>str</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_shared'>shared</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_shared'>shared</span><span class='op'>|</span>
  <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_shared'>shared</span>.<span class='id identifier rubyid_instance_variable_get'>instance_variable_get</span>(<span class='symbeg'>:</span><span class='ivar'>@iv</span>)
<span class='kw'>end</span>

<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>RemoteError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_cause'>cause</span>.<span class='id identifier rubyid_message'>message</span> <span class='comment'>#=&gt; can not access instance variables of shareable objects from non-main Ractors (Ractor::IsolationError)
</span><span class='kw'>end</span></code></pre>

<p>Note that instance variables for class/module objects are also prohibited on Ractors.</p>

<h3>Class variables</h3>

<p>Only the main Ractor can access class variables.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>C</span>
  <span class='cvar'>@@cv</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>str</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='kw'>class</span> <span class='const'>C</span>
    <span class='id identifier rubyid_p'>p</span> <span class='cvar'>@@cv</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>


<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; Ractor::IsolationError
</span><span class='kw'>end</span></code></pre>

<h3>Constants</h3>

<p>Only the main Ractor can read constants which refer to the unshareable object.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>C</span>
  <span class='const'>CONST</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>str</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='const'>C</span><span class='op'>::</span><span class='const'>CONST</span>
<span class='kw'>end</span>
<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; Ractor::IsolationError
</span><span class='kw'>end</span></code></pre>

<p>Only the main Ractor can define constants which refer to the unshareable object.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>C</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='const'>C</span><span class='op'>::</span><span class='const'>CONST</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>str</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span> <span class='comment'>#=&gt; Ractor::IsolationError
</span><span class='kw'>end</span></code></pre>

<p>To make multi-ractor supported library, the constants should only refer shareable objects.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>TABLE</span> <span class='op'>=</span> {<span class='label'>a:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>b:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko2</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>c:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko3</span><span class='tstring_end'>&#39;</span></span>}</code></pre>

<p>In this case, <code>TABLE</code> references an unshareable Hash object. So that other ractors can not refer <code>TABLE</code> constant. To make it shareable, we can use <code>Ractor.make_shareable()</code> like that.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>TABLE</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_make_shareable'>make_shareable</span>( {<span class='label'>a:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>b:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko2</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>c:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko3</span><span class='tstring_end'>&#39;</span></span>} )</code></pre>

<p>To make it easy, Ruby 3.0 introduced new <code>shareable_constant_value</code> Directive.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># shareable_constant_value: literal
</span>
<span class='const'>TABLE</span> <span class='op'>=</span> {<span class='label'>a:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>b:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko2</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>c:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ko3</span><span class='tstring_end'>&#39;</span></span>}
<span class='comment'>#=&gt; Same as: TABLE = Ractor.make_shareable( {a: &#39;ko1&#39;, b: &#39;ko2&#39;, c: &#39;ko3&#39;} )</span></code></pre>

<p><code>shareable_constant_value</code> directive accepts the following modes (descriptions use the example: <code>CONST = expr</code>):</p>

<ul>
<li>none: Do nothing. Same as: <code>CONST = expr</code></li>
<li>literal:

<ul>
<li>if <code>expr</code> consists of literals, replaced to <code>CONST = Ractor.make_shareable(expr)</code>.</li>
<li>otherwise: replaced to <code>CONST = expr.tap{|o| raise unless Ractor.shareable?(o)}</code>.</li>
</ul></li>
<li>experimental_everything: replaced to <code>CONST = Ractor.make_shareable(expr)</code>.</li>
<li>experimental_copy: replaced to <code>CONST = Ractor.make_shareable(expr, copy: true)</code>.</li>
</ul>

<p>Except the <code>none</code> mode (default), it is guaranteed that the assigned constants refer to only shareable objects.</p>

<p>See <a href="syntax/comments.rdoc">doc/syntax/comments.rdoc</a> for more details.</p>

<h2>Implementation note</h2>

<ul>
<li>Each Ractor has its own thread, it means each Ractor has at least 1 native thread.</li>
<li>Each Ractor has its own ID (<code>rb_ractor_t::pub::id</code>).

<ul>
<li>On debug mode, all unshareable objects are labeled with current Ractor&#39;s id, and it is checked to detect unshareable object leak (access an object from different Ractor) in VM.</li>
</ul></li>
</ul>

<h2>Examples</h2>

<h3>Traditional Ring example in Actor-model</h3>

<pre class="code ruby"><code class="ruby"><span class='const'>RN</span> <span class='op'>=</span> <span class='int'>1_000</span>
<span class='const'>CR</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>

<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
  <span class='const'>CR</span> <span class='op'>&lt;&lt;</span> <span class='symbeg'>:</span><span class='id identifier rubyid_fin'>fin</span>
<span class='kw'>end</span>

<span class='const'>RN</span>.<span class='id identifier rubyid_times'>times</span>{
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_next_r'>next_r</span><span class='op'>|</span>
    <span class='id identifier rubyid_next_r'>next_r</span> <span class='op'>&lt;&lt;</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
  <span class='kw'>end</span>
}

<span class='id identifier rubyid_p'>p</span> <span class='symbeg'>:</span><span class='id identifier rubyid_setup_ok'>setup_ok</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>&lt;&lt;</span> <span class='int'>1</span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span></code></pre>

<h3>Fork-join</h3>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_fib'>fib</span> <span class='id identifier rubyid_n'>n</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_n'>n</span> <span class='op'>&lt;</span> <span class='int'>2</span>
    <span class='int'>1</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_fib'>fib</span>(<span class='id identifier rubyid_n'>n</span><span class='op'>-</span><span class='int'>2</span>) <span class='op'>+</span> <span class='id identifier rubyid_fib'>fib</span>(<span class='id identifier rubyid_n'>n</span><span class='op'>-</span><span class='int'>1</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>RN</span> <span class='op'>=</span> <span class='int'>10</span>
<span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> (<span class='int'>1</span><span class='op'>..</span><span class='const'>RN</span>).<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    [<span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_fib'>fib</span>(<span class='id identifier rubyid_i'>i</span>)]
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>until</span> <span class='id identifier rubyid_rs'>rs</span>.<span class='id identifier rubyid_empty?'>empty?</span>
  <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span>)
  <span class='id identifier rubyid_rs'>rs</span>.<span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_r'>r</span>
  <span class='id identifier rubyid_p'>p</span> <span class='label'>answer:</span> <span class='id identifier rubyid_v'>v</span>
<span class='kw'>end</span></code></pre>

<h3>Worker pool</h3>

<p>(1) One ractor has a pool</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>prime</span><span class='tstring_end'>&#39;</span></span>

<span class='const'>N</span> <span class='op'>=</span> <span class='int'>1000</span>
<span class='const'>RN</span> <span class='op'>=</span> <span class='int'>10</span>

<span class='comment'># make RN workers
</span><span class='id identifier rubyid_workers'>workers</span> <span class='op'>=</span> (<span class='int'>1</span><span class='op'>..</span><span class='const'>RN</span>).<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span>
  <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span> <span class='op'>|</span><span class='semicolon'>;</span> <span class='id identifier rubyid_result_port'>result_port</span><span class='op'>|</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result_port'>result_port</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
      <span class='id identifier rubyid_result_port'>result_port</span> <span class='op'>&lt;&lt;</span> [<span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_n'>n</span>.<span class='id identifier rubyid_prime?'>prime?</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>]
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_result_port'>result_port</span> <span class='op'>=</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>Port</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_results'>results</span> <span class='op'>=</span> []

(<span class='int'>1</span><span class='op'>..</span><span class='const'>N</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_workers'>workers</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'># receive a result
</span>    <span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_w'>w</span> <span class='op'>=</span> <span class='id identifier rubyid_result_port'>result_port</span>.<span class='id identifier rubyid_receive'>receive</span>
    <span class='id identifier rubyid_results'>results</span> <span class='op'>&lt;&lt;</span> [<span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span>]
  <span class='kw'>else</span>
    <span class='id identifier rubyid_w'>w</span> <span class='op'>=</span> <span class='id identifier rubyid_workers'>workers</span>.<span class='id identifier rubyid_pop'>pop</span>
  <span class='kw'>end</span>

  <span class='comment'># send a task to the idle worker ractor
</span>  <span class='id identifier rubyid_w'>w</span> <span class='op'>&lt;&lt;</span> [<span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_result_port'>result_port</span>]
<span class='kw'>end</span>

<span class='comment'># receive a result
</span><span class='kw'>while</span> <span class='id identifier rubyid_results'>results</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>!=</span> <span class='const'>N</span>
  <span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid__w'>_w</span> <span class='op'>=</span> <span class='id identifier rubyid_result_port'>result_port</span>.<span class='id identifier rubyid_receive'>receive</span>
  <span class='id identifier rubyid_results'>results</span> <span class='op'>&lt;&lt;</span> [<span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span>]
<span class='kw'>end</span>

<span class='id identifier rubyid_pp'>pp</span> <span class='id identifier rubyid_results'>results</span>.<span class='id identifier rubyid_sort_by'>sort_by</span>{<span class='op'>|</span><span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='op'>|</span> <span class='id identifier rubyid_n'>n</span>}</code></pre>

<h3>Pipeline</h3>

<pre class="code ruby"><code class="ruby"><span class='comment'># pipeline with send/receive
</span>
<span class='id identifier rubyid_r3'>r3</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cr'>cr</span><span class='op'>|</span>
  <span class='id identifier rubyid_cr'>cr</span>.<span class='id identifier rubyid_send'>send</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r3</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r2'>r2</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r3'>r3</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r3'>r3</span><span class='op'>|</span>
  <span class='id identifier rubyid_r3'>r3</span>.<span class='id identifier rubyid_send'>send</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r2</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r1'>r1</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r2'>r2</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r2'>r2</span><span class='op'>|</span>
  <span class='id identifier rubyid_r2'>r2</span>.<span class='id identifier rubyid_send'>send</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r1</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r1'>r1</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='comment'>#=&gt; &quot;r0r1r2r3&quot;</span></code></pre>

<h3>Supervise</h3>

<pre class="code ruby"><code class="ruby"><span class='comment'># ring example again
</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>
(<span class='int'>1</span><span class='op'>..</span><span class='int'>10</span>).<span class='id identifier rubyid_map'>map</span>{<span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
}

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='comment'>#=&gt; &quot;r0r10r9r8r7r6r5r4r3r2r1&quot;</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># ring example with an error
</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>
<span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> (<span class='int'>1</span><span class='op'>..</span><span class='int'>10</span>).<span class='id identifier rubyid_map'>map</span>{<span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>e</span><span class='regexp_end'>/</span></span> <span class='op'>=~</span> <span class='id identifier rubyid_msg'>msg</span>
      <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
}

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='comment'>#=&gt; &quot;r0r10r9r8r7r6r5r4r3r2r1&quot;
</span><span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>) <span class='comment'>#=&gt; [:receive, &quot;r0r10r9r8r7r6r5r4r3r2r1&quot;]
</span><span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>e0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>)
<span class='comment'>#=&gt;
</span><span class='comment'># &lt;Thread:0x000056262de28bd8 run&gt; terminated with exception (report_on_exception is true):
</span><span class='comment'># Traceback (most recent call last):
</span><span class='comment'>#         2: from /home/ko1/src/ruby/trunk/test.rb:7:in `block (2 levels) in &lt;main&gt;&#39;
</span><span class='comment'>#         1: from /home/ko1/src/ruby/trunk/test.rb:7:in `loop&#39;
</span><span class='comment'># /home/ko1/src/ruby/trunk/test.rb:9:in `block (3 levels) in &lt;main&gt;&#39;: unhandled exception
</span><span class='comment'># Traceback (most recent call last):
</span><span class='comment'>#         2: from /home/ko1/src/ruby/trunk/test.rb:7:in `block (2 levels) in &lt;main&gt;&#39;
</span><span class='comment'>#         1: from /home/ko1/src/ruby/trunk/test.rb:7:in `loop&#39;
</span><span class='comment'># /home/ko1/src/ruby/trunk/test.rb:9:in `block (3 levels) in &lt;main&gt;&#39;: unhandled exception
</span><span class='comment'>#         1: from /home/ko1/src/ruby/trunk/test.rb:21:in `&lt;main&gt;&#39;
</span><span class='comment'># &lt;internal:ractor&gt;:69:in `select&#39;: thrown by remote Ractor. (Ractor::RemoteError)</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># resend non-error message
</span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>
<span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> (<span class='int'>1</span><span class='op'>..</span><span class='int'>10</span>).<span class='id identifier rubyid_map'>map</span>{<span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>e</span><span class='regexp_end'>/</span></span> <span class='op'>=~</span> <span class='id identifier rubyid_msg'>msg</span>
      <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
}

<span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span> <span class='comment'>#=&gt; &quot;r0r10r9r8r7r6r5r4r3r2r1&quot;
</span><span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>)
[<span class='symbeg'>:</span><span class='id identifier rubyid_receive'>receive</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r0r10r9r8r7r6r5r4r3r2r1</span><span class='tstring_end'>&quot;</span></span>]
<span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>e0</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_msg'>msg</span>
  <span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>)
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>RemoteError</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r0</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>retry</span>
<span class='kw'>end</span>

<span class='comment'>#=&gt; &lt;internal:ractor&gt;:100:in `send&#39;: The incoming-port is already closed (Ractor::ClosedError)
</span><span class='comment'># because r == r[-1] is terminated.</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># ring example with supervisor and re-start
</span>
<span class='kw'>def</span> <span class='id identifier rubyid_make_ractor'>make_ractor</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span>
  <span class='const'>Ractor</span>.<span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_receive'>receive</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>e</span><span class='regexp_end'>/</span></span> <span class='op'>=~</span> <span class='id identifier rubyid_msg'>msg</span>
      <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>
<span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> (<span class='int'>1</span><span class='op'>..</span><span class='int'>10</span>).<span class='id identifier rubyid_map'>map</span>{<span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='id identifier rubyid_make_ractor'>make_ractor</span>(<span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span>)
}

<span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>e0</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># error causing message
</span><span class='kw'>begin</span>
  <span class='id identifier rubyid_r'>r</span>.<span class='id identifier rubyid_send'>send</span> <span class='id identifier rubyid_msg'>msg</span>
  <span class='id identifier rubyid_p'>p</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_rs'>rs</span><span class='comma'>,</span> <span class='const'>Ractor</span>.<span class='id identifier rubyid_current'>current</span>)
<span class='kw'>rescue</span> <span class='const'>Ractor</span><span class='op'>::</span><span class='const'>RemoteError</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='id identifier rubyid_rs'>rs</span>[<span class='op'>-</span><span class='int'>1</span>] <span class='op'>=</span> <span class='id identifier rubyid_make_ractor'>make_ractor</span>(<span class='id identifier rubyid_rs'>rs</span>[<span class='op'>-</span><span class='int'>2</span>]<span class='comma'>,</span> <span class='id identifier rubyid_rs'>rs</span>.<span class='id identifier rubyid_size'>size</span><span class='op'>-</span><span class='int'>1</span>)
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>x0</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>retry</span>
<span class='kw'>end</span>

<span class='comment'>#=&gt; [:receive, &quot;x0r9r9r8r7r6r5r4r3r2r1&quot;]</span></code></pre>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>