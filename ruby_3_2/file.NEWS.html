<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: NEWS &mdash; Ruby-3.2.9</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "NEWS",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Ruby-3.2.9</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: NEWS&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="file_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>NEWS for Ruby 3.2.0</h1>

<p>This document is a list of user-visible feature changes
since the <strong>3.1.0</strong> release, except for bug fixes.</p>

<p>Note that each entry is kept to a minimum, see links for details.</p>

<h2>Language changes</h2>

<ul>
<li><p>Anonymous rest and keyword rest arguments can now be passed as
arguments, instead of just used in method parameters.
[<a href="https://bugs.ruby-lang.org/issues/18351">Feature #18351</a>]</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_foo'>foo</span>(<span class='op'>*</span>)
  <span class='id identifier rubyid_bar'>bar</span>(<span class='op'>*</span>)
<span class='kw'>end</span>
<span class='kw'>def</span> <span class='id identifier rubyid_baz'>baz</span>(<span class='op'>**</span>)
  <span class='id identifier rubyid_quux'>quux</span>(<span class='op'>**</span>)
<span class='kw'>end</span></code></pre></li>
<li><p>A proc that accepts a single positional argument and keywords will
no longer autosplat. [<a href="https://bugs.ruby-lang.org/issues/18633">Bug #18633</a>]</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_proc'>proc</span>{<span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span>}.<span class='id identifier rubyid_call'>call</span>([<span class='int'>1</span><span class='comma'>,</span> <span class='int'>2</span>])
<span class='comment'># Ruby 3.1 and before
</span><span class='comment'># =&gt; 1
</span><span class='comment'># Ruby 3.2 and after
</span><span class='comment'># =&gt; [1, 2]</span></code></pre></li>
<li><p>Constant assignment evaluation order for constants set on explicit
objects has been made consistent with single attribute assignment
evaluation order. With this code:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_foo'>foo</span><span class='op'>::</span><span class='const'>BAR</span> <span class='op'>=</span> <span class='id identifier rubyid_baz'>baz</span></code></pre>

<p><code>foo</code> is now called before <code>baz</code>. Similarly, for multiple assignments
to constants,  left-to-right evaluation order is used. With this
code:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_foo1'>foo1</span><span class='op'>::</span><span class='const'>BAR1</span><span class='comma'>,</span> <span class='id identifier rubyid_foo2'>foo2</span><span class='op'>::</span><span class='const'>BAR2</span> <span class='op'>=</span> <span class='id identifier rubyid_baz1'>baz1</span><span class='comma'>,</span> <span class='id identifier rubyid_baz2'>baz2</span></code></pre>

<p>The following evaluation order is now used:</p></li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='int'>1</span>. <span class='backtick'>`</span><span class='id identifier rubyid_foo1'>foo1</span><span class='backtick'>`</span><span class='tstring_content'>
2. </span><span class='tstring_end'>`</span></span><span class='id identifier rubyid_foo2'>foo2</span><span class='backtick'>`</span><span class='tstring_content'>
3. </span><span class='tstring_end'>`</span></span><span class='id identifier rubyid_baz1'>baz1</span><span class='backtick'>`</span><span class='tstring_content'>
4. </span><span class='tstring_end'>`</span></span><span class='id identifier rubyid_baz2'>baz2</span><span class='backtick'>`</span><span class='tstring_content'>

[[Bug #15928]]</span></code></pre>

<ul>
<li><p>&quot;Find pattern&quot; is no longer experimental.
[<a href="https://bugs.ruby-lang.org/issues/18585">Feature #18585</a>]</p></li>
<li><p>Methods taking a rest parameter (like <code>*args</code>) and wishing to delegate keyword
arguments through <code>foo(*args)</code> must now be marked with <code>ruby2_keywords</code>
(if not already the case). In other words, all methods wishing to delegate
keyword arguments through <code>*args</code> must now be marked with <code>ruby2_keywords</code>,
with no exception. This will make it easier to transition to other ways of
delegation once a library can require Ruby 3+. Previously, the <code>ruby2_keywords</code>
flag was kept if the receiving method took <code>*args</code>, but this was a bug and an
inconsistency. A good technique to find the potentially-missing <code>ruby2_keywords</code>
is to run the test suite, for where it fails find the last method which must
receive keyword arguments, use <code>puts nil, caller, nil</code> there, and check each
method/block on the call chain which must delegate keywords is correctly marked
as <code>ruby2_keywords</code>. [<a href="https://bugs.ruby-lang.org/issues/18625">Bug #18625</a>] [<a href="https://bugs.ruby-lang.org/issues/16466">Bug #16466</a>]</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_target'>target</span>(<span class='op'>**</span><span class='id identifier rubyid_kw'>kw</span>)
<span class='kw'>end</span>

<span class='comment'># Accidentally worked without ruby2_keywords in Ruby 2.7-3.1, ruby2_keywords
</span><span class='comment'># needed in 3.2+. Just like (*args, **kwargs) or (...) would be needed on
</span><span class='comment'># both #foo and #bar when migrating away from ruby2_keywords.
</span><span class='id identifier rubyid_ruby2_keywords'>ruby2_keywords</span> <span class='kw'>def</span> <span class='id identifier rubyid_bar'>bar</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='id identifier rubyid_target'>target</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
<span class='kw'>end</span>

<span class='id identifier rubyid_ruby2_keywords'>ruby2_keywords</span> <span class='kw'>def</span> <span class='id identifier rubyid_foo'>foo</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='id identifier rubyid_bar'>bar</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
<span class='kw'>end</span>

<span class='id identifier rubyid_foo'>foo</span>(<span class='label'>k:</span> <span class='int'>1</span>)</code></pre></li>
</ul>

<h2>Core classes updates</h2>

<p>Note: We&#39;re only listing outstanding class updates.</p>

<ul>
<li><p>Fiber</p>

<ul>
<li><p>Introduce Fiber.[] and Fiber.[]= for inheritable fiber storage.
Introduce Fiber#storage and Fiber#storage= (experimental) for
getting and resetting the current storage.  Introduce
<code>Fiber.new(storage:)</code> for setting the storage when creating a
fiber. [<a href="https://bugs.ruby-lang.org/issues/19078">Feature #19078</a>]</p>

<p>Existing Thread and Fiber local variables can be tricky to use.
Thread-local variables are shared between all fibers, making it
hard to isolate, while Fiber-local variables can be hard to
share.  It is often desirable to define unit of execution
(&quot;execution context&quot;) such that some state is shared between all
fibers and threads created in that context.  This is what Fiber
storage provides.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_log'>log</span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>Fiber</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_request_id'>request_id</span>]<span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_requests'>handle_requests</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_request'>request</span> <span class='op'>=</span> <span class='id identifier rubyid_read_request'>read_request</span>
    <span class='const'>Fiber</span>.<span class='id identifier rubyid_schedule'>schedule</span> <span class='kw'>do</span>
      <span class='const'>Fiber</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_request_id'>request_id</span>] <span class='op'>=</span> <span class='const'>SecureRandom</span>.<span class='id identifier rubyid_uuid'>uuid</span>

      <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_messages'>messages</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_message'>message</span><span class='op'>|</span>
        <span class='const'>Fiber</span>.<span class='id identifier rubyid_schedule'>schedule</span> <span class='kw'>do</span>
          <span class='id identifier rubyid_log'>log</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Handling </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># Log includes inherited request_id.
</span>        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>You should generally consider Fiber storage for any state which
you want to be shared implicitly between all fibers and threads
created in a given context, e.g. a connection pool, a request
id, a logger level, environment variables, configuration, etc.</p></li>
</ul></li>
<li><p>Fiber::Scheduler</p>

<ul>
<li>Introduce <code>Fiber::Scheduler#io_select</code> for non-blocking IO.select.
[<a href="https://bugs.ruby-lang.org/issues/19060">Feature #19060</a>]</li>
</ul></li>
<li><p>IO</p>

<ul>
<li><p>Introduce IO#timeout= and IO#timeout which can cause
IO::TimeoutError to be raised if a blocking operation exceeds the
specified timeout. [<a href="https://bugs.ruby-lang.org/issues/18630">Feature #18630</a>]</p>

<pre class="code ruby"><code class="ruby"><span class='const'>STDIN</span>.<span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>1</span>
<span class='const'>STDIN</span>.<span class='id identifier rubyid_read'>read</span> <span class='comment'># =&gt; Blocking operation timed out! (IO::TimeoutError)</span></code></pre></li>
<li><p>Introduce <code>IO.new(..., path:)</code> and promote <code>File#path</code> to <code>IO#path</code>.
[<a href="https://bugs.ruby-lang.org/issues/19036">Feature #19036</a>]</p></li>
</ul></li>
<li><p>Class</p>

<ul>
<li><p>Class#attached_object, which returns the object for which
the receiver is the singleton class. Raises TypeError if the
receiver is not a singleton class.
[<a href="https://bugs.ruby-lang.org/issues/12084">Feature #12084</a>]</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Foo</span><span class='semicolon'>;</span> <span class='kw'>end</span>

<span class='const'>Foo</span>.<span class='id identifier rubyid_singleton_class'>singleton_class</span>.<span class='id identifier rubyid_attached_object'>attached_object</span>        <span class='comment'>#=&gt; Foo
</span><span class='const'>Foo</span>.<span class='id identifier rubyid_new'>new</span>.<span class='id identifier rubyid_singleton_class'>singleton_class</span>.<span class='id identifier rubyid_attached_object'>attached_object</span>    <span class='comment'>#=&gt; #&lt;Foo:0x000000010491a370&gt;
</span><span class='const'>Foo</span>.<span class='id identifier rubyid_attached_object'>attached_object</span>                        <span class='comment'>#=&gt; TypeError: `Foo&#39; is not a singleton class
</span><span class='kw'>nil</span>.<span class='id identifier rubyid_singleton_class'>singleton_class</span>.<span class='id identifier rubyid_attached_object'>attached_object</span>        <span class='comment'>#=&gt; TypeError: `NilClass&#39; is not a singleton class</span></code></pre></li>
</ul></li>
<li><p>Data</p>

<ul>
<li><p>New core class to represent simple immutable value object. The class is
similar to Struct and partially shares an implementation, but has more
lean and strict API. [<a href="https://bugs.ruby-lang.org/issues/16122">Feature #16122</a>]</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Measure</span> <span class='op'>=</span> <span class='const'>Data</span>.<span class='id identifier rubyid_define'>define</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unit'>unit</span>)
<span class='id identifier rubyid_distance'>distance</span> <span class='op'>=</span> <span class='const'>Measure</span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>100</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>km</span><span class='tstring_end'>&#39;</span></span>)            <span class='comment'>#=&gt; #&lt;data Measure amount=100, unit=&quot;km&quot;&gt;
</span><span class='id identifier rubyid_weight'>weight</span> <span class='op'>=</span> <span class='const'>Measure</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>amount:</span> <span class='int'>50</span><span class='comma'>,</span> <span class='label'>unit:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>kg</span><span class='tstring_end'>&#39;</span></span>) <span class='comment'>#=&gt; #&lt;data Measure amount=50, unit=&quot;kg&quot;&gt;
</span><span class='id identifier rubyid_weight'>weight</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>amount:</span> <span class='int'>40</span>)                      <span class='comment'>#=&gt; #&lt;data Measure amount=40, unit=&quot;kg&quot;&gt;
</span><span class='id identifier rubyid_weight'>weight</span>.<span class='id identifier rubyid_amount'>amount</span>                                <span class='comment'>#=&gt; 50
</span><span class='id identifier rubyid_weight'>weight</span>.<span class='id identifier rubyid_amount'>amount</span> <span class='op'>=</span> <span class='int'>40</span>                           <span class='comment'>#=&gt; NoMethodError: undefined method `amount=&#39;</span></code></pre></li>
</ul></li>
<li><p>Encoding</p>

<ul>
<li>Encoding#replicate has been deprecated and will be removed in 3.3. [<a href="https://bugs.ruby-lang.org/issues/18949">Feature #18949</a>]</li>
<li>The dummy <code>Encoding::UTF_16</code> and <code>Encoding::UTF_32</code> encodings no longer
try to dynamically guess the endian based on a byte order mark.
Use <code>Encoding::UTF_16BE</code>/<code>UTF_16LE</code> and <code>Encoding::UTF_32BE</code>/<code>UTF_32LE</code> instead.
This change speeds up getting the encoding of a String. [<a href="https://bugs.ruby-lang.org/issues/18949">Feature #18949</a>]</li>
<li>Limit maximum encoding set size by 256.
If exceeding maximum size, <code>EncodingError</code> will be raised. [<a href="https://bugs.ruby-lang.org/issues/18949">Feature #18949</a>]</li>
</ul></li>
<li><p>Enumerator</p>

<ul>
<li>Enumerator.product has been added.  Enumerator::Product is the implementation. [<a href="https://bugs.ruby-lang.org/issues/18685">Feature #18685</a>]</li>
</ul></li>
<li><p>Exception</p>

<ul>
<li>Exception#detailed_message has been added.
The default error printer calls this method on the Exception object
instead of #message. [<a href="https://bugs.ruby-lang.org/issues/18564">Feature #18564</a>]</li>
</ul></li>
<li><p>Hash</p>

<ul>
<li>Hash#shift now always returns nil if the hash is
empty, instead of returning the default value or
calling the default proc. [<a href="https://bugs.ruby-lang.org/issues/16908">Bug #16908</a>]</li>
</ul></li>
<li><p>Integer</p>

<ul>
<li>Integer#ceildiv has been added. [<a href="https://bugs.ruby-lang.org/issues/18809">Feature #18809</a>]</li>
</ul></li>
<li><p>Kernel</p>

<ul>
<li>Kernel#binding raises RuntimeError if called from a non-Ruby frame
(such as a method defined in C). [<a href="https://bugs.ruby-lang.org/issues/18487">Bug #18487</a>]</li>
</ul></li>
<li><p>MatchData</p>

<ul>
<li>MatchData#byteoffset has been added. [<a href="https://bugs.ruby-lang.org/issues/13110">Feature #13110</a>]</li>
<li>MatchData#deconstruct has been added. [<a href="https://bugs.ruby-lang.org/issues/18821">Feature #18821</a>]</li>
<li>MatchData#deconstruct_keys has been added. [<a href="https://bugs.ruby-lang.org/issues/18821">Feature #18821</a>]</li>
</ul></li>
<li><p>Module</p>

<ul>
<li>Module.used_refinements has been added. [<a href="https://bugs.ruby-lang.org/issues/14332">Feature #14332</a>]</li>
<li>Module#refinements has been added. [<a href="https://bugs.ruby-lang.org/issues/12737">Feature #12737</a>]</li>
<li>Module#const_added has been added. [<a href="https://bugs.ruby-lang.org/issues/17881">Feature #17881</a>]</li>
<li>Module#undefined_instance_methods has been added. [<a href="https://bugs.ruby-lang.org/issues/12655">Feature #12655</a>]</li>
</ul></li>
<li><p>Proc</p>

<ul>
<li>Proc#dup returns an instance of subclass. [<a href="https://bugs.ruby-lang.org/issues/17545">Bug #17545</a>]</li>
<li>Proc#parameters now accepts lambda keyword. [<a href="https://bugs.ruby-lang.org/issues/15357">Feature #15357</a>]</li>
</ul></li>
<li><p>Process</p>

<ul>
<li>Added <code>RLIMIT_NPTS</code> constant to FreeBSD platform</li>
</ul></li>
<li><p>Regexp</p>

<ul>
<li>The cache-based optimization is introduced.
Many (but not all) Regexp matching is now in linear time, which
will prevent regular expression denial of service (ReDoS)
vulnerability. [<a href="https://bugs.ruby-lang.org/issues/19104">Feature #19104</a>]</li>
<li>Regexp.linear_time? is introduced. [<a href="https://bugs.ruby-lang.org/issues/19194">Feature #19194</a>]</li>
<li>Regexp.new now supports passing the regexp flags not only as an Integer,
but also as a String.  Unknown flags raise ArgumentError.
Otherwise, anything other than <code>true</code>, <code>false</code>, <code>nil</code> or Integer will be warned.
[<a href="https://bugs.ruby-lang.org/issues/18788">Feature #18788</a>]</li>
<li>Regexp.timeout= has been added. Also, Regexp.new new supports timeout keyword.
See [<a href="https://bugs.ruby-lang.org/issues/17837">Feature #17837</a>]</li>
</ul></li>
<li><p>Refinement</p>

<ul>
<li>Refinement#refined_class has been added. [<a href="https://bugs.ruby-lang.org/issues/12737">Feature #12737</a>]</li>
</ul></li>
<li><p>RubyVM::AbstractSyntaxTree</p>

<ul>
<li>Add <code>error_tolerant</code> option for <code>parse</code>, <code>parse_file</code> and <code>of</code>. [<a href="https://bugs.ruby-lang.org/issues/19013">Feature #19013</a>]
With this option</li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='int'>1</span>. <span class='const'>SyntaxError</span> <span class='id identifier rubyid_is'>is</span> <span class='id identifier rubyid_suppressed'>suppressed</span>
<span class='int'>2</span>. <span class='const'>AST</span> <span class='id identifier rubyid_is'>is</span> <span class='id identifier rubyid_returned'>returned</span> <span class='kw'>for</span> <span class='id identifier rubyid_invalid'>invalid</span> <span class='id identifier rubyid_input'>input</span>
<span class='int'>3</span>. <span class='backtick'>`</span><span class='kw'>end</span><span class='backtick'>`</span><span class='tstring_content'> is complemented when a parser reaches to the end of input but </span><span class='tstring_end'>`</span></span><span class='kw'>end</span><span class='backtick'>`</span><span class='tstring_content'> is insufficient
4. </span><span class='tstring_end'>`</span></span><span class='kw'>end</span><span class='backtick'>`</span><span class='tstring_content'> is treated as keyword based on indent

</span><span class='tstring_end'>`</span></span><span class='backtick'>`</span><span class='tstring_end'>`</span></span><span class='id identifier rubyid_ruby'>ruby</span>
<span class='comment'># Without error_tolerant option
</span><span class='id identifier rubyid_root'>root</span> <span class='op'>=</span> <span class='const'>RubyVM</span><span class='op'>::</span><span class='const'>AbstractSyntaxTree</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='heredoc_beg'>&lt;&lt;~RUBY</span>)
<span class='tstring_content'>def m
  a = 10
  if
end
</span><span class='heredoc_end'>RUBY
</span><span class='comment'># =&gt; &lt;internal:ast&gt;:33:in `parse&#39;: syntax error, unexpected `end&#39; (SyntaxError)
</span>
<span class='comment'># With error_tolerant option
</span><span class='id identifier rubyid_root'>root</span> <span class='op'>=</span> <span class='const'>RubyVM</span><span class='op'>::</span><span class='const'>AbstractSyntaxTree</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='heredoc_beg'>&lt;&lt;~RUBY</span><span class='comma'>,</span> <span class='label'>error_tolerant:</span> <span class='kw'>true</span>)
<span class='tstring_content'>def m
  a = 10
  if
end
</span><span class='heredoc_end'>RUBY
</span><span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_root'>root</span> <span class='comment'># =&gt; #&lt;RubyVM::AbstractSyntaxTree::Node:SCOPE@1:0-4:3&gt;
</span>
<span class='comment'># `end` is treated as keyword based on indent
</span><span class='id identifier rubyid_root'>root</span> <span class='op'>=</span> <span class='const'>RubyVM</span><span class='op'>::</span><span class='const'>AbstractSyntaxTree</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='heredoc_beg'>&lt;&lt;~RUBY</span><span class='comma'>,</span> <span class='label'>error_tolerant:</span> <span class='kw'>true</span>)
<span class='tstring_content'>module Z
  class Foo
    foo.
  end

  def bar
  end
end
</span><span class='heredoc_end'>RUBY
</span><span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_root'>root</span>.<span class='id identifier rubyid_children'>children</span>[<span class='op'>-</span><span class='int'>1</span>].<span class='id identifier rubyid_children'>children</span>[<span class='op'>-</span><span class='int'>1</span>].<span class='id identifier rubyid_children'>children</span>[<span class='op'>-</span><span class='int'>1</span>].<span class='id identifier rubyid_children'>children</span>[<span class='op'>-</span><span class='int'>2</span><span class='op'>..</span><span class='op'>-</span><span class='int'>1</span>]
<span class='comment'># =&gt; [#&lt;RubyVM::AbstractSyntaxTree::Node:CLASS@2:2-4:5&gt;, #&lt;RubyVM::AbstractSyntaxTree::Node:DEFN@6:2-7:5&gt;]
</span><span class='backtick'>`</span><span class='tstring_end'>`</span></span><span class='backtick'>`</span></code></pre>

<ul>
<li><p>Add <code>keep_tokens</code> option for <code>parse</code>, <code>parse_file</code> and <code>of</code>. Add <code>#tokens</code> and <code>#all_tokens</code>
for RubyVM::AbstractSyntaxTree::Node [<a href="https://bugs.ruby-lang.org/issues/19070">Feature #19070</a>]</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_root'>root</span> <span class='op'>=</span> <span class='const'>RubyVM</span><span class='op'>::</span><span class='const'>AbstractSyntaxTree</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>x = 1 + 2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>keep_tokens:</span> <span class='kw'>true</span>)
<span class='id identifier rubyid_root'>root</span>.<span class='id identifier rubyid_tokens'>tokens</span> <span class='comment'># =&gt; [[0, :tIDENTIFIER, &quot;x&quot;, [1, 0, 1, 1]], [1, :tSP, &quot; &quot;, [1, 1, 1, 2]], ...]
</span><span class='id identifier rubyid_root'>root</span>.<span class='id identifier rubyid_tokens'>tokens</span>.<span class='id identifier rubyid_map'>map</span>{<span class='id identifier rubyid__1'>_1</span>[<span class='int'>2</span>]}.<span class='id identifier rubyid_join'>join</span> <span class='comment'># =&gt; &quot;x = 1 + 2&quot;</span></code></pre></li>
</ul></li>
<li><p>Set</p>

<ul>
<li>Set is now available as a built-in class without the need for <code>require &quot;set&quot;</code>. [<a href="https://bugs.ruby-lang.org/issues/16989">Feature #16989</a>]
It is currently autoloaded via the Set constant or a call to Enumerable#to_set.</li>
</ul></li>
<li><p>String</p>

<ul>
<li>String#byteindex and String#byterindex have been added. [<a href="https://bugs.ruby-lang.org/issues/13110">Feature #13110</a>]</li>
<li>Update Unicode to Version 15.0.0 and Emoji Version 15.0. <a href="also%20applies%20to%20Regexp"><a href="https://bugs.ruby-lang.org/issues/18639">Feature #18639</a></a></li>
<li>String#bytesplice has been added.  [<a href="https://bugs.ruby-lang.org/issues/18598">Feature #18598</a>]</li>
<li>String#dedup has been added as an alias to String#<a href="mailto:-@">-@</a>.  [<a href="https://bugs.ruby-lang.org/issues/18595">Feature #18595</a>]</li>
</ul></li>
<li><p>Struct</p>

<ul>
<li><p>A Struct class can also be initialized with keyword arguments
without <code>keyword_init: true</code> on Struct.new [<a href="https://bugs.ruby-lang.org/issues/16806">Feature #16806</a>]</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span> <span class='op'>=</span> <span class='const'>Struct</span>.<span class='id identifier rubyid_new'>new</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>)
<span class='const'>Post</span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>1</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'>#=&gt; #&lt;struct Post id=1, name=&quot;hello&quot;&gt;
</span><span class='comment'># From Ruby 3.2, the following code also works without keyword_init: true.
</span><span class='const'>Post</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>id:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'>#=&gt; #&lt;struct Post id=1, name=&quot;hello&quot;&gt;</span></code></pre></li>
</ul></li>
<li><p>Thread</p>

<ul>
<li>Thread.each_caller_location is added. [<a href="https://bugs.ruby-lang.org/issues/16663">Feature #16663</a>]</li>
</ul></li>
<li><p>Thread::Queue</p>

<ul>
<li>Thread::Queue#pop(timeout: sec) is added. [<a href="https://bugs.ruby-lang.org/issues/18774">Feature #18774</a>]</li>
</ul></li>
<li><p>Thread::SizedQueue</p>

<ul>
<li>Thread::SizedQueue#pop(timeout: sec) is added. [<a href="https://bugs.ruby-lang.org/issues/18774">Feature #18774</a>]</li>
<li>Thread::SizedQueue#push(timeout: sec) is added. [<a href="https://bugs.ruby-lang.org/issues/18944">Feature #18944</a>]</li>
</ul></li>
<li><p>Time</p>

<ul>
<li>Time#deconstruct_keys is added, allowing to use Time instances
in pattern-matching expressions [<a href="https://bugs.ruby-lang.org/issues/19071">Feature #19071</a>]</li>
<li>Time.new now can parse a string like generated by Time#inspect
and return a Time instance based on the given argument.
[<a href="https://bugs.ruby-lang.org/issues/18033">Feature #18033</a>]</li>
</ul></li>
<li><p>SyntaxError</p>

<ul>
<li>SyntaxError#path has been added.  [<a href="https://bugs.ruby-lang.org/issues/19138">Feature #19138</a>]</li>
</ul></li>
<li><p>TracePoint</p>

<ul>
<li>TracePoint#binding now returns <code>nil</code> for <code>c_call</code>/<code>c_return</code> TracePoints.
[<a href="https://bugs.ruby-lang.org/issues/18487">Bug #18487</a>]</li>
<li>TracePoint#enable <code>target_thread</code> keyword argument now defaults to the
current thread if a block is given and <code>target</code> and <code>target_line</code> keyword
arguments are not passed. [<a href="https://bugs.ruby-lang.org/issues/16889">Bug #16889</a>]</li>
</ul></li>
<li><p>UnboundMethod</p>

<ul>
<li><code>UnboundMethod#==</code> returns <code>true</code> if the actual method is same. For example,
<code>String.instance_method(:object_id) == Array.instance_method(:object_id)</code>
returns <code>true</code>. [<a href="https://bugs.ruby-lang.org/issues/18798">Feature #18798</a>]</li>
<li><code>UnboundMethod#inspect</code> does not show the receiver of <code>instance_method</code>.
For example <code>String.instance_method(:object_id).inspect</code> returns
<code>&quot;#&lt;UnboundMethod: Kernel#object_id()&gt;&quot;</code>
(was <code>&quot;#&lt;UnboundMethod: String(Kernel)#object_id()&gt;&quot;</code>).</li>
</ul></li>
<li><p>GC</p>

<ul>
<li>Expose <code>need_major_gc</code> via <code>GC.latest_gc_info</code>. <a href="https://github.com/ruby/ruby/pull/6791">GH-6791</a></li>
</ul></li>
<li><p>ObjectSpace</p>

<ul>
<li><code>ObjectSpace.dump_all</code> dump shapes as well. <a href="https://github.com/ruby/ruby/pull/6868">GH-6868</a></li>
</ul></li>
</ul>

<h2>Stdlib updates</h2>

<ul>
<li><p>Bundler</p>

<ul>
<li>Bundler now uses <a href="https://github.com/jhawthorn/pub_grub">PubGrub</a> resolver instead of <a href="https://github.com/CocoaPods/Molinillo">Molinillo</a> for performance improvement.</li>
<li>Add --ext=rust support to bundle gem for creating simple gems with Rust extensions.
[<a href="https://github.com/rubygems/rubygems/pull/6149">GH-rubygems-6149</a>]</li>
<li>Make cloning git repos faster [<a href="https://github.com/rubygems/rubygems/pull/4475">GH-rubygems-4475</a>]</li>
</ul></li>
<li><p>RubyGems</p>

<ul>
<li>Add mswin support for cargo builder. [<a href="https://github.com/rubygems/rubygems/pull/6167">GH-rubygems-6167</a>]</li>
</ul></li>
<li><p>CGI</p>

<ul>
<li><code>CGI.escapeURIComponent</code> and <code>CGI.unescapeURIComponent</code> are added.
[<a href="https://bugs.ruby-lang.org/issues/18822">Feature #18822</a>]</li>
</ul></li>
<li><p>Coverage</p>

<ul>
<li><code>Coverage.setup</code> now accepts <code>eval: true</code>. By this, <code>eval</code> and related methods are
able to generate code coverage. [<a href="https://bugs.ruby-lang.org/issues/19008">Feature #19008</a>]</li>
<li><code>Coverage.supported?(mode)</code> enables detection of what coverage modes are
supported. [<a href="https://bugs.ruby-lang.org/issues/19026">Feature #19026</a>]</li>
</ul></li>
<li><p>Date</p>

<ul>
<li>Added <code>Date#deconstruct_keys</code> and <code>DateTime#deconstruct_keys</code> same as [<a href="https://bugs.ruby-lang.org/issues/19071">Feature #19071</a>]</li>
</ul></li>
<li><p>ERB</p>

<ul>
<li><code>ERB::Util.html_escape</code> is made faster than <code>CGI.escapeHTML</code>.

<ul>
<li>It no longer allocates a String object when no character needs to be escaped.</li>
<li>It skips calling <code>#to_s</code> method when an argument is already a String.</li>
<li><code>ERB::Escape.html_escape</code> is added as an alias to <code>ERB::Util.html_escape</code>,
which has not been monkey-patched by Rails.</li>
</ul></li>
<li><code>ERB::Util.url_encode</code> is made faster using <code>CGI.escapeURIComponent</code>.</li>
<li><code>-S</code> option is removed from <code>erb</code> command.</li>
</ul></li>
<li><p>FileUtils</p>

<ul>
<li>Add FileUtils.ln_sr method and <code>relative:</code> option to FileUtils.ln_s.
[<a href="https://bugs.ruby-lang.org/issues/18925">Feature #18925</a>]</li>
</ul></li>
<li><p>IRB</p>

<ul>
<li>debug.gem integration commands have been added: <code>debug</code>, <code>break</code>, <code>catch</code>,
<code>next</code>, <code>delete</code>, <code>step</code>, <code>continue</code>, <code>finish</code>, <code>backtrace</code>, <code>info</code>

<ul>
<li>They work even if you don&#39;t have <code>gem &quot;debug&quot;</code> in your Gemfile.</li>
<li>See also: <a href="https://st0012.dev/whats-new-in-ruby-3-2-irb">What&#39;s new in Ruby 3.2&#39;s IRB?</a></li>
</ul></li>
<li>More Pry-like commands and features have been added.

<ul>
<li><code>edit</code> and <code>show_cmds</code> (like Pry&#39;s <code>help</code>) are added.</li>
<li><code>ls</code> takes <code>-g</code> or <code>-G</code> option to filter out outputs.</li>
<li><code>show_source</code> is aliased from <code>$</code> and accepts unquoted inputs.</li>
<li><code>whereami</code> is aliased from <code>@</code>.</li>
</ul></li>
</ul></li>
<li><p>Net::Protocol</p>

<ul>
<li>Improve <code>Net::BufferedIO</code> performance. [<a href="https://github.com/ruby/net-protocol/pull/14">GH-net-protocol-14</a>]</li>
</ul></li>
<li><p>Pathname</p>

<ul>
<li>Added <code>Pathname#lutime</code>. [<a href="https://github.com/ruby/pathname/pull/20">GH-pathname-20</a>]</li>
</ul></li>
<li><p>Socket</p>

<ul>
<li>Added the following constants for supported platforms.

<ul>
<li><code>SO_INCOMING_CPU</code></li>
<li><code>SO_INCOMING_NAPI_ID</code></li>
<li><code>SO_RTABLE</code></li>
<li><code>SO_SETFIB</code></li>
<li><code>SO_USER_COOKIE</code></li>
<li><code>TCP_KEEPALIVE</code></li>
<li><code>TCP_CONNECTION_INFO</code></li>
</ul></li>
</ul></li>
<li><p>SyntaxSuggest</p>

<ul>
<li>The feature of <code>syntax_suggest</code> formerly <code>dead_end</code> is integrated in Ruby.
[<a href="https://bugs.ruby-lang.org/issues/18159">Feature #18159</a>]</li>
</ul></li>
<li><p>UNIXSocket</p>

<ul>
<li>Add support for UNIXSocket on Windows. Emulate anonymous sockets. Add
support for File.socket? and File::Stat#socket? where possible.
[<a href="https://bugs.ruby-lang.org/issues/19135">Feature #19135</a>]</li>
</ul></li>
<li><p>The following default gems are updated.</p>

<ul>
<li>RubyGems 3.4.1</li>
<li>abbrev 0.1.1</li>
<li>benchmark 0.2.1</li>
<li>bigdecimal 3.1.3</li>
<li>bundler 2.4.1</li>
<li>cgi 0.3.6</li>
<li>csv 3.2.6</li>
<li>date 3.3.3</li>
<li>delegate 0.3.0</li>
<li>did_you_mean 1.6.3</li>
<li>digest 3.1.1</li>
<li>drb 2.1.1</li>
<li>english 0.7.2</li>
<li>erb 4.0.2</li>
<li>error_highlight 0.5.1</li>
<li>etc 1.4.2</li>
<li>fcntl 1.0.2</li>
<li>fiddle 1.1.1</li>
<li>fileutils 1.7.0</li>
<li>forwardable 1.3.3</li>
<li>getoptlong 0.2.0</li>
<li>io-console 0.6.0</li>
<li>io-nonblock 0.2.0</li>
<li>io-wait 0.3.0</li>
<li>ipaddr 1.2.5</li>
<li>irb 1.6.2</li>
<li>json 2.6.3</li>
<li>logger 1.5.3</li>
<li>mutex_m 0.1.2</li>
<li>net-http 0.4.0</li>
<li>net-protocol 0.2.1</li>
<li>nkf 0.1.2</li>
<li>open-uri 0.3.0</li>
<li>open3 0.1.2</li>
<li>openssl 3.1.0</li>
<li>optparse 0.3.1</li>
<li>ostruct 0.5.5</li>
<li>pathname 0.2.1</li>
<li>pp 0.4.0</li>
<li>pstore 0.1.2</li>
<li>psych 5.0.1</li>
<li>racc 1.6.2</li>
<li>rdoc 6.5.0</li>
<li>readline-ext 0.1.5</li>
<li>reline 0.3.2</li>
<li>resolv 0.2.2</li>
<li>resolv-replace 0.1.1</li>
<li>securerandom 0.2.2</li>
<li>set 1.0.3</li>
<li>stringio 3.0.4</li>
<li>strscan 3.0.5</li>
<li>syntax_suggest 1.0.2</li>
<li>syslog 0.1.1</li>
<li>tempfile 0.1.3</li>
<li>time 0.2.1</li>
<li>timeout 0.3.1</li>
<li>tmpdir 0.1.3</li>
<li>tsort 0.1.1</li>
<li>un 0.2.1</li>
<li>uri 0.12.0</li>
<li>weakref 0.1.2</li>
<li>win32ole 1.8.9</li>
<li>yaml 0.2.1</li>
<li>zlib 3.0.0</li>
</ul></li>
<li><p>The following bundled gems are updated.</p>

<ul>
<li>minitest 5.16.3</li>
<li>power_assert 2.0.3</li>
<li>test-unit 3.5.7</li>
<li>net-ftp 0.2.0</li>
<li>net-imap 0.3.4</li>
<li>net-pop 0.1.2</li>
<li>net-smtp 0.3.3</li>
<li>rbs 2.8.2</li>
<li>typeprof 0.21.3</li>
<li>debug 1.7.1</li>
</ul></li>
</ul>

<p>See GitHub releases like <a href="https://github.com/ruby/logger/releases">GitHub Releases of Logger</a> or changelog for details of the default gems or bundled gems.</p>

<h2>Supported platforms</h2>

<ul>
<li>WebAssembly/WASI is added. See <a href="https://github.com/ruby/ruby/blob/master/wasm/README.md">wasm/README.md</a> and <a href="https://github.com/ruby/ruby.wasm">ruby.wasm</a> for more details. [<a href="https://bugs.ruby-lang.org/issues/18462">Feature #18462</a>]</li>
</ul>

<h2>Compatibility issues</h2>

<ul>
<li><p><code>String#to_c</code> currently treat a sequence of underscores as an end of Complex
string. [<a href="https://bugs.ruby-lang.org/issues/19087">Bug #19087</a>]</p></li>
<li><p>Now <code>ENV.clone</code> raises <code>TypeError</code> as well as <code>ENV.dup</code> [<a href="https://bugs.ruby-lang.org/issues/17767">Bug #17767</a>]</p></li>
</ul>

<h3>Removed constants</h3>

<p>The following deprecated constants are removed.</p>

<ul>
<li><code>Fixnum</code> and <code>Bignum</code> [<a href="https://bugs.ruby-lang.org/issues/12005">Feature #12005</a>]</li>
<li><code>Random::DEFAULT</code> [<a href="https://bugs.ruby-lang.org/issues/17351">Feature #17351</a>]</li>
<li><code>Struct::Group</code></li>
<li><code>Struct::Passwd</code></li>
</ul>

<h3>Removed methods</h3>

<p>The following deprecated methods are removed.</p>

<ul>
<li><code>Dir.exists?</code> [<a href="https://bugs.ruby-lang.org/issues/17391">Feature #17391</a>]</li>
<li><code>File.exists?</code> [<a href="https://bugs.ruby-lang.org/issues/17391">Feature #17391</a>]</li>
<li><code>Kernel#=~</code> [<a href="https://bugs.ruby-lang.org/issues/15231">Feature #15231</a>]</li>
<li><code>Kernel#taint</code>, <code>Kernel#untaint</code>, <code>Kernel#tainted?</code>
[<a href="https://bugs.ruby-lang.org/issues/16131">Feature #16131</a>]</li>
<li><code>Kernel#trust</code>, <code>Kernel#untrust</code>, <code>Kernel#untrusted?</code>
[<a href="https://bugs.ruby-lang.org/issues/16131">Feature #16131</a>]</li>
<li><code>Method#public?</code>, <code>Method#private?</code>, <code>Method#protected?</code>,
<code>UnboundMethod#public?</code>, <code>UnboundMethod#private?</code>, <code>UnboundMethod#protected?</code>
[<a href="https://bugs.ruby-lang.org/issues/18729">Bug #18729</a>] [<a href="https://bugs.ruby-lang.org/issues/18751">Bug #18751</a>] [<a href="https://bugs.ruby-lang.org/issues/18435">Bug #18435</a>]</li>
</ul>

<h3>Source code incompatibility of extension libraries</h3>

<ul>
<li>Extension libraries provide PRNG, subclasses of Random, need updates.
See [PRNG update] below for more information. [<a href="https://bugs.ruby-lang.org/issues/19100">Bug #19100</a>]</li>
</ul>

<h3>Error printer</h3>

<ul>
<li>Ruby no longer escapes control characters and backslashes in an
error message. [<a href="https://bugs.ruby-lang.org/issues/18367">Feature #18367</a>]</li>
</ul>

<h3>Constant lookup when defining a class/module</h3>

<ul>
<li>When defining a class/module directly under the Object class by class/module
statement, if there is already a class/module defined by <code>Module#include</code>
with the same name, the statement was handled as &quot;open class&quot; in Ruby 3.1 or before.
Since Ruby 3.2, a new class is defined instead. [<a href="https://bugs.ruby-lang.org/issues/18832">Feature #18832</a>]</li>
</ul>

<h2>Stdlib compatibility issues</h2>

<ul>
<li><p>Psych no longer bundles libyaml sources.
And also Fiddle no longer bundles libffi sources.
Users need to install the libyaml/libffi library themselves via the package
manager like apt, yum, brew, etc.</p>

<p>Psych and fiddle supported the static build with specific version of libyaml
and libffi sources. You can build psych with libyaml-0.2.5 like this.</p>

<pre class="code bash"><code class="bash">$ ./configure --with-libyaml-source-dir=/path/to/libyaml-0.2.5
</code></pre>

<p>And you can build fiddle with libffi-3.4.4 like this.</p>

<pre class="code bash"><code class="bash">$ ./configure --with-libffi-source-dir=/path/to/libffi-3.4.4
</code></pre>

<p>[<a href="https://bugs.ruby-lang.org/issues/18571">Feature #18571</a>]</p></li>
<li><p>Check cookie name/path/domain characters in <code>CGI::Cookie</code>. [<a href="https://www.ruby-lang.org/en/news/2022/11/22/http-response-splitting-in-cgi-cve-2021-33621/">CVE-2021-33621</a>]</p></li>
<li><p><code>URI.parse</code> return empty string in host instead of nil. [<a href="https://hackerone.com/reports/156615">sec-156615</a>]</p></li>
</ul>

<h2>C API updates</h2>

<h3>Updated C APIs</h3>

<p>The following APIs are updated.</p>

<ul>
<li><p>PRNG update</p>

<p><code>rb_random_interface_t</code> in ruby/random.h updated and versioned.
Extension libraries which use this interface and built for older
versions need to rebuild with adding <code>init_int32</code> function.</p></li>
</ul>

<h3>Added C APIs</h3>

<ul>
<li><code>VALUE rb_hash_new_capa(long capa)</code> was added to created hashes with the desired capacity.</li>
<li><code>rb_internal_thread_add_event_hook</code> and <code>rb_internal_thread_add_event_hook</code> were added to instrument threads scheduling.
The following events are available:

<ul>
<li><code>RUBY_INTERNAL_THREAD_EVENT_STARTED</code></li>
<li><code>RUBY_INTERNAL_THREAD_EVENT_READY</code></li>
<li><code>RUBY_INTERNAL_THREAD_EVENT_RESUMED</code></li>
<li><code>RUBY_INTERNAL_THREAD_EVENT_SUSPENDED</code></li>
<li><code>RUBY_INTERNAL_THREAD_EVENT_EXITED</code></li>
</ul></li>
<li><code>rb_debug_inspector_current_depth</code> and <code>rb_debug_inspector_frame_depth</code> are added for debuggers.</li>
</ul>

<h3>Removed C APIs</h3>

<p>The following deprecated APIs are removed.</p>

<ul>
<li><code>rb_cData</code> variable.</li>
<li>&quot;taintedness&quot; and &quot;trustedness&quot; functions. [<a href="https://bugs.ruby-lang.org/issues/16131">Feature #16131</a>]</li>
</ul>

<h2>Implementation improvements</h2>

<ul>
<li>Fixed several race conditions in Kernel#autoload. [<a href="https://bugs.ruby-lang.org/issues/18782">Bug #18782</a>]</li>
<li>Cache invalidation for expressions referencing constants is now
more fine-grained. <code>RubyVM.stat(:global_constant_state)</code> was
removed because it was closely tied to the previous caching scheme
where setting any constant invalidates all caches in the system.
New keys, <code>:constant_cache_invalidations</code> and <code>:constant_cache_misses</code>,
were introduced to help with use cases for <code>:global_constant_state</code>.
[<a href="https://bugs.ruby-lang.org/issues/18589">Feature #18589</a>]</li>
<li>The cache-based optimization for Regexp matching is introduced.
[<a href="https://bugs.ruby-lang.org/issues/19104">Feature #19104</a>]</li>
<li><a href="https://shopify.engineering/ruby-variable-width-allocation">Variable Width Allocation</a>
is now enabled by default. [<a href="https://bugs.ruby-lang.org/issues/18239#note-17">Feature #18239</a>]</li>
<li>Added a new instance variable caching mechanism, called object shapes, which
improves inline cache hits for most objects and allows us to generate very
efficient JIT code. Objects whose instance variables are defined in a
consistent order will see the most performance benefits.
[<a href="https://bugs.ruby-lang.org/issues/18776">Feature #18776</a>]</li>
<li>Speed up marking instruction sequences by using a bitmap to find &quot;markable&quot;
objects.  This change results in faster major collections.
[<a href="https://bugs.ruby-lang.org/issues/18875">Feature #18875</a>]</li>
</ul>

<h2>JIT</h2>

<h3>YJIT</h3>

<ul>
<li>YJIT is no longer experimental

<ul>
<li>Has been tested on production workloads for over a year and proven to be quite stable.</li>
</ul></li>
<li>YJIT now supports both x86-64 and arm64/aarch64 CPUs on Linux, MacOS, BSD and other UNIX platforms.

<ul>
<li>This release brings support for Mac M1/M2, AWS Graviton and Raspberry Pi 4.</li>
</ul></li>
<li>Building YJIT now requires Rust 1.58.0+. [<a href="https://bugs.ruby-lang.org/issues/18481">Feature #18481</a>]

<ul>
<li>In order to ensure that CRuby is built with YJIT, please install <code>rustc</code> &gt;= 1.58.0
before running <code>./configure</code></li>
<li>Please reach out to the YJIT team should you run into any issues.</li>
</ul></li>
<li>Physical memory for JIT code is lazily allocated. Unlike Ruby 3.1,
the RSS of a Ruby process is minimized because virtual memory pages
allocated by <code>--yjit-exec-mem-size</code> will not be mapped to physical
memory pages until actually utilized by JIT code.</li>
<li>Introduce Code GC that frees all code pages when the memory consumption
by JIT code reaches <code>--yjit-exec-mem-size</code>.

<ul>
<li><code>RubyVM::YJIT.runtime_stats</code> returns Code GC metrics in addition to
existing <code>inline_code_size</code> and <code>outlined_code_size</code> keys:
<code>code_gc_count</code>, <code>live_page_count</code>, <code>freed_page_count</code>, and <code>freed_code_size</code>.</li>
</ul></li>
<li>Most of the statistics produced by <code>RubyVM::YJIT.runtime_stats</code> are now available in release builds.

<ul>
<li>Simply run ruby with <code>--yjit-stats</code> to compute and dump stats (incurs some run-time overhead).</li>
</ul></li>
<li>YJIT is now optimized to take advantage of object shapes. [<a href="https://bugs.ruby-lang.org/issues/18776">Feature #18776</a>]</li>
<li>Take advantage of finer-grained constant invalidation to invalidate less code when defining new constants. [<a href="https://bugs.ruby-lang.org/issues/18589">Feature #18589</a>]</li>
<li>The default <code>--yjit-exec-mem-size</code> is changed to 64 (MiB).</li>
<li>The default <code>--yjit-call-threshold</code> is changed to 30.</li>
</ul>

<h3>MJIT</h3>

<ul>
<li>The MJIT compiler is re-implemented in Ruby as <code>ruby_vm/mjit/compiler</code>.</li>
<li>MJIT compiler is executed under a forked Ruby process instead of
doing it in a native thread called MJIT worker. [<a href="https://bugs.ruby-lang.org/issues/18968">Feature #18968</a>]

<ul>
<li>As a result, Microsoft Visual Studio (MSWIN) is no longer supported.</li>
</ul></li>
<li>MinGW is no longer supported. [<a href="https://bugs.ruby-lang.org/issues/18824">Feature #18824</a>]</li>
<li>Rename <code>--mjit-min-calls</code> to <code>--mjit-call-threshold</code>.</li>
<li>Change default <code>--mjit-max-cache</code> back from 10000 to 100.</li>
</ul>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>