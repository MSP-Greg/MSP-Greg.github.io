<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: RubyVM::MJIT::Compiler &mdash; ruby_vm  Ruby-3.2.9 p265</title>

<link rel='stylesheet'  type='text/css' href='../../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "RubyVM::MJIT::Compiler",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../../'>Ruby-3.2.9</a> &raquo; 
      <a href='../../'>ruby_vm</a> &raquo; 
      <a href='../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        RubyVM &raquo; 
        MJIT &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>Compiler&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: RubyVM::MJIT::Compiler</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This class is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L16'>lib/ruby_vm/mjit/compiler.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Available variables and macros in JIT-ed function:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_ec'>ec</span><span class='op'>:</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_first'>first</span> <span class='id identifier rubyid_argument'>argument</span> <span class='id identifier rubyid_of'>of</span> <span class='id identifier rubyid__mjitXXX'>_mjitXXX</span>
<span class='id identifier rubyid_reg_cfp'>reg_cfp</span><span class='op'>:</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_second'>second</span> <span class='id identifier rubyid_argument'>argument</span> <span class='id identifier rubyid_of'>of</span> <span class='id identifier rubyid__mjitXXX'>_mjitXXX</span>
<span class='const'>GET_CFP</span>()<span class='op'>:</span> <span class='id identifier rubyid_refers'>refers</span> <span class='id identifier rubyid_to'>to</span> {<span class='id identifier rubyid_reg_cfp'>reg_cfp</span>}
<span class='const'>GET_EP</span>()<span class='op'>:</span> <span class='id identifier rubyid_refers'>refers</span> <span class='id identifier rubyid_to'>to</span> {<span class='id identifier rubyid_reg_cfp'>reg_cfp</span><span class='tlambda'>-&gt;</span><span class='id identifier rubyid_ep'>ep</span>}
<span class='const'>GET_SP</span>()<span class='op'>:</span> <span class='id identifier rubyid_refers'>refers</span> <span class='id identifier rubyid_to'>to</span> {<span class='id identifier rubyid_reg_cfp'>reg_cfp</span><span class='tlambda'>-&gt;</span><span class='id identifier rubyid_sp'>sp</span>}<span class='comma'>,</span> <span class='kw'>or</span> <span class='backtick'>`</span><span class='tstring_content'>(stack + stack_size)</span><span class='tstring_end'>`</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span>
<span class='const'>GET_SELF</span>()<span class='op'>:</span> <span class='id identifier rubyid_refers'>refers</span> <span class='id identifier rubyid_to'>to</span> {<span class='id identifier rubyid_cfp_self'>cfp_self</span>}
<span class='const'>GET_LEP</span>()<span class='op'>:</span> <span class='id identifier rubyid_refers'>refers</span> <span class='id identifier rubyid_to'>to</span> <span class='backtick'>`</span><span class='tstring_content'>VM_EP_LEP(reg_cfp-&gt;ep)</span><span class='tstring_end'>`</span></span>
<span class='const'>EXEC_EC_CFP</span>()<span class='op'>:</span> <span class='id identifier rubyid_refers'>refers</span> <span class='id identifier rubyid_to'>to</span> <span class='backtick'>`</span><span class='tstring_content'>val = vm_exec(ec, true)</span><span class='tstring_end'>`</span></span> <span class='id identifier rubyid_with'>with</span> <span class='id identifier rubyid_frame'>frame</span> <span class='id identifier rubyid_setup'>setup</span>
<span class='const'>CALL_METHOD</span>()<span class='op'>:</span> <span class='id identifier rubyid_using'>using</span> <span class='backtick'>`</span><span class='tstring_content'>GET_CFP()</span><span class='tstring_end'>`</span></span> <span class='kw'>and</span> <span class='backtick'>`</span><span class='tstring_content'>EXEC_EC_CFP()</span><span class='tstring_end'>`</span></span>
<span class='const'>TOPN</span>()<span class='op'>:</span> <span class='id identifier rubyid_refers'>refers</span> <span class='id identifier rubyid_to'>to</span> {<span class='id identifier rubyid_reg_cfp'>reg_cfp</span><span class='tlambda'>-&gt;</span><span class='id identifier rubyid_sp'>sp</span>}<span class='comma'>,</span> <span class='kw'>or</span> <span class='backtick'>`</span><span class='tstring_content'>*(stack + (stack_size - num - 1))</span><span class='tstring_end'>`</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span>
<span class='const'>STACK_ADDR_FROM_TOP</span>()<span class='op'>:</span> <span class='id identifier rubyid_refers'>refers</span> <span class='id identifier rubyid_to'>to</span> {<span class='id identifier rubyid_reg_cfp'>reg_cfp</span><span class='tlambda'>-&gt;</span><span class='id identifier rubyid_sp'>sp</span>}<span class='comma'>,</span> <span class='kw'>or</span> <span class='backtick'>`</span><span class='tstring_content'>stack + (stack_size - num)</span><span class='tstring_end'>`</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span>
<span class='const'>DISPATCH_ORIGINAL_INSN</span>()<span class='op'>:</span> <span class='id identifier rubyid_expanded'>expanded</span> <span class='kw'>in</span> <span class='id identifier rubyid__mjit_compile_insn'>_mjit_compile_insn</span>.<span class='id identifier rubyid_erb'>erb</span>
<span class='const'>THROW_EXCEPTION</span>()<span class='op'>:</span> <span class='id identifier rubyid_specially'>specially</span> <span class='id identifier rubyid_defined'>defined</span> <span class='kw'>for</span> <span class='const'>JIT</span>
<span class='const'>RESTORE_REGS</span>()<span class='op'>:</span> <span class='id identifier rubyid_specially'>specially</span> <span class='id identifier rubyid_defined'>defined</span> <span class='kw'>for</span> <span class='backtick'>`</span><span class='tstring_content'>leave</span><span class='tstring_end'>`</span></span></code></pre>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full nodoc'>
  <li>
    <span id='C-constant' class='summary_signature nodoc'>C =</span>
    <br/>
    <a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L17-L17'># File 'lib/ruby_vm/mjit/compiler.rb', line 17</a>    <pre class='code ruby'><span class='const'>RubyVM</span><span class='op'>::</span><span class='const'><a href="../MJIT.html" title="RubyVM::MJIT (module)">MJIT</a></span>.<span class='id identifier rubyid_const_get'>const_get</span>(<span class='symbeg'>:</span><span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span><span class='comma'>,</span> <span class='kw'>false</span>)</pre>
  </li>
  <li>
    <span id='INSNS-constant' class='summary_signature nodoc'>INSNS =</span>
    <br/>
    <a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L18-L18'># File 'lib/ruby_vm/mjit/compiler.rb', line 18</a>    <pre class='code ruby'><span class='const'>RubyVM</span><span class='op'>::</span><span class='const'><a href="../MJIT.html" title="RubyVM::MJIT (module)">MJIT</a></span>.<span class='id identifier rubyid_const_get'>const_get</span>(<span class='symbeg'>:</span><span class='const'><a href="#INSNS-constant" title="RubyVM::MJIT::Compiler::INSNS (constant)">INSNS</a></span><span class='comma'>,</span> <span class='kw'>false</span>)</pre>
  </li>
  <li>
    <span id='UNSUPPORTED_INSNS-constant' class='summary_signature nodoc'>UNSUPPORTED_INSNS =</span>
    <br/>
    <a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L19-L21'># File 'lib/ruby_vm/mjit/compiler.rb', line 19</a>    <pre class='code ruby'>[
  <span class='symbeg'>:</span><span class='id identifier rubyid_defineclass'>defineclass</span><span class='comma'>,</span> <span class='comment'># low priority
</span>]</pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>  &#x21d2; Compiler </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#compile-instance_method" title="#compile (instance method)">#<strong>compile</strong>(iseq, funcname, id)  &#x21d2; String, NilClass </a>
    </span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#already_compiled%3F-instance_method" title="#already_compiled? (instance method)">#<strong>already_compiled?</strong>(status, pos)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#call_data_index-instance_method" title="#call_data_index (instance method)">#<strong>call_data_index</strong>(cd, body)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#captured_cc_entries-instance_method" title="#captured_cc_entries (instance method)">#<strong>captured_cc_entries</strong>(status)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#cast_offset-instance_method" title="#cast_offset (instance method)">#<strong>cast_offset</strong>(offset)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Interpret unsigned long as signed long (VALUE -&gt; OFFSET).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_body-instance_method" title="#compile_body (instance method)">#<strong>compile_body</strong>(src, iseq, status)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_cancel_handler-instance_method" title="#compile_cancel_handler (instance method)">#<strong>compile_cancel_handler</strong>(src, body, status)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Print the block to cancel JIT execution.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_getconstant_path-instance_method" title="#compile_getconstant_path (instance method)">#<strong>compile_getconstant_path</strong>(stack_size, pos, insn_len, operands, status)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_inlined_cancel_handler-instance_method" title="#compile_inlined_cancel_handler (instance method)">#<strong>compile_inlined_cancel_handler</strong>(src, body, inline_context)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Print the block to cancel inlined method call.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_insn-instance_method" title="#compile_insn (instance method)">#<strong>compile_insn</strong>(insn, pos, status, operands, body, b, src)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Main function of JIT compilation, vm_exec_core counterpart for JIT.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_insn_body-instance_method" title="#compile_insn_body (instance method)">#<strong>compile_insn_body</strong>(src, insn, pos, next_pos, insn_len, local_stack_p, stack_size, sp_inc, operands)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_insn_default-instance_method" title="#compile_insn_default (instance method)">#<strong>compile_insn_default</strong>(insn, stack_size, sp_inc, local_stack_p, pos, next_pos, insn_len, inlined_iseq_p, operands)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_insn_entry-instance_method" title="#compile_insn_entry (instance method)">#<strong>compile_insn_entry</strong>(insn, stack_size, sp_inc, local_stack_p, pos, next_pos, insn_len, inlined_iseq_p, status, operands, body)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_insns-instance_method" title="#compile_insns (instance method)">#<strong>compile_insns</strong>(stack_size, pos, status, body, src)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Compile one conditional branch.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_invokebuiltin-instance_method" title="#compile_invokebuiltin (instance method)">#<strong>compile_invokebuiltin</strong>(insn, stack_size, sp_inc, body, operands)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_ivar-instance_method" title="#compile_ivar (instance method)">#<strong>compile_ivar</strong>(insn_name, stack_size, pos, status, operands, body)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_leave-instance_method" title="#compile_leave (instance method)">#<strong>compile_leave</strong>(stack_size, pos, inlined_iseq_p)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_pc_and_sp-instance_method" title="#compile_pc_and_sp (instance method)">#<strong>compile_pc_and_sp</strong>(src, insn, stack_size, sp_inc, local_stack_p, next_pos)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#compile_send-instance_method" title="#compile_send (instance method)">#<strong>compile_send</strong>(insn, stack_size, sp_inc, local_stack_p, pos, next_pos, status, operands, body)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Optimized case of send / opt_send_without_block instructions.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#def_iseq_ptr-instance_method" title="#def_iseq_ptr (instance method)">#<strong>def_iseq_ptr</strong>(method_def)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#expand_simple_macros-instance_method" title="#expand_simple_macros (instance method)">#<strong>expand_simple_macros</strong>(arg_expr)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Expand simple macro that doesn’t require dynamic <a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a> code.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#has_valid_method_type%3F-instance_method" title="#has_valid_method_type? (instance method)">#<strong>has_valid_method_type?</strong>(cc)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#init_compile_status-instance_method" title="#init_compile_status (instance method)">#<strong>init_compile_status</strong>(status, body, compile_root_p)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#inlinable_iseq_p-instance_method" title="#inlinable_iseq_p (instance method)">#<strong>inlinable_iseq_p</strong>(body)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Return true if the ISeq can be inlined without pushing a new control frame.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#ISEQ_IS_SIZE-instance_method" title="#ISEQ_IS_SIZE (instance method)"><strong>ISEQ_IS_SIZE</strong>(body)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#maybe_special_const%3F-instance_method" title="#maybe_special_const? (instance method)">#<strong>maybe_special_const?</strong>(klass)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Return true if an object of the class may be a special const (immediate).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#parent_shape_id-instance_method" title="#parent_shape_id (instance method)">#<strong>parent_shape_id</strong>(shape_id)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#precompile_inlinable_child_iseq-instance_method" title="#precompile_inlinable_child_iseq (instance method)">#<strong>precompile_inlinable_child_iseq</strong>(src, child_iseq, status, ci, cc, pos)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#precompile_inlinable_iseqs-instance_method" title="#precompile_inlinable_iseqs (instance method)">#<strong>precompile_inlinable_iseqs</strong>(src, iseq, status)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#rb_mjit_inlinable_iseq-instance_method" title="#rb_mjit_inlinable_iseq (instance method)">#<strong>rb_mjit_inlinable_iseq</strong>(ci, cc)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Return an iseq pointer if cc has inlinable iseq.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#rb_mjit_iseq_compile_info-instance_method" title="#rb_mjit_iseq_compile_info (instance method)">#<strong>rb_mjit_iseq_compile_info</strong>(body)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#to_addr-instance_method" title="#to_addr (instance method)">#<strong>to_addr</strong>(struct)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p><a href="CPointer/Struct.html" title="RubyVM::MJIT::CPointer::Struct (class)"><code>CPointer::Struct</code></a> could be nil on field reference, and this is a helper to handle that case while using <a href="CPointer/Struct.html#to_s-instance_method" title="RubyVM::MJIT::CPointer::Struct#to_s (method)">CPointer::Struct#to_s</a> in most cases.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#to_cstr-instance_method" title="#to_cstr (instance method)">#<strong>to_cstr</strong>(expr)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#using_ivar%3F-instance_method" title="#using_ivar? (instance method)">#<strong>using_ivar?</strong>(body)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#vm_cc_cme-instance_method" title="#vm_cc_cme (instance method)">#<strong>vm_cc_cme</strong>(cc)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature nodoc first'>
    .<strong>new</strong>  &#x21d2; <code>Compiler</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L23-L23'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='23' data-end='23'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 23</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span> <span class='op'>=</span> <span class='id identifier rubyid_freeze'>freeze</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="already_compiled?-instance_method">
  <h3 class='signature priv  nodoc first'>
    #<strong>already_compiled?</strong>(status, pos)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L869-L871'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='869' data-end='871'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 869</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_already_compiled?'>already_compiled?</span>(<span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span>)
  <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_stack_size_for_pos'>stack_size_for_pos</span>[<span class='id identifier rubyid_pos'>pos</span>] <span class='op'>!=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>NOT_COMPILED_STACK_SIZE</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="call_data_index-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>call_data_index</strong>(cd, body)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L830-L832'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='830' data-end='832'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 830</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_call_data_index'>call_data_index</span>(<span class='id identifier rubyid_cd'>cd</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
  <span class='id identifier rubyid_cd'>cd</span> <span class='op'>-</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_call_data'>call_data</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="captured_cc_entries-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>captured_cc_entries</strong>(status)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L826-L828'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='826' data-end='828'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 826</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_captured_cc_entries'>captured_cc_entries</span>(<span class='id identifier rubyid_status'>status</span>)
  <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compiled_iseq'>compiled_iseq</span>.<span class='id identifier rubyid_mjit_unit'>mjit_unit</span>.<span class='id identifier rubyid_cc_entries'>cc_entries</span> <span class='op'>+</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_cc_entries_index'>cc_entries_index</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cast_offset-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>cast_offset</strong>(offset)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Interpret unsigned long as signed long (VALUE -&gt; OFFSET)</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L819-L824'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='819' data-end='824'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 819</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cast_offset'>cast_offset</span>(<span class='id identifier rubyid_offset'>offset</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_offset'>offset</span> <span class='op'>&gt;=</span> <span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>8</span> <span class='op'>*</span> <span class='const'>Fiddle</span><span class='op'>::</span><span class='const'>SIZEOF_VOIDP</span> <span class='op'>-</span> <span class='int'>1</span> <span class='comment'># negative
</span>    <span class='id identifier rubyid_offset'>offset</span> <span class='op'>-=</span> <span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>8</span> <span class='op'>*</span> <span class='const'>Fiddle</span><span class='op'>::</span><span class='const'>SIZEOF_VOIDP</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_offset'>offset</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile-instance_method">
  <h3 class='signature nodoc'>
    #<strong>compile</strong>(iseq, funcname, id)  &#x21d2; <code>String</code>, <code>NilClass</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>iseq</span>
    <span class='type'>(<a href="CPointer/Struct.html" title="RubyVM::MJIT::CPointer::Struct (class)">RubyVM::MJIT::CPointer::Struct</a>)</span>
  </li>
  <li>
    <span class='name'>funcname</span>
    <span class='type'>(<code>String</code>)</span>
  </li>
  <li>
    <span class='name'>id</span>
    <span class='type'>(<code>Integer</code>)</span>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L29-L55'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='29' data-end='55'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 29</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile'>compile</span>(<span class='id identifier rubyid_iseq'>iseq</span><span class='comma'>,</span> <span class='id identifier rubyid_funcname'>funcname</span><span class='comma'>,</span> <span class='id identifier rubyid_id'>id</span>)
  <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_compile_status'>compile_status</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="RubyVM::MJIT::Compiler.new (method)">new</a></span> <span class='comment'># not freed for now
</span>  <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compiled_iseq'>compiled_iseq</span> <span class='op'>=</span> <span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>
  <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compiled_id'>compiled_id</span> <span class='op'>=</span> <span class='id identifier rubyid_id'>id</span>
  <span class='id identifier rubyid_init_compile_status'><a href="#init_compile_status-instance_method" title="RubyVM::MJIT::Compiler#init_compile_status (method)">init_compile_status</a></span>(<span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='kw'>true</span>) <span class='comment'># not freed for now
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_ci_size'>ci_size</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_cc_entries_index'>cc_entries_index</span> <span class='op'>==</span> <span class='op'>-</span><span class='int'>1</span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_send_cache'>disable_send_cache</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_inlining'>disable_inlining</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_precompile_inlinable_iseqs'><a href="#precompile_inlinable_iseqs-instance_method" title="RubyVM::MJIT::Compiler#precompile_inlinable_iseqs (method)">precompile_inlinable_iseqs</a></span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_iseq'>iseq</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span>)
      <span class='kw'>return</span> <span class='kw'>nil</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>VALUE\n</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_funcname'>funcname</span><span class='embexpr_end'>}</span><span class='tstring_content'>(rb_execution_context_t *ec, rb_control_frame_t *reg_cfp)\n{\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_success'>success</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_body'><a href="#compile_body-instance_method" title="RubyVM::MJIT::Compiler#compile_body (method)">compile_body</a></span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_iseq'>iseq</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span>)
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n} // end of </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_funcname'>funcname</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='kw'>return</span> <span class='id identifier rubyid_success'>success</span> <span class='op'>?</span> <span class='id identifier rubyid_src'>src</span> <span class='op'>:</span> <span class='kw'>nil</span>
<span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span> <span class='comment'># should we use rb_rescue in C instead?
</span>  <span class='kw'>if</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_mjit_opts'>mjit_opts</span>.<span class='id identifier rubyid_warnings'>warnings</span> <span class='op'>||</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_mjit_opts'>mjit_opts</span>.<span class='id identifier rubyid_verbose'>verbose</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='gvar'>$stderr</span>.<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MJIT error: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_full_message'>full_message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_body-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_body</strong>(src, iseq, status)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L59-L102'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='59' data-end='102'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 59</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_body'>compile_body</span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_iseq'>iseq</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span>)
  <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_success'>success</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_local_stack_p'>local_stack_p</span> <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_catch_except_p'>catch_except_p</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_local_stack_p'>local_stack_p</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    VALUE stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_stack_max'>stack_max</span><span class='embexpr_end'>}</span><span class='tstring_content'>];\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    VALUE *stack = reg_cfp-&gt;sp;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_inlined_iseqs'>inlined_iseqs</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='comment'># i.e. compile root
</span>    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    static const rb_iseq_t *original_iseq = (const rb_iseq_t *)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_iseq'>iseq</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    static const VALUE *const original_body_iseq = (VALUE *)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_encoded'>iseq_encoded</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    VALUE cfp_self = reg_cfp-&gt;self;\n</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># cache self across the method
</span>  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#undef GET_SELF\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#define GET_SELF() cfp_self\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Generate merged ivar guards first if needed
</span>  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_ivar_cache'>disable_ivar_cache</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_using_ivar?'><a href="#using_ivar%3F-instance_method" title="RubyVM::MJIT::Compiler#using_ivar? (method)">using_ivar?</a></span>(<span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>)
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    if (UNLIKELY(!RB_TYPE_P(GET_SELF(), T_OBJECT))) {</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        goto ivar_cancel;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Simulate `opt_pc` in setup_parameters_complex. Other PCs which may be passed by catch tables
</span>  <span class='comment'># are not considered since vm_exec doesn&#39;t call jit_exec for catch tables.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_param'>param</span>.<span class='id identifier rubyid_flags'>flags</span>.<span class='id identifier rubyid_has_opt'>has_opt</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    switch (reg_cfp-&gt;pc - ISEQ_BODY(reg_cfp-&gt;iseq)-&gt;iseq_encoded) {\n</span><span class='tstring_end'>&quot;</span></span>
    (<span class='int'>0</span><span class='op'>..</span><span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_param'>param</span>.<span class='id identifier rubyid_opt_num'>opt_num</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
      <span class='id identifier rubyid_pc_offset'>pc_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_param'>param</span>.<span class='id identifier rubyid_opt_table'>opt_table</span>[<span class='id identifier rubyid_i'>i</span>]
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>      case </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pc_offset'>pc_offset</span><span class='embexpr_end'>}</span><span class='tstring_content'>:\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        goto label_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pc_offset'>pc_offset</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span>(<span class='int'>0</span><span class='comma'>,</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_src'>src</span>)
  <span class='id identifier rubyid_compile_cancel_handler'><a href="#compile_cancel_handler-instance_method" title="RubyVM::MJIT::Compiler#compile_cancel_handler (method)">compile_cancel_handler</a></span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span>)
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#undef GET_SELF\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>return</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_success'>success</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_cancel_handler-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_cancel_handler</strong>(src, body, status)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Print the block to cancel JIT execution.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L665-L694'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='665' data-end='694'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 665</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_cancel_handler'>compile_cancel_handler</span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_inlined_iseqs'>inlined_iseqs</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='comment'># the current ISeq is being inlined
</span>    <span class='id identifier rubyid_compile_inlined_cancel_handler'><a href="#compile_inlined_cancel_handler-instance_method" title="RubyVM::MJIT::Compiler#compile_inlined_cancel_handler (method)">compile_inlined_cancel_handler</a></span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_inline_context'>inline_context</span>)
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nsend_cancel:\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    rb_mjit_recompile_send(original_iseq);\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    goto cancel;\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nivar_cancel:\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    rb_mjit_recompile_ivar(original_iseq);\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    goto cancel;\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nexivar_cancel:\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    rb_mjit_recompile_exivar(original_iseq);\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    goto cancel;\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nconst_cancel:\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    rb_mjit_recompile_const(original_iseq);\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    goto cancel;\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\ncancel:\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>if</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_local_stack_p'>local_stack_p</span>
    (<span class='int'>0</span><span class='op'>...</span><span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_stack_max'>stack_max</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    *(vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_content'>) = stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_content'>];\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    return Qundef;\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_getconstant_path-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_getconstant_path</strong>(stack_size, pos, insn_len, operands, status)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L428-L444'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='428' data-end='444'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 428</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_getconstant_path'>compile_getconstant_path</span>(<span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_insn_len'>insn_len</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span>)
  <span class='id identifier rubyid_ice'>ice</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>IC</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="RubyVM::MJIT::Compiler.new (method)">new</a></span>(<span class='id identifier rubyid_operands'>operands</span>[<span class='int'>0</span>]).<span class='id identifier rubyid_entry'>entry</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_const_cache'>disable_const_cache</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_ice'>ice</span>
    <span class='comment'># JIT: Inline everything in IC, and cancel the slow path
</span>    <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    if (vm_inlined_ic_hit_p(</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ice'>ice</span>.<span class='id identifier rubyid_flags'>flags</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ice'>ice</span>.<span class='id identifier rubyid_value'>value</span><span class='embexpr_end'>}</span><span class='tstring_content'>, (const rb_cref_t *)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_to_addr'><a href="#to_addr-instance_method" title="RubyVM::MJIT::Compiler#to_addr (method)">to_addr</a></span>(<span class='id identifier rubyid_ice'>ice</span>.<span class='id identifier rubyid_ic_cref'>ic_cref</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>, reg_cfp-&gt;ep)) {\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>] = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ice'>ice</span>.<span class='id identifier rubyid_value'>value</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    else {\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;pc = original_body_iseq + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        goto const_cancel;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span>
  <span class='kw'>else</span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_inlined_cancel_handler-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_inlined_cancel_handler</strong>(src, body, inline_context)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Print the block to cancel inlined method call. It’s supporting only <code>opt_send_without_block</code> for now.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L633-L662'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='633' data-end='662'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 633</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_inlined_cancel_handler'>compile_inlined_cancel_handler</span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_inline_context'>inline_context</span>)
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\ncancel:\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    rb_mjit_recompile_inlining(original_iseq);\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Swap pc/sp set on cancel with original pc/sp.
</span>  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const VALUE *current_pc = reg_cfp-&gt;pc;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    VALUE *current_sp = reg_cfp-&gt;sp;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    reg_cfp-&gt;pc = orig_pc;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    reg_cfp-&gt;sp = orig_sp;\n\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Lazily push the current call frame.
</span>  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    struct rb_calling_info calling;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    calling.block_handler = VM_BLOCK_HANDLER_NONE;\n</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># assumes `opt_send_without_block`
</span>  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    calling.argc = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_inline_context'>inline_context</span>.<span class='id identifier rubyid_orig_argc'>orig_argc</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    calling.recv = reg_cfp-&gt;self;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    reg_cfp-&gt;self = orig_self;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='comment'># fastpath_applied_iseq_p checks rb_simple_iseq_p, which ensures has_opt == FALSE
</span>  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    vm_call_iseq_setup_normal(ec, reg_cfp, &amp;calling, (const rb_callable_method_entry_t *)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_inline_context'>inline_context</span>.<span class='id identifier rubyid_me'>me</span><span class='embexpr_end'>}</span><span class='tstring_content'>, 0, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_inline_context'>inline_context</span>.<span class='id identifier rubyid_param_size'>param_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_inline_context'>inline_context</span>.<span class='id identifier rubyid_local_size'>local_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>);\n\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Start usual cancel from here.
</span>  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    reg_cfp = ec-&gt;cfp;\n</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># work on the new frame
</span>  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    reg_cfp-&gt;pc = current_pc;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    reg_cfp-&gt;sp = current_sp;\n</span><span class='tstring_end'>&quot;</span></span>
  (<span class='int'>0</span><span class='op'>...</span><span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_stack_max'>stack_max</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span> <span class='comment'># should be always `status-&gt;local_stack_p`
</span>    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    *(vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_content'>) = stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_content'>];\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='comment'># We&#39;re not just returning Qundef here so that caller&#39;s normal cancel handler can
</span>  <span class='comment'># push back `stack` to `cfp-&gt;sp`.
</span>  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    return vm_exec(ec, false);\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_insn-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_insn</strong>(insn, pos, status, operands, body, b, src)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Main function of JIT compilation, vm_exec_core counterpart for JIT. Compile one insn to <code>f</code>, may modify b-&gt;stack_size and return next position.</p>

<p>When you add a new instruction to insns.def, it would be nice to have JIT compilation support here but it’s optional. This JIT compiler just ignores ISeq which includes unknown instruction, and ISeq which does not have it can be compiled as usual.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L133-L177'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='133' data-end='177'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 133</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_insn'>compile_insn</span>(<span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span><span class='comma'>,</span> <span class='id identifier rubyid_src'>src</span>)
  <span class='id identifier rubyid_sp_inc'>sp_inc</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_mjit_call_attribute_sp_inc'>mjit_call_attribute_sp_inc</span>(<span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_bin'>bin</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span>)
  <span class='id identifier rubyid_next_pos'>next_pos</span> <span class='op'>=</span> <span class='id identifier rubyid_pos'>pos</span> <span class='op'>+</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_len'>len</span>

  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_insn_entry'><a href="#compile_insn_entry-instance_method" title="RubyVM::MJIT::Compiler#compile_insn_entry (method)">compile_insn_entry</a></span>(<span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_len'>len</span><span class='comma'>,</span>
                              <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_inlined_iseqs'>inlined_iseqs</span>.<span class='id identifier rubyid_nil?'>nil?</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>if</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_mjit_opts'>mjit_opts</span>.<span class='id identifier rubyid_warnings'>warnings</span> <span class='op'>||</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_mjit_opts'>mjit_opts</span>.<span class='id identifier rubyid_verbose'>verbose</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='gvar'>$stderr</span>.<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MJIT warning: Skipped to compile unsupported instruction: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_success'>success</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_result_src'>result_src</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_finish_p'>finish_p</span><span class='comma'>,</span> <span class='id identifier rubyid_compile_insns_p'>compile_insns_p</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span>

    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_result_src'>result_src</span>
    <span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+=</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_finish_p'>finish_p</span>
      <span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_finish_p'>finish_p</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_compile_insns_p'>compile_insns_p</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_already_compiled?'><a href="#already_compiled%3F-instance_method" title="RubyVM::MJIT::Compiler#already_compiled? (method)">already_compiled?</a></span>(<span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span> <span class='op'>+</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_len'>len</span>)
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>goto label_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span> <span class='op'>+</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_len'>len</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span>(<span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span> <span class='op'>+</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_len'>len</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_src'>src</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># If next_pos is already compiled and this branch is not finished yet,
</span>  <span class='comment'># next instruction won&#39;t be compiled in C code next and will need `goto`.
</span>  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_finish_p'>finish_p</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_next_pos'>next_pos</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_size'>iseq_size</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_already_compiled?'><a href="#already_compiled%3F-instance_method" title="RubyVM::MJIT::Compiler#already_compiled? (method)">already_compiled?</a></span>(<span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span>)
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>goto label_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_next_pos'>next_pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>

    <span class='comment'># Verify stack size assumption is the same among multiple branches
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_stack_size_for_pos'>stack_size_for_pos</span>[<span class='id identifier rubyid_next_pos'>next_pos</span>] <span class='op'>!=</span> <span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_stack_size'>stack_size</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_mjit_opts'>mjit_opts</span>.<span class='id identifier rubyid_warnings'>warnings</span> <span class='op'>||</span> <span class='id identifier rubyid_mjit_opts'>mjit_opts</span>.<span class='id identifier rubyid_verbose'>verbose</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='gvar'>$stderr</span>.<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MJIT warning: JIT stack assumption is not the same between branches (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_stack_size_for_pos'>stack_size_for_pos</span>[<span class='id identifier rubyid_next_pos'>next_pos</span>]<span class='embexpr_end'>}</span><span class='tstring_content'> != </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_b'>b</span>.<span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>)\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_success'>success</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_next_pos'>next_pos</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_insn_body-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_insn_body</strong>(src, insn, pos, next_pos, insn_len, local_stack_p, stack_size, sp_inc, operands)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L517-L599'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='517' data-end='599'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 517</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_insn_body'>compile_insn_body</span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_insn_len'>insn_len</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span>)
  <span class='comment'># Print a body of insn, but with macro expansion.
</span>  <span class='id identifier rubyid_expand_simple_macros'><a href="#expand_simple_macros-instance_method" title="RubyVM::MJIT::Compiler#expand_simple_macros (method)">expand_simple_macros</a></span>(<span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_expr'>expr</span>).<span class='id identifier rubyid_each_line'>each_line</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span>
    <span class='comment'># Expand dynamic macro here
</span>    <span class='comment'># TODO: support combination of following macros in the same line
</span>    <span class='kw'>case</span> <span class='id identifier rubyid_line'>line</span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A\sRUBY_VM_CHECK_INTS\(ec\);\s\z</span><span class='regexp_end'>/</span></span>
      <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_leaf_without_check_ints?'>leaf_without_check_ints?</span> <span class='comment'># lazily move PC and optionalize mjit_call_p here
</span>        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>            if (UNLIKELY(RUBY_VM_INTERRUPTED_ANY(ec))) {\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>                reg_cfp-&gt;pc = original_body_iseq + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_next_pos'>next_pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># ADD_PC(INSN_ATTR(width));
</span>        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>                rb_threadptr_execute_interrupts(rb_ec_thread_ptr(ec), 0);\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>                if (UNLIKELY(!mjit_call_p)) {\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>                    reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>                    goto cancel;\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>                }\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>            }\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_to_cstr'><a href="#to_cstr-instance_method" title="RubyVM::MJIT::Compiler#to_cstr (method)">to_cstr</a></span>(<span class='id identifier rubyid_line'>line</span>)
      <span class='kw'>end</span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A\sJUMP\((?&lt;dest&gt;[^)])\);\s+\z</span><span class='regexp_end'>/</span></span>
      <span class='id identifier rubyid_dest'>dest</span> <span class='op'>=</span> <span class='const'>Regexp</span>.<span class='id identifier rubyid_last_match'>last_match</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_dest'>dest</span>]
      <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_case_dispatch'>opt_case_dispatch</span> <span class='comment'># special case... TODO: use another macro to avoid checking name
</span>        <span class='id identifier rubyid_hash_offsets'>hash_offsets</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_hash_values'>rb_hash_values</span>(<span class='id identifier rubyid_operands'>operands</span>[<span class='int'>0</span>]).<span class='id identifier rubyid_uniq'>uniq</span>
        <span class='id identifier rubyid_else_offset'>else_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_cast_offset'><a href="#cast_offset-instance_method" title="RubyVM::MJIT::Compiler#cast_offset (method)">cast_offset</a></span>(<span class='id identifier rubyid_operands'>operands</span>[<span class='int'>1</span>])
        <span class='id identifier rubyid_base_pos'>base_pos</span> <span class='op'>=</span> <span class='id identifier rubyid_pos'>pos</span> <span class='op'>+</span> <span class='id identifier rubyid_insn_len'>insn_len</span>

        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    switch (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_dest'>dest</span><span class='embexpr_end'>}</span><span class='tstring_content'>) {\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_hash_offsets'>hash_offsets</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_offset'>offset</span><span class='op'>|</span>
          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>      case </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_offset'>offset</span><span class='embexpr_end'>}</span><span class='tstring_content'>:\n</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        goto label_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_base_pos'>base_pos</span> <span class='op'>+</span> <span class='id identifier rubyid_offset'>offset</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>      case </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_else_offset'>else_offset</span><span class='embexpr_end'>}</span><span class='tstring_content'>:\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        goto label_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_base_pos'>base_pos</span> <span class='op'>+</span> <span class='id identifier rubyid_else_offset'>else_offset</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='comment'># Before we `goto` next insn, we need to set return values, especially for getinlinecache
</span>        <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_rets'>rets</span>.<span class='id identifier rubyid_reverse_each'>reverse_each</span>.<span class='id identifier rubyid_with_index'>with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_ret'>ret</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
          <span class='comment'># TOPN(n) = ...
</span>          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>            stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span> <span class='op'>-</span> (<span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>] = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ret'>ret</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_next_pos'>next_pos</span> <span class='op'>=</span> <span class='id identifier rubyid_pos'>pos</span> <span class='op'>+</span> <span class='id identifier rubyid_insn_len'>insn_len</span> <span class='op'>+</span> <span class='id identifier rubyid_cast_offset'><a href="#cast_offset-instance_method" title="RubyVM::MJIT::Compiler#cast_offset (method)">cast_offset</a></span>(<span class='id identifier rubyid_operands'>operands</span>[<span class='int'>0</span>]) <span class='comment'># workaround: assuming dest == operands[0]. TODO: avoid relying on it
</span>        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>            goto label_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_next_pos'>next_pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A\sCALL_SIMPLE_METHOD\(\);\s\z</span><span class='regexp_end'>/</span></span>
      <span class='comment'># For `opt_xxx`&#39;s fallbacks.
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>            reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>            reg_cfp-&gt;pc = original_body_iseq + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>            goto cancel;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A(?&lt;prefix&gt;.\b)INSN_LABEL\((?&lt;name&gt;[^)])\)(?&lt;suffix&gt;.+)\z</span><span class='regexp_end'>/m</span></span>
      <span class='id identifier rubyid_prefix'>prefix</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_suffix'>suffix</span> <span class='op'>=</span> <span class='const'>Regexp</span>.<span class='id identifier rubyid_last_match'>last_match</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_prefix'>prefix</span>]<span class='comma'>,</span> <span class='const'>Regexp</span>.<span class='id identifier rubyid_last_match'>last_match</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>]<span class='comma'>,</span> <span class='const'>Regexp</span>.<span class='id identifier rubyid_last_match'>last_match</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_suffix'>suffix</span>]
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_prefix'>prefix</span><span class='embexpr_end'>}</span><span class='tstring_content'>INSN_LABEL(</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_suffix'>suffix</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_handles_sp?'>handles_sp?</span>
        <span class='comment'># If insn.handles_sp? is true, cfp-&gt;sp might be changed inside insns (like vm_caller_setup_arg_block)
</span>        <span class='comment'># and thus we need to use cfp-&gt;sp, even when local_stack_p is TRUE. When insn.handles_sp? is true,
</span>        <span class='comment'># cfp-&gt;sp should be available too because _mjit_compile_pc_and_sp.erb sets it.
</span>        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_to_cstr'><a href="#to_cstr-instance_method" title="RubyVM::MJIT::Compiler#to_cstr (method)">to_cstr</a></span>(<span class='id identifier rubyid_line'>line</span>)
      <span class='kw'>else</span>
        <span class='comment'># If local_stack_p is TRUE and insn.handles_sp? is false, stack values are only available in local variables
</span>        <span class='comment'># for stack. So we need to replace those macros if local_stack_p is TRUE here.
</span>        <span class='kw'>case</span> <span class='id identifier rubyid_line'>line</span>
        <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\bGET_SP\(\)</span><span class='regexp_end'>/</span></span>
          <span class='comment'># reg_cfp-&gt;sp
</span>          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_to_cstr'><a href="#to_cstr-instance_method" title="RubyVM::MJIT::Compiler#to_cstr (method)">to_cstr</a></span>(<span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_sub'>sub</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\bGET_SP\(\)</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>(stack + stack_size)</span><span class='tstring_end'>&#39;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>GET_SP()</span><span class='tstring_end'>&#39;</span></span>))
        <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\bSTACK_ADDR_FROM_TOP\((?&lt;num&gt;[^)]+)\)</span><span class='regexp_end'>/</span></span>
          <span class='comment'># #define STACK_ADDR_FROM_TOP(n) (GET_SP()-(n))
</span>          <span class='id identifier rubyid_num'>num</span> <span class='op'>=</span> <span class='const'>Regexp</span>.<span class='id identifier rubyid_last_match'>last_match</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_num'>num</span>]
          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_to_cstr'><a href="#to_cstr-instance_method" title="RubyVM::MJIT::Compiler#to_cstr (method)">to_cstr</a></span>(<span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_sub'>sub</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\bSTACK_ADDR_FROM_TOP\(([^)]+)\)</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(stack + (stack_size - (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_num'>num</span><span class='embexpr_end'>}</span><span class='tstring_content'>)))</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>STACK_ADDR_FROM_TOP(</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_num'>num</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>))
        <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\bTOPN\((?&lt;num&gt;[^)]+)\)</span><span class='regexp_end'>/</span></span>
          <span class='comment'># #define TOPN(n) (*(GET_SP()-(n)-1))
</span>          <span class='id identifier rubyid_num'>num</span> <span class='op'>=</span> <span class='const'>Regexp</span>.<span class='id identifier rubyid_last_match'>last_match</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_num'>num</span>]
          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_to_cstr'><a href="#to_cstr-instance_method" title="RubyVM::MJIT::Compiler#to_cstr (method)">to_cstr</a></span>(<span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_sub'>sub</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\bTOPN\(([^)]+)\)</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*(stack + (stack_size - (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_num'>num</span><span class='embexpr_end'>}</span><span class='tstring_content'>) - 1))</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TOPN(</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_num'>num</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>))
        <span class='kw'>else</span>
          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_to_cstr'><a href="#to_cstr-instance_method" title="RubyVM::MJIT::Compiler#to_cstr (method)">to_cstr</a></span>(<span class='id identifier rubyid_line'>line</span>)
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_next_pos'>next_pos</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_insn_default-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_insn_default</strong>(insn, stack_size, sp_inc, local_stack_p, pos, next_pos, insn_len, inlined_iseq_p, operands)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L446-L515'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='446' data-end='515'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 446</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_insn_default'>compile_insn_default</span>(<span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_insn_len'>insn_len</span><span class='comma'>,</span> <span class='id identifier rubyid_inlined_iseq_p'>inlined_iseq_p</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span>)
  <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_finish_p'>finish_p</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># JIT: Declare stack_size to be used in some macro of _mjit_compile_insn_body.erb
</span>  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>if</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    MAYBE_UNUSED(unsigned int) stack_size = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># JIT: Declare variables for operands, popped values and return values
</span>  <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_declarations'>declarations</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_decl'>decl</span><span class='op'>|</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_decl'>decl</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># JIT: Set const expressions for `RubyVM::OperandsUnifications` insn
</span>  <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_preamble'>preamble</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_amble'>amble</span><span class='op'>|</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_amble'>amble</span>.<span class='id identifier rubyid_sub'>sub</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>const \S\s</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>)<span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># JIT: Initialize operands
</span>  <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_opes'>opes</span>.<span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_ope'>ope</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ope'>ope</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>)<span class='embexpr_end'>}</span><span class='tstring_content'> = (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ope'>ope</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_type'>type</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_operands'>operands</span>[<span class='id identifier rubyid_i'>i</span>]<span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='comment'># TODO: resurrect comment_id
</span>  <span class='kw'>end</span>

  <span class='comment'># JIT: Initialize popped values
</span>  <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_pops'>pops</span>.<span class='id identifier rubyid_reverse_each'>reverse_each</span>.<span class='id identifier rubyid_with_index'>with_index</span>.<span class='id identifier rubyid_reverse_each'>reverse_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pop'>pop</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pop'>pop</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>)<span class='embexpr_end'>}</span><span class='tstring_content'> = stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>-</span> (<span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>];\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># JIT: move sp and pc if necessary
</span>  <span class='id identifier rubyid_pc_moved_p'>pc_moved_p</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_pc_and_sp'><a href="#compile_pc_and_sp-instance_method" title="RubyVM::MJIT::Compiler#compile_pc_and_sp (method)">compile_pc_and_sp</a></span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span>)

  <span class='comment'># JIT: Print insn body in insns.def
</span>  <span class='id identifier rubyid_next_pos'>next_pos</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_insn_body'><a href="#compile_insn_body-instance_method" title="RubyVM::MJIT::Compiler#compile_insn_body (method)">compile_insn_body</a></span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_insn_len'>insn_len</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span>)

  <span class='comment'># JIT: Set return values
</span>  <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_rets'>rets</span>.<span class='id identifier rubyid_reverse_each'>reverse_each</span>.<span class='id identifier rubyid_with_index'>with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_ret'>ret</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='comment'># TOPN(n) = ...
</span>    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span> <span class='op'>-</span> (<span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>] = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ret'>ret</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># JIT: We should evaluate ISeq modified for TracePoint if it&#39;s enabled. Note: This is slow.
</span>  <span class='comment'>#      leaf insn may not cancel JIT. leaf_without_check_ints is covered in RUBY_VM_CHECK_INTS of _mjit_compile_insn_body.erb.
</span>  <span class='kw'>unless</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_always_leaf?'>always_leaf?</span> <span class='op'>||</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_leaf_without_check_ints?'>leaf_without_check_ints?</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    if (UNLIKELY(!mjit_call_p)) {\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_pc_moved_p'>pc_moved_p</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;pc = original_body_iseq + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_next_pos'>next_pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        goto cancel;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>}\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># compiler: If insn has conditional JUMP, the code should go to the branch not targeted by JUMP next.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_expr'>expr</span>.<span class='id identifier rubyid_match?'>match?</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>if\s\([^{}]\)\s\{[^{}]JUMP\([^)]\);[^{}]\}</span><span class='regexp_end'>/</span></span>)
    <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>

  <span class='comment'># compiler: If insn returns (leave) or does longjmp (throw), the branch should no longer be compiled. TODO: create attr for it?
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_expr'>expr</span>.<span class='id identifier rubyid_match?'>match?</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\sTHROW_EXCEPTION\([^)]+\);</span><span class='regexp_end'>/</span></span>) <span class='op'>||</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_expr'>expr</span>.<span class='id identifier rubyid_match?'>match?</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\bvm_pop_frame\(</span><span class='regexp_end'>/</span></span>)
    <span class='id identifier rubyid_finish_p'>finish_p</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_finish_p'>finish_p</span><span class='comma'>,</span> <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_insn_entry-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_insn_entry</strong>(insn, stack_size, sp_inc, local_stack_p, pos, next_pos, insn_len, inlined_iseq_p, status, operands, body)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L179-L231'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='179' data-end='231'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 179</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_insn_entry'>compile_insn_entry</span>(<span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_insn_len'>insn_len</span><span class='comma'>,</span> <span class='id identifier rubyid_inlined_iseq_p'>inlined_iseq_p</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
  <span class='id identifier rubyid_finish_p'>finish_p</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># TODO: define this outside this method, or at least cache it
</span>  <span class='id identifier rubyid_opt_send_without_block'>opt_send_without_block</span> <span class='op'>=</span> <span class='const'><a href="#INSNS-constant" title="RubyVM::MJIT::Compiler::INSNS (constant)">INSNS</a></span>.<span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_find'>find</span> { <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span> <span class='id identifier rubyid_i'>i</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_send_without_block'>opt_send_without_block</span> }
  <span class='kw'>if</span> <span class='id identifier rubyid_opt_send_without_block'>opt_send_without_block</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>opt_send_without_block not found</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_send_compatible_opt_insns'>send_compatible_opt_insns</span> <span class='op'>=</span> <span class='const'><a href="#INSNS-constant" title="RubyVM::MJIT::Compiler::INSNS (constant)">INSNS</a></span>.<span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_insn'>insn</span><span class='op'>|</span>
    <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_start_with?'>start_with?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>opt_</span><span class='tstring_end'>&#39;</span></span>) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_opt_send_without_block'>opt_send_without_block</span>.<span class='id identifier rubyid_opes'>opes</span> <span class='op'>==</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_opes'>opes</span> <span class='op'>&amp;&amp;</span>
      <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_expr'>expr</span>.<span class='id identifier rubyid_lines'>lines</span>.<span class='id identifier rubyid_any?'>any?</span> { <span class='op'>|</span><span class='id identifier rubyid_l'>l</span><span class='op'>|</span> <span class='id identifier rubyid_l'>l</span>.<span class='id identifier rubyid_match'>match</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A\sCALL_SIMPLE_METHOD\(\);\s\z</span><span class='regexp_end'>/</span></span>) }
  <span class='kw'>end</span>.<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>)

  <span class='kw'>case</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span>
  <span class='kw'>when</span> <span class='op'>*</span><span class='const'><a href="#UNSUPPORTED_INSNS-constant" title="RubyVM::MJIT::Compiler::UNSUPPORTED_INSNS (constant)">UNSUPPORTED_INSNS</a></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_send_without_block'>opt_send_without_block</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_send'>send</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_send'><a href="#compile_send-instance_method" title="RubyVM::MJIT::Compiler#compile_send (method)">compile_send</a></span>(<span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
      <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_finish_p'>finish_p</span><span class='comma'>,</span> <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='op'>*</span><span class='id identifier rubyid_send_compatible_opt_insns'>send_compatible_opt_insns</span>
    <span class='kw'>if</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_has_cache_for_send'>has_cache_for_send</span>(<span class='id identifier rubyid_captured_cc_entries'><a href="#captured_cc_entries-instance_method" title="RubyVM::MJIT::Compiler#captured_cc_entries (method)">captured_cc_entries</a></span>(<span class='id identifier rubyid_status'>status</span>)[<span class='id identifier rubyid_call_data_index'><a href="#call_data_index-instance_method" title="RubyVM::MJIT::Compiler#call_data_index (method)">call_data_index</a></span>(<span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>CALL_DATA</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="RubyVM::MJIT::Compiler.new (method)">new</a></span>(<span class='id identifier rubyid_operands'>operands</span>[<span class='int'>0</span>])<span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)]<span class='comma'>,</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_bin'>bin</span>) <span class='op'>&amp;&amp;</span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_send'><a href="#compile_send-instance_method" title="RubyVM::MJIT::Compiler#compile_send (method)">compile_send</a></span>(<span class='id identifier rubyid_opt_send_without_block'>opt_send_without_block</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
      <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_finish_p'>finish_p</span><span class='comma'>,</span> <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_getinstancevariable'>getinstancevariable</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_setinstancevariable'>setinstancevariable</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_ivar'><a href="#compile_ivar-instance_method" title="RubyVM::MJIT::Compiler#compile_ivar (method)">compile_ivar</a></span>(<span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
      <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_finish_p'>finish_p</span><span class='comma'>,</span> <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_getconstant_path'>opt_getconstant_path</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_getconstant_path'><a href="#compile_getconstant_path-instance_method" title="RubyVM::MJIT::Compiler#compile_getconstant_path (method)">compile_getconstant_path</a></span>(<span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_insn_len'>insn_len</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span>)
      <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_finish_p'>finish_p</span><span class='comma'>,</span> <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invokebuiltin'>invokebuiltin</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_invokebuiltin_delegate'>opt_invokebuiltin_delegate</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_invokebuiltin_delegate_leave'>opt_invokebuiltin_delegate_leave</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_invokebuiltin'><a href="#compile_invokebuiltin-instance_method" title="RubyVM::MJIT::Compiler#compile_invokebuiltin (method)">compile_invokebuiltin</a></span>(<span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span>)
      <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_invokebuiltin_delegate_leave'>opt_invokebuiltin_delegate_leave</span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_compile_leave'><a href="#compile_leave-instance_method" title="RubyVM::MJIT::Compiler#compile_leave (method)">compile_leave</a></span>(<span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_inlined_iseq_p'>inlined_iseq_p</span>)
        <span class='id identifier rubyid_finish_p'>finish_p</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>end</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_finish_p'>finish_p</span><span class='comma'>,</span> <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_leave'>leave</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>!=</span> <span class='int'>1</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unexpected JIT stack_size on leave: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_leave'><a href="#compile_leave-instance_method" title="RubyVM::MJIT::Compiler#compile_leave (method)">compile_leave</a></span>(<span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_inlined_iseq_p'>inlined_iseq_p</span>)
    <span class='id identifier rubyid_finish_p'>finish_p</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_finish_p'>finish_p</span><span class='comma'>,</span> <span class='id identifier rubyid_compile_insns'><a href="#compile_insns-instance_method" title="RubyVM::MJIT::Compiler#compile_insns (method)">compile_insns</a></span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_compile_insn_default'><a href="#compile_insn_default-instance_method" title="RubyVM::MJIT::Compiler#compile_insn_default (method)">compile_insn_default</a></span>(<span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_insn_len'>insn_len</span><span class='comma'>,</span> <span class='id identifier rubyid_inlined_iseq_p'>inlined_iseq_p</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_insns-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_insns</strong>(stack_size, pos, status, body, src)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Compile one conditional branch. If it has branchXXX insn, this should be called multiple times for each branch.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L106-L125'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='106' data-end='125'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 106</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_insns'>compile_insns</span>(<span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_src'>src</span>)
  <span class='id identifier rubyid_branch'>branch</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_compile_branch'>compile_branch</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="RubyVM::MJIT::Compiler.new (method)">new</a></span> <span class='comment'># not freed for now
</span>  <span class='id identifier rubyid_branch'>branch</span>.<span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>=</span> <span class='id identifier rubyid_stack_size'>stack_size</span>
  <span class='id identifier rubyid_branch'>branch</span>.<span class='id identifier rubyid_finish_p'>finish_p</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='kw'>while</span> <span class='id identifier rubyid_pos'>pos</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_size'>iseq_size</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_already_compiled?'><a href="#already_compiled%3F-instance_method" title="RubyVM::MJIT::Compiler#already_compiled? (method)">already_compiled?</a></span>(<span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_branch'>branch</span>.<span class='id identifier rubyid_finish_p'>finish_p</span>
    <span class='id identifier rubyid_insn'>insn</span> <span class='op'>=</span> <span class='const'><a href="#INSNS-constant" title="RubyVM::MJIT::Compiler::INSNS (constant)">INSNS</a></span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_vm_insn_decode'>rb_vm_insn_decode</span>(<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_encoded'>iseq_encoded</span>[<span class='id identifier rubyid_pos'>pos</span>]))
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_stack_size_for_pos'>stack_size_for_pos</span>[<span class='id identifier rubyid_pos'>pos</span>] <span class='op'>=</span> <span class='id identifier rubyid_branch'>branch</span>.<span class='id identifier rubyid_stack_size'>stack_size</span>

    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nlabel_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>: /* </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> */\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_pos'>pos</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_insn'><a href="#compile_insn-instance_method" title="RubyVM::MJIT::Compiler#compile_insn (method)">compile_insn</a></span>(<span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_encoded'>iseq_encoded</span> <span class='op'>+</span> (<span class='id identifier rubyid_pos'>pos</span><span class='op'>+</span><span class='int'>1</span>)<span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_branch'>branch</span><span class='comma'>,</span> <span class='id identifier rubyid_src'>src</span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_success'>success</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_branch'>branch</span>.<span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_stack_max'>stack_max</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_mjit_opts'>mjit_opts</span>.<span class='id identifier rubyid_warnings'>warnings</span> <span class='op'>||</span> <span class='id identifier rubyid_mjit_opts'>mjit_opts</span>.<span class='id identifier rubyid_verbose'>verbose</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='gvar'>$stderr</span>.<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MJIT warning: JIT stack size (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_branch'>branch</span>.<span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>) exceeded its max size (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_stack_max'>stack_max</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_success'>success</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
    <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_success'>success</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_invokebuiltin-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_invokebuiltin</strong>(insn, stack_size, sp_inc, body, operands)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L398-L411'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='398' data-end='411'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 398</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_invokebuiltin'>compile_invokebuiltin</span>(<span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span>)
  <span class='id identifier rubyid_bf'>bf</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>RB_BUILTIN</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="RubyVM::MJIT::Compiler.new (method)">new</a></span>(<span class='id identifier rubyid_operands'>operands</span>[<span class='int'>0</span>])
  <span class='kw'>if</span> <span class='id identifier rubyid_bf'>bf</span>.<span class='id identifier rubyid_compiler'>compiler</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='id identifier rubyid_index'>index</span> <span class='op'>=</span> (<span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invokebuiltin'>invokebuiltin</span> <span class='op'>?</span> <span class='op'>-</span><span class='int'>1</span> <span class='op'>:</span> <span class='id identifier rubyid_operands'>operands</span>[<span class='int'>1</span>])
    <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    VALUE val;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_builtin_compiler'>builtin_compiler</span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_bf'>bf</span><span class='comma'>,</span> <span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_builtin_inline_p'>builtin_inline_p</span>)
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>] = val;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>}\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span>
  <span class='kw'>else</span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_ivar-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_ivar</strong>(insn_name, stack_size, pos, status, operands, body)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L329-L396'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='329' data-end='396'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 329</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_ivar'>compile_ivar</span>(<span class='id identifier rubyid_insn_name'>insn_name</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
  <span class='id identifier rubyid_iv_cache'>iv_cache</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_iseq_inline_storage_entry'>iseq_inline_storage_entry</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="RubyVM::MJIT::Compiler.new (method)">new</a></span>(<span class='id identifier rubyid_operands'>operands</span>[<span class='int'>1</span>]).<span class='id identifier rubyid_iv_cache'>iv_cache</span>
  <span class='id identifier rubyid_dest_shape_id'>dest_shape_id</span> <span class='op'>=</span> <span class='id identifier rubyid_iv_cache'>iv_cache</span>.<span class='id identifier rubyid_value'>value</span> <span class='op'>&gt;&gt;</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>SHAPE_FLAG_SHIFT</span>
  <span class='id identifier rubyid_source_shape_id'>source_shape_id</span> <span class='op'>=</span> <span class='id identifier rubyid_parent_shape_id'><a href="#parent_shape_id-instance_method" title="RubyVM::MJIT::Compiler#parent_shape_id (method)">parent_shape_id</a></span>(<span class='id identifier rubyid_dest_shape_id'>dest_shape_id</span>)
  <span class='id identifier rubyid_attr_index'>attr_index</span> <span class='op'>=</span> <span class='id identifier rubyid_iv_cache'>iv_cache</span>.<span class='id identifier rubyid_value'>value</span> <span class='op'>&amp;</span> ((<span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>SHAPE_FLAG_SHIFT</span>) <span class='op'>-</span> <span class='int'>1</span>)

  <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_ivar_cache'>disable_ivar_cache</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_source_shape_id'>source_shape_id</span> <span class='op'>!=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>INVALID_SHAPE_ID</span>
    <span class='comment'># JIT: optimize away motion of sp and pc. This path does not call rb_warning() and so it&#39;s always leaf and not `handles_sp`.
</span>    <span class='comment'># compile_pc_and_sp(src, insn, stack_size, sp_inc, local_stack_p, next_pos)
</span>
    <span class='comment'># JIT: prepare vm_getivar/vm_setivar arguments and variables
</span>    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    VALUE obj = GET_SELF();\n</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># T_OBJECT guaranteed by compile_body
</span>    <span class='comment'># JIT: cache hit path of vm_getivar/vm_setivar, or cancel JIT (recompile it with exivar)
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_insn_name'>insn_name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_setinstancevariable'>setinstancevariable</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const uint32_t index = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_attr_index'>attr_index</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const shape_id_t dest_shape_id = (shape_id_t)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_dest_shape_id'>dest_shape_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    if (dest_shape_id == ROBJECT_SHAPE_ID(obj)) {\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        VALUE *ptr = ROBJECT_IVPTR(obj);\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        RB_OBJ_WRITE(obj, &amp;ptr[index], stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>]);\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const shape_id_t source_shape_id = (shape_id_t)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_dest_shape_id'>dest_shape_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>if</span> <span class='id identifier rubyid_attr_index'>attr_index</span> <span class='op'>==</span> <span class='int'>0</span> <span class='comment'># cache hit, but uninitialized iv
</span>        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    /* Uninitialized instance variable */\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    if (source_shape_id == ROBJECT_SHAPE_ID(obj)) {\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>] = Qnil;\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const uint32_t index = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_attr_index'>attr_index</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    if (source_shape_id == ROBJECT_SHAPE_ID(obj)) {\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>] = ROBJECT_IVPTR(obj)[index];\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    else {\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;pc = original_body_iseq + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        goto ivar_cancel;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>}\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_insn_name'>insn_name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_getinstancevariable'>getinstancevariable</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_exivar_cache'>disable_exivar_cache</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_source_shape_id'>source_shape_id</span> <span class='op'>!=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>INVALID_SHAPE_ID</span>
    <span class='comment'># JIT: optimize away motion of sp and pc. This path does not call rb_warning() and so it&#39;s always leaf and not `handles_sp`.
</span>    <span class='comment'># compile_pc_and_sp(src, insn, stack_size, sp_inc, local_stack_p, next_pos)
</span>
    <span class='comment'># JIT: prepare vm_getivar&#39;s arguments and variables
</span>    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    VALUE obj = GET_SELF();\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const shape_id_t source_shape_id = (shape_id_t)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_dest_shape_id'>dest_shape_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const uint32_t index = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_attr_index'>attr_index</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='comment'># JIT: cache hit path of vm_getivar, or cancel JIT (recompile it without any ivar optimization)
</span>    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    struct gen_ivtbl *ivtbl;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    if (LIKELY(FL_TEST_RAW(GET_SELF(), FL_EXIVAR) &amp;&amp; source_shape_id == rb_shape_get_shape_id(obj) &amp;&amp; rb_ivar_generic_ivtbl_lookup(obj, &amp;ivtbl))) {\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>] = ivtbl-&gt;ivptr[index];\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    else {\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;pc = original_body_iseq + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        goto exivar_cancel;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>}\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span>
  <span class='kw'>else</span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_leave-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_leave</strong>(stack_size, pos, inlined_iseq_p)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L413-L426'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='413' data-end='426'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 413</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_leave'>compile_leave</span>(<span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_inlined_iseq_p'>inlined_iseq_p</span>)
  <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='comment'># Skip vm_pop_frame for inlined call
</span>  <span class='kw'>unless</span> <span class='id identifier rubyid_inlined_iseq_p'>inlined_iseq_p</span>
    <span class='comment'># Cancel on interrupts to make leave insn leaf
</span>    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    if (UNLIKELY(RUBY_VM_INTERRUPTED_ANY(ec))) {\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;pc = original_body_iseq + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        rb_threadptr_execute_interrupts(rb_ec_thread_ptr(ec), 0);\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    ec-&gt;cfp = RUBY_VM_PREVIOUS_CONTROL_FRAME(reg_cfp);\n</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># vm_pop_frame
</span>  <span class='kw'>end</span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    return stack[0];\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_pc_and_sp-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_pc_and_sp</strong>(src, insn, stack_size, sp_inc, local_stack_p, next_pos)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L601-L630'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='601' data-end='630'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 601</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_pc_and_sp'>compile_pc_and_sp</span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span>)
  <span class='comment'># JIT: When an insn is leaf, we don&#39;t need to Move pc for a catch table on catch_except_p, #caller_locations,
</span>  <span class='comment'>#      and rb_profile_frames. For check_ints, we lazily move PC when we have interruptions.
</span>  <span class='id identifier rubyid_pc_moved_p'>pc_moved_p</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_always_leaf?'>always_leaf?</span> <span class='op'>||</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_leaf_without_check_ints?'>leaf_without_check_ints?</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    reg_cfp-&gt;pc = original_body_iseq + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_next_pos'>next_pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># ADD_PC(INSN_ATTR(width));
</span>    <span class='id identifier rubyid_pc_moved_p'>pc_moved_p</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>

  <span class='comment'># JIT: move sp to use or preserve stack variables
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span>
    <span class='comment'># sp motion is optimized away for `handles_sp? #=&gt; false` case.
</span>    <span class='comment'># Thus sp should be set properly before `goto cancel`.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_handles_sp?'>handles_sp?</span>
      <span class='comment'># JIT-only behavior (pushing JIT&#39;s local variables to VM&#39;s stack):
</span>      <span class='id identifier rubyid_push_size'>push_size</span> <span class='op'>=</span> <span class='op'>-</span><span class='id identifier rubyid_sp_inc'>sp_inc</span> <span class='op'>+</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_rets'>rets</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>-</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_pops'>pops</span>.<span class='id identifier rubyid_size'>size</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_push_size'>push_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_push_size'>push_size</span>.<span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    *(reg_cfp-&gt;sp + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span> <span class='op'>-</span> <span class='id identifier rubyid_push_size'>push_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>) = stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>-</span> <span class='id identifier rubyid_push_size'>push_size</span> <span class='op'>+</span> <span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_content'>];\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_handles_sp?'>handles_sp?</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>-</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_pops'>pops</span>.<span class='id identifier rubyid_size'>size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># POPN(INSN_ATTR(popn));
</span>    <span class='kw'>else</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_pc_moved_p'>pc_moved_p</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="compile_send-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>compile_send</strong>(insn, stack_size, sp_inc, local_stack_p, pos, next_pos, status, operands, body)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Optimized case of send / opt_send_without_block instructions.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L234-L327'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='234' data-end='327'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 234</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_compile_send'>compile_send</span>(<span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_operands'>operands</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
  <span class='comment'># compiler: Use captured cc to avoid race condition
</span>  <span class='id identifier rubyid_cd'>cd</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>CALL_DATA</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="RubyVM::MJIT::Compiler.new (method)">new</a></span>(<span class='id identifier rubyid_operands'>operands</span>[<span class='int'>0</span>])
  <span class='id identifier rubyid_cd_index'>cd_index</span> <span class='op'>=</span> <span class='id identifier rubyid_call_data_index'><a href="#call_data_index-instance_method" title="RubyVM::MJIT::Compiler#call_data_index (method)">call_data_index</a></span>(<span class='id identifier rubyid_cd'>cd</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
  <span class='id identifier rubyid_captured_cc'>captured_cc</span> <span class='op'>=</span> <span class='id identifier rubyid_captured_cc_entries'><a href="#captured_cc_entries-instance_method" title="RubyVM::MJIT::Compiler#captured_cc_entries (method)">captured_cc_entries</a></span>(<span class='id identifier rubyid_status'>status</span>)[<span class='id identifier rubyid_cd_index'>cd_index</span>]

  <span class='comment'># compiler: Inline send insn where some supported fastpath is used.
</span>  <span class='id identifier rubyid_ci'>ci</span> <span class='op'>=</span> <span class='id identifier rubyid_cd'>cd</span>.<span class='id identifier rubyid_ci'>ci</span>
  <span class='id identifier rubyid_kw_splat'>kw_splat</span> <span class='op'>=</span> (<span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_vm_ci_flag'>vm_ci_flag</span>(<span class='id identifier rubyid_ci'>ci</span>) <span class='op'>&amp;</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>VM_CALL_KW_SPLAT</span>) <span class='op'>&gt;</span> <span class='int'>0</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_send_cache'>disable_send_cache</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_has_valid_method_type?'><a href="#has_valid_method_type%3F-instance_method" title="RubyVM::MJIT::Compiler#has_valid_method_type? (method)">has_valid_method_type?</a></span>(<span class='id identifier rubyid_captured_cc'>captured_cc</span>) <span class='op'>&amp;&amp;</span> (
      <span class='comment'># `CC_SET_FASTPATH(cd-&gt;cc, vm_call_cfunc_with_frame, ...)` in `vm_call_cfunc`
</span>      (<span class='id identifier rubyid_vm_cc_cme'><a href="#vm_cc_cme-instance_method" title="RubyVM::MJIT::Compiler#vm_cc_cme (method)">vm_cc_cme</a></span>(<span class='id identifier rubyid_captured_cc'>captured_cc</span>).<span class='id identifier rubyid_def'>def</span>.<span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>VM_METHOD_TYPE_CFUNC</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_splat_or_kwargs_p'>rb_splat_or_kwargs_p</span>(<span class='id identifier rubyid_ci'>ci</span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_kw_splat'>kw_splat</span>) <span class='op'>||</span>
      <span class='comment'># `CC_SET_FASTPATH(cc, vm_call_iseq_setup_func(...), vm_call_iseq_optimizable_p(...))` in `vm_callee_setup_arg`,
</span>      <span class='comment'># and support only non-VM_CALL_TAILCALL path inside it
</span>      (<span class='id identifier rubyid_vm_cc_cme'><a href="#vm_cc_cme-instance_method" title="RubyVM::MJIT::Compiler#vm_cc_cme (method)">vm_cc_cme</a></span>(<span class='id identifier rubyid_captured_cc'>captured_cc</span>).<span class='id identifier rubyid_def'>def</span>.<span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>VM_METHOD_TYPE_ISEQ</span> <span class='op'>&amp;&amp;</span>
       <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_fastpath_applied_iseq_p'>fastpath_applied_iseq_p</span>(<span class='id identifier rubyid_ci'>ci</span><span class='comma'>,</span> <span class='id identifier rubyid_captured_cc'>captured_cc</span><span class='comma'>,</span> <span class='id identifier rubyid_iseq'>iseq</span> <span class='op'>=</span> <span class='id identifier rubyid_def_iseq_ptr'><a href="#def_iseq_ptr-instance_method" title="RubyVM::MJIT::Compiler#def_iseq_ptr (method)">def_iseq_ptr</a></span>(<span class='id identifier rubyid_vm_cc_cme'><a href="#vm_cc_cme-instance_method" title="RubyVM::MJIT::Compiler#vm_cc_cme (method)">vm_cc_cme</a></span>(<span class='id identifier rubyid_captured_cc'>captured_cc</span>).<span class='id identifier rubyid_def'>def</span>)) <span class='op'>&amp;&amp;</span>
       (<span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_vm_ci_flag'>vm_ci_flag</span>(<span class='id identifier rubyid_ci'>ci</span>) <span class='op'>&amp;</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>VM_CALL_TAILCALL</span>) <span class='op'>==</span> <span class='int'>0</span>)
  )
    <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{\n</span><span class='tstring_end'>&quot;</span></span>

    <span class='comment'># JIT: Invalidate call cache if it requires vm_search_method. This allows to inline some of following things.
</span>    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const struct rb_callcache *cc = (struct rb_callcache *)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_captured_cc'>captured_cc</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const rb_callable_method_entry_t *cc_cme = (rb_callable_method_entry_t *)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_vm_cc_cme'><a href="#vm_cc_cme-instance_method" title="RubyVM::MJIT::Compiler#vm_cc_cme (method)">vm_cc_cme</a></span>(<span class='id identifier rubyid_captured_cc'>captured_cc</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const VALUE recv = stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>];\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='comment'># If opt_class_of is true, use RBASIC_CLASS instead of CLASS_OF to reduce code size
</span>    <span class='id identifier rubyid_opt_class_of'>opt_class_of</span> <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_maybe_special_const?'><a href="#maybe_special_const%3F-instance_method" title="RubyVM::MJIT::Compiler#maybe_special_const? (method)">maybe_special_const?</a></span>(<span class='id identifier rubyid_captured_cc'>captured_cc</span>.<span class='id identifier rubyid_klass'>klass</span>)
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    if (UNLIKELY(</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opt_class_of'>opt_class_of</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RB_SPECIAL_CONST_P(recv)</span><span class='tstring_end'>&#39;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>false</span><span class='tstring_end'>&#39;</span></span><span class='embexpr_end'>}</span><span class='tstring_content'> || !vm_cc_valid_p(cc, cc_cme, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opt_class_of'>opt_class_of</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RBASIC_CLASS</span><span class='tstring_end'>&#39;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>CLASS_OF</span><span class='tstring_end'>&#39;</span></span><span class='embexpr_end'>}</span><span class='tstring_content'>(recv)))) {\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;pc = original_body_iseq + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        goto send_cancel;\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>

    <span class='comment'># JIT: move sp and pc if necessary
</span>    <span class='id identifier rubyid_pc_moved_p'>pc_moved_p</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_pc_and_sp'><a href="#compile_pc_and_sp-instance_method" title="RubyVM::MJIT::Compiler#compile_pc_and_sp (method)">compile_pc_and_sp</a></span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_insn'>insn</span><span class='comma'>,</span> <span class='id identifier rubyid_stack_size'>stack_size</span><span class='comma'>,</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='comma'>,</span> <span class='id identifier rubyid_local_stack_p'>local_stack_p</span><span class='comma'>,</span> <span class='id identifier rubyid_next_pos'>next_pos</span>)

    <span class='comment'># JIT: If ISeq is inlinable, call the inlined method without pushing a frame.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_iseq'>iseq</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_inlined_iseqs'>inlined_iseqs</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>==</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_inlined_iseqs'>inlined_iseqs</span>[<span class='id identifier rubyid_pos'>pos</span>]<span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    {\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        VALUE orig_self = reg_cfp-&gt;self;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;self = stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>];\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>] = _mjit</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compiled_id'>compiled_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>_inlined_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>(ec, reg_cfp, orig_self, original_iseq);\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;self = orig_self;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='comment'># JIT: Forked `vm_sendish` (except method_explorer = vm_search_method_wrap) to inline various things
</span>      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    {\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        VALUE val;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        struct rb_calling_info calling;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_send'>send</span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        calling.block_handler = vm_caller_setup_arg_block(ec, reg_cfp, (const struct rb_callinfo *)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ci'>ci</span><span class='embexpr_end'>}</span><span class='tstring_content'>, (rb_iseq_t *)0x</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_operands'>operands</span>[<span class='int'>1</span>].<span class='id identifier rubyid_to_s'>to_s</span>(<span class='int'>16</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>, FALSE);\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        calling.block_handler = VM_BLOCK_HANDLER_NONE;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        calling.kw_splat = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_kw_splat'>kw_splat</span> <span class='op'>?</span> <span class='int'>1</span> <span class='op'>:</span> <span class='int'>0</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        calling.recv = stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>];\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        calling.argc = </span><span class='embexpr_beg'>#{</span><span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_vm_ci_argc'>vm_ci_argc</span>(<span class='id identifier rubyid_ci'>ci</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>

      <span class='kw'>if</span> <span class='id identifier rubyid_vm_cc_cme'><a href="#vm_cc_cme-instance_method" title="RubyVM::MJIT::Compiler#vm_cc_cme (method)">vm_cc_cme</a></span>(<span class='id identifier rubyid_captured_cc'>captured_cc</span>).<span class='id identifier rubyid_def'>def</span>.<span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>VM_METHOD_TYPE_CFUNC</span>
        <span class='comment'># TODO: optimize this more
</span>        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        calling.ci = (const struct rb_callinfo *)</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ci'>ci</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># creating local cd here because operand&#39;s cd-&gt;cc may not be the same as inlined cc.
</span>        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        calling.cc = cc;</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        val = vm_call_cfunc_with_frame(ec, reg_cfp, &amp;calling);\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span> <span class='comment'># :iseq
</span>        <span class='comment'># fastpath_applied_iseq_p checks rb_simple_iseq_p, which ensures has_opt == FALSE
</span>        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        vm_call_iseq_setup_normal(ec, reg_cfp, &amp;calling, cc_cme, 0, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_param'>param</span>.<span class='id identifier rubyid_size'>size</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_local_table_size'>local_table_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>);\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>if</span> <span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_catch_except_p'>catch_except_p</span>
          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        VM_ENV_FLAGS_SET(ec-&gt;cfp-&gt;ep, VM_FRAME_FLAG_FINISH);\n</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        val = vm_exec(ec, true);\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        if ((val = jit_exec(ec)) == Qundef) {\n</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>            VM_ENV_FLAGS_SET(ec-&gt;cfp-&gt;ep, VM_FRAME_FLAG_FINISH);\n</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># This is vm_call0_body&#39;s code after vm_call_iseq_setup
</span>          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>            val = vm_exec(ec, false);\n</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        }\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        stack[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>] = val;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>

      <span class='comment'># JIT: We should evaluate ISeq modified for TracePoint if it&#39;s enabled. Note: This is slow.
</span>      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    if (UNLIKELY(!mjit_call_p)) {\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;sp = vm_base_ptr(reg_cfp) + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stack_size'>stack_size</span> <span class='op'>+</span> <span class='id identifier rubyid_sp_inc'>sp_inc</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_pc_moved_p'>pc_moved_p</span>
        <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        reg_cfp-&gt;pc = original_body_iseq + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_next_pos'>next_pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>        goto cancel;\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    }\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>}\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='id identifier rubyid_src'>src</span>
  <span class='kw'>else</span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="def_iseq_ptr-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>def_iseq_ptr</strong>(method_def)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L839-L841'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='839' data-end='841'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 839</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_def_iseq_ptr'>def_iseq_ptr</span>(<span class='id identifier rubyid_method_def'>method_def</span>)
  <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_iseq_check'>rb_iseq_check</span>(<span class='id identifier rubyid_method_def'>method_def</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_iseqptr'>iseqptr</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="expand_simple_macros-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>expand_simple_macros</strong>(arg_expr)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Expand simple macro that doesn’t require dynamic <a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a> code.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L791-L812'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='791' data-end='812'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 791</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_expand_simple_macros'>expand_simple_macros</span>(<span class='id identifier rubyid_arg_expr'>arg_expr</span>)
  <span class='id identifier rubyid_arg_expr'>arg_expr</span>.<span class='id identifier rubyid_dup'>dup</span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_expr'>expr</span><span class='op'>|</span>
    <span class='comment'># For `leave`. We can&#39;t proceed next ISeq in the same JIT function.
</span>    <span class='id identifier rubyid_expr'>expr</span>.<span class='id identifier rubyid_gsub!'>gsub!</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^(?&lt;indent&gt;\s*)RESTORE_REGS\(\);\n</span><span class='regexp_end'>/</span></span>) <span class='kw'>do</span>
      <span class='id identifier rubyid_indent'>indent</span> <span class='op'>=</span> <span class='const'>Regexp</span>.<span class='id identifier rubyid_last_match'>last_match</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_indent'>indent</span>]
      <span class='heredoc_beg'>&lt;&lt;-end</span>.<span class='id identifier rubyid_gsub'>gsub</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^ {12}</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>)
<span class='tstring_content'>        #if OPT_CALL_THREADED_CODE
        </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_indent'>indent</span><span class='embexpr_end'>}</span><span class='tstring_content'>rb_ec_thread_ptr(ec)-&gt;retval = val;
        </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_indent'>indent</span><span class='embexpr_end'>}</span><span class='tstring_content'>return 0;
        #else
        </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_indent'>indent</span><span class='embexpr_end'>}</span><span class='tstring_content'>return val;
        #endif
</span><span class='heredoc_end'>      end
</span>    <span class='kw'>end</span>
    <span class='id identifier rubyid_expr'>expr</span>.<span class='id identifier rubyid_gsub!'>gsub!</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^(?&lt;indent&gt;\s*)NEXT_INSN\(\);\n</span><span class='regexp_end'>/</span></span>) <span class='kw'>do</span>
      <span class='id identifier rubyid_indent'>indent</span> <span class='op'>=</span> <span class='const'>Regexp</span>.<span class='id identifier rubyid_last_match'>last_match</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_indent'>indent</span>]
      <span class='heredoc_beg'>&lt;&lt;-end</span>.<span class='id identifier rubyid_gsub'>gsub</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^ {12}</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>)
<span class='tstring_content'>        </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_indent'>indent</span><span class='embexpr_end'>}</span><span class='tstring_content'>UNREACHABLE_RETURN(Qundef);
</span><span class='heredoc_end'>      end
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="has_valid_method_type?-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>has_valid_method_type?</strong>(cc)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L865-L867'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='865' data-end='867'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 865</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_has_valid_method_type?'>has_valid_method_type?</span>(<span class='id identifier rubyid_cc'>cc</span>)
  <span class='id identifier rubyid_vm_cc_cme'><a href="#vm_cc_cme-instance_method" title="RubyVM::MJIT::Compiler#vm_cc_cme (method)">vm_cc_cme</a></span>(<span class='id identifier rubyid_cc'>cc</span>) <span class='op'>!=</span> <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="init_compile_status-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>init_compile_status</strong>(status, body, compile_root_p)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L749-L775'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='749' data-end='775'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 749</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_init_compile_status'>init_compile_status</span>(<span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_compile_root_p'>compile_root_p</span>)
  <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_stack_size_for_pos'>stack_size_for_pos</span> <span class='op'>=</span> <span class='const'>Fiddle</span>.<span class='id identifier rubyid_malloc'>malloc</span>(<span class='const'>Fiddle</span><span class='op'>::</span><span class='const'>SIZEOF_INT</span> <span class='op'>*</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_size'>iseq_size</span>)
  <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_size'>iseq_size</span>.<span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_stack_size_for_pos'>stack_size_for_pos</span>[<span class='id identifier rubyid_i'>i</span>] <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>NOT_COMPILED_STACK_SIZE</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_compile_root_p'>compile_root_p</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_inlined_iseqs'>inlined_iseqs</span> <span class='op'>=</span> <span class='const'>Fiddle</span>.<span class='id identifier rubyid_malloc'>malloc</span>(<span class='const'>Fiddle</span><span class='op'>::</span><span class='const'>SIZEOF_VOIDP</span> <span class='op'>*</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_size'>iseq_size</span>)
    <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_size'>iseq_size</span>.<span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
      <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_inlined_iseqs'>inlined_iseqs</span>[<span class='id identifier rubyid_i'>i</span>] <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_ci_size'>ci_size</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_cc_entries_index'>cc_entries_index</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_mjit_capture_cc_entries'>mjit_capture_cc_entries</span>(<span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compiled_iseq'>compiled_iseq</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_cc_entries_index'>cc_entries_index</span> <span class='op'>=</span> <span class='op'>-</span><span class='int'>1</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_compile_root_p'>compile_root_p</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span> <span class='op'>=</span> <span class='id identifier rubyid_rb_mjit_iseq_compile_info'><a href="#rb_mjit_iseq_compile_info-instance_method" title="RubyVM::MJIT::Compiler#rb_mjit_iseq_compile_info (method)">rb_mjit_iseq_compile_info</a></span>(<span class='id identifier rubyid_body'>body</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span> <span class='op'>=</span> <span class='const'>Fiddle</span>.<span class='id identifier rubyid_malloc'>malloc</span>(<span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_mjit_compile_info'>rb_mjit_compile_info</span>.<span class='id identifier rubyid_sizeof'>sizeof</span>)
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_ivar_cache'>disable_ivar_cache</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_exivar_cache'>disable_exivar_cache</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_send_cache'>disable_send_cache</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_inlining'>disable_inlining</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>.<span class='id identifier rubyid_disable_const_cache'>disable_const_cache</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="inlinable_iseq_p-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>inlinable_iseq_p</strong>(body)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return true if the ISeq can be inlined without pushing a new control frame.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L886-L931'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='886' data-end='931'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 886</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_inlinable_iseq_p'>inlinable_iseq_p</span>(<span class='id identifier rubyid_body'>body</span>)
  <span class='comment'># 1) If catch_except_p, caller frame should be preserved when callee catches an exception.
</span>  <span class='comment'># Then we need to wrap `vm_exec()` but then we can&#39;t inline the call inside it.
</span>  <span class='comment'>#
</span>  <span class='comment'># 2) If `body-&gt;catch_except_p` is false and `handles_sp?` of an insn is false,
</span>  <span class='comment'># sp is not moved as we assume `status-&gt;local_stack_p = !body-&gt;catch_except_p`.
</span>  <span class='comment'>#
</span>  <span class='comment'># 3) If `body-&gt;catch_except_p` is false and `always_leaf?` of an insn is true,
</span>  <span class='comment'># pc is not moved.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_catch_except_p'>catch_except_p</span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_pos'>pos</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_pos'>pos</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_size'>iseq_size</span>
    <span class='id identifier rubyid_insn'>insn</span> <span class='op'>=</span> <span class='const'><a href="#INSNS-constant" title="RubyVM::MJIT::Compiler::INSNS (constant)">INSNS</a></span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_vm_insn_decode'>rb_vm_insn_decode</span>(<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_encoded'>iseq_encoded</span>[<span class='id identifier rubyid_pos'>pos</span>]))
    <span class='comment'># All insns in the ISeq except `leave` (to be overridden in the inlined code)
</span>    <span class='comment'># should meet following strong assumptions:
</span>    <span class='comment'>#   * Do not require `cfp-&gt;sp` motion
</span>    <span class='comment'>#   * Do not move `cfp-&gt;pc`
</span>    <span class='comment'>#   * Do not read any `cfp-&gt;pc`
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invokebuiltin'>invokebuiltin</span> <span class='op'>||</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_invokebuiltin_delegate'>opt_invokebuiltin_delegate</span> <span class='op'>||</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_invokebuiltin_delegate_leave'>opt_invokebuiltin_delegate_leave</span>
      <span class='comment'># builtin insn&#39;s inlinability is handled by `Primitive.attr! &#39;inline&#39;` per iseq
</span>      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_builtin_inline_p'>builtin_inline_p</span>
        <span class='kw'>return</span> <span class='kw'>false</span><span class='semicolon'>;</span>
      <span class='kw'>end</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>!=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_leave'>leave</span> <span class='op'>&amp;&amp;</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_insn_may_depend_on_sp_or_pc'>insn_may_depend_on_sp_or_pc</span>(<span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_bin'>bin</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_encoded'>iseq_encoded</span> <span class='op'>+</span> (<span class='id identifier rubyid_pos'>pos</span> <span class='op'>+</span> <span class='int'>1</span>))
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
    <span class='comment'># At this moment, `cfp-&gt;ep` in an inlined method is not working.
</span>    <span class='kw'>case</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span>
    <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_getlocal'>getlocal</span><span class='comma'>,</span>
         <span class='symbeg'>:</span><span class='id identifier rubyid_getlocal_WC_0'>getlocal_WC_0</span><span class='comma'>,</span>
         <span class='symbeg'>:</span><span class='id identifier rubyid_getlocal_WC_1'>getlocal_WC_1</span><span class='comma'>,</span>
         <span class='symbeg'>:</span><span class='id identifier rubyid_setlocal'>setlocal</span><span class='comma'>,</span>
         <span class='symbeg'>:</span><span class='id identifier rubyid_setlocal_WC_0'>setlocal_WC_0</span><span class='comma'>,</span>
         <span class='symbeg'>:</span><span class='id identifier rubyid_setlocal_WC_1'>setlocal_WC_1</span><span class='comma'>,</span>
         <span class='symbeg'>:</span><span class='id identifier rubyid_getblockparam'>getblockparam</span><span class='comma'>,</span>
         <span class='symbeg'>:</span><span class='id identifier rubyid_getblockparamproxy'>getblockparamproxy</span><span class='comma'>,</span>
         <span class='symbeg'>:</span><span class='id identifier rubyid_setblockparam'>setblockparam</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_pos'>pos</span> <span class='op'>+=</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_len'>len</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ISEQ_IS_SIZE-instance_method">
  <h3 class='signature priv  nodoc'>
    <strong>ISEQ_IS_SIZE</strong>(body)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L847-L849'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='847' data-end='849'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 847</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='const'>ISEQ_IS_SIZE</span>(<span class='id identifier rubyid_body'>body</span>)
  <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_ic_size'>ic_size</span> <span class='op'>+</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_ivc_size'>ivc_size</span> <span class='op'>+</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_ise_size'>ise_size</span> <span class='op'>+</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_icvarc_size'>icvarc_size</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="maybe_special_const?-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>maybe_special_const?</strong>(klass)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return true if an object of the class may be a special const (immediate). It’s “maybe” because Integer and Float are not guaranteed to be an immediate. If this returns false, rb_class_of could be optimzied to RBASIC_CLASS.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L854-L863'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='854' data-end='863'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 854</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_maybe_special_const?'>maybe_special_const?</span>(<span class='id identifier rubyid_klass'>klass</span>)
  [
    <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_cFalseClass'>rb_cFalseClass</span><span class='comma'>,</span>
    <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_cNilClass'>rb_cNilClass</span><span class='comma'>,</span>
    <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_cTrueClass'>rb_cTrueClass</span><span class='comma'>,</span>
    <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_cInteger'>rb_cInteger</span><span class='comma'>,</span>
    <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_cSymbol'>rb_cSymbol</span><span class='comma'>,</span>
    <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_cFloat'>rb_cFloat</span><span class='comma'>,</span>
  ].<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_klass'>klass</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="parent_shape_id-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>parent_shape_id</strong>(shape_id)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L940-L951'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='940' data-end='951'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 940</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_parent_shape_id'>parent_shape_id</span>(<span class='id identifier rubyid_shape_id'>shape_id</span>)
  <span class='kw'>return</span> <span class='id identifier rubyid_shape_id'>shape_id</span> <span class='kw'>if</span> <span class='id identifier rubyid_shape_id'>shape_id</span> <span class='op'>==</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>INVALID_SHAPE_ID</span>

  <span class='id identifier rubyid_parent_id'>parent_id</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_shape_get_shape_by_id'>rb_shape_get_shape_by_id</span>(<span class='id identifier rubyid_shape_id'>shape_id</span>).<span class='id identifier rubyid_parent_id'>parent_id</span>
  <span class='id identifier rubyid_parent'>parent</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_shape_get_shape_by_id'>rb_shape_get_shape_by_id</span>(<span class='id identifier rubyid_parent_id'>parent_id</span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_parent'>parent</span>.<span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>SHAPE_CAPACITY_CHANGE</span>
    <span class='id identifier rubyid_parent'>parent</span>.<span class='id identifier rubyid_parent_id'>parent_id</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_parent_id'>parent_id</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="precompile_inlinable_child_iseq-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>precompile_inlinable_child_iseq</strong>(src, child_iseq, status, ci, cc, pos)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L696-L719'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='696' data-end='719'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 696</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_precompile_inlinable_child_iseq'>precompile_inlinable_child_iseq</span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_child_iseq'>child_iseq</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_ci'>ci</span><span class='comma'>,</span> <span class='id identifier rubyid_cc'>cc</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span>)
  <span class='id identifier rubyid_child_status'>child_status</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_compile_status'>compile_status</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="RubyVM::MJIT::Compiler.new (method)">new</a></span> <span class='comment'># not freed for now
</span>  <span class='id identifier rubyid_child_status'>child_status</span>.<span class='id identifier rubyid_compiled_iseq'>compiled_iseq</span> <span class='op'>=</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compiled_iseq'>compiled_iseq</span>
  <span class='id identifier rubyid_child_status'>child_status</span>.<span class='id identifier rubyid_compiled_id'>compiled_id</span> <span class='op'>=</span> <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compiled_id'>compiled_id</span>
  <span class='id identifier rubyid_init_compile_status'><a href="#init_compile_status-instance_method" title="RubyVM::MJIT::Compiler#init_compile_status (method)">init_compile_status</a></span>(<span class='id identifier rubyid_child_status'>child_status</span><span class='comma'>,</span> <span class='id identifier rubyid_child_iseq'>child_iseq</span>.<span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='kw'>false</span>) <span class='comment'># not freed for now
</span>  <span class='id identifier rubyid_child_status'>child_status</span>.<span class='id identifier rubyid_inline_context'>inline_context</span>.<span class='id identifier rubyid_orig_argc'>orig_argc</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_vm_ci_argc'>vm_ci_argc</span>(<span class='id identifier rubyid_ci'>ci</span>)
  <span class='id identifier rubyid_child_status'>child_status</span>.<span class='id identifier rubyid_inline_context'>inline_context</span>.<span class='id identifier rubyid_me'>me</span> <span class='op'>=</span> <span class='id identifier rubyid_vm_cc_cme'><a href="#vm_cc_cme-instance_method" title="RubyVM::MJIT::Compiler#vm_cc_cme (method)">vm_cc_cme</a></span>(<span class='id identifier rubyid_cc'>cc</span>).<span class='id identifier rubyid_to_i'>to_i</span>
  <span class='id identifier rubyid_child_status'>child_status</span>.<span class='id identifier rubyid_inline_context'>inline_context</span>.<span class='id identifier rubyid_param_size'>param_size</span> <span class='op'>=</span> <span class='id identifier rubyid_child_iseq'>child_iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_param'>param</span>.<span class='id identifier rubyid_size'>size</span>
  <span class='id identifier rubyid_child_status'>child_status</span>.<span class='id identifier rubyid_inline_context'>inline_context</span>.<span class='id identifier rubyid_local_size'>local_size</span> <span class='op'>=</span> <span class='id identifier rubyid_child_iseq'>child_iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_local_table_size'>local_table_size</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_child_iseq'>child_iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_ci_size'>ci_size</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_child_status'>child_status</span>.<span class='id identifier rubyid_cc_entries_index'>cc_entries_index</span> <span class='op'>==</span> <span class='op'>-</span><span class='int'>1</span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ALWAYS_INLINE(static VALUE _mjit</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compiled_id'>compiled_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>_inlined_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>(rb_execution_context_t *ec, rb_control_frame_t *reg_cfp, const VALUE orig_self, const rb_iseq_t *original_iseq));\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>static inline VALUE\n_mjit</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compiled_id'>compiled_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>_inlined_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'>(rb_execution_context_t *ec, rb_control_frame_t *reg_cfp, const VALUE orig_self, const rb_iseq_t *original_iseq)\n{\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    const VALUE *orig_pc = reg_cfp-&gt;pc;\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    VALUE *orig_sp = reg_cfp-&gt;sp;\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_success'>success</span> <span class='op'>=</span> <span class='id identifier rubyid_compile_body'><a href="#compile_body-instance_method" title="RubyVM::MJIT::Compiler#compile_body (method)">compile_body</a></span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_child_iseq'>child_iseq</span><span class='comma'>,</span> <span class='id identifier rubyid_child_status'>child_status</span>)

  <span class='id identifier rubyid_src'>src</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n} /* end of _mjit</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_compiled_id'>compiled_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>_inlined_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pos'>pos</span><span class='embexpr_end'>}</span><span class='tstring_content'> */\n\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='kw'>return</span> <span class='id identifier rubyid_success'>success</span><span class='semicolon'>;</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="precompile_inlinable_iseqs-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>precompile_inlinable_iseqs</strong>(src, iseq, status)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L721-L747'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='721' data-end='747'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 721</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_precompile_inlinable_iseqs'>precompile_inlinable_iseqs</span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_iseq'>iseq</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span>)
  <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>
  <span class='id identifier rubyid_pos'>pos</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_pos'>pos</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_size'>iseq_size</span>
    <span class='id identifier rubyid_insn'>insn</span> <span class='op'>=</span> <span class='const'><a href="#INSNS-constant" title="RubyVM::MJIT::Compiler::INSNS (constant)">INSNS</a></span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_vm_insn_decode'>rb_vm_insn_decode</span>(<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_encoded'>iseq_encoded</span>[<span class='id identifier rubyid_pos'>pos</span>]))
    <span class='kw'>if</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_send_without_block'>opt_send_without_block</span> <span class='op'>||</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_opt_size'>opt_size</span> <span class='comment'># `compile_inlined_cancel_handler` supports only `opt_send_without_block`
</span>      <span class='id identifier rubyid_cd'>cd</span> <span class='op'>=</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>CALL_DATA</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="RubyVM::MJIT::Compiler.new (method)">new</a></span>(<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_encoded'>iseq_encoded</span>[<span class='id identifier rubyid_pos'>pos</span> <span class='op'>+</span> <span class='int'>1</span>])
      <span class='id identifier rubyid_ci'>ci</span> <span class='op'>=</span> <span class='id identifier rubyid_cd'>cd</span>.<span class='id identifier rubyid_ci'>ci</span>
      <span class='id identifier rubyid_cc'>cc</span> <span class='op'>=</span> <span class='id identifier rubyid_captured_cc_entries'><a href="#captured_cc_entries-instance_method" title="RubyVM::MJIT::Compiler#captured_cc_entries (method)">captured_cc_entries</a></span>(<span class='id identifier rubyid_status'>status</span>)[<span class='id identifier rubyid_call_data_index'><a href="#call_data_index-instance_method" title="RubyVM::MJIT::Compiler#call_data_index (method)">call_data_index</a></span>(<span class='id identifier rubyid_cd'>cd</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)] <span class='comment'># use copy to avoid race condition
</span>
      <span class='kw'>if</span> (<span class='id identifier rubyid_child_iseq'>child_iseq</span> <span class='op'>=</span> <span class='id identifier rubyid_rb_mjit_inlinable_iseq'><a href="#rb_mjit_inlinable_iseq-instance_method" title="RubyVM::MJIT::Compiler#rb_mjit_inlinable_iseq (method)">rb_mjit_inlinable_iseq</a></span>(<span class='id identifier rubyid_ci'>ci</span><span class='comma'>,</span> <span class='id identifier rubyid_cc'>cc</span>)) <span class='op'>!=</span> <span class='kw'>nil</span>
        <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_inlined_iseqs'>inlined_iseqs</span>[<span class='id identifier rubyid_pos'>pos</span>] <span class='op'>=</span> <span class='id identifier rubyid_child_iseq'>child_iseq</span>.<span class='id identifier rubyid_body'>body</span>

        <span class='kw'>if</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_mjit_opts'>mjit_opts</span>.<span class='id identifier rubyid_verbose'>verbose</span> <span class='op'>&gt;=</span> <span class='int'>1</span> <span class='comment'># print beforehand because ISeq may be GCed during copy job.
</span>          <span class='id identifier rubyid_child_location'>child_location</span> <span class='op'>=</span> <span class='id identifier rubyid_child_iseq'>child_iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_location'>location</span>
          <span class='gvar'>$stderr</span>.<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>JIT inline: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_child_location'>child_location</span>.<span class='id identifier rubyid_label'>label</span><span class='embexpr_end'>}</span><span class='tstring_content'>@</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_iseq_path'>rb_iseq_path</span>(<span class='id identifier rubyid_child_iseq'>child_iseq</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_iseq_first_lineno'>rb_iseq_first_lineno</span>(<span class='id identifier rubyid_child_iseq'>child_iseq</span>)<span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> \
            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>=&gt; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_location'>location</span>.<span class='id identifier rubyid_label'>label</span><span class='embexpr_end'>}</span><span class='tstring_content'>@</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_iseq_path'>rb_iseq_path</span>(<span class='id identifier rubyid_iseq'>iseq</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_iseq_first_lineno'>rb_iseq_first_lineno</span>(<span class='id identifier rubyid_iseq'>iseq</span>)<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
        <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_precompile_inlinable_child_iseq'><a href="#precompile_inlinable_child_iseq-instance_method" title="RubyVM::MJIT::Compiler#precompile_inlinable_child_iseq (method)">precompile_inlinable_child_iseq</a></span>(<span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_child_iseq'>child_iseq</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_ci'>ci</span><span class='comma'>,</span> <span class='id identifier rubyid_cc'>cc</span><span class='comma'>,</span> <span class='id identifier rubyid_pos'>pos</span>)
          <span class='kw'>return</span> <span class='kw'>false</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_pos'>pos</span> <span class='op'>+=</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_len'>len</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="rb_mjit_inlinable_iseq-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>rb_mjit_inlinable_iseq</strong>(ci, cc)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return an iseq pointer if cc has inlinable iseq.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L874-L883'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='874' data-end='883'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 874</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_rb_mjit_inlinable_iseq'>rb_mjit_inlinable_iseq</span>(<span class='id identifier rubyid_ci'>ci</span><span class='comma'>,</span> <span class='id identifier rubyid_cc'>cc</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_has_valid_method_type?'><a href="#has_valid_method_type%3F-instance_method" title="RubyVM::MJIT::Compiler#has_valid_method_type? (method)">has_valid_method_type?</a></span>(<span class='id identifier rubyid_cc'>cc</span>) <span class='op'>&amp;&amp;</span>
      <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_vm_ci_flag'>vm_ci_flag</span>(<span class='id identifier rubyid_ci'>ci</span>) <span class='op'>&amp;</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>VM_CALL_TAILCALL</span> <span class='op'>==</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span> <span class='comment'># inlining only non-tailcall path
</span>      <span class='id identifier rubyid_vm_cc_cme'><a href="#vm_cc_cme-instance_method" title="RubyVM::MJIT::Compiler#vm_cc_cme (method)">vm_cc_cme</a></span>(<span class='id identifier rubyid_cc'>cc</span>).<span class='id identifier rubyid_def'>def</span>.<span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='const'>VM_METHOD_TYPE_ISEQ</span> <span class='op'>&amp;&amp;</span>
      <span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_fastpath_applied_iseq_p'>fastpath_applied_iseq_p</span>(<span class='id identifier rubyid_ci'>ci</span><span class='comma'>,</span> <span class='id identifier rubyid_cc'>cc</span><span class='comma'>,</span> <span class='id identifier rubyid_iseq'>iseq</span> <span class='op'>=</span> <span class='id identifier rubyid_def_iseq_ptr'><a href="#def_iseq_ptr-instance_method" title="RubyVM::MJIT::Compiler#def_iseq_ptr (method)">def_iseq_ptr</a></span>(<span class='id identifier rubyid_vm_cc_cme'><a href="#vm_cc_cme-instance_method" title="RubyVM::MJIT::Compiler#vm_cc_cme (method)">vm_cc_cme</a></span>(<span class='id identifier rubyid_cc'>cc</span>).<span class='id identifier rubyid_def'>def</span>)) <span class='op'>&amp;&amp;</span>
      <span class='id identifier rubyid_inlinable_iseq_p'><a href="#inlinable_iseq_p-instance_method" title="RubyVM::MJIT::Compiler#inlinable_iseq_p (method)">inlinable_iseq_p</a></span>(<span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_body'>body</span>) <span class='comment'># CC_SET_FASTPATH in vm_callee_setup_arg
</span>    <span class='kw'>return</span> <span class='id identifier rubyid_iseq'>iseq</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="rb_mjit_iseq_compile_info-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>rb_mjit_iseq_compile_info</strong>(body)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L843-L845'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='843' data-end='845'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 843</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_rb_mjit_iseq_compile_info'>rb_mjit_iseq_compile_info</span>(<span class='id identifier rubyid_body'>body</span>)
  <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_mjit_unit'>mjit_unit</span>.<span class='id identifier rubyid_compile_info'>compile_info</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="to_addr-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>to_addr</strong>(struct)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p><a href="CPointer/Struct.html" title="RubyVM::MJIT::CPointer::Struct (class)"><code>CPointer::Struct</code></a> could be nil on field reference, and this is a helper to handle that case while using <a href="CPointer/Struct.html#to_s-instance_method" title="RubyVM::MJIT::CPointer::Struct#to_s (method)">CPointer::Struct#to_s</a> in most cases.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>struct</span>
    <span class='type'>(<a href="CPointer/Struct.html" title="RubyVM::MJIT::CPointer::Struct (class)">RubyVM::MJIT::CPointer::Struct</a>)</span>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L936-L938'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='936' data-end='938'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 936</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_to_addr'>to_addr</span>(<span class='id identifier rubyid_struct'>struct</span>)
  <span class='id identifier rubyid_struct'>struct</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>NULL</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="to_cstr-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>to_cstr</strong>(expr)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L814-L816'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='814' data-end='816'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 814</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_to_cstr'>to_cstr</span>(<span class='id identifier rubyid_expr'>expr</span>)
  <span class='id identifier rubyid_expr'>expr</span>.<span class='id identifier rubyid_gsub'>gsub</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^(?!#)</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>    </span><span class='tstring_end'>&#39;</span></span>) <span class='comment'># indent everything but preprocessor lines
</span><span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="using_ivar?-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>using_ivar?</strong>(body)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L777-L788'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='777' data-end='788'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 777</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_using_ivar?'>using_ivar?</span>(<span class='id identifier rubyid_body'>body</span>)
  <span class='id identifier rubyid_pos'>pos</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_pos'>pos</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_size'>iseq_size</span>
    <span class='id identifier rubyid_insn'>insn</span> <span class='op'>=</span> <span class='const'><a href="#INSNS-constant" title="RubyVM::MJIT::Compiler::INSNS (constant)">INSNS</a></span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='const'><a href="#C-constant" title="RubyVM::MJIT::Compiler::C (constant)">C</a></span>.<span class='id identifier rubyid_rb_vm_insn_decode'>rb_vm_insn_decode</span>(<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_iseq_encoded'>iseq_encoded</span>[<span class='id identifier rubyid_pos'>pos</span>]))
    <span class='kw'>case</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_name'>name</span>
    <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_getinstancevariable'>getinstancevariable</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_setinstancevariable'>setinstancevariable</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_pos'>pos</span> <span class='op'>+=</span> <span class='id identifier rubyid_insn'>insn</span>.<span class='id identifier rubyid_len'>len</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='kw'>false</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="vm_cc_cme-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>vm_cc_cme</strong>(cc)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_2_9/lib/ruby_vm/mjit/compiler.rb#L834-L837'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='834' data-end='837'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/ruby_vm/mjit/compiler.rb', line 834</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_vm_cc_cme'>vm_cc_cme</span>(<span class='id identifier rubyid_cc'>cc</span>)
  <span class='comment'># TODO: add VM_ASSERT like actual vm_cc_cme
</span>  <span class='id identifier rubyid_cc'>cc</span>.<span class='id identifier rubyid_cme_'>cme_</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>