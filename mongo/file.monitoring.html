<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Monitoring &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "monitoring",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Mongo master</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Monitoring&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>Monitoring</h1>

<p>The driver allows the application to be notified when certain events happen.
These events are organized into the following categories:</p>

<ul>
<li>  Command monitoring</li>
<li>  Topology lifecycle</li>
<li>  Server lifecycle</li>
<li>  Server heartbeats</li>
<li>  Connection pools and connections</li>
</ul>

<p>Topology and server events are part of Server Discovery and Monitoring (SDAM).</p>

<h2>Command Monitoring</h2>

<p>All user-initiated commands that are sent to the server publish events that
can be subscribed to for fine grained information. The monitoring API
publishes a guaranteed start event for each command, then either a succeeded
or a failed event. A subscriber must implement 3 methods: <code>started</code>,
<code>succeeded</code>, and <code>failed</code>, each which takes a single parameter for
the event. The following is an example logging subscriber based on a
logging subscriber used internally by the driver:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CommandLogSubscriber</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Loggable.html" title="Mongo::Loggable (module)">Loggable</a></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_started'>started</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='comment'># The default inspection of a command which is a BSON document gets
</span>    <span class='comment'># truncated in the middle. To get the full rendering of the command, the
</span>    <span class='comment'># {to_json} method can be called on the document.
</span>    <span class='id identifier rubyid_log_debug'>log_debug</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_prefix'>prefix</span>(<span class='id identifier rubyid_event'>event</span>)<span class='embexpr_end'>}</span><span class='tstring_content'> | STARTED | </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_format_command'>format_command</span>(<span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_command'>command</span>.<span class='id identifier rubyid_to_json'>to_json</span>)<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_succeeded'>succeeded</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='id identifier rubyid_log_debug'>log_debug</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_prefix'>prefix</span>(<span class='id identifier rubyid_event'>event</span>)<span class='embexpr_end'>}</span><span class='tstring_content'> | SUCCEEDED | </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_duration'>duration</span><span class='embexpr_end'>}</span><span class='tstring_content'>s</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_failed'>failed</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='id identifier rubyid_log_debug'>log_debug</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_prefix'>prefix</span>(<span class='id identifier rubyid_event'>event</span>)<span class='embexpr_end'>}</span><span class='tstring_content'> | FAILED | </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> | </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_duration'>duration</span><span class='embexpr_end'>}</span><span class='tstring_content'>s</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_logger'>logger</span>
    <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Logger.html" title="Mongo::Logger (class)">Logger</a></span>.<span class='id identifier rubyid_logger'><a href="Mongo/Logger.html#logger-class_method" title="Mongo::Logger.logger (method)">logger</a></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_format_command'>format_command</span>(<span class='id identifier rubyid_args'>args</span>)
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_args'>args</span>.<span class='id identifier rubyid_inspect'>inspect</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&lt;Unable to inspect arguments&gt;</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_format_message'>format_message</span>(<span class='id identifier rubyid_message'>message</span>)
    <span class='id identifier rubyid_format'>format</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>COMMAND | %s</span><span class='tstring_end'>&quot;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_prefix'>prefix</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> | </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_database_name'>database_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_command_name'>command_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>To register a custom subscriber, you can do so globally for
all clients or on a per-client basis:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_subscriber'>subscriber</span> <span class='op'>=</span> <span class='const'>CommandLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>

<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/Global.html" title="Mongo::Monitoring::Global (module)">Global</a></span>.<span class='id identifier rubyid_subscribe'><a href="Mongo/Monitoring/Subscribable.html#subscribe-instance_method" title="Mongo::Monitoring::Subscribable#subscribe (method)">subscribe</a></span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#COMMAND-constant" title="Mongo::Monitoring::COMMAND (constant)">COMMAND</a></span><span class='comma'>,</span> <span class='id identifier rubyid_subscriber'>subscriber</span>)

<span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test</span><span class='tstring_end'>&#39;</span></span> )
<span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_subscribe'>subscribe</span>( <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#COMMAND-constant" title="Mongo::Monitoring::COMMAND (constant)">COMMAND</a></span><span class='comma'>,</span> <span class='id identifier rubyid_subscriber'>subscriber</span> )</code></pre>

<p>Sample output:</p>

<pre class="code none"><code class="none">D, [2018-09-23T13:47:31.258020 #4692] DEBUG -- : COMMAND | 127.0.0.1:27027 | test.hello | STARTED | {&quot;hello&quot;=&gt;1, &quot;$readPreference&quot;=&gt;{&quot;mode&quot;=&gt;&quot;primary&quot;}, &quot;lsid&quot;=&gt;{&quot;id&quot;=&gt;&lt;BSON::Binary:0x47111693353080 type=uuid data=0x730341e880dc40a2...&gt;}}
D, [2018-09-23T13:47:31.259145 #4692] DEBUG -- : COMMAND | 127.0.0.1:27027 | test.hello | SUCCEEDED | 0.000791175s
</code></pre>

<h2>Server Discovery And Monitoring [sdam]</h2>

<p>The Ruby driver implements <a href="https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring">Server Discovery And Monitoring (SDAM) specification</a>.
and makes the following events available to the application:</p>

<ul>
<li>  Topology opening</li>
<li>  Server opening</li>
<li>  Server description changed</li>
<li>  Topology changed</li>
<li>  Server closed</li>
<li>  Topology closed</li>
<li>  Heartbeat events (covered below in a separate section)</li>
</ul>

<p>For all events other than the heartbeat events, the <code>succeeded</code> method
will be called on each event subscriber with the event as the sole argument.
Available data for events varies, therefore to log the events a separate
class is needed for each event type. A simple SDAM logging subscriber
can look like the following:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>SDAMLogSubscriber</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Loggable.html" title="Mongo::Loggable (module)">Loggable</a></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_succeeded'>succeeded</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='id identifier rubyid_log_debug'>log_debug</span>(<span class='id identifier rubyid_format_event'>format_event</span>(<span class='id identifier rubyid_event'>event</span>))
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_logger'>logger</span>
    <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Logger.html" title="Mongo::Logger (class)">Logger</a></span>.<span class='id identifier rubyid_logger'><a href="Mongo/Logger.html#logger-class_method" title="Mongo::Logger.logger (method)">logger</a></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_format_message'>format_message</span>(<span class='id identifier rubyid_message'>message</span>)
    <span class='id identifier rubyid_format'>format</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SDAM | %s</span><span class='tstring_end'>&quot;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>TopologyOpeningLogSubscriber</span> <span class='op'>&lt;</span> <span class='const'>SDAMLogSubscriber</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_format_event'>format_event</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Topology type &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_topology'>topology</span>.<span class='id identifier rubyid_display_name'>display_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; initializing.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>ServerOpeningLogSubscriber</span> <span class='op'>&lt;</span> <span class='const'>SDAMLogSubscriber</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_format_event'>format_event</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_content'> initializing.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>ServerDescriptionChangedLogSubscriber</span> <span class='op'>&lt;</span> <span class='const'>SDAMLogSubscriber</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_format_event'>format_event</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Server description for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_content'> changed from </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_previous_description'>previous_description</span>.<span class='id identifier rubyid_server_type'>server_type</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; to &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_new_description'>new_description</span>.<span class='id identifier rubyid_server_type'>server_type</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>TopologyChangedLogSubscriber</span> <span class='op'>&lt;</span> <span class='const'>SDAMLogSubscriber</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_format_event'>format_event</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_previous_topology'>previous_topology</span> <span class='op'>!=</span> <span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_new_topology'>new_topology</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Topology type &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_previous_topology'>previous_topology</span>.<span class='id identifier rubyid_display_name'>display_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; changed to </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>type &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_new_topology'>new_topology</span>.<span class='id identifier rubyid_display_name'>display_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>There was a change in the members of the &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_new_topology'>new_topology</span>.<span class='id identifier rubyid_display_name'>display_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>topology.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>ServerClosedLogSubscriber</span> <span class='op'>&lt;</span> <span class='const'>SDAMLogSubscriber</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_format_event'>format_event</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_content'> connection closed.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>TopologyClosedLogSubscriber</span> <span class='op'>&lt;</span> <span class='const'>SDAMLogSubscriber</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_format_event'>format_event</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Topology type &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_topology'>topology</span>.<span class='id identifier rubyid_display_name'>display_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; closed.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>To subscribe to SDAM events globally:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_topology_opening_subscriber'>topology_opening_subscriber</span> <span class='op'>=</span> <span class='const'>TopologyOpeningLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_server_opening_subscriber'>server_opening_subscriber</span> <span class='op'>=</span> <span class='const'>ServerOpeningLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_server_description_changed_subscriber'>server_description_changed_subscriber</span> <span class='op'>=</span> <span class='const'>ServerDescriptionChangedLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_topology_changed_subscriber'>topology_changed_subscriber</span> <span class='op'>=</span> <span class='const'>TopologyChangedLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_server_closed_subscriber'>server_closed_subscriber</span> <span class='op'>=</span> <span class='const'>ServerClosedLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_topology_closed_subscriber'>topology_closed_subscriber</span> <span class='op'>=</span> <span class='const'>TopologyClosedLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>

<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/Global.html" title="Mongo::Monitoring::Global (module)">Global</a></span>.<span class='id identifier rubyid_subscribe'><a href="Mongo/Monitoring/Subscribable.html#subscribe-instance_method" title="Mongo::Monitoring::Subscribable#subscribe (method)">subscribe</a></span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#TOPOLOGY_OPENING-constant" title="Mongo::Monitoring::TOPOLOGY_OPENING (constant)">TOPOLOGY_OPENING</a></span><span class='comma'>,</span>
  <span class='id identifier rubyid_topology_opening_subscriber'>topology_opening_subscriber</span>)
<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/Global.html" title="Mongo::Monitoring::Global (module)">Global</a></span>.<span class='id identifier rubyid_subscribe'><a href="Mongo/Monitoring/Subscribable.html#subscribe-instance_method" title="Mongo::Monitoring::Subscribable#subscribe (method)">subscribe</a></span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#SERVER_OPENING-constant" title="Mongo::Monitoring::SERVER_OPENING (constant)">SERVER_OPENING</a></span><span class='comma'>,</span>
  <span class='id identifier rubyid_server_opening_subscriber'>server_opening_subscriber</span>)
<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/Global.html" title="Mongo::Monitoring::Global (module)">Global</a></span>.<span class='id identifier rubyid_subscribe'><a href="Mongo/Monitoring/Subscribable.html#subscribe-instance_method" title="Mongo::Monitoring::Subscribable#subscribe (method)">subscribe</a></span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#SERVER_DESCRIPTION_CHANGED-constant" title="Mongo::Monitoring::SERVER_DESCRIPTION_CHANGED (constant)">SERVER_DESCRIPTION_CHANGED</a></span><span class='comma'>,</span>
  <span class='id identifier rubyid_server_description_changed_subscriber'>server_description_changed_subscriber</span>)
<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/Global.html" title="Mongo::Monitoring::Global (module)">Global</a></span>.<span class='id identifier rubyid_subscribe'><a href="Mongo/Monitoring/Subscribable.html#subscribe-instance_method" title="Mongo::Monitoring::Subscribable#subscribe (method)">subscribe</a></span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#TOPOLOGY_CHANGED-constant" title="Mongo::Monitoring::TOPOLOGY_CHANGED (constant)">TOPOLOGY_CHANGED</a></span><span class='comma'>,</span>
  <span class='id identifier rubyid_topology_changed_subscriber'>topology_changed_subscriber</span>)
<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/Global.html" title="Mongo::Monitoring::Global (module)">Global</a></span>.<span class='id identifier rubyid_subscribe'><a href="Mongo/Monitoring/Subscribable.html#subscribe-instance_method" title="Mongo::Monitoring::Subscribable#subscribe (method)">subscribe</a></span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#SERVER_CLOSED-constant" title="Mongo::Monitoring::SERVER_CLOSED (constant)">SERVER_CLOSED</a></span><span class='comma'>,</span>
  <span class='id identifier rubyid_server_closed_subscriber'>server_closed_subscriber</span>)
<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/Global.html" title="Mongo::Monitoring::Global (module)">Global</a></span>.<span class='id identifier rubyid_subscribe'><a href="Mongo/Monitoring/Subscribable.html#subscribe-instance_method" title="Mongo::Monitoring::Subscribable#subscribe (method)">subscribe</a></span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#TOPOLOGY_CLOSED-constant" title="Mongo::Monitoring::TOPOLOGY_CLOSED (constant)">TOPOLOGY_CLOSED</a></span><span class='comma'>,</span>
  <span class='id identifier rubyid_topology_closed_subscriber'>topology_closed_subscriber</span>)</code></pre>

<p>Subscribing to SDAM events for a single client is a little more involved
since the events may be published during the client&#39;s construction:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_topology_opening_subscriber'>topology_opening_subscriber</span> <span class='op'>=</span> <span class='const'>TopologyOpeningLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_server_opening_subscriber'>server_opening_subscriber</span> <span class='op'>=</span> <span class='const'>ServerOpeningLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_server_description_changed_subscriber'>server_description_changed_subscriber</span> <span class='op'>=</span> <span class='const'>ServerDescriptionChangedLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_topology_changed_subscriber'>topology_changed_subscriber</span> <span class='op'>=</span> <span class='const'>TopologyChangedLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_server_closed_subscriber'>server_closed_subscriber</span> <span class='op'>=</span> <span class='const'>ServerClosedLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_topology_closed_subscriber'>topology_closed_subscriber</span> <span class='op'>=</span> <span class='const'>TopologyClosedLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>

<span class='id identifier rubyid_sdam_proc'>sdam_proc</span> <span class='op'>=</span> <span class='const'>Proc</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_client'>client</span><span class='op'>|</span>
  <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_subscribe'>subscribe</span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#TOPOLOGY_OPENING-constant" title="Mongo::Monitoring::TOPOLOGY_OPENING (constant)">TOPOLOGY_OPENING</a></span><span class='comma'>,</span>
    <span class='id identifier rubyid_topology_opening_subscriber'>topology_opening_subscriber</span>)
  <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_subscribe'>subscribe</span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#SERVER_OPENING-constant" title="Mongo::Monitoring::SERVER_OPENING (constant)">SERVER_OPENING</a></span><span class='comma'>,</span>
    <span class='id identifier rubyid_server_opening_subscriber'>server_opening_subscriber</span>)
  <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_subscribe'>subscribe</span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#SERVER_DESCRIPTION_CHANGED-constant" title="Mongo::Monitoring::SERVER_DESCRIPTION_CHANGED (constant)">SERVER_DESCRIPTION_CHANGED</a></span><span class='comma'>,</span>
    <span class='id identifier rubyid_server_description_changed_subscriber'>server_description_changed_subscriber</span>)
  <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_subscribe'>subscribe</span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#TOPOLOGY_CHANGED-constant" title="Mongo::Monitoring::TOPOLOGY_CHANGED (constant)">TOPOLOGY_CHANGED</a></span><span class='comma'>,</span>
    <span class='id identifier rubyid_topology_changed_subscriber'>topology_changed_subscriber</span>)
  <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_subscribe'>subscribe</span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#SERVER_CLOSED-constant" title="Mongo::Monitoring::SERVER_CLOSED (constant)">SERVER_CLOSED</a></span><span class='comma'>,</span>
    <span class='id identifier rubyid_server_closed_subscriber'>server_closed_subscriber</span>)
  <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_subscribe'>subscribe</span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#TOPOLOGY_CLOSED-constant" title="Mongo::Monitoring::TOPOLOGY_CLOSED (constant)">TOPOLOGY_CLOSED</a></span><span class='comma'>,</span>
    <span class='id identifier rubyid_topology_closed_subscriber'>topology_closed_subscriber</span>)
<span class='kw'>end</span>

<span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>sdam_proc:</span> <span class='id identifier rubyid_sdam_proc'>sdam_proc</span>)</code></pre>

<p>Sample output:</p>

<pre class="code none"><code class="none">D, [2018-10-09T13:58:03.489461 #22079] DEBUG -- : SDAM | Topology type &#39;Unknown&#39; initializing.
D, [2018-10-09T13:58:03.489699 #22079] DEBUG -- : SDAM | Server 127.0.0.1:27100 initializing.
D, [2018-10-09T13:58:03.491384 #22079] DEBUG -- : SDAM | Server description for 127.0.0.1:27100 changed from &#39;unknown&#39; to &#39;unknown&#39;.
D, [2018-10-09T13:58:03.491642 #22079] DEBUG -- : SDAM | Server localhost:27100 initializing.
D, [2018-10-09T13:58:03.493199 #22079] DEBUG -- : SDAM | Server description for localhost:27100 changed from &#39;unknown&#39; to &#39;primary&#39;.
D, [2018-10-09T13:58:03.493473 #22079] DEBUG -- : SDAM | Server localhost:27101 initializing.
D, [2018-10-09T13:58:03.494874 #22079] DEBUG -- : SDAM | Server description for localhost:27101 changed from &#39;unknown&#39; to &#39;secondary&#39;.
D, [2018-10-09T13:58:03.495139 #22079] DEBUG -- : SDAM | Server localhost:27102 initializing.
D, [2018-10-09T13:58:03.496504 #22079] DEBUG -- : SDAM | Server description for localhost:27102 changed from &#39;unknown&#39; to &#39;secondary&#39;.
D, [2018-10-09T13:58:03.496777 #22079] DEBUG -- : SDAM | Topology type &#39;Unknown&#39; changed to type &#39;ReplicaSetNoPrimary&#39;.
D, [2018-10-09T13:58:03.497306 #22079] DEBUG -- : SDAM | Server 127.0.0.1:27100 connection closed.
D, [2018-10-09T13:58:03.497606 #22079] DEBUG -- : SDAM | Topology type &#39;ReplicaSetNoPrimary&#39; changed to type &#39;ReplicaSetWithPrimary&#39;.

# client.close

D, [2018-10-09T13:58:05.342057 #22079] DEBUG -- : SDAM | Server localhost:27100 connection closed.
D, [2018-10-09T13:58:05.342299 #22079] DEBUG -- : SDAM | Server localhost:27101 connection closed.
D, [2018-10-09T13:58:05.342565 #22079] DEBUG -- : SDAM | Server localhost:27102 connection closed.
D, [2018-10-09T13:58:05.342693 #22079] DEBUG -- : SDAM | Topology type &#39;ReplicaSetWithPrimary&#39; closed.
</code></pre>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p><code>:sdam_proc</code> client option applies only to the client during whose
construction it is given. When certain client options are changed via the
<code>Client#with</code> call, a new cluster may be created by the driver with
a default set of event subscribers. If this happens, the provided
<code>:sdam_proc</code> is not called and the application may miss events.</p>

<p></div></p>

<h2>Server Heartbeats</h2>

<p>The application can be notified of each server heartbeat by subscribing
to SERVER_HEARTBEAT topic. A server heartbeat listener must implement
three methods: <code>started</code>, <code>succeeded</code> and <code>failed</code>. Each heartbeat
invokes the <code>started</code> method on the listener, and then either <code>succeeded</code>
or <code>failed</code> method depending on the outcome of the heartbeat.</p>

<p>All heartbeat events contain the address of the server that the heartbeat
was sent to. Succeeded and failed events contain the round trip time for
the hello or legacy hello command. Failed event also contains the exception
instance that was raised during hello or legacy hello command execution.
Please review the API documentation for ServerHeartbeatStarted,
ServerHeartbeatSucceeded and ServerHeartbeatFailed for event attribute details.</p>

<p>The following is an example logging heartbeat event subscriber:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>HeartbeatLogSubscriber</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Loggable.html" title="Mongo::Loggable (module)">Loggable</a></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_started'>started</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='id identifier rubyid_log_debug'>log_debug</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_content'> | STARTED</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_succeeded'>succeeded</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='id identifier rubyid_log_debug'>log_debug</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_content'> | SUCCEEDED | </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_duration'>duration</span><span class='embexpr_end'>}</span><span class='tstring_content'>s</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_failed'>failed</span>(<span class='id identifier rubyid_event'>event</span>)
    <span class='id identifier rubyid_log_debug'>log_debug</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_content'> | FAILED | </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_error'>error</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_error'>error</span>.<span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> | </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_duration'>duration</span><span class='embexpr_end'>}</span><span class='tstring_content'>s</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_logger'>logger</span>
    <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Logger.html" title="Mongo::Logger (class)">Logger</a></span>.<span class='id identifier rubyid_logger'><a href="Mongo/Logger.html#logger-class_method" title="Mongo::Logger.logger (method)">logger</a></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_format_message'>format_message</span>(<span class='id identifier rubyid_message'>message</span>)
    <span class='id identifier rubyid_format'>format</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HEARTBEAT | %s</span><span class='tstring_end'>&quot;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Similarly to command events, the application can subscribe to heartbeat
events globally or for a specific client:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_subscriber'>subscriber</span> <span class='op'>=</span> <span class='const'>HeartbeatLogSubscriber</span>.<span class='id identifier rubyid_new'>new</span>

<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/Global.html" title="Mongo::Monitoring::Global (module)">Global</a></span>.<span class='id identifier rubyid_subscribe'><a href="Mongo/Monitoring/Subscribable.html#subscribe-instance_method" title="Mongo::Monitoring::Subscribable#subscribe (method)">subscribe</a></span>(<span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#SERVER_HEARTBEAT-constant" title="Mongo::Monitoring::SERVER_HEARTBEAT (constant)">SERVER_HEARTBEAT</a></span><span class='comma'>,</span> <span class='id identifier rubyid_subscriber'>subscriber</span>)

<span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test</span><span class='tstring_end'>&#39;</span></span> )
<span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_subscribe'>subscribe</span>( <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#SERVER_HEARTBEAT-constant" title="Mongo::Monitoring::SERVER_HEARTBEAT (constant)">SERVER_HEARTBEAT</a></span><span class='comma'>,</span> <span class='id identifier rubyid_subscriber'>subscriber</span> )</code></pre>

<p>Sample output:</p>

<pre class="code none"><code class="none">D, [2018-09-23T13:44:10.707018 #1739] DEBUG -- : HEARTBEAT | 127.0.0.1:27027 | STARTED
D, [2018-09-23T13:44:10.707778 #1739] DEBUG -- : HEARTBEAT | 127.0.0.1:27027 | SUCCEEDED | 0.000772381s
</code></pre>

<h3>Heartbeat Event Intervals</h3>

<p>When connected to MongoDB 4.2 and earlier servers, Ruby driver by default
issues heartbeats every <code>:heartbeat_frequency</code> (Ruby client option) seconds,
and heartbeats are non-overlapping (the succeeded event for a heartbeat is
guaranteed to be published before the started event for the next heartbeat is
published). When connected to MongoDB 4.4 and later servers, the driver uses
multiple monitoring threads and a more complex heartbeat protocol designed
to detect changes in server state quicker; as a result, heartbeat event
intervals can be more irregular and heartbeat events can overlap. Specifically,
an <em>awaited heartbeat</em> can start or finish while a <em>non-awaited heartbeat</em>
is in progress, and vice versa. Use the <code>ServerHeartbeatStarted#awaited?</code>,
<code>ServerHeartbeatSucceeded#awaited?</code> and <code>ServerHeartbeatFailed#awaited?</code>
methods to distinguish between non-awaited and awaited heartbeats.</p>

<p>When a client is attempting to perform an operation and it does not have a
suitable server, the deployment is scanned more frequently - each server can
be polled up to every 500 milliseconds. It is also possible for the application
to request a manual scan of a particular server; the driver enforces the
500 millisecond minimum interval between scans.</p>

<h2>Connection Pool And Connection Monitoring</h2>

<p>Each client maintains a connection pool for each server in the deployment that
it is aware of, and publishes events for both connection pools and individual
connections. To subscribe to these events, define a subscriber class implementing
the method <code>pubished</code> which takes a single parameter for the event that
is being published. Note that future versions of the driver may introduce
additional events published through this mechanism.</p>

<p>The following events are currently implemented by the driver, following
the <a href="https://github.com/mongodb/specifications/blob/master/source/connection-monitoring-and-pooling/connection-monitoring-and-pooling.rst">CMAP specification</a>:</p>

<ul>
<li>  PoolCreated</li>
<li>  PoolCleared</li>
<li>  PoolClosed</li>
<li>  ConnectionCreated</li>
<li>  ConnectionReady</li>
<li>  ConnectionClosed</li>
<li>  ConnectionCheckOutStarted</li>
<li>  ConnectionCheckOutFailed</li>
<li>  ConnectionCheckOutSucceeded</li>
<li>  ConnectionCheckedIn</li>
</ul>

<p>The driver provides a logging subscriber which may be used to log all
connection pool and connection-related events. This subscriber is not enabled
by default because it will create log entries for each operation performed
by the application. To enable this subscriber globally or per client:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/Global.html" title="Mongo::Monitoring::Global (module)">Global</a></span>.<span class='id identifier rubyid_subscribe'><a href="Mongo/Monitoring/Subscribable.html#subscribe-instance_method" title="Mongo::Monitoring::Subscribable#subscribe (method)">subscribe</a></span>(
  <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#CONNECTION_POOL-constant" title="Mongo::Monitoring::CONNECTION_POOL (constant)">CONNECTION_POOL</a></span><span class='comma'>,</span>
  <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/CmapLogSubscriber.html" title="Mongo::Monitoring::CmapLogSubscriber (class)">CmapLogSubscriber</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Monitoring/CmapLogSubscriber.html#new-class_method" title="Mongo::Monitoring::CmapLogSubscriber.new (method)">new</a></span>)

<span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test</span><span class='tstring_end'>&#39;</span></span> )
<span class='id identifier rubyid_subscriber'>subscriber</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring/CmapLogSubscriber.html" title="Mongo::Monitoring::CmapLogSubscriber (class)">CmapLogSubscriber</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Monitoring/CmapLogSubscriber.html#new-class_method" title="Mongo::Monitoring::CmapLogSubscriber.new (method)">new</a></span>
<span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_subscribe'>subscribe</span>( <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Monitoring.html#CONNECTION_POOL-constant" title="Mongo::Monitoring::CONNECTION_POOL (constant)">CONNECTION_POOL</a></span><span class='comma'>,</span> <span class='id identifier rubyid_subscriber'>subscriber</span> )</code></pre>

<p>Sample output:</p>

<pre class="code none"><code class="none">D, [2019-05-06T17:23:21.595412 #8576] DEBUG -- : MONGODB | EVENT: #&lt;PoolCreated address=127.0.0.1:27741 options={...}&gt;
D, [2019-05-06T17:23:21.595584 #8576] DEBUG -- : MONGODB | EVENT: #&lt;PoolCleared address=127.0.0.1:27741&gt;
D, [2019-05-06T17:23:21.603549 #8576] DEBUG -- : MONGODB | EVENT: #&lt;PoolCreated address=localhost:27741 options={...}&gt;
D, [2019-05-06T17:23:21.603616 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionCheckOutStarted address=localhost:27741&gt;
D, [2019-05-06T17:23:21.603684 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionCreated address=localhost:27741 connection_id=1&gt;
D, [2019-05-06T17:23:21.604079 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionCheckedOut address=localhost:27741 connection_id=1&gt;
D, [2019-05-06T17:23:21.605759 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionReady address=localhost:27741 connection_id=1&gt;
D, [2019-05-06T17:23:21.605784 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionCheckedIn address=localhost:27741 connection_id=1&gt;
D, [2019-05-06T17:23:21.605817 #8576] DEBUG -- : MONGODB | EVENT: #&lt;PoolCleared address=localhost:27741&gt;
D, [2019-05-06T17:23:21.605852 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionClosed address=localhost:27741 connection_id=1 reason=stale&gt;
</code></pre>

<h2>Disabling Monitoring</h2>

<p>To turn off monitoring, set the client monitoring option to <code>false</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_monitoring'>monitoring</span> <span class='op'>=&gt;</span> <span class='kw'>false</span> )</code></pre>

<h2>Excluded and Redacted Events</h2>

<p>The Ruby driver does not pubish, and occasionaly redacts, some events via the
command monitoring mechanism:</p>

<ol>
<li> If the command belongs to a particular subset of redacted commands, or
contains keys that trigger payload redaction, an empty payload will be
provided for security reasons. The full payload can be accessed by setting
the <code>MONGO_RUBY_DRIVER_UNREDACT_EVENTS</code> environment variable to <code>1</code>, <code>true</code> or <code>yes</code>. The
following commands are redacted:

<ul>
<li>  <code>authenticate</code></li>
<li>  <code>saslStart</code></li>
<li>  <code>saslContinue</code></li>
<li>  <code>getnonce</code></li>
<li>  <code>createUser</code></li>
<li>  <code>updateUser</code></li>
<li>  <code>copydbgetnonce</code></li>
<li>  <code>copydbsaslstart</code></li>
<li>  <code>copydb</code></li>
</ul></li>
<li> If the command is a handshake command, either <code>ismaster</code> or <code>hello</code>, on
a non-monitoring connection, no event is published at all.</li>
<li> Commands sent over monitoring connections (such as ismaster and hello) do
not publish command monitoring events. Instead, every time a server is
checked a server heartbeat event is published. The server heartbeat events
do not include command or reply payloads.</li>
<li> If the command is a handshake command, and the <code>speculativeAuthenticate</code>
options is <code>true</code>, the command will be redacted, and an empty payload will
be provided.</li>
</ol>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>