<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: CRUD Operations &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "crud_operations",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Mongo master</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: CRUD Operations&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>CRUD Operations</h1>

<p>CRUD operations are those which deal with creating, reading, updating,
and deleting documents.</p>

<h2>Key-value Pair Notation</h2>

<p>Key-value pairs appear in many different contexts in the MongoDB Ruby
driver, and there are some quirks of syntax with regard to how they can
be notated which depend on which version of Ruby you&#39;re using.</p>

<p>When constructing a document, the following syntax is acceptable and
correct for Ruby version 1.9 and later:</p>

<pre class="code javascript"><code class="javascript">document = { name: &quot;Harriet&quot;, age: 36 }
</code></pre>

<p>If you&#39;re using Ruby version 2.2 or greater, you can optionally enclose
your keys in quotes.</p>

<pre class="code javascript"><code class="javascript">document = { &quot;name&quot;: &quot;Harriet&quot;, &quot;age&quot;: 36 }
</code></pre>

<p>If you need to use any MongoDB operator which begins with <code>$</code>,
such as <code>$set</code>, <code>$gte</code>, or <code>$near</code>, you must enclose it in
quotes. If you&#39;re using Ruby version 2.2 or greater, you can notate
it as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_update_one'>update_one</span>({ <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Harriet</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='label_end'>&quot;:</span> { <span class='label'>age:</span> <span class='int'>42</span> } })</code></pre>

<p>If you&#39;re using an earlier version of Ruby, use the hashrocket symbol:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_update_one'>update_one</span>({ <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Harriet</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='label'>age:</span> <span class='int'>42</span> } })</code></pre>

<p>Quoted strings and hashrockets for key-value pairs will work with any
version of Ruby:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_update_one'>update_one</span>({ <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Harriet</span><span class='tstring_end'>&quot;</span></span> }<span class='comma'>,</span> { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='label'>age:</span> <span class='int'>42</span> } })</code></pre>

<h2>Creating Documents</h2>

<p>To insert documents into a collection, select a
collection on the client and call <code>insert_one</code> or <code>insert_many</code>.</p>

<p>Insert operations return a <a href="Mongo/Operation/Result.html" title="Mongo::Operation::Result (class)"><code>::Mongo::Operation::Result</code></a> object which
gives you information about the insert itself.</p>

<p>On MongoDB 2.6 and later, if the insert fails, an exception is
raised, because write commands are used.</p>

<p>On MongoDB 2.4, an exception is only raised if the insert fails and the
<code>write concern&lt;/reference/write-concern/&gt;</code> is 1 or higher.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_insert_one'>insert_one</span>( { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>FKA Twigs</span><span class='tstring_end'>&#39;</span></span> } )
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_n'>n</span> <span class='comment'># returns 1, because 1 document was inserted.
</span>
<span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_insert_many'>insert_many</span>([
  { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Flying Lotus</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span>
  { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Aphex Twin</span><span class='tstring_end'>&#39;</span></span> }
])
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_inserted_count'>inserted_count</span> <span class='comment'># returns 2, because 2 documents were inserted.</span></code></pre>

<h3>Specify a <code>Decimal128</code> number [specify-decimal128]</h3>

<div class="versionadded" markdown="1">

3.4

</div>

<p><code>Decimal128</tutorial/model-monetary-data></code> is a
<code>BSON datatype &lt;/tutorials/bson&gt;</code>
that employs 128-bit decimal-based floating-point values capable
of emulating decimal rounding with exact precision. This
functionality is intended for applications that handle
<code>monetary data &lt;/tutorial/model-monetary-data&gt;</code>,
such as financial and tax computations.</p>

<p>The following example inserts a value of type <code>Decimal128</code> into
the <code>price</code> field of a collection named <code>inventory</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_price'>price</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Decimal128</span>.<span class='id identifier rubyid_new'>new</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>428.79</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_inventory'>inventory</span>].<span class='id identifier rubyid_insert_one'>insert_one</span>({ <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='comma'>,</span>
                                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>item</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>26 inch monitor</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>price</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_price'>price</span> })</code></pre>

<p>The above operation produces the following document:</p>

<pre class="code javascript"><code class="javascript">{ &quot;_id&quot; : 1, &quot;item&quot; : &quot;26 inch monitor&quot;, &quot;price&quot; : NumberDecimal(&quot;428.79&quot;) }
</code></pre>

<p>You can also create a <code>Decimal128</code> object from a Ruby <code>BigDecimal</code>
object, or with <code>Decimal128.from_string()</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_big_decimal'>big_decimal</span> <span class='op'>=</span> <span class='const'>BigDecimal</span>.<span class='id identifier rubyid_new'>new</span>(<span class='float'>428.79</span><span class='comma'>,</span> <span class='int'>5</span>)
<span class='id identifier rubyid_price'>price</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Decimal128</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_big_decimal'>big_decimal</span>)
<span class='comment'># =&gt; BSON::Decimal128(&#39;428.79&#39;)
</span>
<span class='id identifier rubyid_price'>price</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Decimal128</span>.<span class='id identifier rubyid_from_string'>from_string</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>428.79</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; BSON::Decimal128(&#39;428.79&#39;)</span></code></pre>

<h2>Query Cache</h2>

<p>The Ruby driver provides a query cache. When enabled, the query cache will
save the results of find and aggregation queries and return those saved results
when the same queries are performed again.</p>

<p>To read more about the query cache, visit the
<code>query cache tutorial &lt;query-cache&gt;</code>.</p>

<h2>Reading</h2>

<p>The Ruby driver provides a fluent interface for queries using the <code>find</code>
method on the collection. Various options are available
to the <code>find</code> method.</p>

<p>The query is lazily executed against the server only when iterating the
results - at that point the query is dispatched and a <a href="Mongo/Cursor.html" title="Mongo::Cursor (class)"><code>::Mongo::Cursor</code></a> is
returned.</p>

<p>To find all documents for a given filter, call <code>find</code> with the
query:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Flying Lotus</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_document'>document</span><span class='op'>|</span>
  <span class='comment'>#=&gt; Yields a BSON::Document.
</span><span class='kw'>end</span></code></pre>

<p>To query nested documents, specify the keys in nested order using dot
notation.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_find'>find</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>records.releaseYear</span><span class='label_end'>&quot;:</span> <span class='int'>2008</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_document'>document</span><span class='op'>|</span>
  <span class='comment'>#=&gt; Yields a BSON::Document.
</span><span class='kw'>end</span></code></pre>

<h3>Legacy <code>$query</code> Syntax</h3>

<p><em>This usage is deprecated.</em></p>

<p>The <code>find</code> method allows providing the query and the options using the
legacy <code>$query</code> syntax in the first parameter:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:&#39;</span><span class='tstring_content'>$query</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> {<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mr. Smith</span><span class='tstring_end'>&#39;</span></span>})
<span class='comment'># Equivalent to:
</span><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_find'>find</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mr. Smith</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:&#39;</span><span class='tstring_content'>$query</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> {<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mr. Smith</span><span class='tstring_end'>&#39;</span></span>}<span class='comma'>,</span> <span class='symbeg'>:&#39;</span><span class='tstring_content'>$sort</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> {<span class='label'>age:</span> <span class='int'>1</span>})
<span class='comment'># Equivalent to:
</span><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_find'>find</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mr. Smith</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_sort'>sort</span>(<span class='label'>age:</span> <span class='int'>1</span>)</code></pre>

<p>When the query is executed against MongoDB 3.2 or newer, the driver will
use the protocol appropriate for the server version in question, automatically
converting the query as needed to either a find command or an OP_MSG payload.</p>

<h3>Query Options</h3>

<p>To add options to a query, chain the appropriate methods after the
<code>find</code> method. Note that the underlying object, the <a href="Mongo/Collection/View.html" title="Mongo::Collection::View (class)"><code>::Mongo::Collection::View</code></a>,
is immutable and a new object will be returned after each method call.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_documents'>documents</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Flying Lotus</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_skip'>skip</span>(<span class='int'>10</span>).<span class='id identifier rubyid_limit'>limit</span>(<span class='int'>10</span>)
<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_document'>document</span><span class='op'>|</span>
  <span class='comment'>#=&gt; Yields a BSON::Document.
</span><span class='kw'>end</span></code></pre>

<p>The following is a full list of the available options that can be added
when querying and their corresponding methods as examples.</p>

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>allow_disk_use</code></td>
<td>When set to true, the server can write temporary data to disk while
executing the find operation. This option is only available on MongoDB
server versions 4.4 and newer.</td>
</tr>
<tr class="even">
<td><code>allow_partial_results</code></td>
<td>For use with sharded clusters. If a shard is down, allows the query
to return results from the shards that are up, potentially only getting
a portion of the results.</td>
</tr>
<tr class="odd">
<td><code>batch_size(Integer)</code></td>
<td>Specifies the size of each batch of documents the cursor will return on
each <code>GETMORE</code> operation.</td>
</tr>
<tr class="even">
<td><code>comment(String)</code></td>
<td>Adds a comment to the query.</td>
</tr>
<tr class="odd">
<td><p><code>explain(**opts)</code></p></td>
<td><p>Returns the query plan for the query. Pass the <code class="interpreted-text" role="manual">explain options
&lt;/reference/command/explain/&gt;</code> via the keyword arguments using symbol
keys.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All server versions - default explain behavior</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.explain</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># MongoDB 3.0 and newer</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.explain</span>(<span class="wa">verbosity: :query_planner</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.explain</span>(<span class="wa">verbosity: :execution_stats</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.explain</span>(<span class="wa">verbosity: :all_plans_execution</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative syntax using camel case</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.explain</span>(<span class="wa">verbosity: </span><span class="st">&quot;queryPlanner&quot;</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.explain</span>(<span class="wa">verbosity: </span><span class="st">&quot;executionStats&quot;</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.explain</span>(<span class="wa">verbosity: </span><span class="st">&quot;allPlansExecution&quot;</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># MongoDB 2.6</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.explain</span>(<span class="wa">verbose: </span><span class="dv">true</span>)</span></code></pre></div>
<p>The explain operation supports <code>:session</code> and <code>:read</code>
(for read preference) options. To specify these options for a single
explain operation, they must be given to the <code>find</code> method as
follows:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find</span>(<span class="kw">{}</span>, <span class="wa">session: </span>session)<span class="at">.explain</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find</span>(<span class="kw">{}</span>, <span class="wa">read: </span><span class="kw">{</span><span class="wa">mode: :secondary_preferred</span><span class="kw">}</span>)<span class="at">.explain</span></span></code></pre></div>
<p>If the read preference option is specified on the client or on the
collection, it will be passed to the explain operation:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span>, <span class="wa">read: </span><span class="kw">{</span><span class="wa">mode: :secondary_preferred</span><span class="kw">}]</span><span class="at">.find.explain</span></span></code></pre></div>
<p>Note that the session option is not accepted when creating a collection
object.</p>
<p>The explain command does not support passing the read concern option.
If the read concern is specifed on the client or collection level, or
if the read concern is specified as a find option, it will NOT be passed
by the driver to the explain command.</p>
<div class="note">
<div class="title">
<p>Note</p>
</div>
<p>The information returned by the server for the <code>explain</code> command
varies with server version and deployment topology. The driver's
<code>explain</code> method returns whatever the server provided.</p>
<p><strong>The return value of <code>explain</code> method is not part of the driver's
public API and depends on the server version and deployment topology.</strong></p>
</div></td>
</tr>
<tr class="even">
<td><code>hint(Hash)</code></td>
<td>Provides the query with an
<code class="interpreted-text" role="manual">index hint&lt;/reference/method/cursor.hint/&gt;</code> to use.</td>
</tr>
<tr class="odd">
<td><code>let(Hash)</code></td>
<td>Mapping of <code class="interpreted-text" role="manual">variables&lt;/reference/command/find/#std-label-find-let-syntax&gt;</code>
to use in the query.</td>
</tr>
<tr class="even">
<td><code>limit(Integer)</code></td>
<td>Limits the number of returned documents to the provided value.</td>
</tr>
<tr class="odd">
<td><code>max_scan(Integer)</code></td>
<td>Sets the maximum number of documents to scan if a full collection scan
would be performed. Deprecated as of MongoDB server version 4.0.</td>
</tr>
<tr class="even">
<td><code>max_time_ms(Integer)</code></td>
<td>The maximum amount of time to allow the query to run, in milliseconds.</td>
</tr>
<tr class="odd">
<td><code>no_cursor_timeout</code></td>
<td>MongoDB automatically closes inactive cursors after a period of 10
minutes. Call this for cursors to remain open indefinitely on the server.</td>
</tr>
<tr class="even">
<td><p><code>projection(Hash)</code></p></td>
<td><p>Specifies the fields to include or exclude from the results.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.projection</span>(<span class="wa">:name</span> <span class="kw">=&gt;</span> <span class="dv">1</span>)</span></code></pre></div></td>
</tr>
<tr class="odd">
<td><p><code>read(Hash)</code></p></td>
<td><p>Changes the read preference for this query only.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.read</span>(<span class="wa">:mode</span> <span class="kw">=&gt;</span> <span class="wa">:secondary_preferred</span>)</span></code></pre></div></td>
</tr>
<tr class="even">
<td><code>session(Session)</code></td>
<td>The session to use.</td>
</tr>
<tr class="odd">
<td><code>show_disk_loc(Boolean)</code></td>
<td>Tells the results to also include the location of the documents on disk.</td>
</tr>
<tr class="even">
<td><code>skip(Integer)</code></td>
<td>Skip the provided number of documents in the results.</td>
</tr>
<tr class="odd">
<td><code>snapshot</code></td>
<td>Execute the query in snapshot mode. Deprecated as of MongoDB server version 4.0.</td>
</tr>
<tr class="even">
<td><p><code>sort(Hash)</code></p></td>
<td><p>Specifies sort criteria for the query.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>client<span class="kw">[</span><span class="wa">:artists</span><span class="kw">]</span><span class="at">.find.sort</span>(<span class="wa">:name</span> <span class="kw">=&gt;</span> <span class="kw">-</span><span class="dv">1</span>)</span></code></pre></div></td>
</tr>
</tbody>
</table>

<h3>Additional Query Operations</h3>

<p><code>count_documents</code></p>

<p>:   Get the total number of documents matching a filter, or the total number
    of documents in a collection.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Flying Lotus</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_count_documents'>count_documents</span></code></pre>

<p><code>estimated_document_count</code></p>

<p>:   Get an approximate number of documents in the collection.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Note</span> <span class='id identifier rubyid_that'>that</span> <span class='id identifier rubyid_unlike'>unlike</span> {<span class='id identifier rubyid_count_documents'>count_documents</span>}<span class='comma'>,</span> {<span class='id identifier rubyid_estimated_document_count'>estimated_document_count</span>} <span class='id identifier rubyid_does'>does</span> <span class='kw'>not</span>
<span class='id identifier rubyid_accept'>accept</span> <span class='id identifier rubyid_a'>a</span> <span class='id identifier rubyid_filter'>filter</span>.

<span class='const'>The</span> {<span class='id identifier rubyid_count'>count</span>} <span class='id identifier rubyid_server'>server</span> <span class='id identifier rubyid_command'>command</span> <span class='id identifier rubyid_is'>is</span> <span class='id identifier rubyid_used'>used</span> <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_implement'>implement</span> {<span class='id identifier rubyid_estimated_document_count'>estimated_document_count</span>}.
<span class='const'>More</span> <span class='id identifier rubyid_information'>information</span> <span class='id identifier rubyid_can'>can</span> <span class='id identifier rubyid_be'>be</span> <span class='id identifier rubyid_found'>found</span> <span class='id identifier rubyid_via'>via</span> [<span class='label'>Count:</span> <span class='const'>Behavior</span>](<span class='id identifier rubyid_https'>https</span><span class='symbeg'>:</span><span class='op'>/</span><span class='op'>/</span><span class='id identifier rubyid_www'>www</span>.<span class='id identifier rubyid_mongodb'>mongodb</span>.<span class='id identifier rubyid_com'>com</span><span class='op'>/</span><span class='id identifier rubyid_docs'>docs</span><span class='op'>/</span><span class='id identifier rubyid_manual'>manual</span><span class='op'>/</span><span class='id identifier rubyid_reference'>reference</span><span class='op'>/</span><span class='id identifier rubyid_command'>command</span><span class='op'>/</span><span class='id identifier rubyid_count'>count</span><span class='op'>/</span><span class='comment'>#behavior).
</span>
<span class='const'>Due</span> <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_an'>an</span> <span class='id identifier rubyid_oversight'>oversight</span> <span class='kw'>in</span> <span class='const'>MongoDB</span> <span class='id identifier rubyid_versions'>versions</span> <span class='float'>5.0</span><span class='op'>-</span><span class='float'>5.0</span><span class='comma'>,</span> <span class='id identifier rubyid_the'>the</span> {<span class='id identifier rubyid_count'>count</span>} <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span>
<span class='id identifier rubyid_which'>which</span> {<span class='id identifier rubyid_estimated_document_count'>estimated_document_count</span>} <span class='id identifier rubyid_uses'>uses</span> <span class='kw'>in</span> <span class='id identifier rubyid_its'>its</span> <span class='id identifier rubyid_implementation'>implementation</span><span class='comma'>,</span> <span class='id identifier rubyid_was'>was</span> <span class='kw'>not</span>
<span class='id identifier rubyid_included'>included</span> <span class='kw'>in</span> <span class='id identifier rubyid_v1'>v1</span> <span class='id identifier rubyid_of'>of</span> <span class='id identifier rubyid_the'>the</span> <span class='const'>Stable</span> <span class='const'>API</span>. <span class='const'>Therefore</span><span class='comma'>,</span> <span class='id identifier rubyid_users'>users</span> <span class='id identifier rubyid_of'>of</span> <span class='id identifier rubyid_the'>the</span> <span class='const'>Stable</span> <span class='const'>API</span> <span class='id identifier rubyid_with'>with</span>
{<span class='id identifier rubyid_estimated_document_count'>estimated_document_count</span>} <span class='id identifier rubyid_are'>are</span> <span class='id identifier rubyid_recommended'>recommended</span> <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_upgrade'>upgrade</span> <span class='id identifier rubyid_their'>their</span> <span class='id identifier rubyid_server'>server</span> <span class='id identifier rubyid_version'>version</span> <span class='id identifier rubyid_to'>to</span>
<span class='float'>5.0</span><span class='op'>+</span> <span class='kw'>or</span> <span class='id identifier rubyid_set'>set</span> <span class='backtick'>`</span><span class='tstring_content'>api_strict: false</span><span class='tstring_end'>`</span></span> <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_avoid'>avoid</span> <span class='id identifier rubyid_encountering'>encountering</span> <span class='id identifier rubyid_errors'>errors</span>.</code></pre>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_estimated_document_count'>estimated_document_count</span></code></pre>

<p><code>count</code></p>

<p>:   Get an approximate number of documents matching a filter, or an approximate
    number of documents in the collection.</p>

<pre class="code ruby"><code class="ruby"><span class='op'>*</span><span class='const'>Deprecated</span><span class='symbeg'>:</span><span class='op'>*</span> <span class='const'>The</span> {<span class='id identifier rubyid_count'>count</span>} <span class='id identifier rubyid_method'>method</span> <span class='id identifier rubyid_is'>is</span> <span class='id identifier rubyid_deprecated'>deprecated</span> <span class='kw'>and</span> <span class='id identifier rubyid_does'>does</span> <span class='kw'>not</span> <span class='id identifier rubyid_work'>work</span> <span class='kw'>in</span>
<span class='id identifier rubyid_transactions'>transactions</span>. <span class='const'>Please</span> <span class='id identifier rubyid_use'>use</span> {<span class='id identifier rubyid_count_documents'>count_documents</span>} <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_obtain'>obtain</span> <span class='id identifier rubyid_an'>an</span> <span class='id identifier rubyid_exact'>exact</span> <span class='id identifier rubyid_count'>count</span> <span class='id identifier rubyid_of'>of</span>
<span class='id identifier rubyid_documents'>documents</span> <span class='id identifier rubyid_potentially'>potentially</span> <span class='id identifier rubyid_matching'>matching</span> <span class='id identifier rubyid_a'>a</span> <span class='id identifier rubyid_filter'>filter</span> <span class='kw'>or</span> {<span class='id identifier rubyid_estimated_document_count'>estimated_document_count</span>}
<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_obtain'>obtain</span> <span class='id identifier rubyid_an'>an</span> <span class='id identifier rubyid_approximate'>approximate</span> <span class='id identifier rubyid_number'>number</span> <span class='id identifier rubyid_of'>of</span> <span class='id identifier rubyid_documents'>documents</span> <span class='kw'>in</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_collection'>collection</span>.</code></pre>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Flying Lotus</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_count'>count</span></code></pre>

<p><code>distinct</code></p>

<p>:   Filters out documents with duplicate values. Equivalent to the SQL
    <code>distinct</code> clause.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)

<span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_find'>find</span>.<span class='id identifier rubyid_distinct'>distinct</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> )</code></pre>

<h3>Tailable Cursors</h3>

<p>For capped collections you may use a <code>tailable cursor
&lt;/core/tailable-cursors/&gt;</code> that remains open
after the client exhausts the results in the initial cursor. The
following code example shows how a tailable cursor might be used:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_drop'>drop</span>
<span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span><span class='comma'>,</span> <span class='label'>capped:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>size:</span> <span class='int'>512</span>].<span class='id identifier rubyid_create'>create</span>

<span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_insert_many'>insert_many</span>([
  { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Flying Lotus</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span>
  { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Aphex Twin</span><span class='tstring_end'>&#39;</span></span> }
])

<span class='id identifier rubyid_enum'>enum</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>].<span class='id identifier rubyid_find'>find</span>({}<span class='comma'>,</span> <span class='label'>cursor_type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tailable_await'>tailable_await</span>).<span class='id identifier rubyid_to_enum'>to_enum</span>

<span class='kw'>while</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_enum'>enum</span>.<span class='id identifier rubyid_next'>next</span>
  <span class='comment'># do something
</span>  <span class='id identifier rubyid_sleep'>sleep</span>(<span class='int'>1</span>)
<span class='kw'>end</span></code></pre>

<h3>Read Concern</h3>

<p>Read concern can be <code>set on the client &lt;client-options&gt;</code>
or on the collection:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>localhost:14420</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>read_concern:</span> {<span class='label'>level:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_local'>local</span>})

<span class='id identifier rubyid_client'>client</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>collection</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_find'>find</span>.<span class='id identifier rubyid_to_a'>to_a</span>

<span class='id identifier rubyid_collection'>collection</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>collection</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>read_concern:</span> {<span class='label'>level:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>}]

<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_find'>find</span>.<span class='id identifier rubyid_to_a'>to_a</span></code></pre>

<p>The driver does not currently support setting read concern on an individual
query.</p>

<p>Read concern can be specified when <code>starting a transaction
&lt;using-transactions&gt;</code>. When a transaction is active, <code>any read concern
specified on the client or on the collection is ignored
&lt;/core/transactions/#transactions-and-read-concern&gt;</code>.</p>

<p>When using the generic command helper, the read concern can be specified as
part of the command:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_command'>command</span>(<span class='label'>dbStats:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>readConcern:</span> {<span class='label'>level:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>})</code></pre>

<h3>Read Preference</h3>

<p>Read preference determines the candidate <code>replica set&lt;/replication/&gt;</code>
members to which a query or command can be sent. They consist of a <strong>mode</strong>
specified as a symbol, an array of hashes known as <strong>tag_sets</strong>,
the <code>hedge</code> option, which is a Hash specifying hedged read behavior, and two
timing options: <strong>local_threshold</strong> and <strong>server_selection_timeout</strong>.</p>

<p><code>local_threshold</code></p>

<p>:   Defines the upper limit in seconds of the latency window
    between the nearest server and suitable servers to which an operation may be sent.
    The default is 15 milliseconds, or 0.015 seconds.</p>

<p><code>server_selection_timeout</code></p>

<p>:   Defines how long to block for server selection
    before throwing an exception. The default is 30,000 milliseconds, or 30 seconds.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>Read preference does not apply to Standalone deployments. When a client
is connected to a Standalone deployment, any application-specified read
preference is ignored.</p>

<p></div></p>

<p>For more information on the algorithm used to select a server, please
refer to the <a href="">Server Selection documentation, available on GitHub
&lt;https://github.com/mongodb/specifications/blob/master/source/server-sel
ection/server-selection.rst&gt;</a>.</p>

<p>Read preference can be set as an option on the client or passed an
option when a command is run on a database:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Set read preference on a client, used for all operations
</span><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span>
                           <span class='label'>read:</span> { <span class='label'>mode:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_secondary'>secondary</span><span class='comma'>,</span>
                                   <span class='label'>tag_sets:</span> [ { <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>dc</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>nyc</span><span class='tstring_end'>&#39;</span></span> } ]
                                  } )

<span class='comment'># Set read preference for a given command
</span><span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_command'>command</span>( { <span class='label'>dbStats:</span> <span class='int'>1</span> }<span class='comma'>,</span> <span class='label'>read:</span> { <span class='label'>mode:</span> <span class='id identifier rubyid_secondary'>secondary</span><span class='comma'>,</span>
                                                     <span class='label'>tag_sets:</span> [ { <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>dc</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>nyc</span><span class='tstring_end'>&#39;</span></span> } ] } )</code></pre>

<p>Read preference can also be set for specific operations on a collection
using the <code>with</code> method:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_artists'>artists</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>]
<span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_with'>with</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_read'>read</span> <span class='op'>=&gt;</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_mode'>mode</span> <span class='op'>=&gt;</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_preferred'>primary_preferred</span> }).<span class='id identifier rubyid_find'>find</span>.<span class='id identifier rubyid_to_a'>to_a</span></code></pre>

<h3>Mode</h3>

<p>There are five possible read preference modes: <code>:primary</code>, <code>:secondary</code>,
<code>:primary_preferred</code>, <code>:secondary_preferred</code> and<code>:nearest</code>.
Please see the <code>read preference documentation in the MongoDB Manual
&lt;/core/read-preference/&gt;</code> for an explanation of the modes.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>When a client is directly connected to a server using the <code>:direct_connection</code>
Ruby option or the <code>directConnection</code> URI option, read preference mode
is automatically set to <code>:primary_preferred</code> to permit read operations
against secondaries. If the application specified a <code>:primary</code> read
preference mode, the mode is automatically converted to <code>:primary_preferred</code>.
If another read preference mode is specified, it is passed to the server
unchanged.</p>

<p></div></p>

<h3>Tag sets</h3>

<p>The <code>tag_sets</code> parameter is an ordered list of tag sets used to
restrict the eligibility of servers for selection, such as for data
center awareness. Please see the <code>read preference documentation in
the MongoDB Manual &lt;/core/read-preference/&gt;</code> for an explanation of tag sets.</p>

<p>A read preference tag set (T) matches a server tag set (S) – or
equivalently a server tag set (S) matches a read preference tag set
(T) — if T is a subset of S.</p>

<p>For example, the read preference tag set <code>{ dc: &#39;ny&#39;, rack: 2 }</code>
matches a secondary server with tag set <code>{ dc: &#39;ny&#39;, rack: 2, size: &#39;large&#39; }</code>.</p>

<p>A tag set that is an empty document matches any server, because
the empty tag set is a subset of any tag set. This means the default
<code>tag_sets</code> parameter <code>[{}]</code> matches all servers.</p>

<h3>Hedge</h3>

<p>The <code>hedge</code> parameter is a Hash that specifies whether the server should use
hedged reads. With hedged reads, sharded clusters can route read operations to
two replica set members and return results from the first respondent.</p>

<p>The <code>hedge</code> option may only be specified on non-primary read preferences. It
must be provided as Hash with the key <code>enabled</code> set to <code>true</code> or <code>false</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>(
  [ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span>
  <span class='label'>read:</span> { <span class='label'>mode:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_secondary'>secondary</span><span class='comma'>,</span> <span class='label'>hedge:</span> { <span class='label'>enabled:</span> <span class='kw'>true</span> } }<span class='comma'>,</span>
)</code></pre>

<p>See the <code>MongoDB Manual &lt;/core/read-preference-hedge-option&gt;</code> for
more information about hedged reads.</p>

<div class="note" markdown="1">

<div class="title" markdown="1">

Note

</div>

<p>The <code>hedge</code> option is only available on MongoDB server versions 4.4 and newer.
Attempting to use this option on older server versions will result in an error.</p>

<p></div></p>

<h2>Updating</h2>

<p>Updating documents is possible by executing a single or
multiple update, or by using the <code>$findAndModify</code> command.</p>

<p><code>update_one</code></p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_artists'>artists</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>]

<span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Goldie</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_update_one'>update_one</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$inc</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_plays'>plays</span> <span class='op'>=&gt;</span>  <span class='int'>1</span> } )
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_n'>n</span> <span class='comment'># Returns 1.
</span>
<span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_update_one'>update_one</span>( { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Goldie</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span> { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$inc</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_plays'>plays</span> <span class='op'>=&gt;</span>  <span class='int'>1</span> } } )
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_n'>n</span> <span class='comment'># Returns 1.</span></code></pre>

<p><code>update_many</code></p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Hospital</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_update_many'>update_many</span>( <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$inc</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_plays'>plays</span> <span class='op'>=&gt;</span>  <span class='int'>1</span> } )
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_modified_count'>modified_count</span> <span class='comment'># Returns the number of documents that were updated.
</span>
<span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_update_many'>update_many</span>( { <span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Hospital</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span> { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$inc</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_plays'>plays</span> <span class='op'>=&gt;</span>  <span class='int'>1</span> } } )
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_modified_count'>modified_count</span> <span class='comment'># Returns the number of documents that were updated.</span></code></pre>

<p><code>replace_one</code></p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Aphex Twin</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_replace_one'>replace_one</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Richard James</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_modified_count'>modified_count</span> <span class='comment'># Returns 1.
</span>
<span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_replace_one'>replace_one</span>( { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Aphex Twin</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Richard James</span><span class='tstring_end'>&#39;</span></span> } )
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_modified_count'>modified_count</span> <span class='comment'># Returns 1.</span></code></pre>

<p>To update documents and return a document via <code>$findAndModify</code>, use one of
the three provided helpers: <code>find_one_and_delete</code>, <code>find_one_and_replace</code>,
or <code>find_one_and_update</code>. You can opt to return the document before or after
the modification occurs.</p>

<p><code>find_one_and_delete</code></p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>( [ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_artists'>artists</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>]

<span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José James</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_find_one_and_delete'>find_one_and_delete</span> <span class='comment'># Returns the document.</span></code></pre>

<p><code>find_one_and_replace</code></p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José James</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_find_one_and_replace'>find_one_and_replace</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_doc'>doc</span> <span class='comment'># Return the document before the update.
</span>
<span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find_one_and_replace'>find_one_and_replace</span>({ <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José James</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José</span><span class='tstring_end'>&#39;</span></span> })
<span class='id identifier rubyid_doc'>doc</span> <span class='comment'># Return the document before the update.
</span>
<span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José James</span><span class='tstring_end'>&#39;</span></span>).
  <span class='id identifier rubyid_find_one_and_replace'>find_one_and_replace</span>( { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_return_document'>return_document</span> <span class='op'>=&gt;</span> <span class='symbeg'>:</span><span class='id identifier rubyid_after'>after</span> )
<span class='id identifier rubyid_doc'>doc</span> <span class='comment'># Return the document after the update.</span></code></pre>

<p><code>find_one_and_update</code></p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José James</span><span class='tstring_end'>&#39;</span></span>).
  <span class='id identifier rubyid_find_one_and_update'>find_one_and_update</span>( <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José</span><span class='tstring_end'>&#39;</span></span> } )
<span class='id identifier rubyid_doc'>doc</span> <span class='comment'># Return the document before the update.
</span>
<span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find_one_and_update'>find_one_and_update</span>( { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José James</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span> { <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>José</span><span class='tstring_end'>&#39;</span></span> } } )
<span class='id identifier rubyid_doc'>doc</span> <span class='comment'># Return the document before the update.</span></code></pre>

<h3>Update Options</h3>

<p>To add options to an update command, specify them as key-value pairs in the options
Hash argument.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_artists'>artists</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>]

<span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_indexes'>indexes</span>.<span class='id identifier rubyid_create_one'>create_one</span>(<span class='label'>name:</span> <span class='int'>1</span>)

<span class='comment'># Force the server to use the name index to perform this operation
</span><span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_update_one'>update_one</span>(
  { <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Goldie</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span>
  { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$inc</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_plays'>plays</span> <span class='op'>=&gt;</span>  <span class='int'>1</span> } }<span class='comma'>,</span>
  { <span class='label'>hint:</span> { <span class='label'>name:</span> <span class='int'>1</span> } }
)
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_n'>n</span> <span class='comment'># Returns 1.</span></code></pre>

<p>The following is a list of the options that can be added to update operations,
including <code>update_one</code>, <code>update_many</code>, <code>replace_one</code>,
<code>find_one_and_delete</code>, <code>find_one_and_update</code>, and <code>find_one_and_replace</code>.</p>

<table><thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code>array_filters</code></td>
<td>An Array of filter documents that determine which array elements to modify</td>
</tr>
<tr>
<td>for an update operation on an array field.</td>
<td></td>
</tr>
<tr>
<td><code>bypass_document_validation</code></td>
<td>Whether to skip document-level validation before writing the document.</td>
</tr>
<tr>
<td><code>collation</code></td>
<td>Specifies a set of rules to use when comparing strings complying with the</td>
</tr>
<tr>
<td>conventions of a particular language.</td>
<td></td>
</tr>
<tr>
<td><code>hint</code></td>
<td>The index to use for this operation. May be specified as a Hash</td>
</tr>
</tbody></table>

<pre class="code ruby"><code class="ruby">(<span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_g'>g</span>. { <span class='CHAR'>\</span><span class='label'>_id:</span> <span class='int'>1</span> }) <span class='kw'>or</span> <span class='id identifier rubyid_as'>as</span> <span class='id identifier rubyid_a'>a</span> <span class='const'>String</span> (<span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_g'>g</span>. <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\_[id]()</span><span class='tstring_end'>&quot;</span></span>). <span class='const'>Supported</span> <span class='id identifier rubyid_on'>on</span> <span class='const'>MongoDB</span>       
<span class='id identifier rubyid_server'>server</span> <span class='id identifier rubyid_versions'>versions</span> <span class='float'>4.2</span> <span class='kw'>and</span> <span class='id identifier rubyid_newer'>newer</span> <span class='kw'>for</span> {<span class='id identifier rubyid_update_one'>update_one</span>}<span class='comma'>,</span> {<span class='id identifier rubyid_update_many'>update_many</span>}<span class='comma'>,</span> <span class='kw'>and</span>              
{<span class='id identifier rubyid_replace_one'>replace_one</span>} <span class='id identifier rubyid_commands'>commands</span><span class='comma'>,</span> <span class='kw'>and</span> <span class='id identifier rubyid_on'>on</span> <span class='id identifier rubyid_server'>server</span> <span class='id identifier rubyid_versions'>versions</span> <span class='float'>4.4</span> <span class='kw'>and</span> <span class='id identifier rubyid_newer'>newer</span> <span class='kw'>for</span>                
{<span class='id identifier rubyid_find_one_and_delete'>find_one_and_delete</span>}<span class='comma'>,</span> {<span class='id identifier rubyid_find_one_and_update'>find_one_and_update</span>}<span class='comma'>,</span> <span class='kw'>and</span> {<span class='id identifier rubyid_find_one_and_replace'>find_one_and_replace</span>}        
<span class='id identifier rubyid_commands'>commands</span>.                                                                       <span class='op'>|</span></code></pre>

<p>| <code>let(Hash)</code>                  | Mapping of <code>variables&lt;/reference/command/update/#std-label-update-let-syntax&gt;</code> 
                                to use for this operation.                                                      |
| <code>projection</code>                 | The fields to exclude or include in the operation result (only available<br>
                                on <code>find_one_and_delete</code>, <code>find_one_and_replace</code>, and<br>
                                <code>find_one_and_update</code> commands).                                                |
| <code>return_document</code>            | A symbol specifying whether to return the updated document as it was before or 
                                after the update. Potential values are <code>:before</code> or <code>:after</code>.<br>
                                (Only available on <code>find_one_and_update</code> and <code>find_one_and_replace</code> commands).  |
| <code>sort</code>                       | How to sort the results of a find and modify command. Specified as a Hash<br>
                                key-value pair, where the key is the name of the field to sort by, and<br>
                                the value is either 1 or -1, specifying a sort in ascending or descending<br>
                                order (only available on <code>find_one_and_delete</code>, <code>find_one_and_replace</code>,<br>
                                and <code>find_one_and_update</code> commands).                                            |
| <code>session</code>                    | The session to use for this operation.                                         |
| <code>upsert</code>                     | Whether to upsert if the document doesn&#39;t exist. Cannot be used on<br>
                                <code>find_one_and_delete</code> operation.                                                |</p>

<p>For more information about update options, see the MongoDB server documentation
on the following commands:</p>

<ul>
<li>  <code>update &lt;/reference/command/update&gt;</code></li>
<li>  <code>findAndModify &lt;/reference/command/findAndModify&gt;</code></li>
</ul>

<h2>Deleting</h2>

<p><code>delete_one</code></p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_artists'>artists</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>]

<span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Björk</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_delete_one'>delete_one</span>
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_deleted_count'>deleted_count</span> <span class='comment'># Returns 1.
</span>
<span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_delete_one'>delete_one</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Björk</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_deleted_count'>deleted_count</span> <span class='comment'># Returns 1.</span></code></pre>

<p><code>delete_many</code></p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mute</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_delete_many'>delete_many</span>
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_deleted_count'>deleted_count</span> <span class='comment'># Returns the number deleted.
</span>
<span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_delete_many'>delete_many</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_label'>label</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mute</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_deleted_count'>deleted_count</span> <span class='comment'># Returns the number deleted.</span></code></pre>

<h3>Delete Options</h3>

<p>To add options to a delete command, specify them as key-value pairs in the
options Hash argument.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_database'>database</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_artists'>artists</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span>]

<span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_indexes'>indexes</span>.<span class='id identifier rubyid_create_one'>create_one</span>(<span class='label'>name:</span> <span class='int'>1</span>)

<span class='comment'># Force the server to use the name index to perform this operation
</span><span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_artists'>artists</span>.<span class='id identifier rubyid_find'>find</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Björk</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_delete_one'>delete_one</span>(<span class='label'>hint:</span> { <span class='label'>name:</span> <span class='int'>1</span> })
<span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_deleted_count'>deleted_count</span> <span class='comment'># Returns 1.</span></code></pre>

<p>The following is a full list of the available options that can be added
to <code>delete_one</code> and <code>delete_many</code> operations.</p>

<table><thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code>collation</code></td>
<td>Specifies a set of rules to use when comparing strings complying with the</td>
</tr>
<tr>
<td>conventions of a particular language.</td>
<td></td>
</tr>
<tr>
<td><code>hint</code></td>
<td>The index to use for this operation. May be specified as a Hash</td>
</tr>
</tbody></table>

<pre class="code ruby"><code class="ruby">(<span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_g'>g</span>. { <span class='CHAR'>\</span><span class='label'>_id:</span> <span class='int'>1</span> }) <span class='kw'>or</span> <span class='id identifier rubyid_as'>as</span> <span class='id identifier rubyid_a'>a</span> <span class='const'>String</span> (<span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_g'>g</span>. <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\_[id]()</span><span class='tstring_end'>&quot;</span></span>). <span class='const'>Supported</span> <span class='id identifier rubyid_on'>on</span> <span class='const'>MongoDB</span>       
<span class='id identifier rubyid_server'>server</span> <span class='id identifier rubyid_versions'>versions</span> <span class='float'>4.4</span> <span class='kw'>and</span> <span class='id identifier rubyid_newer'>newer</span>.                                                  <span class='op'>|</span></code></pre>

<p>| <code>let(Hash)</code> | Mapping of <code>variables&lt;/reference/command/delete/#std-label-delete-let-syntax&gt;</code> 
               to use for this operation.                                                      |
| <code>session</code>   | The session to use for this operation.                                         |</p>

<p>For more information about update options, see the MongoDB server documentation
on the <code>delete command. &lt;/reference/command/delete&gt;</code></p>

<h2>Write Concern</h2>

<p>All write operations in MongoDB are executed with a write concern which is
the level of acknowledgment requested from MongoDB for the particular write.
More information about write concerns in general is available in the
<a href="https://mongodb.com/docs/manual/reference/write-concern/">MongoDB manual</a>.</p>

<p>The Ruby driver supports specifying write concern on client, collection,
session (for transactions on that session), transaction, GridFS bucket
and write stream levels, as well as when manually issuing commands via
<code>Database#command</code>.</p>

<p>As of driver version 2.10, all driver objects accepting write concerns do so
through the <code>:write_concern</code> option, which should be given a hash with
the write concern options. Usage of the <code>:write</code> option is deprecated.
In driver versions 2.9 and below, client, collection and GridFS objects
took write concern options in the <code>:write</code> option with session and
transaction objects employing the <code>:write_concern</code> option.</p>

<p>Below are some examples of passing write concerns to client and collection
objects. The <code>:write_concern</code> option can be provided when constructing
new client and collection objects, or to the <code>#with</code> methods.</p>

<p>GridFS examples are provided on the <code>GridFS &lt;gridfs&gt;</code> page.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>2</span>})
<span class='id identifier rubyid_alt_client'>alt_client</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>})

<span class='id identifier rubyid_collection'>collection</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span><span class='comma'>,</span> <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>3</span>}]
<span class='id identifier rubyid_alt_collection'>alt_collection</span> <span class='op'>=</span> <span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>})

<span class='comment'># Uses w: 3
</span><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_insert_one'>insert_one</span>({<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SUN Project</span><span class='tstring_end'>&#39;</span></span>})
<span class='comment'># Uses w: :majority
</span><span class='id identifier rubyid_alt_collection'>alt_collection</span>.<span class='id identifier rubyid_insert_one'>insert_one</span>({<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SUN Project</span><span class='tstring_end'>&#39;</span></span>})</code></pre>

<p>Driver versions 2.9 and earlier accepted write concerns on client and collection
level via the <code>:write</code> option. This usage continues to be supported for
backwards compatibility, but is deprecated:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>write:</span> {<span class='label'>w:</span> <span class='int'>2</span>})
<span class='id identifier rubyid_alt_client'>alt_client</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>write:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>})

<span class='id identifier rubyid_collection'>collection</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span><span class='comma'>,</span> <span class='label'>write:</span> {<span class='label'>w:</span> <span class='int'>3</span>}]
<span class='id identifier rubyid_alt_collection'>alt_collection</span> <span class='op'>=</span> <span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>write:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>})</code></pre>

<p>If both <code>:write</code> and <code>:write_concern</code> options are provided, their
values must be identical or an exception will be raised:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># OK
</span><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>3</span>}<span class='comma'>,</span> <span class='label'>write:</span> {<span class='label'>w:</span> <span class='int'>3</span>})

<span class='comment'># Error
</span><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>3</span>}<span class='comma'>,</span> <span class='label'>write:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>})</code></pre>

<p>When <code>#with</code> methods are used to alter the options on a client or collection,
the last provided option wins in case of naming differences:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>2</span>})
<span class='id identifier rubyid_alt_client'>alt_client</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>write:</span> {<span class='label'>w:</span> <span class='int'>3</span>})

<span class='id identifier rubyid_alt_client'>alt_client</span>.<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write'>write</span>]
<span class='comment'># =&gt; {&quot;w&quot;=&gt;3}
</span>
<span class='id identifier rubyid_alt_client'>alt_client</span>.<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>]
<span class='comment'># =&gt; nil</span></code></pre>

<p>When using transactions, write concern is only sent to the server in
<code>commit_transaction</code> and <code>abort_transaction</code> operations
per the <a href="https://github.com/mongodb/specifications/blob/master/source/transactions/transactions.rst#writeconcern">transactions specification</a>.
Write concern may be set via the <code>:write_concern</code> option in a
<code>with_transaction</code> or <code>start_transaction</code> call, or via
<code>default_transaction_options</code> option on a session object.
If neither of these is set, write concern of the client is used; note
that transactions ignore write concerns of collections that are involved
in their operations. Note that when setting the write concern as a
transaction option, the <code>:write</code> option is not recognized by any
driver version.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>2</span>})
<span class='id identifier rubyid_collection'>collection</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span><span class='comma'>,</span> <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>}]


<span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_start_session'>start_session</span>
<span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_with_transaction'>with_transaction</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_insert_one'>insert_one</span>({<span class='label'>test:</span> <span class='int'>1</span>}<span class='comma'>,</span> <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span>)

  <span class='comment'># Uses w: 2 when committing
</span><span class='kw'>end</span>


<span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_start_session'>start_session</span>(<span class='label'>default_transaction_options:</span>
  {<span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>3</span>})
)
<span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_with_transaction'>with_transaction</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_insert_one'>insert_one</span>({<span class='label'>test:</span> <span class='int'>1</span>}<span class='comma'>,</span> <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span>)

  <span class='comment'># Uses w: 3 when committing
</span><span class='kw'>end</span>


<span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_start_session'>start_session</span>
<span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_with_transaction'>with_transaction</span>(<span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>3</span>}) <span class='kw'>do</span>
  <span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_insert_one'>insert_one</span>({<span class='label'>test:</span> <span class='int'>1</span>}<span class='comma'>,</span> <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span>)

  <span class='comment'># Uses w: 3 when committing
</span><span class='kw'>end</span></code></pre>

<p>When write concerns are inherited, inheritance applies to the entire
write concern hash rather than individual elements. For example, <code>j: true</code>
is not inherited in the following case:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>j:</span> <span class='kw'>true</span>})
<span class='id identifier rubyid_collection'>collection</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span><span class='comma'>,</span> <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>2</span>}]

<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_write_concern'>write_concern</span>.<span class='id identifier rubyid_options'>options</span>
<span class='comment'># =&gt; #&lt;Mongo::WriteConcern::Acknowledged:0x47289650367880 options={:w=&gt;2}&gt;</span></code></pre>

<p>Although CRUD operations accept an options hash, they currently do not
recognize the <code>:write_concern</code> option:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'><a href="Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Mongo/Client.html" title="Mongo::Client (class)">Client</a></span>.<span class='id identifier rubyid_new'><a href="Mongo/Client.html#new-class_method" title="Mongo::Client.new (method)">new</a></span>([ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>127.0.0.1:27017</span><span class='tstring_end'>&#39;</span></span> ]<span class='comma'>,</span> <span class='label'>database:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>music</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>2</span>})
<span class='id identifier rubyid_collection'>collection</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artists'>artists</span><span class='comma'>,</span> <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>}]

<span class='comment'># Still uses w: :majority
</span><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_insert_one'>insert_one</span>({<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SUN Project</span><span class='tstring_end'>&#39;</span></span>}<span class='comma'>,</span> <span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>1</span>})</code></pre>

<p>The easiest workaround for this is to use <code>#with</code> to obtain a new collection
instance with the desired write concern:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Uses w: 1
</span><span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='int'>1</span>}).<span class='id identifier rubyid_insert_one'>insert_one</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SUN Project</span><span class='tstring_end'>&#39;</span></span>)</code></pre>

<p>Write concern can also be manually specified in <code>Database#command</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_command'>command</span>(<span class='label'>create:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>foo-collection</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>writeConcern:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>})</code></pre>

<p>Note that writeConcern here is part of the operation rather than options,
and the syntax is the camel case one that MongoDB server recognizes, not the
underscore one that Ruby driver uses.</p>

<h2>Field Names with Dots/Periods (.) and Dollar Signs (\$) [dots-dollars-in-field-names]</h2>

<p>Starting in Mongo Ruby Driver version 2.18.0, the ability to work with fields
that begin with dollar signs (\$) and fields with dots/periods (.) in them is available.
In Driver version 2.17.0 and earlier, any attempt to work with dotted or dollared
fields would result in an <code>IllegalKey</code> error being raised. See the MongoDB docs
on <a href="https://www.mongodb.com/docs/manual/core/dot-dollar-considerations/">Field Names with Periods (.) and Dollar Signs (\$)</a>
for more information on working with these types of fields.</p>

<h2>A Note about the BSON Symbol type</h2>

<p>Because the BSON specification deprecated the BSON symbol type, the <code>bson</code> gem
will serialize Ruby symbols into BSON strings when used on its own. However, in
order to maintain backwards compatibility with older datasets, the Ruby driver
overrides this behavior to serialize Ruby symbols as BSON symbols. This is
necessary to be able to specify queries for documents which contain BSON
symbols as fields. Despite this, new documents with symbol type fields should
<em>not</em> be stored in the database; instead, use string fields.</p>

<p>To override default behavior and configure the driver to encode symbol values
as strings, include the following code snippet in your project:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'><a href="Symbol.html" title="Symbol (class)">Symbol</a></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_bson_type'>bson_type</span>
    <span class='const'>BSON</span><span class='op'>::</span><span class='const'>String</span><span class='op'>::</span><span class='const'>BSON_TYPE</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>