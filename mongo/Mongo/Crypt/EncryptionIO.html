<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Crypt::EncryptionIO &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Crypt::EncryptionIO",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongo master</a> &raquo; 
      <a href='../../_index.html#alpha_E'>Index (E)</a> &raquo; 
        <a href="../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../Crypt.html" title="Mongo::Crypt (module)">Crypt</a> &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>EncryptionIO&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Crypt::EncryptionIO  <span class='private note title'>Private</span>
</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This class is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L25'>lib/mongo/crypt/encryption_io.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>A class that implements I/O methods between the driver and the MongoDB server or mongocryptd.</p>

  </div>
</div>
<div class='tags'>
  
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full nodoc'>
  <li>
    <span id='SOCKET_TIMEOUT-constant' class='summary_signature nodoc'>SOCKET_TIMEOUT =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p><a href="../Timeout.html" title="Mongo::Timeout (module)"><code>::Mongo::Timeout</code></a> used for TLS socket connection, reading, and writing. There is no specific timeout written in the spec. See SPEC-1394 for a discussion and updates on what this timeout should be.</p>

  </div>
</div>
<div class='tags'>
  
</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L30-L30'># File 'lib/mongo/crypt/encryption_io.rb', line 30</a>    <pre class='code ruby'><span class='int'>10</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(client: nil, mongocryptd_client: nil, key_vault_namespace:, key_vault_client:, metadata_client:, mongocryptd_options: {})  &#x21d2; EncryptionIO </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Creates a new <code>EncryptionIO</code> object with information about how to connect to the key vault.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#add_key_alt_name-instance_method" title="#add_key_alt_name (instance method)">#<strong>add_key_alt_name</strong>(id, key_alt_name, timeout_ms: nil)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Adds a key_alt_name to the key_alt_names array of the key document in the key vault collection with the given id.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#collection_info-instance_method" title="#collection_info (instance method)">#<strong>collection_info</strong>(db_name, filter, timeout_ms: nil)  &#x21d2; Hash </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Get collection info for a collection matching the provided filter.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#delete_key-instance_method" title="#delete_key (instance method)">#<strong>delete_key</strong>(id, timeout_ms: nil)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Removes the key document with the given id from the key vault collection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#feed_kms-instance_method" title="#feed_kms (instance method)">#<strong>feed_kms</strong>(kms_context, tls_options, timeout_ms: nil)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Get information about the remote <a href="KMS.html" title="Mongo::Crypt::KMS (module)"><code>KMS</code></a> encryption key and feed it to the the <a href="KmsContext.html" title="Mongo::Crypt::KmsContext (class)"><code>KmsContext</code></a> object.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#find_keys-instance_method" title="#find_keys (instance method)">#<strong>find_keys</strong>(filter, timeout_ms: nil)  &#x21d2; Array&lt;BSON::Document&gt; </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Query for keys in the key vault collection using the provided filter.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#get_key-instance_method" title="#get_key (instance method)">#<strong>get_key</strong>(id, timeout_ms: nil)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Finds a single key document with the given id.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#get_key_by_alt_name-instance_method" title="#get_key_by_alt_name (instance method)">#<strong>get_key_by_alt_name</strong>(key_alt_name, timeout_ms: nil)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns a key document in the key vault collection with the given key_alt_name.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#get_keys-instance_method" title="#get_keys (instance method)">#<strong>get_keys</strong>(timeout_ms: nil)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Finds all documents in the key vault collection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#insert_data_key-instance_method" title="#insert_data_key (instance method)">#<strong>insert_data_key</strong>(document, timeout_ms: nil)  &#x21d2; Mongo::Operation::Insert::Result </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Insert a document into the key vault collection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#mark_command-instance_method" title="#mark_command (instance method)">#<strong>mark_command</strong>(cmd, timeout_ms: nil)  &#x21d2; Hash </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Send the command to mongocryptd to be marked with intent-to-encrypt markings.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#remove_key_alt_name-instance_method" title="#remove_key_alt_name (instance method)">#<strong>remove_key_alt_name</strong>(id, key_alt_name, timeout_ms: nil)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Removes a key_alt_name from the key_alt_names array of the key document in the key vault collection with the given id.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#update_data_keys-instance_method" title="#update_data_keys (instance method)">#<strong>update_data_keys</strong>(updates, timeout_ms: nil)  &#x21d2; BulkWrite::Result </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Apply given requests to the key vault collection using bulk write.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#key_vault_collection-instance_method" title="#key_vault_collection (instance method)">#<strong>key_vault_collection</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Use the provided key vault client and namespace to construct a <a href="../Collection.html" title="Mongo::Collection (class)"><code>::Mongo::Collection</code></a> object representing the key vault collection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#spawn_mongocryptd-instance_method" title="#spawn_mongocryptd (instance method)">#<strong>spawn_mongocryptd</strong>  &#x21d2; Integer </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Spawn a new mongocryptd process using the mongocryptd_spawn_path and mongocryptd_spawn_args passed in through the extra auto encrypt options.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#validate_key_vault_client!-instance_method" title="#validate_key_vault_client! (instance method)">#<strong>validate_key_vault_client!</strong>(key_vault_client)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#validate_key_vault_namespace!-instance_method" title="#validate_key_vault_namespace! (instance method)">#<strong>validate_key_vault_namespace!</strong>(key_vault_namespace)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#with_ssl_socket-instance_method" title="#with_ssl_socket (instance method)">#<strong>with_ssl_socket</strong>(endpoint, tls_options, timeout_ms: nil) {|ssl_socket| ... } </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Provide a TLS socket to be used for <a href="KMS.html" title="Mongo::Crypt::KMS (module)"><code>KMS</code></a> calls in a block API.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="add_key_alt_name-instance_method">
  <h3 class='signature nodoc first'>
    #<strong>add_key_alt_name</strong>(id, key_alt_name, timeout_ms: nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Adds a key_alt_name to the key_alt_names array of the key document in the key vault collection with the given id.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L185-L191'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='185' data-end='191'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 185</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add_key_alt_name'>add_key_alt_name</span>(<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_key_alt_name'>key_alt_name</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_key_vault_collection'><a href="#key_vault_collection-instance_method" title="Mongo::Crypt::EncryptionIO#key_vault_collection (method)">key_vault_collection</a></span>.<span class='id identifier rubyid_find_one_and_update'>find_one_and_update</span>(
    { <span class='label'>_id:</span> <span class='id identifier rubyid_id'>id</span> }<span class='comma'>,</span>
    { <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$addToSet</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> { <span class='label'>keyAltNames:</span> <span class='id identifier rubyid_key_alt_name'>key_alt_name</span> } }<span class='comma'>,</span>
    <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>
  )
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="collection_info-instance_method">
  <h3 class='signature nodoc'>
    #<strong>collection_info</strong>(db_name, filter, timeout_ms: nil)  &#x21d2; <code>Hash</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get collection info for a collection matching the provided filter</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>filter</span>
    <span class='type'>(<code>Hash</code>)</span>
  </li>
  <li>
    <span class='name'>:timeout_ms</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The operation timeout in milliseconds. Must be a non-negative integer. An explicit value of 0 means infinite. The default value is unset which means the feature is not enabled.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>The collection information</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L105-L115'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='105' data-end='115'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 105</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_collection_info'>collection_info</span>(<span class='id identifier rubyid_db_name'>db_name</span><span class='comma'>,</span> <span class='id identifier rubyid_filter'>filter</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='kw'>unless</span> <span class='ivar'>@metadata_client</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>collection_info requires metadata_client to have been passed to the constructor, but it was not</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='ivar'>@metadata_client</span>
    .<span class='id identifier rubyid_use'>use</span>(<span class='id identifier rubyid_db_name'>db_name</span>)
    .<span class='id identifier rubyid_database'>database</span>
    .<span class='id identifier rubyid_list_collections'>list_collections</span>(<span class='label'>filter:</span> <span class='id identifier rubyid_filter'>filter</span><span class='comma'>,</span> <span class='label'>deserialize_as_bson:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>)
    .<span class='id identifier rubyid_first'>first</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="delete_key-instance_method">
  <h3 class='signature nodoc'>
    #<strong>delete_key</strong>(id, timeout_ms: nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Removes the key document with the given id from the key vault collection.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L195-L197'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='195' data-end='197'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 195</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_delete_key'>delete_key</span>(<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_key_vault_collection'><a href="#key_vault_collection-instance_method" title="Mongo::Crypt::EncryptionIO#key_vault_collection (method)">key_vault_collection</a></span>.<span class='id identifier rubyid_delete_one'>delete_one</span>(<span class='label'>_id:</span> <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="feed_kms-instance_method">
  <h3 class='signature nodoc'>
    #<strong>feed_kms</strong>(kms_context, tls_options, timeout_ms: nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get information about the remote <a href="KMS.html" title="Mongo::Crypt::KMS (module)"><code>KMS</code></a> encryption key and feed it to the the <a href="KmsContext.html" title="Mongo::Crypt::KmsContext (class)"><code>KmsContext</code></a> object</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>kms_context</span>
    <span class='type'>(<a href="KmsContext.html" title="Mongo::Crypt::KmsContext (class)">Mongo::Crypt::KmsContext</a>)</span>
&mdash;    <div class='inline'>
<p>A KmsContext object corresponding to one remote <a href="KMS.html" title="Mongo::Crypt::KMS (module)"><code>KMS</code></a> data key. Contains information about the endpoint at which to establish a TLS connection and the message to send on that connection.</p>
</div>
  </li>
  <li>
    <span class='name'>tls_options.</span>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>TLS options to connect to <a href="KMS.html" title="Mongo::Crypt::KMS (module)"><code>KMS</code></a> provider. The options are same as for <a href="../Client.html" title="Mongo::Client (class)"><code>::Mongo::Client</code></a>.</p>
</div>
  </li>
  <li>
    <span class='name'>:timeout_ms</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The operation timeout in milliseconds. Must be a non-negative integer. An explicit value of 0 means infinite. The default value is unset which means the feature is not enabled.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L161-L181'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='161' data-end='181'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 161</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_feed_kms'>feed_kms</span>(<span class='id identifier rubyid_kms_context'>kms_context</span><span class='comma'>,</span> <span class='id identifier rubyid_tls_options'>tls_options</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_with_ssl_socket'><a href="#with_ssl_socket-instance_method" title="Mongo::Crypt::EncryptionIO#with_ssl_socket (method)">with_ssl_socket</a></span>(<span class='id identifier rubyid_kms_context'>kms_context</span>.<span class='id identifier rubyid_endpoint'>endpoint</span><span class='comma'>,</span> <span class='id identifier rubyid_tls_options'>tls_options</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_ssl_socket'>ssl_socket</span><span class='op'>|</span>
    <span class='const'><a href="../Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span>.<span class='id identifier rubyid_timeout'><a href="../Timeout.html#timeout-class_method" title="Mongo::Timeout.timeout (method)">timeout</a></span>(<span class='id identifier rubyid_timeout_ms'>timeout_ms</span> <span class='op'>||</span> <span class='const'><a href="#SOCKET_TIMEOUT-constant" title="Mongo::Crypt::EncryptionIO::SOCKET_TIMEOUT (constant)">SOCKET_TIMEOUT</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Socket write operation timed out</span><span class='tstring_end'>&#39;</span></span>
    ) <span class='kw'>do</span>
      <span class='id identifier rubyid_ssl_socket'>ssl_socket</span>.<span class='id identifier rubyid_syswrite'>syswrite</span>(<span class='id identifier rubyid_kms_context'>kms_context</span>.<span class='id identifier rubyid_message'>message</span>)
    <span class='kw'>end</span>

    <span class='id identifier rubyid_bytes_needed'>bytes_needed</span> <span class='op'>=</span> <span class='id identifier rubyid_kms_context'>kms_context</span>.<span class='id identifier rubyid_bytes_needed'>bytes_needed</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_bytes_needed'>bytes_needed</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_bytes'>bytes</span> <span class='op'>=</span> <span class='const'><a href="../Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span>.<span class='id identifier rubyid_timeout'><a href="../Timeout.html#timeout-class_method" title="Mongo::Timeout.timeout (method)">timeout</a></span>(<span class='id identifier rubyid_timeout_ms'>timeout_ms</span> <span class='op'>||</span> <span class='const'><a href="#SOCKET_TIMEOUT-constant" title="Mongo::Crypt::EncryptionIO::SOCKET_TIMEOUT (constant)">SOCKET_TIMEOUT</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Socket read operation timed out</span><span class='tstring_end'>&#39;</span></span>
      ) <span class='kw'>do</span>
        <span class='id identifier rubyid_ssl_socket'>ssl_socket</span>.<span class='id identifier rubyid_sysread'>sysread</span>(<span class='id identifier rubyid_bytes_needed'>bytes_needed</span>)
      <span class='kw'>end</span>

      <span class='id identifier rubyid_kms_context'>kms_context</span>.<span class='id identifier rubyid_feed'>feed</span>(<span class='id identifier rubyid_bytes'>bytes</span>)
      <span class='id identifier rubyid_bytes_needed'>bytes_needed</span> <span class='op'>=</span> <span class='id identifier rubyid_kms_context'>kms_context</span>.<span class='id identifier rubyid_bytes_needed'>bytes_needed</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="find_keys-instance_method">
  <h3 class='signature nodoc'>
    #<strong>find_keys</strong>(filter, timeout_ms: nil)  &#x21d2; <code>Array</code>&lt;<code>BSON::Document</code>&gt; 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Query for keys in the key vault collection using the provided filter</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>filter</span>
    <span class='type'>(<code>Hash</code>)</span>
  </li>
  <li>
    <span class='name'>:timeout_ms</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The operation timeout in milliseconds. Must be a non-negative integer. An explicit value of 0 means infinite. The default value is unset which means the feature is not enabled.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>&lt;<code>BSON::Document</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The query results</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L81-L83'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='81' data-end='83'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 81</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_find_keys'>find_keys</span>(<span class='id identifier rubyid_filter'>filter</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_key_vault_collection'><a href="#key_vault_collection-instance_method" title="Mongo::Crypt::EncryptionIO#key_vault_collection (method)">key_vault_collection</a></span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_filter'>filter</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>).<span class='id identifier rubyid_to_a'>to_a</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="get_key-instance_method">
  <h3 class='signature nodoc'>
    #<strong>get_key</strong>(id, timeout_ms: nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Finds a single key document with the given id.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L200-L202'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='200' data-end='202'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 200</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_get_key'>get_key</span>(<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_key_vault_collection'><a href="#key_vault_collection-instance_method" title="Mongo::Crypt::EncryptionIO#key_vault_collection (method)">key_vault_collection</a></span>.<span class='id identifier rubyid_find'>find</span>(<span class='label'>_id:</span> <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>).<span class='id identifier rubyid_first'>first</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="get_key_by_alt_name-instance_method">
  <h3 class='signature nodoc'>
    #<strong>get_key_by_alt_name</strong>(key_alt_name, timeout_ms: nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns a key document in the key vault collection with the given key_alt_name.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L206-L208'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='206' data-end='208'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 206</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_get_key_by_alt_name'>get_key_by_alt_name</span>(<span class='id identifier rubyid_key_alt_name'>key_alt_name</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_key_vault_collection'><a href="#key_vault_collection-instance_method" title="Mongo::Crypt::EncryptionIO#key_vault_collection (method)">key_vault_collection</a></span>.<span class='id identifier rubyid_find'>find</span>(<span class='label'>keyAltNames:</span> <span class='id identifier rubyid_key_alt_name'>key_alt_name</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>).<span class='id identifier rubyid_first'>first</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="get_keys-instance_method">
  <h3 class='signature nodoc'>
    #<strong>get_keys</strong>(timeout_ms: nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Finds all documents in the key vault collection.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L211-L213'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='211' data-end='213'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 211</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_get_keys'>get_keys</span>(<span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_key_vault_collection'><a href="#key_vault_collection-instance_method" title="Mongo::Crypt::EncryptionIO#key_vault_collection (method)">key_vault_collection</a></span>.<span class='id identifier rubyid_find'>find</span>(<span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="insert_data_key-instance_method">
  <h3 class='signature nodoc'>
    #<strong>insert_data_key</strong>(document, timeout_ms: nil)  &#x21d2; <a href="../Operation/Insert/Result.html" title="Mongo::Operation::Insert::Result (class)">Mongo::Operation::Insert::Result</a> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Insert a document into the key vault collection</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>document</span>
    <span class='type'>(<code>Hash</code>)</span>
  </li>
  <li>
    <span class='name'>:timeout_ms</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The operation timeout in milliseconds. Must be a non-negative integer. An explicit value of 0 means infinite. The default value is unset which means the feature is not enabled.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Operation/Insert/Result.html" title="Mongo::Operation::Insert::Result (class)">Mongo::Operation::Insert::Result</a>)</span>
&mdash;    <div class='inline'>
<p>The insertion result</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L93-L95'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='93' data-end='95'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 93</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_insert_data_key'>insert_data_key</span>(<span class='id identifier rubyid_document'>document</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_key_vault_collection'><a href="#key_vault_collection-instance_method" title="Mongo::Crypt::EncryptionIO#key_vault_collection (method)">key_vault_collection</a></span>.<span class='id identifier rubyid_insert_one'>insert_one</span>(<span class='id identifier rubyid_document'>document</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="key_vault_collection-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>key_vault_collection</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Use the provided key vault client and namespace to construct a <a href="../Collection.html" title="Mongo::Collection (class)"><code>::Mongo::Collection</code></a> object representing the key vault collection.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L280-L286'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='280' data-end='286'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 280</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_key_vault_collection'>key_vault_collection</span>
  <span class='ivar'>@key_vault_collection</span> <span class='op'>||=</span> <span class='ivar'>@key_vault_client</span>.<span class='id identifier rubyid_with'>with</span>(
    <span class='label'>database:</span> <span class='ivar'>@key_vault_db_name</span><span class='comma'>,</span>
    <span class='label'>read_concern:</span> { <span class='label'>level:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span> }<span class='comma'>,</span>
    <span class='label'>write_concern:</span> { <span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span> }
  )[<span class='ivar'>@key_vault_collection_name</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="mark_command-instance_method">
  <h3 class='signature nodoc'>
    #<strong>mark_command</strong>(cmd, timeout_ms: nil)  &#x21d2; <code>Hash</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Send the command to mongocryptd to be marked with intent-to-encrypt markings</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>cmd</span>
    <span class='type'>(<code>Hash</code>)</span>
  </li>
  <li>
    <span class='name'>:timeout_ms</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The operation timeout in milliseconds. Must be a non-negative integer. An explicit value of 0 means infinite. The default value is unset which means the feature is not enabled.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>The marked command</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L125-L147'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='125' data-end='147'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 125</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_mark_command'>mark_command</span>(<span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='kw'>unless</span> <span class='ivar'>@mongocryptd_client</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mark_command requires mongocryptd_client to have been passed to the constructor, but it was not</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Ensure the response from mongocryptd is deserialized with { mode: :bson }
</span>  <span class='comment'># to prevent losing type information in commands
</span>  <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> {
    <span class='label'>execution_options:</span> { <span class='label'>deserialize_as_bson:</span> <span class='kw'>true</span> }<span class='comma'>,</span>
    <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>
  }

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='ivar'>@mongocryptd_client</span>.<span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_command'>command</span>(<span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span>)
  <span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span> <span class='kw'>if</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_mongocryptd_bypass_spawn'>mongocryptd_bypass_spawn</span>]

    <span class='id identifier rubyid_spawn_mongocryptd'><a href="#spawn_mongocryptd-instance_method" title="Mongo::Crypt::EncryptionIO#spawn_mongocryptd (method)">spawn_mongocryptd</a></span>
    <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='ivar'>@mongocryptd_client</span>.<span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_command'>command</span>(<span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span>)
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_first'>first</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="remove_key_alt_name-instance_method">
  <h3 class='signature nodoc'>
    #<strong>remove_key_alt_name</strong>(id, key_alt_name, timeout_ms: nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Removes a key_alt_name from the key_alt_names array of the key document in the key vault collection with the given id.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L217-L240'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='217' data-end='240'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 217</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_key_alt_name'>remove_key_alt_name</span>(<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_key_alt_name'>key_alt_name</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_key_vault_collection'><a href="#key_vault_collection-instance_method" title="Mongo::Crypt::EncryptionIO#key_vault_collection (method)">key_vault_collection</a></span>.<span class='id identifier rubyid_find_one_and_update'>find_one_and_update</span>(
    { <span class='label'>_id:</span> <span class='id identifier rubyid_id'>id</span> }<span class='comma'>,</span>
    [
      {
        <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> {
          <span class='label'>keyAltNames:</span> {
            <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$cond</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> [
              { <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$eq</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> [ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$keyAltNames</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> [ <span class='id identifier rubyid_key_alt_name'>key_alt_name</span> ] ] }<span class='comma'>,</span>
              <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$$REMOVE</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
              {
                <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$filter</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> {
                  <span class='label'>input:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$keyAltNames</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
                  <span class='label'>cond:</span> { <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$ne</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span>  [ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$$this</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_key_alt_name'>key_alt_name</span> ] }
                }
              }
            ]
          }
        }
      }
    ]<span class='comma'>,</span>
    <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>
  )
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="spawn_mongocryptd-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>spawn_mongocryptd</strong>  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>To capture the mongocryptd logs, add “–logpath=/path/to/logs” to auto_encryption_options -&gt; extra_options -&gt; mongocrpytd_spawn_args</p>
</div>
  </div>


<p>Spawn a new mongocryptd process using the mongocryptd_spawn_path and mongocryptd_spawn_args passed in through the extra auto encrypt options. Stdout and Stderr of this new process are written to /dev/null.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The process id of the spawned process</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<code>ArgumentError</code>)</span>
&mdash;    <div class='inline'>
<p>Raises an exception if no encryption options have been provided</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L300-L334'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='300' data-end='334'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 300</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_spawn_mongocryptd'>spawn_mongocryptd</span>
  <span class='id identifier rubyid_mongocryptd_spawn_args'>mongocryptd_spawn_args</span> <span class='op'>=</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_mongocryptd_spawn_args'>mongocryptd_spawn_args</span>]
  <span class='id identifier rubyid_mongocryptd_spawn_path'>mongocryptd_spawn_path</span> <span class='op'>=</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_mongocryptd_spawn_path'>mongocryptd_spawn_path</span>]

  <span class='kw'>unless</span> <span class='id identifier rubyid_mongocryptd_spawn_path'>mongocryptd_spawn_path</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Crypt::EncryptionIO.new (method)">new</a></span>(
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Cannot spawn mongocryptd process when no </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:mongocryptd_spawn_path option is provided</span><span class='tstring_end'>&#39;</span></span>
    )
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_mongocryptd_spawn_path'>mongocryptd_spawn_path</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span>
    <span class='id identifier rubyid_mongocryptd_spawn_args'>mongocryptd_spawn_args</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_mongocryptd_spawn_args'>mongocryptd_spawn_args</span>.<span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>then</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Crypt::EncryptionIO.new (method)">new</a></span>(
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Cannot spawn mongocryptd process when no :mongocryptd_spawn_args </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>option is provided. To start mongocryptd without arguments, pass </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;--&quot; for :mongocryptd_spawn_args</span><span class='tstring_end'>&#39;</span></span>
    )
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='const'>Process</span>.<span class='id identifier rubyid_spawn'>spawn</span>(
      <span class='id identifier rubyid_mongocryptd_spawn_path'>mongocryptd_spawn_path</span><span class='comma'>,</span>
      <span class='op'>*</span><span class='id identifier rubyid_mongocryptd_spawn_args'>mongocryptd_spawn_args</span><span class='comma'>,</span>
      [<span class='symbeg'>:</span><span class='id identifier rubyid_out'>out</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_err'>err</span>]<span class='op'>=&gt;</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&#39;</span></span>
    )
  <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOENT</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/MongocryptdSpawnError.html" title="Mongo::Error::MongocryptdSpawnError (class)">MongocryptdSpawnError</a></span>.<span class='id identifier rubyid_new'><a href="../Error/CryptError.html#new-class_method" title="Mongo::Error::CryptError.new (method)">new</a></span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to spawn mongocryptd at the path \&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_mongocryptd_spawn_path'>mongocryptd_spawn_path</span><span class='embexpr_end'>}</span><span class='tstring_content'>\&quot; </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>with arguments </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_mongocryptd_spawn_args'>mongocryptd_spawn_args</span><span class='embexpr_end'>}</span><span class='tstring_content'>. Received error </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: \&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'>\&quot;</span><span class='tstring_end'>&quot;</span></span>
    )
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_data_keys-instance_method">
  <h3 class='signature nodoc'>
    #<strong>update_data_keys</strong>(updates, timeout_ms: nil)  &#x21d2; <a href="../BulkWrite/Result.html" title="Mongo::BulkWrite::Result (class)">BulkWrite::Result</a> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Apply given requests to the key vault collection using bulk write.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>requests</span>
    <span class='type'>(<code>Array</code>&lt;<code>Hash</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The bulk write requests.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../BulkWrite/Result.html" title="Mongo::BulkWrite::Result (class)">BulkWrite::Result</a>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L247-L249'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='247' data-end='249'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 247</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_data_keys'>update_data_keys</span>(<span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_key_vault_collection'><a href="#key_vault_collection-instance_method" title="Mongo::Crypt::EncryptionIO#key_vault_collection (method)">key_vault_collection</a></span>.<span class='id identifier rubyid_bulk_write'>bulk_write</span>(<span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_key_vault_client!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>validate_key_vault_client!</strong>(key_vault_client)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L253-L263'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='253' data-end='263'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 253</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_key_vault_client!'>validate_key_vault_client!</span>(<span class='id identifier rubyid_key_vault_client'>key_vault_client</span>)
  <span class='kw'>unless</span> <span class='id identifier rubyid_key_vault_client'>key_vault_client</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Crypt::EncryptionIO.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The :key_vault_client option cannot be nil</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_key_vault_client'>key_vault_client</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../Client.html" title="Mongo::Client (class)">Client</a></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Crypt::EncryptionIO.new (method)">new</a></span>(
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The :key_vault_client option must be an instance of Mongo::Client</span><span class='tstring_end'>&#39;</span></span>
    )
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_key_vault_namespace!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>validate_key_vault_namespace!</strong>(key_vault_namespace)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L265-L276'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='265' data-end='276'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 265</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_key_vault_namespace!'>validate_key_vault_namespace!</span>(<span class='id identifier rubyid_key_vault_namespace'>key_vault_namespace</span>)
  <span class='kw'>unless</span> <span class='id identifier rubyid_key_vault_namespace'>key_vault_namespace</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Crypt::EncryptionIO.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The :key_vault_namespace option cannot be nil</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_key_vault_namespace'>key_vault_namespace</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>2</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Crypt::EncryptionIO.new (method)">new</a></span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_key_vault_namespace'>key_vault_namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'> is an invalid key vault namespace.</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The :key_vault_namespace option must be in the format database.collection</span><span class='tstring_end'>&quot;</span></span>
    )
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="with_ssl_socket-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>with_ssl_socket</strong>(endpoint, tls_options, timeout_ms: nil) {|ssl_socket| ... }  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>The socket is always closed when the provided block has finished executing</p>
</div>
  </div>


<p>Provide a TLS socket to be used for <a href="KMS.html" title="Mongo::Crypt::KMS (module)"><code>KMS</code></a> calls in a block API</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>endpoint</span>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>The URI at which to connect the TLS socket.</p>
</div>
  </li>
  <li>
    <span class='name'>tls_options.</span>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>TLS options to connect to <a href="KMS.html" title="Mongo::Crypt::KMS (module)"><code>KMS</code></a> provider. The options are same as for <a href="../Client.html" title="Mongo::Client (class)"><code>::Mongo::Client</code></a>.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Yield Parameters:</p>
<ul class='yieldparam'>
  <li>
    <span class='name'>ssl_socket</span>
    <span class='type'>(<code>OpenSSL::SSL::SSLSocket</code>)</span>
&mdash;    <div class='inline'>
<p>Yields a TLS socket connected to the specified endpoint.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/KmsError.html" title="Mongo::Error::KmsError (class)">Mongo::Error::KmsError</a>)</span>
&mdash;    <div class='inline'>
<p>If the socket times out or raises an exception</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/crypt/encryption_io.rb#L349-L372'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='349' data-end='372'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/crypt/encryption_io.rb', line 349</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_with_ssl_socket'>with_ssl_socket</span>(<span class='id identifier rubyid_endpoint'>endpoint</span><span class='comma'>,</span> <span class='id identifier rubyid_tls_options'>tls_options</span><span class='comma'>,</span> <span class='label'>timeout_ms:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_csot'>csot</span> <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_timeout_ms'>timeout_ms</span>.<span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_address'>address</span> <span class='op'>=</span> <span class='kw'>begin</span>
    <span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='id identifier rubyid_endpoint'>endpoint</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_port'>port</span> <span class='op'>||=</span> <span class='int'>443</span> <span class='comment'># All supported KMS APIs use this port by default.
</span>    <span class='const'><a href="../Address.html" title="Mongo::Address (class)">Address</a></span>.<span class='id identifier rubyid_new'><a href="../Address.html#new-class_method" title="Mongo::Address.new (method)">new</a></span>([<span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span>].<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span>))
  <span class='kw'>end</span>
  <span class='id identifier rubyid_socket_options'>socket_options</span> <span class='op'>=</span> { <span class='label'>ssl:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>csot:</span> <span class='id identifier rubyid_csot'>csot</span> }.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_opts'>opts</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_csot'>csot</span>
      <span class='id identifier rubyid_opts'>opts</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_connect_timeout'>connect_timeout</span>] <span class='op'>=</span> (<span class='id identifier rubyid_timeout_ms'>timeout_ms</span> <span class='op'>/</span> <span class='float'>1_000.0</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_mongo_socket'>mongo_socket</span> <span class='op'>=</span> <span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_socket'>socket</span>(
    <span class='const'><a href="#SOCKET_TIMEOUT-constant" title="Mongo::Crypt::EncryptionIO::SOCKET_TIMEOUT (constant)">SOCKET_TIMEOUT</a></span><span class='comma'>,</span>
    <span class='id identifier rubyid_tls_options'>tls_options</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_socket_options'>socket_options</span>)
  )
  <span class='kw'>yield</span>(<span class='id identifier rubyid_mongo_socket'>mongo_socket</span>.<span class='id identifier rubyid_socket'>socket</span>)
<span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/KmsError.html" title="Mongo::Error::KmsError (class)">KmsError</a></span>
  <span class='id identifier rubyid_raise'>raise</span>
<span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/KmsError.html" title="Mongo::Error::KmsError (class)">KmsError</a></span>.<span class='id identifier rubyid_new'><a href="../Error/KmsError.html#new-class_method" title="Mongo::Error::KmsError.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Error when connecting to KMS provider: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>network_error:</span> <span class='kw'>true</span>)
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_mongo_socket'>mongo_socket</span><span class='op'>&amp;.</span><span class='id identifier rubyid_close'>close</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>