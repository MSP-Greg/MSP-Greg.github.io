<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: Mongo::BackgroundThread &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::BackgroundThread",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Mongo master</a> &raquo; 
      <a href='../_index.html#alpha_B'>Index (B)</a> &raquo; 
        <a href="../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>BackgroundThread&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: Mongo::BackgroundThread  <span class='private note title'>Private</span>
</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This module is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Included In:</div>
      <div class='box_11'>
        <a href="Cluster/PeriodicExecutor.html" title="Mongo::Cluster::PeriodicExecutor (class)"><code>Cluster::PeriodicExecutor</code></a>,
          <a href="Server/ConnectionPool/Populator.html" title="Mongo::Server::ConnectionPool::Populator (class)"><code>Server::ConnectionPool::Populator</code></a>,
          <a href="Server/Monitor.html" title="Mongo::Server::Monitor (class)"><code>Server::Monitor</code></a>,
          <a href="Server/PushMonitor.html" title="Mongo::Server::PushMonitor (class)"><code>Server::PushMonitor</code></a>,
          <a href="Srv/Monitor.html" title="Mongo::Srv::Monitor (class)"><code>Srv::Monitor</code></a>
      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="Loggable.html" title="Mongo::Loggable (module)"><code>Loggable</code></a>
        </div>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/background_thread.rb#L38'>lib/mongo/background_thread.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Do not start or stop background threads in finalizers. See <a href="https://jira.mongodb.org/browse/RUBY-2453">jira.mongodb.org/browse/RUBY-2453</a> and <a href="https://bugs.ruby-lang.org/issues/16288">bugs.ruby-lang.org/issues/16288</a>. When interpreter exits, background threads are stopped first and finalizers are invoked next, and MRI’s internal data structures are basically corrupt at this point if threads are being referenced. Prior to interpreter shutdown this means threads cannot be stopped by objects going out of scope, but most likely the threads hold references to said objects anyway if work is being performed thus the objects wouldn’t go out of scope in the first place.</p>
</div>
  </div>


<p>The run!, running? and stop! methods used to be part of the public API in some of the classes which now include this module. Therefore these methods must be considered part of the driver’s public API for backwards compatibility reasons. However using these methods outside of the driver is deprecated.</p>

  </div>
</div>
<div class='tags'>
  
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
  <h3 class='inherited'><a href="Loggable.html" title="Mongo::Loggable (module)"><code>Loggable</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="Loggable.html#PREFIX-constant" title="Mongo::Loggable::PREFIX (constant)">PREFIX</a>
  </p>
</div>

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#running%3F-instance_method" title="#running? (instance method)">#<strong>running?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#run!-instance_method" title="#run! (instance method)">#<strong>run!</strong>  </a>
      (also: #restart!)
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Start the background thread.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#stop!-instance_method" title="#stop! (instance method)">#<strong>stop!</strong>  &#x21d2; true | false </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Stop the background thread and wait for to terminate for a reasonable amount of time.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#do_work-instance_method" title="#do_work (instance method)">#<strong>do_work</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Override this method to do the work in the background thread.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#pre_stop-instance_method" title="#pre_stop (instance method)">#<strong>pre_stop</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Override this method to perform additional signaling for the background thread to stop.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#start!-instance_method" title="#start! (instance method)">#<strong>start!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#wait_for_stop-instance_method" title="#wait_for_stop (instance method)">#<strong>wait_for_stop</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Waits for the thread to die, with a timeout.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited'><a href="Loggable.html" title="Mongo::Loggable (module)"><code>Loggable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#log_debug-instance_method" title="Mongo::Loggable#log_debug (method)">#log_debug</a></td>
      <td><div class='inline'><p>Convenience method to log debug messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#log_error-instance_method" title="Mongo::Loggable#log_error (method)">#log_error</a></td>
      <td><div class='inline'><p>Convenience method to log error messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#log_fatal-instance_method" title="Mongo::Loggable#log_fatal (method)">#log_fatal</a></td>
      <td><div class='inline'><p>Convenience method to log fatal messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#log_info-instance_method" title="Mongo::Loggable#log_info (method)">#log_info</a></td>
      <td><div class='inline'><p>Convenience method to log info messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#log_warn-instance_method" title="Mongo::Loggable#log_warn (method)">#log_warn</a></td>
      <td><div class='inline'><p>Convenience method to log warn messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#logger-instance_method" title="Mongo::Loggable#logger (method)">#logger</a></td>
      <td><div class='inline'><p>Get the logger instance.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Loggable.html#_mongo_log_prefix-instance_method" title="Mongo::Loggable#_mongo_log_prefix (method)">#_mongo_log_prefix</a>,
        <a class='i_m priv' href="Loggable.html#format_message-instance_method" title="Mongo::Loggable#format_message (method)">#format_message</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="running?-instance_method">
  <h3 class='signature ro  nodoc first'>
    #<strong>running?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/background_thread.rb#L63-L69'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='69'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/background_thread.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_running?'>running?</span>
  <span class='kw'>if</span> <span class='ivar'>@thread</span>
    <span class='ivar'>@thread</span>.<span class='id identifier rubyid_alive?'>alive?</span>
  <span class='kw'>else</span>
    <span class='kw'>false</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="do_work-instance_method">
  <h3 class='signature priv  nodoc first'>
    #<strong>do_work</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Override this method to do the work in the background thread.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/background_thread.rb#L165-L166'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='165' data-end='166'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/background_thread.rb', line 165</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_work'>do_work</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pre_stop-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>pre_stop</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Override this method to perform additional signaling for the background thread to stop.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/background_thread.rb#L170-L171'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='170' data-end='171'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/background_thread.rb', line 170</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_pre_stop'>pre_stop</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="run!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>run!</strong>  
    <span class='aliases'>Also known as: <span class='names'>#restart!</span></span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Start the background thread.</p>

<p>If the thread is already running, this method does nothing.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/background_thread.rb#L46-L60'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='46' data-end='60'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/background_thread.rb', line 46</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_run!'>run!</span>
  <span class='kw'>if</span> <span class='ivar'>@stop_requested</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@thread</span>
    <span class='id identifier rubyid_wait_for_stop'><a href="#wait_for_stop-instance_method" title="Mongo::BackgroundThread#wait_for_stop (method)">wait_for_stop</a></span>
    <span class='kw'>if</span> <span class='ivar'>@thread</span>.<span class='id identifier rubyid_alive?'>alive?</span>
      <span class='id identifier rubyid_log_warn'>log_warn</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Starting a new background thread in </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='embexpr_end'>}</span><span class='tstring_content'>, but the previous background thread is still running</span><span class='tstring_end'>&quot;</span></span>)
      <span class='ivar'>@thread</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>end</span>
    <span class='ivar'>@stop_requested</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_running?'><a href="#running%3F-instance_method" title="Mongo::BackgroundThread#running? (method)">running?</a></span>
    <span class='ivar'>@thread</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_start!'><a href="#start!-instance_method" title="Mongo::BackgroundThread#start! (method)">start!</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="start!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>start!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/background_thread.rb#L111-L119'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='111' data-end='119'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/background_thread.rb', line 111</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_start!'>start!</span>
  <span class='ivar'>@thread</span> <span class='op'>=</span> <span class='const'>Thread</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_catch'>catch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_done'>done</span>) <span class='kw'>do</span>
      <span class='kw'>until</span> <span class='ivar'>@stop_requested</span>
        <span class='id identifier rubyid_do_work'><a href="#do_work-instance_method" title="Mongo::BackgroundThread#do_work (method)">do_work</a></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="stop!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>stop!</strong>  &#x21d2; <code>true</code> | <code>false</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Stop the background thread and wait for to terminate for a reasonable amount of time.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the thread was terminated.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/background_thread.rb#L77-L107'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='77' data-end='107'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/background_thread.rb', line 77</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_stop!'>stop!</span>
  <span class='comment'># If the thread was not started, there is nothing to stop.
</span>  <span class='comment'>#
</span>  <span class='comment'># Classes including this module may want to perform additional
</span>  <span class='comment'># cleanup, which they can do by overriding this method.
</span>  <span class='kw'>return</span> <span class='kw'>true</span> <span class='kw'>unless</span> <span class='ivar'>@thread</span>

  <span class='comment'># Background threads generally perform operations in a loop.
</span>  <span class='comment'># This flag is meant to be checked on each iteration of the
</span>  <span class='comment'># working loops and the thread should stop working when this flag
</span>  <span class='comment'># is set.
</span>  <span class='ivar'>@stop_requested</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='comment'># Besides setting the flag, a particular class may have additional
</span>  <span class='comment'># ways of signaling the background thread to either stop working or
</span>  <span class='comment'># wake up to check the stop flag, for example, setting a semaphore.
</span>  <span class='comment'># This can be accomplished by providing the pre_stop method.
</span>  <span class='id identifier rubyid_pre_stop'><a href="#pre_stop-instance_method" title="Mongo::BackgroundThread#pre_stop (method)">pre_stop</a></span>

  <span class='comment'># Now we have requested the graceful termination, and we could wait
</span>  <span class='comment'># for the thread to exit on its own accord. A future version of the
</span>  <span class='comment'># driver may allow a certain amount of time for the thread to quit.
</span>  <span class='comment'># For now, we additionally use the Ruby machinery to request the thread
</span>  <span class='comment'># be terminated, and do so immediately.
</span>  <span class='comment'>#
</span>  <span class='comment'># Note that this may cause the background thread to terminate in
</span>  <span class='comment'># the middle of an operation.
</span>  <span class='ivar'>@thread</span>.<span class='id identifier rubyid_kill'>kill</span>

  <span class='id identifier rubyid_wait_for_stop'><a href="#wait_for_stop-instance_method" title="Mongo::BackgroundThread#wait_for_stop (method)">wait_for_stop</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="wait_for_stop-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>wait_for_stop</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Waits for the thread to die, with a timeout.</p>

<p>Returns true if the thread died, false otherwise.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/background_thread.rb#L124-L162'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='124' data-end='162'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/background_thread.rb', line 124</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_for_stop'>wait_for_stop</span>
  <span class='comment'># Wait for the thread to die. This is important in order to reliably
</span>  <span class='comment'># clean up resources like connections knowing that no background
</span>  <span class='comment'># thread will reconnect because it is still working.
</span>  <span class='comment'>#
</span>  <span class='comment'># However, we do not want to wait indefinitely because in theory
</span>  <span class='comment'># a background thread could be performing, say, network I/O and if
</span>  <span class='comment'># the network is no longer available that could take a long time.
</span>  <span class='id identifier rubyid_start_time'>start_time</span> <span class='op'>=</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
  ([<span class='float'>0.1</span><span class='comma'>,</span> <span class='float'>0.15</span>] <span class='op'>+</span> [<span class='float'>0.2</span>] <span class='op'>*</span> <span class='int'>5</span> <span class='op'>+</span> [<span class='float'>0.3</span>] <span class='op'>*</span> <span class='int'>20</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_interval'>interval</span><span class='op'>|</span>
    <span class='kw'>begin</span>
      <span class='const'><a href="Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span>.<span class='id identifier rubyid_timeout'><a href="Timeout.html#timeout-class_method" title="Mongo::Timeout.timeout (method)">timeout</a></span>(<span class='id identifier rubyid_interval'>interval</span>) <span class='kw'>do</span>
        <span class='ivar'>@thread</span>.<span class='id identifier rubyid_join'>join</span>
      <span class='kw'>end</span>
      <span class='kw'>break</span>
    <span class='kw'>rescue</span> <span class='op'>::</span><span class='const'><a href="Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Some driver objects can be reconnected, for backwards compatibiilty
</span>  <span class='comment'># reasons. Clear the thread instance variable to support this cleanly.
</span>  <span class='kw'>if</span> <span class='ivar'>@thread</span>.<span class='id identifier rubyid_alive?'>alive?</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to stop the background thread in </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='embexpr_end'>}</span><span class='tstring_content'> in </span><span class='embexpr_beg'>#{</span>(<span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>-</span> <span class='id identifier rubyid_start_time'>start_time</span>).<span class='id identifier rubyid_to_i'>to_i</span><span class='embexpr_end'>}</span><span class='tstring_content'> seconds: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@thread</span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> (thread status: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@thread</span>.<span class='id identifier rubyid_status'>status</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>)
    <span class='comment'># On JRuby the thread may be stuck in aborting state
</span>    <span class='comment'># seemingly indefinitely. If the thread is aborting, consider it dead
</span>    <span class='comment'># for our purposes (we will create a new thread if needed, and
</span>    <span class='comment'># the background thread monitor will not detect the aborting thread
</span>    <span class='comment'># as being alive).
</span>    <span class='kw'>if</span> <span class='ivar'>@thread</span>.<span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>aborting</span><span class='tstring_end'>&#39;</span></span>
      <span class='ivar'>@thread</span> <span class='op'>=</span> <span class='kw'>nil</span>
      <span class='ivar'>@stop_requested</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
    <span class='kw'>false</span>
  <span class='kw'>else</span>
    <span class='ivar'>@thread</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@stop_requested</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>