<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Socket &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Socket",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Mongo master</a> &raquo; 
      <a href='../_index.html#alpha_S'>Index (S)</a> &raquo; 
        <a href="../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>Socket&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Socket  <span class='private note title'>Private</span>
</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This class is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Modules:</div>
      <div class='box_11'>
          <a href="Socket/OcspCache.html" title="Mongo::Socket::OcspCache (module)"><code>OcspCache</code></a>      </div>
    </td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a href="Socket/OcspVerifier.html" title="Mongo::Socket::OcspVerifier (class)"><code>OcspVerifier</code></a>,
        <a href="Socket/SSL.html" title="Mongo::Socket::SSL (class)"><code>SSL</code></a>,
        <a href="Socket/TCP.html" title="Mongo::Socket::TCP (class)"><code>TCP</code></a>,
        <a href="Socket/Unix.html" title="Mongo::Socket::Unix (class)"><code>Unix</code></a>      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Subclasses:</div>
        <div class='box_22'>
          <a href="Socket/SSL.html" title="Mongo::Socket::SSL (class)">SSL</a>, <a href="Socket/TCP.html" title="Mongo::Socket::TCP (class)">TCP</a>, <a href="Socket/Unix.html" title="Mongo::Socket::Unix (class)">Unix</a>
        </div>
      </td>
    </tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          Socket::Constants
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2 o'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L30'>lib/mongo/socket.rb</a><span class='defines'>,<br /><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket/ocsp_cache.rb#L19'>lib/mongo/socket/ocsp_cache.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket/ocsp_verifier.rb#L23'>lib/mongo/socket/ocsp_verifier.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket/ssl.rb#L19'>lib/mongo/socket/ssl.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket/tcp.rb#L19'>lib/mongo/socket/tcp.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket/unix.rb#L19'>lib/mongo/socket/unix.rb</a></span>
      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Provides additional data around sockets for the driver’s use.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full nodoc'>
  <li>
    <span id='DEFAULT_TCP_KEEPCNT-constant' class='summary_signature nodoc'>DEFAULT_TCP_KEEPCNT =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L574-L574'># File 'lib/mongo/socket.rb', line 574</a>    <pre class='code ruby'><span class='int'>9</span></pre>
  </li>
  <li>
    <span id='DEFAULT_TCP_KEEPIDLE-constant' class='summary_signature nodoc'>DEFAULT_TCP_KEEPIDLE =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L576-L576'># File 'lib/mongo/socket.rb', line 576</a>    <pre class='code ruby'><span class='int'>120</span></pre>
  </li>
  <li>
    <span id='DEFAULT_TCP_KEEPINTVL-constant' class='summary_signature nodoc'>DEFAULT_TCP_KEEPINTVL =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L572-L572'># File 'lib/mongo/socket.rb', line 572</a>    <pre class='code ruby'><span class='int'>10</span></pre>
  </li>
  <li>
    <span id='DEFAULT_TCP_USER_TIMEOUT-constant' class='summary_signature nodoc'>DEFAULT_TCP_USER_TIMEOUT =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L578-L578'># File 'lib/mongo/socket.rb', line 578</a>    <pre class='code ruby'><span class='int'>210</span></pre>
  </li>
  <li>
    <span id='SSL_ERROR-constant' class='summary_signature deprecated nodoc'>SSL_ERROR =</span>
    <div class='docstring'>
  <div class='discussion'>
    <div class="note deprecated"><strong>Deprecated.</strong> <div class='inline'></div></div>

<p><a href="Error.html" title="Mongo::Error (class)"><code>Error</code></a> message for TLS related exceptions.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L37-L37'># File 'lib/mongo/socket.rb', line 37</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>MongoDB may not be configured with TLS support</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
  <li>
    <span id='TIMEOUT_ERROR-constant' class='summary_signature deprecated nodoc'>TIMEOUT_ERROR =</span>
    <div class='docstring'>
  <div class='discussion'>
    <div class="note deprecated"><strong>Deprecated.</strong> <div class='inline'></div></div>

<p><a href="Error.html" title="Mongo::Error (class)"><code>Error</code></a> message for timeouts on socket calls.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L43-L43'># File 'lib/mongo/socket.rb', line 43</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Socket request timed out</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
  <li>
    <span id='TIMEOUT_PACK-constant' class='summary_signature nodoc'>TIMEOUT_PACK =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The pack directive for timeouts.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L48-L48'># File 'lib/mongo/socket.rb', line 48</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>l_2</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
  <li>
    <span id='WRITE_CHUNK_SIZE-constant' class='summary_signature nodoc'>WRITE_CHUNK_SIZE =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>Write data to the socket in chunks of this size.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L53-L53'># File 'lib/mongo/socket.rb', line 53</a>    <pre class='code ruby'><span class='int'>65536</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(timeout, options)  &#x21d2; Socket </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Initializes common socket attributes.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li class='deprecated'>
    <span class='summary_signature ro nodoc deprecated'>
      <a href="#alive%3F-instance_method" title="#alive? (instance method)">#<strong>alive?</strong>  &#x21d2; true, false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='deprecated note title'>deprecated</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='summary_desc'><strong>Deprecated.</strong>
      <div class='inline'>
<p>Use #connectable? on the connection instead.</p>
</div>    </span>
  </li>
  <li class='deprecated'>
    <span class='summary_signature ro nodoc deprecated'>
      <a href="#connectable%3F-instance_method" title="#connectable? (instance method)">#<strong>connectable?</strong>  &#x21d2; true </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='deprecated note title'>deprecated</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='summary_desc'><strong>Deprecated.</strong>
      <div class='inline'></div>    </span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#eof%3F-instance_method" title="#eof? (instance method)">#<strong>eof?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Tests if this socket has reached EOF.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#family-instance_method" title="#family (instance method)">#<strong>family</strong>  &#x21d2; Integer </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#monitor%3F-instance_method" title="#monitor? (instance method)">#<strong>monitor?</strong>  &#x21d2; true | false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#options-instance_method" title="#options (instance method)">#<strong>options</strong>  &#x21d2; Hash </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#socket-instance_method" title="#socket (instance method)">#<strong>socket</strong>  &#x21d2; Socket </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#timeout-instance_method" title="#timeout (instance method)">#<strong>timeout</strong>  &#x21d2; Float </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#close-instance_method" title="#close (instance method)">#<strong>close</strong>  &#x21d2; true </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Close the socket.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#connection_address-instance_method" title="#connection_address (instance method)">#<strong>connection_address</strong>  &#x21d2; Address </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#connection_generation-instance_method" title="#connection_generation (instance method)">#<strong>connection_generation</strong>  &#x21d2; Integer </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#gets-instance_method" title="#gets (instance method)">#<strong>gets</strong>(*args)  &#x21d2; Object </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Delegates gets to the underlying socket.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#pipe-instance_method" title="#pipe (instance method)">#<strong>pipe</strong>  &#x21d2; IO </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>listen on during the select system call when reading from the socket.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#read-instance_method" title="#read (instance method)">#<strong>read</strong>(length, socket_timeout: nil, timeout: nil)  &#x21d2; Object </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Will read all data from the socket for the provided number of bytes.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#readbyte-instance_method" title="#readbyte (instance method)">#<strong>readbyte</strong>  &#x21d2; Object </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Read a single byte from the socket.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#summary-instance_method" title="#summary (instance method)">#<strong>summary</strong>  &#x21d2; String </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#write-instance_method" title="#write (instance method)">#<strong>write</strong>(*args, timeout: nil)  &#x21d2; Integer </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Writes data to the socket instance.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#allocate_string-instance_method" title="#allocate_string (instance method)">#<strong>allocate_string</strong>(capacity)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#do_write-instance_method" title="#do_write (instance method)">#<strong>do_write</strong>(*args, timeout: nil)  &#x21d2; Integer </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Writes data to the socket instance.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#human_address-instance_method" title="#human_address (instance method)">#<strong>human_address</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#map_exceptions-instance_method" title="#map_exceptions (instance method)">#<strong>map_exceptions</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#raise_timeout_error!-instance_method" title="#raise_timeout_error! (instance method)">#<strong>raise_timeout_error!</strong>(message = nil, csot = false)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#read_buffer_size-instance_method" title="#read_buffer_size (instance method)">#<strong>read_buffer_size</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#read_from_socket-instance_method" title="#read_from_socket (instance method)">#<strong>read_from_socket</strong>(length, socket_timeout: nil, csot: false)  &#x21d2; Object </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Reads the <code>length</code> bytes from the socket.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#read_with_timeout-instance_method" title="#read_with_timeout (instance method)">#<strong>read_with_timeout</strong>(length, timeout)  &#x21d2; Object </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Reads the <code>length</code> bytes from the socket, the read operation duration is limited to <a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">#timeout</a> second.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#read_without_timeout-instance_method" title="#read_without_timeout (instance method)">#<strong>read_without_timeout</strong>(length, socket_timeout = nil)  &#x21d2; Object </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Reads the <code>length</code> bytes from the socket.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#set_keepalive_opts-instance_method" title="#set_keepalive_opts (instance method)">#<strong>set_keepalive_opts</strong>(sock)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#set_option-instance_method" title="#set_option (instance method)">#<strong>set_option</strong>(sock, option, default)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#set_socket_options-instance_method" title="#set_socket_options (instance method)">#<strong>set_socket_options</strong>(sock)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#unix_socket%3F-instance_method" title="#unix_socket? (instance method)">#<strong>unix_socket?</strong>(sock)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#wait_for_socket_to_be_writable-instance_method" title="#wait_for_socket_to_be_writable (instance method)">#<strong>wait_for_socket_to_be_writable</strong>(deadline)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#write_chunk-instance_method" title="#write_chunk (instance method)">#<strong>write_chunk</strong>(chunk, timeout)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#write_with_timeout-instance_method" title="#write_with_timeout (instance method)">#<strong>write_with_timeout</strong>(*args, timeout:)  &#x21d2; Integer </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Writes data to to the socket, the write duration is limited to <a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">#timeout</a>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#write_without_timeout-instance_method" title="#write_without_timeout (instance method)">#<strong>write_without_timeout</strong>(*args)  &#x21d2; Integer </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Writes data to to the socket.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="alive?-instance_method">
  <h3 class='signature ro  nodoc deprecated first'>
    #<strong>alive?</strong>  &#x21d2; <code>true</code>, <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <div class="note deprecated"><strong>Deprecated.</strong> <div class='inline'>
<p>Use #connectable? on the connection instead.</p>
</div></div>

<p>Is the socket connection alive?</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Is the socket alive?</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_socket'><a href="#socket-instance_method" title="Mongo::Socket#socket (method)">socket</a></span>.<span class='id identifier rubyid_alive?'>alive?</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>, <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>If the socket is alive.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L144-L160'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='144' data-end='160'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 144</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_alive?'>alive?</span>
  <span class='id identifier rubyid_sock_arr'>sock_arr</span> <span class='op'>=</span> [ <span class='ivar'>@socket</span> ]
  <span class='kw'>if</span> <span class='const'>Kernel</span><span class='op'>::</span><span class='id identifier rubyid_select'>select</span>(<span class='id identifier rubyid_sock_arr'>sock_arr</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_sock_arr'>sock_arr</span><span class='comma'>,</span> <span class='int'>0</span>)
    <span class='comment'># The eof? call is supposed to return immediately since select
</span>    <span class='comment'># indicated the socket is readable. However, if @socket is a TLS
</span>    <span class='comment'># socket, eof? can block anyway - see RUBY-2140.
</span>    <span class='kw'>begin</span>
      <span class='const'><a href="Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span>.<span class='id identifier rubyid_timeout'><a href="Timeout.html#timeout-class_method" title="Mongo::Timeout.timeout (method)">timeout</a></span>(<span class='float'>0.1</span>) <span class='kw'>do</span>
        <span class='id identifier rubyid_eof?'><a href="#eof%3F-instance_method" title="Mongo::Socket#eof? (method)">eof?</a></span>
      <span class='kw'>end</span>
    <span class='kw'>rescue</span> <span class='op'>::</span><span class='const'><a href="Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span>
      <span class='kw'>true</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connectable?-instance_method">
  <h3 class='signature ro  nodoc deprecated'>
    #<strong>connectable?</strong>  &#x21d2; <code>true</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <div class="note deprecated"><strong>Deprecated.</strong> <div class='inline'></div></div>

<p>For backwards compatibility only, do not use.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>)</span>
&mdash;    <div class='inline'>
<p>Always true.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L270-L272'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='270' data-end='272'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 270</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connectable?'>connectable?</span>
  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="eof?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>eof?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Tests if this socket has reached EOF. Primarily used for liveness checks.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.5</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L259-L263'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='259' data-end='263'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 259</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_eof?'>eof?</span>
  <span class='ivar'>@socket</span>.<span class='id identifier rubyid_eof?'>eof?</span>
<span class='kw'>rescue</span> <span class='const'>IOError</span><span class='comma'>,</span> <span class='const'>SystemCallError</span>
  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="family-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>family</strong>  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>family The type of host family.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L78-L78'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='78' data-end='78'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 78</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_family'>family</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="monitor?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>monitor?</strong>  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether this socket was created by a monitoring connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L108-L110'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='108' data-end='110'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 108</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_monitor?'>monitor?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Socket#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_monitor'>monitor</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="options-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>options</strong>  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>The options.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L84-L84'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='84' data-end='84'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 84</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_options'>options</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="socket-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>socket</strong>  &#x21d2; <code>Socket</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Socket</code>)</span>
&mdash;    <div class='inline'>
<p>socket The wrapped socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L81-L81'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='81' data-end='81'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 81</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_socket'>socket</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="timeout-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>timeout</strong>  &#x21d2; <code>Float</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Float</code>)</span>
&mdash;    <div class='inline'>
<p>timeout The socket timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L87-L87'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='87' data-end='87'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 87</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_timeout'>timeout</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="allocate_string-instance_method">
  <h3 class='signature priv  nodoc first'>
    #<strong>allocate_string</strong>(capacity)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L453-L455'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='453' data-end='455'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 453</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_allocate_string'>allocate_string</span>(<span class='id identifier rubyid_capacity'>capacity</span>)
  <span class='const'>String</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Socket.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_capacity'>capacity</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_capacity'>capacity</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_encoding'>encoding</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BINARY</span><span class='tstring_end'>&#39;</span></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="close-instance_method">
  <h3 class='signature nodoc'>
    #<strong>close</strong>  &#x21d2; <code>true</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Close the socket.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Close the socket.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_socket'><a href="#socket-instance_method" title="Mongo::Socket#socket (method)">socket</a></span>.<span class='id identifier rubyid_close'>close</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>)</span>
&mdash;    <div class='inline'>
<p>Always true.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L170-L180'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='170' data-end='180'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 170</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_close'>close</span>
  <span class='kw'>begin</span>
    <span class='comment'># Sometimes it seems the close call can hang for a long time
</span>    <span class='op'>::</span><span class='const'><a href="Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span>.<span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>(<span class='int'>5</span>) <span class='kw'>do</span>
      <span class='ivar'>@socket</span><span class='op'>&amp;.</span><span class='id identifier rubyid_close'>close</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span>
    <span class='comment'># Silence all errors
</span>  <span class='kw'>end</span>
  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connection_address-instance_method">
  <h3 class='signature nodoc'>
    #<strong>connection_address</strong>  &#x21d2; <a href="Address.html" title="Mongo::Address (class)">Address</a> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Address.html" title="Mongo::Address (class)">Address</a>)</span>
&mdash;    <div class='inline'>
<p><a href="Address.html" title="Mongo::Address (class)"><code>Address</code></a> of the connection that created this socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L92-L94'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='92' data-end='94'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 92</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connection_address'>connection_address</span>
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Socket#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_connection_address'>connection_address</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connection_generation-instance_method">
  <h3 class='signature nodoc'>
    #<strong>connection_generation</strong>  &#x21d2; <code>Integer</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>Generation of the connection (for non-monitoring connections) that created this socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L100-L102'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='100' data-end='102'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 100</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connection_generation'>connection_generation</span>
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Socket#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_connection_generation'>connection_generation</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="do_write-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>do_write</strong>(*args, timeout: nil)  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Writes data to the socket instance.</p>

<p>This is a separate method from <a href="#write-instance_method" title="Mongo::Socket#write (method)">#write</a> for ease of mocking in the tests. This method should not perform any exception mapping, upstream code sholud map exceptions.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>args</span>
    <span class='type'>(<code>Array</code>&lt;<code>Object</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The data to be written.</p>
</div>
  </li>
  <li>
    <span class='name'>:timeout</span>
    <span class='type'>(<code>Numeric</code>)</span>
&mdash;    <div class='inline'>
<p>The total timeout to the whole write operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The length of bytes written to the socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L473-L479'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='473' data-end='479'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 473</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_write'>do_write</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='kw'>nil</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_write_without_timeout'><a href="#write_without_timeout-instance_method" title="Mongo::Socket#write_without_timeout (method)">write_without_timeout</a></span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_write_with_timeout'><a href="#write_with_timeout-instance_method" title="Mongo::Socket#write_with_timeout (method)">write_with_timeout</a></span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="gets-instance_method">
  <h3 class='signature nodoc'>
    #<strong>gets</strong>(*args)  &#x21d2; <code>Object</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Delegates gets to the underlying socket.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Get the next line.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_socket'><a href="#socket-instance_method" title="Mongo::Socket#socket (method)">socket</a></span>.<span class='id identifier rubyid_gets'>gets</span>(<span class='int'>10</span>)</code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>args</span>
    <span class='type'>(<code>Array</code>&lt;<code>Object</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The arguments to pass through.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The returned bytes.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L192-L196'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='192' data-end='196'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 192</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_gets'>gets</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='id identifier rubyid_map_exceptions'><a href="#map_exceptions-instance_method" title="Mongo::Socket#map_exceptions (method)">map_exceptions</a></span> <span class='kw'>do</span>
    <span class='ivar'>@socket</span>.<span class='id identifier rubyid_gets'>gets</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="human_address-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>human_address</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<code>NotImplementedError</code>)</span>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L619-L621'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='619' data-end='621'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 619</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_human_address'>human_address</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="map_exceptions-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>map_exceptions</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L607-L617'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='607' data-end='617'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 607</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_map_exceptions'>map_exceptions</span>
  <span class='kw'>begin</span>
    <span class='kw'>yield</span>
  <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ETIMEDOUT</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'> (for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_human_address'><a href="#human_address-instance_method" title="Mongo::Socket#human_address (method)">human_address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>rescue</span> <span class='const'>IOError</span><span class='comma'>,</span> <span class='const'>SystemCallError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'> (for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_human_address'><a href="#human_address-instance_method" title="Mongo::Socket#human_address (method)">human_address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>rescue</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'><a href="Socket/SSL.html" title="Mongo::Socket::SSL (class)">SSL</a></span><span class='op'>::</span><span class='const'>SSLError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'> (for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_human_address'><a href="#human_address-instance_method" title="Mongo::Socket#human_address (method)">human_address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pipe-instance_method">
  <h3 class='signature nodoc'>
    #<strong>pipe</strong>  &#x21d2; <code>IO</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>listen on during the select system call when reading from the socket.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>IO</code>)</span>
&mdash;    <div class='inline'>
<p>The file descriptor for the read end of the pipe to</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L115-L117'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='115' data-end='117'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 115</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_pipe'>pipe</span>
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Socket#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_pipe'>pipe</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="raise_timeout_error!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>raise_timeout_error!</strong>(message = nil, csot = false)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L623-L629'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='623' data-end='629'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 623</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_raise_timeout_error!'>raise_timeout_error!</span>(<span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_csot'>csot</span> <span class='op'>=</span> <span class='kw'>false</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_csot'>csot</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/TimeoutError.html" title="Mongo::Error::TimeoutError (class)">TimeoutError</a></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ETIMEDOUT</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read-instance_method">
  <h3 class='signature nodoc'>
    #<strong>read</strong>(length, socket_timeout: nil, timeout: nil)  &#x21d2; <code>Object</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Will read all data from the socket for the provided number of bytes. If no data is returned, an exception will be raised.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Read all the requested data from the socket.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_socket'><a href="#socket-instance_method" title="Mongo::Socket#socket (method)">socket</a></span>.<span class='id identifier rubyid_read'>read</span>(<span class='int'>4096</span>)</code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>length</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The number of bytes to read.</p>
</div>
  </li>
  <li>
    <span class='name'>socket_timeout</span>
    <span class='type'>(<code>Numeric</code>)</span>
&mdash;    <div class='inline'>
<p>The timeout to use for each chunk read, mutually exclusive to <a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">#timeout</a>.</p>
</div>
  </li>
  <li>
    <span class='name'>timeout</span>
    <span class='type'>(<code>Numeric</code>)</span>
&mdash;    <div class='inline'>
<p>The total timeout to the whole read operation, mutually exclusive to <code>socket_timeout</code>.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The data from the socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error.html" title="Mongo::Error (class)">Mongo::SocketError</a>)</span>
&mdash;    <div class='inline'>
<p>If not all data is returned.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L215-L224'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='215' data-end='224'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 215</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read'>read</span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='label'>socket_timeout:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='kw'>nil</span>)
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_socket_timeout'>socket_timeout</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Both timeout and socket_timeout cannot be set</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_socket_timeout'>socket_timeout</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_read_without_timeout'><a href="#read_without_timeout-instance_method" title="Mongo::Socket#read_without_timeout (method)">read_without_timeout</a></span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='id identifier rubyid_socket_timeout'>socket_timeout</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_read_with_timeout'><a href="#read_with_timeout-instance_method" title="Mongo::Socket#read_with_timeout (method)">read_with_timeout</a></span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_buffer_size-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>read_buffer_size</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L457-L461'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='457' data-end='461'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 457</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_buffer_size'>read_buffer_size</span>
  <span class='comment'># Buffer size for non-TLS reads
</span>  <span class='comment'># 64kb
</span>  <span class='int'>65536</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_from_socket-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>read_from_socket</strong>(length, socket_timeout: nil, csot: false)  &#x21d2; <code>Object</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Reads the <code>length</code> bytes from the socket. The read operation may involve multiple socket reads, each read is limited to <a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">#timeout</a> second, if the parameter is provided.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>length</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The number of bytes to read.</p>
</div>
  </li>
  <li>
    <span class='name'>:socket_timeout</span>
    <span class='type'>(<code>Numeric</code>)</span>
&mdash;    <div class='inline'>
<p>The timeout to use for each chunk read.</p>
</div>
  </li>
  <li>
    <span class='name'>:csot</span>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the CSOT timeout is set for the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The data from the socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L334-L451'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='334' data-end='451'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 334</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_from_socket'>read_from_socket</span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='label'>socket_timeout:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>csot:</span> <span class='kw'>false</span>)
  <span class='comment'># Just in case
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_force_encoding'>force_encoding</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BINARY</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid__timeout'>_timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_socket_timeout'>socket_timeout</span> <span class='op'>||</span> <span class='kw'>self</span>.<span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>
  <span class='kw'>if</span> <span class='id identifier rubyid__timeout'>_timeout</span>
    <span class='kw'>if</span> <span class='id identifier rubyid__timeout'>_timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>=</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>+</span> <span class='id identifier rubyid__timeout'>_timeout</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid__timeout'>_timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_raise_timeout_error!'><a href="#raise_timeout_error!-instance_method" title="Mongo::Socket#raise_timeout_error! (method)">raise_timeout_error!</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Negative timeout </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid__timeout'>_timeout</span><span class='embexpr_end'>}</span><span class='tstring_content'> given to socket</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_csot'>csot</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># We want to have a fixed and reasonably small size buffer for reads
</span>  <span class='comment'># because, for example, OpenSSL reads in 16 kb chunks max.
</span>  <span class='comment'># Having a 16 mb buffer means there will be 1000 reads each allocating
</span>  <span class='comment'># 16 mb of memory and using 16 kb of it.
</span>  <span class='id identifier rubyid_buf_size'>buf_size</span> <span class='op'>=</span> <span class='id identifier rubyid_read_buffer_size'><a href="#read_buffer_size-instance_method" title="Mongo::Socket#read_buffer_size (method)">read_buffer_size</a></span>
  <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='comment'># If we want to read less than the buffer size, just allocate the
</span>  <span class='comment'># memory that is necessary
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_buf_size'>buf_size</span>
    <span class='id identifier rubyid_buf_size'>buf_size</span> <span class='op'>=</span> <span class='id identifier rubyid_length'>length</span>
  <span class='kw'>end</span>

  <span class='comment'># The binary encoding is important, otherwise Ruby performs encoding
</span>  <span class='comment'># conversions of some sort during the write into the buffer which
</span>  <span class='comment'># kills performance
</span>  <span class='id identifier rubyid_buf'>buf</span> <span class='op'>=</span> <span class='id identifier rubyid_allocate_string'><a href="#allocate_string-instance_method" title="Mongo::Socket#allocate_string (method)">allocate_string</a></span>(<span class='id identifier rubyid_buf_size'>buf_size</span>)
  <span class='id identifier rubyid_retrieved'>retrieved</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='kw'>begin</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_retrieved'>retrieved</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_length'>length</span>
      <span class='id identifier rubyid_retrieve'>retrieve</span> <span class='op'>=</span> <span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='id identifier rubyid_retrieved'>retrieved</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_retrieve'>retrieve</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_buf_size'>buf_size</span>
        <span class='id identifier rubyid_retrieve'>retrieve</span> <span class='op'>=</span> <span class='id identifier rubyid_buf_size'>buf_size</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='ivar'>@socket</span>.<span class='id identifier rubyid_read_nonblock'>read_nonblock</span>(<span class='id identifier rubyid_retrieve'>retrieve</span><span class='comma'>,</span> <span class='id identifier rubyid_buf'>buf</span>)

      <span class='comment'># If we read the entire wanted length in one operation,
</span>      <span class='comment'># return the data as is which saves one memory allocation and
</span>      <span class='comment'># one copy per read
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_retrieved'>retrieved</span> <span class='op'>==</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_chunk'>chunk</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='id identifier rubyid_length'>length</span>
        <span class='kw'>return</span> <span class='id identifier rubyid_chunk'>chunk</span>
      <span class='kw'>end</span>

      <span class='comment'># If we are here, we are reading the wanted length in
</span>      <span class='comment'># multiple operations. Allocate the total buffer here rather
</span>      <span class='comment'># than up front so that the special case above won&#39;t be
</span>      <span class='comment'># allocating twice
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_data'>data</span>.<span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_allocate_string'><a href="#allocate_string-instance_method" title="Mongo::Socket#allocate_string (method)">allocate_string</a></span>(<span class='id identifier rubyid_length'>length</span>)
      <span class='kw'>end</span>

      <span class='comment'># ... and we need to copy the chunks at this point
</span>      <span class='id identifier rubyid_data'>data</span>[<span class='id identifier rubyid_retrieved'>retrieved</span><span class='comma'>,</span> <span class='id identifier rubyid_chunk'>chunk</span>.<span class='id identifier rubyid_length'>length</span>] <span class='op'>=</span> <span class='id identifier rubyid_chunk'>chunk</span>
      <span class='id identifier rubyid_retrieved'>retrieved</span> <span class='op'>+=</span> <span class='id identifier rubyid_chunk'>chunk</span>.<span class='id identifier rubyid_length'>length</span>
    <span class='kw'>end</span>
  <span class='comment'># As explained in https://ruby-doc.com/core-trunk/IO.html#method-c-select,
</span>  <span class='comment'># reading from a TLS socket may require writing which may raise WaitWritable
</span>  <span class='kw'>rescue</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>WaitReadable</span><span class='comma'>,</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>WaitWritable</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_exc'>exc</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_deadline'>deadline</span>
      <span class='id identifier rubyid_select_timeout'>select_timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_select_timeout'>select_timeout</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
        <span class='id identifier rubyid_raise_timeout_error!'><a href="#raise_timeout_error!-instance_method" title="Mongo::Socket#raise_timeout_error! (method)">raise_timeout_error!</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Took more than </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid__timeout'>_timeout</span><span class='embexpr_end'>}</span><span class='tstring_content'> seconds to receive data</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_csot'>csot</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'>IO</span><span class='op'>::</span><span class='const'>WaitReadable</span>)
      <span class='kw'>if</span> <span class='id identifier rubyid_pipe'><a href="#pipe-instance_method" title="Mongo::Socket#pipe (method)">pipe</a></span>
        <span class='id identifier rubyid_select_args'>select_args</span> <span class='op'>=</span> [[<span class='ivar'>@socket</span><span class='comma'>,</span> <span class='id identifier rubyid_pipe'><a href="#pipe-instance_method" title="Mongo::Socket#pipe (method)">pipe</a></span>]<span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> [<span class='ivar'>@socket</span><span class='comma'>,</span> <span class='id identifier rubyid_pipe'><a href="#pipe-instance_method" title="Mongo::Socket#pipe (method)">pipe</a></span>]<span class='comma'>,</span> <span class='id identifier rubyid_select_timeout'>select_timeout</span>]
      <span class='kw'>else</span>
        <span class='id identifier rubyid_select_args'>select_args</span> <span class='op'>=</span> [[<span class='ivar'>@socket</span>]<span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> [<span class='ivar'>@socket</span>]<span class='comma'>,</span> <span class='id identifier rubyid_select_timeout'>select_timeout</span>]
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_select_args'>select_args</span> <span class='op'>=</span> [<span class='kw'>nil</span><span class='comma'>,</span> [<span class='ivar'>@socket</span>]<span class='comma'>,</span> [<span class='ivar'>@socket</span>]<span class='comma'>,</span> <span class='id identifier rubyid_select_timeout'>select_timeout</span>]
    <span class='kw'>end</span>

    <span class='id identifier rubyid_rv'>rv</span> <span class='op'>=</span> <span class='const'>Kernel</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>*</span><span class='id identifier rubyid_select_args'>select_args</span>)
    <span class='kw'>if</span> <span class='const'><a href="Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>
      <span class='kw'>if</span> <span class='id identifier rubyid_pipe'><a href="#pipe-instance_method" title="Mongo::Socket#pipe (method)">pipe</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_rv'>rv</span><span class='op'>&amp;.</span><span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_pipe'><a href="#pipe-instance_method" title="Mongo::Socket#pipe (method)">pipe</a></span>)
        <span class='comment'># If the return value of select is the read end of the pipe, and
</span>        <span class='comment'># an IOError is not raised, then that means the socket is still
</span>        <span class='comment'># open. Select is interrupted be closing the write end of the
</span>        <span class='comment'># pipe, which either returns the pipe if the socket is open, or
</span>        <span class='comment'># raises an IOError if it isn&#39;t. Select is interrupted after all
</span>        <span class='comment'># of the pending and checked out connections have been interrupted
</span>        <span class='comment'># and closed, and this only happens once the pool is cleared with
</span>        <span class='comment'># interrupt_in_use connections flag. This means that in order for
</span>        <span class='comment'># the socket to still be open when the select is interrupted, and
</span>        <span class='comment'># that socket is being read from, that means after clear was
</span>        <span class='comment'># called, a connection from the previous generation was checked
</span>        <span class='comment'># out of the pool, for reading on its socket. This should be impossible.
</span>        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'>LintError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Select interrupted for live socket. This should be impossible.</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Environment</span>.<span class='id identifier rubyid_jruby?'>jruby?</span>
      <span class='comment'># Ignore the return value of Kernel.select.
</span>      <span class='comment'># On JRuby, select appears to return nil prior to timeout expiration
</span>      <span class='comment'># (apparently due to a EAGAIN) which then causes us to fail the read
</span>      <span class='comment'># even though we could have retried it.
</span>      <span class='comment'># Check the deadline ourselves.
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_deadline'>deadline</span>
        <span class='id identifier rubyid_select_timeout'>select_timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_select_timeout'>select_timeout</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
          <span class='id identifier rubyid_raise_timeout_error!'><a href="#raise_timeout_error!-instance_method" title="Mongo::Socket#raise_timeout_error! (method)">raise_timeout_error!</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Took more than </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid__timeout'>_timeout</span><span class='embexpr_end'>}</span><span class='tstring_content'> seconds to receive data</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_csot'>csot</span>)
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_rv'>rv</span>.<span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_raise_timeout_error!'><a href="#raise_timeout_error!-instance_method" title="Mongo::Socket#raise_timeout_error! (method)">raise_timeout_error!</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Took more than </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid__timeout'>_timeout</span><span class='embexpr_end'>}</span><span class='tstring_content'> seconds to receive data (select call timed out)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_csot'>csot</span>)
    <span class='kw'>end</span>
    <span class='kw'>retry</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_data'>data</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_with_timeout-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>read_with_timeout</strong>(length, timeout)  &#x21d2; <code>Object</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Reads the <code>length</code> bytes from the socket, the read operation duration is limited to <a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">#timeout</a> second.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>length</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The number of bytes to read.</p>
</div>
  </li>
  <li>
    <span class='name'>timeout</span>
    <span class='type'>(<code>Numeric</code>)</span>
&mdash;    <div class='inline'>
<p>The total timeout to the whole read operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The data from the socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L283-L300'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='283' data-end='300'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 283</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_with_timeout'>read_with_timeout</span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>)
  <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>=</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>
  <span class='id identifier rubyid_map_exceptions'><a href="#map_exceptions-instance_method" title="Mongo::Socket#map_exceptions (method)">map_exceptions</a></span> <span class='kw'>do</span>
    <span class='const'>String</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Socket.new (method)">new</a></span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_data'>data</span><span class='op'>|</span>
      <span class='kw'>while</span> <span class='id identifier rubyid_data'>data</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_length'>length</span>
        <span class='id identifier rubyid_socket_timeout'>socket_timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_socket_timeout'>socket_timeout</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/TimeoutError.html" title="Mongo::Error::TimeoutError (class)">TimeoutError</a></span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_read_from_socket'><a href="#read_from_socket-instance_method" title="Mongo::Socket#read_from_socket (method)">read_from_socket</a></span>(<span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='id identifier rubyid_data'>data</span>.<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='label'>socket_timeout:</span> <span class='id identifier rubyid_socket_timeout'>socket_timeout</span><span class='comma'>,</span> <span class='label'>csot:</span> <span class='kw'>true</span>)
        <span class='kw'>unless</span> <span class='id identifier rubyid_chunk'>chunk</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='const'>IOError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Expected to read &gt; 0 bytes but read 0 bytes</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_data'>data</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_chunk'>chunk</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_without_timeout-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>read_without_timeout</strong>(length, socket_timeout = nil)  &#x21d2; <code>Object</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Reads the <code>length</code> bytes from the socket. The read operation may involve multiple socket reads, each read is limited to <a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">#timeout</a> second, if the parameter is provided.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>length</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The number of bytes to read.</p>
</div>
  </li>
  <li>
    <span class='name'>socket_timeout</span>
    <span class='type'>(<code>Numeric</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>The timeout to use for each chunk read.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The data from the socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L310-L322'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='310' data-end='322'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 310</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_without_timeout'>read_without_timeout</span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='id identifier rubyid_socket_timeout'>socket_timeout</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_map_exceptions'><a href="#map_exceptions-instance_method" title="Mongo::Socket#map_exceptions (method)">map_exceptions</a></span> <span class='kw'>do</span>
    <span class='const'>String</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Socket.new (method)">new</a></span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_data'>data</span><span class='op'>|</span>
      <span class='kw'>while</span> <span class='id identifier rubyid_data'>data</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_length'>length</span>
        <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_read_from_socket'><a href="#read_from_socket-instance_method" title="Mongo::Socket#read_from_socket (method)">read_from_socket</a></span>(<span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='id identifier rubyid_data'>data</span>.<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='label'>socket_timeout:</span> <span class='id identifier rubyid_socket_timeout'>socket_timeout</span>)
        <span class='kw'>unless</span> <span class='id identifier rubyid_chunk'>chunk</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='const'>IOError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Expected to read &gt; 0 bytes but read 0 bytes</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_data'>data</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_chunk'>chunk</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="readbyte-instance_method">
  <h3 class='signature nodoc'>
    #<strong>readbyte</strong>  &#x21d2; <code>Object</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Read a single byte from the socket.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Read a single byte.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_socket'><a href="#socket-instance_method" title="Mongo::Socket#socket (method)">socket</a></span>.<span class='id identifier rubyid_readbyte'>readbyte</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The read byte.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L234-L238'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='234' data-end='238'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 234</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_readbyte'>readbyte</span>
  <span class='id identifier rubyid_map_exceptions'><a href="#map_exceptions-instance_method" title="Mongo::Socket#map_exceptions (method)">map_exceptions</a></span> <span class='kw'>do</span>
    <span class='ivar'>@socket</span>.<span class='id identifier rubyid_readbyte'>readbyte</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="set_keepalive_opts-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>set_keepalive_opts</strong>(sock)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L580-L591'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='580' data-end='591'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 580</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_set_keepalive_opts'>set_keepalive_opts</span>(<span class='id identifier rubyid_sock'>sock</span>)
  <span class='id identifier rubyid_sock'>sock</span>.<span class='id identifier rubyid_setsockopt'>setsockopt</span>(<span class='const'>SOL_SOCKET</span><span class='comma'>,</span> <span class='const'>SO_KEEPALIVE</span><span class='comma'>,</span> <span class='kw'>true</span>)
  <span class='id identifier rubyid_set_option'><a href="#set_option-instance_method" title="Mongo::Socket#set_option (method)">set_option</a></span>(<span class='id identifier rubyid_sock'>sock</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='const'>TCP_KEEPINTVL</span><span class='comma'>,</span> <span class='const'><a href="#DEFAULT_TCP_KEEPINTVL-constant" title="Mongo::Socket::DEFAULT_TCP_KEEPINTVL (constant)">DEFAULT_TCP_KEEPINTVL</a></span>)
  <span class='id identifier rubyid_set_option'><a href="#set_option-instance_method" title="Mongo::Socket#set_option (method)">set_option</a></span>(<span class='id identifier rubyid_sock'>sock</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='const'>TCP_KEEPCNT</span><span class='comma'>,</span> <span class='const'><a href="#DEFAULT_TCP_KEEPCNT-constant" title="Mongo::Socket::DEFAULT_TCP_KEEPCNT (constant)">DEFAULT_TCP_KEEPCNT</a></span>)
  <span class='id identifier rubyid_set_option'><a href="#set_option-instance_method" title="Mongo::Socket#set_option (method)">set_option</a></span>(<span class='id identifier rubyid_sock'>sock</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='const'>TCP_KEEPIDLE</span><span class='comma'>,</span> <span class='const'><a href="#DEFAULT_TCP_KEEPIDLE-constant" title="Mongo::Socket::DEFAULT_TCP_KEEPIDLE (constant)">DEFAULT_TCP_KEEPIDLE</a></span>)
  <span class='id identifier rubyid_set_option'><a href="#set_option-instance_method" title="Mongo::Socket#set_option (method)">set_option</a></span>(<span class='id identifier rubyid_sock'>sock</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='const'>TCP_USER_TIMEOUT</span><span class='comma'>,</span> <span class='const'><a href="#DEFAULT_TCP_USER_TIMEOUT-constant" title="Mongo::Socket::DEFAULT_TCP_USER_TIMEOUT (constant)">DEFAULT_TCP_USER_TIMEOUT</a></span>)
<span class='kw'>rescue</span>
  <span class='comment'># JRuby 9.2.13.0 and lower do not define TCP_KEEPINTVL etc. constants.
</span>  <span class='comment'># JRuby 9.2.14.0 defines the constants but does not allow to get or
</span>  <span class='comment'># set them with this error:
</span>  <span class='comment'># Errno::ENOPROTOOPT: Protocol not available - Protocol not available
</span><span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="set_option-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>set_option</strong>(sock, option, default)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L593-L600'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='593' data-end='600'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 593</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_set_option'>set_option</span>(<span class='id identifier rubyid_sock'>sock</span><span class='comma'>,</span> <span class='id identifier rubyid_option'>option</span><span class='comma'>,</span> <span class='id identifier rubyid_default'>default</span>)
  <span class='kw'>if</span> <span class='const'>Socket</span>.<span class='id identifier rubyid_const_defined?'>const_defined?</span>(<span class='id identifier rubyid_option'>option</span>)
    <span class='id identifier rubyid_system_default'>system_default</span> <span class='op'>=</span> <span class='id identifier rubyid_sock'>sock</span>.<span class='id identifier rubyid_getsockopt'>getsockopt</span>(<span class='const'>IPPROTO_TCP</span><span class='comma'>,</span> <span class='id identifier rubyid_option'>option</span>).<span class='id identifier rubyid_int'>int</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_system_default'>system_default</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_default'>default</span>
      <span class='id identifier rubyid_sock'>sock</span>.<span class='id identifier rubyid_setsockopt'>setsockopt</span>(<span class='const'>IPPROTO_TCP</span><span class='comma'>,</span> <span class='id identifier rubyid_option'>option</span><span class='comma'>,</span> <span class='id identifier rubyid_default'>default</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="set_socket_options-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>set_socket_options</strong>(sock)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L602-L605'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='602' data-end='605'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 602</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_set_socket_options'>set_socket_options</span>(<span class='id identifier rubyid_sock'>sock</span>)
  <span class='id identifier rubyid_sock'>sock</span>.<span class='id identifier rubyid_set_encoding'>set_encoding</span>(<span class='const'>BSON</span><span class='op'>::</span><span class='const'>BINARY</span>)
  <span class='id identifier rubyid_set_keepalive_opts'><a href="#set_keepalive_opts-instance_method" title="Mongo::Socket#set_keepalive_opts (method)">set_keepalive_opts</a></span>(<span class='id identifier rubyid_sock'>sock</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="summary-instance_method">
  <h3 class='signature nodoc'>
    #<strong>summary</strong>  &#x21d2; <code>String</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>Human-readable summary of the socket for debugging.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L122-L134'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='122' data-end='134'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 122</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_summary'>summary</span>
  <span class='id identifier rubyid_fileno'>fileno</span> <span class='op'>=</span> <span class='ivar'>@socket</span><span class='op'>&amp;.</span><span class='id identifier rubyid_fileno'>fileno</span> <span class='kw'>rescue</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&lt;no socket&gt;</span><span class='tstring_end'>&#39;</span></span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&lt;no socket&gt;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>if</span> <span class='id identifier rubyid_monitor?'><a href="#monitor%3F-instance_method" title="Mongo::Socket#monitor? (method)">monitor?</a></span>
    <span class='id identifier rubyid_indicator'>indicator</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Socket#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_push'>push</span>]
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pm</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>else</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>m</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>end</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection_address'><a href="#connection_address-instance_method" title="Mongo::Socket#connection_address (method)">connection_address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_indicator'>indicator</span><span class='embexpr_end'>}</span><span class='tstring_content'>;fd=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_fileno'>fileno</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection_address'><a href="#connection_address-instance_method" title="Mongo::Socket#connection_address (method)">connection_address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>;c:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection_generation'><a href="#connection_generation-instance_method" title="Mongo::Socket#connection_generation (method)">connection_generation</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>;fd=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_fileno'>fileno</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="unix_socket?-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>unix_socket?</strong>(sock)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L568-L570'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='568' data-end='570'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 568</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_unix_socket?'>unix_socket?</span>(<span class='id identifier rubyid_sock'>sock</span>)
  <span class='kw'>defined?</span>(<span class='const'>UNIXSocket</span>) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_sock'>sock</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'>UNIXSocket</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="wait_for_socket_to_be_writable-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>wait_for_socket_to_be_writable</strong>(deadline)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L551-L566'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='551' data-end='566'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 551</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_for_socket_to_be_writable'>wait_for_socket_to_be_writable</span>(<span class='id identifier rubyid_deadline'>deadline</span>)
  <span class='id identifier rubyid_select_timeout'>select_timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
  <span class='id identifier rubyid_rv'>rv</span> <span class='op'>=</span> <span class='const'>Kernel</span>.<span class='id identifier rubyid_select'>select</span>(<span class='kw'>nil</span><span class='comma'>,</span> [<span class='ivar'>@socket</span>]<span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_select_timeout'>select_timeout</span>)

  <span class='kw'>if</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Environment</span>.<span class='id identifier rubyid_jruby?'>jruby?</span>
    <span class='comment'># Ignore the return value of Kernel.select.
</span>    <span class='comment'># On JRuby, select appears to return nil prior to timeout expiration
</span>    <span class='comment'># (apparently due to a EAGAIN) which then causes us to fail the read
</span>    <span class='comment'># even though we could have retried it.
</span>    <span class='comment'># Check the deadline ourselves.
</span>    <span class='id identifier rubyid_select_timeout'>select_timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_select_timeout'>select_timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span>
  <span class='kw'>end</span>

  <span class='op'>!</span><span class='id identifier rubyid_rv'>rv</span>.<span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="write-instance_method">
  <h3 class='signature nodoc'>
    #<strong>write</strong>(*args, timeout: nil)  &#x21d2; <code>Integer</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Writes data to the socket instance.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>args</span>
    <span class='type'>(<code>Array</code>&lt;<code>Object</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The data to be written.</p>
</div>
  </li>
  <li>
    <span class='name'>timeout</span>
    <span class='type'>(<code>Numeric</code>)</span>
&mdash;    <div class='inline'>
<p>The total timeout to the whole write operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The length of bytes written to the socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/SocketError.html" title="Mongo::Error::SocketError (class)">Error::SocketError</a> | <a href="Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">Error::SocketTimeoutError</a>)</span>
&mdash;    <div class='inline'>
<p>When there is a network error during the write.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L250-L254'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='250' data-end='254'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 250</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_write'>write</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_map_exceptions'><a href="#map_exceptions-instance_method" title="Mongo::Socket#map_exceptions (method)">map_exceptions</a></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_do_write'><a href="#do_write-instance_method" title="Mongo::Socket#do_write (method)">do_write</a></span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="write_chunk-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>write_chunk</strong>(chunk, timeout)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L532-L549'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='532' data-end='549'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 532</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_write_chunk'>write_chunk</span>(<span class='id identifier rubyid_chunk'>chunk</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>)
  <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>=</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>

  <span class='id identifier rubyid_written'>written</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_written'>written</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_chunk'>chunk</span>.<span class='id identifier rubyid_length'>length</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_written'>written</span> <span class='op'>+=</span> <span class='ivar'>@socket</span>.<span class='id identifier rubyid_write_nonblock'>write_nonblock</span>(<span class='id identifier rubyid_chunk'>chunk</span>[<span class='id identifier rubyid_written'>written</span><span class='op'>..</span><span class='op'>-</span><span class='int'>1</span>])
    <span class='kw'>rescue</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>WaitWritable</span><span class='comma'>,</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>EINTR</span>
      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_wait_for_socket_to_be_writable'><a href="#wait_for_socket_to_be_writable-instance_method" title="Mongo::Socket#wait_for_socket_to_be_writable (method)">wait_for_socket_to_be_writable</a></span>(<span class='id identifier rubyid_deadline'>deadline</span>)
        <span class='id identifier rubyid_raise_timeout_error!'><a href="#raise_timeout_error!-instance_method" title="Mongo::Socket#raise_timeout_error! (method)">raise_timeout_error!</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Took more than </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> seconds to receive data</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='kw'>true</span>)
      <span class='kw'>end</span>

      <span class='kw'>retry</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_written'>written</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="write_with_timeout-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>write_with_timeout</strong>(*args, timeout:)  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Writes data to to the socket, the write duration is limited to <a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">#timeout</a>.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>args</span>
    <span class='type'>(<code>Array</code>&lt;<code>Object</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The data to be written.</p>
</div>
  </li>
  <li>
    <span class='name'>:timeout</span>
    <span class='type'>(<code>Numeric</code>)</span>
&mdash;    <div class='inline'>
<p>The total timeout to the whole write operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The length of bytes written to the socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<code>ArgumentError</code>)</span>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L515-L530'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='515' data-end='530'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 515</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_write_with_timeout'>write_with_timeout</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='label'>timeout:</span>)
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>timeout cannot be nil</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>.<span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise_timeout_error!'><a href="#raise_timeout_error!-instance_method" title="Mongo::Socket#raise_timeout_error! (method)">raise_timeout_error!</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Negative timeout </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> given to socket</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='kw'>true</span>) <span class='kw'>if</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span> <span class='op'>&lt;</span> <span class='int'>0</span>

  <span class='id identifier rubyid_written'>written</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_args'>args</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_buf'>buf</span><span class='op'>|</span>
    <span class='id identifier rubyid_buf'>buf</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span>.<span class='id identifier rubyid_to_s'>to_s</span>
    <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_buf'>buf</span>.<span class='id identifier rubyid_length'>length</span>
      <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span>[<span class='id identifier rubyid_i'>i</span><span class='op'>...</span>(<span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='const'><a href="#WRITE_CHUNK_SIZE-constant" title="Mongo::Socket::WRITE_CHUNK_SIZE (constant)">WRITE_CHUNK_SIZE</a></span>)]
      <span class='id identifier rubyid_written'>written</span> <span class='op'>+=</span> <span class='id identifier rubyid_write_chunk'><a href="#write_chunk-instance_method" title="Mongo::Socket#write_chunk (method)">write_chunk</a></span>(<span class='id identifier rubyid_chunk'>chunk</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'><a href="#timeout-instance_method" title="Mongo::Socket#timeout (method)">timeout</a></span>)
      <span class='id identifier rubyid_i'>i</span> <span class='op'>+=</span> <span class='const'><a href="#WRITE_CHUNK_SIZE-constant" title="Mongo::Socket::WRITE_CHUNK_SIZE (constant)">WRITE_CHUNK_SIZE</a></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_written'>written</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="write_without_timeout-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>write_without_timeout</strong>(*args)  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Writes data to to the socket.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>args</span>
    <span class='type'>(<code>Array</code>&lt;<code>Object</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The data to be written.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The length of bytes written to the socket.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/socket.rb#L486-L507'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='486' data-end='507'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/socket.rb', line 486</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_write_without_timeout'>write_without_timeout</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='comment'># This method used to forward arguments to @socket.write in a
</span>  <span class='comment'># single call like so:
</span>  <span class='comment'>#
</span>  <span class='comment'># @socket.write(*args)
</span>  <span class='comment'>#
</span>  <span class='comment'># Turns out, when each buffer to be written is large (e.g. 32 MiB),
</span>  <span class='comment'># this write call would take an extremely long time (20+ seconds)
</span>  <span class='comment'># while using 100% CPU. Splitting the writes into chunks produced
</span>  <span class='comment'># massively better performance (0.05 seconds to write the 32 MiB of
</span>  <span class='comment'># data on the same hardware). Unfortunately splitting the data,
</span>  <span class='comment'># one would assume, results in it being copied, but this seems to be
</span>  <span class='comment'># a much more minor issue compared to CPU cost of writing large buffers.
</span>  <span class='id identifier rubyid_args'>args</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_buf'>buf</span><span class='op'>|</span>
    <span class='id identifier rubyid_buf'>buf</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span>.<span class='id identifier rubyid_to_s'>to_s</span>
    <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_buf'>buf</span>.<span class='id identifier rubyid_length'>length</span>
      <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span>[<span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='const'><a href="#WRITE_CHUNK_SIZE-constant" title="Mongo::Socket::WRITE_CHUNK_SIZE (constant)">WRITE_CHUNK_SIZE</a></span>]
      <span class='id identifier rubyid_i'>i</span> <span class='op'>+=</span> <span class='ivar'>@socket</span>.<span class='id identifier rubyid_write'><a href="#write-instance_method" title="Mongo::Socket#write (method)">write</a></span>(<span class='id identifier rubyid_chunk'>chunk</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>