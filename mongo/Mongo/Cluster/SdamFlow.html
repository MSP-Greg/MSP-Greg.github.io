<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Cluster::SdamFlow &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Cluster::SdamFlow",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongo master</a> &raquo; 
      <a href='../../_index.html#alpha_S'>Index (S)</a> &raquo; 
        <a href="../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../Cluster.html" title="Mongo::Cluster (class)">Cluster</a> &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>SdamFlow&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Cluster::SdamFlow  <span class='private note title'>Private</span>
</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This class is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          Forwardable
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L28'>lib/mongo/cluster/sdam_flow.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Handles SDAM flow for a server description changed event.</p>

<p>Updates server descriptions, topology descriptions and publishes SDAM events.</p>

<p><code>SdamFlow</code> is meant to be instantiated once for every server description changed event that needs to be processed.</p>

  </div>
</div>
<div class='tags'>
  
</div>
</div>
<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(cluster, previous_desc, updated_desc, awaited: false)  &#x21d2; SdamFlow </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#awaited%3F-instance_method" title="#awaited? (instance method)">#<strong>awaited?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#became_unknown%3F-instance_method" title="#became_unknown? (instance method)">#<strong>became_unknown?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns whether the server whose description this flow processed was not previously unknown, and is now.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#cluster-instance_method" title="#cluster (instance method)">#<strong>cluster</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#original_desc-instance_method" title="#original_desc (instance method)">#<strong>original_desc</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#previous_desc-instance_method" title="#previous_desc (instance method)">#<strong>previous_desc</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#stale_primary%3F-instance_method" title="#stale_primary? (instance method)">#<strong>stale_primary?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Whether updated_desc is for a stale primary.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#topology-instance_method" title="#topology (instance method)">#<strong>topology</strong>  &#x21d2; Object </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>The topology stored in this attribute can change multiple times throughout a single sdam flow (e.g. unknown -&gt; RS no primary -&gt; RS with primary).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#topology_effectively_changed%3F-instance_method" title="#topology_effectively_changed? (instance method)">#<strong>topology_effectively_changed?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns whether topology meaningfully changed as a result of running SDAM flow.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#updated_desc-instance_method" title="#updated_desc (instance method)">#<strong>updated_desc</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#add_servers_from_desc-instance_method" title="#add_servers_from_desc (instance method)">#<strong>add_servers_from_desc</strong>(updated_desc)  &#x21d2; Array&lt;Server&gt; </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Adds all servers referenced in the given description (which is supposed to have come from a good primary) which are not already in the cluster, to the cluster.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#check_if_has_primary-instance_method" title="#check_if_has_primary (instance method)">#<strong>check_if_has_primary</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Checks if the cluster has a primary, and if not, transitions the topology to ReplicaSetNoPrimary.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#commit_changes-instance_method" title="#commit_changes (instance method)">#<strong>commit_changes</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Publishes server description changed events, updates topology on the cluster and publishes topology changed event, as needed based on operations performed during SDAM flow processing.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#disconnect_servers-instance_method" title="#disconnect_servers (instance method)">#<strong>disconnect_servers</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#do_remove-instance_method" title="#do_remove (instance method)">#<strong>do_remove</strong>(address_str)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Removes specified server from topology and warns if the topology ends up with an empty server list as a result.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#publish_description_change_event-instance_method" title="#publish_description_change_event (instance method)">#<strong>publish_description_change_event</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#remove-instance_method" title="#remove (instance method)">#<strong>remove</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Removes the server whose description we are processing from the topology.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#remove_servers_not_in_desc-instance_method" title="#remove_servers_not_in_desc (instance method)">#<strong>remove_servers_not_in_desc</strong>(updated_desc)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Removes servers from the topology which are not present in the given server description (which is supposed to have come from a good primary).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#server_description_changed-instance_method" title="#server_description_changed (instance method)">#<strong>server_description_changed</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#start_pool_if_data_bearing-instance_method" title="#start_pool_if_data_bearing (instance method)">#<strong>start_pool_if_data_bearing</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>If the server being processed is identified as data bearing, creates the server’s connection pool so it can start populating.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#update_rs_from_primary-instance_method" title="#update_rs_from_primary (instance method)">#<strong>update_rs_from_primary</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Updates topology which must be a ReplicaSetWithPrimary with information from the primary’s server description.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#update_rs_with_primary_from_member-instance_method" title="#update_rs_with_primary_from_member (instance method)">#<strong>update_rs_with_primary_from_member</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Updates a ReplicaSetWithPrimary topology from a non-primary member.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#update_rs_without_primary-instance_method" title="#update_rs_without_primary (instance method)">#<strong>update_rs_without_primary</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Updates a ReplicaSetNoPrimary topology from a non-primary member.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#update_server_descriptions-instance_method" title="#update_server_descriptions (instance method)">#<strong>update_server_descriptions</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Updates descriptions on all servers whose address matches updated_desc’s address.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#update_unknown_with_standalone-instance_method" title="#update_unknown_with_standalone (instance method)">#<strong>update_unknown_with_standalone</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Transitions from unknown to single topology type, when a standalone server is discovered.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#verify_invariants-instance_method" title="#verify_invariants (instance method)">#<strong>verify_invariants</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="awaited?-instance_method">
  <h3 class='signature ro  nodoc first'>
    #<strong>awaited?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L58-L60'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='58' data-end='60'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 58</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_awaited?'>awaited?</span>
  <span class='ivar'>@awaited</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="became_unknown?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>became_unknown?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns whether the server whose description this flow processed was not previously unknown, and is now. Used to decide, in particular, whether to clear the server’s connection pool.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L618-L620'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='618' data-end='620'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 618</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_became_unknown?'>became_unknown?</span>
  <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_unknown?'>unknown?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_original_desc'><a href="#original_desc-instance_method" title="Mongo::Cluster::SdamFlow#original_desc (method)">original_desc</a></span>.<span class='id identifier rubyid_unknown?'>unknown?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cluster-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>cluster</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L40-L40'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='40' data-end='40'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 40</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cluster'>cluster</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="original_desc-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>original_desc</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L56-L56'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='56' data-end='56'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 56</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_original_desc'>original_desc</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="previous_desc-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>previous_desc</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L54-L54'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='54' data-end='54'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 54</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_previous_desc'>previous_desc</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="stale_primary?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>stale_primary?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Whether updated_desc is for a stale primary.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L586-L613'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='586' data-end='613'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 586</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_stale_primary?'>stale_primary?</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_max_wire_version'>max_wire_version</span> <span class='op'>&gt;=</span> <span class='int'>17</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_election_id'>election_id</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_election_id'>max_election_id</span>.<span class='id identifier rubyid_nil?'>nil?</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_election_id'>election_id</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_election_id'>max_election_id</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_election_id'>election_id</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_election_id'>max_election_id</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_election_id'>election_id</span> <span class='op'>==</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_election_id'>max_election_id</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_set_version'>set_version</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_set_version'>max_set_version</span>.<span class='id identifier rubyid_nil?'>nil?</span>
        <span class='kw'>return</span> <span class='kw'>true</span>
      <span class='kw'>end</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_set_version'>set_version</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_set_version'>set_version</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_set_version'>max_set_version</span>
        <span class='kw'>return</span> <span class='kw'>true</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_election_id'>election_id</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_set_version'>set_version</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_election_id'>max_election_id</span> <span class='op'>&amp;&amp;</span>
          (<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_set_version'>set_version</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>||</span>
              (<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_set_version'>set_version</span> <span class='op'>==</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>&amp;&amp;</span>
                  <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_election_id'>election_id</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_election_id'>max_election_id</span>))
        <span class='kw'>return</span> <span class='kw'>true</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>false</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="topology-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>topology</strong>  &#x21d2; <code>Object</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>The topology stored in this attribute can change multiple times throughout a single sdam flow (e.g. unknown -&gt; RS no primary -&gt; RS with primary). Events for topology change get sent at the end of flow processing, such that the above example only publishes an unknown -&gt; RS with primary event to the application.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p>Mongo::Cluster::Topology The current topology.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L52-L52'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='52' data-end='52'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 52</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_topology'>topology</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="topology_effectively_changed?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>topology_effectively_changed?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns whether topology meaningfully changed as a result of running SDAM flow.</p>

<p>The spec defines topology equality through equality of topology types and server descriptions in each topology; this definition is not usable by us because our topology objects do not hold server descriptions and are instead “live”. Thus we have to store the full list of server descriptions at the beginning of SDAM flow and compare them to the current ones.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L631-L641'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='631' data-end='641'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 631</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_topology_effectively_changed?'>topology_effectively_changed?</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_equal?'>equal?</span>(<span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>)
    <span class='kw'>return</span> <span class='kw'>true</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_server_descriptions'>server_descriptions</span> <span class='op'>=</span> <span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    [<span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_description'>description</span>]
  <span class='kw'>end</span>

  <span class='ivar'>@previous_server_descriptions</span> <span class='op'>!=</span> <span class='id identifier rubyid_server_descriptions'>server_descriptions</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="updated_desc-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>updated_desc</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L55-L55'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='55' data-end='55'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 55</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_updated_desc'>updated_desc</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="add_servers_from_desc-instance_method">
  <h3 class='signature nodoc first'>
    #<strong>add_servers_from_desc</strong>(updated_desc)  &#x21d2; <code>Array</code>&lt;<a href="../Server.html" title="Mongo::Server (class)">Server</a>&gt; 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Servers are added unmonitored. <a href="../Monitoring.html" title="Mongo::Monitoring (class)"><code>::Mongo::Monitoring</code></a> must be started later</p>
</div>
  </div>


<p>Adds all servers referenced in the given description (which is supposed to have come from a good primary) which are not already in the cluster, to the cluster.</p>

<p>separately.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>&lt;<a href="../Server.html" title="Mongo::Server (class)">Server</a>&gt;)</span>
&mdash;    <div class='inline'>
<p>Servers actually added to the cluster. This is the set of servers on which monitoring should be started.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L374-L387'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='374' data-end='387'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 374</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add_servers_from_desc'>add_servers_from_desc</span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>)
  <span class='id identifier rubyid_added_servers'>added_servers</span> <span class='op'>=</span> []
  <span class='qwords'><span class='qwords_beg'>%w(</span><span class='tstring_content'>hosts</span><span class='words_sep'> </span><span class='tstring_content'>passives</span><span class='words_sep'> </span><span class='tstring_content'>arbiters</span><span class='tstring_end'>)</span></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span>
    <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_send'>send</span>(<span class='id identifier rubyid_m'>m</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_address_str'>address_str</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_add'><a href="../Cluster.html#add-instance_method" title="Mongo::Cluster#add (method)">add</a></span>(<span class='id identifier rubyid_address_str'>address_str</span><span class='comma'>,</span> <span class='label'>monitor:</span> <span class='kw'>false</span>)
        <span class='id identifier rubyid_added_servers'>added_servers</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_server'>server</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_verify_invariants'><a href="#verify_invariants-instance_method" title="Mongo::Cluster::SdamFlow#verify_invariants (method)">verify_invariants</a></span>

  <span class='id identifier rubyid_added_servers'>added_servers</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="check_if_has_primary-instance_method">
  <h3 class='signature nodoc'>
    #<strong>check_if_has_primary</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Checks if the cluster has a primary, and if not, transitions the topology to ReplicaSetNoPrimary. <a href="Topology.html" title="Mongo::Cluster::Topology (module)"><code>Topology</code></a> must be ReplicaSetWithPrimary when invoking this method.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L570-L583'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='570' data-end='583'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 570</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_check_if_has_primary'>check_if_has_primary</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set?'>replica_set?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>check_if_has_primary should only be called when topology is replica set, but it is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_class'>class</span>.<span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_sub'>sub</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>.*::</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>)<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_primary'>primary</span> <span class='op'>=</span> <span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span>.<span class='id identifier rubyid_detect'>detect</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='comment'># A primary with the wrong set name is not a primary
</span>    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_primary?'>primary?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span> <span class='op'>==</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
  <span class='kw'>end</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_primary'>primary</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetNoPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetNoPrimary (class)">ReplicaSetNoPrimary</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(
      <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span><span class='comma'>,</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="commit_changes-instance_method">
  <h3 class='signature nodoc'>
    #<strong>commit_changes</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Publishes server description changed events, updates topology on the cluster and publishes topology changed event, as needed based on operations performed during SDAM flow processing.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L494-L544'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='494' data-end='544'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 494</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_commit_changes'>commit_changes</span>
  <span class='comment'># The application-visible sequence of events should be as follows:
</span>  <span class='comment'>#
</span>  <span class='comment'># 1. Description change for the server which we are processing;
</span>  <span class='comment'># 2. Topology change, if any;
</span>  <span class='comment'># 3. Description changes for other servers, if any.
</span>  <span class='comment'>#
</span>  <span class='comment'># The tricky part here is that the server description changes are
</span>  <span class='comment'># not all processed together.
</span>
  <span class='id identifier rubyid_publish_description_change_event'><a href="#publish_description_change_event-instance_method" title="Mongo::Cluster::SdamFlow#publish_description_change_event (method)">publish_description_change_event</a></span>
  <span class='id identifier rubyid_start_pool_if_data_bearing'><a href="#start_pool_if_data_bearing-instance_method" title="Mongo::Cluster::SdamFlow#start_pool_if_data_bearing (method)">start_pool_if_data_bearing</a></span>

  <span class='id identifier rubyid_topology_changed_event_published'>topology_changed_event_published</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_equal?'>equal?</span>(<span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>) <span class='op'>||</span> <span class='ivar'>@need_topology_changed_event</span>
    <span class='comment'># We are about to publish topology changed event.
</span>    <span class='comment'># Recreate the topology instance to get its server descriptions
</span>    <span class='comment'># up to date.
</span>    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_class'>class</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Cluster::SdamFlow.new (method)">new</a></span>(<span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span><span class='comma'>,</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>)
    <span class='comment'># This sends the SDAM event
</span>    <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_update_topology'><a href="../Cluster.html#update_topology-instance_method" title="Mongo::Cluster#update_topology (method)">update_topology</a></span>(<span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>)
    <span class='id identifier rubyid_topology_changed_event_published'>topology_changed_event_published</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='ivar'>@need_topology_changed_event</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='comment'># If a server description changed, topology description change event
</span>  <span class='comment'># must be published with the previous and next topologies being of
</span>  <span class='comment'># the same type, unless we already published topology change event
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_topology_changed_event_published'>topology_changed_event_published</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_unknown?'>unknown?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_previous_desc'><a href="#previous_desc-instance_method" title="Mongo::Cluster::SdamFlow#previous_desc (method)">previous_desc</a></span>.<span class='id identifier rubyid_unknown?'>unknown?</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_object_id'>object_id</span> <span class='op'>==</span> <span class='id identifier rubyid_previous_desc'><a href="#previous_desc-instance_method" title="Mongo::Cluster::SdamFlow#previous_desc (method)">previous_desc</a></span>.<span class='id identifier rubyid_object_id'>object_id</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_topology_effectively_changed?'><a href="#topology_effectively_changed%3F-instance_method" title="Mongo::Cluster::SdamFlow#topology_effectively_changed? (method)">topology_effectively_changed?</a></span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># If we are here, there has been a change in the server descriptions
</span>  <span class='comment'># in our topology, but topology class has not changed.
</span>  <span class='comment'># Publish the topology changed event and recreate the topology to
</span>  <span class='comment'># get the new list of server descriptions into it.
</span>  <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_class'>class</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Cluster::SdamFlow.new (method)">new</a></span>(<span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span><span class='comma'>,</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>)
  <span class='comment'># This sends the SDAM event
</span>  <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_update_topology'><a href="../Cluster.html#update_topology-instance_method" title="Mongo::Cluster#update_topology (method)">update_topology</a></span>(<span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="disconnect_servers-instance_method">
  <h3 class='signature nodoc'>
    #<strong>disconnect_servers</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L546-L553'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='546' data-end='553'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 546</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_disconnect_servers'>disconnect_servers</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='ivar'>@servers_to_disconnect</span>.<span class='id identifier rubyid_shift'>shift</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_connected?'><a href="../Cluster.html#connected%3F-instance_method" title="Mongo::Cluster#connected? (method)">connected?</a></span>
      <span class='comment'># Do not publish server closed event, as this was already done
</span>      <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_disconnect!'>disconnect!</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="do_remove-instance_method">
  <h3 class='signature nodoc'>
    #<strong>do_remove</strong>(address_str)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Removes specified server from topology and warns if the topology ends up with an empty server list as a result</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L421-L445'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='421' data-end='445'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 421</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_remove'>do_remove</span>(<span class='id identifier rubyid_address_str'>address_str</span>)
  <span class='id identifier rubyid_servers'><a href="../Cluster.html#servers-instance_method" title="Mongo::Cluster#servers (method)">servers</a></span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_remove'><a href="#remove-instance_method" title="Mongo::Cluster::SdamFlow#remove (method)">remove</a></span>(<span class='id identifier rubyid_address_str'>address_str</span><span class='comma'>,</span> <span class='label'>disconnect:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_servers'><a href="../Cluster.html#servers-instance_method" title="Mongo::Cluster#servers (method)">servers</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='comment'># Clear the description so that the server is marked as unknown.
</span>    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_clear_description'>clear_description</span>

    <span class='comment'># We need to publish server closed event here, but we cannot close
</span>    <span class='comment'># the server because it could be the server owning the monitor in
</span>    <span class='comment'># whose thread this flow is presently executing, in which case closing
</span>    <span class='comment'># the server can terminate the thread and leave SDAM processing
</span>    <span class='comment'># incomplete. Thus we have to remove the server from the cluster,
</span>    <span class='comment'># publish the event, but do not call disconnect on the server until
</span>    <span class='comment'># the very end when all processing has completed.
</span>    <span class='id identifier rubyid_publish_sdam_event'>publish_sdam_event</span>(
      <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring.html#SERVER_CLOSED-constant" title="Mongo::Monitoring::SERVER_CLOSED (constant)">SERVER_CLOSED</a></span><span class='comma'>,</span>
      <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/ServerClosed.html" title="Mongo::Monitoring::Event::ServerClosed (class)">ServerClosed</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/ServerClosed.html#new-class_method" title="Mongo::Monitoring::Event::ServerClosed.new (method)">new</a></span>(<span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>)
    )
  <span class='kw'>end</span>
  <span class='ivar'>@servers_to_disconnect</span> <span class='op'>+=</span> <span class='id identifier rubyid_servers'><a href="../Cluster.html#servers-instance_method" title="Mongo::Cluster#servers (method)">servers</a></span>
  <span class='kw'>if</span> <span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Topology now has no servers - this is likely a misconfiguration of the cluster and/or the application</span><span class='tstring_end'>&quot;</span></span>
    )
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="publish_description_change_event-instance_method">
  <h3 class='signature nodoc'>
    #<strong>publish_description_change_event</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L447-L489'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='447' data-end='489'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 447</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_publish_description_change_event'>publish_description_change_event</span>
  <span class='comment'># This method may be invoked when server description definitely changed
</span>  <span class='comment'># but prior to the topology getting updated. Therefore we check both
</span>  <span class='comment'># server description changes and overall topology changes. When this
</span>  <span class='comment'># method is called at the end of SDAM flow as part of &quot;commit changes&quot;
</span>  <span class='comment'># step, server description change is incorporated into the topology
</span>  <span class='comment'># change.
</span>  <span class='kw'>unless</span> <span class='ivar'>@server_description_changed</span> <span class='op'>||</span> <span class='id identifier rubyid_topology_effectively_changed?'><a href="#topology_effectively_changed%3F-instance_method" title="Mongo::Cluster::SdamFlow#topology_effectively_changed? (method)">topology_effectively_changed?</a></span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># updated_desc here may not be the description we received from
</span>  <span class='comment'># the server - in case of a stale primary, the server reported itself
</span>  <span class='comment'># as being a primary but updated_desc here will be unknown.
</span>
  <span class='comment'># We used to not notify on Unknown -&gt; Unknown server changes.
</span>  <span class='comment'># Technically these are valid state changes (or at least as valid as
</span>  <span class='comment'># other server description changes when the description has not
</span>  <span class='comment'># changed meaningfully but the events are still published).
</span>  <span class='comment'># The current version of the driver notifies on Unknown -&gt; Unknown
</span>  <span class='comment'># transitions.
</span>
  <span class='comment'># Avoid dispatching events when updated description is the same as
</span>  <span class='comment'># previous description. This allows this method to be called multiple
</span>  <span class='comment'># times in the flow when the events should be published, without
</span>  <span class='comment'># worrying about whether there are any unpublished changes.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_object_id'>object_id</span> <span class='op'>==</span> <span class='id identifier rubyid_previous_desc'><a href="#previous_desc-instance_method" title="Mongo::Cluster::SdamFlow#previous_desc (method)">previous_desc</a></span>.<span class='id identifier rubyid_object_id'>object_id</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_publish_sdam_event'>publish_sdam_event</span>(
    <span class='op'>::</span><span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring.html#SERVER_DESCRIPTION_CHANGED-constant" title="Mongo::Monitoring::SERVER_DESCRIPTION_CHANGED (constant)">SERVER_DESCRIPTION_CHANGED</a></span><span class='comma'>,</span>
    <span class='op'>::</span><span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/ServerDescriptionChanged.html" title="Mongo::Monitoring::Event::ServerDescriptionChanged (class)">ServerDescriptionChanged</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/ServerDescriptionChanged.html#new-class_method" title="Mongo::Monitoring::Event::ServerDescriptionChanged.new (method)">new</a></span>(
      <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span><span class='comma'>,</span>
      <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span><span class='comma'>,</span>
      <span class='id identifier rubyid_previous_desc'><a href="#previous_desc-instance_method" title="Mongo::Cluster::SdamFlow#previous_desc (method)">previous_desc</a></span><span class='comma'>,</span>
      <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span><span class='comma'>,</span>
      <span class='label'>awaited:</span> <span class='id identifier rubyid_awaited?'><a href="#awaited%3F-instance_method" title="Mongo::Cluster::SdamFlow#awaited? (method)">awaited?</a></span><span class='comma'>,</span>
    )
  )
  <span class='ivar'>@previous_desc</span> <span class='op'>=</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>
  <span class='ivar'>@need_topology_changed_event</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="remove-instance_method">
  <h3 class='signature nodoc'>
    #<strong>remove</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Removes the server whose description we are processing from the topology.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L414-L417'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='414' data-end='417'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 414</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_remove'>remove</span>
  <span class='id identifier rubyid_publish_description_change_event'><a href="#publish_description_change_event-instance_method" title="Mongo::Cluster::SdamFlow#publish_description_change_event (method)">publish_description_change_event</a></span>
  <span class='id identifier rubyid_do_remove'><a href="#do_remove-instance_method" title="Mongo::Cluster::SdamFlow#do_remove (method)">do_remove</a></span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="remove_servers_not_in_desc-instance_method">
  <h3 class='signature nodoc'>
    #<strong>remove_servers_not_in_desc</strong>(updated_desc)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Removes servers from the topology which are not present in the given server description (which is supposed to have come from a good primary).</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L392-L410'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='392' data-end='410'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 392</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_servers_not_in_desc'>remove_servers_not_in_desc</span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>)
  <span class='id identifier rubyid_updated_desc_address_strs'>updated_desc_address_strs</span> <span class='op'>=</span> <span class='qwords'><span class='qwords_beg'>%w(</span><span class='tstring_content'>hosts</span><span class='words_sep'> </span><span class='tstring_content'>passives</span><span class='words_sep'> </span><span class='tstring_content'>arbiters</span><span class='tstring_end'>)</span></span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span>
    <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_send'>send</span>(<span class='id identifier rubyid_m'>m</span>)
  <span class='kw'>end</span>.<span class='id identifier rubyid_flatten'>flatten</span>
  <span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_updated_desc_address_strs'>updated_desc_address_strs</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_address_str'>address_str</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span>)
      <span class='id identifier rubyid_updated_host'>updated_host</span> <span class='op'>=</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_me'>me</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_me'>me</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_host'>updated_host</span>
        <span class='id identifier rubyid_updated_host'>updated_host</span> <span class='op'>+=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> (self-identified as </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_me'>me</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_log_warn'>log_warn</span>(
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address_str'>address_str</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it is not in hosts reported by primary </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_host'>updated_host</span><span class='embexpr_end'>}</span><span class='tstring_content'>. Reported hosts are: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
        <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_hosts'>hosts</span>.<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span>)
      )
      <span class='id identifier rubyid_do_remove'><a href="#do_remove-instance_method" title="Mongo::Cluster::SdamFlow#do_remove (method)">do_remove</a></span>(<span class='id identifier rubyid_address_str'>address_str</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="server_description_changed-instance_method">
  <h3 class='signature nodoc'>
    #<strong>server_description_changed</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L93-L192'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='93' data-end='192'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 93</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_server_description_changed'>server_description_changed</span>
  <span class='ivar'>@previous_server_descriptions</span> <span class='op'>=</span> <span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    [<span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_description'>description</span>]
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_update_server_descriptions'><a href="#update_server_descriptions-instance_method" title="Mongo::Cluster::SdamFlow#update_server_descriptions (method)">update_server_descriptions</a></span>
    <span class='comment'># All of the transitions require that server whose updated_desc we are
</span>    <span class='comment'># processing is still in the cluster (i.e., was not removed as a result
</span>    <span class='comment'># of processing another response, potentially concurrently).
</span>    <span class='comment'># If update_server_descriptions returned false we have no servers
</span>    <span class='comment'># in the topology for the description we are processing, stop.
</span>    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>case</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>
  <span class='kw'>when</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/LoadBalanced.html" title="Mongo::Cluster::Topology::LoadBalanced (class)">LoadBalanced</a></span>
    <span class='ivar'>@updated_desc</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span><span class='op'>::</span><span class='const'><a href="../Server/Description.html" title="Mongo::Server::Description (class)">Description</a></span><span class='op'>::</span><span class='const'><a href="../Server/Description/LoadBalancer.html" title="Mongo::Server::Description::LoadBalancer (class)">LoadBalancer</a></span>.<span class='id identifier rubyid_new'><a href="../Server/Description/LoadBalancer.html#new-class_method" title="Mongo::Server::Description::LoadBalancer.new (method)">new</a></span>(
      <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span><span class='comma'>,</span>
    )
    <span class='id identifier rubyid_update_server_descriptions'><a href="#update_server_descriptions-instance_method" title="Mongo::Cluster::SdamFlow#update_server_descriptions (method)">update_server_descriptions</a></span>
  <span class='kw'>when</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/Single.html" title="Mongo::Cluster::Topology::Single (class)">Single</a></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span> <span class='op'>!=</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
        <span class='id identifier rubyid_log_warn'>log_warn</span>(
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> has an incorrect replica set name &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;; expected &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
        )
        <span class='ivar'>@updated_desc</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span><span class='op'>::</span><span class='const'><a href="../Server/Description.html" title="Mongo::Server::Description (class)">Description</a></span>.<span class='id identifier rubyid_new'><a href="../Server/Description.html#new-class_method" title="Mongo::Server::Description.new (method)">new</a></span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span><span class='comma'>,</span>
          {}<span class='comma'>,</span> <span class='label'>average_round_trip_time:</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_average_round_trip_time'>average_round_trip_time</span>)
        <span class='id identifier rubyid_update_server_descriptions'><a href="#update_server_descriptions-instance_method" title="Mongo::Cluster::SdamFlow#update_server_descriptions (method)">update_server_descriptions</a></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/Unknown.html" title="Mongo::Cluster::Topology::Unknown (class)">Unknown</a></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_standalone?'>standalone?</span>
      <span class='id identifier rubyid_update_unknown_with_standalone'><a href="#update_unknown_with_standalone-instance_method" title="Mongo::Cluster::SdamFlow#update_unknown_with_standalone (method)">update_unknown_with_standalone</a></span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_mongos?'>mongos?</span>
      <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/Sharded.html" title="Mongo::Cluster::Topology::Sharded (class)">Sharded</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(<span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span><span class='comma'>,</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_primary?'>primary?</span>
      <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(
        <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='label'>replica_set_name:</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>)<span class='comma'>,</span>
        <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
      <span class='id identifier rubyid_update_rs_from_primary'><a href="#update_rs_from_primary-instance_method" title="Mongo::Cluster::SdamFlow#update_rs_from_primary (method)">update_rs_from_primary</a></span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_secondary?'>secondary?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_arbiter?'>arbiter?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_other?'>other?</span>
      <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetNoPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetNoPrimary (class)">ReplicaSetNoPrimary</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(
        <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='label'>replica_set_name:</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>)<span class='comma'>,</span>
        <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
      <span class='id identifier rubyid_update_rs_without_primary'><a href="#update_rs_without_primary-instance_method" title="Mongo::Cluster::SdamFlow#update_rs_without_primary (method)">update_rs_without_primary</a></span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/Sharded.html" title="Mongo::Cluster::Topology::Sharded (class)">Sharded</a></span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_unknown?'>unknown?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_mongos?'>mongos?</span>
      <span class='id identifier rubyid_log_warn'>log_warn</span>(
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it is of the wrong type (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_server_type'>server_type</span>.<span class='id identifier rubyid_to_s'>to_s</span>.<span class='id identifier rubyid_upcase'>upcase</span><span class='embexpr_end'>}</span><span class='tstring_content'>) - expected SHARDED</span><span class='tstring_end'>&quot;</span></span>
      )
      <span class='id identifier rubyid_remove'><a href="#remove-instance_method" title="Mongo::Cluster::SdamFlow#remove (method)">remove</a></span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_standalone?'>standalone?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_mongos?'>mongos?</span>
      <span class='id identifier rubyid_log_warn'>log_warn</span>(
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it is of the wrong type (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_server_type'>server_type</span>.<span class='id identifier rubyid_to_s'>to_s</span>.<span class='id identifier rubyid_upcase'>upcase</span><span class='embexpr_end'>}</span><span class='tstring_content'>) - expected a replica set member</span><span class='tstring_end'>&quot;</span></span>
      )
      <span class='id identifier rubyid_remove'><a href="#remove-instance_method" title="Mongo::Cluster::SdamFlow#remove (method)">remove</a></span>
      <span class='id identifier rubyid_check_if_has_primary'><a href="#check_if_has_primary-instance_method" title="Mongo::Cluster::SdamFlow#check_if_has_primary (method)">check_if_has_primary</a></span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_primary?'>primary?</span>
      <span class='id identifier rubyid_update_rs_from_primary'><a href="#update_rs_from_primary-instance_method" title="Mongo::Cluster::SdamFlow#update_rs_from_primary (method)">update_rs_from_primary</a></span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_secondary?'>secondary?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_arbiter?'>arbiter?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_other?'>other?</span>
      <span class='id identifier rubyid_update_rs_with_primary_from_member'><a href="#update_rs_with_primary_from_member-instance_method" title="Mongo::Cluster::SdamFlow#update_rs_with_primary_from_member (method)">update_rs_with_primary_from_member</a></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_check_if_has_primary'><a href="#check_if_has_primary-instance_method" title="Mongo::Cluster::SdamFlow#check_if_has_primary (method)">check_if_has_primary</a></span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetNoPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetNoPrimary (class)">ReplicaSetNoPrimary</a></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_standalone?'>standalone?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_mongos?'>mongos?</span>
      <span class='id identifier rubyid_log_warn'>log_warn</span>(
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it is of the wrong type (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_server_type'>server_type</span>.<span class='id identifier rubyid_to_s'>to_s</span>.<span class='id identifier rubyid_upcase'>upcase</span><span class='embexpr_end'>}</span><span class='tstring_content'>) - expected a replica set member</span><span class='tstring_end'>&quot;</span></span>
      )
      <span class='id identifier rubyid_remove'><a href="#remove-instance_method" title="Mongo::Cluster::SdamFlow#remove (method)">remove</a></span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_primary?'>primary?</span>
      <span class='comment'># Here we change topology type to RS with primary, however
</span>      <span class='comment'># while processing updated_desc we may find that its RS name
</span>      <span class='comment'># does not match our existing RS name. For this reason
</span>      <span class='comment'># is is imperative to NOT pass updated_desc&#39;s RS name to
</span>      <span class='comment'># topology constructor here.
</span>      <span class='comment'># During processing we may remove the server whose updated_desc
</span>      <span class='comment'># we are be processing (e.g. the RS name mismatch case again),
</span>      <span class='comment'># in which case topoogy type will go back to RS without primary
</span>      <span class='comment'># in the check_if_has_primary step.
</span>      <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(
        <span class='comment'># Do not pass updated_desc&#39;s RS name here
</span>        <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span><span class='comma'>,</span>
        <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
      <span class='id identifier rubyid_update_rs_from_primary'><a href="#update_rs_from_primary-instance_method" title="Mongo::Cluster::SdamFlow#update_rs_from_primary (method)">update_rs_from_primary</a></span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_secondary?'>secondary?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_arbiter?'>arbiter?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_other?'>other?</span>
      <span class='id identifier rubyid_update_rs_without_primary'><a href="#update_rs_without_primary-instance_method" title="Mongo::Cluster::SdamFlow#update_rs_without_primary (method)">update_rs_without_primary</a></span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unknown topology </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_verify_invariants'><a href="#verify_invariants-instance_method" title="Mongo::Cluster::SdamFlow#verify_invariants (method)">verify_invariants</a></span>
  <span class='id identifier rubyid_commit_changes'><a href="#commit_changes-instance_method" title="Mongo::Cluster::SdamFlow#commit_changes (method)">commit_changes</a></span>
  <span class='id identifier rubyid_disconnect_servers'><a href="#disconnect_servers-instance_method" title="Mongo::Cluster::SdamFlow#disconnect_servers (method)">disconnect_servers</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="start_pool_if_data_bearing-instance_method">
  <h3 class='signature nodoc'>
    #<strong>start_pool_if_data_bearing</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>If the server being processed is identified as data bearing, creates the server’s connection pool so it can start populating</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L557-L565'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='557' data-end='565'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 557</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_start_pool_if_data_bearing'>start_pool_if_data_bearing</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_data_bearing?'>data_bearing?</span>

  <span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_address'>address</span> <span class='op'>==</span> <span class='ivar'>@updated_desc</span>.<span class='id identifier rubyid_address'>address</span>
      <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_pool'><a href="../Cluster.html#pool-instance_method" title="Mongo::Cluster#pool (method)">pool</a></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_rs_from_primary-instance_method">
  <h3 class='signature nodoc'>
    #<strong>update_rs_from_primary</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Updates topology which must be a ReplicaSetWithPrimary with information from the primary’s server description.</p>

<p>This method does not change topology type to ReplicaSetWithPrimary - this needs to have been done prior to calling this method.</p>

<p>If the primary whose description is being processed is determined to be stale, this method will change the server description and topology type to unknown.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L217-L288'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='217' data-end='288'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 217</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_rs_from_primary'>update_rs_from_primary</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(
      <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='label'>replica_set_name:</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>)<span class='comma'>,</span>
      <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it has an </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>incorrect replica set name &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;; </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>expected &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
    )
    <span class='id identifier rubyid_remove'><a href="#remove-instance_method" title="Mongo::Cluster::SdamFlow#remove (method)">remove</a></span>
    <span class='id identifier rubyid_check_if_has_primary'><a href="#check_if_has_primary-instance_method" title="Mongo::Cluster::SdamFlow#check_if_has_primary (method)">check_if_has_primary</a></span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_stale_primary?'><a href="#stale_primary%3F-instance_method" title="Mongo::Cluster::SdamFlow#stale_primary? (method)">stale_primary?</a></span>
    <span class='ivar'>@updated_desc</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span><span class='op'>::</span><span class='const'><a href="../Server/Description.html" title="Mongo::Server::Description (class)">Description</a></span>.<span class='id identifier rubyid_new'><a href="../Server/Description.html#new-class_method" title="Mongo::Server::Description.new (method)">new</a></span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span><span class='comma'>,</span>
      {}<span class='comma'>,</span> <span class='label'>average_round_trip_time:</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_average_round_trip_time'>average_round_trip_time</span>)
    <span class='id identifier rubyid_update_server_descriptions'><a href="#update_server_descriptions-instance_method" title="Mongo::Cluster::SdamFlow#update_server_descriptions (method)">update_server_descriptions</a></span>
    <span class='id identifier rubyid_check_if_has_primary'><a href="#check_if_has_primary-instance_method" title="Mongo::Cluster::SdamFlow#check_if_has_primary (method)">check_if_has_primary</a></span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_max_wire_version'>max_wire_version</span> <span class='op'>&gt;=</span> <span class='int'>17</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(
      <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span>.<span class='id identifier rubyid_merge'>merge</span>(
        <span class='label'>max_election_id:</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_election_id'>election_id</span><span class='comma'>,</span>
        <span class='label'>max_set_version:</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_set_version'>set_version</span>
      )<span class='comma'>,</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_max_election_id'>max_election_id</span> <span class='op'>=</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_new_max_election_id'>new_max_election_id</span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>)
    <span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>=</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_new_max_set_version'>new_max_set_version</span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>)

    <span class='kw'>if</span> <span class='id identifier rubyid_max_election_id'>max_election_id</span> <span class='op'>!=</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_election_id'>max_election_id</span> <span class='op'>||</span>
      <span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>!=</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_max_set_version'>max_set_version</span>
    <span class='kw'>then</span>
      <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(
        <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span>.<span class='id identifier rubyid_merge'>merge</span>(
          <span class='label'>max_election_id:</span> <span class='id identifier rubyid_max_election_id'>max_election_id</span><span class='comma'>,</span>
          <span class='label'>max_set_version:</span> <span class='id identifier rubyid_max_set_version'>max_set_version</span>
        )<span class='comma'>,</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># At this point we have accepted the updated server description
</span>  <span class='comment'># and the topology (both are primary). Commit these changes so that
</span>  <span class='comment'># their respective SDAM events are published before SDAM events for
</span>  <span class='comment'># server additions/removals that follow
</span>  <span class='id identifier rubyid_publish_description_change_event'><a href="#publish_description_change_event-instance_method" title="Mongo::Cluster::SdamFlow#publish_description_change_event (method)">publish_description_change_event</a></span>

  <span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_address'>address</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_primary?'>primary?</span>
        <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_update_description'>update_description</span>(<span class='op'>::</span><span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span><span class='op'>::</span><span class='const'><a href="../Server/Description.html" title="Mongo::Server::Description (class)">Description</a></span>.<span class='id identifier rubyid_new'><a href="../Server/Description.html#new-class_method" title="Mongo::Server::Description.new (method)">new</a></span>(
          <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> {}<span class='comma'>,</span>
          <span class='label'>average_round_trip_time:</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_average_round_trip_time'>average_round_trip_time</span>))
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_servers'><a href="../Cluster.html#servers-instance_method" title="Mongo::Cluster#servers (method)">servers</a></span> <span class='op'>=</span> <span class='id identifier rubyid_add_servers_from_desc'><a href="#add_servers_from_desc-instance_method" title="Mongo::Cluster::SdamFlow#add_servers_from_desc (method)">add_servers_from_desc</a></span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>)
  <span class='id identifier rubyid_remove_servers_not_in_desc'><a href="#remove_servers_not_in_desc-instance_method" title="Mongo::Cluster::SdamFlow#remove_servers_not_in_desc (method)">remove_servers_not_in_desc</a></span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>)

  <span class='id identifier rubyid_check_if_has_primary'><a href="#check_if_has_primary-instance_method" title="Mongo::Cluster::SdamFlow#check_if_has_primary (method)">check_if_has_primary</a></span>

  <span class='id identifier rubyid_servers'><a href="../Cluster.html#servers-instance_method" title="Mongo::Cluster#servers (method)">servers</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_start_monitoring'>start_monitoring</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_rs_with_primary_from_member-instance_method">
  <h3 class='signature nodoc'>
    #<strong>update_rs_with_primary_from_member</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Updates a ReplicaSetWithPrimary topology from a non-primary member.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L291-L325'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='291' data-end='325'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 291</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_rs_with_primary_from_member'>update_rs_with_primary_from_member</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it has an </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>incorrect replica set name (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>); </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>current set name is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    )
    <span class='id identifier rubyid_remove'><a href="#remove-instance_method" title="Mongo::Cluster::SdamFlow#remove (method)">remove</a></span>
    <span class='id identifier rubyid_check_if_has_primary'><a href="#check_if_has_primary-instance_method" title="Mongo::Cluster::SdamFlow#check_if_has_primary (method)">check_if_has_primary</a></span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_me_mismatch?'>me_mismatch?</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>reported itself as </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_me'>me</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    )
    <span class='id identifier rubyid_remove'><a href="#remove-instance_method" title="Mongo::Cluster::SdamFlow#remove (method)">remove</a></span>
    <span class='id identifier rubyid_check_if_has_primary'><a href="#check_if_has_primary-instance_method" title="Mongo::Cluster::SdamFlow#check_if_has_primary (method)">check_if_has_primary</a></span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_have_primary'>have_primary</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_primary?'>primary?</span>
      <span class='id identifier rubyid_have_primary'>have_primary</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_have_primary'>have_primary</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetNoPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetNoPrimary (class)">ReplicaSetNoPrimary</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(
      <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span><span class='comma'>,</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_rs_without_primary-instance_method">
  <h3 class='signature nodoc'>
    #<strong>update_rs_without_primary</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Updates a ReplicaSetNoPrimary topology from a non-primary member.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L328-L363'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='328' data-end='363'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 328</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_rs_without_primary'>update_rs_without_primary</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/ReplicaSetNoPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetNoPrimary (class)">ReplicaSetNoPrimary</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(
      <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='label'>replica_set_name:</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>)<span class='comma'>,</span>
      <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it has an </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>incorrect replica set name (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>); </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>current set name is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    )
    <span class='id identifier rubyid_remove'><a href="#remove-instance_method" title="Mongo::Cluster::SdamFlow#remove (method)">remove</a></span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_publish_description_change_event'><a href="#publish_description_change_event-instance_method" title="Mongo::Cluster::SdamFlow#publish_description_change_event (method)">publish_description_change_event</a></span>

  <span class='id identifier rubyid_servers'><a href="../Cluster.html#servers-instance_method" title="Mongo::Cluster#servers (method)">servers</a></span> <span class='op'>=</span> <span class='id identifier rubyid_add_servers_from_desc'><a href="#add_servers_from_desc-instance_method" title="Mongo::Cluster::SdamFlow#add_servers_from_desc (method)">add_servers_from_desc</a></span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>)

  <span class='id identifier rubyid_commit_changes'><a href="#commit_changes-instance_method" title="Mongo::Cluster::SdamFlow#commit_changes (method)">commit_changes</a></span>

  <span class='id identifier rubyid_servers'><a href="../Cluster.html#servers-instance_method" title="Mongo::Cluster#servers (method)">servers</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_start_monitoring'>start_monitoring</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_me_mismatch?'>me_mismatch?</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>reported itself as </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_me'>me</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    )
    <span class='id identifier rubyid_remove'><a href="#remove-instance_method" title="Mongo::Cluster::SdamFlow#remove (method)">remove</a></span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_server_descriptions-instance_method">
  <h3 class='signature nodoc'>
    #<strong>update_server_descriptions</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Updates descriptions on all servers whose address matches updated_desc’s address.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L66-L91'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='66' data-end='91'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 66</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_server_descriptions'>update_server_descriptions</span>
  <span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_address'>address</span> <span class='op'>==</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>
      <span class='comment'># SDAM flow must be run when topology version in the new description
</span>      <span class='comment'># is equal to the current topology version, per the example in
</span>      <span class='comment'># https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#what-is-the-purpose-of-topologyversion
</span>      <span class='kw'>unless</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_topology_version_gte?'>topology_version_gte?</span>(<span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_description'>description</span>)
        <span class='kw'>return</span> <span class='kw'>false</span>
      <span class='kw'>end</span>

      <span class='ivar'>@server_description_changed</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_description'>description</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>

      <span class='comment'># Always update server description, so that fields that do not
</span>      <span class='comment'># affect description equality comparisons but are part of the
</span>      <span class='comment'># description are updated.
</span>      <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_update_description'>update_description</span>(<span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>)
      <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_update_last_scan'>update_last_scan</span>

      <span class='comment'># If there was no content difference between descriptions, we
</span>      <span class='comment'># still need to run sdam flow, but if the flow produces no change
</span>      <span class='comment'># in topology we will omit sending events.
</span>      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>false</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_unknown_with_standalone-instance_method">
  <h3 class='signature nodoc'>
    #<strong>update_unknown_with_standalone</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Transitions from unknown to single topology type, when a standalone server is discovered.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L196-L206'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='196' data-end='206'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 196</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_unknown_with_standalone'>update_unknown_with_standalone</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_seeds'><a href="../Cluster.html#seeds-instance_method" title="Mongo::Cluster#seeds (method)">seeds</a></span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="Topology/Single.html" title="Mongo::Cluster::Topology::Single (class)">Single</a></span>.<span class='id identifier rubyid_new'><a href="Topology/Base.html#new-class_method" title="Mongo::Cluster::Topology::Base.new (method)">new</a></span>(
      <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_options'><a href="../Cluster.html#options-instance_method" title="Mongo::Cluster#options (method)">options</a></span><span class='comma'>,</span> <span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_monitoring'><a href="../Cluster.html#monitoring-instance_method" title="Mongo::Cluster#monitoring (method)">monitoring</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'><a href="#updated_desc-instance_method" title="Mongo::Cluster::SdamFlow#updated_desc (method)">updated_desc</a></span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it is a standalone and we have multiple seeds (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_seeds'><a href="../Cluster.html#seeds-instance_method" title="Mongo::Cluster#seeds (method)">seeds</a></span>.<span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
    )
    <span class='id identifier rubyid_remove'><a href="#remove-instance_method" title="Mongo::Cluster::SdamFlow#remove (method)">remove</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="verify_invariants-instance_method">
  <h3 class='signature nodoc'>
    #<strong>verify_invariants</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/cluster/sdam_flow.rb#L643-L651'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='643' data-end='651'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/cluster/sdam_flow.rb', line 643</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_verify_invariants'>verify_invariants</span>
  <span class='kw'>if</span> <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_topology'><a href="#topology-instance_method" title="Mongo::Cluster::SdamFlow#topology (method)">topology</a></span>.<span class='id identifier rubyid_single?'>single?</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>1</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Trying to create a single topology with multiple servers: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Cluster::SdamFlow#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_servers_list'><a href="../Cluster.html#servers_list-instance_method" title="Mongo::Cluster#servers_list (method)">servers_list</a></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>