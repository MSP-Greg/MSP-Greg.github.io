<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::BulkWrite &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::BulkWrite",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Mongo master</a> &raquo; 
      <a href='../_index.html#alpha_B'>Index (B)</a> &raquo; 
        <a href="../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>BulkWrite&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::BulkWrite</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Modules:</div>
      <div class='box_11'>
          <a href="BulkWrite/Combineable.html" title="Mongo::BulkWrite::Combineable (module)"><code>Combineable</code></a>,
        <a href="BulkWrite/Transformable.html" title="Mongo::BulkWrite::Transformable (module)"><code>Transformable</code></a>,
        <a href="BulkWrite/Validatable.html" title="Mongo::BulkWrite::Validatable (module)"><code>Validatable</code></a>      </div>
    </td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a href="BulkWrite/OrderedCombiner.html" title="Mongo::BulkWrite::OrderedCombiner (class)"><code>OrderedCombiner</code></a>,
        <a href="BulkWrite/Result.html" title="Mongo::BulkWrite::Result (class)"><code>Result</code></a>,
        <a href="BulkWrite/ResultCombiner.html" title="Mongo::BulkWrite::ResultCombiner (class)"><code>ResultCombiner</code></a>,
        <a href="BulkWrite/UnorderedCombiner.html" title="Mongo::BulkWrite::UnorderedCombiner (class)"><code>UnorderedCombiner</code></a>      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          Forwardable
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="Operation/ResponseHandling.html" title="Mongo::Operation::ResponseHandling (module)"><code>Operation::ResponseHandling</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2 o'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L27'>lib/mongo/bulk_write.rb</a><span class='defines'>,<br /><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write/combineable.rb#L19'>lib/mongo/bulk_write/combineable.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write/ordered_combiner.rb#L19'>lib/mongo/bulk_write/ordered_combiner.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write/result.rb#L19'>lib/mongo/bulk_write/result.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write/result_combiner.rb#L19'>lib/mongo/bulk_write/result_combiner.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write/transformable.rb#L19'>lib/mongo/bulk_write/transformable.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write/unordered_combiner.rb#L19'>lib/mongo/bulk_write/unordered_combiner.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write/validatable.rb#L19'>lib/mongo/bulk_write/validatable.rb</a></span>
      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='SINGLE_STATEMENT_OPS-constant' class='summary_signature'>SINGLE_STATEMENT_OPS =</span>
    <br/>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L169-L171'># File 'lib/mongo/bulk_write.rb', line 169</a>    <pre class='code ruby'>[ <span class='symbeg'>:</span><span class='id identifier rubyid_delete_one'><a href="#delete_one-instance_method" title="Mongo::BulkWrite#delete_one (method)">delete_one</a></span><span class='comma'>,</span>
<span class='symbeg'>:</span><span class='id identifier rubyid_update_one'><a href="#update_one-instance_method" title="Mongo::BulkWrite#update_one (method)">update_one</a></span><span class='comma'>,</span>
<span class='symbeg'>:</span><span class='id identifier rubyid_insert_one'><a href="#insert_one-instance_method" title="Mongo::BulkWrite#insert_one (method)">insert_one</a></span> ].<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(collection, requests, options = {})  &#x21d2; BulkWrite </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Create the new bulk write operation.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#collection-instance_method" title="#collection (instance method)">#<strong>collection</strong>  &#x21d2; Mongo::Collection </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#options-instance_method" title="#options (instance method)">#<strong>options</strong>  &#x21d2; Hash, BSON::Document </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#ordered%3F-instance_method" title="#ordered? (instance method)">#<strong>ordered?</strong>  &#x21d2; true, false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Is the bulk write ordered?</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#requests-instance_method" title="#requests (instance method)">#<strong>requests</strong>  &#x21d2; Array&lt;Hash, BSON::Document&gt; </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#execute-instance_method" title="#execute (instance method)">#<strong>execute</strong>  &#x21d2; Mongo::BulkWrite::Result </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Execute the bulk write operation.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#write_concern-instance_method" title="#write_concern (instance method)">#<strong>write_concern</strong>(session = nil)  &#x21d2; WriteConcern </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Get the write concern for the bulk write.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#base_spec-instance_method" title="#base_spec (instance method)">#<strong>base_spec</strong>(operation_id, session)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#calculate_deadline-instance_method" title="#calculate_deadline (instance method)">#<strong>calculate_deadline</strong>  &#x21d2; Float | nil </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#can_hint%3F-instance_method" title="#can_hint? (instance method)">#<strong>can_hint?</strong>(connection)  &#x21d2; true | false </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Loop through the requests and check if each operation is allowed to send a hint for each operation on the given server version.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#delete_many-instance_method" title="#delete_many (instance method)">#<strong>delete_many</strong>(documents, connection, context, operation_id, session, txn_num)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#delete_one-instance_method" title="#delete_one (instance method)">#<strong>delete_one</strong>(documents, connection, context, operation_id, session, txn_num)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#execute_operation-instance_method" title="#execute_operation (instance method)">#<strong>execute_operation</strong>(name, values, connection, context, operation_id, result_combiner, session, txn_num = nil)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#insert_one-instance_method" title="#insert_one (instance method)">#<strong>insert_one</strong>(documents, connection, context, operation_id, session, txn_num)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#maybe_first-instance_method" title="#maybe_first (instance method)">#<strong>maybe_first</strong>(obj)  &#x21d2; Object </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>If the given object is an array return the first element, otherwise return the given object.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#op_combiner-instance_method" title="#op_combiner (instance method)">#<strong>op_combiner</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#op_timeout_ms-instance_method" title="#op_timeout_ms (instance method)">#<strong>op_timeout_ms</strong>(deadline)  &#x21d2; Integer | nil </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#replace_one-instance_method" title="#replace_one (instance method)">#<strong>replace_one</strong>(documents, connection, context, operation_id, session, txn_num)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Alias for <a href="#update_one-instance_method" title="Mongo::BulkWrite#update_one (method)">#update_one</a>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#single_statement%3F-instance_method" title="#single_statement? (instance method)">#<strong>single_statement?</strong>(operation)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#split_execute-instance_method" title="#split_execute (instance method)">#<strong>split_execute</strong>(name, values, connection, context, operation_id, result_combiner, session, txn_num)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#update_many-instance_method" title="#update_many (instance method)">#<strong>update_many</strong>(documents, connection, context, operation_id, session, txn_num)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#update_one-instance_method" title="#update_one (instance method)">#<strong>update_one</strong>(documents, connection, context, operation_id, session, txn_num)  </a>
      (also: #replace_one)
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#validate_array_filters!-instance_method" title="#validate_array_filters! (instance method)">#<strong>validate_array_filters!</strong>(connection)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#validate_collation!-instance_method" title="#validate_collation! (instance method)">#<strong>validate_collation!</strong>(connection)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#validate_hint!-instance_method" title="#validate_hint! (instance method)">#<strong>validate_hint!</strong>(connection)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#validate_requests!-instance_method" title="#validate_requests! (instance method)">#<strong>validate_requests!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Perform the request document validation required by driver specifications.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited nodoc'><a href="Operation/ResponseHandling.html" title="Mongo::Operation::ResponseHandling (module)"><code>Operation::ResponseHandling</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="Operation/ResponseHandling.html#add_error_labels-instance_method" title="Mongo::Operation::ResponseHandling#add_error_labels (method)">#add_error_labels</a></td>
      <td><div class='inline'><p>Adds error labels to exceptions raised in the yielded to block, which should perform MongoDB operations and raise Mongo::Errors on failure.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="Operation/ResponseHandling.html#add_server_diagnostics-instance_method" title="Mongo::Operation::ResponseHandling#add_server_diagnostics (method)">#add_server_diagnostics</a></td>
      <td><div class='inline'><p>Yields to the block and, if the block raises an exception, adds a note to the exception with the address of the specified server.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="Operation/ResponseHandling.html#maybe_add_retryable_write_error_label!-instance_method" title="Mongo::Operation::ResponseHandling#maybe_add_retryable_write_error_label! (method)">#maybe_add_retryable_write_error_label!</a></td>
      <td><div class='inline'><p>A method that will add the RetryableWriteError label to an error if any of the following conditions are true:</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="Operation/ResponseHandling.html#unpin_maybe-instance_method" title="Mongo::Operation::ResponseHandling#unpin_maybe (method)">#unpin_maybe</a></td>
      <td><div class='inline'><p>Unpins the session and/or the connection if  the yielded to block raises errors that are required to unpin the session and the connection.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv nodoc' href="Operation/ResponseHandling.html#validate_result-instance_method" title="Mongo::Operation::ResponseHandling#validate_result (method)">#validate_result</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="collection-instance_method">
  <h3 class='signature ro first'>
    #<strong>collection</strong>  &#x21d2; <a href="Collection.html" title="Mongo::Collection (class)">Mongo::Collection</a>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Collection.html" title="Mongo::Collection (class)">Mongo::Collection</a>)</span>
&mdash;    <div class='inline'>
<p>collection The collection.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L32-L32'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='32' data-end='32'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 32</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_collection'>collection</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="options-instance_method">
  <h3 class='signature ro'>
    #<strong>options</strong>  &#x21d2; <code>Hash</code>, <code>BSON::Document</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>, <code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>options The options.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L38-L38'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='38' data-end='38'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 38</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_options'>options</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ordered?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>ordered?</strong>  &#x21d2; <code>true</code>, <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Is the bulk write ordered?</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Is the bulk write ordered?</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_bulk_write'>bulk_write</span>.<span class='id identifier rubyid_ordered?'>ordered?</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>, <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>If the bulk write is ordered.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.1.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L147-L149'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='147' data-end='149'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 147</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ordered?'>ordered?</span>
  <span class='ivar'>@ordered</span> <span class='op'>||=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::BulkWrite#options (method)">options</a></span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_ordered'>ordered</span><span class='comma'>,</span> <span class='kw'>true</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="requests-instance_method">
  <h3 class='signature ro'>
    #<strong>requests</strong>  &#x21d2; <code>Array</code>&lt;<code>Hash</code>, <code>BSON::Document</code>&gt;  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>&lt;<code>Hash</code>, <code>BSON::Document</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>requests The requests.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L35-L35'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='35' data-end='35'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 35</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_requests'>requests</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="base_spec-instance_method">
  <h3 class='signature priv first'>
    #<strong>base_spec</strong>(operation_id, session)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L202-L217'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='202' data-end='217'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 202</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_base_spec'>base_spec</span>(<span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)
  {
    <span class='symbeg'>:</span><span class='id identifier rubyid_db_name'>db_name</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_database'>database</span>.<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_coll_name'>coll_name</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_collection'><a href="#collection-instance_method" title="Mongo::BulkWrite#collection (method)">collection</a></span>.<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'><a href="#write_concern-instance_method" title="Mongo::BulkWrite#write_concern (method)">write_concern</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_write_concern'><a href="#write_concern-instance_method" title="Mongo::BulkWrite#write_concern (method)">write_concern</a></span>(<span class='id identifier rubyid_session'>session</span>)<span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_ordered'>ordered</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ordered?'><a href="#ordered%3F-instance_method" title="Mongo::BulkWrite#ordered? (method)">ordered?</a></span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_operation_id'>operation_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_bypass_document_validation'>bypass_document_validation</span> <span class='op'>=&gt;</span> <span class='op'>!</span><span class='op'>!</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::BulkWrite#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_bypass_document_validation'>bypass_document_validation</span>]<span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_max_time_ms'>max_time_ms</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::BulkWrite#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_time_ms'>max_time_ms</span>]<span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::BulkWrite#options (method)">options</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::BulkWrite#options (method)">options</a></span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_id_generator'>id_generator</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::BulkWrite#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id_generator'>id_generator</span>]<span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_session'>session</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_comment'>comment</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::BulkWrite#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_comment'>comment</span>]<span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_let'>let</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::BulkWrite#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_let'>let</span>]<span class='comma'>,</span>
  }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="calculate_deadline-instance_method">
  <h3 class='signature priv'>
    #<strong>calculate_deadline</strong>  &#x21d2; <code>Float</code> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Float</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>Deadline for the batch of operations, if set.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L174-L183'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='174' data-end='183'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 174</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_calculate_deadline'>calculate_deadline</span>
  <span class='id identifier rubyid_timeout_ms'>timeout_ms</span> <span class='op'>=</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_timeout_ms'>timeout_ms</span>] <span class='op'>||</span> <span class='id identifier rubyid_collection'><a href="#collection-instance_method" title="Mongo::BulkWrite#collection (method)">collection</a></span>.<span class='id identifier rubyid_timeout_ms'>timeout_ms</span>
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span>.<span class='id identifier rubyid_nil?'>nil?</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_timeout_ms'>timeout_ms</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='int'>0</span>
  <span class='kw'>else</span>
    <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>+</span> (<span class='id identifier rubyid_timeout_ms'>timeout_ms</span> <span class='op'>/</span> <span class='float'>1_000.0</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="can_hint?-instance_method">
  <h3 class='signature priv'>
    #<strong>can_hint?</strong>(connection)  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Loop through the requests and check if each operation is allowed to send a hint for each operation on the given server version.</p>

<p>For the following operations, the client can send a hint for servers &gt;= 4.2 and for the rest, the client can only send it for 4.4+:</p>

<pre class="code ruby"><code class="ruby"><span class='op'>-</span> <span class='id identifier rubyid_updateOne'>updateOne</span>
<span class='op'>-</span> <span class='id identifier rubyid_updateMany'>updateMany</span>
<span class='op'>-</span> <span class='id identifier rubyid_replaceOne'>replaceOne</span></code></pre>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<code>Connection</code>)</span>
&mdash;    <div class='inline'>
<p>The connection object.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the request is able to send hints for the current server version.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L335-L350'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='335' data-end='350'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 335</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_can_hint?'>can_hint?</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='id identifier rubyid_gte_4_2'>gte_4_2</span> <span class='op'>=</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_server_version_gte?'>server_version_gte?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>4.2</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_gte_4_4'>gte_4_4</span> <span class='op'>=</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_server_version_gte?'>server_version_gte?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>4.4</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_op_combiner'><a href="#op_combiner-instance_method" title="Mongo::BulkWrite#op_combiner (method)">op_combiner</a></span>.<span class='id identifier rubyid_requests'><a href="#requests-instance_method" title="Mongo::BulkWrite#requests (method)">requests</a></span>.<span class='id identifier rubyid_all?'>all?</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_req'>req</span><span class='op'>|</span>
    <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='id identifier rubyid_req'>req</span>.<span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_first'>first</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_req'>req</span>[<span class='id identifier rubyid_op'>op</span>].<span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_hint'>hint</span>)
      <span class='kw'>if</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_update_one'><a href="#update_one-instance_method" title="Mongo::BulkWrite#update_one (method)">update_one</a></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update_many'><a href="#update_many-instance_method" title="Mongo::BulkWrite#update_many (method)">update_many</a></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_replace_one'><a href="#replace_one-instance_method" title="Mongo::BulkWrite#replace_one (method)">replace_one</a></span>].<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_op'>op</span>)
        <span class='id identifier rubyid_gte_4_2'>gte_4_2</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_gte_4_4'>gte_4_4</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='kw'>true</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="delete_many-instance_method">
  <h3 class='signature priv'>
    #<strong>delete_many</strong>(documents, connection, context, operation_id, session, txn_num)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L269-L274'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='269' data-end='274'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 269</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_delete_many'>delete_many</span>(<span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
  <span class='const'><a href="QueryCache.html" title="Mongo::QueryCache (module)">QueryCache</a></span>.<span class='id identifier rubyid_clear_namespace'><a href="QueryCache.html#clear_namespace-class_method" title="Mongo::QueryCache.clear_namespace (method)">clear_namespace</a></span>(<span class='id identifier rubyid_collection'><a href="#collection-instance_method" title="Mongo::BulkWrite#collection (method)">collection</a></span>.<span class='id identifier rubyid_namespace'>namespace</span>)

  <span class='id identifier rubyid_spec'>spec</span> <span class='op'>=</span> <span class='id identifier rubyid_base_spec'><a href="#base_spec-instance_method" title="Mongo::BulkWrite#base_spec (method)">base_spec</a></span>(<span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>).<span class='id identifier rubyid_merge'>merge</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_deletes'>deletes</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_documents'>documents</span>)
  <span class='const'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="Operation/Delete.html" title="Mongo::Operation::Delete (class)">Delete</a></span>.<span class='id identifier rubyid_new'><a href="Operation/Specifiable.html#initialize-instance_method" title="Mongo::Operation::Specifiable#initialize (method)">new</a></span>(<span class='id identifier rubyid_spec'>spec</span>).<span class='id identifier rubyid_bulk_execute'>bulk_execute</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="delete_one-instance_method">
  <h3 class='signature priv'>
    #<strong>delete_one</strong>(documents, connection, context, operation_id, session, txn_num)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L262-L267'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='262' data-end='267'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 262</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_delete_one'>delete_one</span>(<span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
  <span class='const'><a href="QueryCache.html" title="Mongo::QueryCache (module)">QueryCache</a></span>.<span class='id identifier rubyid_clear_namespace'><a href="QueryCache.html#clear_namespace-class_method" title="Mongo::QueryCache.clear_namespace (method)">clear_namespace</a></span>(<span class='id identifier rubyid_collection'><a href="#collection-instance_method" title="Mongo::BulkWrite#collection (method)">collection</a></span>.<span class='id identifier rubyid_namespace'>namespace</span>)

  <span class='id identifier rubyid_spec'>spec</span> <span class='op'>=</span> <span class='id identifier rubyid_base_spec'><a href="#base_spec-instance_method" title="Mongo::BulkWrite#base_spec (method)">base_spec</a></span>(<span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>).<span class='id identifier rubyid_merge'>merge</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_deletes'>deletes</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
  <span class='const'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="Operation/Delete.html" title="Mongo::Operation::Delete (class)">Delete</a></span>.<span class='id identifier rubyid_new'><a href="Operation/Specifiable.html#initialize-instance_method" title="Mongo::Operation::Specifiable#initialize (method)">new</a></span>(<span class='id identifier rubyid_spec'>spec</span>).<span class='id identifier rubyid_bulk_execute'>bulk_execute</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="execute-instance_method">
  <h3 class='signature '>
    #<strong>execute</strong>  &#x21d2; <a href="BulkWrite/Result.html" title="Mongo::BulkWrite::Result (class)">Mongo::BulkWrite::Result</a> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Execute the bulk write operation.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Execute the bulk write.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_bulk_write'>bulk_write</span>.<span class='id identifier rubyid_execute'>execute</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="BulkWrite/Result.html" title="Mongo::BulkWrite::Result (class)">Mongo::BulkWrite::Result</a>)</span>
&mdash;    <div class='inline'>
<p>The result.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.1.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L58-L100'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='58' data-end='100'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 58</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_execute'>execute</span>
  <span class='id identifier rubyid_operation_id'>operation_id</span> <span class='op'>=</span> <span class='const'><a href="Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span>.<span class='id identifier rubyid_next_operation_id'><a href="Monitoring.html#next_operation_id-class_method" title="Mongo::Monitoring.next_operation_id (method)">next_operation_id</a></span>
  <span class='id identifier rubyid_result_combiner'>result_combiner</span> <span class='op'>=</span> <span class='const'><a href="BulkWrite/ResultCombiner.html" title="Mongo::BulkWrite::ResultCombiner (class)">ResultCombiner</a></span>.<span class='id identifier rubyid_new'><a href="BulkWrite/ResultCombiner.html#new-class_method" title="Mongo::BulkWrite::ResultCombiner.new (method)">new</a></span>
  <span class='id identifier rubyid_operations'>operations</span> <span class='op'>=</span> <span class='id identifier rubyid_op_combiner'><a href="#op_combiner-instance_method" title="Mongo::BulkWrite#op_combiner (method)">op_combiner</a></span>.<span class='id identifier rubyid_combine'>combine</span>
  <span class='id identifier rubyid_validate_requests!'><a href="#validate_requests!-instance_method" title="Mongo::BulkWrite#validate_requests! (method)">validate_requests!</a></span>
  <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_calculate_deadline'><a href="#calculate_deadline-instance_method" title="Mongo::BulkWrite#calculate_deadline (method)">calculate_deadline</a></span>

  <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_with_session'>with_session</span>(<span class='ivar'>@options</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_session'>session</span><span class='op'>|</span>
    <span class='id identifier rubyid_operations'>operations</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_operation'>operation</span><span class='op'>|</span>
      <span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="Operation/Context.html" title="Mongo::Operation::Context (class)">Context</a></span>.<span class='id identifier rubyid_new'><a href="Operation/Context.html#new-class_method" title="Mongo::Operation::Context.new (method)">new</a></span>(
        <span class='label'>client:</span> <span class='id identifier rubyid_client'>client</span><span class='comma'>,</span>
        <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span>
        <span class='label'>operation_timeouts:</span> { <span class='label'>operation_timeout_ms:</span> <span class='id identifier rubyid_op_timeout_ms'><a href="#op_timeout_ms-instance_method" title="Mongo::BulkWrite#op_timeout_ms (method)">op_timeout_ms</a></span>(<span class='id identifier rubyid_deadline'>deadline</span>) }
      )
      <span class='kw'>if</span> <span class='id identifier rubyid_single_statement?'><a href="#single_statement%3F-instance_method" title="Mongo::BulkWrite#single_statement? (method)">single_statement?</a></span>(<span class='id identifier rubyid_operation'>operation</span>)
        <span class='id identifier rubyid_write_concern'><a href="#write_concern-instance_method" title="Mongo::BulkWrite#write_concern (method)">write_concern</a></span> <span class='op'>=</span> <span class='id identifier rubyid_write_concern'><a href="#write_concern-instance_method" title="Mongo::BulkWrite#write_concern (method)">write_concern</a></span>(<span class='id identifier rubyid_session'>session</span>)
        <span class='id identifier rubyid_write_with_retry'>write_with_retry</span>(<span class='id identifier rubyid_write_concern'><a href="#write_concern-instance_method" title="Mongo::BulkWrite#write_concern (method)">write_concern</a></span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='op'>|</span>
          <span class='id identifier rubyid_execute_operation'><a href="#execute_operation-instance_method" title="Mongo::BulkWrite#execute_operation (method)">execute_operation</a></span>(
            <span class='id identifier rubyid_operation'>operation</span>.<span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_first'>first</span><span class='comma'>,</span>
            <span class='id identifier rubyid_operation'>operation</span>.<span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_flatten'>flatten</span><span class='comma'>,</span>
            <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span>
            <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span>
            <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span>
            <span class='id identifier rubyid_result_combiner'>result_combiner</span><span class='comma'>,</span>
            <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span>
            <span class='id identifier rubyid_txn_num'>txn_num</span>)
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_nro_write_with_retry'>nro_write_with_retry</span>(<span class='id identifier rubyid_write_concern'><a href="#write_concern-instance_method" title="Mongo::BulkWrite#write_concern (method)">write_concern</a></span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='op'>|</span>
          <span class='id identifier rubyid_execute_operation'><a href="#execute_operation-instance_method" title="Mongo::BulkWrite#execute_operation (method)">execute_operation</a></span>(
            <span class='id identifier rubyid_operation'>operation</span>.<span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_first'>first</span><span class='comma'>,</span>
            <span class='id identifier rubyid_operation'>operation</span>.<span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_flatten'>flatten</span><span class='comma'>,</span>
            <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span>
            <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span>
            <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span>
            <span class='id identifier rubyid_result_combiner'>result_combiner</span><span class='comma'>,</span>
            <span class='id identifier rubyid_session'>session</span>)
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_result_combiner'>result_combiner</span>.<span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="execute_operation-instance_method">
  <h3 class='signature priv'>
    #<strong>execute_operation</strong>(name, values, connection, context, operation_id, result_combiner, session, txn_num = nil)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L219-L249'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='219' data-end='249'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 219</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_execute_operation'>execute_operation</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_result_combiner'>result_combiner</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_validate_collation!'><a href="#validate_collation!-instance_method" title="Mongo::BulkWrite#validate_collation! (method)">validate_collation!</a></span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='id identifier rubyid_validate_array_filters!'><a href="#validate_array_filters!-instance_method" title="Mongo::BulkWrite#validate_array_filters! (method)">validate_array_filters!</a></span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='id identifier rubyid_validate_hint!'><a href="#validate_hint!-instance_method" title="Mongo::BulkWrite#validate_hint! (method)">validate_hint!</a></span>(<span class='id identifier rubyid_connection'>connection</span>)

  <span class='id identifier rubyid_unpin_maybe'>unpin_maybe</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>) <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_max_write_batch_size'>max_write_batch_size</span>
      <span class='id identifier rubyid_split_execute'><a href="#split_execute-instance_method" title="Mongo::BulkWrite#split_execute (method)">split_execute</a></span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_result_combiner'>result_combiner</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
    <span class='kw'>else</span>
      <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_send'>send</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)

      <span class='id identifier rubyid_add_server_diagnostics'>add_server_diagnostics</span>(<span class='id identifier rubyid_connection'>connection</span>) <span class='kw'>do</span>
        <span class='id identifier rubyid_add_error_labels'>add_error_labels</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>) <span class='kw'>do</span>
          <span class='id identifier rubyid_result_combiner'>result_combiner</span>.<span class='id identifier rubyid_combine!'>combine!</span>(<span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_size'>size</span>)
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='comment'># With OP_MSG (3.6+ servers), the size of each section in the message
</span><span class='comment'># is independently capped at 16m and each bulk operation becomes
</span><span class='comment'># its own section. The size of the entire bulk write is limited to 48m.
</span><span class='comment'># With OP_QUERY (pre-3.6 servers), the entire bulk write is sent as a
</span><span class='comment'># single document and is thus subject to the 16m document size limit.
</span><span class='comment'># This means the splits differ between pre-3.6 and 3.6+ servers, with
</span><span class='comment'># 3.6+ servers being able to split less.
</span><span class='kw'>rescue</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/MaxBSONSize.html" title="Mongo::Error::MaxBSONSize (class)">MaxBSONSize</a></span><span class='comma'>,</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/MaxMessageSize.html" title="Mongo::Error::MaxMessageSize (class)">MaxMessageSize</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span> <span class='kw'>if</span> <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>&lt;=</span> <span class='int'>1</span>
  <span class='id identifier rubyid_unpin_maybe'>unpin_maybe</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>) <span class='kw'>do</span>
    <span class='id identifier rubyid_split_execute'><a href="#split_execute-instance_method" title="Mongo::BulkWrite#split_execute (method)">split_execute</a></span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_result_combiner'>result_combiner</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="insert_one-instance_method">
  <h3 class='signature priv'>
    #<strong>insert_one</strong>(documents, connection, context, operation_id, session, txn_num)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L276-L281'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='276' data-end='281'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 276</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_insert_one'>insert_one</span>(<span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
  <span class='const'><a href="QueryCache.html" title="Mongo::QueryCache (module)">QueryCache</a></span>.<span class='id identifier rubyid_clear_namespace'><a href="QueryCache.html#clear_namespace-class_method" title="Mongo::QueryCache.clear_namespace (method)">clear_namespace</a></span>(<span class='id identifier rubyid_collection'><a href="#collection-instance_method" title="Mongo::BulkWrite#collection (method)">collection</a></span>.<span class='id identifier rubyid_namespace'>namespace</span>)

  <span class='id identifier rubyid_spec'>spec</span> <span class='op'>=</span> <span class='id identifier rubyid_base_spec'><a href="#base_spec-instance_method" title="Mongo::BulkWrite#base_spec (method)">base_spec</a></span>(<span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>).<span class='id identifier rubyid_merge'>merge</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_documents'>documents</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
  <span class='const'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="Operation/Insert.html" title="Mongo::Operation::Insert (class)">Insert</a></span>.<span class='id identifier rubyid_new'><a href="Operation/Specifiable.html#initialize-instance_method" title="Mongo::Operation::Specifiable#initialize (method)">new</a></span>(<span class='id identifier rubyid_spec'>spec</span>).<span class='id identifier rubyid_bulk_execute'>bulk_execute</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="maybe_first-instance_method">
  <h3 class='signature priv'>
    #<strong>maybe_first</strong>(obj)  &#x21d2; <code>Object</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>If the given object is an array return the first element, otherwise return the given object.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>obj</span>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The given object.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The first element of the array or the given object.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L406-L408'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='406' data-end='408'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 406</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_maybe_first'>maybe_first</span>(<span class='id identifier rubyid_obj'>obj</span>)
  <span class='id identifier rubyid_obj'>obj</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'>Array</span>) <span class='op'>?</span> <span class='id identifier rubyid_obj'>obj</span>.<span class='id identifier rubyid_first'>first</span> <span class='op'>:</span> <span class='id identifier rubyid_obj'>obj</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="op_combiner-instance_method">
  <h3 class='signature priv'>
    #<strong>op_combiner</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L251-L253'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='251' data-end='253'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 251</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_op_combiner'>op_combiner</span>
  <span class='ivar'>@op_combiner</span> <span class='op'>||=</span> <span class='id identifier rubyid_ordered?'><a href="#ordered%3F-instance_method" title="Mongo::BulkWrite#ordered? (method)">ordered?</a></span> <span class='op'>?</span> <span class='const'><a href="BulkWrite/OrderedCombiner.html" title="Mongo::BulkWrite::OrderedCombiner (class)">OrderedCombiner</a></span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::BulkWrite.new (method)">new</a></span>(<span class='id identifier rubyid_requests'><a href="#requests-instance_method" title="Mongo::BulkWrite#requests (method)">requests</a></span>) <span class='op'>:</span> <span class='const'><a href="BulkWrite/UnorderedCombiner.html" title="Mongo::BulkWrite::UnorderedCombiner (class)">UnorderedCombiner</a></span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::BulkWrite.new (method)">new</a></span>(<span class='id identifier rubyid_requests'><a href="#requests-instance_method" title="Mongo::BulkWrite#requests (method)">requests</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="op_timeout_ms-instance_method">
  <h3 class='signature priv'>
    #<strong>op_timeout_ms</strong>(deadline)  &#x21d2; <code>Integer</code> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>deadline</span>
    <span class='type'>(<code>Float</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>Deadline for the batch of operations.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p><a href="Timeout.html" title="Mongo::Timeout (module)"><code>Timeout</code></a> in milliseconds for the next operation.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L188-L196'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='188' data-end='196'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 188</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_op_timeout_ms'>op_timeout_ms</span>(<span class='id identifier rubyid_deadline'>deadline</span>)
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_deadline'>deadline</span>.<span class='id identifier rubyid_nil?'>nil?</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='int'>0</span>
  <span class='kw'>else</span>
    ((<span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>) <span class='op'>*</span> <span class='int'>1_000</span>).<span class='id identifier rubyid_to_i'>to_i</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="replace_one-instance_method">
  <h3 class='signature priv'>
    #<strong>replace_one</strong>(documents, connection, context, operation_id, session, txn_num)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Alias for <a href="#update_one-instance_method" title="Mongo::BulkWrite#update_one (method)">#update_one</a>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L289-L289'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='289' data-end='289'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 289</span></pre>
<pre class='code ruby'>

<span class='kw'>alias</span> <span class='symbeg'>:</span><span class='id identifier rubyid_replace_one'>replace_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update_one'><a href="#update_one-instance_method" title="Mongo::BulkWrite#update_one (method)">update_one</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="single_statement?-instance_method">
  <h3 class='signature priv'>
    #<strong>single_statement?</strong>(operation)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L198-L200'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='198' data-end='200'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 198</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_single_statement?'>single_statement?</span>(<span class='id identifier rubyid_operation'>operation</span>)
  <span class='const'><a href="#SINGLE_STATEMENT_OPS-constant" title="Mongo::BulkWrite::SINGLE_STATEMENT_OPS (constant)">SINGLE_STATEMENT_OPS</a></span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_operation'>operation</span>.<span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_first'>first</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="split_execute-instance_method">
  <h3 class='signature priv'>
    #<strong>split_execute</strong>(name, values, connection, context, operation_id, result_combiner, session, txn_num)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L255-L260'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='255' data-end='260'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 255</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_split_execute'>split_execute</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_result_combiner'>result_combiner</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
  <span class='id identifier rubyid_execute_operation'><a href="#execute_operation-instance_method" title="Mongo::BulkWrite#execute_operation (method)">execute_operation</a></span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_shift'>shift</span>(<span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>/</span> <span class='int'>2</span>)<span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_result_combiner'>result_combiner</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)

  <span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_next_txn_num'>next_txn_num</span> <span class='kw'>if</span> <span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
  <span class='id identifier rubyid_execute_operation'><a href="#execute_operation-instance_method" title="Mongo::BulkWrite#execute_operation (method)">execute_operation</a></span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_result_combiner'>result_combiner</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_many-instance_method">
  <h3 class='signature priv'>
    #<strong>update_many</strong>(documents, connection, context, operation_id, session, txn_num)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L291-L296'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='291' data-end='296'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 291</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_many'>update_many</span>(<span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
  <span class='const'><a href="QueryCache.html" title="Mongo::QueryCache (module)">QueryCache</a></span>.<span class='id identifier rubyid_clear_namespace'><a href="QueryCache.html#clear_namespace-class_method" title="Mongo::QueryCache.clear_namespace (method)">clear_namespace</a></span>(<span class='id identifier rubyid_collection'><a href="#collection-instance_method" title="Mongo::BulkWrite#collection (method)">collection</a></span>.<span class='id identifier rubyid_namespace'>namespace</span>)

  <span class='id identifier rubyid_spec'>spec</span> <span class='op'>=</span> <span class='id identifier rubyid_base_spec'><a href="#base_spec-instance_method" title="Mongo::BulkWrite#base_spec (method)">base_spec</a></span>(<span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>).<span class='id identifier rubyid_merge'>merge</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_updates'>updates</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_documents'>documents</span>)
  <span class='const'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="Operation/Update.html" title="Mongo::Operation::Update (class)">Update</a></span>.<span class='id identifier rubyid_new'><a href="Operation/Specifiable.html#initialize-instance_method" title="Mongo::Operation::Specifiable#initialize (method)">new</a></span>(<span class='id identifier rubyid_spec'>spec</span>).<span class='id identifier rubyid_bulk_execute'>bulk_execute</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_one-instance_method">
  <h3 class='signature priv'>
    #<strong>update_one</strong>(documents, connection, context, operation_id, session, txn_num)   <span class="extras">(<span class='priv'>private</span>)</span>
    <span class='aliases'>Also known as: <span class='names'>#replace_one</span></span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L283-L288'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='283' data-end='288'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 283</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_one'>update_one</span>(<span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
  <span class='const'><a href="QueryCache.html" title="Mongo::QueryCache (module)">QueryCache</a></span>.<span class='id identifier rubyid_clear_namespace'><a href="QueryCache.html#clear_namespace-class_method" title="Mongo::QueryCache.clear_namespace (method)">clear_namespace</a></span>(<span class='id identifier rubyid_collection'><a href="#collection-instance_method" title="Mongo::BulkWrite#collection (method)">collection</a></span>.<span class='id identifier rubyid_namespace'>namespace</span>)

  <span class='id identifier rubyid_spec'>spec</span> <span class='op'>=</span> <span class='id identifier rubyid_base_spec'><a href="#base_spec-instance_method" title="Mongo::BulkWrite#base_spec (method)">base_spec</a></span>(<span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>).<span class='id identifier rubyid_merge'>merge</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_updates'>updates</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_txn_num'>txn_num</span>)
  <span class='const'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="Operation/Update.html" title="Mongo::Operation::Update (class)">Update</a></span>.<span class='id identifier rubyid_new'><a href="Operation/Specifiable.html#initialize-instance_method" title="Mongo::Operation::Specifiable#initialize (method)">new</a></span>(<span class='id identifier rubyid_spec'>spec</span>).<span class='id identifier rubyid_bulk_execute'>bulk_execute</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_array_filters!-instance_method">
  <h3 class='signature priv'>
    #<strong>validate_array_filters!</strong>(connection)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L306-L310'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='306' data-end='310'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 306</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_array_filters!'>validate_array_filters!</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_op_combiner'><a href="#op_combiner-instance_method" title="Mongo::BulkWrite#op_combiner (method)">op_combiner</a></span>.<span class='id identifier rubyid_has_array_filters?'>has_array_filters?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_array_filters_enabled?'>array_filters_enabled?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/UnsupportedArrayFilters.html" title="Mongo::Error::UnsupportedArrayFilters (class)">UnsupportedArrayFilters</a></span>.<span class='id identifier rubyid_new'><a href="Error/UnsupportedArrayFilters.html#new-class_method" title="Mongo::Error::UnsupportedArrayFilters.new (method)">new</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_collation!-instance_method">
  <h3 class='signature priv'>
    #<strong>validate_collation!</strong>(connection)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L300-L304'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='300' data-end='304'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 300</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_collation!'>validate_collation!</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_op_combiner'><a href="#op_combiner-instance_method" title="Mongo::BulkWrite#op_combiner (method)">op_combiner</a></span>.<span class='id identifier rubyid_has_collation?'>has_collation?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_collation_enabled?'>collation_enabled?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/UnsupportedCollation.html" title="Mongo::Error::UnsupportedCollation (class)">UnsupportedCollation</a></span>.<span class='id identifier rubyid_new'><a href="Error/UnsupportedCollation.html#new-class_method" title="Mongo::Error::UnsupportedCollation.new (method)">new</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_hint!-instance_method">
  <h3 class='signature priv'>
    #<strong>validate_hint!</strong>(connection)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L312-L320'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='312' data-end='320'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 312</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_hint!'>validate_hint!</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_op_combiner'><a href="#op_combiner-instance_method" title="Mongo::BulkWrite#op_combiner (method)">op_combiner</a></span>.<span class='id identifier rubyid_has_hint?'>has_hint?</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_can_hint?'><a href="#can_hint%3F-instance_method" title="Mongo::BulkWrite#can_hint? (method)">can_hint?</a></span>(<span class='id identifier rubyid_connection'>connection</span>) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_write_concern'><a href="#write_concern-instance_method" title="Mongo::BulkWrite#write_concern (method)">write_concern</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_write_concern'><a href="#write_concern-instance_method" title="Mongo::BulkWrite#write_concern (method)">write_concern</a></span>.<span class='id identifier rubyid_acknowledged?'>acknowledged?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/UnsupportedOption.html" title="Mongo::Error::UnsupportedOption (class)">UnsupportedOption</a></span>.<span class='id identifier rubyid_hint_error'><a href="Error/UnsupportedOption.html#hint_error-class_method" title="Mongo::Error::UnsupportedOption.hint_error (method)">hint_error</a></span>(<span class='label'>unacknowledged_write:</span> <span class='kw'>true</span>)
    <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_update_delete_option_validation_enabled?'>update_delete_option_validation_enabled?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/UnsupportedOption.html" title="Mongo::Error::UnsupportedOption (class)">UnsupportedOption</a></span>.<span class='id identifier rubyid_hint_error'><a href="Error/UnsupportedOption.html#hint_error-class_method" title="Mongo::Error::UnsupportedOption.hint_error (method)">hint_error</a></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_requests!-instance_method">
  <h3 class='signature priv'>
    #<strong>validate_requests!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Perform the request document validation required by driver specifications. This method validates the first key of each update request document to be an operator (i.e. start with $) and the first key of each replacement document to not be an operator (i.e. not start with $). The request document may be invalid without this method flagging it as such (for example an update or replacement document containing some keys which are operators and some which are not), in which case the driver expects the server to fail the operation with an error.</p>

<p>Raise an ArgumentError if requests is empty.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/InvalidUpdateDocument.html" title="Mongo::Error::InvalidUpdateDocument (class)">Error::InvalidUpdateDocument</a>, <a href="Error/InvalidReplacementDocument.html" title="Mongo::Error::InvalidReplacementDocument (class)">Error::InvalidReplacementDocument</a>, <code>ArgumentError</code>)</span>
&mdash;    <div class='inline'>
<p>if the document is invalid.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L366-L398'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='366' data-end='398'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 366</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_requests!'>validate_requests!</span>
  <span class='id identifier rubyid_requests_empty'>requests_empty</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='ivar'>@requests</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_req'>req</span><span class='op'>|</span>
    <span class='id identifier rubyid_requests_empty'>requests_empty</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='id identifier rubyid_req'>req</span>.<span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_first'>first</span>
      <span class='kw'>if</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_update_one'><a href="#update_one-instance_method" title="Mongo::BulkWrite#update_one (method)">update_one</a></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update_many'><a href="#update_many-instance_method" title="Mongo::BulkWrite#update_many (method)">update_many</a></span>].<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_op'>op</span>)
        <span class='kw'>if</span> <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_maybe_first'><a href="#maybe_first-instance_method" title="Mongo::BulkWrite#maybe_first (method)">maybe_first</a></span>(<span class='id identifier rubyid_req'>req</span>.<span class='id identifier rubyid_dig'>dig</span>(<span class='id identifier rubyid_op'>op</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update'>update</span>))
          <span class='kw'>if</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_doc'>doc</span>.<span class='id identifier rubyid_keys'>keys</span><span class='op'>&amp;.</span><span class='id identifier rubyid_first'>first</span>
            <span class='kw'>unless</span> <span class='id identifier rubyid_key'>key</span>.<span class='id identifier rubyid_to_s'>to_s</span>.<span class='id identifier rubyid_start_with?'>start_with?</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$</span><span class='tstring_end'>&quot;</span></span>)
              <span class='kw'>if</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span>.<span class='id identifier rubyid_validate_update_replace'>validate_update_replace</span>
                <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidUpdateDocument.html" title="Mongo::Error::InvalidUpdateDocument (class)">InvalidUpdateDocument</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidUpdateDocument.html#new-class_method" title="Mongo::Error::InvalidUpdateDocument.new (method)">new</a></span>(<span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span>)
              <span class='kw'>else</span>
                <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidUpdateDocument.html" title="Mongo::Error::InvalidUpdateDocument (class)">InvalidUpdateDocument</a></span>.<span class='id identifier rubyid_warn'><a href="Error/InvalidUpdateDocument.html#warn-class_method" title="Mongo::Error::InvalidUpdateDocument.warn (method)">warn</a></span>(<span class='const'><a href="Logger.html" title="Mongo::Logger (class)">Logger</a></span>.<span class='id identifier rubyid_logger'><a href="Logger.html#logger-class_method" title="Mongo::Logger.logger (method)">logger</a></span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span>)
              <span class='kw'>end</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_op'>op</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_replace_one'><a href="#replace_one-instance_method" title="Mongo::BulkWrite#replace_one (method)">replace_one</a></span>
        <span class='kw'>if</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_req'>req</span>.<span class='id identifier rubyid_dig'>dig</span>(<span class='id identifier rubyid_op'>op</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_replacement'>replacement</span>)<span class='op'>&amp;.</span><span class='id identifier rubyid_keys'>keys</span><span class='op'>&amp;.</span><span class='id identifier rubyid_first'>first</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_key'>key</span>.<span class='id identifier rubyid_to_s'>to_s</span>.<span class='id identifier rubyid_start_with?'>start_with?</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$</span><span class='tstring_end'>&quot;</span></span>)
            <span class='kw'>if</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span>.<span class='id identifier rubyid_validate_update_replace'>validate_update_replace</span>
              <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidReplacementDocument.html" title="Mongo::Error::InvalidReplacementDocument (class)">InvalidReplacementDocument</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidReplacementDocument.html#new-class_method" title="Mongo::Error::InvalidReplacementDocument.new (method)">new</a></span>(<span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span>)
            <span class='kw'>else</span>
              <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidReplacementDocument.html" title="Mongo::Error::InvalidReplacementDocument (class)">InvalidReplacementDocument</a></span>.<span class='id identifier rubyid_warn'><a href="Error/InvalidReplacementDocument.html#warn-class_method" title="Mongo::Error::InvalidReplacementDocument.warn (method)">warn</a></span>(<span class='const'><a href="Logger.html" title="Mongo::Logger (class)">Logger</a></span>.<span class='id identifier rubyid_logger'><a href="Logger.html#logger-class_method" title="Mongo::Logger.logger (method)">logger</a></span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span>)
            <span class='kw'>end</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Bulk write requests cannot be empty</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_requests_empty'>requests_empty</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="write_concern-instance_method">
  <h3 class='signature nodoc'>
    #<strong>write_concern</strong>(session = nil)  &#x21d2; <a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get the write concern for the bulk write.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Get the write concern.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_bulk_write'>bulk_write</span>.<span class='id identifier rubyid_write_concern'>write_concern</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a>)</span>
&mdash;    <div class='inline'>
<p>The write concern.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.1.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/bulk_write.rb#L161-L165'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='161' data-end='165'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/bulk_write.rb', line 161</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_write_concern'>write_concern</span>(<span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='ivar'>@write_concern</span> <span class='op'>||=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::BulkWrite#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>] <span class='op'>?</span>
    <span class='const'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span>.<span class='id identifier rubyid_get'><a href="WriteConcern.html#get-instance_method" title="Mongo::WriteConcern#get (method)">get</a></span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::BulkWrite#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>]) <span class='op'>:</span>
    <span class='id identifier rubyid_collection'><a href="#collection-instance_method" title="Mongo::BulkWrite#collection (method)">collection</a></span>.<span class='id identifier rubyid_write_concern_with_session'>write_concern_with_session</span>(<span class='id identifier rubyid_session'>session</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>