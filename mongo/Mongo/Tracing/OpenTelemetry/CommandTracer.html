<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Tracing::OpenTelemetry::CommandTracer &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Tracing::OpenTelemetry::CommandTracer",
    relpath = '../../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../../'>Mongo master</a> &raquo; 
      <a href='../../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../../Tracing.html" title="Mongo::Tracing (module)">Tracing</a> &raquo; 
        <a href="../OpenTelemetry.html" title="Mongo::Tracing::OpenTelemetry (module)">OpenTelemetry</a> &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>CommandTracer&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Tracing::OpenTelemetry::CommandTracer  <span class='private note title'>Private</span>
</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This class is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L23'>lib/mongo/tracing/open_telemetry/command_tracer.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p><code>CommandTracer</code> is responsible for tracing MongoDB server commands using <a href="../OpenTelemetry.html" title="Mongo::Tracing::OpenTelemetry (module)"><code>::Mongo::Tracing::OpenTelemetry</code></a>.</p>

  </div>
</div>
<div class='tags'>
  
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full nodoc'>
  <li>
    <span id='ELLIPSIS-constant' class='summary_signature nodoc'>ELLIPSIS =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>Ellipsis for truncated query text.</p>

  </div>
</div>
<div class='tags'>
  
</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L297-L297'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 297</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>...</span><span class='tstring_end'>&#39;</span></span></pre>
  </li>
  <li>
    <span id='EXCLUDED_KEYS-constant' class='summary_signature nodoc'>EXCLUDED_KEYS =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>Keys to exclude from query text capture.</p>

  </div>
</div>
<div class='tags'>
  
</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L294-L294'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 294</a>    <pre class='code ruby'><span class='qwords'><span class='qwords_beg'>%w[</span><span class='tstring_content'>lsid</span><span class='words_sep'> </span><span class='tstring_content'>$db</span><span class='words_sep'> </span><span class='tstring_content'>$clusterTime</span><span class='words_sep'> </span><span class='tstring_content'>signature</span><span class='tstring_end'>]</span></span>.<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(otel_tracer, parent_tracer, query_text_max_length: 0)  &#x21d2; CommandTracer </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Initializes a new <code>CommandTracer</code>.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature ro priv nodoc'>
      <a href="#query_text%3F-instance_method" title="#query_text? (instance method)">#<strong>query_text?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Checks if query text capture is enabled.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#start_span-instance_method" title="#start_span (instance method)">#<strong>start_span</strong>(message, operation_context, connection)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Starts a span for a MongoDB command.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#trace_command-instance_method" title="#trace_command (instance method)">#<strong>trace_command</strong>(message, _operation_context, connection) { ... } &#x21d2; Object </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Trace a MongoDB command.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#base_attributes-instance_method" title="#base_attributes (instance method)">#<strong>base_attributes</strong>(message)  &#x21d2; Hash </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns base database and command attributes.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#collection_name-instance_method" title="#collection_name (instance method)">#<strong>collection_name</strong>(message)  &#x21d2; String | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Extracts the collection name from the command message.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#command_name-instance_method" title="#command_name (instance method)">#<strong>command_name</strong>(message)  &#x21d2; String </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Extracts the command name from the message.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#connection_attributes-instance_method" title="#connection_attributes (instance method)">#<strong>connection_attributes</strong>(connection)  &#x21d2; Hash </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns connection-related attributes.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#create_command_span-instance_method" title="#create_command_span (instance method)">#<strong>create_command_span</strong>(message, connection)  &#x21d2; OpenTelemetry::Trace::Span </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Creates a span for a command.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#cursor_id-instance_method" title="#cursor_id (instance method)">#<strong>cursor_id</strong>(message)  &#x21d2; Integer | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Extracts the cursor ID from getMore commands.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#database-instance_method" title="#database (instance method)">#<strong>database</strong>(message)  &#x21d2; String </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Extracts the database name from the message.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#handle_command_exception-instance_method" title="#handle_command_exception (instance method)">#<strong>handle_command_exception</strong>(span, exception)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Handles exceptions that occur during command execution.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#lsid-instance_method" title="#lsid (instance method)">#<strong>lsid</strong>(message)  &#x21d2; BSON::Binary | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Extracts the logical session ID from the command.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#maybe_trace_error-instance_method" title="#maybe_trace_error (instance method)">#<strong>maybe_trace_error</strong>(result, span)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Records error status code if the command failed.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#process_command_result-instance_method" title="#process_command_result (instance method)">#<strong>process_command_result</strong>(result, cursor_id, context, span)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Processes the command result and updates span attributes.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#process_cursor_context-instance_method" title="#process_cursor_context (instance method)">#<strong>process_cursor_context</strong>(result, _cursor_id, _context, span)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Processes cursor context from the command result.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#query_summary-instance_method" title="#query_summary (instance method)">#<strong>query_summary</strong>(message)  &#x21d2; String </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Generates a summary string for the query.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro priv nodoc'>
      <a href="#query_text-instance_method" title="#query_text (instance method)">#<strong>query_text</strong>(message)  &#x21d2; String | nil </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Extracts and formats the query text from the command.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#session_attributes-instance_method" title="#session_attributes (instance method)">#<strong>session_attributes</strong>(message)  &#x21d2; Hash </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns session and transaction attributes.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#span_attributes-instance_method" title="#span_attributes (instance method)">#<strong>span_attributes</strong>(message, connection)  &#x21d2; Hash </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Builds span attributes for the command.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#txn_number-instance_method" title="#txn_number (instance method)">#<strong>txn_number</strong>(message)  &#x21d2; Integer | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Extracts the transaction number from the command.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="query_text?-instance_method">
  <h3 class='signature ro priv  nodoc first'>
    #<strong>query_text?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Checks if query text capture is enabled.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Boolean</code>)</span>
&mdash;    <div class='inline'>
<p>true if query text should be captured.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L254-L256'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='254' data-end='256'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 254</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_query_text?'>query_text?</span>
  <span class='ivar'>@query_text_max_length</span>.<span class='id identifier rubyid_positive?'>positive?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="base_attributes-instance_method">
  <h3 class='signature priv  nodoc first'>
    #<strong>base_attributes</strong>(message)  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns base database and command attributes.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>base span attributes.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L136-L145'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='136' data-end='145'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 136</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_base_attributes'>base_attributes</span>(<span class='id identifier rubyid_message'>message</span>)
  {
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.system</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mongodb</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.namespace</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_database'><a href="#database-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#database (method)">database</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.collection.name</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_collection_name'><a href="#collection_name-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#collection_name (method)">collection_name</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.command.name</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_command_name'><a href="#command_name-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#command_name (method)">command_name</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.query.summary</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_query_summary'><a href="#query_summary-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#query_summary (method)">query_summary</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.query.text</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_query_text'><a href="#query_text-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#query_text (method)">query_text</a></span>(<span class='id identifier rubyid_message'>message</span>)
  }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="collection_name-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>collection_name</strong>(message)  &#x21d2; <code>String</code> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Extracts the collection name from the command message.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>the collection name, or nil if not applicable.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L220-L231'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='220' data-end='231'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 220</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_collection_name'>collection_name</span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='kw'>case</span> <span class='id identifier rubyid_command_name'><a href="#command_name-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#command_name (method)">command_name</a></span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>getMore</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_first'>first</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>collection</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>listCollections</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>listDatabases</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>commitTransaction</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>abortTransaction</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>nil</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_first'>first</span>
    <span class='comment'># Return nil if the value is not a string (e.g., for admin commands that have numeric values)
</span>    <span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'>String</span>) <span class='op'>?</span> <span class='id identifier rubyid_value'>value</span> <span class='op'>:</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="command_name-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>command_name</strong>(message)  &#x21d2; <code>String</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Extracts the command name from the message.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>the command name.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L238-L240'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='238' data-end='240'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 238</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_command_name'>command_name</span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_to_s'>to_s</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connection_attributes-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>connection_attributes</strong>(connection)  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns connection-related attributes.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<a href="../../Server/Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>the connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>connection span attributes.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L152-L160'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='152' data-end='160'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 152</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connection_attributes'>connection_attributes</span>(<span class='id identifier rubyid_connection'>connection</span>)
  {
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>server.port</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_port'>port</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>server.address</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_address'>address</span>.<span class='id identifier rubyid_host'>host</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>network.transport</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_transport'>transport</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.mongodb.server_connection_id</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_server_connection_id'>server_connection_id</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.mongodb.driver_connection_id</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_id'>id</span>
  }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="create_command_span-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>create_command_span</strong>(message, connection)  &#x21d2; <code>OpenTelemetry::Trace::Span</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Creates a span for a command.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<a href="../../Server/Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>the connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>OpenTelemetry::Trace::Span</code>)</span>
&mdash;    <div class='inline'>
<p>the created span.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L85-L91'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='85' data-end='91'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 85</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_create_command_span'>create_command_span</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='ivar'>@otel_tracer</span>.<span class='id identifier rubyid_start_span'><a href="#start_span-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#start_span (method)">start_span</a></span>(
    <span class='id identifier rubyid_command_name'><a href="#command_name-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#command_name (method)">command_name</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='comma'>,</span>
    <span class='label'>attributes:</span> <span class='id identifier rubyid_span_attributes'><a href="#span_attributes-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#span_attributes (method)">span_attributes</a></span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)<span class='comma'>,</span>
    <span class='label'>kind:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_client'>client</span>
  )
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cursor_id-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>cursor_id</strong>(message)  &#x21d2; <code>Integer</code> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Extracts the cursor ID from getMore commands.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>the cursor ID, or nil if not a getMore command.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L263-L267'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='263' data-end='267'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 263</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cursor_id'>cursor_id</span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_command_name'><a href="#command_name-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#command_name (method)">command_name</a></span>(<span class='id identifier rubyid_message'>message</span>) <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>getMore</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_first'>first</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>getMore</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="database-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>database</strong>(message)  &#x21d2; <code>String</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Extracts the database name from the message.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>the database name.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L247-L249'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='247' data-end='249'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 247</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_database'>database</span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_first'>first</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$db</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_to_s'>to_s</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handle_command_exception-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>handle_command_exception</strong>(span, exception)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Handles exceptions that occur during command execution.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>span</span>
    <span class='type'>(<code>OpenTelemetry::Trace::Span</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>the span.</p>
</div>
  </li>
  <li>
    <span class='name'>exception</span>
    <span class='type'>(<code>Exception</code>)</span>
&mdash;    <div class='inline'>
<p>the exception that occurred.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L108-L116'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='108' data-end='116'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 108</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_command_exception'>handle_command_exception</span>(<span class='id identifier rubyid_span'>span</span><span class='comma'>,</span> <span class='id identifier rubyid_exception'>exception</span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_span'>span</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_exception'>exception</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span>)
    <span class='id identifier rubyid_span'>span</span>.<span class='id identifier rubyid_set_attribute'>set_attribute</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.response.status_code</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_exception'>exception</span>.<span class='id identifier rubyid_code'>code</span>.<span class='id identifier rubyid_to_s'>to_s</span>)
  <span class='kw'>end</span>
  <span class='id identifier rubyid_span'>span</span>.<span class='id identifier rubyid_record_exception'>record_exception</span>(<span class='id identifier rubyid_exception'>exception</span>)
  <span class='id identifier rubyid_span'>span</span>.<span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../OpenTelemetry.html" title="Mongo::Tracing::OpenTelemetry (module)">OpenTelemetry</a></span><span class='op'>::</span><span class='const'>Trace</span><span class='op'>::</span><span class='const'>Status</span>.<span class='id identifier rubyid_error'>error</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unhandled exception of type: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_exception'>exception</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="lsid-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>lsid</strong>(message)  &#x21d2; <code>BSON::Binary</code> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Extracts the logical session ID from the command.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>BSON::Binary</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>the session ID, or nil if not present.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L274-L279'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='274' data-end='279'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 274</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_lsid'>lsid</span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='id identifier rubyid_lsid_doc'>lsid_doc</span> <span class='op'>=</span> <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_first'>first</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>lsid</span><span class='tstring_end'>&#39;</span></span>]
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_lsid_doc'>lsid_doc</span>

  <span class='id identifier rubyid_lsid_doc'>lsid_doc</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>id</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_to_uuid'>to_uuid</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="maybe_trace_error-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>maybe_trace_error</strong>(result, span)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Records error status code if the command failed.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>result</span>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>the command result.</p>
</div>
  </li>
  <li>
    <span class='name'>span</span>
    <span class='type'>(<code>OpenTelemetry::Trace::Span</code>)</span>
&mdash;    <div class='inline'>
<p>the current span.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L191-L200'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='191' data-end='200'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 191</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_maybe_trace_error'>maybe_trace_error</span>(<span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_span'>span</span>)
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_successful?'>successful?</span>

  <span class='id identifier rubyid_span'>span</span>.<span class='id identifier rubyid_set_attribute'>set_attribute</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.response.status_code</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_error'>error</span>.<span class='id identifier rubyid_code'>code</span>.<span class='id identifier rubyid_to_s'>to_s</span>)
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_validate!'>validate!</span>
  <span class='kw'>rescue</span> <span class='const'><a href="../../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_span'>span</span>.<span class='id identifier rubyid_record_exception'>record_exception</span>(<span class='id identifier rubyid_e'>e</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="process_command_result-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>process_command_result</strong>(result, cursor_id, context, span)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Processes the command result and updates span attributes.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>result</span>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>the command result.</p>
</div>
  </li>
  <li>
    <span class='name'>cursor_id</span>
    <span class='type'>(<code>Integer</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>the cursor ID.</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<code>OpenTelemetry::Context</code>)</span>
&mdash;    <div class='inline'>
<p>the context.</p>
</div>
  </li>
  <li>
    <span class='name'>span</span>
    <span class='type'>(<code>OpenTelemetry::Trace::Span</code>)</span>
&mdash;    <div class='inline'>
<p>the current span.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L99-L102'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='99' data-end='102'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 99</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_process_command_result'>process_command_result</span>(<span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor_id'><a href="#cursor_id-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#cursor_id (method)">cursor_id</a></span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_span'>span</span>)
  <span class='id identifier rubyid_process_cursor_context'><a href="#process_cursor_context-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#process_cursor_context (method)">process_cursor_context</a></span>(<span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor_id'><a href="#cursor_id-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#cursor_id (method)">cursor_id</a></span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_span'>span</span>)
  <span class='id identifier rubyid_maybe_trace_error'><a href="#maybe_trace_error-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#maybe_trace_error (method)">maybe_trace_error</a></span>(<span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_span'>span</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="process_cursor_context-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>process_cursor_context</strong>(result, _cursor_id, _context, span)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Processes cursor context from the command result.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>result</span>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>the command result.</p>
</div>
  </li>
  <li>
    <span class='name'>_cursor_id</span>
    <span class='type'>(<code>Integer</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>the cursor ID (unused).</p>
</div>
  </li>
  <li>
    <span class='name'>_context</span>
    <span class='type'>(<code>OpenTelemetry::Context</code>)</span>
&mdash;    <div class='inline'>
<p>the context (unused).</p>
</div>
  </li>
  <li>
    <span class='name'>span</span>
    <span class='type'>(<code>OpenTelemetry::Trace::Span</code>)</span>
&mdash;    <div class='inline'>
<p>the current span.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L181-L185'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='181' data-end='185'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 181</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_process_cursor_context'>process_cursor_context</span>(<span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid__cursor_id'>_cursor_id</span><span class='comma'>,</span> <span class='id identifier rubyid__context'>_context</span><span class='comma'>,</span> <span class='id identifier rubyid_span'>span</span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_has_cursor_id?'>has_cursor_id?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_cursor_id'><a href="#cursor_id-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#cursor_id (method)">cursor_id</a></span>.<span class='id identifier rubyid_positive?'>positive?</span>

  <span class='id identifier rubyid_span'>span</span>.<span class='id identifier rubyid_set_attribute'>set_attribute</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.mongodb.cursor_id</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_cursor_id'><a href="#cursor_id-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#cursor_id (method)">cursor_id</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="query_summary-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>query_summary</strong>(message)  &#x21d2; <code>String</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Generates a summary string for the query.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>summary in format “command_name db.collection” or “command_name db”.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L207-L213'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='207' data-end='213'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 207</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_query_summary'>query_summary</span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='kw'>if</span> (<span class='id identifier rubyid_coll_name'>coll_name</span> <span class='op'>=</span> <span class='id identifier rubyid_collection_name'><a href="#collection_name-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#collection_name (method)">collection_name</a></span>(<span class='id identifier rubyid_message'>message</span>))
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_command_name'><a href="#command_name-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#command_name (method)">command_name</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_database'><a href="#database-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#database (method)">database</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_coll_name'>coll_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_command_name'><a href="#command_name-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#command_name (method)">command_name</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_database'><a href="#database-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#database (method)">database</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="query_text-instance_method">
  <h3 class='signature ro priv  nodoc'>
    #<strong>query_text</strong>(message)  &#x21d2; <code>String</code> | <code>nil</code>  <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Extracts and formats the query text from the command.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>JSON representation of the command, truncated if necessary, or nil if disabled.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L304-L316'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='304' data-end='316'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 304</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_query_text'>query_text</span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_query_text?'><a href="#query_text%3F-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#query_text? (method)">query_text?</a></span>

  <span class='id identifier rubyid_text'>text</span> <span class='op'>=</span> <span class='id identifier rubyid_message'>message</span>
         .<span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>command</span><span class='tstring_end'>&#39;</span></span>]
         .<span class='id identifier rubyid_reject'>reject</span> { <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='op'>|</span> <span class='const'><a href="#EXCLUDED_KEYS-constant" title="Mongo::Tracing::OpenTelemetry::CommandTracer::EXCLUDED_KEYS (constant)">EXCLUDED_KEYS</a></span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_key'>key</span>) }
         .<span class='id identifier rubyid_to_json'>to_json</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_text'>text</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='ivar'>@query_text_max_length</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_text'>text</span>[<span class='int'>0</span><span class='op'>...</span><span class='ivar'>@query_text_max_length</span>]<span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#ELLIPSIS-constant" title="Mongo::Tracing::OpenTelemetry::CommandTracer::ELLIPSIS (constant)">ELLIPSIS</a></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_text'>text</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="session_attributes-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>session_attributes</strong>(message)  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns session and transaction attributes.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>session span attributes.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L167-L173'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='167' data-end='173'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 167</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_session_attributes'>session_attributes</span>(<span class='id identifier rubyid_message'>message</span>)
  {
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.mongodb.cursor_id</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_cursor_id'><a href="#cursor_id-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#cursor_id (method)">cursor_id</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.mongodb.lsid</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_lsid'><a href="#lsid-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#lsid (method)">lsid</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db.mongodb.txn_number</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_txn_number'><a href="#txn_number-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#txn_number (method)">txn_number</a></span>(<span class='id identifier rubyid_message'>message</span>)
  }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="span_attributes-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>span_attributes</strong>(message, connection)  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Builds span attributes for the command.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<a href="../../Server/Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>the connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p><a href="../OpenTelemetry.html" title="Mongo::Tracing::OpenTelemetry (module)"><code>::Mongo::Tracing::OpenTelemetry</code></a> span attributes following MongoDB semantic conventions.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L124-L129'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='124' data-end='129'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 124</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_span_attributes'>span_attributes</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='id identifier rubyid_base_attributes'><a href="#base_attributes-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#base_attributes (method)">base_attributes</a></span>(<span class='id identifier rubyid_message'>message</span>)
    .<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_connection_attributes'><a href="#connection_attributes-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#connection_attributes (method)">connection_attributes</a></span>(<span class='id identifier rubyid_connection'>connection</span>))
    .<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_session_attributes'><a href="#session_attributes-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#session_attributes (method)">session_attributes</a></span>(<span class='id identifier rubyid_message'>message</span>))
    .<span class='id identifier rubyid_compact'>compact</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="start_span-instance_method">
  <h3 class='signature nodoc'>
    #<strong>start_span</strong>(message, operation_context, connection)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Starts a span for a MongoDB command.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
  <li>
    <span class='name'>operation_context</span>
    <span class='type'>(<a href="../../Operation/Context.html" title="Mongo::Operation::Context (class)">Mongo::Operation::Context</a>)</span>
&mdash;    <div class='inline'>
<p>the operation context.</p>
</div>
  </li>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<a href="../../Server/Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>the connection.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L42-L42'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='42' data-end='42'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 42</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_start_span'>start_span</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_operation_context'>operation_context</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)<span class='semicolon'>;</span> <span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="trace_command-instance_method">
  <h3 class='signature nodoc'>
    #<strong>trace_command</strong>(message, _operation_context, connection) { ... } &#x21d2; <code>Object</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Trace a MongoDB command.</p>

<p>Creates an <a href="../OpenTelemetry.html" title="Mongo::Tracing::OpenTelemetry (module)"><code>::Mongo::Tracing::OpenTelemetry</code></a> span for the command, capturing attributes such as command name, database name, collection name, server address, connection IDs, and optionally query text. The span is automatically nested under the current operation span and is finished when the command completes or fails.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message to trace.</p>
</div>
  </li>
  <li>
    <span class='name'>_operation_context</span>
    <span class='type'>(<a href="../../Operation/Context.html" title="Mongo::Operation::Context (class)">Mongo::Operation::Context</a>)</span>
&mdash;    <div class='inline'>
<p>the context of the operation.</p>
</div>
  </li>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<a href="../../Server/Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>the connection used to send the command.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Yields:</p>
<ul class='yield'>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p>the block representing the command to be traced.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>the result of the command.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L59-L74'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='59' data-end='74'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 59</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_trace_command'>trace_command</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid__operation_context'>_operation_context</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='comment'># Commands should always be nested under their operation span, not directly under
</span>  <span class='comment'># the transaction span. Don&#39;t pass with_parent to use automatic parent resolution
</span>  <span class='comment'># from the currently active span (the operation span).
</span>  <span class='id identifier rubyid_span'>span</span> <span class='op'>=</span> <span class='id identifier rubyid_create_command_span'><a href="#create_command_span-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#create_command_span (method)">create_command_span</a></span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='op'>::</span><span class='const'><a href="../OpenTelemetry.html" title="Mongo::Tracing::OpenTelemetry (module)">OpenTelemetry</a></span><span class='op'>::</span><span class='const'>Trace</span>.<span class='id identifier rubyid_with_span'>with_span</span>(<span class='id identifier rubyid_span'>span</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_s'>s</span><span class='comma'>,</span> <span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='kw'>yield</span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_result'>result</span><span class='op'>|</span>
      <span class='id identifier rubyid_process_command_result'><a href="#process_command_result-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#process_command_result (method)">process_command_result</a></span>(<span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_cursor_id'><a href="#cursor_id-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#cursor_id (method)">cursor_id</a></span>(<span class='id identifier rubyid_message'>message</span>)<span class='comma'>,</span> <span class='id identifier rubyid_c'>c</span><span class='comma'>,</span> <span class='id identifier rubyid_s'>s</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_handle_command_exception'><a href="#handle_command_exception-instance_method" title="Mongo::Tracing::OpenTelemetry::CommandTracer#handle_command_exception (method)">handle_command_exception</a></span>(<span class='id identifier rubyid_span'>span</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span>)
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_span'>span</span><span class='op'>&amp;.</span><span class='id identifier rubyid_finish'>finish</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="txn_number-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>txn_number</strong>(message)  &#x21d2; <code>Integer</code> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Extracts the transaction number from the command.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>message</span>
    <span class='type'>(<a href="../../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Mongo::Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>the command message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>the transaction number, or nil if not present.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/tracing/open_telemetry/command_tracer.rb#L286-L291'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='286' data-end='291'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/tracing/open_telemetry/command_tracer.rb', line 286</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_txn_number'>txn_number</span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>=</span> <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_first'>first</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>txnNumber</span><span class='tstring_end'>&#39;</span></span>]
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txn_num'>txn_num</span>

  <span class='id identifier rubyid_txn_num'>txn_num</span>.<span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>