<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Auth::Aws::CredentialsRetriever &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Auth::Aws::CredentialsRetriever",
    relpath = '../../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../../'>Mongo master</a> &raquo; 
      <a href='../../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../../Auth.html" title="Mongo::Auth (module)">Auth</a> &raquo; 
        <a href="../Aws.html" title="Mongo::Auth::Aws (class)">Aws</a> &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>CredentialsRetriever&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Auth::Aws::CredentialsRetriever  <span class='private note title'>Private</span>
</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This class is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L52'>lib/mongo/auth/aws/credentials_retriever.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Retrieves AWS credentials from a variety of sources.</p>

<p>This class provides for AWS credentials retrieval from:</p>
<ul><li>
<p>the passed user (which receives the credentials passed to the client via URI options and Ruby options)</p>
</li><li>
<p>AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_SESSION_TOKEN environment variables (commonly used by AWS SDKs and various tools, as well as AWS Lambda)</p>
</li><li>
<p>AssumeRoleWithWebIdentity API call</p>
</li><li>
<p>EC2 metadata endpoint</p>
</li><li>
<p>ECS metadata endpoint</p>
</li></ul>

<p>The sources listed above are consulted in the order specified. The first source that contains any of the three credential components (access key id, secret access key or session token) is used. The credential components must form a valid set if any of the components is specified; meaning, access key id and secret access key must always be provided together, and if a session token is provided the key id and secret key must also be provided. If a source provides partial credentials, credential retrieval fails with an exception.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full nodoc'>
  <li>
    <span id='METADATA_TIMEOUT-constant' class='summary_signature nodoc'>METADATA_TIMEOUT =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p><a href="../../Timeout.html" title="Mongo::Timeout (module)"><code>::Mongo::Timeout</code></a> for metadata operations, in seconds.</p>

<p>The auth spec suggests a 10 second timeout but this seems excessively long given that the endpoint is essentially local.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L57-L57'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 57</a>    <pre class='code ruby'><span class='int'>5</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(user = nil, credentials_cache: CredentialsCache.instance)  &#x21d2; CredentialsRetriever </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#user-instance_method" title="#user (instance method)">#<strong>user</strong>  &#x21d2; Auth::User | nil </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#credentials-instance_method" title="#credentials (instance method)">#<strong>credentials</strong>(timeout_holder = nil)  &#x21d2; Auth::Aws::Credentials </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Retrieves a valid set of credentials, if possible, or raises <a href="../InvalidConfiguration.html" title="Mongo::Auth::InvalidConfiguration (class)"><code>::Mongo::Auth::InvalidConfiguration</code></a>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#credentials_from_environment-instance_method" title="#credentials_from_environment (instance method)">#<strong>credentials_from_environment</strong>  &#x21d2; Auth::Aws::Credentials | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns credentials from environment variables.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#credentials_from_user-instance_method" title="#credentials_from_user (instance method)">#<strong>credentials_from_user</strong>(user)  &#x21d2; Auth::Aws::Credentials | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns credentials from the user object.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#credentials_from_web_identity_response-instance_method" title="#credentials_from_web_identity_response (instance method)">#<strong>credentials_from_web_identity_response</strong>(response)  &#x21d2; Auth::Aws::Credentials | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Extracts credentials from AssumeRoleWithWebIdentity response.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#credentials_valid%3F-instance_method" title="#credentials_valid? (instance method)">#<strong>credentials_valid?</strong>(credentials, source)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Checks whether the credentials provided are valid.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#ec2_metadata_credentials-instance_method" title="#ec2_metadata_credentials (instance method)">#<strong>ec2_metadata_credentials</strong>(timeout_holder = nil)  &#x21d2; Auth::Aws::Credentials | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns credentials from the EC2 metadata endpoint.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#ecs_metadata_credentials-instance_method" title="#ecs_metadata_credentials (instance method)">#<strong>ecs_metadata_credentials</strong>(timeout_holder = nil)  &#x21d2; Auth::Aws::Credentials | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns credentials from the ECS metadata endpoint.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#http_get-instance_method" title="#http_get (instance method)">#<strong>http_get</strong>(http, uri, metadata_token)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#obtain_credentials_from_endpoints-instance_method" title="#obtain_credentials_from_endpoints (instance method)">#<strong>obtain_credentials_from_endpoints</strong>(timeout_holder = nil)  &#x21d2; Auth::Aws::Credentials | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns credentials from the AWS metadata endpoints.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#prepare_web_identity_inputs-instance_method" title="#prepare_web_identity_inputs (instance method)">#<strong>prepare_web_identity_inputs</strong>  &#x21d2; Array&lt;String | nil, String | nil, String | nil&gt; </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns inputs for the AssumeRoleWithWebIdentity AWS API call.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#request_web_identity_credentials-instance_method" title="#request_web_identity_credentials (instance method)">#<strong>request_web_identity_credentials</strong>(token, role_arn, role_session_name, timeout_holder)  &#x21d2; Net::HTTPResponse | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Calls AssumeRoleWithWebIdentity to obtain credentials for the given web identity token.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#web_identity_credentials-instance_method" title="#web_identity_credentials (instance method)">#<strong>web_identity_credentials</strong>(timeout_holder = nil)  &#x21d2; Auth::Aws::Credentials | nil </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns credentials associated with web identity token that is stored in a file.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#with_timeout-instance_method" title="#with_timeout (instance method)">#<strong>with_timeout</strong>(timeout_holder)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Execute the given block considering the timeout defined on the context, or the default timeout value.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="user-instance_method">
  <h3 class='signature ro  nodoc first'>
    #<strong>user</strong>  &#x21d2; <a href="../User.html" title="Mongo::Auth::User (class)">Auth::User</a> | <code>nil</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../User.html" title="Mongo::Auth::User (class)">Auth::User</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The user object, if one was provided.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L67-L67'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='67' data-end='67'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 67</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="credentials-instance_method">
  <h3 class='signature nodoc first'>
    #<strong>credentials</strong>(timeout_holder = nil)  &#x21d2; <a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Retrieves a valid set of credentials, if possible, or raises <a href="../InvalidConfiguration.html" title="Mongo::Auth::InvalidConfiguration (class)"><code>::Mongo::Auth::InvalidConfiguration</code></a>.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>timeout_holder</span>
    <span class='type'>(<a href="../../CsotTimeoutHolder.html" title="Mongo::CsotTimeoutHolder (class)">CsotTimeoutHolder</a> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>CSOT timeout, if any.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a>)</span>
&mdash;    <div class='inline'>
<p>A valid set of credentials.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p><a href="../InvalidConfiguration.html" title="Mongo::Auth::InvalidConfiguration (class)"><code>::Mongo::Auth::InvalidConfiguration</code></a> if a source contains an invalid set of credentials.</p>
</div>
  </li>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p>Auth::Aws::CredentialsNotFound if credentials could not be retrieved from any source.</p>
</div>
  </li>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p><a href="../../Error/TimeoutError.html" title="Mongo::Error::TimeoutError (class)"><code>::Mongo::Error::TimeoutError</code></a> if credentials cannot be retrieved within the timeout defined on the operation context.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L82-L93'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='82' data-end='93'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 82</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_credentials'>credentials</span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_credentials'>credentials</span> <span class='op'>=</span> <span class='id identifier rubyid_credentials_from_user'><a href="#credentials_from_user-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials_from_user (method)">credentials_from_user</a></span>(<span class='id identifier rubyid_user'><a href="#user-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#user (method)">user</a></span>)
  <span class='kw'>return</span> <span class='id identifier rubyid_credentials'>credentials</span> <span class='kw'>unless</span> <span class='id identifier rubyid_credentials'>credentials</span>.<span class='id identifier rubyid_nil?'>nil?</span>

  <span class='id identifier rubyid_credentials'>credentials</span> <span class='op'>=</span> <span class='id identifier rubyid_credentials_from_environment'><a href="#credentials_from_environment-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials_from_environment (method)">credentials_from_environment</a></span>
  <span class='kw'>return</span> <span class='id identifier rubyid_credentials'>credentials</span> <span class='kw'>unless</span> <span class='id identifier rubyid_credentials'>credentials</span>.<span class='id identifier rubyid_nil?'>nil?</span>

  <span class='id identifier rubyid_credentials'>credentials</span> <span class='op'>=</span> <span class='ivar'>@credentials_cache</span>.<span class='id identifier rubyid_fetch'>fetch</span> { <span class='id identifier rubyid_obtain_credentials_from_endpoints'><a href="#obtain_credentials_from_endpoints-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#obtain_credentials_from_endpoints (method)">obtain_credentials_from_endpoints</a></span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span>) }
  <span class='kw'>return</span> <span class='id identifier rubyid_credentials'>credentials</span> <span class='kw'>unless</span> <span class='id identifier rubyid_credentials'>credentials</span>.<span class='id identifier rubyid_nil?'>nil?</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../../Auth.html" title="Mongo::Auth (module)">Auth</a></span><span class='op'>::</span><span class='const'><a href="../Aws.html" title="Mongo::Auth::Aws (class)">Aws</a></span><span class='op'>::</span><span class='const'><a href="CredentialsNotFound.html" title="Mongo::Auth::Aws::CredentialsNotFound (class)">CredentialsNotFound</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="credentials_from_environment-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>credentials_from_environment</strong>  &#x21d2; <a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns credentials from environment variables.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>A set of credentials, or nil if retrieval failed or the obtained credentials are invalid.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p><a href="../InvalidConfiguration.html" title="Mongo::Auth::InvalidConfiguration (class)"><code>::Mongo::Auth::InvalidConfiguration</code></a> if a source contains an invalid set of credentials.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L123-L130'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='123' data-end='130'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 123</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_credentials_from_environment'>credentials_from_environment</span>
  <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span> <span class='op'>=</span> <span class='const'><a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Credentials</a></span>.<span class='id identifier rubyid_new'><a href="../Base.html#new-class_method" title="Mongo::Auth::Base.new (method)">new</a></span>(
    <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AWS_ACCESS_KEY_ID</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AWS_SECRET_ACCESS_KEY</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AWS_SESSION_TOKEN</span><span class='tstring_end'>&#39;</span></span>]
  )
  <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_credentials_valid?'><a href="#credentials_valid%3F-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials_valid? (method)">credentials_valid?</a></span>(<span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>environment variables</span><span class='tstring_end'>&#39;</span></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="credentials_from_user-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>credentials_from_user</strong>(user)  &#x21d2; <a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns credentials from the user object.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>user</span>
    <span class='type'>(<a href="../User.html" title="Mongo::Auth::User (class)">Auth::User</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The user object, if one was provided.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>A set of credentials, or nil</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p><a href="../InvalidConfiguration.html" title="Mongo::Auth::InvalidConfiguration (class)"><code>::Mongo::Auth::InvalidConfiguration</code></a> if a source contains an invalid set of credentials.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L105-L114'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='105' data-end='114'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 105</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_credentials_from_user'>credentials_from_user</span>(<span class='id identifier rubyid_user'><a href="#user-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#user (method)">user</a></span>)
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>unless</span> <span class='id identifier rubyid_user'><a href="#user-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#user (method)">user</a></span>

  <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span> <span class='op'>=</span> <span class='const'><a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Credentials</a></span>.<span class='id identifier rubyid_new'><a href="../Base.html#new-class_method" title="Mongo::Auth::Base.new (method)">new</a></span>(
    <span class='id identifier rubyid_user'><a href="#user-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#user (method)">user</a></span>.<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
    <span class='id identifier rubyid_user'><a href="#user-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#user (method)">user</a></span>.<span class='id identifier rubyid_password'>password</span><span class='comma'>,</span>
    <span class='id identifier rubyid_user'><a href="#user-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#user (method)">user</a></span>.<span class='id identifier rubyid_auth_mech_properties'>auth_mech_properties</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>aws_session_token</span><span class='tstring_end'>&#39;</span></span>]
  )
  <span class='kw'>return</span> <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_credentials_valid?'><a href="#credentials_valid%3F-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials_valid? (method)">credentials_valid?</a></span>(<span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mongo::Client URI or Ruby options</span><span class='tstring_end'>&#39;</span></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="credentials_from_web_identity_response-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>credentials_from_web_identity_response</strong>(response)  &#x21d2; <a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Extracts credentials from AssumeRoleWithWebIdentity response.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>response</span>
    <span class='type'>(<code>Net::HTTPResponse</code>)</span>
&mdash;    <div class='inline'>
<p>AssumeRoleWithWebIdentity call response.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>A set of credentials, or nil if response parsing failed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L334-L348'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='334' data-end='348'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 334</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_credentials_from_web_identity_response'>credentials_from_web_identity_response</span>(<span class='id identifier rubyid_response'>response</span>)
  <span class='id identifier rubyid_payload'>payload</span> <span class='op'>=</span> <span class='const'>JSON</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_body'>body</span>).<span class='id identifier rubyid_dig'>dig</span>(
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AssumeRoleWithWebIdentityResponse</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AssumeRoleWithWebIdentityResult</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Credentials</span><span class='tstring_end'>&#39;</span></span>
  ) <span class='op'>||</span> {}
  <span class='const'><a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Credentials</a></span>.<span class='id identifier rubyid_new'><a href="../Base.html#new-class_method" title="Mongo::Auth::Base.new (method)">new</a></span>(
    <span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AccessKeyId</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SecretAccessKey</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SessionToken</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='const'>Time</span>.<span class='id identifier rubyid_at'>at</span>(<span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Expiration</span><span class='tstring_end'>&#39;</span></span>])
  )
<span class='kw'>rescue</span> <span class='const'>JSON</span><span class='op'>::</span><span class='const'>ParserError</span><span class='comma'>,</span> <span class='const'>TypeError</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="credentials_valid?-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>credentials_valid?</strong>(credentials, source)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Checks whether the credentials provided are valid.</p>

<p>Returns true if they are valid, false if they are empty, and raises <a href="../InvalidConfiguration.html" title="Mongo::Auth::InvalidConfiguration (class)"><code>::Mongo::Auth::InvalidConfiguration</code></a> if the credentials are incomplete (i.e. some of the components are missing).</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L361-L385'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='361' data-end='385'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 361</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_credentials_valid?'>credentials_valid?</span>(<span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span><span class='comma'>,</span> <span class='id identifier rubyid_source'>source</span>)
  <span class='kw'>unless</span> <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>.<span class='id identifier rubyid_access_key_id'>access_key_id</span> <span class='op'>||</span> <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>.<span class='id identifier rubyid_secret_access_key'>secret_access_key</span> <span class='op'>||</span>
    <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>.<span class='id identifier rubyid_session_token'>session_token</span>
  <span class='kw'>then</span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>.<span class='id identifier rubyid_access_key_id'>access_key_id</span> <span class='op'>||</span> <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>.<span class='id identifier rubyid_secret_access_key'>secret_access_key</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>.<span class='id identifier rubyid_access_key_id'>access_key_id</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>.<span class='id identifier rubyid_secret_access_key'>secret_access_key</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../../Auth.html" title="Mongo::Auth (module)">Auth</a></span><span class='op'>::</span><span class='const'><a href="../InvalidConfiguration.html" title="Mongo::Auth::InvalidConfiguration (class)">InvalidConfiguration</a></span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Access key ID is provided without secret access key (source: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_source'>source</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>.<span class='id identifier rubyid_secret_access_key'>secret_access_key</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>.<span class='id identifier rubyid_access_key_id'>access_key_id</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../../Auth.html" title="Mongo::Auth (module)">Auth</a></span><span class='op'>::</span><span class='const'><a href="../InvalidConfiguration.html" title="Mongo::Auth::InvalidConfiguration (class)">InvalidConfiguration</a></span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Secret access key is provided without access key ID (source: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_source'>source</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

  <span class='kw'>elsif</span> <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>.<span class='id identifier rubyid_session_token'>session_token</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../../Auth.html" title="Mongo::Auth (module)">Auth</a></span><span class='op'>::</span><span class='const'><a href="../InvalidConfiguration.html" title="Mongo::Auth::InvalidConfiguration (class)">InvalidConfiguration</a></span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Session token is provided without access key ID or secret access key (source: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_source'>source</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ec2_metadata_credentials-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>ec2_metadata_credentials</strong>(timeout_holder = nil)  &#x21d2; <a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns credentials from the EC2 metadata endpoint. The credentials could be empty, partial or invalid.</p>

<p>@ raise <a href="../../Error/TimeoutError.html" title="Mongo::Error::TimeoutError (class)"><code>::Mongo::Error::TimeoutError</code></a> if credentials cannot be retrieved within</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_timeout'>timeout</span>.</code></pre>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>timeout_holder</span>
    <span class='type'>(<a href="../../CsotTimeoutHolder.html" title="Mongo::CsotTimeoutHolder (class)">CsotTimeoutHolder</a>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>CSOT timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>A set of credentials, or nil if retrieval failed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L162-L203'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='162' data-end='203'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 162</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ec2_metadata_credentials'>ec2_metadata_credentials</span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_timeout_holder'>timeout_holder</span><span class='op'>&amp;.</span><span class='id identifier rubyid_check_timeout!'>check_timeout!</span>
  <span class='id identifier rubyid_http'>http</span> <span class='op'>=</span> <span class='const'><a href="../../../Net.html" title="Net (module)">Net</a></span><span class='op'>::</span><span class='const'>HTTP</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Auth::Aws::CredentialsRetriever.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>169.254.169.254</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_req'>req</span> <span class='op'>=</span> <span class='const'><a href="../../../Net.html" title="Net (module)">Net</a></span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Put</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Auth::Aws::CredentialsRetriever.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/latest/api/token</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='comment'># The TTL is required in order to obtain the metadata token.
</span>    {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>x-aws-ec2-metadata-token-ttl-seconds</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>30</span><span class='tstring_end'>&#39;</span></span>})
  <span class='id identifier rubyid_resp'>resp</span> <span class='op'>=</span> <span class='id identifier rubyid_with_timeout'><a href="#with_timeout-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#with_timeout (method)">with_timeout</a></span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span>) <span class='kw'>do</span>
    <span class='id identifier rubyid_http'>http</span>.<span class='id identifier rubyid_request'>request</span>(<span class='id identifier rubyid_req'>req</span>)
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_code'>code</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>200</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_metadata_token'>metadata_token</span> <span class='op'>=</span> <span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_body'>body</span>
  <span class='id identifier rubyid_resp'>resp</span> <span class='op'>=</span> <span class='id identifier rubyid_with_timeout'><a href="#with_timeout-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#with_timeout (method)">with_timeout</a></span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span>) <span class='kw'>do</span>
    <span class='id identifier rubyid_http_get'><a href="#http_get-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#http_get (method)">http_get</a></span>(<span class='id identifier rubyid_http'>http</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/latest/meta-data/iam/security-credentials</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_metadata_token'>metadata_token</span>)
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_code'>code</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>200</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_role_name'>role_name</span> <span class='op'>=</span> <span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_body'>body</span>
  <span class='id identifier rubyid_escaped_role_name'>escaped_role_name</span> <span class='op'>=</span> <span class='const'>CGI</span>.<span class='id identifier rubyid_escape'>escape</span>(<span class='id identifier rubyid_role_name'>role_name</span>).<span class='id identifier rubyid_gsub'>gsub</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>+</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%20</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_resp'>resp</span> <span class='op'>=</span> <span class='id identifier rubyid_with_timeout'><a href="#with_timeout-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#with_timeout (method)">with_timeout</a></span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span>) <span class='kw'>do</span>
    <span class='id identifier rubyid_http_get'><a href="#http_get-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#http_get (method)">http_get</a></span>(<span class='id identifier rubyid_http'>http</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/latest/meta-data/iam/security-credentials/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_escaped_role_name'>escaped_role_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_metadata_token'>metadata_token</span>)
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_code'>code</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>200</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_payload'>payload</span> <span class='op'>=</span> <span class='const'>JSON</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_body'>body</span>)
  <span class='kw'>unless</span> <span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Code</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Success</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
  <span class='const'><a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Credentials</a></span>.<span class='id identifier rubyid_new'><a href="../Base.html#new-class_method" title="Mongo::Auth::Base.new (method)">new</a></span>(
    <span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AccessKeyId</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SecretAccessKey</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Token</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='const'>DateTime</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Expiration</span><span class='tstring_end'>&#39;</span></span>]).<span class='id identifier rubyid_to_time'>to_time</span>
  )
<span class='comment'># When trying to use the EC2 metadata endpoint on ECS:
</span><span class='comment'># Errno::EINVAL: Failed to open TCP connection to 169.254.169.254:80 (Invalid argument - connect(2) for &quot;169.254.169.254&quot; port 80)
</span><span class='kw'>rescue</span> <span class='op'>::</span><span class='const'><a href="../../Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span><span class='op'>::</span><span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='comma'>,</span> <span class='const'>IOError</span><span class='comma'>,</span> <span class='const'>SystemCallError</span><span class='comma'>,</span> <span class='const'>TypeError</span>
  <span class='kw'>return</span> <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ecs_metadata_credentials-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>ecs_metadata_credentials</strong>(timeout_holder = nil)  &#x21d2; <a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns credentials from the ECS metadata endpoint. The credentials could be empty, partial or invalid.</p>

<p>@ raise <a href="../../Error/TimeoutError.html" title="Mongo::Error::TimeoutError (class)"><code>::Mongo::Error::TimeoutError</code></a> if credentials cannot be retrieved within</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='id identifier rubyid_defined'>defined</span> <span class='id identifier rubyid_on'>on</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_operation'>operation</span> <span class='id identifier rubyid_context'>context</span>.</code></pre>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>timeout_holder</span>
    <span class='type'>(<a href="../../CsotTimeoutHolder.html" title="Mongo::CsotTimeoutHolder (class)">CsotTimeoutHolder</a> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>CSOT timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>A set of credentials, or nil if retrieval failed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L214-L244'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='214' data-end='244'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 214</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ecs_metadata_credentials'>ecs_metadata_credentials</span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_timeout_holder'>timeout_holder</span><span class='op'>&amp;.</span><span class='id identifier rubyid_check_timeout!'>check_timeout!</span>
  <span class='id identifier rubyid_relative_uri'>relative_uri</span> <span class='op'>=</span> <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</span><span class='tstring_end'>&#39;</span></span>]
  <span class='kw'>if</span> <span class='id identifier rubyid_relative_uri'>relative_uri</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_relative_uri'>relative_uri</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_http'>http</span> <span class='op'>=</span> <span class='const'><a href="../../../Net.html" title="Net (module)">Net</a></span><span class='op'>::</span><span class='const'>HTTP</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Auth::Aws::CredentialsRetriever.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>169.254.170.2</span><span class='tstring_end'>&#39;</span></span>)
  <span class='comment'># Per https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html
</span>  <span class='comment'># the value in AWS_CONTAINER_CREDENTIALS_RELATIVE_URI includes
</span>  <span class='comment'># the leading slash.
</span>  <span class='comment'># The current language in MONGODB-AWS specification implies that
</span>  <span class='comment'># a leading slash must be added by the driver, but this is not
</span>  <span class='comment'># in fact needed.
</span>  <span class='id identifier rubyid_req'>req</span> <span class='op'>=</span> <span class='const'><a href="../../../Net.html" title="Net (module)">Net</a></span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Get</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Auth::Aws::CredentialsRetriever.new (method)">new</a></span>(<span class='id identifier rubyid_relative_uri'>relative_uri</span>)
  <span class='id identifier rubyid_resp'>resp</span> <span class='op'>=</span> <span class='id identifier rubyid_with_timeout'><a href="#with_timeout-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#with_timeout (method)">with_timeout</a></span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span>) <span class='kw'>do</span>
    <span class='id identifier rubyid_http'>http</span>.<span class='id identifier rubyid_request'>request</span>(<span class='id identifier rubyid_req'>req</span>)
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_code'>code</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>200</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_payload'>payload</span> <span class='op'>=</span> <span class='const'>JSON</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_body'>body</span>)
  <span class='const'><a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Credentials</a></span>.<span class='id identifier rubyid_new'><a href="../Base.html#new-class_method" title="Mongo::Auth::Base.new (method)">new</a></span>(
    <span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AccessKeyId</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SecretAccessKey</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Token</span><span class='tstring_end'>&#39;</span></span>]<span class='comma'>,</span>
    <span class='const'>DateTime</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_payload'>payload</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Expiration</span><span class='tstring_end'>&#39;</span></span>]).<span class='id identifier rubyid_to_time'>to_time</span>
  )
<span class='kw'>rescue</span> <span class='op'>::</span><span class='const'><a href="../../Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span><span class='op'>::</span><span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='comma'>,</span> <span class='const'>IOError</span><span class='comma'>,</span> <span class='const'>SystemCallError</span><span class='comma'>,</span> <span class='const'>TypeError</span>
  <span class='kw'>return</span> <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="http_get-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>http_get</strong>(http, uri, metadata_token)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L350-L354'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='350' data-end='354'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 350</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_http_get'>http_get</span>(<span class='id identifier rubyid_http'>http</span><span class='comma'>,</span> <span class='id identifier rubyid_uri'>uri</span><span class='comma'>,</span> <span class='id identifier rubyid_metadata_token'>metadata_token</span>)
  <span class='id identifier rubyid_req'>req</span> <span class='op'>=</span> <span class='const'><a href="../../../Net.html" title="Net (module)">Net</a></span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Get</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Auth::Aws::CredentialsRetriever.new (method)">new</a></span>(<span class='id identifier rubyid_uri'>uri</span><span class='comma'>,</span>
    {<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>x-aws-ec2-metadata-token</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_metadata_token'>metadata_token</span>})
  <span class='id identifier rubyid_http'>http</span>.<span class='id identifier rubyid_request'>request</span>(<span class='id identifier rubyid_req'>req</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="obtain_credentials_from_endpoints-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>obtain_credentials_from_endpoints</strong>(timeout_holder = nil)  &#x21d2; <a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns credentials from the AWS metadata endpoints.</p>

<p>@ raise <a href="../../Error/TimeoutError.html" title="Mongo::Error::TimeoutError (class)"><code>::Mongo::Error::TimeoutError</code></a> if credentials cannot be retrieved within</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='id identifier rubyid_defined'>defined</span> <span class='id identifier rubyid_on'>on</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_operation'>operation</span> <span class='id identifier rubyid_context'>context</span>.</code></pre>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>timeout_holder</span>
    <span class='type'>(<a href="../../CsotTimeoutHolder.html" title="Mongo::CsotTimeoutHolder (class)">CsotTimeoutHolder</a>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>CSOT timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>A set of credentials, or nil if retrieval failed or the obtained credentials are invalid.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p><a href="../InvalidConfiguration.html" title="Mongo::Auth::InvalidConfiguration (class)"><code>::Mongo::Auth::InvalidConfiguration</code></a> if a source contains an invalid set of credentials.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L143-L151'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='143' data-end='151'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 143</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_obtain_credentials_from_endpoints'>obtain_credentials_from_endpoints</span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='kw'>if</span> (<span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span> <span class='op'>=</span> <span class='id identifier rubyid_web_identity_credentials'><a href="#web_identity_credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#web_identity_credentials (method)">web_identity_credentials</a></span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span>)) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_credentials_valid?'><a href="#credentials_valid%3F-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials_valid? (method)">credentials_valid?</a></span>(<span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Web identity token</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>
  <span class='kw'>elsif</span> (<span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span> <span class='op'>=</span> <span class='id identifier rubyid_ecs_metadata_credentials'><a href="#ecs_metadata_credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#ecs_metadata_credentials (method)">ecs_metadata_credentials</a></span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span>)) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_credentials_valid?'><a href="#credentials_valid%3F-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials_valid? (method)">credentials_valid?</a></span>(<span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ECS task metadata</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>
  <span class='kw'>elsif</span> (<span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span> <span class='op'>=</span> <span class='id identifier rubyid_ec2_metadata_credentials'><a href="#ec2_metadata_credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#ec2_metadata_credentials (method)">ec2_metadata_credentials</a></span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span>)) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_credentials_valid?'><a href="#credentials_valid%3F-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials_valid? (method)">credentials_valid?</a></span>(<span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>EC2 instance metadata</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_credentials'><a href="#credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials (method)">credentials</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="prepare_web_identity_inputs-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>prepare_web_identity_inputs</strong>  &#x21d2; <code>Array</code>&lt;<code>String</code> | <code>nil</code>, <code>String</code> | <code>nil</code>, <code>String</code> | <code>nil</code>&gt;  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns inputs for the AssumeRoleWithWebIdentity AWS API call.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>&lt;<code>String</code> | <code>nil</code>, <code>String</code> | <code>nil</code>, <code>String</code> | <code>nil</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>Web identity token, role arn, and role session name.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L269-L283'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='269' data-end='283'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 269</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_prepare_web_identity_inputs'>prepare_web_identity_inputs</span>
  <span class='id identifier rubyid_token_file'>token_file</span> <span class='op'>=</span> <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AWS_WEB_IDENTITY_TOKEN_FILE</span><span class='tstring_end'>&#39;</span></span>]
  <span class='id identifier rubyid_role_arn'>role_arn</span> <span class='op'>=</span> <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AWS_ROLE_ARN</span><span class='tstring_end'>&#39;</span></span>]
  <span class='kw'>if</span> <span class='id identifier rubyid_token_file'>token_file</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_role_arn'>role_arn</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_web_identity_token'>web_identity_token</span> <span class='op'>=</span> <span class='const'>File</span>.<span class='id identifier rubyid_open'>open</span>(<span class='id identifier rubyid_token_file'>token_file</span>).<span class='id identifier rubyid_read'>read</span>
  <span class='id identifier rubyid_role_session_name'>role_session_name</span> <span class='op'>=</span> <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AWS_ROLE_SESSION_NAME</span><span class='tstring_end'>&#39;</span></span>]
  <span class='kw'>if</span> <span class='id identifier rubyid_role_session_name'>role_session_name</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_role_session_name'>role_session_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby-app-</span><span class='embexpr_beg'>#{</span><span class='const'>SecureRandom</span>.<span class='id identifier rubyid_alphanumeric'>alphanumeric</span>(<span class='int'>50</span>)<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  [<span class='id identifier rubyid_web_identity_token'>web_identity_token</span><span class='comma'>,</span> <span class='id identifier rubyid_role_arn'>role_arn</span><span class='comma'>,</span> <span class='id identifier rubyid_role_session_name'>role_session_name</span>]
<span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOENT</span><span class='comma'>,</span> <span class='const'>IOError</span><span class='comma'>,</span> <span class='const'>SystemCallError</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="request_web_identity_credentials-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>request_web_identity_credentials</strong>(token, role_arn, role_session_name, timeout_holder)  &#x21d2; <code>Net::HTTPResponse</code> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Calls AssumeRoleWithWebIdentity to obtain credentials for the given web identity token.</p>

<p>@ raise <a href="../../Error/TimeoutError.html" title="Mongo::Error::TimeoutError (class)"><code>::Mongo::Error::TimeoutError</code></a> if credentials cannot be retrieved within</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='id identifier rubyid_defined'>defined</span> <span class='id identifier rubyid_on'>on</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_operation'>operation</span> <span class='id identifier rubyid_context'>context</span>.</code></pre>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>token</span>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>The OAuth 2.0 access token or OpenID Connect ID token that is provided by the identity provider.</p>
</div>
  </li>
  <li>
    <span class='name'>role_arn</span>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>The Amazon Resource Name (ARN) of the role that the caller is assuming.</p>
</div>
  </li>
  <li>
    <span class='name'>role_session_name</span>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>An identifier for the assumed role session.</p>
</div>
  </li>
  <li>
    <span class='name'>timeout_holder</span>
    <span class='type'>(<a href="../../CsotTimeoutHolder.html" title="Mongo::CsotTimeoutHolder (class)">CsotTimeoutHolder</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>CSOT timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Net::HTTPResponse</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>AWS API response if successful, otherwise nil.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L301-L325'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='301' data-end='325'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 301</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_request_web_identity_credentials'>request_web_identity_credentials</span>(<span class='id identifier rubyid_token'>token</span><span class='comma'>,</span> <span class='id identifier rubyid_role_arn'>role_arn</span><span class='comma'>,</span> <span class='id identifier rubyid_role_session_name'>role_session_name</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout_holder'>timeout_holder</span>)
  <span class='id identifier rubyid_timeout_holder'>timeout_holder</span><span class='op'>&amp;.</span><span class='id identifier rubyid_check_timeout!'>check_timeout!</span>
  <span class='id identifier rubyid_uri'>uri</span> <span class='op'>=</span> <span class='const'><a href="../../URI.html" title="Mongo::URI (class)">URI</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>https://sts.amazonaws.com/</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> {
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Action</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AssumeRoleWithWebIdentity</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Version</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>2011-06-15</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RoleArn</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_role_arn'>role_arn</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>WebIdentityToken</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_token'>token</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RoleSessionName</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_role_session_name'>role_session_name</span>
  }
  <span class='id identifier rubyid_uri'>uri</span>.<span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="../../URI.html" title="Mongo::URI (class)">URI</a></span>.<span class='id identifier rubyid_encode_www_form'>encode_www_form</span>(<span class='id identifier rubyid_params'>params</span>)
  <span class='id identifier rubyid_req'>req</span> <span class='op'>=</span> <span class='const'><a href="../../../Net.html" title="Net (module)">Net</a></span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Post</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Auth::Aws::CredentialsRetriever.new (method)">new</a></span>(<span class='id identifier rubyid_uri'>uri</span>)
  <span class='id identifier rubyid_req'>req</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Accept</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/json</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_resp'>resp</span> <span class='op'>=</span> <span class='id identifier rubyid_with_timeout'><a href="#with_timeout-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#with_timeout (method)">with_timeout</a></span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span>) <span class='kw'>do</span>
    <span class='const'><a href="../../../Net.html" title="Net (module)">Net</a></span><span class='op'>::</span><span class='const'>HTTP</span>.<span class='id identifier rubyid_start'>start</span>(<span class='id identifier rubyid_uri'>uri</span>.<span class='id identifier rubyid_hostname'>hostname</span><span class='comma'>,</span> <span class='id identifier rubyid_uri'>uri</span>.<span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='label'>use_ssl:</span> <span class='kw'>true</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_https'>https</span><span class='op'>|</span>
      <span class='id identifier rubyid_https'>https</span>.<span class='id identifier rubyid_request'>request</span>(<span class='id identifier rubyid_req'>req</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_code'>code</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>200</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_resp'>resp</span>
<span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOENT</span><span class='comma'>,</span> <span class='const'>IOError</span><span class='comma'>,</span> <span class='const'>SystemCallError</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="web_identity_credentials-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>web_identity_credentials</strong>(timeout_holder = nil)  &#x21d2; <a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns credentials associated with web identity token that is stored in a file. This authentication mechanism is used to authenticate inside EKS. See <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html">docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html</a> for further details.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>timeout_holder</span>
    <span class='type'>(<a href="../../CsotTimeoutHolder.html" title="Mongo::CsotTimeoutHolder (class)">CsotTimeoutHolder</a> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>CSOT timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Credentials.html" title="Mongo::Auth::Aws::Credentials (class)">Auth::Aws::Credentials</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>A set of credentials, or nil if retrieval failed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L255-L263'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='255' data-end='263'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 255</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_web_identity_credentials'>web_identity_credentials</span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_web_identity_token'>web_identity_token</span><span class='comma'>,</span> <span class='id identifier rubyid_role_arn'>role_arn</span><span class='comma'>,</span> <span class='id identifier rubyid_role_session_name'>role_session_name</span> <span class='op'>=</span> <span class='id identifier rubyid_prepare_web_identity_inputs'><a href="#prepare_web_identity_inputs-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#prepare_web_identity_inputs (method)">prepare_web_identity_inputs</a></span>
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_web_identity_token'>web_identity_token</span>.<span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='id identifier rubyid_request_web_identity_credentials'><a href="#request_web_identity_credentials-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#request_web_identity_credentials (method)">request_web_identity_credentials</a></span>(
    <span class='id identifier rubyid_web_identity_token'>web_identity_token</span><span class='comma'>,</span> <span class='id identifier rubyid_role_arn'>role_arn</span><span class='comma'>,</span> <span class='id identifier rubyid_role_session_name'>role_session_name</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout_holder'>timeout_holder</span>
  )
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_credentials_from_web_identity_response'><a href="#credentials_from_web_identity_response-instance_method" title="Mongo::Auth::Aws::CredentialsRetriever#credentials_from_web_identity_response (method)">credentials_from_web_identity_response</a></span>(<span class='id identifier rubyid_response'>response</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="with_timeout-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>with_timeout</strong>(timeout_holder)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Execute the given block considering the timeout defined on the context, or the default timeout value.</p>

<p>We use <a href="../../Timeout.html#timeout-class_method" title="Mongo::Timeout.timeout (method)">Timeout.timeout</a> here because there is no other acceptable easy way to time limit http requests.</p>

<p>@ raise <a href="../../Error/TimeoutError.html" title="Mongo::Error::TimeoutError (class)"><code>::Mongo::Error::TimeoutError</code></a> if deadline exceeded.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>timeout_holder</span>
    <span class='type'>(<a href="../../CsotTimeoutHolder.html" title="Mongo::CsotTimeoutHolder (class)">CsotTimeoutHolder</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>CSOT timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/auth/aws/credentials_retriever.rb#L396-L406'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='396' data-end='406'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/auth/aws/credentials_retriever.rb', line 396</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_with_timeout'>with_timeout</span>(<span class='id identifier rubyid_timeout_holder'>timeout_holder</span>)
  <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout_holder'>timeout_holder</span><span class='op'>&amp;.</span><span class='id identifier rubyid_remaining_timeout_sec!'>remaining_timeout_sec!</span> <span class='op'>||</span> <span class='const'><a href="#METADATA_TIMEOUT-constant" title="Mongo::Auth::Aws::CredentialsRetriever::METADATA_TIMEOUT (constant)">METADATA_TIMEOUT</a></span>
  <span class='id identifier rubyid_exception_class'>exception_class</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_timeout_holder'>timeout_holder</span><span class='op'>&amp;.</span><span class='id identifier rubyid_csot?'>csot?</span>
                      <span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../../Error/TimeoutError.html" title="Mongo::Error::TimeoutError (class)">TimeoutError</a></span>
                    <span class='kw'>else</span>
                      <span class='kw'>nil</span>
                    <span class='kw'>end</span>
  <span class='op'>::</span><span class='const'><a href="../../Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span>.<span class='id identifier rubyid_timeout'>timeout</span>(<span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='id identifier rubyid_exception_class'>exception_class</span>) <span class='kw'>do</span>
    <span class='kw'>yield</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>