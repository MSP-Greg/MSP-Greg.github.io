<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::ServerSelector::Base &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::ServerSelector::Base",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongo master</a> &raquo; 
      <a href='../../_index.html#alpha_B'>Index (B)</a> &raquo; 
        <a href="../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Base&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::ServerSelector::Base</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Subclasses:</div>
        <div class='box_22'>
          <a href="Nearest.html" title="Mongo::ServerSelector::Nearest (class)">Nearest</a>, <a href="Primary_.html" title="Mongo::ServerSelector::Primary (class)">Primary</a>, <a href="PrimaryPreferred.html" title="Mongo::ServerSelector::PrimaryPreferred (class)">PrimaryPreferred</a>, <a href="Secondary.html" title="Mongo::ServerSelector::Secondary (class)">Secondary</a>, <a href="SecondaryPreferred.html" title="Mongo::ServerSelector::SecondaryPreferred (class)">SecondaryPreferred</a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L22'>lib/mongo/server_selector/base.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(options = nil)  &#x21d2; Base </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Initialize the server selector.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#hedge-instance_method" title="#hedge (instance method)">#<strong>hedge</strong>  &#x21d2; Hash | nil </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#max_staleness-instance_method" title="#max_staleness (instance method)">#<strong>max_staleness</strong>  &#x21d2; Integer </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#options-instance_method" title="#options (instance method)">#<strong>options</strong>  &#x21d2; Hash </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#tag_sets-instance_method" title="#tag_sets (instance method)">#<strong>tag_sets</strong>  &#x21d2; Array </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#==-instance_method" title="#== (instance method)">#<strong>==</strong>(other)  &#x21d2; true, false </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Check equality of two server selectors.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#candidates-instance_method" title="#candidates (instance method)">#<strong>candidates</strong>(cluster)  &#x21d2; Array&lt;Server&gt; </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns servers of acceptable types from the cluster.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#inspect-instance_method" title="#inspect (instance method)">#<strong>inspect</strong>  &#x21d2; String </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Inspect the server selector.</p></div>
    </div>
  </li>
  <li class='deprecated'>
    <span class='summary_signature deprecated'>
      <a href="#local_threshold-instance_method" title="#local_threshold (instance method)">#<strong>local_threshold</strong>  &#x21d2; Float </a>
    </span>
    <span class='deprecated note title'>deprecated</span>
    <span class='summary_desc'><strong>Deprecated.</strong>
      <div class='inline'>
<p>This setting is now taken from the cluster options when a server is selected. Will be removed in version 3.0.</p>
</div>    </span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#local_threshold_with_cluster-instance_method" title="#local_threshold_with_cluster (instance method)">#<strong>local_threshold_with_cluster</strong>(cluster)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#select_server-instance_method" title="#select_server (instance method)">#<strong>select_server</strong>(cluster, ping = nil, session = nil, write_aggregation: false, deprioritized: [], timeout: nil)  &#x21d2; Mongo::Server </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Select a server from the specified cluster, taking into account mongos pinning for the specified session.</p></div>
    </div>
  </li>
  <li class='deprecated'>
    <span class='summary_signature deprecated'>
      <a href="#server_selection_timeout-instance_method" title="#server_selection_timeout (instance method)">#<strong>server_selection_timeout</strong>  &#x21d2; Float </a>
    </span>
    <span class='deprecated note title'>deprecated</span>
    <span class='summary_desc'><strong>Deprecated.</strong>
      <div class='inline'>
<p>This setting is now taken from the cluster options when a server is selected. Will be removed in version 3.0.</p>
</div>    </span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#suitable_servers-instance_method" title="#suitable_servers (instance method)">#<strong>suitable_servers</strong>(cluster)  &#x21d2; Array&lt;Server&gt; </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns servers satisfying the server selector from the cluster.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#try_select_server-instance_method" title="#try_select_server (instance method)">#<strong>try_select_server</strong>(cluster, write_aggregation: false, deprioritized: [])  &#x21d2; Server | nil </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Tries to find a suitable server, returns the server if one is available or nil if there isn’t a suitable server.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#filter_stale_servers-instance_method" title="#filter_stale_servers (instance method)">#<strong>filter_stale_servers</strong>(candidates, primary = nil)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#full_doc-instance_method" title="#full_doc (instance method)">#<strong>full_doc</strong>  &#x21d2; Hash </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Convert this server preference definition into a format appropriate.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#match_tag_sets-instance_method" title="#match_tag_sets (instance method)">#<strong>match_tag_sets</strong>(candidates)  &#x21d2; Array </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Select the servers matching the defined tag sets.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#near_servers-instance_method" title="#near_servers (instance method)">#<strong>near_servers</strong>(candidates = [], local_threshold = nil)  &#x21d2; Array </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Select the near servers from a list of provided candidates, taking the.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#primary-instance_method" title="#primary (instance method)">#<strong>primary</strong>(candidates)  &#x21d2; Array </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Select the primary from a list of provided candidates.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#secondaries-instance_method" title="#secondaries (instance method)">#<strong>secondaries</strong>(candidates)  &#x21d2; Array </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Select the secondaries from a list of provided candidates.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#select_server_impl-instance_method" title="#select_server_impl (instance method)">#<strong>select_server_impl</strong>(cluster, ping, session, write_aggregation, deprioritized, csot_timeout)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Parameters and return values are the same as for select_server, only the <code>timeout</code> param is renamed to <code>csot_timeout</code>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#server_selection_diagnostic_message-instance_method" title="#server_selection_diagnostic_message (instance method)">#<strong>server_selection_diagnostic_message</strong>(cluster)  &#x21d2; String </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Creates a diagnostic message when server selection fails.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#suitable_server-instance_method" title="#suitable_server (instance method)">#<strong>suitable_server</strong>(servers, deprioritized)  &#x21d2; Server | nil </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns a server from the list of servers that is suitable for executing the operation.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#validate!-instance_method" title="#validate! (instance method)">#<strong>validate!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#validate_max_staleness_support!-instance_method" title="#validate_max_staleness_support! (instance method)">#<strong>validate_max_staleness_support!</strong>(server)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#validate_max_staleness_value!-instance_method" title="#validate_max_staleness_value! (instance method)">#<strong>validate_max_staleness_value!</strong>(cluster)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#validate_max_staleness_value_early!-instance_method" title="#validate_max_staleness_value_early! (instance method)">#<strong>validate_max_staleness_value_early!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#wait_for_server_selection-instance_method" title="#wait_for_server_selection (instance method)">#<strong>wait_for_server_selection</strong>(cluster, time_remaining)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Waits for server state changes in the specified cluster.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="hedge-instance_method">
  <h3 class='signature ro first'>
    #<strong>hedge</strong>  &#x21d2; <code>Hash</code> | <code>nil</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>hedge The document specifying whether to enable hedged reads.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L76-L76'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='76' data-end='76'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 76</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_hedge'>hedge</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="max_staleness-instance_method">
  <h3 class='signature ro'>
    #<strong>max_staleness</strong>  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>max_staleness The maximum replication lag, in seconds, that a secondary can suffer and still be eligible for a read.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.4.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L72-L72'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='72' data-end='72'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 72</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_max_staleness'>max_staleness</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="options-instance_method">
  <h3 class='signature ro'>
    #<strong>options</strong>  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>options The options.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L63-L63'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='63'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_options'>options</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="tag_sets-instance_method">
  <h3 class='signature ro'>
    #<strong>tag_sets</strong>  &#x21d2; <code>Array</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>)</span>
&mdash;    <div class='inline'>
<p>tag_sets The tag sets used to select servers.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L66-L66'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='66' data-end='66'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 66</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tag_sets'>tag_sets</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="==-instance_method">
  <h3 class='signature  first'>
    #<strong>==</strong>(other)  &#x21d2; <code>true</code>, <code>false</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Check equality of two server selectors.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Check server selector equality.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_preference'>preference</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span></code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>other</span>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The other preference.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>, <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the objects are equal.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L136-L139'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='136' data-end='139'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 136</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='op'>==</span>(<span class='id identifier rubyid_other'>other</span>)
  <span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span>.<span class='id identifier rubyid_name'>name</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_hedge'><a href="#hedge-instance_method" title="Mongo::ServerSelector::Base#hedge (method)">hedge</a></span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span>.<span class='id identifier rubyid_hedge'><a href="#hedge-instance_method" title="Mongo::ServerSelector::Base#hedge (method)">hedge</a></span> <span class='op'>&amp;&amp;</span>
    <span class='id identifier rubyid_max_staleness'><a href="#max_staleness-instance_method" title="Mongo::ServerSelector::Base#max_staleness (method)">max_staleness</a></span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span>.<span class='id identifier rubyid_max_staleness'><a href="#max_staleness-instance_method" title="Mongo::ServerSelector::Base#max_staleness (method)">max_staleness</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_tag_sets'><a href="#tag_sets-instance_method" title="Mongo::ServerSelector::Base#tag_sets (method)">tag_sets</a></span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span>.<span class='id identifier rubyid_tag_sets'><a href="#tag_sets-instance_method" title="Mongo::ServerSelector::Base#tag_sets (method)">tag_sets</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="candidates-instance_method">
  <h3 class='signature nodoc'>
    #<strong>candidates</strong>(cluster)  &#x21d2; <code>Array</code>&lt;<a href="../Server.html" title="Mongo::Server (class)">Server</a>&gt; 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns servers of acceptable types from the cluster.</p>

<p>Does not perform staleness validation, staleness filtering or latency filtering.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>cluster</span>
    <span class='type'>(<a href="../Cluster.html" title="Mongo::Cluster (class)">Cluster</a>)</span>
&mdash;    <div class='inline'>
<p>The cluster.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>&lt;<a href="../Server.html" title="Mongo::Server (class)">Server</a>&gt;)</span>
&mdash;    <div class='inline'>
<p>The candidate servers.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L403-L418'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='403' data-end='418'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 403</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_candidates'>candidates</span>(<span class='id identifier rubyid_cluster'>cluster</span>)
  <span class='id identifier rubyid_servers'>servers</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_servers'>servers</span>
  <span class='id identifier rubyid_servers'>servers</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='id identifier rubyid_validate_max_staleness_support!'><a href="#validate_max_staleness_support!-instance_method" title="Mongo::ServerSelector::Base#validate_max_staleness_support! (method)">validate_max_staleness_support!</a></span>(<span class='id identifier rubyid_server'>server</span>)
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_single?'>single?</span>
    <span class='id identifier rubyid_servers'>servers</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_sharded?'>sharded?</span>
    <span class='id identifier rubyid_servers'>servers</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_replica_set?'>replica_set?</span>
    <span class='id identifier rubyid_select_in_replica_set'>select_in_replica_set</span>(<span class='id identifier rubyid_servers'>servers</span>)
  <span class='kw'>else</span>
    <span class='comment'># Unknown cluster - no servers
</span>    []
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="filter_stale_servers-instance_method">
  <h3 class='signature priv'>
    #<strong>filter_stale_servers</strong>(candidates, primary = nil)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L572-L595'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='572' data-end='595'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 572</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_filter_stale_servers'>filter_stale_servers</span>(<span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span><span class='comma'>,</span> <span class='id identifier rubyid_primary'><a href="#primary-instance_method" title="Mongo::ServerSelector::Base#primary (method)">primary</a></span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='kw'>return</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span> <span class='kw'>unless</span> <span class='ivar'>@max_staleness</span>

  <span class='comment'># last_scan is filled out by the Monitor, and can be nil if a server
</span>  <span class='comment'># had its description manually set rather than being normally updated
</span>  <span class='comment'># via the SDAM flow. We don&#39;t handle the possibility of a nil
</span>  <span class='comment'># last_scan here.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_primary'><a href="#primary-instance_method" title="Mongo::ServerSelector::Base#primary (method)">primary</a></span>
    <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
      <span class='id identifier rubyid_validate_max_staleness_support!'><a href="#validate_max_staleness_support!-instance_method" title="Mongo::ServerSelector::Base#validate_max_staleness_support! (method)">validate_max_staleness_support!</a></span>(<span class='id identifier rubyid_server'>server</span>)
      <span class='id identifier rubyid_staleness'>staleness</span> <span class='op'>=</span> (<span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_last_scan'>last_scan</span> <span class='op'>-</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_last_write_date'>last_write_date</span>) <span class='op'>-</span>
                  (<span class='id identifier rubyid_primary'><a href="#primary-instance_method" title="Mongo::ServerSelector::Base#primary (method)">primary</a></span>.<span class='id identifier rubyid_last_scan'>last_scan</span> <span class='op'>-</span> <span class='id identifier rubyid_primary'><a href="#primary-instance_method" title="Mongo::ServerSelector::Base#primary (method)">primary</a></span>.<span class='id identifier rubyid_last_write_date'>last_write_date</span>)  <span class='op'>+</span>
                  <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_heartbeat_interval'>heartbeat_interval</span>
      <span class='id identifier rubyid_staleness'>staleness</span> <span class='op'>&lt;=</span> <span class='ivar'>@max_staleness</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_max_write_date'>max_write_date</span> <span class='op'>=</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_collect'>collect</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_last_write_date'>last_write_date</span>).<span class='id identifier rubyid_max'>max</span>
    <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
      <span class='id identifier rubyid_validate_max_staleness_support!'><a href="#validate_max_staleness_support!-instance_method" title="Mongo::ServerSelector::Base#validate_max_staleness_support! (method)">validate_max_staleness_support!</a></span>(<span class='id identifier rubyid_server'>server</span>)
      <span class='id identifier rubyid_staleness'>staleness</span> <span class='op'>=</span> <span class='id identifier rubyid_max_write_date'>max_write_date</span> <span class='op'>-</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_last_write_date'>last_write_date</span> <span class='op'>+</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_heartbeat_interval'>heartbeat_interval</span>
      <span class='id identifier rubyid_staleness'>staleness</span> <span class='op'>&lt;=</span> <span class='ivar'>@max_staleness</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="full_doc-instance_method">
  <h3 class='signature priv'>
    #<strong>full_doc</strong>  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Convert this server preference definition into a format appropriate</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>for</span> <span class='id identifier rubyid_sending'>sending</span> <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_a'>a</span> <span class='const'>MongoDB</span> <span class='id identifier rubyid_server'>server</span> (<span class='id identifier rubyid_i'>i</span>.<span class='id identifier rubyid_e'>e</span>.<span class='comma'>,</span> <span class='id identifier rubyid_as'>as</span> <span class='id identifier rubyid_a'>a</span> <span class='id identifier rubyid_command'>command</span> <span class='id identifier rubyid_field'>field</span>).</code></pre>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>The server preference formatted as a command field value.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L469-L477'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='469' data-end='477'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 469</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_full_doc'>full_doc</span>
  <span class='ivar'>@full_doc</span> <span class='op'>||=</span> <span class='kw'>begin</span>
    <span class='id identifier rubyid_preference'>preference</span> <span class='op'>=</span> { <span class='symbeg'>:</span><span class='id identifier rubyid_mode'>mode</span> <span class='op'>=&gt;</span> <span class='kw'>self</span>.<span class='id identifier rubyid_class'>class</span>.<span class='id identifier rubyid_const_get'>const_get</span>(<span class='symbeg'>:</span><span class='const'>SERVER_FORMATTED_NAME</span>) }
    <span class='id identifier rubyid_preference'>preference</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>tags:</span> <span class='id identifier rubyid_tag_sets'><a href="#tag_sets-instance_method" title="Mongo::ServerSelector::Base#tag_sets (method)">tag_sets</a></span>) <span class='kw'>unless</span> <span class='id identifier rubyid_tag_sets'><a href="#tag_sets-instance_method" title="Mongo::ServerSelector::Base#tag_sets (method)">tag_sets</a></span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_preference'>preference</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>maxStalenessSeconds:</span> <span class='id identifier rubyid_max_staleness'><a href="#max_staleness-instance_method" title="Mongo::ServerSelector::Base#max_staleness (method)">max_staleness</a></span>) <span class='kw'>if</span> <span class='id identifier rubyid_max_staleness'><a href="#max_staleness-instance_method" title="Mongo::ServerSelector::Base#max_staleness (method)">max_staleness</a></span>
    <span class='id identifier rubyid_preference'>preference</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>hedge:</span> <span class='id identifier rubyid_hedge'><a href="#hedge-instance_method" title="Mongo::ServerSelector::Base#hedge (method)">hedge</a></span>) <span class='kw'>if</span> <span class='id identifier rubyid_hedge'><a href="#hedge-instance_method" title="Mongo::ServerSelector::Base#hedge (method)">hedge</a></span>
    <span class='id identifier rubyid_preference'>preference</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="inspect-instance_method">
  <h3 class='signature '>
    #<strong>inspect</strong>  &#x21d2; <code>String</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Inspect the server selector.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Inspect the server selector.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_selector'>selector</span>.<span class='id identifier rubyid_inspect'>inspect</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>The inspection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.2.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L122-L124'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='122' data-end='124'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 122</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_inspect'>inspect</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;</span><span class='embexpr_beg'>#{</span><span class='kw'>self</span>.<span class='id identifier rubyid_class'>class</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>:0x</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_object_id'>object_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> tag_sets=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_tag_sets'><a href="#tag_sets-instance_method" title="Mongo::ServerSelector::Base#tag_sets (method)">tag_sets</a></span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> max_staleness=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_staleness'><a href="#max_staleness-instance_method" title="Mongo::ServerSelector::Base#max_staleness (method)">max_staleness</a></span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> hedge=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hedge'><a href="#hedge-instance_method" title="Mongo::ServerSelector::Base#hedge (method)">hedge</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="local_threshold-instance_method">
  <h3 class='signature deprecated'>
    #<strong>local_threshold</strong>  &#x21d2; <code>Float</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <div class="note deprecated"><strong>Deprecated.</strong> <div class='inline'>
<p>This setting is now taken from the cluster options when a server is selected. Will be removed in version 3.0.</p>
</div></div>

<p>Get the local threshold boundary for nearest selection in seconds.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Get the local threshold.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_selector'>selector</span>.<span class='id identifier rubyid_local_threshold'>local_threshold</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Float</code>)</span>
&mdash;    <div class='inline'>
<p>The local threshold.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L105-L107'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='105' data-end='107'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 105</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_local_threshold'>local_threshold</span>
  <span class='ivar'>@local_threshold</span> <span class='op'>||=</span> (<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::ServerSelector::Base#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_local_threshold'>local_threshold</span>] <span class='op'>||</span> <span class='const'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span><span class='op'>::</span><span class='const'><a href="../ServerSelector.html#LOCAL_THRESHOLD-constant" title="Mongo::ServerSelector::LOCAL_THRESHOLD (constant)">LOCAL_THRESHOLD</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="local_threshold_with_cluster-instance_method">
  <h3 class='signature nodoc'>
    #<strong>local_threshold_with_cluster</strong>(cluster)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L110-L112'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='110' data-end='112'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 110</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_local_threshold_with_cluster'>local_threshold_with_cluster</span>(<span class='id identifier rubyid_cluster'>cluster</span>)
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::ServerSelector::Base#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_local_threshold'><a href="#local_threshold-instance_method" title="Mongo::ServerSelector::Base#local_threshold (method)">local_threshold</a></span>] <span class='op'>||</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::ServerSelector::Base#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_local_threshold'><a href="#local_threshold-instance_method" title="Mongo::ServerSelector::Base#local_threshold (method)">local_threshold</a></span>] <span class='op'>||</span> <span class='const'><a href="../ServerSelector.html#LOCAL_THRESHOLD-constant" title="Mongo::ServerSelector::LOCAL_THRESHOLD (constant)">LOCAL_THRESHOLD</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="match_tag_sets-instance_method">
  <h3 class='signature priv'>
    #<strong>match_tag_sets</strong>(candidates)  &#x21d2; <code>Array</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Select the servers matching the defined tag sets.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>candidates</span>
    <span class='type'>(<code>Array</code>)</span>
&mdash;    <div class='inline'>
<p>List of candidate servers from which those matching the defined tag sets should be selected.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>)</span>
&mdash;    <div class='inline'>
<p>The servers matching the defined tag sets.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L563-L570'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='563' data-end='570'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 563</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_match_tag_sets'>match_tag_sets</span>(<span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>)
  <span class='id identifier rubyid_matches'>matches</span> <span class='op'>=</span> []
  <span class='id identifier rubyid_tag_sets'><a href="#tag_sets-instance_method" title="Mongo::ServerSelector::Base#tag_sets (method)">tag_sets</a></span>.<span class='id identifier rubyid_find'>find</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tag_set'>tag_set</span><span class='op'>|</span>
    <span class='id identifier rubyid_matches'>matches</span> <span class='op'>=</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_select'>select</span> { <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_matches_tag_set?'>matches_tag_set?</span>(<span class='id identifier rubyid_tag_set'>tag_set</span>) }
    <span class='op'>!</span><span class='id identifier rubyid_matches'>matches</span>.<span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_matches'>matches</span> <span class='op'>||</span> []
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="near_servers-instance_method">
  <h3 class='signature priv'>
    #<strong>near_servers</strong>(candidates = [], local_threshold = nil)  &#x21d2; <code>Array</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Select the near servers from a list of provided candidates, taking the</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_local'>local</span> <span class='id identifier rubyid_threshold'>threshold</span> <span class='id identifier rubyid_into'>into</span> <span class='id identifier rubyid_account'>account</span>.</code></pre>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>candidates</span>
    <span class='type'>(<code>Array</code>)</span>
    <em class='default'>(defaults to: <tt>[]</tt>)</em>
&mdash;    <div class='inline'>
<p>List of candidate servers to select the near servers from.</p>
</div>
  </li>
  <li>
    <span class='name'>local_threshold</span>
    <span class='type'>(<code>Integer</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>Local threshold. This parameter will be required in driver version 3.0.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>)</span>
&mdash;    <div class='inline'>
<p>The near servers.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L523-L553'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='523' data-end='553'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 523</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_near_servers'>near_servers</span>(<span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span> <span class='op'>=</span> []<span class='comma'>,</span> <span class='id identifier rubyid_local_threshold'><a href="#local_threshold-instance_method" title="Mongo::ServerSelector::Base#local_threshold (method)">local_threshold</a></span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='kw'>return</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_empty?'>empty?</span>

  <span class='comment'># Average RTT on any server may change at any time by the server
</span>  <span class='comment'># monitor&#39;s background thread. ARTT may also become nil if the
</span>  <span class='comment'># server is marked unknown. Take a snapshot of ARTTs for the duration
</span>  <span class='comment'># of this method.
</span>
  <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span> <span class='op'>=</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    {<span class='label'>server:</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='label'>artt:</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_average_round_trip_time'>average_round_trip_time</span>}
  <span class='kw'>end</span>.<span class='id identifier rubyid_reject'>reject</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_candidate'>candidate</span><span class='op'>|</span>
    <span class='id identifier rubyid_candidate'>candidate</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artt'>artt</span>].<span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_empty?'>empty?</span>

  <span class='id identifier rubyid_nearest_candidate'>nearest_candidate</span> <span class='op'>=</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_min_by'>min_by</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_candidate'>candidate</span><span class='op'>|</span>
    <span class='id identifier rubyid_candidate'>candidate</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artt'>artt</span>]
  <span class='kw'>end</span>

  <span class='comment'># Default for legacy signarure
</span>  <span class='id identifier rubyid_local_threshold'><a href="#local_threshold-instance_method" title="Mongo::ServerSelector::Base#local_threshold (method)">local_threshold</a></span> <span class='op'>||=</span> <span class='kw'>self</span>.<span class='id identifier rubyid_local_threshold'><a href="#local_threshold-instance_method" title="Mongo::ServerSelector::Base#local_threshold (method)">local_threshold</a></span>

  <span class='id identifier rubyid_threshold'>threshold</span> <span class='op'>=</span> <span class='id identifier rubyid_nearest_candidate'>nearest_candidate</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artt'>artt</span>] <span class='op'>+</span> <span class='id identifier rubyid_local_threshold'><a href="#local_threshold-instance_method" title="Mongo::ServerSelector::Base#local_threshold (method)">local_threshold</a></span>

  <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_candidate'>candidate</span><span class='op'>|</span>
    <span class='id identifier rubyid_candidate'>candidate</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_artt'>artt</span>] <span class='op'>&lt;=</span> <span class='id identifier rubyid_threshold'>threshold</span>
  <span class='kw'>end</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_candidate'>candidate</span><span class='op'>|</span>
    <span class='id identifier rubyid_candidate'>candidate</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_server'>server</span>]
  <span class='kw'>end</span>.<span class='id identifier rubyid_shuffle!'>shuffle!</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="primary-instance_method">
  <h3 class='signature priv'>
    #<strong>primary</strong>(candidates)  &#x21d2; <code>Array</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Select the primary from a list of provided candidates.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>candidates</span>
    <span class='type'>(<code>Array</code>)</span>
&mdash;    <div class='inline'>
<p>List of candidate servers to select the primary from.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>)</span>
&mdash;    <div class='inline'>
<p>The primary.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L487-L491'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='487' data-end='491'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 487</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_primary'>primary</span>(<span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>)
  <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_primary?'>primary?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="secondaries-instance_method">
  <h3 class='signature priv'>
    #<strong>secondaries</strong>(candidates)  &#x21d2; <code>Array</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Select the secondaries from a list of provided candidates.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>candidates</span>
    <span class='type'>(<code>Array</code>)</span>
&mdash;    <div class='inline'>
<p>List of candidate servers to select the secondaries from.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>)</span>
&mdash;    <div class='inline'>
<p>The secondary servers.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L501-L510'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='501' data-end='510'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 501</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_secondaries'>secondaries</span>(<span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>)
  <span class='id identifier rubyid_matching_servers'>matching_servers</span> <span class='op'>=</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_secondary?'>secondary?</span>)
  <span class='id identifier rubyid_matching_servers'>matching_servers</span> <span class='op'>=</span> <span class='id identifier rubyid_filter_stale_servers'><a href="#filter_stale_servers-instance_method" title="Mongo::ServerSelector::Base#filter_stale_servers (method)">filter_stale_servers</a></span>(<span class='id identifier rubyid_matching_servers'>matching_servers</span><span class='comma'>,</span> <span class='id identifier rubyid_primary'><a href="#primary-instance_method" title="Mongo::ServerSelector::Base#primary (method)">primary</a></span>(<span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>).<span class='id identifier rubyid_first'>first</span>)
  <span class='id identifier rubyid_matching_servers'>matching_servers</span> <span class='op'>=</span> <span class='id identifier rubyid_match_tag_sets'><a href="#match_tag_sets-instance_method" title="Mongo::ServerSelector::Base#match_tag_sets (method)">match_tag_sets</a></span>(<span class='id identifier rubyid_matching_servers'>matching_servers</span>) <span class='kw'>unless</span> <span class='id identifier rubyid_tag_sets'><a href="#tag_sets-instance_method" title="Mongo::ServerSelector::Base#tag_sets (method)">tag_sets</a></span>.<span class='id identifier rubyid_empty?'>empty?</span>
  <span class='comment'># Per server selection spec the server selected MUST be a random
</span>  <span class='comment'># one matching staleness and latency requirements.
</span>  <span class='comment'># Selectors always pass the output of #secondaries to #nearest
</span>  <span class='comment'># which shuffles the server list, fulfilling this requirement.
</span>  <span class='id identifier rubyid_matching_servers'>matching_servers</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="select_server-instance_method">
  <h3 class='signature '>
    #<strong>select_server</strong>(cluster, ping = nil, session = nil, write_aggregation: false, deprioritized: [], timeout: nil)  &#x21d2; <a href="../Server.html" title="Mongo::Server (class)">Mongo::Server</a> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Select a server from the specified cluster, taking into account mongos pinning for the specified session.</p>

<p>If the session is given and has a pinned server, this server is the only server considered for selection. If the server is of type mongos, it is returned immediately; otherwise monitoring checks on this server are initiated to update its status, and if the server becomes a mongos within the server selection timeout, it is returned.</p>

<p>If no session is given or the session does not have a pinned server, normal server selection process is performed among all servers in the specified cluster matching the preference of this server selector object. <a href="../Monitoring.html" title="Mongo::Monitoring (class)"><code>::Mongo::Monitoring</code></a> checks are initiated on servers in the cluster until a suitable server is found, up to the server selection timeout.</p>

<p>If a suitable server is not found within the server selection timeout, this method raises <a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)"><code>::Mongo::Error::NoServerAvailable</code></a>.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>cluster</span>
    <span class='type'>(<a href="../Cluster.html" title="Mongo::Cluster (class)">Mongo::Cluster</a>)</span>
&mdash;    <div class='inline'>
<p>The cluster from which to select an eligible server.</p>
</div>
  </li>
  <li>
    <span class='name'>ping</span>
    <span class='type'>(<code>true</code>, <code>false</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>Whether to ping the server before selection. Deprecated and ignored.</p>
</div>
  </li>
  <li>
    <span class='name'>session</span>
    <span class='type'>(<a href="../Session.html" title="Mongo::Session (class)">Session</a> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>Optional session to take into account for mongos pinning. Added in version 2.10.0.</p>
</div>
  </li>
  <li>
    <span class='name'>write_aggregation</span>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether we need a server that supports writing aggregations (e.g. with $merge/$out) on secondaries.</p>
</div>
  </li>
  <li>
    <span class='name'>deprioritized</span>
    <span class='type'>(<code>Array</code>&lt;<a href="../Server.html" title="Mongo::Server (class)">Server</a>&gt;)</span>
&mdash;    <div class='inline'>
<p>A list of servers that should be selected from only if no other servers are available. This is used to avoid selecting the same server twice in a row when retrying a command.</p>
</div>
  </li>
  <li>
    <span class='name'>:timeout</span>
    <span class='type'>(<code>Float</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p><a href="../Timeout.html" title="Mongo::Timeout (module)"><code>::Mongo::Timeout</code></a> in seconds for the operation, if any.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Server.html" title="Mongo::Server (class)">Mongo::Server</a>)</span>
&mdash;    <div class='inline'>
<p>A server matching the server preference.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">Error::NoServerAvailable</a>)</span>
&mdash;    <div class='inline'>
<p>No server was found matching the specified preference / pinning requirement in the server selection timeout.</p>
</div>
  </li>
  <li>
    <span class='type'>(<a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">Error::LintError</a>)</span>
&mdash;    <div class='inline'>
<p>An unexpected condition was detected, and lint mode is enabled.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L183-L196'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='183' data-end='196'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 183</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_select_server'>select_server</span>(
  <span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span>
  <span class='id identifier rubyid_ping'>ping</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span>
  <span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span>
  <span class='label'>write_aggregation:</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='label'>deprioritized:</span> []<span class='comma'>,</span>
  <span class='label'>timeout:</span> <span class='kw'>nil</span>
)
  <span class='id identifier rubyid_select_server_impl'><a href="#select_server_impl-instance_method" title="Mongo::ServerSelector::Base#select_server_impl (method)">select_server_impl</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_ping'>ping</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_write_aggregation'>write_aggregation</span><span class='comma'>,</span> <span class='id identifier rubyid_deprioritized'>deprioritized</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span>).<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_pool'>pool</span>.<span class='id identifier rubyid_ready?'>ready?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Server selector returning a server with a pool which is not ready</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="select_server_impl-instance_method">
  <h3 class='signature priv'>
    #<strong>select_server_impl</strong>(cluster, ping, session, write_aggregation, deprioritized, csot_timeout)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Parameters and return values are the same as for select_server, only the <code>timeout</code> param is renamed to <code>csot_timeout</code>.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L200-L335'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='200' data-end='335'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 200</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_private'>private</span> <span class='kw'>def</span> <span class='id identifier rubyid_select_server_impl'>select_server_impl</span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_ping'>ping</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_write_aggregation'>write_aggregation</span><span class='comma'>,</span> <span class='id identifier rubyid_deprioritized'>deprioritized</span><span class='comma'>,</span> <span class='id identifier rubyid_csot_timeout'>csot_timeout</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_topology'>topology</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../Cluster.html" title="Mongo::Cluster (class)">Cluster</a></span><span class='op'>::</span><span class='const'><a href="../Cluster/Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span><span class='op'>::</span><span class='const'><a href="../Cluster/Topology/LoadBalanced.html" title="Mongo::Cluster::Topology::LoadBalanced (class)">LoadBalanced</a></span>)
    <span class='kw'>return</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_servers'>servers</span>.<span class='id identifier rubyid_first'>first</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::ServerSelector::Base#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_server_selection_timeout'><a href="#server_selection_timeout-instance_method" title="Mongo::ServerSelector::Base#server_selection_timeout (method)">server_selection_timeout</a></span>] <span class='op'>||</span> <span class='const'><a href="../ServerSelector.html#SERVER_SELECTION_TIMEOUT-constant" title="Mongo::ServerSelector::SERVER_SELECTION_TIMEOUT (constant)">SERVER_SELECTION_TIMEOUT</a></span>

  <span class='id identifier rubyid_server_selection_timeout'><a href="#server_selection_timeout-instance_method" title="Mongo::ServerSelector::Base#server_selection_timeout (method)">server_selection_timeout</a></span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_csot_timeout'>csot_timeout</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_csot_timeout'>csot_timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span>
                               [<span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='id identifier rubyid_csot_timeout'>csot_timeout</span>].<span class='id identifier rubyid_min'>min</span>
                             <span class='kw'>else</span>
                               <span class='id identifier rubyid_timeout'>timeout</span>
                             <span class='kw'>end</span>

  <span class='comment'># Special handling for zero timeout: if we have to select a server,
</span>  <span class='comment'># and the timeout is zero, fail immediately (since server selection
</span>  <span class='comment'># will take some non-zero amount of time in any case).
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_server_selection_timeout'><a href="#server_selection_timeout-instance_method" title="Mongo::ServerSelector::Base#server_selection_timeout (method)">server_selection_timeout</a></span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failing server selection due to zero timeout. </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> Requested </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> in cluster: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_summary'>summary</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span>.<span class='id identifier rubyid_new'><a href="../Error/NoServerAvailable.html#new-class_method" title="Mongo::Error::NoServerAvailable.new (method)">new</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>=</span> <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>+</span> <span class='id identifier rubyid_server_selection_timeout'><a href="#server_selection_timeout-instance_method" title="Mongo::ServerSelector::Base#server_selection_timeout (method)">server_selection_timeout</a></span>

  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_pinned_server'>pinned_server</span>
    <span class='kw'>if</span> <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_sharded?'>sharded?</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Session has a pinned server in a non-sharded topology: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'>topology</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
      <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_unpin'>unpin</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_pinned_server'>pinned_server</span>
      <span class='comment'># Here we assume that a mongos stays in the topology indefinitely.
</span>      <span class='comment'># This will no longer be the case once SRV polling is implemented.
</span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_mongos?'>mongos?</span>
        <span class='kw'>while</span> (<span class='id identifier rubyid_time_remaining'>time_remaining</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>) <span class='op'>&gt;</span> <span class='int'>0</span>
          <span class='id identifier rubyid_wait_for_server_selection'><a href="#wait_for_server_selection-instance_method" title="Mongo::ServerSelector::Base#wait_for_server_selection (method)">wait_for_server_selection</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_time_remaining'>time_remaining</span>)
        <span class='kw'>end</span>

        <span class='kw'>unless</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_mongos?'>mongos?</span>
          <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The session being used is pinned to the server which is not a mongos: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_summary'>summary</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(after </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server_selection_timeout'><a href="#server_selection_timeout-instance_method" title="Mongo::ServerSelector::Base#server_selection_timeout (method)">server_selection_timeout</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> seconds)</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span>.<span class='id identifier rubyid_new'><a href="../Error/NoServerAvailable.html#new-class_method" title="Mongo::Error::NoServerAvailable.new (method)">new</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span>)
        <span class='kw'>end</span>
      <span class='kw'>end</span>

      <span class='kw'>return</span> <span class='id identifier rubyid_server'>server</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_replica_set?'>replica_set?</span>
    <span class='id identifier rubyid_validate_max_staleness_value_early!'><a href="#validate_max_staleness_value_early!-instance_method" title="Mongo::ServerSelector::Base#validate_max_staleness_value_early! (method)">validate_max_staleness_value_early!</a></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_addresses'>addresses</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='kw'>if</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_servers'>servers</span>.<span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cluster has no addresses but has servers: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_servers'>servers</span>.<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_inspect'><a href="#inspect-instance_method" title="Mongo::ServerSelector::Base#inspect (method)">inspect</a></span>).<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span>)<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cluster has no addresses, and therefore will never have a server</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span>.<span class='id identifier rubyid_new'><a href="../Error/NoServerAvailable.html#new-class_method" title="Mongo::Error::NoServerAvailable.new (method)">new</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span>)
  <span class='kw'>end</span>

<span class='embdoc_beg'>=begin Add this check in version 3.0.0
</span><span class='embdoc'>  unless cluster.connected?
</span><span class='embdoc'>    msg = &#39;Cluster is disconnected&#39;
</span><span class='embdoc'>    raise Error::NoServerAvailable.new(self, cluster, msg)
</span><span class='embdoc'>  end
</span><span class='embdoc_end'>=end
</span>
  <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>
      <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_servers'>servers</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
        <span class='comment'># TODO: Add this back in RUBY-3174.
</span>        <span class='comment'># if !server.unknown? &amp;&amp; !server.connected?
</span>        <span class='comment'>#   raise Error::LintError, &quot;Server #{server.summary} is known but is not connected&quot;
</span>        <span class='comment'># end
</span>        <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_unknown?'>unknown?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_pool'>pool</span>.<span class='id identifier rubyid_ready?'>ready?</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_summary'>summary</span><span class='embexpr_end'>}</span><span class='tstring_content'> is known but has non-ready pool</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_try_select_server'><a href="#try_select_server-instance_method" title="Mongo::ServerSelector::Base#try_select_server (method)">try_select_server</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='label'>write_aggregation:</span> <span class='id identifier rubyid_write_aggregation'>write_aggregation</span><span class='comma'>,</span> <span class='label'>deprioritized:</span> <span class='id identifier rubyid_deprioritized'>deprioritized</span>)

    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_topology'>topology</span>.<span class='id identifier rubyid_compatible?'>compatible?</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/UnsupportedFeatures.html" title="Mongo::Error::UnsupportedFeatures (class)">UnsupportedFeatures</a></span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_topology'>topology</span>.<span class='id identifier rubyid_compatibility_error'>compatibility_error</span>.<span class='id identifier rubyid_to_s'>to_s</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_starting_transaction?'>starting_transaction?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_sharded?'>sharded?</span>
        <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_pin_to_server'>pin_to_server</span>(<span class='id identifier rubyid_server'>server</span>)
      <span class='kw'>end</span>

      <span class='kw'>return</span> <span class='id identifier rubyid_server'>server</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_scan!'>scan!</span>(<span class='kw'>false</span>)

    <span class='id identifier rubyid_time_remaining'>time_remaining</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_time_remaining'>time_remaining</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_wait_for_server_selection'><a href="#wait_for_server_selection-instance_method" title="Mongo::ServerSelector::Base#wait_for_server_selection (method)">wait_for_server_selection</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_time_remaining'>time_remaining</span>)

      <span class='comment'># If we wait for server selection, perform another round of
</span>      <span class='comment'># attempting to locate a suitable server. Otherwise server selection
</span>      <span class='comment'># can raise NoServerAvailable message when the diagnostics
</span>      <span class='comment'># reports an available server of the requested type.
</span>    <span class='kw'>else</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> server</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>if</span> <span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span><span class='op'>::</span><span class='const'><a href="Secondary.html" title="Mongo::ServerSelector::Secondary (class)">Secondary</a></span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_tag_sets'><a href="#tag_sets-instance_method" title="Mongo::ServerSelector::Base#tag_sets (method)">tag_sets</a></span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> with tag sets: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_tag_sets'><a href="#tag_sets-instance_method" title="Mongo::ServerSelector::Base#tag_sets (method)">tag_sets</a></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> is available in cluster: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_summary'>summary</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>with timeout=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server_selection_timeout'><a href="#server_selection_timeout-instance_method" title="Mongo::ServerSelector::Base#server_selection_timeout (method)">server_selection_timeout</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LT=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_local_threshold_with_cluster'><a href="#local_threshold_with_cluster-instance_method" title="Mongo::ServerSelector::Base#local_threshold_with_cluster (method)">local_threshold_with_cluster</a></span>(<span class='id identifier rubyid_cluster'>cluster</span>)<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+=</span> <span class='id identifier rubyid_server_selection_diagnostic_message'><a href="#server_selection_diagnostic_message-instance_method" title="Mongo::ServerSelector::Base#server_selection_diagnostic_message (method)">server_selection_diagnostic_message</a></span>(<span class='id identifier rubyid_cluster'>cluster</span>)
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span>.<span class='id identifier rubyid_new'><a href="../Error/NoServerAvailable.html#new-class_method" title="Mongo::Error::NoServerAvailable.new (method)">new</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span>)
<span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_in_transaction?'>in_transaction?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_committing_transaction?'>committing_transaction?</span>
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_label'>add_label</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TransientTransactionError</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_committing_transaction?'>committing_transaction?</span>
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_label'>add_label</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UnknownTransactionCommitResult</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>end</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="server_selection_diagnostic_message-instance_method">
  <h3 class='signature priv'>
    #<strong>server_selection_diagnostic_message</strong>(cluster)  &#x21d2; <code>String</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Creates a diagnostic message when server selection fails.</p>

<p>The diagnostic message includes the following information, as applicable:</p>
<ul><li>
<p>Servers having dead monitor threads</p>
</li><li>
<p><a href="../Cluster.html" title="Mongo::Cluster (class)"><code>::Mongo::Cluster</code></a> is disconnected</p>
</li></ul>

<p>If none of the conditions for diagnostic messages apply, an empty string is returned.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>cluster</span>
    <span class='type'>(<a href="../Cluster.html" title="Mongo::Cluster (class)">Cluster</a>)</span>
&mdash;    <div class='inline'>
<p>The cluster on which server selection was performed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>The diagnostic message.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L695-L711'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='695' data-end='711'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 695</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_server_selection_diagnostic_message'>server_selection_diagnostic_message</span>(<span class='id identifier rubyid_cluster'>cluster</span>)
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_dead_monitors'>dead_monitors</span> <span class='op'>=</span> []
  <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_servers_list'>servers_list</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='id identifier rubyid_thread'>thread</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_monitor'>monitor</span>.<span class='id identifier rubyid_instance_variable_get'>instance_variable_get</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@thread</span><span class='tstring_end'>&#39;</span></span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_thread'>thread</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='op'>!</span><span class='id identifier rubyid_thread'>thread</span>.<span class='id identifier rubyid_alive?'>alive?</span>
      <span class='id identifier rubyid_dead_monitors'>dead_monitors</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_server'>server</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_dead_monitors'>dead_monitors</span>.<span class='id identifier rubyid_any?'>any?</span>
    <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>. The following servers have dead monitor threads: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_dead_monitors'>dead_monitors</span>.<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_summary'>summary</span>).<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span>)<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_connected?'>connected?</span>
    <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>. The cluster is disconnected (client may have been closed)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_msg'>msg</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="server_selection_timeout-instance_method">
  <h3 class='signature deprecated'>
    #<strong>server_selection_timeout</strong>  &#x21d2; <code>Float</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <div class="note deprecated"><strong>Deprecated.</strong> <div class='inline'>
<p>This setting is now taken from the cluster options when a server is selected. Will be removed in version 3.0.</p>
</div></div>

<p>Get the timeout for server selection.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Get the server selection timeout, in seconds.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_selector'>selector</span>.<span class='id identifier rubyid_server_selection_timeout'>server_selection_timeout</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Float</code>)</span>
&mdash;    <div class='inline'>
<p>The timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L89-L92'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='89' data-end='92'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 89</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_server_selection_timeout'>server_selection_timeout</span>
  <span class='ivar'>@server_selection_timeout</span> <span class='op'>||=</span>
    (<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::ServerSelector::Base#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_server_selection_timeout'>server_selection_timeout</span>] <span class='op'>||</span> <span class='const'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span><span class='op'>::</span><span class='const'><a href="../ServerSelector.html#SERVER_SELECTION_TIMEOUT-constant" title="Mongo::ServerSelector::SERVER_SELECTION_TIMEOUT (constant)">SERVER_SELECTION_TIMEOUT</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="suitable_server-instance_method">
  <h3 class='signature priv'>
    #<strong>suitable_server</strong>(servers, deprioritized)  &#x21d2; <a href="../Server.html" title="Mongo::Server (class)">Server</a> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns a server from the list of servers that is suitable for executing the operation.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>servers</span>
    <span class='type'>(<code>Array</code>&lt;<a href="../Server.html" title="Mongo::Server (class)">Server</a>&gt;)</span>
&mdash;    <div class='inline'>
<p>The candidate servers.</p>
</div>
  </li>
  <li>
    <span class='name'>deprioritized</span>
    <span class='type'>(<code>Array</code>&lt;<a href="../Server.html" title="Mongo::Server (class)">Server</a>&gt;)</span>
&mdash;    <div class='inline'>
<p>A list of servers that should be selected from only if no other servers are available.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Server.html" title="Mongo::Server (class)">Server</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The suitable server or nil if no suitable server is available.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L454-L461'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='454' data-end='461'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 454</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_suitable_server'>suitable_server</span>(<span class='id identifier rubyid_servers'>servers</span><span class='comma'>,</span> <span class='id identifier rubyid_deprioritized'>deprioritized</span>)
  <span class='id identifier rubyid_preferred'>preferred</span> <span class='op'>=</span> <span class='id identifier rubyid_servers'>servers</span> <span class='op'>-</span> <span class='id identifier rubyid_deprioritized'>deprioritized</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_preferred'>preferred</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_servers'>servers</span>.<span class='id identifier rubyid_first'>first</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_preferred'>preferred</span>.<span class='id identifier rubyid_first'>first</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="suitable_servers-instance_method">
  <h3 class='signature nodoc'>
    #<strong>suitable_servers</strong>(cluster)  &#x21d2; <code>Array</code>&lt;<a href="../Server.html" title="Mongo::Server (class)">Server</a>&gt; 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns servers satisfying the server selector from the cluster.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>cluster</span>
    <span class='type'>(<a href="../Cluster.html" title="Mongo::Cluster (class)">Cluster</a>)</span>
&mdash;    <div class='inline'>
<p>The cluster.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>&lt;<a href="../Server.html" title="Mongo::Server (class)">Server</a>&gt;)</span>
&mdash;    <div class='inline'>
<p>The suitable servers.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L427-L441'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='427' data-end='441'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 427</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_suitable_servers'>suitable_servers</span>(<span class='id identifier rubyid_cluster'>cluster</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_single?'>single?</span>
    <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>(<span class='id identifier rubyid_cluster'>cluster</span>)
  <span class='kw'>elsif</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_sharded?'>sharded?</span>
    <span class='id identifier rubyid_local_threshold'><a href="#local_threshold-instance_method" title="Mongo::ServerSelector::Base#local_threshold (method)">local_threshold</a></span> <span class='op'>=</span> <span class='id identifier rubyid_local_threshold_with_cluster'><a href="#local_threshold_with_cluster-instance_method" title="Mongo::ServerSelector::Base#local_threshold_with_cluster (method)">local_threshold_with_cluster</a></span>(<span class='id identifier rubyid_cluster'>cluster</span>)
    <span class='id identifier rubyid_servers'>servers</span> <span class='op'>=</span> <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>(<span class='id identifier rubyid_cluster'>cluster</span>)
    <span class='id identifier rubyid_near_servers'><a href="#near_servers-instance_method" title="Mongo::ServerSelector::Base#near_servers (method)">near_servers</a></span>(<span class='id identifier rubyid_servers'>servers</span><span class='comma'>,</span> <span class='id identifier rubyid_local_threshold'><a href="#local_threshold-instance_method" title="Mongo::ServerSelector::Base#local_threshold (method)">local_threshold</a></span>)
  <span class='kw'>elsif</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_replica_set?'>replica_set?</span>
    <span class='id identifier rubyid_validate_max_staleness_value!'><a href="#validate_max_staleness_value!-instance_method" title="Mongo::ServerSelector::Base#validate_max_staleness_value! (method)">validate_max_staleness_value!</a></span>(<span class='id identifier rubyid_cluster'>cluster</span>)
    <span class='id identifier rubyid_candidates'><a href="#candidates-instance_method" title="Mongo::ServerSelector::Base#candidates (method)">candidates</a></span>(<span class='id identifier rubyid_cluster'>cluster</span>)
  <span class='kw'>else</span>
    <span class='comment'># Unknown cluster - no servers
</span>    []
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="try_select_server-instance_method">
  <h3 class='signature nodoc'>
    #<strong>try_select_server</strong>(cluster, write_aggregation: false, deprioritized: [])  &#x21d2; <a href="../Server.html" title="Mongo::Server (class)">Server</a> | <code>nil</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Tries to find a suitable server, returns the server if one is available or nil if there isn’t a suitable server.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>cluster</span>
    <span class='type'>(<a href="../Cluster.html" title="Mongo::Cluster (class)">Mongo::Cluster</a>)</span>
&mdash;    <div class='inline'>
<p>The cluster from which to select an eligible server.</p>
</div>
  </li>
  <li>
    <span class='name'>write_aggregation</span>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether we need a server that supports writing aggregations (e.g. with $merge/$out) on secondaries.</p>
</div>
  </li>
  <li>
    <span class='name'>deprioritized</span>
    <span class='type'>(<code>Array</code>&lt;<a href="../Server.html" title="Mongo::Server (class)">Server</a>&gt;)</span>
&mdash;    <div class='inline'>
<p>A list of servers that should be selected from only if no other servers are available. This is used to avoid selecting the same server twice in a row when retrying a command.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Server.html" title="Mongo::Server (class)">Server</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>A suitable server, if one exists.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L352-L391'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='352' data-end='391'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 352</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_try_select_server'>try_select_server</span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='label'>write_aggregation:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>deprioritized:</span> [])
  <span class='id identifier rubyid_servers'>servers</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_write_aggregation'>write_aggregation</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_replica_set?'>replica_set?</span>
    <span class='comment'># 1. Check if ALL servers in cluster support secondary writes.
</span>    <span class='id identifier rubyid_is_write_supported'>is_write_supported</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_servers'>servers</span>.<span class='id identifier rubyid_reduce'>reduce</span>(<span class='kw'>true</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_res'>res</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
      <span class='id identifier rubyid_res'>res</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_merge_out_on_secondary_enabled?'>merge_out_on_secondary_enabled?</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_is_write_supported'>is_write_supported</span>
      <span class='comment'># 2. If all servers support secondary writes, we respect read preference.
</span>      <span class='id identifier rubyid_suitable_servers'><a href="#suitable_servers-instance_method" title="Mongo::ServerSelector::Base#suitable_servers (method)">suitable_servers</a></span>(<span class='id identifier rubyid_cluster'>cluster</span>)
    <span class='kw'>else</span>
      <span class='comment'># 3. Otherwise we fallback to primary for replica set.
</span>      [<span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_servers'>servers</span>.<span class='id identifier rubyid_detect'>detect</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_primary?'>primary?</span>)]
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_suitable_servers'><a href="#suitable_servers-instance_method" title="Mongo::ServerSelector::Base#suitable_servers (method)">suitable_servers</a></span>(<span class='id identifier rubyid_cluster'>cluster</span>)
  <span class='kw'>end</span>

  <span class='comment'># This list of servers may be ordered in a specific way
</span>  <span class='comment'># by the selector (e.g. for secondary preferred, the first
</span>  <span class='comment'># server may be a secondary and the second server may be primary)
</span>  <span class='comment'># and we should take the first server here respecting the order
</span>  <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_suitable_server'><a href="#suitable_server-instance_method" title="Mongo::ServerSelector::Base#suitable_server (method)">suitable_server</a></span>(<span class='id identifier rubyid_servers'>servers</span><span class='comma'>,</span> <span class='id identifier rubyid_deprioritized'>deprioritized</span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>
    <span class='kw'>if</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>
      <span class='comment'># It is possible for a server to have a nil average RTT here
</span>      <span class='comment'># because the ARTT comes from description which may be updated
</span>      <span class='comment'># by a background thread while server selection is running.
</span>      <span class='comment'># Currently lint mode is not a public feature, if/when this
</span>      <span class='comment'># changes (https://jira.mongodb.org/browse/RUBY-1576) the
</span>      <span class='comment'># requirement for ARTT to be not nil would need to be removed.
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_average_round_trip_time'>average_round_trip_time</span>.<span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_content'> has nil average rtt</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_server'>server</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate!-instance_method">
  <h3 class='signature priv'>
    #<strong>validate!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L597-L617'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='597' data-end='617'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 597</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate!'>validate!</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@tag_sets</span>.<span class='id identifier rubyid_all?'>all?</span> { <span class='op'>|</span><span class='id identifier rubyid_set'>set</span><span class='op'>|</span> <span class='id identifier rubyid_set'>set</span>.<span class='id identifier rubyid_empty?'>empty?</span> } <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_tags_allowed?'>tags_allowed?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span>.<span class='id identifier rubyid_new'><a href="../Error/InvalidServerPreference.html#new-class_method" title="Mongo::Error::InvalidServerPreference.new (method)">new</a></span>(<span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html#NO_TAG_SUPPORT-constant" title="Mongo::Error::InvalidServerPreference::NO_TAG_SUPPORT (constant)">NO_TAG_SUPPORT</a></span>)
  <span class='kw'>elsif</span> <span class='ivar'>@max_staleness</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_max_staleness_allowed?'>max_staleness_allowed?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span>.<span class='id identifier rubyid_new'><a href="../Error/InvalidServerPreference.html#new-class_method" title="Mongo::Error::InvalidServerPreference.new (method)">new</a></span>(<span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html#NO_MAX_STALENESS_SUPPORT-constant" title="Mongo::Error::InvalidServerPreference::NO_MAX_STALENESS_SUPPORT (constant)">NO_MAX_STALENESS_SUPPORT</a></span>)
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='ivar'>@hedge</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_hedge_allowed?'>hedge_allowed?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span>.<span class='id identifier rubyid_new'><a href="../Error/InvalidServerPreference.html#new-class_method" title="Mongo::Error::InvalidServerPreference.new (method)">new</a></span>(<span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html#NO_HEDGE_SUPPORT-constant" title="Mongo::Error::InvalidServerPreference::NO_HEDGE_SUPPORT (constant)">NO_HEDGE_SUPPORT</a></span>)
    <span class='kw'>end</span>

    <span class='kw'>unless</span> <span class='ivar'>@hedge</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'>Hash</span>) <span class='op'>&amp;&amp;</span> <span class='ivar'>@hedge</span>.<span class='id identifier rubyid_key?'>key?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_enabled'>enabled</span>) <span class='op'>&amp;&amp;</span>
        [<span class='kw'>true</span><span class='comma'>,</span> <span class='kw'>false</span>].<span class='id identifier rubyid_include?'>include?</span>(<span class='ivar'>@hedge</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_enabled'>enabled</span>])
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span>.<span class='id identifier rubyid_new'><a href="../Error/InvalidServerPreference.html#new-class_method" title="Mongo::Error::InvalidServerPreference.new (method)">new</a></span>(
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>`hedge` value (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hedge'><a href="#hedge-instance_method" title="Mongo::ServerSelector::Base#hedge (method)">hedge</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>) is invalid - hedge must be a Hash in the </span><span class='tstring_end'>&quot;</span></span> \
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>format { enabled: true }</span><span class='tstring_end'>&quot;</span></span>
      )
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_max_staleness_support!-instance_method">
  <h3 class='signature priv'>
    #<strong>validate_max_staleness_support!</strong>(server)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L619-L623'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='619' data-end='623'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 619</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_max_staleness_support!'>validate_max_staleness_support!</span>(<span class='id identifier rubyid_server'>server</span>)
  <span class='kw'>if</span> <span class='ivar'>@max_staleness</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_max_staleness_enabled?'>max_staleness_enabled?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span>.<span class='id identifier rubyid_new'><a href="../Error/InvalidServerPreference.html#new-class_method" title="Mongo::Error::InvalidServerPreference.new (method)">new</a></span>(<span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html#NO_MAX_STALENESS_WITH_LEGACY_SERVER-constant" title="Mongo::Error::InvalidServerPreference::NO_MAX_STALENESS_WITH_LEGACY_SERVER (constant)">NO_MAX_STALENESS_WITH_LEGACY_SERVER</a></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_max_staleness_value!-instance_method">
  <h3 class='signature priv'>
    #<strong>validate_max_staleness_value!</strong>(cluster)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L635-L648'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='635' data-end='648'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 635</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_max_staleness_value!'>validate_max_staleness_value!</span>(<span class='id identifier rubyid_cluster'>cluster</span>)
  <span class='kw'>if</span> <span class='ivar'>@max_staleness</span>
    <span class='id identifier rubyid_heartbeat_interval'>heartbeat_interval</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_heartbeat_interval'>heartbeat_interval</span>
    <span class='kw'>unless</span> <span class='ivar'>@max_staleness</span> <span class='op'>&gt;=</span> [
      <span class='const'><a href="../ServerSelector.html#SMALLEST_MAX_STALENESS_SECONDS-constant" title="Mongo::ServerSelector::SMALLEST_MAX_STALENESS_SECONDS (constant)">SMALLEST_MAX_STALENESS_SECONDS</a></span><span class='comma'>,</span>
      <span class='id identifier rubyid_min_cluster_staleness'>min_cluster_staleness</span> <span class='op'>=</span> <span class='id identifier rubyid_heartbeat_interval'>heartbeat_interval</span> <span class='op'>+</span> <span class='const'><a href="../Cluster.html" title="Mongo::Cluster (class)">Cluster</a></span><span class='op'>::</span><span class='const'><a href="../Cluster.html#IDLE_WRITE_PERIOD_SECONDS-constant" title="Mongo::Cluster::IDLE_WRITE_PERIOD_SECONDS (constant)">IDLE_WRITE_PERIOD_SECONDS</a></span><span class='comma'>,</span>
    ].<span class='id identifier rubyid_max'>max</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>`max_staleness` value (</span><span class='embexpr_beg'>#{</span><span class='ivar'>@max_staleness</span><span class='embexpr_end'>}</span><span class='tstring_content'>) is too small - it must be at least </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>`Mongo::ServerSelector::SMALLEST_MAX_STALENESS_SECONDS` (</span><span class='embexpr_beg'>#{</span><span class='const'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span><span class='op'>::</span><span class='const'><a href="../ServerSelector.html#SMALLEST_MAX_STALENESS_SECONDS-constant" title="Mongo::ServerSelector::SMALLEST_MAX_STALENESS_SECONDS (constant)">SMALLEST_MAX_STALENESS_SECONDS</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>) and (the cluster&#39;s heartbeat_frequency </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>setting + `Mongo::Cluster::IDLE_WRITE_PERIOD_SECONDS`) (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_min_cluster_staleness'>min_cluster_staleness</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span>.<span class='id identifier rubyid_new'><a href="../Error/InvalidServerPreference.html#new-class_method" title="Mongo::Error::InvalidServerPreference.new (method)">new</a></span>(<span class='id identifier rubyid_msg'>msg</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_max_staleness_value_early!-instance_method">
  <h3 class='signature priv'>
    #<strong>validate_max_staleness_value_early!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L625-L633'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='625' data-end='633'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 625</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_max_staleness_value_early!'>validate_max_staleness_value_early!</span>
  <span class='kw'>if</span> <span class='ivar'>@max_staleness</span>
    <span class='kw'>unless</span> <span class='ivar'>@max_staleness</span> <span class='op'>&gt;=</span> <span class='const'><a href="../ServerSelector.html#SMALLEST_MAX_STALENESS_SECONDS-constant" title="Mongo::ServerSelector::SMALLEST_MAX_STALENESS_SECONDS (constant)">SMALLEST_MAX_STALENESS_SECONDS</a></span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>`max_staleness` value (</span><span class='embexpr_beg'>#{</span><span class='ivar'>@max_staleness</span><span class='embexpr_end'>}</span><span class='tstring_content'>) is too small - it must be at least </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>`Mongo::ServerSelector::SMALLEST_MAX_STALENESS_SECONDS` (</span><span class='embexpr_beg'>#{</span><span class='const'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span><span class='op'>::</span><span class='const'><a href="../ServerSelector.html#SMALLEST_MAX_STALENESS_SECONDS-constant" title="Mongo::ServerSelector::SMALLEST_MAX_STALENESS_SECONDS (constant)">SMALLEST_MAX_STALENESS_SECONDS</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">InvalidServerPreference</a></span>.<span class='id identifier rubyid_new'><a href="../Error/InvalidServerPreference.html#new-class_method" title="Mongo::Error::InvalidServerPreference.new (method)">new</a></span>(<span class='id identifier rubyid_msg'>msg</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="wait_for_server_selection-instance_method">
  <h3 class='signature priv'>
    #<strong>wait_for_server_selection</strong>(cluster, time_remaining)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Waits for server state changes in the specified cluster.</p>

<p>If the cluster has a server selection semaphore, waits on that semaphore up to the specified remaining time. Any change in server state resulting from SDAM will immediately wake up this method and cause it to return.</p>

<p>If the cluster does not have a server selection semaphore, waits the smaller of 0.25 seconds and the specified remaining time. This functionality is provided for backwards compatibility only for applications directly invoking the server selection process. If lint mode is enabled and the cluster does not have a server selection semaphore, <a href="../Error/LintError.html" title="Mongo::Error::LintError (class)"><code>::Mongo::Error::LintError</code></a> will be raised.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>cluster</span>
    <span class='type'>(<a href="../Cluster.html" title="Mongo::Cluster (class)">Cluster</a>)</span>
&mdash;    <div class='inline'>
<p>The cluster to wait for.</p>
</div>
  </li>
  <li>
    <span class='name'>time_remaining</span>
    <span class='type'>(<code>Numeric</code>)</span>
&mdash;    <div class='inline'>
<p>Maximum time to wait, in seconds.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server_selector/base.rb#L666-L679'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='666' data-end='679'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server_selector/base.rb', line 666</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_for_server_selection'>wait_for_server_selection</span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_time_remaining'>time_remaining</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_server_selection_semaphore'>server_selection_semaphore</span>
    <span class='comment'># Since the semaphore may have been signaled between us checking
</span>    <span class='comment'># the servers list earlier and the wait call below, we should not
</span>    <span class='comment'># wait for the full remaining time - wait for up to 0.5 second, then
</span>    <span class='comment'># recheck the state.
</span>    <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_server_selection_semaphore'>server_selection_semaphore</span>.<span class='id identifier rubyid_wait'>wait</span>([<span class='id identifier rubyid_time_remaining'>time_remaining</span><span class='comma'>,</span> <span class='float'>0.5</span>].<span class='id identifier rubyid_min'>min</span>)
  <span class='kw'>else</span>
    <span class='kw'>if</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Waiting for server selection without having a server selection semaphore</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_sleep'>sleep</span> [<span class='id identifier rubyid_time_remaining'>time_remaining</span><span class='comma'>,</span> <span class='float'>0.25</span>].<span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>