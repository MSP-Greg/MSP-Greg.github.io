<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Session &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Session",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Mongo master</a> &raquo; 
      <a href='../_index.html#alpha_S'>Index (S)</a> &raquo; 
        <a href="../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Session&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Session</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a href="Session/ServerSession.html" title="Mongo::Session::ServerSession (class)"><code>ServerSession</code></a>,
        <a href="Session/SessionPool.html" title="Mongo::Session::SessionPool (class)"><code>SessionPool</code></a>      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          Forwardable
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="ClusterTime/Consumer.html" title="Mongo::ClusterTime::Consumer (module)"><code>ClusterTime::Consumer</code></a>,
          <a href="Loggable.html" title="Mongo::Loggable (module)"><code>Loggable</code></a>,
          <a href="Retryable.html" title="Mongo::Retryable (module)"><code>Retryable</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2 o'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L30'>lib/mongo/session.rb</a><span class='defines'>,<br /><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session/server_session.rb#L22'>lib/mongo/session/server_session.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session/session_pool.rb#L20'>lib/mongo/session/session_pool.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session/server_session/dirtyable.rb#L18'>lib/mongo/session/server_session/dirtyable.rb</a></span>
      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p><code>Session</code> objects are not thread-safe. An application may use a session from only one thread or process at a time.</p>
</div>
  </div>


<p>A logical session representing a set of sequential operations executed by an application that are related in some way.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='MISMATCHED_CLUSTER_ERROR_MSG-constant' class='summary_signature'>MISMATCHED_CLUSTER_ERROR_MSG =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p><a href="Error.html" title="Mongo::Error (class)"><code>Error</code></a> message indicating that the session was retrieved from a client with a different cluster than that of the client through which it is currently being used.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L289-L291'># File 'lib/mongo/session.rb', line 289</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The configuration of the client used to create this session does not match that </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span>
<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>of the client owning this operation. Please only use this session for operations through its parent </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span>
<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>client.</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
  <li>
    <span id='NO_TRANSACTION_STATE-constant' class='summary_signature'>NO_TRANSACTION_STATE =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The state of a session in which the last operation was not related to any transaction or no operations have yet occurred.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L309-L309'># File 'lib/mongo/session.rb', line 309</a>    <pre class='code ruby'><span class='symbeg'>:</span><span class='id identifier rubyid_no_transaction'>no_transaction</span></pre>
  </li>
  <li>
    <span id='SESSIONS_NOT_SUPPORTED-constant' class='summary_signature deprecated'>SESSIONS_NOT_SUPPORTED =</span>
    <div class='docstring'>
  <div class='discussion'>
    <div class="note deprecated"><strong>Deprecated.</strong> <div class='inline'></div></div>

<p><a href="Error.html" title="Mongo::Error (class)"><code>Error</code></a> message describing that sessions are not supported by the server version.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L302-L302'># File 'lib/mongo/session.rb', line 302</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Sessions are not supported by the connected servers.</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
  <li>
    <span id='SESSION_ENDED_ERROR_MSG-constant' class='summary_signature'>SESSION_ENDED_ERROR_MSG =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p><a href="Error.html" title="Mongo::Error (class)"><code>Error</code></a> message describing that the session cannot be used because it has already been ended.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L296-L296'># File 'lib/mongo/session.rb', line 296</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>This session has ended and cannot be used. Please create a new one.</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
  <li>
    <span id='STARTING_TRANSACTION_STATE-constant' class='summary_signature'>STARTING_TRANSACTION_STATE =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The state of a session in which a user has initiated a transaction but no operations within the transactions have occurred yet.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L315-L315'># File 'lib/mongo/session.rb', line 315</a>    <pre class='code ruby'><span class='symbeg'>:</span><span class='id identifier rubyid_starting_transaction'>starting_transaction</span></pre>
  </li>
  <li>
    <span id='TRANSACTION_ABORTED_STATE-constant' class='summary_signature'>TRANSACTION_ABORTED_STATE =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The state of a session in which the last operation executed was a transaction abort.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L332-L332'># File 'lib/mongo/session.rb', line 332</a>    <pre class='code ruby'><span class='symbeg'>:</span><span class='id identifier rubyid_transaction_aborted'>transaction_aborted</span></pre>
  </li>
  <li>
    <span id='TRANSACTION_COMMITTED_STATE-constant' class='summary_signature'>TRANSACTION_COMMITTED_STATE =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The state of a session in which the last operation executed was a transaction commit.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L327-L327'># File 'lib/mongo/session.rb', line 327</a>    <pre class='code ruby'><span class='symbeg'>:</span><span class='id identifier rubyid_transaction_committed'>transaction_committed</span></pre>
  </li>
  <li>
    <span id='TRANSACTION_IN_PROGRESS_STATE-constant' class='summary_signature'>TRANSACTION_IN_PROGRESS_STATE =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The state of a session in which a transaction has been started and at least one operation has occurred, but the transaction has not yet been committed or aborted.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L322-L322'># File 'lib/mongo/session.rb', line 322</a>    <pre class='code ruby'><span class='symbeg'>:</span><span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span></pre>
  </li>
  <li>
    <span id='UNLABELED_WRITE_CONCERN_CODES-constant' class='summary_signature nodoc'>UNLABELED_WRITE_CONCERN_CODES =</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L335-L338'># File 'lib/mongo/session.rb', line 335</a>    <pre class='code ruby'>[
  <span class='int'>79</span><span class='comma'>,</span>  <span class='comment'># UnknownReplWriteConcern
</span>  <span class='int'>100</span><span class='comma'>,</span> <span class='comment'># CannotSatisfyWriteConcern,
</span>].<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
</ul>
  <h3 class='inherited'><a href="Loggable.html" title="Mongo::Loggable (module)"><code>Loggable</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="Loggable.html#PREFIX-constant" title="Mongo::Loggable::PREFIX (constant)">PREFIX</a>
  </p>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(server_session, client, options = {})  &#x21d2; Session </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Initialize a <code>Session</code>.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#aborting_transaction%3F-instance_method" title="#aborting_transaction? (instance method)">#<strong>aborting_transaction?</strong>  &#x21d2; true | false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#client-instance_method" title="#client (instance method)">#<strong>client</strong>  &#x21d2; Client </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#committing_transaction%3F-instance_method" title="#committing_transaction? (instance method)">#<strong>committing_transaction?</strong>  &#x21d2; true | false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#dirty%3F-instance_method" title="#dirty? (instance method)">#<strong>dirty?</strong>  &#x21d2; true | false | nil </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#ended%3F-instance_method" title="#ended? (instance method)">#<strong>ended?</strong>  &#x21d2; true, false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Whether this session has ended.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#explicit%3F-instance_method" title="#explicit? (instance method)">#<strong>explicit?</strong>  &#x21d2; true, false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Is this session an explicit one (i.e.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#implicit%3F-instance_method" title="#implicit? (instance method)">#<strong>implicit?</strong>  &#x21d2; true, false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Is this session an implicit one (not user-created).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#in_transaction%3F-instance_method" title="#in_transaction? (instance method)">#<strong>in_transaction?</strong>  &#x21d2; true | false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Whether or not the session is currently in a transaction.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#materialized%3F-instance_method" title="#materialized? (instance method)">#<strong>materialized?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#operation_time-instance_method" title="#operation_time (instance method)">#<strong>operation_time</strong>  &#x21d2; BSON::Timestamp </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#options-instance_method" title="#options (instance method)">#<strong>options</strong>  &#x21d2; Hash </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#pinned_connection_global_id-instance_method" title="#pinned_connection_global_id (instance method)">#<strong>pinned_connection_global_id</strong>  &#x21d2; Integer | nil </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#pinned_server-instance_method" title="#pinned_server (instance method)">#<strong>pinned_server</strong>  &#x21d2; Server | nil </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature rw nodoc'>
      <a href="#recovery_token-instance_method" title="#recovery_token (instance method)">#<strong>recovery_token</strong>  &#x21d2; BSON::Document | nil </a>
    </span>
    <span class='note title rw'>rw</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#retry_reads%3F-instance_method" title="#retry_reads? (instance method)">#<strong>retry_reads?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Whether reads executed with this session can be retried according to the modern retryable reads specification.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#retry_writes%3F-instance_method" title="#retry_writes? (instance method)">#<strong>retry_writes?</strong>  &#x21d2; true, false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Will writes executed with this session be retried.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#snapshot%3F-instance_method" title="#snapshot? (instance method)">#<strong>snapshot?</strong>  &#x21d2; true | false </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature rw nodoc'>
      <a href="#snapshot_timestamp-instance_method" title="#snapshot_timestamp (instance method)">#<strong>snapshot_timestamp</strong>  </a>
    </span>
    <span class='note title rw'>rw</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#starting_transaction%3F-instance_method" title="#starting_transaction? (instance method)">#<strong>starting_transaction?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#causal_consistency%3F-instance_method" title="#causal_consistency? (instance method)">#<strong>causal_consistency?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
</ul>

<h3 class='inherited'><a href="ClusterTime/Consumer.html" title="Mongo::ClusterTime::Consumer (module)"><code>ClusterTime::Consumer</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ro' href="ClusterTime/Consumer.html#cluster_time-instance_method" title="Mongo::ClusterTime::Consumer#cluster_time (method)">#cluster_time</a></td>
      <td><div class='inline'><p>The cluster time tracked by the object including this module.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#abort_transaction-instance_method" title="#abort_transaction (instance method)">#<strong>abort_transaction</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Abort the currently active transaction without making any changes to the database.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#add_autocommit!-instance_method" title="#add_autocommit! (instance method)">#<strong>add_autocommit!</strong>(command)  &#x21d2; Hash, BSON::Document </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Add the autocommit field to a command document if applicable.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#add_start_transaction!-instance_method" title="#add_start_transaction! (instance method)">#<strong>add_start_transaction!</strong>(command)  &#x21d2; Hash, BSON::Document </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Add the startTransaction field to a command document if applicable.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#add_txn_num!-instance_method" title="#add_txn_num! (instance method)">#<strong>add_txn_num!</strong>(command)  &#x21d2; Hash, BSON::Document </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Add the transaction number to a command document if applicable.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#add_txn_opts!-instance_method" title="#add_txn_opts! (instance method)">#<strong>add_txn_opts!</strong>(command, read)  &#x21d2; Hash, BSON::Document </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Add the transactions options if applicable.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#advance_operation_time-instance_method" title="#advance_operation_time (instance method)">#<strong>advance_operation_time</strong>(new_operation_time)  &#x21d2; BSON::Timestamp </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Advance the cached operation time for this session.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#cluster-instance_method" title="#cluster (instance method)">#<strong>cluster</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#commit_transaction-instance_method" title="#commit_transaction (instance method)">#<strong>commit_transaction</strong>(options = nil)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Commit the currently active transaction on the session.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#dirty!-instance_method" title="#dirty! (instance method)">#<strong>dirty!</strong>(mark = true)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Sets the dirty state to the given value for the underlying server session.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#end_session-instance_method" title="#end_session (instance method)">#<strong>end_session</strong>  &#x21d2; nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>End this session.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#inspect-instance_method" title="#inspect (instance method)">#<strong>inspect</strong>  &#x21d2; String </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Get a formatted string for use in inspection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#materialize_if_needed-instance_method" title="#materialize_if_needed (instance method)">#<strong>materialize_if_needed</strong>  &#x21d2; Session </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>If not already set, populate a session objects’s server_session by checking out a session from the session pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#next_txn_num-instance_method" title="#next_txn_num (instance method)">#<strong>next_txn_num</strong>  &#x21d2; Integer </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Increment and return the next transaction number.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#pin_to_connection-instance_method" title="#pin_to_connection (instance method)">#<strong>pin_to_connection</strong>(connection_global_id)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Pins this session to the specified connection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#pin_to_server-instance_method" title="#pin_to_server (instance method)">#<strong>pin_to_server</strong>(server)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Pins this session to the specified server, which should be a mongos.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#process-instance_method" title="#process (instance method)">#<strong>process</strong>(result)  &#x21d2; Operation::Result </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Process a response from the server that used this session.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#session_id-instance_method" title="#session_id (instance method)">#<strong>session_id</strong>  &#x21d2; BSON::Document </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Get the server session id of this session, if the session has not been ended.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#start_transaction-instance_method" title="#start_transaction (instance method)">#<strong>start_transaction</strong>(options = nil)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Places subsequent operations in this session into a new transaction.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#suppress_read_write_concern!-instance_method" title="#suppress_read_write_concern! (instance method)">#<strong>suppress_read_write_concern!</strong>(command)  &#x21d2; Hash, BSON::Document </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Remove the read concern and/or write concern from the command if not applicable.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#txn_num-instance_method" title="#txn_num (instance method)">#<strong>txn_num</strong>  &#x21d2; Integer </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Get the current transaction number.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#txn_options-instance_method" title="#txn_options (instance method)">#<strong>txn_options</strong>  &#x21d2; Hash </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>on this session.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#txn_read_preference-instance_method" title="#txn_read_preference (instance method)">#<strong>txn_read_preference</strong>  &#x21d2; Hash </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Get the read preference the session will use in the currently active transaction.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#unpin-instance_method" title="#unpin (instance method)">#<strong>unpin</strong>(connection = nil)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Unpins this session from the pinned server or connection, if the session was pinned.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#unpin_maybe-instance_method" title="#unpin_maybe (instance method)">#<strong>unpin_maybe</strong>(error, connection = nil)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Unpins this session from the pinned server or connection, if the session was pinned and the specified exception instance and the session’s transaction state require it to be unpinned.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#update_state!-instance_method" title="#update_state! (instance method)">#<strong>update_state!</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Update the state of the session due to a (non-commit and non-abort) operation being run.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#validate!-instance_method" title="#validate! (instance method)">#<strong>validate!</strong>(client)  &#x21d2; Session </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Validate the session for use by the specified client.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#validate_read_preference!-instance_method" title="#validate_read_preference! (instance method)">#<strong>validate_read_preference!</strong>(command)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Ensure that the read preference of a command primary.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#with_transaction-instance_method" title="#with_transaction (instance method)">#<strong>with_transaction</strong>(options = nil)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Executes the provided block in a transaction, retrying as necessary.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#causal_consistency_doc-instance_method" title="#causal_consistency_doc (instance method)">#<strong>causal_consistency_doc</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns causal consistency document if the last operation time is known and causal consistency is enabled, otherwise returns nil.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#check_if_ended!-instance_method" title="#check_if_ended! (instance method)">#<strong>check_if_ended!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#check_if_no_transaction!-instance_method" title="#check_if_no_transaction! (instance method)">#<strong>check_if_no_transaction!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#check_matching_cluster!-instance_method" title="#check_matching_cluster! (instance method)">#<strong>check_matching_cluster!</strong>(client)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#check_transactions_supported!-instance_method" title="#check_transactions_supported! (instance method)">#<strong>check_transactions_supported!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#set_operation_time-instance_method" title="#set_operation_time (instance method)">#<strong>set_operation_time</strong>(result)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#txn_read_concern-instance_method" title="#txn_read_concern (instance method)">#<strong>txn_read_concern</strong>  &#x21d2; Hash </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Get the read concern the session will use when starting a transaction.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#txn_write_concern-instance_method" title="#txn_write_concern (instance method)">#<strong>txn_write_concern</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#within_states%3F-instance_method" title="#within_states? (instance method)">#<strong>within_states?</strong>(*states)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>

<h3 class='inherited'><a href="ClusterTime/Consumer.html" title="Mongo::ClusterTime::Consumer (module)"><code>ClusterTime::Consumer</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="ClusterTime/Consumer.html#advance_cluster_time-instance_method" title="Mongo::ClusterTime::Consumer#advance_cluster_time (method)">#advance_cluster_time</a></td>
      <td><div class='inline'><p>Advance the tracked cluster time document for the object including this module.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Loggable.html" title="Mongo::Loggable (module)"><code>Loggable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#log_debug-instance_method" title="Mongo::Loggable#log_debug (method)">#log_debug</a></td>
      <td><div class='inline'><p>Convenience method to log debug messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#log_error-instance_method" title="Mongo::Loggable#log_error (method)">#log_error</a></td>
      <td><div class='inline'><p>Convenience method to log error messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#log_fatal-instance_method" title="Mongo::Loggable#log_fatal (method)">#log_fatal</a></td>
      <td><div class='inline'><p>Convenience method to log fatal messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#log_info-instance_method" title="Mongo::Loggable#log_info (method)">#log_info</a></td>
      <td><div class='inline'><p>Convenience method to log info messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#log_warn-instance_method" title="Mongo::Loggable#log_warn (method)">#log_warn</a></td>
      <td><div class='inline'><p>Convenience method to log warn messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Loggable.html#logger-instance_method" title="Mongo::Loggable#logger (method)">#logger</a></td>
      <td><div class='inline'><p>Get the logger instance.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Loggable.html#_mongo_log_prefix-instance_method" title="Mongo::Loggable#_mongo_log_prefix (method)">#_mongo_log_prefix</a>,
        <a class='i_m priv' href="Loggable.html#format_message-instance_method" title="Mongo::Loggable#format_message (method)">#format_message</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Retryable.html" title="Mongo::Retryable (module)"><code>Retryable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="Retryable.html#read_worker-instance_method" title="Mongo::Retryable#read_worker (method)">#read_worker</a></td>
      <td><div class='inline'><p>Returns the read worker for handling retryable reads.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">#select_server</a></td>
      <td><div class='inline'><p>This is a separate method to make it possible for the test suite to assert that server selection is performed during retry attempts.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="Retryable.html#write_worker-instance_method" title="Mongo::Retryable#write_worker (method)">#write_worker</a></td>
      <td><div class='inline'><p>Returns the write worker for handling retryable writes.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="aborting_transaction?-instance_method">
  <h3 class='signature ro  nodoc first'>
    #<strong>aborting_transaction?</strong>  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the session is currently aborting a transaction.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L774-L776'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='774' data-end='776'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 774</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_aborting_transaction?'>aborting_transaction?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='ivar'>@aborting_transaction</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="causal_consistency?-instance_method">
  <h3 class='signature ro priv'>
    #<strong>causal_consistency?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1184-L1190'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1184' data-end='1190'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1184</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_causal_consistency?'>causal_consistency?</span>
  <span class='ivar'>@causal_consistency</span> <span class='op'>||=</span> (<span class='kw'>if</span> <span class='ivar'>@options</span>.<span class='id identifier rubyid_key?'>key?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_causal_consistency'>causal_consistency</span>)
                             <span class='op'>!</span><span class='op'>!</span><span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_causal_consistency'>causal_consistency</span>]
                           <span class='kw'>else</span>
                             <span class='kw'>true</span>
                           <span class='kw'>end</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="client-instance_method">
  <h3 class='signature ro'>
    #<strong>client</strong>  &#x21d2; <a href="Client.html" title="Mongo::Client (class)">Client</a>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Client.html" title="Mongo::Client (class)">Client</a>)</span>
&mdash;    <div class='inline'>
<p>The client through which this session was created.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.1</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L109-L109'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='109' data-end='109'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 109</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_client'>client</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="committing_transaction?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>committing_transaction?</strong>  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the session is currently committing a transaction.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L766-L768'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='766' data-end='768'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 766</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_committing_transaction?'>committing_transaction?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='ivar'>@committing_transaction</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="dirty?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>dirty?</strong>  &#x21d2; <code>true</code> | <code>false</code> | <code>nil</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>whether the underlying server session is dirty. If no server session exists for this session, returns nil.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L139-L141'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='139' data-end='141'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 139</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_dirty?'>dirty?</span>
  <span class='ivar'>@server_session</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dirty?'>dirty?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ended?-instance_method">
  <h3 class='signature ro'>
    #<strong>ended?</strong>  &#x21d2; <code>true</code>, <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Whether this session has ended.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_ended?'>ended?</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>, <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the session has ended.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L236-L238'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='236' data-end='238'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 236</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ended?'>ended?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='ivar'>@ended</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="explicit?-instance_method">
  <h3 class='signature ro'>
    #<strong>explicit?</strong>  &#x21d2; <code>true</code>, <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Is this session an explicit one (i.e. user-created).</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Is the session explicit?</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_explicit?'>explicit?</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>, <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether this session is explicit.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L171-L173'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='171' data-end='173'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 171</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_explicit?'>explicit?</span>
  <span class='op'>!</span><span class='id identifier rubyid_implicit?'><a href="#implicit%3F-instance_method" title="Mongo::Session#implicit? (method)">implicit?</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="implicit?-instance_method">
  <h3 class='signature ro'>
    #<strong>implicit?</strong>  &#x21d2; <code>true</code>, <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Is this session an implicit one (not user-created).</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Is the session implicit?</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_implicit?'>implicit?</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>, <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether this session is implicit.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.1</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L159-L161'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='159' data-end='161'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 159</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_implicit?'>implicit?</span>
  <span class='ivar'>@implicit</span> <span class='op'>||=</span> <span class='op'>!</span><span class='op'>!</span>(<span class='ivar'>@options</span>.<span class='id identifier rubyid_key?'>key?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_implicit'>implicit</span>) <span class='op'>&amp;&amp;</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_implicit'>implicit</span>] <span class='op'>==</span> <span class='kw'>true</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="in_transaction?-instance_method">
  <h3 class='signature ro'>
    #<strong>in_transaction?</strong>  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Whether or not the session is currently in a transaction.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Is the session in a transaction?</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_in_transaction?'>in_transaction?</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether or not the session in a transaction.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L758-L760'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='758' data-end='760'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 758</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
  <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span><span class='comma'>,</span> <span class='const'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="materialized?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>materialized?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1097-L1103'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1097' data-end='1103'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1097</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_materialized?'>materialized?</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_ended?'><a href="#ended%3F-instance_method" title="Mongo::Session#ended? (method)">ended?</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/SessionEnded.html" title="Mongo::Error::SessionEnded (class)">SessionEnded</a></span>
  <span class='kw'>end</span>

  <span class='op'>!</span><span class='ivar'>@server_session</span>.<span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="operation_time-instance_method">
  <h3 class='signature ro'>
    #<strong>operation_time</strong>  &#x21d2; <code>BSON::Timestamp</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>BSON::Timestamp</code>)</span>
&mdash;    <div class='inline'>
<p>The latest seen operation time for this session.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L124-L124'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='124' data-end='124'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 124</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_operation_time'>operation_time</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="options-instance_method">
  <h3 class='signature ro'>
    #<strong>options</strong>  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>The options for this session.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L104-L104'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='104' data-end='104'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 104</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_options'>options</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pinned_connection_global_id-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>pinned_connection_global_id</strong>  &#x21d2; <code>Integer</code> | <code>nil</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The connection global id that this session is pinned to, if any.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L277-L277'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='277' data-end='277'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 277</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pinned_connection_global_id'>pinned_connection_global_id</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pinned_server-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>pinned_server</strong>  &#x21d2; <a href="Server.html" title="Mongo::Server (class)">Server</a> | <code>nil</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Server.html" title="Mongo::Server (class)">Server</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The server (which should be a mongos) that this session is pinned to, if any.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L271-L271'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='271' data-end='271'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 271</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pinned_server'>pinned_server</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="recovery_token-instance_method">
  <h3 class='signature rw  nodoc'>
    #<strong>recovery_token</strong>  &#x21d2; <code>BSON::Document</code> | <code>nil</code>  <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>BSON::Document</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>Recovery token for the sharded transaction being executed on this session, if any.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L283-L283'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='283' data-end='283'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 283</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbeg'>:</span><span class='id identifier rubyid_recovery_token'>recovery_token</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="retry_reads?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>retry_reads?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Whether reads executed with this session can be retried according to the modern retryable reads specification.</p>

<p>If this method returns true, the modern retryable reads have been requested by the application. If the server selected for a read operation supports modern retryable reads, they will be used for that particular operation. If the server selected for a read operation does not support modern retryable reads, the read will not be retried.</p>

<p>If this method returns false, legacy retryable reads have been requested by the application. Legacy retryable read logic will be used regardless of server version of the server(s) that the client is connected to. The number of read retries is given by <code>:max_read_retries</code> client option, which is 1 by default and can be set to 0 to disable legacy read retries.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L191-L193'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='191' data-end='193'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 191</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_retry_reads?'>retry_reads?</span>
  <span class='id identifier rubyid_client'><a href="#client-instance_method" title="Mongo::Session#client (method)">client</a></span>.<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_retry_reads'>retry_reads</span>] <span class='op'>!=</span> <span class='kw'>false</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="retry_writes?-instance_method">
  <h3 class='signature ro'>
    #<strong>retry_writes?</strong>  &#x21d2; <code>true</code>, <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p><a href="Retryable.html" title="Mongo::Retryable (module)"><code>Retryable</code></a> writes are only available on server versions at least 3.6 and with sharded clusters, replica sets, or load-balanced topologies.</p>
</div>
  </div>


<p>Will writes executed with this session be retried.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Will writes be retried.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_retry_writes?'>retry_writes?</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>, <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>If writes will be retried.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L206-L208'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='206' data-end='208'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 206</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_retry_writes?'>retry_writes?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='id identifier rubyid_client'><a href="#client-instance_method" title="Mongo::Session#client (method)">client</a></span>.<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_retry_writes'>retry_writes</span>] <span class='op'>&amp;&amp;</span> (<span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_replica_set?'>replica_set?</span> <span class='op'>||</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_sharded?'>sharded?</span> <span class='op'>||</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_load_balanced?'>load_balanced?</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="snapshot?-instance_method">
  <h3 class='signature ro'>
    #<strong>snapshot?</strong>  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the session is configured for snapshot reads.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L117-L119'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='117' data-end='119'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 117</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_snapshot?'>snapshot?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_snapshot'>snapshot</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="snapshot_timestamp-instance_method">
  <h3 class='signature rw  nodoc'>
    #<strong>snapshot_timestamp</strong>   <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1139-L1139'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1139' data-end='1139'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1139</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbeg'>:</span><span class='id identifier rubyid_snapshot_timestamp'>snapshot_timestamp</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="starting_transaction?-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>starting_transaction?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L746-L748'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='746' data-end='748'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 746</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_starting_transaction?'>starting_transaction?</span>
  <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="abort_transaction-instance_method">
  <h3 class='signature  first'>
    #<strong>abort_transaction</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Abort the currently active transaction without making any changes to the database.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Abort the transaction.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_abort_transaction'>abort_transaction</span></code></pre>
  </div>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Error::InvalidTransactionOperation</a>)</span>
&mdash;    <div class='inline'>
<p>If there is no active transaction.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L691-L743'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='691' data-end='743'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 691</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_abort_transaction'>abort_transaction</span>
  <span class='const'><a href="QueryCache.html" title="Mongo::QueryCache (module)">QueryCache</a></span>.<span class='id identifier rubyid_clear'><a href="QueryCache.html#clear-class_method" title="Mongo::QueryCache.clear (method)">clear</a></span>

  <span class='id identifier rubyid_check_if_ended!'><a href="#check_if_ended!-instance_method" title="Mongo::Session#check_if_ended! (method)">check_if_ended!</a></span>
  <span class='id identifier rubyid_check_if_no_transaction!'><a href="#check_if_no_transaction!-instance_method" title="Mongo::Session#check_if_no_transaction! (method)">check_if_no_transaction!</a></span>

  <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#TRANSACTION_COMMITTED_STATE-constant" title="Mongo::Session::TRANSACTION_COMMITTED_STATE (constant)">TRANSACTION_COMMITTED_STATE</a></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidTransactionOperation.html#new-class_method" title="Mongo::Error::InvalidTransactionOperation.new (method)">new</a></span>(
      <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>.<span class='id identifier rubyid_cannot_call_after_msg'><a href="Error/InvalidTransactionOperation.html#cannot_call_after_msg-class_method" title="Mongo::Error::InvalidTransactionOperation.cannot_call_after_msg (method)">cannot_call_after_msg</a></span>(
        <span class='symbeg'>:</span><span class='id identifier rubyid_commitTransaction'>commitTransaction</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_abortTransaction'>abortTransaction</span>))
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidTransactionOperation.html#new-class_method" title="Mongo::Error::InvalidTransactionOperation.new (method)">new</a></span>(
      <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>.<span class='id identifier rubyid_cannot_call_twice_msg'><a href="Error/InvalidTransactionOperation.html#cannot_call_twice_msg-class_method" title="Mongo::Error::InvalidTransactionOperation.cannot_call_twice_msg (method)">cannot_call_twice_msg</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_abortTransaction'>abortTransaction</span>))
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_starting_transaction?'><a href="#starting_transaction%3F-instance_method" title="Mongo::Session#starting_transaction? (method)">starting_transaction?</a></span>
      <span class='ivar'>@aborting_transaction</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="Operation/Context.html" title="Mongo::Operation::Context (class)">Context</a></span>.<span class='id identifier rubyid_new'><a href="Operation/Context.html#new-class_method" title="Mongo::Operation::Context.new (method)">new</a></span>(<span class='label'>client:</span> <span class='ivar'>@client</span><span class='comma'>,</span> <span class='label'>session:</span> <span class='kw'>self</span>)
      <span class='id identifier rubyid_write_with_retry'>write_with_retry</span>(<span class='id identifier rubyid_txn_options'><a href="#txn_options-instance_method" title="Mongo::Session#txn_options (method)">txn_options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>]<span class='comma'>,</span>
        <span class='label'>ending_transaction:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span>
      ) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'><a href="#txn_num-instance_method" title="Mongo::Session#txn_num (method)">txn_num</a></span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='op'>|</span>
        <span class='kw'>begin</span>
          <span class='const'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="Operation/Command.html" title="Mongo::Operation::Command (class)">Command</a></span>.<span class='id identifier rubyid_new'><a href="Operation/Specifiable.html#initialize-instance_method" title="Mongo::Operation::Specifiable#initialize (method)">new</a></span>(
            <span class='label'>selector:</span> { <span class='label'>abortTransaction:</span> <span class='int'>1</span> }<span class='comma'>,</span>
            <span class='label'>db_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
            <span class='label'>session:</span> <span class='kw'>self</span><span class='comma'>,</span>
            <span class='label'>txn_num:</span> <span class='id identifier rubyid_txn_num'><a href="#txn_num-instance_method" title="Mongo::Session#txn_num (method)">txn_num</a></span>
          ).<span class='id identifier rubyid_execute_with_connection'>execute_with_connection</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>)
        <span class='kw'>ensure</span>
          <span class='id identifier rubyid_unpin'><a href="#unpin-instance_method" title="Mongo::Session#unpin (method)">unpin</a></span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span>
  <span class='kw'>rescue</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>rescue</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span>
  <span class='kw'>rescue</span> <span class='const'>Exception</span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>ensure</span>
    <span class='ivar'>@aborting_transaction</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='comment'># No official return value, but return true so that in interactive
</span>  <span class='comment'># use the method hints that it succeeded.
</span>  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="add_autocommit!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>add_autocommit!</strong>(command)  &#x21d2; <code>Hash</code>, <code>BSON::Document</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Add the autocommit field to a command document if applicable.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_add_autocommit!'>add_autocommit!</span>(<span class='id identifier rubyid_cmd'>cmd</span>)</code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>, <code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>The command document.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L854-L858'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='854' data-end='858'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 854</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add_autocommit!'>add_autocommit!</span>(<span class='id identifier rubyid_command'>command</span>)
  <span class='id identifier rubyid_command'>command</span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_autocommit'>autocommit</span>] <span class='op'>=</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='id identifier rubyid_in_transaction?'><a href="#in_transaction%3F-instance_method" title="Mongo::Session#in_transaction? (method)">in_transaction?</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="add_start_transaction!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>add_start_transaction!</strong>(command)  &#x21d2; <code>Hash</code>, <code>BSON::Document</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Add the startTransaction field to a command document if applicable.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_add_start_transaction!'>add_start_transaction!</span>(<span class='id identifier rubyid_cmd'>cmd</span>)</code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>, <code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>The command document.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L869-L875'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='869' data-end='875'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 869</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add_start_transaction!'>add_start_transaction!</span>(<span class='id identifier rubyid_command'>command</span>)
  <span class='id identifier rubyid_command'>command</span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_starting_transaction?'><a href="#starting_transaction%3F-instance_method" title="Mongo::Session#starting_transaction? (method)">starting_transaction?</a></span>
      <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_startTransaction'>startTransaction</span>] <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="add_txn_num!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>add_txn_num!</strong>(command)  &#x21d2; <code>Hash</code>, <code>BSON::Document</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Add the transaction number to a command document if applicable.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_add_txn_num!'>add_txn_num!</span>(<span class='id identifier rubyid_cmd'>cmd</span>)</code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>, <code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>The command document.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L886-L890'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='886' data-end='890'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 886</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add_txn_num!'>add_txn_num!</span>(<span class='id identifier rubyid_command'>command</span>)
  <span class='id identifier rubyid_command'>command</span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_txnNumber'>txnNumber</span>] <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Int64</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Session.new (method)">new</a></span>(<span class='ivar'>@server_session</span>.<span class='id identifier rubyid_txn_num'><a href="#txn_num-instance_method" title="Mongo::Session#txn_num (method)">txn_num</a></span>) <span class='kw'>if</span> <span class='id identifier rubyid_in_transaction?'><a href="#in_transaction%3F-instance_method" title="Mongo::Session#in_transaction? (method)">in_transaction?</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="add_txn_opts!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>add_txn_opts!</strong>(command, read)  &#x21d2; <code>Hash</code>, <code>BSON::Document</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Add the transactions options if applicable.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_add_txn_opts!'>add_txn_opts!</span>(<span class='id identifier rubyid_cmd'>cmd</span>)</code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>, <code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>The command document.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L901-L956'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='901' data-end='956'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 901</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add_txn_opts!'>add_txn_opts!</span>(<span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_read'>read</span>)
  <span class='id identifier rubyid_command'>command</span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='comment'># The read concern should be added to any command that starts a transaction.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_starting_transaction?'><a href="#starting_transaction%3F-instance_method" title="Mongo::Session#starting_transaction? (method)">starting_transaction?</a></span>
      <span class='comment'># https://jira.mongodb.org/browse/SPEC-1161: transaction&#39;s
</span>      <span class='comment'># read concern overrides collection/database/client read concerns,
</span>      <span class='comment'># even if transaction&#39;s read concern is not set.
</span>      <span class='comment'># Read concern here is the one sent to the server and may
</span>      <span class='comment'># include afterClusterTime.
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_rc'>rc</span> <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span>]
        <span class='id identifier rubyid_rc'>rc</span> <span class='op'>=</span> <span class='id identifier rubyid_rc'>rc</span>.<span class='id identifier rubyid_dup'>dup</span>
        <span class='id identifier rubyid_rc'>rc</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_level'>level</span>)
      <span class='kw'>end</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_txn_read_concern'><a href="#txn_read_concern-instance_method" title="Mongo::Session#txn_read_concern (method)">txn_read_concern</a></span>
        <span class='kw'>if</span> <span class='id identifier rubyid_rc'>rc</span>
          <span class='id identifier rubyid_rc'>rc</span>.<span class='id identifier rubyid_update'>update</span>(<span class='id identifier rubyid_txn_read_concern'><a href="#txn_read_concern-instance_method" title="Mongo::Session#txn_read_concern (method)">txn_read_concern</a></span>)
        <span class='kw'>else</span>
          <span class='id identifier rubyid_rc'>rc</span> <span class='op'>=</span> <span class='id identifier rubyid_txn_read_concern'><a href="#txn_read_concern-instance_method" title="Mongo::Session#txn_read_concern (method)">txn_read_concern</a></span>.<span class='id identifier rubyid_dup'>dup</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_rc'>rc</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_rc'>rc</span>.<span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_c'>c</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span>)
      <span class='kw'>else</span>
        <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span> ] <span class='op'>=</span> <span class='const'><a href="Options.html" title="Mongo::Options (module)">Options</a></span><span class='op'>::</span><span class='const'><a href="Options/Mapper.html" title="Mongo::Options::Mapper (module)">Mapper</a></span>.<span class='id identifier rubyid_transform_values_to_strings'><a href="Options/Mapper.html#transform_values_to_strings-instance_method" title="Mongo::Options::Mapper#transform_values_to_strings (method)">transform_values_to_strings</a></span>(<span class='id identifier rubyid_rc'>rc</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># We need to send the read concern level as a string rather than a symbol.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span>]
      <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span>] <span class='op'>=</span> <span class='const'><a href="Options.html" title="Mongo::Options (module)">Options</a></span><span class='op'>::</span><span class='const'><a href="Options/Mapper.html" title="Mongo::Options::Mapper (module)">Mapper</a></span>.<span class='id identifier rubyid_transform_values_to_strings'><a href="Options/Mapper.html#transform_values_to_strings-instance_method" title="Mongo::Options::Mapper#transform_values_to_strings (method)">transform_values_to_strings</a></span>(<span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span>])
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_commitTransaction'>commitTransaction</span>]
      <span class='kw'>if</span> <span class='id identifier rubyid_max_time_ms'>max_time_ms</span> <span class='op'>=</span> <span class='id identifier rubyid_txn_options'><a href="#txn_options-instance_method" title="Mongo::Session#txn_options (method)">txn_options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_commit_time_ms'>max_commit_time_ms</span>]
        <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_maxTimeMS'>maxTimeMS</span>] <span class='op'>=</span> <span class='id identifier rubyid_max_time_ms'>max_time_ms</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># The write concern should be added to any abortTransaction or commitTransaction command.
</span>    <span class='kw'>if</span> (<span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_abortTransaction'>abortTransaction</span>] <span class='op'>||</span> <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_commitTransaction'>commitTransaction</span>])
      <span class='kw'>if</span> <span class='ivar'>@already_committed</span>
        <span class='id identifier rubyid_wc'>wc</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Document</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Session.new (method)">new</a></span>(<span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_writeConcern'>writeConcern</span>] <span class='op'>||</span> <span class='id identifier rubyid_txn_write_concern'><a href="#txn_write_concern-instance_method" title="Mongo::Session#txn_write_concern (method)">txn_write_concern</a></span> <span class='op'>||</span> {})
        <span class='id identifier rubyid_wc'>wc</span>.<span class='id identifier rubyid_merge!'>merge!</span>(<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>)
        <span class='id identifier rubyid_wc'>wc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wtimeout'>wtimeout</span>] <span class='op'>||=</span> <span class='int'>10000</span>
        <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_writeConcern'>writeConcern</span>] <span class='op'>=</span> <span class='id identifier rubyid_wc'>wc</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_txn_write_concern'><a href="#txn_write_concern-instance_method" title="Mongo::Session#txn_write_concern (method)">txn_write_concern</a></span>
        <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_writeConcern'>writeConcern</span>] <span class='op'>||=</span> <span class='id identifier rubyid_txn_write_concern'><a href="#txn_write_concern-instance_method" title="Mongo::Session#txn_write_concern (method)">txn_write_concern</a></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># A non-numeric write concern w value needs to be sent as a string rather than a symbol.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_writeConcern'>writeConcern</span>] <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_writeConcern'>writeConcern</span>][<span class='symbeg'>:</span><span class='id identifier rubyid_w'>w</span>] <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_writeConcern'>writeConcern</span>][<span class='symbeg'>:</span><span class='id identifier rubyid_w'>w</span>].<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../Symbol.html" title="Symbol (class)">Symbol</a></span>)
      <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_writeConcern'>writeConcern</span>][<span class='symbeg'>:</span><span class='id identifier rubyid_w'>w</span>] <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_writeConcern'>writeConcern</span>][<span class='symbeg'>:</span><span class='id identifier rubyid_w'>w</span>].<span class='id identifier rubyid_to_s'>to_s</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="advance_operation_time-instance_method">
  <h3 class='signature '>
    #<strong>advance_operation_time</strong>(new_operation_time)  &#x21d2; <code>BSON::Timestamp</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Advance the cached operation time for this session.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Advance the operation time.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_advance_operation_time'>advance_operation_time</span>(<span class='id identifier rubyid_timestamp'>timestamp</span>)</code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>new_operation_time</span>
    <span class='type'>(<code>BSON::Timestamp</code>)</span>
&mdash;    <div class='inline'>
<p>The new operation time.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>BSON::Timestamp</code>)</span>
&mdash;    <div class='inline'>
<p>The max operation time, considering the current and new times.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1070-L1076'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1070' data-end='1076'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1070</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_advance_operation_time'>advance_operation_time</span>(<span class='id identifier rubyid_new_operation_time'>new_operation_time</span>)
  <span class='kw'>if</span> <span class='ivar'>@operation_time</span>
    <span class='ivar'>@operation_time</span> <span class='op'>=</span> [ <span class='ivar'>@operation_time</span><span class='comma'>,</span> <span class='id identifier rubyid_new_operation_time'>new_operation_time</span> ].<span class='id identifier rubyid_max'>max</span>
  <span class='kw'>else</span>
    <span class='ivar'>@operation_time</span> <span class='op'>=</span> <span class='id identifier rubyid_new_operation_time'>new_operation_time</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="causal_consistency_doc-instance_method">
  <h3 class='signature priv'>
    #<strong>causal_consistency_doc</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns causal consistency document if the last operation time is known and causal consistency is enabled, otherwise returns nil.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1176-L1182'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1176' data-end='1182'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1176</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_causal_consistency_doc'>causal_consistency_doc</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_operation_time'><a href="#operation_time-instance_method" title="Mongo::Session#operation_time (method)">operation_time</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_causal_consistency?'><a href="#causal_consistency%3F-instance_method" title="Mongo::Session#causal_consistency? (method)">causal_consistency?</a></span>
    {<span class='symbeg'>:</span><span class='id identifier rubyid_afterClusterTime'>afterClusterTime</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_operation_time'><a href="#operation_time-instance_method" title="Mongo::Session#operation_time (method)">operation_time</a></span>}
  <span class='kw'>else</span>
    <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="check_if_ended!-instance_method">
  <h3 class='signature priv'>
    #<strong>check_if_ended!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/InvalidSession.html" title="Mongo::Error::InvalidSession (class)">Mongo::Error::InvalidSession</a>)</span>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1198-L1200'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1198' data-end='1200'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1198</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_check_if_ended!'>check_if_ended!</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidSession.html" title="Mongo::Error::InvalidSession (class)">InvalidSession</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidSession.html#new-class_method" title="Mongo::Error::InvalidSession.new (method)">new</a></span>(<span class='const'><a href="#SESSION_ENDED_ERROR_MSG-constant" title="Mongo::Session::SESSION_ENDED_ERROR_MSG (constant)">SESSION_ENDED_ERROR_MSG</a></span>) <span class='kw'>if</span> <span class='id identifier rubyid_ended?'><a href="#ended%3F-instance_method" title="Mongo::Session#ended? (method)">ended?</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="check_if_no_transaction!-instance_method">
  <h3 class='signature priv'>
    #<strong>check_if_no_transaction!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Mongo::Error::InvalidTransactionOperation</a>)</span>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1162-L1167'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1162' data-end='1167'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1162</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_check_if_no_transaction!'>check_if_no_transaction!</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#NO_TRANSACTION_STATE-constant" title="Mongo::Session::NO_TRANSACTION_STATE (constant)">NO_TRANSACTION_STATE</a></span>)

  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidTransactionOperation.html#new-class_method" title="Mongo::Error::InvalidTransactionOperation.new (method)">new</a></span>(
    <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html#NO_TRANSACTION_STARTED-constant" title="Mongo::Error::InvalidTransactionOperation::NO_TRANSACTION_STARTED (constant)">NO_TRANSACTION_STARTED</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="check_matching_cluster!-instance_method">
  <h3 class='signature priv'>
    #<strong>check_matching_cluster!</strong>(client)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1202-L1206'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1202' data-end='1206'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1202</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_check_matching_cluster!'>check_matching_cluster!</span>(<span class='id identifier rubyid_client'><a href="#client-instance_method" title="Mongo::Session#client (method)">client</a></span>)
  <span class='kw'>if</span> <span class='ivar'>@client</span>.<span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span> <span class='op'>!=</span> <span class='id identifier rubyid_client'><a href="#client-instance_method" title="Mongo::Session#client (method)">client</a></span>.<span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidSession.html" title="Mongo::Error::InvalidSession (class)">InvalidSession</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidSession.html#new-class_method" title="Mongo::Error::InvalidSession.new (method)">new</a></span>(<span class='const'><a href="#MISMATCHED_CLUSTER_ERROR_MSG-constant" title="Mongo::Session::MISMATCHED_CLUSTER_ERROR_MSG (constant)">MISMATCHED_CLUSTER_ERROR_MSG</a></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="check_transactions_supported!-instance_method">
  <h3 class='signature priv'>
    #<strong>check_transactions_supported!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/TransactionsNotSupported.html" title="Mongo::Error::TransactionsNotSupported (class)">Mongo::Error::TransactionsNotSupported</a>)</span>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1208-L1219'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1208' data-end='1219'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1208</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_check_transactions_supported!'>check_transactions_supported!</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/TransactionsNotSupported.html" title="Mongo::Error::TransactionsNotSupported (class)">TransactionsNotSupported</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>standalone topology</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_single?'>single?</span>

  <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_next_primary'>next_primary</span>.<span class='id identifier rubyid_with_connection'>with_connection</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_replica_set?'>replica_set?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_transactions_enabled?'>transactions_enabled?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/TransactionsNotSupported.html" title="Mongo::Error::TransactionsNotSupported (class)">TransactionsNotSupported</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>server version is &lt; 4.0</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_sharded?'>sharded?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_sharded_transactions_enabled?'>sharded_transactions_enabled?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/TransactionsNotSupported.html" title="Mongo::Error::TransactionsNotSupported (class)">TransactionsNotSupported</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sharded transactions require server version &gt;= 4.2</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cluster-instance_method">
  <h3 class='signature '>
    #<strong>cluster</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L111-L113'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='111' data-end='113'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 111</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cluster'>cluster</span>
  <span class='ivar'>@client</span>.<span class='id identifier rubyid_cluster'>cluster</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="commit_transaction-instance_method">
  <h3 class='signature '>
    #<strong>commit_transaction</strong>(options = nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Commit the currently active transaction on the session.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Commits the transaction.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_commit_transaction'>commit_transaction</span></code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>options</span>
    <span class='type'>(<code>Hash</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>a customizable set of options</p>
</div>
  </li>
</ul>
    <p class='tag_title'>Options Hash (<tt>options</tt>):</p>
    <ul class='option'>
        <li>
          <span class='name'>:write_concern</span>
          <span class='type'>(<code>nil</code> | <a href="WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">WriteConcern::Base</a>)</span>
            &mdash; <div class='inline'>
<p>The write concern to use for this operation.</p>
</div>        </li>
    </ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Error::InvalidTransactionOperation</a>)</span>
&mdash;    <div class='inline'>
<p>If there is no active transaction.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L618-L681'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='618' data-end='681'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 618</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_commit_transaction'>commit_transaction</span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span><span class='op'>=</span><span class='kw'>nil</span>)
  <span class='const'><a href="QueryCache.html" title="Mongo::QueryCache (module)">QueryCache</a></span>.<span class='id identifier rubyid_clear'><a href="QueryCache.html#clear-class_method" title="Mongo::QueryCache.clear (method)">clear</a></span>
  <span class='id identifier rubyid_check_if_ended!'><a href="#check_if_ended!-instance_method" title="Mongo::Session#check_if_ended! (method)">check_if_ended!</a></span>
  <span class='id identifier rubyid_check_if_no_transaction!'><a href="#check_if_no_transaction!-instance_method" title="Mongo::Session#check_if_no_transaction! (method)">check_if_no_transaction!</a></span>

  <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidTransactionOperation.html#new-class_method" title="Mongo::Error::InvalidTransactionOperation.new (method)">new</a></span>(
      <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>.<span class='id identifier rubyid_cannot_call_after_msg'><a href="Error/InvalidTransactionOperation.html#cannot_call_after_msg-class_method" title="Mongo::Error::InvalidTransactionOperation.cannot_call_after_msg (method)">cannot_call_after_msg</a></span>(
        <span class='symbeg'>:</span><span class='id identifier rubyid_abortTransaction'>abortTransaction</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_commitTransaction'>commitTransaction</span>))
  <span class='kw'>end</span>

  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span> <span class='op'>||=</span> {}

  <span class='kw'>begin</span>
    <span class='comment'># If commitTransaction is called twice, we need to run the same commit
</span>    <span class='comment'># operation again, so we revert the session to the previous state.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#TRANSACTION_COMMITTED_STATE-constant" title="Mongo::Session::TRANSACTION_COMMITTED_STATE (constant)">TRANSACTION_COMMITTED_STATE</a></span>)
      <span class='ivar'>@state</span> <span class='op'>=</span> <span class='ivar'>@last_commit_skipped</span> <span class='op'>?</span> <span class='const'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span> <span class='op'>:</span> <span class='const'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span>
      <span class='ivar'>@already_committed</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_starting_transaction?'><a href="#starting_transaction%3F-instance_method" title="Mongo::Session#starting_transaction? (method)">starting_transaction?</a></span>
      <span class='ivar'>@last_commit_skipped</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>else</span>
      <span class='ivar'>@last_commit_skipped</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='ivar'>@committing_transaction</span> <span class='op'>=</span> <span class='kw'>true</span>

      <span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>] <span class='op'>||</span> <span class='id identifier rubyid_txn_options'><a href="#txn_options-instance_method" title="Mongo::Session#txn_options (method)">txn_options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>]
      <span class='kw'>if</span> <span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_write_concern'>write_concern</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span><span class='op'>::</span><span class='const'><a href="WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">Base</a></span>)
        <span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>=</span> <span class='const'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span>.<span class='id identifier rubyid_get'><a href="WriteConcern.html#get-instance_method" title="Mongo::WriteConcern#get (method)">get</a></span>(<span class='id identifier rubyid_write_concern'>write_concern</span>)
      <span class='kw'>end</span>

      <span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="Operation/Context.html" title="Mongo::Operation::Context (class)">Context</a></span>.<span class='id identifier rubyid_new'><a href="Operation/Context.html#new-class_method" title="Mongo::Operation::Context.new (method)">new</a></span>(<span class='label'>client:</span> <span class='ivar'>@client</span><span class='comma'>,</span> <span class='label'>session:</span> <span class='kw'>self</span>)
      <span class='id identifier rubyid_write_with_retry'>write_with_retry</span>(<span class='id identifier rubyid_write_concern'>write_concern</span><span class='comma'>,</span> <span class='label'>ending_transaction:</span> <span class='kw'>true</span><span class='comma'>,</span>
        <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span>
      ) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'><a href="#txn_num-instance_method" title="Mongo::Session#txn_num (method)">txn_num</a></span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_retry?'>retry?</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_write_concern'>write_concern</span>
            <span class='id identifier rubyid_wco'>wco</span> <span class='op'>=</span> <span class='id identifier rubyid_write_concern'>write_concern</span>.<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>)
            <span class='id identifier rubyid_wco'>wco</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wtimeout'>wtimeout</span>] <span class='op'>||=</span> <span class='int'>10000</span>
            <span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>=</span> <span class='const'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span>.<span class='id identifier rubyid_get'><a href="WriteConcern.html#get-instance_method" title="Mongo::WriteConcern#get (method)">get</a></span>(<span class='id identifier rubyid_wco'>wco</span>)
          <span class='kw'>else</span>
            <span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>=</span> <span class='const'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span>.<span class='id identifier rubyid_get'><a href="WriteConcern.html#get-instance_method" title="Mongo::WriteConcern#get (method)">get</a></span>(<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span><span class='comma'>,</span> <span class='label'>wtimeout:</span> <span class='int'>10000</span>)
          <span class='kw'>end</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_spec'>spec</span> <span class='op'>=</span> {
          <span class='label'>selector:</span> { <span class='label'>commitTransaction:</span> <span class='int'>1</span> }<span class='comma'>,</span>
          <span class='label'>db_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
          <span class='label'>session:</span> <span class='kw'>self</span><span class='comma'>,</span>
          <span class='label'>txn_num:</span> <span class='id identifier rubyid_txn_num'><a href="#txn_num-instance_method" title="Mongo::Session#txn_num (method)">txn_num</a></span><span class='comma'>,</span>
          <span class='label'>write_concern:</span> <span class='id identifier rubyid_write_concern'>write_concern</span><span class='comma'>,</span>
        }
        <span class='const'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="Operation/Command.html" title="Mongo::Operation::Command (class)">Command</a></span>.<span class='id identifier rubyid_new'><a href="Operation/Specifiable.html#initialize-instance_method" title="Mongo::Operation::Specifiable#initialize (method)">new</a></span>(<span class='id identifier rubyid_spec'>spec</span>).<span class='id identifier rubyid_execute_with_connection'>execute_with_connection</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>ensure</span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><a href="#TRANSACTION_COMMITTED_STATE-constant" title="Mongo::Session::TRANSACTION_COMMITTED_STATE (constant)">TRANSACTION_COMMITTED_STATE</a></span>
    <span class='ivar'>@committing_transaction</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='comment'># No official return value, but return true so that in interactive
</span>  <span class='comment'># use the method hints that it succeeded.
</span>  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="dirty!-instance_method">
  <h3 class='signature '>
    #<strong>dirty!</strong>(mark = true)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Sets the dirty state to the given value for the underlying server session. If there is no server session, this does nothing.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>mark</span>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
    <em class='default'>(defaults to: <tt>true</tt>)</em>
&mdash;    <div class='inline'>
<p>whether to mark the server session as dirty, or not.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L131-L133'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='131' data-end='133'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 131</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_dirty!'>dirty!</span>(<span class='id identifier rubyid_mark'>mark</span> <span class='op'>=</span> <span class='kw'>true</span>)
  <span class='ivar'>@server_session</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dirty!'>dirty!</span>(<span class='id identifier rubyid_mark'>mark</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="end_session-instance_method">
  <h3 class='signature '>
    #<strong>end_session</strong>  &#x21d2; <code>nil</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>End this session.</p>

<p>If there is an in-progress transaction on this session, the transaction is aborted. The server session associated with this session is returned to the server session pool. Finally, this session is marked ended and is no longer usable.</p>

<p>If this session is already ended, this method does nothing.</p>

<p>Note that this method does not directly issue an endSessions command to this server, contrary to what its name might suggest.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_end_session'>end_session</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>Always nil.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L370-L385'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='370' data-end='385'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 370</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_end_session'>end_session</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_ended?'><a href="#ended%3F-instance_method" title="Mongo::Session#ended? (method)">ended?</a></span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@client</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span>)
      <span class='kw'>begin</span>
        <span class='id identifier rubyid_abort_transaction'><a href="#abort_transaction-instance_method" title="Mongo::Session#abort_transaction (method)">abort_transaction</a></span>
      <span class='kw'>rescue</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='comma'>,</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/AuthError.html" title="Mongo::Error::AuthError (class)">AuthError</a></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='ivar'>@server_session</span>
      <span class='ivar'>@client</span>.<span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_session_pool'>session_pool</span>.<span class='id identifier rubyid_checkin'>checkin</span>(<span class='ivar'>@server_session</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>ensure</span>
  <span class='ivar'>@server_session</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@ended</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="inspect-instance_method">
  <h3 class='signature '>
    #<strong>inspect</strong>  &#x21d2; <code>String</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get a formatted string for use in inspection.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Inspect the session object.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_inspect'>inspect</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>The session inspection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L348-L350'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='348' data-end='350'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 348</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_inspect'>inspect</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;Mongo::Session:0x</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_object_id'>object_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> session_id=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_session_id'><a href="#session_id-instance_method" title="Mongo::Session#session_id (method)">session_id</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> options=</span><span class='embexpr_beg'>#{</span><span class='ivar'>@options</span><span class='embexpr_end'>}</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="materialize_if_needed-instance_method">
  <h3 class='signature nodoc'>
    #<strong>materialize_if_needed</strong>  &#x21d2; <code>Session</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>If not already set, populate a session objects’s server_session by checking out a session from the session pool.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Session</code>)</span>
&mdash;    <div class='inline'>
<p>Self.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1084-L1094'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1084' data-end='1094'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1084</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_materialize_if_needed'>materialize_if_needed</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_ended?'><a href="#ended%3F-instance_method" title="Mongo::Session#ended? (method)">ended?</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/SessionEnded.html" title="Mongo::Error::SessionEnded (class)">SessionEnded</a></span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_implicit?'><a href="#implicit%3F-instance_method" title="Mongo::Session#implicit? (method)">implicit?</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@server_session</span>

  <span class='ivar'>@server_session</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'><a href="#cluster-instance_method" title="Mongo::Session#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_session_pool'>session_pool</span>.<span class='id identifier rubyid_checkout'>checkout</span>

  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="next_txn_num-instance_method">
  <h3 class='signature nodoc'>
    #<strong>next_txn_num</strong>  &#x21d2; <code>Integer</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Increment and return the next transaction number.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Get the next transaction number.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_next_txn_num'>next_txn_num</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The next transaction number.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1114-L1120'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1114' data-end='1120'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1114</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_next_txn_num'>next_txn_num</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_ended?'><a href="#ended%3F-instance_method" title="Mongo::Session#ended? (method)">ended?</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/SessionEnded.html" title="Mongo::Error::SessionEnded (class)">SessionEnded</a></span>
  <span class='kw'>end</span>

  <span class='ivar'>@server_session</span>.<span class='id identifier rubyid_next_txn_num'>next_txn_num</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pin_to_connection-instance_method">
  <h3 class='signature nodoc'>
    #<strong>pin_to_connection</strong>(connection_global_id)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Pins this session to the specified connection.</p>

<p>this session to.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connection_global_id</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The global id of connection to pin</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L801-L806'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='801' data-end='806'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 801</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_pin_to_connection'>pin_to_connection</span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Cannot pin to a nil connection id</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
  <span class='ivar'>@pinned_connection_global_id</span> <span class='op'>=</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pin_to_server-instance_method">
  <h3 class='signature nodoc'>
    #<strong>pin_to_server</strong>(server)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Pins this session to the specified server, which should be a mongos.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>server</span>
    <span class='type'>(<a href="Server.html" title="Mongo::Server (class)">Server</a>)</span>
&mdash;    <div class='inline'>
<p>The server to pin this session to.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L783-L793'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='783' data-end='793'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 783</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_pin_to_server'>pin_to_server</span>(<span class='id identifier rubyid_server'>server</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Cannot pin to a nil server</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='const'><a href="Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_mongos?'>mongos?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Attempted to pin the session to server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_summary'>summary</span><span class='embexpr_end'>}</span><span class='tstring_content'> which is not a mongos</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='ivar'>@pinned_server</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="process-instance_method">
  <h3 class='signature nodoc'>
    #<strong>process</strong>(result)  &#x21d2; <a href="Operation/Result.html" title="Mongo::Operation::Result (class)">Operation::Result</a> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Process a response from the server that used this session.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Process a response from the server.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_process'>process</span>(<span class='id identifier rubyid_result'>result</span>)</code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>result</span>
    <span class='type'>(<a href="Operation/Result.html" title="Mongo::Operation::Result (class)">Operation::Result</a>)</span>
&mdash;    <div class='inline'>
<p>The result from the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Operation/Result.html" title="Mongo::Operation::Result (class)">Operation::Result</a>)</span>
&mdash;    <div class='inline'>
<p>The result.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1042-L1058'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1042' data-end='1058'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1042</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_process'>process</span>(<span class='id identifier rubyid_result'>result</span>)
  <span class='kw'>unless</span> <span class='id identifier rubyid_implicit?'><a href="#implicit%3F-instance_method" title="Mongo::Session#implicit? (method)">implicit?</a></span>
    <span class='id identifier rubyid_set_operation_time'><a href="#set_operation_time-instance_method" title="Mongo::Session#set_operation_time (method)">set_operation_time</a></span>(<span class='id identifier rubyid_result'>result</span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_cluster_time_doc'>cluster_time_doc</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_cluster_time'>cluster_time</span>
      <span class='id identifier rubyid_advance_cluster_time'>advance_cluster_time</span>(<span class='id identifier rubyid_cluster_time_doc'>cluster_time_doc</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='ivar'>@server_session</span>.<span class='id identifier rubyid_set_last_use!'>set_last_use!</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_reply'>reply</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_reply'>reply</span>.<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_first'>first</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_recoveryToken'>recoveryToken</span>]
      <span class='kw'>self</span>.<span class='id identifier rubyid_recovery_token'><a href="#recovery_token-instance_method" title="Mongo::Session#recovery_token (method)">recovery_token</a></span> <span class='op'>=</span> <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_recoveryToken'>recoveryToken</span>]
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="session_id-instance_method">
  <h3 class='signature '>
    #<strong>session_id</strong>  &#x21d2; <code>BSON::Document</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get the server session id of this session, if the session has not been ended. If the session had been ended, raises <a href="Error/SessionEnded.html" title="Mongo::Error::SessionEnded (class)"><code>Error::SessionEnded</code></a>.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>The server session id.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/SessionEnded.html" title="Mongo::Error::SessionEnded (class)">Error::SessionEnded</a>)</span>
&mdash;    <div class='inline'>
<p>If the session had been ended.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L248-L265'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='248' data-end='265'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 248</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_session_id'>session_id</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_ended?'><a href="#ended%3F-instance_method" title="Mongo::Session#ended? (method)">ended?</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/SessionEnded.html" title="Mongo::Error::SessionEnded (class)">SessionEnded</a></span>
  <span class='kw'>end</span>

  <span class='comment'># An explicit session will always have a session_id, because during
</span>  <span class='comment'># construction a server session must be provided. An implicit session
</span>  <span class='comment'># will not have a session_id until materialized, thus calls to
</span>  <span class='comment'># session_id might fail. An application should not have an opportunity
</span>  <span class='comment'># to experience this failure because an implicit session shouldn&#39;t be
</span>  <span class='comment'># accessible to applications due to its lifetime being constrained to
</span>  <span class='comment'># operation execution, which is done entirely by the driver.
</span>  <span class='kw'>unless</span> <span class='id identifier rubyid_materialized?'><a href="#materialized%3F-instance_method" title="Mongo::Session#materialized? (method)">materialized?</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/SessionNotMaterialized.html" title="Mongo::Error::SessionNotMaterialized (class)">SessionNotMaterialized</a></span>
  <span class='kw'>end</span>

  <span class='ivar'>@server_session</span>.<span class='id identifier rubyid_session_id'>session_id</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="set_operation_time-instance_method">
  <h3 class='signature priv'>
    #<strong>set_operation_time</strong>(result)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1192-L1196'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1192' data-end='1196'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1192</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_set_operation_time'>set_operation_time</span>(<span class='id identifier rubyid_result'>result</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_result'>result</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_operation_time'><a href="#operation_time-instance_method" title="Mongo::Session#operation_time (method)">operation_time</a></span>
    <span class='ivar'>@operation_time</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_operation_time'><a href="#operation_time-instance_method" title="Mongo::Session#operation_time (method)">operation_time</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="start_transaction-instance_method">
  <h3 class='signature '>
    #<strong>start_transaction</strong>(options = nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Places subsequent operations in this session into a new transaction.</p>

<p>Note that the transaction will not be started on the server until an operation is performed after start_transaction is called.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Start a new transaction</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_start_transaction'>start_transaction</span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>)</code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>options</span>
    <span class='type'>(<code>Hash</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>The options for the transaction being started.</p>
</div>
  </li>
</ul>
    <p class='tag_title'>Options Hash (<tt>options</tt>):</p>
    <ul class='option'>
        <li>
          <span class='name'>:max_commit_time_ms</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>The maximum amount of time to allow a single commitTransaction command to run, in milliseconds.</p>
</div>        </li>
        <li>
          <span class='name'>:read_concern</span>
          <span class='type'>(<code>Hash</code>)</span>
            &mdash; <div class='inline'>
<p>The read concern options hash, with the following optional keys:</p>
<ul><li>
<p><strong>:level</strong> – the read preference level as a symbol; valid values</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_are'>are</span> <span class='op'>*</span><span class='symbeg'>:</span><span class='id identifier rubyid_local'>local</span><span class='op'>*</span><span class='comma'>,</span> <span class='op'>*</span><span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span><span class='op'>*</span><span class='comma'>,</span> <span class='kw'>and</span> <span class='op'>*</span><span class='symbeg'>:</span><span class='id identifier rubyid_snapshot'>snapshot</span><span class='op'>*</span></code></pre>
</li></ul>
</div>        </li>
        <li>
          <span class='name'>:write_concern</span>
          <span class='type'>(<code>Hash</code>)</span>
            &mdash; <div class='inline'>
<p>The write concern options. Can be <code>:w</code> =&gt; Integer|String, <code>:fsync</code> =&gt; Boolean, <code>:j</code> =&gt; Boolean.</p>
</div>        </li>
        <li>
          <span class='name'>:read</span>
          <span class='type'>(<code>Hash</code>)</span>
            &mdash; <div class='inline'>
<p>The read preference options. The hash may have the following items:</p>
<ul><li>
<p><strong>:mode</strong> – read preference specified as a symbol; the only valid value is <strong>:primary</strong>.</p>
</li></ul>
</div>        </li>
    </ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Error::InvalidTransactionOperation</a>)</span>
&mdash;    <div class='inline'>
<p>If a transaction is already in progress or if the write concern is unacknowledged.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L557-L605'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='557' data-end='605'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 557</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_start_transaction'>start_transaction</span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_check_transactions_supported!'><a href="#check_transactions_supported!-instance_method" title="Mongo::Session#check_transactions_supported! (method)">check_transactions_supported!</a></span>

  <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>
    <span class='const'><a href="Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_validate_read_concern_option'><a href="Lint.html#validate_read_concern_option-class_method" title="Mongo::Lint.validate_read_concern_option (method)">validate_read_concern_option</a></span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_read_concern'>read_concern</span>])

<span class='embdoc_beg'>=begin
</span><span class='embdoc'>    # It would be handy to detect invalid read preferences here, but
</span><span class='embdoc'>    # some of the spec tests require later detection of invalid read prefs.
</span><span class='embdoc'>    # Maybe we can do this when lint mode is on.
</span><span class='embdoc'>    mode = options[:read] &amp;&amp; options[:read][:mode].to_s
</span><span class='embdoc'>    if mode &amp;&amp; mode != &#39;primary&#39;
</span><span class='embdoc'>      raise Mongo::Error::InvalidTransactionOperation.new(
</span><span class='embdoc'>        &quot;read preference in a transaction must be primary (requested: #{mode})&quot;
</span><span class='embdoc'>      )
</span><span class='embdoc'>    end
</span><span class='embdoc_end'>=end
</span>  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_snapshot?'><a href="#snapshot%3F-instance_method" title="Mongo::Session#snapshot? (method)">snapshot?</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/SnapshotSessionTransactionProhibited.html" title="Mongo::Error::SnapshotSessionTransactionProhibited (class)">SnapshotSessionTransactionProhibited</a></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_check_if_ended!'><a href="#check_if_ended!-instance_method" title="Mongo::Session#check_if_ended! (method)">check_if_ended!</a></span>

  <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span><span class='comma'>,</span> <span class='const'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidTransactionOperation.html#new-class_method" title="Mongo::Error::InvalidTransactionOperation.new (method)">new</a></span>(
      <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html#TRANSACTION_ALREADY_IN_PROGRESS-constant" title="Mongo::Error::InvalidTransactionOperation::TRANSACTION_ALREADY_IN_PROGRESS (constant)">TRANSACTION_ALREADY_IN_PROGRESS</a></span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_unpin'><a href="#unpin-instance_method" title="Mongo::Session#unpin (method)">unpin</a></span>

  <span class='id identifier rubyid_next_txn_num'><a href="#next_txn_num-instance_method" title="Mongo::Session#next_txn_num (method)">next_txn_num</a></span>
  <span class='ivar'>@txn_options</span> <span class='op'>=</span> (<span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_default_transaction_options'>default_transaction_options</span>] <span class='op'>||</span> {}).<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span> <span class='op'>||</span> {})

  <span class='kw'>if</span> <span class='id identifier rubyid_txn_write_concern'><a href="#txn_write_concern-instance_method" title="Mongo::Session#txn_write_concern (method)">txn_write_concern</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='const'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span>.<span class='id identifier rubyid_get'><a href="WriteConcern.html#get-instance_method" title="Mongo::WriteConcern#get (method)">get</a></span>(<span class='id identifier rubyid_txn_write_concern'><a href="#txn_write_concern-instance_method" title="Mongo::Session#txn_write_concern (method)">txn_write_concern</a></span>).<span class='id identifier rubyid_acknowledged?'>acknowledged?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidTransactionOperation.html#new-class_method" title="Mongo::Error::InvalidTransactionOperation.new (method)">new</a></span>(
      <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html#UNACKNOWLEDGED_WRITE_CONCERN-constant" title="Mongo::Error::InvalidTransactionOperation::UNACKNOWLEDGED_WRITE_CONCERN (constant)">UNACKNOWLEDGED_WRITE_CONCERN</a></span>)
  <span class='kw'>end</span>

  <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span>
  <span class='ivar'>@already_committed</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># This method has no explicit return value.
</span>  <span class='comment'># We could return nil here but true indicates to the user that the
</span>  <span class='comment'># operation succeeded. This is intended for interactive use.
</span>  <span class='comment'># Note that the return value is not documented.
</span>  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="suppress_read_write_concern!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>suppress_read_write_concern!</strong>(command)  &#x21d2; <code>Hash</code>, <code>BSON::Document</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Remove the read concern and/or write concern from the command if not applicable.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_suppress_read_write_concern!'>suppress_read_write_concern!</span>(<span class='id identifier rubyid_cmd'>cmd</span>)</code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>, <code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>The command document.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L967-L974'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='967' data-end='974'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 967</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_suppress_read_write_concern!'>suppress_read_write_concern!</span>(<span class='id identifier rubyid_command'>command</span>)
  <span class='id identifier rubyid_command'>command</span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_in_transaction?'><a href="#in_transaction%3F-instance_method" title="Mongo::Session#in_transaction? (method)">in_transaction?</a></span>

    <span class='id identifier rubyid_c'>c</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span>) <span class='kw'>unless</span> <span class='id identifier rubyid_starting_transaction?'><a href="#starting_transaction%3F-instance_method" title="Mongo::Session#starting_transaction? (method)">starting_transaction?</a></span>
    <span class='id identifier rubyid_c'>c</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_writeConcern'>writeConcern</span>) <span class='kw'>unless</span> <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_commitTransaction'>commitTransaction</span>] <span class='op'>||</span> <span class='id identifier rubyid_c'>c</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_abortTransaction'>abortTransaction</span>]
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="txn_num-instance_method">
  <h3 class='signature '>
    #<strong>txn_num</strong>  &#x21d2; <code>Integer</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get the current transaction number.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Get the current transaction number.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_txn_num'>txn_num</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The current transaction number.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1130-L1136'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1130' data-end='1136'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1130</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_txn_num'>txn_num</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_ended?'><a href="#ended%3F-instance_method" title="Mongo::Session#ended? (method)">ended?</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/SessionEnded.html" title="Mongo::Error::SessionEnded (class)">SessionEnded</a></span>
  <span class='kw'>end</span>

  <span class='ivar'>@server_session</span>.<span class='id identifier rubyid_txn_num'>txn_num</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="txn_options-instance_method">
  <h3 class='signature '>
    #<strong>txn_options</strong>  &#x21d2; <code>Hash</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>on this session.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>The options for the transaction currently being executed</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L147-L149'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='147' data-end='149'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 147</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_txn_options'>txn_options</span>
  <span class='ivar'>@txn_options</span> <span class='kw'>or</span> <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>There is no active transaction</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="txn_read_concern-instance_method">
  <h3 class='signature priv'>
    #<strong>txn_read_concern</strong>  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get the read concern the session will use when starting a transaction.</p>

<p>This is a driver style hash with underscore keys.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Get the session’s transaction read concern.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_txn_read_concern'>txn_read_concern</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>The read concern used for starting transactions.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1153-L1156'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1153' data-end='1156'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1153</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_txn_read_concern'>txn_read_concern</span>
  <span class='comment'># Read concern is inherited from client but not db or collection.
</span>  <span class='id identifier rubyid_txn_options'><a href="#txn_options-instance_method" title="Mongo::Session#txn_options (method)">txn_options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_read_concern'>read_concern</span>] <span class='op'>||</span> <span class='ivar'>@client</span>.<span class='id identifier rubyid_read_concern'>read_concern</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="txn_read_preference-instance_method">
  <h3 class='signature '>
    #<strong>txn_read_preference</strong>  &#x21d2; <code>Hash</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get the read preference the session will use in the currently active transaction.</p>

<p>This is a driver style hash with underscore keys.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Get the transaction’s read preference</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_txn_read_preference'>txn_read_preference</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>The read preference of the transaction.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L221-L226'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='221' data-end='226'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 221</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_txn_read_preference'>txn_read_preference</span>
  <span class='id identifier rubyid_rp'>rp</span> <span class='op'>=</span> <span class='id identifier rubyid_txn_options'><a href="#txn_options-instance_method" title="Mongo::Session#txn_options (method)">txn_options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_read'>read</span>] <span class='op'>||</span>
    <span class='ivar'>@client</span>.<span class='id identifier rubyid_read_preference'>read_preference</span>
  <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_validate_underscore_read_preference'><a href="Lint.html#validate_underscore_read_preference-class_method" title="Mongo::Lint.validate_underscore_read_preference (method)">validate_underscore_read_preference</a></span>(<span class='id identifier rubyid_rp'>rp</span>)
  <span class='id identifier rubyid_rp'>rp</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="txn_write_concern-instance_method">
  <h3 class='signature priv'>
    #<strong>txn_write_concern</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1169-L1172'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1169' data-end='1172'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1169</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_txn_write_concern'>txn_write_concern</span>
  <span class='id identifier rubyid_txn_options'><a href="#txn_options-instance_method" title="Mongo::Session#txn_options (method)">txn_options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>] <span class='op'>||</span>
    (<span class='ivar'>@client</span>.<span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@client</span>.<span class='id identifier rubyid_write_concern'>write_concern</span>.<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="unpin-instance_method">
  <h3 class='signature nodoc'>
    #<strong>unpin</strong>(connection = nil)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Unpins this session from the pinned server or connection, if the session was pinned.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<code>Connection</code> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>Connection to unpin from.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L814-L818'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='814' data-end='818'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 814</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_unpin'>unpin</span>(<span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='ivar'>@pinned_server</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@pinned_connection_global_id</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_unpin'>unpin</span> <span class='kw'>unless</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="unpin_maybe-instance_method">
  <h3 class='signature nodoc'>
    #<strong>unpin_maybe</strong>(error, connection = nil)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Unpins this session from the pinned server or connection, if the session was pinned and the specified exception instance and the session’s transaction state require it to be unpinned.</p>

<p>The exception instance should already have all of the labels set on it (both client- and server-side generated ones).</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>error</span>
    <span class='type'>(<a href="Error.html" title="Mongo::Error (class)">Error</a>)</span>
&mdash;    <div class='inline'>
<p>The exception instance to process.</p>
</div>
  </li>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<code>Connection</code> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>Connection to unpin from.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L831-L843'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='831' data-end='843'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 831</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_unpin_maybe'>unpin_maybe</span>(<span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'>Session</span><span class='op'>::</span><span class='const'><a href="#NO_TRANSACTION_STATE-constant" title="Mongo::Session::NO_TRANSACTION_STATE (constant)">NO_TRANSACTION_STATE</a></span>) <span class='op'>&amp;&amp;</span>
    <span class='id identifier rubyid_error'>error</span>.<span class='id identifier rubyid_label?'>label?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TransientTransactionError</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>then</span>
    <span class='id identifier rubyid_unpin'><a href="#unpin-instance_method" title="Mongo::Session#unpin (method)">unpin</a></span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_committing_transaction?'><a href="#committing_transaction%3F-instance_method" title="Mongo::Session#committing_transaction? (method)">committing_transaction?</a></span> <span class='op'>&amp;&amp;</span>
    <span class='id identifier rubyid_error'>error</span>.<span class='id identifier rubyid_label?'>label?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UnknownTransactionCommitResult</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>then</span>
    <span class='id identifier rubyid_unpin'><a href="#unpin-instance_method" title="Mongo::Session#unpin (method)">unpin</a></span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_state!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>update_state!</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Update the state of the session due to a (non-commit and non-abort) operation being run.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1003-L1010'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1003' data-end='1010'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1003</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_state!'>update_state!</span>
  <span class='kw'>case</span> <span class='ivar'>@state</span>
  <span class='kw'>when</span> <span class='const'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span>
  <span class='kw'>when</span> <span class='const'><a href="#TRANSACTION_COMMITTED_STATE-constant" title="Mongo::Session::TRANSACTION_COMMITTED_STATE (constant)">TRANSACTION_COMMITTED_STATE</a></span><span class='comma'>,</span> <span class='const'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><a href="#NO_TRANSACTION_STATE-constant" title="Mongo::Session::NO_TRANSACTION_STATE (constant)">NO_TRANSACTION_STATE</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>validate!</strong>(client)  &#x21d2; <code>Session</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Validate the session for use by the specified client.</p>

<p>The session must not be ended and must have been created by a client with the same cluster as the client that the session is to be used with.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>client</span>
    <span class='type'>(<a href="Client.html" title="Mongo::Client (class)">Client</a>)</span>
&mdash;    <div class='inline'>
<p>The client the session is to be used with.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Session</code>)</span>
&mdash;    <div class='inline'>
<p>self, if the session is valid.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/InvalidSession.html" title="Mongo::Error::InvalidSession (class)">Mongo::Error::InvalidSession</a>)</span>
&mdash;    <div class='inline'>
<p>Exception raised if the session is not valid.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1025-L1029'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1025' data-end='1029'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1025</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate!'>validate!</span>(<span class='id identifier rubyid_client'><a href="#client-instance_method" title="Mongo::Session#client (method)">client</a></span>)
  <span class='id identifier rubyid_check_matching_cluster!'><a href="#check_matching_cluster!-instance_method" title="Mongo::Session#check_matching_cluster! (method)">check_matching_cluster!</a></span>(<span class='id identifier rubyid_client'><a href="#client-instance_method" title="Mongo::Session#client (method)">client</a></span>)
  <span class='id identifier rubyid_check_if_ended!'><a href="#check_if_ended!-instance_method" title="Mongo::Session#check_if_ended! (method)">check_if_ended!</a></span>
  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_read_preference!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>validate_read_preference!</strong>(command)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Ensure that the read preference of a command primary.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_validate_read_preference!'>validate_read_preference!</span>(<span class='id identifier rubyid_command'>command</span>)</code></pre>
  </div>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Mongo::Error::InvalidTransactionOperation</a>)</span>
&mdash;    <div class='inline'>
<p>If the read preference of the command is not primary.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L986-L997'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='986' data-end='997'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 986</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_read_preference!'>validate_read_preference!</span>(<span class='id identifier rubyid_command'>command</span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_in_transaction?'><a href="#in_transaction%3F-instance_method" title="Mongo::Session#in_transaction? (method)">in_transaction?</a></span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_command'>command</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$readPreference</span><span class='tstring_end'>&#39;</span></span>]

  <span class='id identifier rubyid_mode'>mode</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$readPreference</span><span class='tstring_end'>&#39;</span></span>][<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mode</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>||</span> <span class='id identifier rubyid_command'>command</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$readPreference</span><span class='tstring_end'>&#39;</span></span>][<span class='symbeg'>:</span><span class='id identifier rubyid_mode'>mode</span>]

  <span class='kw'>if</span> <span class='id identifier rubyid_mode'>mode</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_mode'>mode</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>primary</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>.<span class='id identifier rubyid_new'><a href="Error/InvalidTransactionOperation.html#new-class_method" title="Mongo::Error::InvalidTransactionOperation.new (method)">new</a></span>(
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>read preference in a transaction must be primary (requested: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_mode'>mode</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
    )
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="with_transaction-instance_method">
  <h3 class='signature '>
    #<strong>with_transaction</strong>(options = nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>with_transaction contains a loop, therefore the if with_transaction itself is placed in a loop, its block should not call next or break to control the outer loop because this will instead affect the loop in with_transaction. The driver will warn and abort the transaction if it detects this situation.</p>
</div>
  </div>


<p>Executes the provided block in a transaction, retrying as necessary.</p>

<p>Returns the return value of the block.</p>

<p>Exact number of retries and when they are performed are implementation details of the driver; the provided block should be idempotent, and should be prepared to be called more than once. The driver may retry the commit command within an active transaction or it may repeat the transaction and invoke the block again, depending on the error encountered if any. Note also that the retries may be executed against different servers.</p>

<p>Transactions cannot be nested - InvalidTransactionOperation will be raised if this method is called when the session already has an active transaction.</p>

<p>Exceptions raised by the block which are not derived from <a href="Error.html" title="Mongo::Error (class)"><code>Error</code></a> stop processing, abort the transaction and are propagated out of with_transaction. Exceptions derived from <a href="Error.html" title="Mongo::Error (class)"><code>Error</code></a> may be handled by with_transaction, resulting in retries of the process.</p>

<p>Currently, with_transaction will retry commits and block invocations until at least 120 seconds have passed since with_transaction started executing. This timeout is not configurable and may change in a future driver version.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Execute a statement in a transaction</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_with_transaction'>with_transaction</span>(<span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>}) <span class='kw'>do</span>
  <span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_update_one'>update_one</span>({ <span class='label'>id:</span> <span class='int'>3</span> }<span class='comma'>,</span> { <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> { <span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Inactive</span><span class='tstring_end'>&#39;</span></span>} }<span class='comma'>,</span>
                        <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span>)

<span class='kw'>end</span></code></pre>
        <p class='example_title'><div class='inline'>
<p>Execute a statement in a transaction, limiting total time consumed</p>
</div></p>
      <pre class='example code ruby'><code><span class='const'><a href="Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span>.<span class='id identifier rubyid_timeout'><a href="Timeout.html#timeout-class_method" title="Mongo::Timeout.timeout (method)">timeout</a></span>(<span class='int'>5</span>) <span class='kw'>do</span>
  <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_with_transaction'>with_transaction</span>(<span class='label'>write_concern:</span> {<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>}) <span class='kw'>do</span>
    <span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_update_one'>update_one</span>({ <span class='label'>id:</span> <span class='int'>3</span> }<span class='comma'>,</span> { <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> { <span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Inactive</span><span class='tstring_end'>&#39;</span></span>} }<span class='comma'>,</span>
                          <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span>)

  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>options</span>
    <span class='type'>(<code>Hash</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>The options for the transaction being started. These are the same options that start_transaction accepts.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Error::InvalidTransactionOperation</a>)</span>
&mdash;    <div class='inline'>
<p>If a transaction is already in progress or if the write concern is unacknowledged.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.7.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L441-L528'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='441' data-end='528'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 441</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_with_transaction'>with_transaction</span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span><span class='op'>=</span><span class='kw'>nil</span>)
  <span class='comment'># Non-configurable 120 second timeout for the entire operation
</span>  <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>=</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>+</span> <span class='int'>120</span>
  <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_commit_options'>commit_options</span> <span class='op'>=</span> {}
    <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>
      <span class='id identifier rubyid_commit_options'>commit_options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>] <span class='op'>=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>]
    <span class='kw'>end</span>
    <span class='id identifier rubyid_start_transaction'><a href="#start_transaction-instance_method" title="Mongo::Session#start_transaction (method)">start_transaction</a></span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>)
    <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_rv'>rv</span> <span class='op'>=</span> <span class='kw'>yield</span> <span class='kw'>self</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span><span class='comma'>,</span> <span class='const'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span>)
        <span class='id identifier rubyid_log_warn'>log_warn</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Aborting transaction due to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
        <span class='id identifier rubyid_abort_transaction'><a href="#abort_transaction-instance_method" title="Mongo::Session#abort_transaction (method)">abort_transaction</a></span>
        <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_deadline'>deadline</span>
        <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='id identifier rubyid_raise'>raise</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span>) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_label?'>label?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TransientTransactionError</span><span class='tstring_end'>&#39;</span></span>)
        <span class='kw'>next</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_raise'>raise</span>
    <span class='kw'>else</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'><a href="#within_states%3F-instance_method" title="Mongo::Session#within_states? (method)">within_states?</a></span>(<span class='const'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span><span class='comma'>,</span> <span class='const'><a href="#NO_TRANSACTION_STATE-constant" title="Mongo::Session::NO_TRANSACTION_STATE (constant)">NO_TRANSACTION_STATE</a></span><span class='comma'>,</span> <span class='const'><a href="#TRANSACTION_COMMITTED_STATE-constant" title="Mongo::Session::TRANSACTION_COMMITTED_STATE (constant)">TRANSACTION_COMMITTED_STATE</a></span>)
        <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='kw'>return</span> <span class='id identifier rubyid_rv'>rv</span>
      <span class='kw'>end</span>

      <span class='kw'>begin</span>
        <span class='id identifier rubyid_commit_transaction'><a href="#commit_transaction-instance_method" title="Mongo::Session#commit_transaction (method)">commit_transaction</a></span>(<span class='id identifier rubyid_commit_options'>commit_options</span>)
        <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='kw'>return</span> <span class='id identifier rubyid_rv'>rv</span>
      <span class='kw'>rescue</span> <span class='const'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_label?'>label?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UnknownTransactionCommitResult</span><span class='tstring_end'>&#39;</span></span>)
          <span class='kw'>if</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>||</span>
            <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span>) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_max_time_ms_expired?'>max_time_ms_expired?</span>
          <span class='kw'>then</span>
            <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
            <span class='id identifier rubyid_raise'>raise</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_wc_options'>wc_options</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_v'>v</span> <span class='op'>=</span> <span class='id identifier rubyid_commit_options'>commit_options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>]
            <span class='kw'>when</span> <span class='const'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span><span class='op'>::</span><span class='const'><a href="WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">Base</a></span>
              <span class='id identifier rubyid_v'>v</span>.<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Session#options (method)">options</a></span>
            <span class='kw'>when</span> <span class='kw'>nil</span>
              {}
            <span class='kw'>else</span>
              <span class='id identifier rubyid_v'>v</span>
            <span class='kw'>end</span>
          <span class='id identifier rubyid_commit_options'>commit_options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_concern'>write_concern</span>] <span class='op'>=</span> <span class='id identifier rubyid_wc_options'>wc_options</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='label'>w:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_majority'>majority</span>)
          <span class='kw'>retry</span>
        <span class='kw'>elsif</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_label?'>label?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TransientTransactionError</span><span class='tstring_end'>&#39;</span></span>)
          <span class='kw'>if</span> <span class='const'><a href="Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_deadline'>deadline</span>
            <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
            <span class='id identifier rubyid_raise'>raise</span>
          <span class='kw'>end</span>
          <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><a href="#NO_TRANSACTION_STATE-constant" title="Mongo::Session::NO_TRANSACTION_STATE (constant)">NO_TRANSACTION_STATE</a></span>
          <span class='kw'>next</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
          <span class='id identifier rubyid_raise'>raise</span>
        <span class='kw'>end</span>
      <span class='kw'>rescue</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/AuthError.html" title="Mongo::Error::AuthError (class)">AuthError</a></span>
        <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='id identifier rubyid_raise'>raise</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># No official return value, but return true so that in interactive
</span>  <span class='comment'># use the method hints that it succeeded.
</span>  <span class='kw'>true</span>
<span class='kw'>ensure</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>with_transaction callback broke out of with_transaction loop, aborting transaction</span><span class='tstring_end'>&#39;</span></span>)
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_abort_transaction'><a href="#abort_transaction-instance_method" title="Mongo::Session#abort_transaction (method)">abort_transaction</a></span>
    <span class='kw'>rescue</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span><span class='comma'>,</span> <span class='const'><a href="Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="within_states?-instance_method">
  <h3 class='signature priv'>
    #<strong>within_states?</strong>(*states)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/session.rb#L1158-L1160'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1158' data-end='1160'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/session.rb', line 1158</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_within_states?'>within_states?</span>(<span class='op'>*</span><span class='id identifier rubyid_states'>states</span>)
  <span class='id identifier rubyid_states'>states</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='ivar'>@state</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>