<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: Mongo::Operation::SessionsSupported &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Operation::SessionsSupported",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongo master</a> &raquo; 
      <a href='../../_index.html#alpha_S'>Index (S)</a> &raquo; 
        <a href="../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a class='nodoc' href="../Operation.html" title="Mongo::Operation (module)">Operation</a> &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>SessionsSupported&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: Mongo::Operation::SessionsSupported  <span class='private note title'>Private</span>
</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This module is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Included In:</div>
      <div class='box_11'>
        <a href="Aggregate/OpMsg.html" title="Mongo::Operation::Aggregate::OpMsg (class)"><code>Aggregate::OpMsg</code></a>,
          <a href="Command/OpMsg.html" title="Mongo::Operation::Command::OpMsg (class)"><code>Command::OpMsg</code></a>,
          <a href="Count/OpMsg.html" title="Mongo::Operation::Count::OpMsg (class)"><code>Count::OpMsg</code></a>,
          <a href="Create/OpMsg.html" title="Mongo::Operation::Create::OpMsg (class)"><code>Create::OpMsg</code></a>,
          <a href="CreateIndex/OpMsg.html" title="Mongo::Operation::CreateIndex::OpMsg (class)"><code>CreateIndex::OpMsg</code></a>,
          <a href="CreateSearchIndexes/OpMsg.html" title="Mongo::Operation::CreateSearchIndexes::OpMsg (class)"><code>CreateSearchIndexes::OpMsg</code></a>,
          <a href="CreateUser/OpMsg.html" title="Mongo::Operation::CreateUser::OpMsg (class)"><code>CreateUser::OpMsg</code></a>,
          <a href="Delete/OpMsg.html" title="Mongo::Operation::Delete::OpMsg (class)"><code>Delete::OpMsg</code></a>,
          <a href="Distinct/OpMsg.html" title="Mongo::Operation::Distinct::OpMsg (class)"><code>Distinct::OpMsg</code></a>,
          <a href="Drop/OpMsg.html" title="Mongo::Operation::Drop::OpMsg (class)"><code>Drop::OpMsg</code></a>,
          <a href="DropDatabase/OpMsg.html" title="Mongo::Operation::DropDatabase::OpMsg (class)"><code>DropDatabase::OpMsg</code></a>,
          <a href="DropIndex/OpMsg.html" title="Mongo::Operation::DropIndex::OpMsg (class)"><code>DropIndex::OpMsg</code></a>,
          <a href="DropSearchIndex/OpMsg.html" title="Mongo::Operation::DropSearchIndex::OpMsg (class)"><code>DropSearchIndex::OpMsg</code></a>,
          <a href="Explain/OpMsg.html" title="Mongo::Operation::Explain::OpMsg (class)"><code>Explain::OpMsg</code></a>,
          <a href="Find/OpMsg.html" title="Mongo::Operation::Find::OpMsg (class)"><code>Find::OpMsg</code></a>,
          <a href="GetMore/OpMsg.html" title="Mongo::Operation::GetMore::OpMsg (class)"><code>GetMore::OpMsg</code></a>,
          <a href="Indexes/OpMsg.html" title="Mongo::Operation::Indexes::OpMsg (class)"><code>Indexes::OpMsg</code></a>,
          <a href="Insert/OpMsg.html" title="Mongo::Operation::Insert::OpMsg (class)"><code>Insert::OpMsg</code></a>,
          <a href="KillCursors/OpMsg.html" title="Mongo::Operation::KillCursors::OpMsg (class)"><code>KillCursors::OpMsg</code></a>,
          <a href="ListCollections/OpMsg.html" title="Mongo::Operation::ListCollections::OpMsg (class)"><code>ListCollections::OpMsg</code></a>,
          <a href="MapReduce/OpMsg.html" title="Mongo::Operation::MapReduce::OpMsg (class)"><code>MapReduce::OpMsg</code></a>,
          <a href="OpMsgBase.html" title="Mongo::Operation::OpMsgBase (class)"><code>OpMsgBase</code></a>,
          <a href="ParallelScan/OpMsg.html" title="Mongo::Operation::ParallelScan::OpMsg (class)"><code>ParallelScan::OpMsg</code></a>,
          <a href="RemoveUser/OpMsg.html" title="Mongo::Operation::RemoveUser::OpMsg (class)"><code>RemoveUser::OpMsg</code></a>,
          <a href="Update/OpMsg.html" title="Mongo::Operation::Update::OpMsg (class)"><code>Update::OpMsg</code></a>,
          <a href="UpdateSearchIndex/OpMsg.html" title="Mongo::Operation::UpdateSearchIndex::OpMsg (class)"><code>UpdateSearchIndex::OpMsg</code></a>,
          <a href="UpdateUser/OpMsg.html" title="Mongo::Operation::UpdateUser::OpMsg (class)"><code>UpdateUser::OpMsg</code></a>,
          <a href="UsersInfo/OpMsg.html" title="Mongo::Operation::UsersInfo::OpMsg (class)"><code>UsersInfo::OpMsg</code></a>,
          <a href="WriteCommand/OpMsg.html" title="Mongo::Operation::WriteCommand::OpMsg (class)"><code>WriteCommand::OpMsg</code></a>
      </div>
    </td></tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L25'>lib/mongo/operation/shared/sessions_supported.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Shared behavior of operations that support a session.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full nodoc'>
  <li>
    <span id='READ_COMMANDS-constant' class='summary_signature nodoc'>READ_COMMANDS =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L31-L42'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 31</a>    <pre class='code ruby'>[
  <span class='symbeg'>:</span><span class='id identifier rubyid_aggregate'>aggregate</span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_count'>count</span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_dbStats'>dbStats</span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_distinct'>distinct</span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_find'>find</span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_geoNear'>geoNear</span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_geoSearch'>geoSearch</span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_group'>group</span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_mapReduce'>mapReduce</span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_parallelCollectionScan'>parallelCollectionScan</span>
].<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
  <li>
    <span id='ZERO_TIMESTAMP-constant' class='summary_signature nodoc'>ZERO_TIMESTAMP =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L29-L29'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 29</a>    <pre class='code ruby'><span class='const'>BSON</span><span class='op'>::</span><span class='const'>Timestamp</span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='int'>0</span>)</pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#add_read_preference-instance_method" title="#add_read_preference (instance method)">#<strong>add_read_preference</strong>(sel, connection)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Adds $readPreference field to the command document.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#add_write_concern!-instance_method" title="#add_write_concern! (instance method)">#<strong>add_write_concern!</strong>(sel)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#apply_autocommit!-instance_method" title="#apply_autocommit! (instance method)">#<strong>apply_autocommit!</strong>(selector)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#apply_causal_consistency!-instance_method" title="#apply_causal_consistency! (instance method)">#<strong>apply_causal_consistency!</strong>(selector, connection)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Adds causal consistency document to the selector, if one can be constructed and the selector is for a startTransaction command.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#apply_causal_consistency_if_possible-instance_method" title="#apply_causal_consistency_if_possible (instance method)">#<strong>apply_causal_consistency_if_possible</strong>(selector, connection)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Adds causal consistency document to the selector, if one can be constructed.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#apply_cluster_time!-instance_method" title="#apply_cluster_time! (instance method)">#<strong>apply_cluster_time!</strong>(selector, connection)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#apply_read_pref!-instance_method" title="#apply_read_pref! (instance method)">#<strong>apply_read_pref!</strong>(selector)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#apply_session_options-instance_method" title="#apply_session_options (instance method)">#<strong>apply_session_options</strong>(sel, connection)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#apply_start_transaction!-instance_method" title="#apply_start_transaction! (instance method)">#<strong>apply_start_transaction!</strong>(selector)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#apply_txn_num!-instance_method" title="#apply_txn_num! (instance method)">#<strong>apply_txn_num!</strong>(selector)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#apply_txn_opts!-instance_method" title="#apply_txn_opts! (instance method)">#<strong>apply_txn_opts!</strong>(selector)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#build_message-instance_method" title="#build_message (instance method)">#<strong>build_message</strong>(connection, context)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#command-instance_method" title="#command (instance method)">#<strong>command</strong>(connection)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#flags-instance_method" title="#flags (instance method)">#<strong>flags</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#read_command%3F-instance_method" title="#read_command? (instance method)">#<strong>read_command?</strong>(sel)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#suppress_read_write_concern!-instance_method" title="#suppress_read_write_concern! (instance method)">#<strong>suppress_read_write_concern!</strong>(selector)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#validate_read_preference!-instance_method" title="#validate_read_preference! (instance method)">#<strong>validate_read_preference!</strong>(selector)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="add_read_preference-instance_method">
  <h3 class='signature priv  nodoc first'>
    #<strong>add_read_preference</strong>(sel, connection)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Adds $readPreference field to the command document.</p>

<p>$readPreference is only sent when the server is a mongos, following the rules described in <a href="https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.md#passing-read-preference-to-mongos">github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.md#passing-read-preference-to-mongos</a>. The topology does not matter for figuring out whether to send $readPreference since the decision is always made based on server type.</p>

<p>$readPreference is sent to OP_MSG-grokking replica set members.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>sel</span>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>Existing command document which will be mutated.</p>
</div>
  </li>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<a href="../Server/Connection.html" title="Mongo::Server::Connection (class)">Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>The connection that the operation will be executed on.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L167-L213'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='167' data-end='213'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 167</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add_read_preference'>add_read_preference</span>(<span class='id identifier rubyid_sel'>sel</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_assert_type'><a href="../Lint.html#assert_type-class_method" title="Mongo::Lint.assert_type (method)">assert_type</a></span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='const'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span><span class='op'>::</span><span class='const'><a href="../Server/Connection.html" title="Mongo::Server::Connection (class)">Connection</a></span>)

  <span class='comment'># https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.md#topology-type-single
</span>  <span class='id identifier rubyid_read_doc'>read_doc</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_standalone?'>standalone?</span>
    <span class='comment'># Read preference is never sent to standalones.
</span>    <span class='kw'>nil</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span>
    <span class='id identifier rubyid_read'>read</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_mongos'>to_mongos</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_mongos?'>mongos?</span>
    <span class='comment'># When server is a mongos:
</span>    <span class='comment'># - $readPreference is never sent when mode is &#39;primary&#39;
</span>    <span class='comment'># - Otherwise $readPreference is sent
</span>    <span class='comment'># When mode is &#39;secondaryPreferred&#39; $readPreference is currently
</span>    <span class='comment'># required to only be sent when a non-mode field (i.e. tag_sets)
</span>    <span class='comment'># is present, but this causes wrong behavior (DRIVERS-1642).
</span>    <span class='id identifier rubyid_read'>read</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_mongos'>to_mongos</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_single?'>single?</span>
    <span class='comment'># In Single topology:
</span>    <span class='comment'># - If no read preference is specified by the application, the driver
</span>    <span class='comment'>#   adds mode: primaryPreferred.
</span>    <span class='comment'># - If a read preference is specified by the application, the driver
</span>    <span class='comment'>#   replaces the mode with primaryPreferred.
</span>    <span class='id identifier rubyid_read_doc'>read_doc</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_read'>read</span>
      <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Document</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_read'>read</span>.<span class='id identifier rubyid_to_doc'>to_doc</span>)
    <span class='kw'>else</span>
      <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Document</span>.<span class='id identifier rubyid_new'>new</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> [<span class='kw'>nil</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>primary</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_read_doc'>read_doc</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mode</span><span class='tstring_end'>&#39;</span></span>])
      <span class='id identifier rubyid_read_doc'>read_doc</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mode</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>primaryPreferred</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_read_doc'>read_doc</span>
  <span class='kw'>else</span>
    <span class='comment'># In replica sets, read preference is passed to the server if one
</span>    <span class='comment'># is specified by the application, except for primary read preferences.
</span>    <span class='id identifier rubyid_read_doc'>read_doc</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Document</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_read'>read</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_doc'>to_doc</span> <span class='op'>||</span> {})
    <span class='kw'>if</span> [<span class='kw'>nil</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>primary</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_read_doc'>read_doc</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mode</span><span class='tstring_end'>&#39;</span></span>])
      <span class='kw'>nil</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_read_doc'>read_doc</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_read_doc'>read_doc</span>
    <span class='id identifier rubyid_sel'>sel</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$readPreference</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='id identifier rubyid_read_doc'>read_doc</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="add_write_concern!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>add_write_concern!</strong>(sel)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L96-L98'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='96' data-end='98'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 96</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add_write_concern!'>add_write_concern!</span>(<span class='id identifier rubyid_sel'>sel</span>)
  <span class='id identifier rubyid_sel'>sel</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_writeConcern'>writeConcern</span>] <span class='op'>=</span> <span class='id identifier rubyid_write_concern'>write_concern</span>.<span class='id identifier rubyid_options'>options</span> <span class='kw'>if</span> <span class='id identifier rubyid_write_concern'>write_concern</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_autocommit!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>apply_autocommit!</strong>(selector)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L100-L102'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='100' data-end='102'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 100</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_autocommit!'>apply_autocommit!</span>(<span class='id identifier rubyid_selector'>selector</span>)
  <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_add_autocommit!'>add_autocommit!</span>(<span class='id identifier rubyid_selector'>selector</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_causal_consistency!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>apply_causal_consistency!</strong>(selector, connection)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Adds causal consistency document to the selector, if one can be constructed and the selector is for a startTransaction command.</p>

<p>When operations are performed in a transaction, only the first operation (the one which starts the transaction via startTransaction) is allowed to have a read concern, and with it the causal consistency document, specified.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L51-L55'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='51' data-end='55'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 51</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_causal_consistency!'>apply_causal_consistency!</span>(<span class='id identifier rubyid_selector'>selector</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_selector'>selector</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_startTransaction'>startTransaction</span>]

  <span class='id identifier rubyid_apply_causal_consistency_if_possible'><a href="#apply_causal_consistency_if_possible-instance_method" title="Mongo::Operation::SessionsSupported#apply_causal_consistency_if_possible (method)">apply_causal_consistency_if_possible</a></span>(<span class='id identifier rubyid_selector'>selector</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_causal_consistency_if_possible-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>apply_causal_consistency_if_possible</strong>(selector, connection)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Adds causal consistency document to the selector, if one can be constructed.</p>

<p>In order for the causal consistency document to be constructed, causal consistency must be enabled for the session and the session must have the current operation time. Also, topology must be replica set or sharded cluster.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L64-L73'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='64' data-end='73'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 64</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_causal_consistency_if_possible'>apply_causal_consistency_if_possible</span>(<span class='id identifier rubyid_selector'>selector</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_standalone?'>standalone?</span>
    <span class='id identifier rubyid_cc_doc'>cc_doc</span> <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_causal_consistency_doc'>causal_consistency_doc</span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_cc_doc'>cc_doc</span>
      <span class='id identifier rubyid_rc_doc'>rc_doc</span> <span class='op'>=</span> (<span class='id identifier rubyid_selector'>selector</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span>] <span class='op'>||</span> <span class='id identifier rubyid_read_concern'>read_concern</span> <span class='op'>||</span> {}).<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_cc_doc'>cc_doc</span>)
      <span class='id identifier rubyid_selector'>selector</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span>] <span class='op'>=</span> <span class='const'><a href="../Options.html" title="Mongo::Options (module)">Options</a></span><span class='op'>::</span><span class='const'><a href="../Options/Mapper.html" title="Mongo::Options::Mapper (module)">Mapper</a></span>.<span class='id identifier rubyid_transform_values_to_strings'><a href="../Options/Mapper.html#transform_values_to_strings-instance_method" title="Mongo::Options::Mapper#transform_values_to_strings (method)">transform_values_to_strings</a></span>(
        <span class='id identifier rubyid_rc_doc'>rc_doc</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_cluster_time!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>apply_cluster_time!</strong>(selector, connection)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L79-L90'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='79' data-end='90'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 79</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_cluster_time!'>apply_cluster_time!</span>(<span class='id identifier rubyid_selector'>selector</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_standalone?'>standalone?</span>
    <span class='id identifier rubyid_cluster_time'>cluster_time</span> <span class='op'>=</span> [
      <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_cluster_time'>cluster_time</span><span class='comma'>,</span>
      <span class='id identifier rubyid_session'>session</span><span class='op'>&amp;.</span><span class='id identifier rubyid_cluster_time'>cluster_time</span><span class='comma'>,</span>
    ].<span class='id identifier rubyid_compact'>compact</span>.<span class='id identifier rubyid_max'>max</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_cluster_time'>cluster_time</span>
      <span class='id identifier rubyid_selector'>selector</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$clusterTime</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='id identifier rubyid_cluster_time'>cluster_time</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_read_pref!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>apply_read_pref!</strong>(selector)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L112-L114'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='112' data-end='114'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 112</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_read_pref!'>apply_read_pref!</span>(<span class='id identifier rubyid_selector'>selector</span>)
  <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_apply_read_pref!'>apply_read_pref!</span>(<span class='id identifier rubyid_selector'>selector</span>) <span class='kw'>if</span> <span class='id identifier rubyid_read_command?'><a href="#read_command%3F-instance_method" title="Mongo::Operation::SessionsSupported#read_command? (method)">read_command?</a></span>(<span class='id identifier rubyid_selector'>selector</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_session_options-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>apply_session_options</strong>(sel, connection)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L215-L242'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='215' data-end='242'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 215</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_session_options'>apply_session_options</span>(<span class='id identifier rubyid_sel'>sel</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='id identifier rubyid_apply_cluster_time!'><a href="#apply_cluster_time!-instance_method" title="Mongo::Operation::SessionsSupported#apply_cluster_time! (method)">apply_cluster_time!</a></span>(<span class='id identifier rubyid_sel'>sel</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='id identifier rubyid_sel'>sel</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_txnNumber'>txnNumber</span>] <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Int64</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_txn_num'>txn_num</span>) <span class='kw'>if</span> <span class='id identifier rubyid_txn_num'>txn_num</span>
  <span class='id identifier rubyid_sel'>sel</span>.<span class='id identifier rubyid_merge!'>merge!</span>(<span class='label'>lsid:</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_session_id'>session_id</span>)
  <span class='id identifier rubyid_apply_start_transaction!'><a href="#apply_start_transaction!-instance_method" title="Mongo::Operation::SessionsSupported#apply_start_transaction! (method)">apply_start_transaction!</a></span>(<span class='id identifier rubyid_sel'>sel</span>)
  <span class='id identifier rubyid_apply_causal_consistency!'><a href="#apply_causal_consistency!-instance_method" title="Mongo::Operation::SessionsSupported#apply_causal_consistency! (method)">apply_causal_consistency!</a></span>(<span class='id identifier rubyid_sel'>sel</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='id identifier rubyid_apply_autocommit!'><a href="#apply_autocommit!-instance_method" title="Mongo::Operation::SessionsSupported#apply_autocommit! (method)">apply_autocommit!</a></span>(<span class='id identifier rubyid_sel'>sel</span>)
  <span class='id identifier rubyid_apply_txn_opts!'><a href="#apply_txn_opts!-instance_method" title="Mongo::Operation::SessionsSupported#apply_txn_opts! (method)">apply_txn_opts!</a></span>(<span class='id identifier rubyid_sel'>sel</span>)
  <span class='id identifier rubyid_suppress_read_write_concern!'><a href="#suppress_read_write_concern!-instance_method" title="Mongo::Operation::SessionsSupported#suppress_read_write_concern! (method)">suppress_read_write_concern!</a></span>(<span class='id identifier rubyid_sel'>sel</span>)
  <span class='id identifier rubyid_validate_read_preference!'><a href="#validate_read_preference!-instance_method" title="Mongo::Operation::SessionsSupported#validate_read_preference! (method)">validate_read_preference!</a></span>(<span class='id identifier rubyid_sel'>sel</span>)
  <span class='id identifier rubyid_apply_txn_num!'><a href="#apply_txn_num!-instance_method" title="Mongo::Operation::SessionsSupported#apply_txn_num! (method)">apply_txn_num!</a></span>(<span class='id identifier rubyid_sel'>sel</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_recovery_token'>recovery_token</span> <span class='op'>&amp;&amp;</span>
    (<span class='id identifier rubyid_sel'>sel</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_commitTransaction'>commitTransaction</span>] <span class='op'>||</span> <span class='id identifier rubyid_sel'>sel</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_abortTransaction'>abortTransaction</span>])
  <span class='kw'>then</span>
    <span class='id identifier rubyid_sel'>sel</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_recoveryToken'>recoveryToken</span>] <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_recovery_token'>recovery_token</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_snapshot?'>snapshot?</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_server_version_gte?'>server_version_gte?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>5.0</span><span class='tstring_end'>&#39;</span></span>)
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SnapshotSessionInvalidServerVersion.html" title="Mongo::Error::SnapshotSessionInvalidServerVersion (class)">SnapshotSessionInvalidServerVersion</a></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_sel'>sel</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span>] <span class='op'>=</span> {<span class='label'>level:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>snapshot</span><span class='tstring_end'>&#39;</span></span>}
    <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_snapshot_timestamp'>snapshot_timestamp</span>
      <span class='id identifier rubyid_sel'>sel</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_readConcern'>readConcern</span>][<span class='symbeg'>:</span><span class='id identifier rubyid_atClusterTime'>atClusterTime</span>] <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_snapshot_timestamp'>snapshot_timestamp</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_start_transaction!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>apply_start_transaction!</strong>(selector)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L104-L106'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='104' data-end='106'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 104</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_start_transaction!'>apply_start_transaction!</span>(<span class='id identifier rubyid_selector'>selector</span>)
  <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_add_start_transaction!'>add_start_transaction!</span>(<span class='id identifier rubyid_selector'>selector</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_txn_num!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>apply_txn_num!</strong>(selector)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L108-L110'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='108' data-end='110'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 108</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_txn_num!'>apply_txn_num!</span>(<span class='id identifier rubyid_selector'>selector</span>)
  <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_add_txn_num!'>add_txn_num!</span>(<span class='id identifier rubyid_selector'>selector</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_txn_opts!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>apply_txn_opts!</strong>(selector)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L116-L118'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='116' data-end='118'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 116</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_txn_opts!'>apply_txn_opts!</span>(<span class='id identifier rubyid_selector'>selector</span>)
  <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_add_txn_opts!'>add_txn_opts!</span>(<span class='id identifier rubyid_selector'>selector</span><span class='comma'>,</span> <span class='id identifier rubyid_read_command?'><a href="#read_command%3F-instance_method" title="Mongo::Operation::SessionsSupported#read_command? (method)">read_command?</a></span>(<span class='id identifier rubyid_selector'>selector</span>)<span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="build_message-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>build_message</strong>(connection, context)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L244-L270'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='244' data-end='270'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 244</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_build_message'>build_message</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)
  <span class='kw'>if</span> <span class='kw'>self</span>.<span class='id identifier rubyid_session'>session</span> <span class='op'>!=</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_session'>session</span>
    <span class='kw'>if</span> <span class='kw'>self</span>.<span class='id identifier rubyid_session'>session</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InternalDriverError.html" title="Mongo::Error::InternalDriverError (class)">InternalDriverError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Operation session </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span>.<span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> does not match context session </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='comment'># Some operations are not constructed with sessions but are
</span>      <span class='comment'># executed in a context where a session is available.
</span>      <span class='comment'># This could be OK or a driver issue.
</span>      <span class='comment'># TODO investigate.
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>super</span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_message'>message</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_session'>session</span>
      <span class='comment'># Serialize the message to detect client-side problems,
</span>      <span class='comment'># such as invalid BSON keys or too large messages.
</span>      <span class='comment'># The message will be serialized again
</span>      <span class='comment'># later prior to being sent to the connection.
</span>      <span class='id identifier rubyid_buf'>buf</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>ByteBuffer</span>.<span class='id identifier rubyid_new'>new</span>
      <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_serialize'>serialize</span>(<span class='id identifier rubyid_buf'>buf</span>)
      <span class='kw'>if</span> <span class='id identifier rubyid_buf'>buf</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_max_message_size'>max_message_size</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/MaxMessageSize.html" title="Mongo::Error::MaxMessageSize (class)">MaxMessageSize</a></span>.<span class='id identifier rubyid_new'><a href="../Error/MaxMessageSize.html#new-class_method" title="Mongo::Error::MaxMessageSize.new (method)">new</a></span>(<span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_max_message_size'>max_message_size</span>)
      <span class='kw'>end</span>
      <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_update_state!'>update_state!</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="command-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>command</strong>(connection)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L128-L151'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='128' data-end='151'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 128</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_command'>command</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>if</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span><span class='op'>::</span><span class='const'><a href="../Server/Connection.html" title="Mongo::Server::Connection (class)">Connection</a></span>)
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connection is not a Connection instance: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection'>connection</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_sel'>sel</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Document</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_selector'>selector</span>(<span class='id identifier rubyid_connection'>connection</span>))
  <span class='id identifier rubyid_add_write_concern!'><a href="#add_write_concern!-instance_method" title="Mongo::Operation::SessionsSupported#add_write_concern! (method)">add_write_concern!</a></span>(<span class='id identifier rubyid_sel'>sel</span>)
  <span class='id identifier rubyid_sel'>sel</span>[<span class='const'><a href="../Protocol.html" title="Mongo::Protocol (module)">Protocol</a></span><span class='op'>::</span><span class='const'><a href="../Protocol/Msg.html" title="Mongo::Protocol::Msg (class)">Msg</a></span><span class='op'>::</span><span class='const'><a href="../Protocol/Msg.html#DATABASE_IDENTIFIER-constant" title="Mongo::Protocol::Msg::DATABASE_IDENTIFIER (constant)">DATABASE_IDENTIFIER</a></span>] <span class='op'>=</span> <span class='id identifier rubyid_db_name'>db_name</span>

  <span class='id identifier rubyid_add_read_preference'><a href="#add_read_preference-instance_method" title="Mongo::Operation::SessionsSupported#add_read_preference (method)">add_read_preference</a></span>(<span class='id identifier rubyid_sel'>sel</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_sessions_enabled?'>sessions_enabled?</span>
    <span class='id identifier rubyid_apply_cluster_time!'><a href="#apply_cluster_time!-instance_method" title="Mongo::Operation::SessionsSupported#apply_cluster_time! (method)">apply_cluster_time!</a></span>(<span class='id identifier rubyid_sel'>sel</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> (<span class='id identifier rubyid_acknowledged_write?'>acknowledged_write?</span> <span class='op'>||</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_in_transaction?'>in_transaction?</span>)
      <span class='id identifier rubyid_apply_session_options'><a href="#apply_session_options-instance_method" title="Mongo::Operation::SessionsSupported#apply_session_options (method)">apply_session_options</a></span>(<span class='id identifier rubyid_sel'>sel</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
    <span class='kw'>end</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_explicit?'>explicit?</span>
    <span class='id identifier rubyid_apply_session_options'><a href="#apply_session_options-instance_method" title="Mongo::Operation::SessionsSupported#apply_session_options (method)">apply_session_options</a></span>(<span class='id identifier rubyid_sel'>sel</span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_sel'>sel</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="flags-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>flags</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L75-L77'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='75' data-end='77'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 75</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_flags'>flags</span>
  <span class='id identifier rubyid_acknowledged_write?'>acknowledged_write?</span> <span class='op'>?</span> [] <span class='op'>:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_more_to_come'>more_to_come</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_command?-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>read_command?</strong>(sel)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L92-L94'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='92' data-end='94'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 92</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_command?'>read_command?</span>(<span class='id identifier rubyid_sel'>sel</span>)
  <span class='const'><a href="#READ_COMMANDS-constant" title="Mongo::Operation::SessionsSupported::READ_COMMANDS (constant)">READ_COMMANDS</a></span>.<span class='id identifier rubyid_any?'>any?</span> { <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_sel'>sel</span>[<span class='id identifier rubyid_c'>c</span>] }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="suppress_read_write_concern!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>suppress_read_write_concern!</strong>(selector)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L120-L122'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='120' data-end='122'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 120</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_suppress_read_write_concern!'>suppress_read_write_concern!</span>(<span class='id identifier rubyid_selector'>selector</span>)
  <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_suppress_read_write_concern!'>suppress_read_write_concern!</span>(<span class='id identifier rubyid_selector'>selector</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_read_preference!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>validate_read_preference!</strong>(selector)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.2</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/operation/shared/sessions_supported.rb#L124-L126'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='124' data-end='126'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/operation/shared/sessions_supported.rb', line 124</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_read_preference!'>validate_read_preference!</span>(<span class='id identifier rubyid_selector'>selector</span>)
  <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_validate_read_preference!'>validate_read_preference!</span>(<span class='id identifier rubyid_selector'>selector</span>) <span class='kw'>if</span> <span class='id identifier rubyid_read_command?'><a href="#read_command%3F-instance_method" title="Mongo::Operation::SessionsSupported#read_command? (method)">read_command?</a></span>(<span class='id identifier rubyid_selector'>selector</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>