<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Server::ConnectionPool &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Server::ConnectionPool",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongo master</a> &raquo; 
      <a href='../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../Server.html" title="Mongo::Server (class)">Server</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ConnectionPool&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Server::ConnectionPool</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a href="ConnectionPool/GenerationManager.html" title="Mongo::Server::ConnectionPool::GenerationManager (class)"><code>GenerationManager</code></a>,
        <a href="ConnectionPool/Populator.html" title="Mongo::Server::ConnectionPool::Populator (class)"><code>Populator</code></a>      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          Forwardable
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="../Monitoring/Publishable.html" title="Mongo::Monitoring::Publishable (module)"><code>::Mongo::Monitoring::Publishable</code></a>,
          <a href="../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2 o'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L24'>lib/mongo/server/connection_pool.rb</a><span class='defines'>,<br /><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool/generation_manager.rb#L20'>lib/mongo/server/connection_pool/generation_manager.rb</a>,<br/> <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool/populator.rb#L20'>lib/mongo/server/connection_pool/populator.rb</a></span>
      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Represents a connection pool for server connections.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='DEFAULT_MAX_CONNECTING-constant' class='summary_signature'>DEFAULT_MAX_CONNECTING =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The default maximum number of connections that can be connecting at any given time.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L41-L41'># File 'lib/mongo/server/connection_pool.rb', line 41</a>    <pre class='code ruby'><span class='int'>2</span></pre>
  </li>
  <li>
    <span id='DEFAULT_MAX_SIZE-constant' class='summary_signature'>DEFAULT_MAX_SIZE =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The default max size for the connection pool.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L32-L32'># File 'lib/mongo/server/connection_pool.rb', line 32</a>    <pre class='code ruby'><span class='int'>20</span></pre>
  </li>
  <li>
    <span id='DEFAULT_MIN_SIZE-constant' class='summary_signature'>DEFAULT_MIN_SIZE =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The default min size for the connection pool.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L37-L37'># File 'lib/mongo/server/connection_pool.rb', line 37</a>    <pre class='code ruby'><span class='int'>0</span></pre>
  </li>
  <li>
    <span id='DEFAULT_WAIT_TIMEOUT-constant' class='summary_signature'>DEFAULT_WAIT_TIMEOUT =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The default timeout, in seconds, to wait for a connection.</p>

<p>This timeout applies while in flow threads are waiting for background threads to establish connections (and hence they must connect, handshake and auth in the allotted time).</p>

<p>It is currently set to 10 seconds. The default connect timeout is 10 seconds by itself, but setting large timeouts can get applications in trouble if their requests get timed out by the reverse proxy, thus anything over 15 seconds is potentially dangerous.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L55-L55'># File 'lib/mongo/server/connection_pool.rb', line 55</a>    <pre class='code ruby'><span class='int'>10</span>.<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
</ul>
  <h3 class='inherited'><a href="../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="../Loggable.html#PREFIX-constant" title="Mongo::Loggable::PREFIX (constant)">PREFIX</a>
  </p>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#finalize-class_method" title=".finalize (class method)">.<strong>finalize</strong>(available_connections, pending_connections, populator)  &#x21d2; Proc </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Finalize the connection pool for garbage collection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(server, options = {})  &#x21d2; ConnectionPool </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Create the new connection pool.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#closed%3F-instance_method" title="#closed? (instance method)">#<strong>closed?</strong>  &#x21d2; true | false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Whether the pool has been closed.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#generation_manager-instance_method" title="#generation_manager (instance method)">#<strong>generation_manager</strong>  &#x21d2; Integer </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#max_connecting-instance_method" title="#max_connecting (instance method)">#<strong>max_connecting</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#options-instance_method" title="#options (instance method)">#<strong>options</strong>  &#x21d2; Hash </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#paused%3F-instance_method" title="#paused? (instance method)">#<strong>paused?</strong>  &#x21d2; true | false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>A connection pool is paused if it is not closed and it is not ready.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#populate_semaphore-instance_method" title="#populate_semaphore (instance method)">#<strong>populate_semaphore</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Condition variable broadcast when the size of the pool changes to wake up the populator.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#populator-instance_method" title="#populator (instance method)">#<strong>populator</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#ready%3F-instance_method" title="#ready? (instance method)">#<strong>ready?</strong>  &#x21d2; true | false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Whether the pool is ready.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#server-instance_method" title="#server (instance method)">#<strong>server</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>

<h3 class='inherited'><a href="../Monitoring/Publishable.html" title="Mongo::Monitoring::Publishable (module)"><code>::Mongo::Monitoring::Publishable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="../Monitoring/Publishable.html#monitoring-instance_method" title="Mongo::Monitoring::Publishable#monitoring (method)">#monitoring</a>,
        <a class='i_m ro priv' href="../Monitoring/Publishable.html#monitoring%3F-instance_method" title="Mongo::Monitoring::Publishable#monitoring? (method)">#monitoring?</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#available_count-instance_method" title="#available_count (instance method)">#<strong>available_count</strong>  &#x21d2; Integer </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Number of available connections in the pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#check_in-instance_method" title="#check_in (instance method)">#<strong>check_in</strong>(connection)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Check a connection back into the pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#check_out-instance_method" title="#check_out (instance method)">#<strong>check_out</strong>(connection_global_id: nil, context: nil)  &#x21d2; Mongo::Server::Connection </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Checks a connection out of the pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#clear-instance_method" title="#clear (instance method)">#<strong>clear</strong>(options = nil)  &#x21d2; true </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Closes all idle connections in the pool and schedules currently checked out connections to be closed when they are checked back into the pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#close-instance_method" title="#close (instance method)">#<strong>close</strong>(options = nil)  &#x21d2; true </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Marks the pool closed, closes all idle connections in the pool and schedules currently checked out connections to be closed when they are checked back into the pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#close_idle_sockets-instance_method" title="#close_idle_sockets (instance method)">#<strong>close_idle_sockets</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Close sockets that have been open for longer than the max idle time,.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#disconnect!-instance_method" title="#disconnect! (instance method)">#<strong>disconnect!</strong>(options = nil)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Disconnects the pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#do_check_in-instance_method" title="#do_check_in (instance method)">#<strong>do_check_in</strong>(connection)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Executes the check in after having already acquired the lock.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#do_clear-instance_method" title="#do_clear (instance method)">#<strong>do_clear</strong>(options = nil)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#do_pause-instance_method" title="#do_pause (instance method)">#<strong>do_pause</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Mark the connection pool as paused without acquiring the lock.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#inspect-instance_method" title="#inspect (instance method)">#<strong>inspect</strong>  &#x21d2; String </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Get a pretty printed string inspection for the pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#max_idle_time-instance_method" title="#max_idle_time (instance method)">#<strong>max_idle_time</strong>  &#x21d2; Float | nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>The maximum seconds a socket can remain idle since it has been checked in to the pool, if set.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#max_size-instance_method" title="#max_size (instance method)">#<strong>max_size</strong>  &#x21d2; Integer </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Get the maximum size of the connection pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#min_size-instance_method" title="#min_size (instance method)">#<strong>min_size</strong>  &#x21d2; Integer </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Get the minimum size of the connection pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#pause-instance_method" title="#pause (instance method)">#<strong>pause</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Mark the connection pool as paused.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#populate-instance_method" title="#populate (instance method)">#<strong>populate</strong>  &#x21d2; true | false </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>This method does three things: 1.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#ready-instance_method" title="#ready (instance method)">#<strong>ready</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Instructs the pool to create and return connections.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#size-instance_method" title="#size (instance method)">#<strong>size</strong>  &#x21d2; Integer </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Size of the connection pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#stop_populator-instance_method" title="#stop_populator (instance method)">#<strong>stop_populator</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Stop the background populator thread and clean up any connections created which have not been connected yet.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#summary-instance_method" title="#summary (instance method)">#<strong>summary</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#unavailable_connections-instance_method" title="#unavailable_connections (instance method)">#<strong>unavailable_connections</strong>  &#x21d2; Integer </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#wait_timeout-instance_method" title="#wait_timeout (instance method)">#<strong>wait_timeout</strong>(context = nil)  &#x21d2; Float </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>The time to wait, in seconds, for a connection to become available.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#with_connection-instance_method" title="#with_connection (instance method)">#<strong>with_connection</strong>(connection_global_id: nil, context: nil)  &#x21d2; Object </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Yield the block to a connection, while handling check in/check out logic.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#check_invariants-instance_method" title="#check_invariants (instance method)">#<strong>check_invariants</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#clear_pending_connections-instance_method" title="#clear_pending_connections (instance method)">#<strong>clear_pending_connections</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Clear and disconnect the pending connections.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#close_available_connections-instance_method" title="#close_available_connections (instance method)">#<strong>close_available_connections</strong>(service_id)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Close the available connections.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#connect_connection-instance_method" title="#connect_connection (instance method)">#<strong>connect_connection</strong>(connection, context = nil)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Attempts to connect (handshake and auth) the connection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#connect_or_raise-instance_method" title="#connect_or_raise (instance method)">#<strong>connect_or_raise</strong>(connection, context)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Connects a connection and raises an exception if the connection cannot be connected.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#connection_stale_unlocked%3F-instance_method" title="#connection_stale_unlocked? (instance method)">#<strong>connection_stale_unlocked?</strong>(connection)  &#x21d2; true | false </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Checks whether a connection is stale.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#create_and_add_connection-instance_method" title="#create_and_add_connection (instance method)">#<strong>create_and_add_connection</strong>  &#x21d2; true | false </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Create a connection, connect it, and add it to the pool.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#create_connection-instance_method" title="#create_connection (instance method)">#<strong>create_connection</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#decrement_connection_requests_and_signal-instance_method" title="#decrement_connection_requests_and_signal (instance method)">#<strong>decrement_connection_requests_and_signal</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Decrement connection requests counter and signal the condition variables that the number of unavailable connections has decreased.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#get_connection-instance_method" title="#get_connection (instance method)">#<strong>get_connection</strong>(pid, connection_global_id)  &#x21d2; Mongo::Server::Connection </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Retrieves a connection if one is available, otherwise we create a new one.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#maybe_raise_pool_cleared!-instance_method" title="#maybe_raise_pool_cleared! (instance method)">#<strong>maybe_raise_pool_cleared!</strong>(connection, e)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>If the connection was interrupted, raise a pool cleared error.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#next_available_connection-instance_method" title="#next_available_connection (instance method)">#<strong>next_available_connection</strong>(connection_global_id)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the next available connection, optionally with given global id.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#raise_check_out_timeout!-instance_method" title="#raise_check_out_timeout! (instance method)">#<strong>raise_check_out_timeout!</strong>(connection_global_id)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>The lock should be acquired when calling this method.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#raise_check_out_timeout_locked!-instance_method" title="#raise_check_out_timeout_locked! (instance method)">#<strong>raise_check_out_timeout_locked!</strong>(connection_global_id)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#raise_if_closed!-instance_method" title="#raise_if_closed! (instance method)">#<strong>raise_if_closed!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Asserts that the pool has not been closed.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#raise_if_not_ready!-instance_method" title="#raise_if_not_ready! (instance method)">#<strong>raise_if_not_ready!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>The lock should be acquired when calling this method.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#raise_if_pool_closed!-instance_method" title="#raise_if_pool_closed! (instance method)">#<strong>raise_if_pool_closed!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#raise_if_pool_paused!-instance_method" title="#raise_if_pool_paused! (instance method)">#<strong>raise_if_pool_paused!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#raise_if_pool_paused_locked!-instance_method" title="#raise_if_pool_paused_locked! (instance method)">#<strong>raise_if_pool_paused_locked!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#raise_unless_locked!-instance_method" title="#raise_unless_locked! (instance method)">#<strong>raise_unless_locked!</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#remove_interrupted_connections-instance_method" title="#remove_interrupted_connections (instance method)">#<strong>remove_interrupted_connections</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Interrupt connections scheduled for interruption.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#remove_stale_connection-instance_method" title="#remove_stale_connection (instance method)">#<strong>remove_stale_connection</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Removes and disconnects all stale available connections.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#retrieve_and_connect_connection-instance_method" title="#retrieve_and_connect_connection (instance method)">#<strong>retrieve_and_connect_connection</strong>(connection_global_id, context = nil)  &#x21d2; Mongo::Server::Connection </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Retrieves a connection and connects it.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#schedule_for_interruption-instance_method" title="#schedule_for_interruption (instance method)">#<strong>schedule_for_interruption</strong>(connections, service_id)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Schedule connections of previous generations for interruption.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#unsynchronized_size-instance_method" title="#unsynchronized_size (instance method)">#<strong>unsynchronized_size</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the size of the connection pool without acquiring the lock.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#valid_available_connection%3F-instance_method" title="#valid_available_connection? (instance method)">#<strong>valid_available_connection?</strong>(connection, pid, connection_global_id)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#wait_for_connection-instance_method" title="#wait_for_connection (instance method)">#<strong>wait_for_connection</strong>(connection_global_id, deadline)  &#x21d2; Mongo::Server::Connection </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Waits for a connection to become available, or raises is no connection becomes available before the timeout.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited'><a href="../Monitoring/Publishable.html" title="Mongo::Monitoring::Publishable (module)"><code>::Mongo::Monitoring::Publishable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="../Monitoring/Publishable.html#publish_cmap_event-instance_method" title="Mongo::Monitoring::Publishable#publish_cmap_event (method)">#publish_cmap_event</a>,
        <a class='i_m deprecated' href="../Monitoring/Publishable.html#publish_event-instance_method" title="Mongo::Monitoring::Publishable#publish_event (method)">#publish_event</a>,
        <a class='i_m ' href="../Monitoring/Publishable.html#publish_sdam_event-instance_method" title="Mongo::Monitoring::Publishable#publish_sdam_event (method)">#publish_sdam_event</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_completed-instance_method" title="Mongo::Monitoring::Publishable#command_completed (method)">#command_completed</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_failed-instance_method" title="Mongo::Monitoring::Publishable#command_failed (method)">#command_failed</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_started-instance_method" title="Mongo::Monitoring::Publishable#command_started (method)">#command_started</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_succeeded-instance_method" title="Mongo::Monitoring::Publishable#command_succeeded (method)">#command_succeeded</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#duration-instance_method" title="Mongo::Monitoring::Publishable#duration (method)">#duration</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_debug-instance_method" title="Mongo::Loggable#log_debug (method)">#log_debug</a></td>
      <td><div class='inline'><p>Convenience method to log debug messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_error-instance_method" title="Mongo::Loggable#log_error (method)">#log_error</a></td>
      <td><div class='inline'><p>Convenience method to log error messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_fatal-instance_method" title="Mongo::Loggable#log_fatal (method)">#log_fatal</a></td>
      <td><div class='inline'><p>Convenience method to log fatal messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_info-instance_method" title="Mongo::Loggable#log_info (method)">#log_info</a></td>
      <td><div class='inline'><p>Convenience method to log info messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_warn-instance_method" title="Mongo::Loggable#log_warn (method)">#log_warn</a></td>
      <td><div class='inline'><p>Convenience method to log warn messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#logger-instance_method" title="Mongo::Loggable#logger (method)">#logger</a></td>
      <td><div class='inline'><p>Get the logger instance.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="../Loggable.html#_mongo_log_prefix-instance_method" title="Mongo::Loggable#_mongo_log_prefix (method)">#_mongo_log_prefix</a>,
        <a class='i_m priv' href="../Loggable.html#format_message-instance_method" title="Mongo::Loggable#format_message (method)">#format_message</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(server, options = {})  &#x21d2; <code>ConnectionPool</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Create the new connection pool.</p>

<p>Note: Additionally, options for connections created by this pool should</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_be'>be</span> <span class='id identifier rubyid_included'>included</span> <span class='kw'>in</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='id identifier rubyid_passed'>passed</span> <span class='id identifier rubyid_here'>here</span><span class='comma'>,</span> <span class='kw'>and</span> <span class='id identifier rubyid_they'>they</span> <span class='id identifier rubyid_will'>will</span> <span class='id identifier rubyid_be'>be</span> <span class='id identifier rubyid_forwarded'>forwarded</span> <span class='id identifier rubyid_to'>to</span>
<span class='id identifier rubyid_any'>any</span> <span class='id identifier rubyid_connections'>connections</span> <span class='id identifier rubyid_created'>created</span> <span class='id identifier rubyid_by'>by</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_pool'><a href="../Server.html#pool-instance_method" title="Mongo::Server#pool (method)">pool</a></span>.</code></pre>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>server</span>
    <span class='type'>(<a href="../Server.html" title="Mongo::Server (class)">Server</a>)</span>
&mdash;    <div class='inline'>
<p>The server which this connection pool is for.</p>
</div>
  </li>
  <li>
    <span class='name'>options</span>
    <span class='type'>(<code>Hash</code>)</span>
    <em class='default'>(defaults to: <tt>{}</tt>)</em>
&mdash;    <div class='inline'>
<p>The connection pool options.</p>
</div>
  </li>
</ul>
    <p class='tag_title'>Options Hash (<tt>options</tt>):</p>
    <ul class='option'>
        <li>
          <span class='name'>:max_size</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>The maximum pool size. Setting this option to zero creates an unlimited connection pool.</p>
</div>        </li>
        <li>
          <span class='name'>:max_connecting</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>The maximum number of connections that can be connecting simultaneously. The default is 2. This option should be increased if there are many threads that share same connection pool and the application is experiencing timeouts while waiting for connections to be established.</p>
</div>        </li>
        <li>
          <span class='name'>:max_pool_size</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>Deprecated. The maximum pool size. If max_size is also given, max_size and max_pool_size must be identical.</p>
</div>        </li>
        <li>
          <span class='name'>:min_size</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>The minimum pool size.</p>
</div>        </li>
        <li>
          <span class='name'>:min_pool_size</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>Deprecated. The minimum pool size. If min_size is also given, min_size and min_pool_size must be identical.</p>
</div>        </li>
        <li>
          <span class='name'>:wait_timeout</span>
          <span class='type'>(<code>Float</code>)</span>
            &mdash; <div class='inline'>
<p>The time to wait, in seconds, for a free connection.</p>
</div>        </li>
        <li>
          <span class='name'>:wait_queue_timeout</span>
          <span class='type'>(<code>Float</code>)</span>
            &mdash; <div class='inline'>
<p>Deprecated. Alias for <code>:wait_timeout</code>. If both wait_timeout and wait_queue_timeout are given, their values must be identical.</p>
</div>        </li>
        <li>
          <span class='name'>:max_idle_time</span>
          <span class='type'>(<code>Float</code>)</span>
            &mdash; <div class='inline'>
<p>The time, in seconds, after which idle connections should be closed by the pool.</p>
</div>        </li>
        <li>
          <span class='name'>:populator_io</span>
          <span class='type'>(<code>true</code>, <code>false</code>)</span>
            &mdash; <div class='inline'>
<p>For internal driver use only. Set to false to prevent the populator threads from being created and started in the server’s connection pool. It is intended for use in tests that also turn off monitoring_io, unless the populator is explicitly needed. If monitoring_io is off, but the populator_io is on, the populator needs to be manually closed at the end of the test, since a cluster without monitoring is considered not connected, and thus will not clean up the connection pool populator threads on close.</p>
</div>        </li>
    </ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, API changed in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L102-L177'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='102' data-end='177'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 102</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_server'><a href="#server-instance_method" title="Mongo::Server::ConnectionPool#server (method)">server</a></span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>=</span> {})
  <span class='kw'>unless</span> <span class='id identifier rubyid_server'><a href="#server-instance_method" title="Mongo::Server::ConnectionPool#server (method)">server</a></span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>First argument must be a Server instance</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>.<span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span>] <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_pool_size'>min_pool_size</span>] <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span>] <span class='op'>!=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_pool_size'>min_pool_size</span>]
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Min size </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span>]<span class='embexpr_end'>}</span><span class='tstring_content'> is not identical to min pool size </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_pool_size'>min_pool_size</span>]<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span>] <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_pool_size'>max_pool_size</span>] <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span>] <span class='op'>!=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_pool_size'>max_pool_size</span>]
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Max size </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span>]<span class='embexpr_end'>}</span><span class='tstring_content'> is not identical to max pool size </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_pool_size'>max_pool_size</span>]<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wait_timeout'><a href="#wait_timeout-instance_method" title="Mongo::Server::ConnectionPool#wait_timeout (method)">wait_timeout</a></span>] <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wait_queue_timeout'>wait_queue_timeout</span>] <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wait_timeout'><a href="#wait_timeout-instance_method" title="Mongo::Server::ConnectionPool#wait_timeout (method)">wait_timeout</a></span>] <span class='op'>!=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wait_queue_timeout'>wait_queue_timeout</span>]
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Wait timeout </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wait_timeout'><a href="#wait_timeout-instance_method" title="Mongo::Server::ConnectionPool#wait_timeout (method)">wait_timeout</a></span>]<span class='embexpr_end'>}</span><span class='tstring_content'> is not identical to wait queue timeout </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wait_queue_timeout'>wait_queue_timeout</span>]<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span>] <span class='op'>||=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_pool_size'>min_pool_size</span>]
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_min_pool_size'>min_pool_size</span>)
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span>] <span class='op'>||=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_pool_size'>max_pool_size</span>]
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_max_pool_size'>max_pool_size</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span>] <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span>] <span class='op'>&amp;&amp;</span>
    (<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span>] <span class='op'>!=</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span>] <span class='op'>&gt;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span>])
  <span class='kw'>then</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cannot have min size </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span>]<span class='embexpr_end'>}</span><span class='tstring_content'> exceed max size </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span>]<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wait_queue_timeout'>wait_queue_timeout</span>]
    <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wait_timeout'><a href="#wait_timeout-instance_method" title="Mongo::Server::ConnectionPool#wait_timeout (method)">wait_timeout</a></span>] <span class='op'>||=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wait_queue_timeout'>wait_queue_timeout</span>]
  <span class='kw'>end</span>
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_wait_queue_timeout'>wait_queue_timeout</span>)

  <span class='ivar'>@server</span> <span class='op'>=</span> <span class='id identifier rubyid_server'><a href="#server-instance_method" title="Mongo::Server::ConnectionPool#server (method)">server</a></span>
  <span class='ivar'>@options</span> <span class='op'>=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>.<span class='id identifier rubyid_freeze'>freeze</span>

  <span class='ivar'>@generation_manager</span> <span class='op'>=</span> <span class='const'><a href="ConnectionPool/GenerationManager.html" title="Mongo::Server::ConnectionPool::GenerationManager (class)">GenerationManager</a></span>.<span class='id identifier rubyid_new'><a href="ConnectionPool/GenerationManager.html#new-class_method" title="Mongo::Server::ConnectionPool::GenerationManager.new (method)">new</a></span>(<span class='label'>server:</span> <span class='id identifier rubyid_server'><a href="#server-instance_method" title="Mongo::Server::ConnectionPool#server (method)">server</a></span>)
  <span class='ivar'>@ready</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@closed</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># A connection owned by this pool should be either in the
</span>  <span class='comment'># available connections array (which is used as a stack)
</span>  <span class='comment'># or in the checked out connections set.
</span>  <span class='ivar'>@available_connections</span> <span class='op'>=</span> <span class='id identifier rubyid_available_connections'>available_connections</span> <span class='op'>=</span> []
  <span class='ivar'>@checked_out_connections</span> <span class='op'>=</span> <span class='const'>Set</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@pending_connections</span> <span class='op'>=</span> <span class='const'>Set</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@interrupt_connections</span> <span class='op'>=</span> []

  <span class='comment'># Mutex used for synchronizing access to @available_connections and
</span>  <span class='comment'># @checked_out_connections. The pool object is thread-safe, thus
</span>  <span class='comment'># all methods that retrieve or modify instance variables generally
</span>  <span class='comment'># must do so under this lock.
</span>  <span class='ivar'>@lock</span> <span class='op'>=</span> <span class='const'>Mutex</span>.<span class='id identifier rubyid_new'>new</span>

  <span class='comment'># Background thread reponsible for maintaining the size of
</span>  <span class='comment'># the pool to at least min_size
</span>  <span class='ivar'>@populator</span> <span class='op'>=</span> <span class='const'><a href="ConnectionPool/Populator.html" title="Mongo::Server::ConnectionPool::Populator (class)">Populator</a></span>.<span class='id identifier rubyid_new'><a href="ConnectionPool/Populator.html#new-class_method" title="Mongo::Server::ConnectionPool::Populator.new (method)">new</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>)
  <span class='ivar'>@populate_semaphore</span> <span class='op'>=</span> <span class='const'><a href="../Semaphore.html" title="Mongo::Semaphore (class)">Semaphore</a></span>.<span class='id identifier rubyid_new'><a href="../Semaphore.html#new-class_method" title="Mongo::Semaphore.new (method)">new</a></span>

  <span class='comment'># Condition variable to enforce the first check in check_out: max_pool_size.
</span>  <span class='comment'># This condition variable should be signaled when the number of
</span>  <span class='comment'># unavailable connections decreases (pending + pending_connections +
</span>  <span class='comment'># checked_out_connections).
</span>  <span class='ivar'>@size_cv</span> <span class='op'>=</span> <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../ConditionVariable.html" title="Mongo::ConditionVariable (class)">ConditionVariable</a></span>.<span class='id identifier rubyid_new'><a href="../ConditionVariable.html#new-class_method" title="Mongo::ConditionVariable.new (method)">new</a></span>(<span class='ivar'>@lock</span>)
  <span class='comment'># This represents the number of threads that have made it past the size_cv
</span>  <span class='comment'># gate but have not acquired a connection to add to the pending_connections
</span>  <span class='comment'># set.
</span>  <span class='ivar'>@connection_requests</span> <span class='op'>=</span> <span class='int'>0</span>

  <span class='comment'># Condition variable to enforce the second check in check_out: max_connecting.
</span>  <span class='comment'># Thei condition variable should be signaled when the number of pending
</span>  <span class='comment'># connections decreases.
</span>  <span class='ivar'>@max_connecting_cv</span> <span class='op'>=</span> <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../ConditionVariable.html" title="Mongo::ConditionVariable (class)">ConditionVariable</a></span>.<span class='id identifier rubyid_new'><a href="../ConditionVariable.html#new-class_method" title="Mongo::ConditionVariable.new (method)">new</a></span>(<span class='ivar'>@lock</span>)
  <span class='ivar'>@max_connecting</span> <span class='op'>=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_max_connecting'><a href="#max_connecting-instance_method" title="Mongo::Server::ConnectionPool#max_connecting (method)">max_connecting</a></span><span class='comma'>,</span> <span class='const'><a href="#DEFAULT_MAX_CONNECTING-constant" title="Mongo::Server::ConnectionPool::DEFAULT_MAX_CONNECTING (constant)">DEFAULT_MAX_CONNECTING</a></span>)

  <span class='const'>ObjectSpace</span>.<span class='id identifier rubyid_define_finalizer'>define_finalizer</span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='kw'>self</span>.<span class='id identifier rubyid_class'>class</span>.<span class='id identifier rubyid_finalize'><a href="#finalize-class_method" title="Mongo::Server::ConnectionPool.finalize (method)">finalize</a></span>(<span class='ivar'>@available_connections</span><span class='comma'>,</span> <span class='ivar'>@pending_connections</span><span class='comma'>,</span> <span class='ivar'>@populator</span>))

  <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
    <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/PoolCreated.html" title="Mongo::Monitoring::Event::Cmap::PoolCreated (class)">PoolCreated</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/PoolCreated.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::PoolCreated.new (method)">new</a></span>(<span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  )
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Class Method Details</h2>
<section class='method_details first' id="finalize-class_method">
  <h3 class='signature  first'>
    .<strong>finalize</strong>(available_connections, pending_connections, populator)  &#x21d2; <code>Proc</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Finalize the connection pool for garbage collection.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>available_connections</span>
    <span class='type'>(<code>List</code>&lt;<code>Mongo::Connection</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The available connections.</p>
</div>
  </li>
  <li>
    <span class='name'>pending_connections</span>
    <span class='type'>(<code>List</code>&lt;<code>Mongo::Connection</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The pending connections.</p>
</div>
  </li>
  <li>
    <span class='name'>populator</span>
    <span class='type'>(<a href="ConnectionPool/Populator.html" title="Mongo::Server::ConnectionPool::Populator (class)">Populator</a>)</span>
&mdash;    <div class='inline'>
<p>The populator.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Proc</code>)</span>
&mdash;    <div class='inline'>
<p>The Finalizer.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L814-L830'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='814' data-end='830'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 814</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_finalize'>finalize</span>(<span class='id identifier rubyid_available_connections'>available_connections</span><span class='comma'>,</span> <span class='id identifier rubyid_pending_connections'>pending_connections</span><span class='comma'>,</span> <span class='id identifier rubyid_populator'><a href="#populator-instance_method" title="Mongo::Server::ConnectionPool#populator (method)">populator</a></span>)
  <span class='id identifier rubyid_proc'>proc</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_available_connections'>available_connections</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
      <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pool_closed'>pool_closed</span>)
    <span class='kw'>end</span>
    <span class='id identifier rubyid_available_connections'>available_connections</span>.<span class='id identifier rubyid_clear'><a href="#clear-instance_method" title="Mongo::Server::ConnectionPool#clear (method)">clear</a></span>

    <span class='id identifier rubyid_pending_connections'>pending_connections</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
      <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pool_closed'>pool_closed</span>)
    <span class='kw'>end</span>
    <span class='id identifier rubyid_pending_connections'>pending_connections</span>.<span class='id identifier rubyid_clear'><a href="#clear-instance_method" title="Mongo::Server::ConnectionPool#clear (method)">clear</a></span>

    <span class='comment'># Finalizer does not close checked out connections.
</span>    <span class='comment'># Those would have to be garbage collected on their own
</span>    <span class='comment'># and that should close them.
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="closed?-instance_method">
  <h3 class='signature ro first'>
    #<strong>closed?</strong>  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Whether the pool has been closed.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the pool is closed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L304-L306'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='304' data-end='306'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 304</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_closed?'>closed?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='ivar'>@closed</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="generation_manager-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>generation_manager</strong>  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>generation Generation of connections currently being used by the queue.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L233-L233'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='233' data-end='233'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 233</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_generation_manager'>generation_manager</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="max_connecting-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>max_connecting</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L342-L342'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='342' data-end='342'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 342</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_max_connecting'>max_connecting</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="options-instance_method">
  <h3 class='signature ro'>
    #<strong>options</strong>  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>options The pool options.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L180-L180'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='180' data-end='180'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 180</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_options'>options</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="paused?-instance_method">
  <h3 class='signature ro'>
    #<strong>paused?</strong>  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>A connection pool is paused if it is not closed and it is not ready.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>whether the connection pool is paused.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/PoolClosedError.html" title="Mongo::Error::PoolClosedError (class)">Error::PoolClosedError</a>)</span>
&mdash;    <div class='inline'>
<p>If the pool has been closed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L246-L252'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='246' data-end='252'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 246</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_paused?'>paused?</span>
  <span class='id identifier rubyid_raise_if_closed!'><a href="#raise_if_closed!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_closed! (method)">raise_if_closed!</a></span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='op'>!</span><span class='ivar'>@ready</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="populate_semaphore-instance_method">
  <h3 class='signature ro'>
    #<strong>populate_semaphore</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Condition variable broadcast when the size of the pool changes to wake up the populator</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L59-L59'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='59' data-end='59'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 59</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_populate_semaphore'>populate_semaphore</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="populator-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>populator</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L339-L339'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='339' data-end='339'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 339</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_populator'>populator</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ready?-instance_method">
  <h3 class='signature ro'>
    #<strong>ready?</strong>  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Whether the pool is ready.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the pool is ready.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L311-L315'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='311' data-end='315'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 311</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ready?'>ready?</span>
  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@ready</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="server-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>server</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L183-L183'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='183' data-end='183'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 183</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_server'>server</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="available_count-instance_method">
  <h3 class='signature  first'>
    #<strong>available_count</strong>  &#x21d2; <code>Integer</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Number of available connections in the pool.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>Number of available connections.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L291-L297'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='291' data-end='297'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 291</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_available_count'>available_count</span>
  <span class='id identifier rubyid_raise_if_closed!'><a href="#raise_if_closed!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_closed! (method)">raise_if_closed!</a></span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_length'>length</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="check_in-instance_method">
  <h3 class='signature '>
    #<strong>check_in</strong>(connection)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Check a connection back into the pool.</p>

<p>The connection must have been previously created by this pool.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>The connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L402-L410'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='402' data-end='410'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 402</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_check_in'>check_in</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='id identifier rubyid_check_invariants'><a href="#check_invariants-instance_method" title="Mongo::Server::ConnectionPool#check_invariants (method)">check_invariants</a></span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_do_check_in'><a href="#do_check_in-instance_method" title="Mongo::Server::ConnectionPool#do_check_in (method)">do_check_in</a></span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>end</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_check_invariants'><a href="#check_invariants-instance_method" title="Mongo::Server::ConnectionPool#check_invariants (method)">check_invariants</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="check_invariants-instance_method">
  <h3 class='signature priv'>
    #<strong>check_invariants</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1011-L1031'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1011' data-end='1031'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1011</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_check_invariants'>check_invariants</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>

  <span class='comment'># Server summary calls pool summary which requires pool lock -&gt; deadlock.
</span>  <span class='comment'># Obtain the server summary ahead of time.
</span>  <span class='id identifier rubyid_server_summary'>server_summary</span> <span class='op'>=</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_summary'><a href="#summary-instance_method" title="Mongo::Server::ConnectionPool#summary (method)">summary</a></span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Available connection is closed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection'>connection</span><span class='embexpr_end'>}</span><span class='tstring_content'> for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server_summary'>server_summary</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Pending connection is closed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection'>connection</span><span class='embexpr_end'>}</span><span class='tstring_content'> for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server_summary'>server_summary</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="check_out-instance_method">
  <h3 class='signature '>
    #<strong>check_out</strong>(connection_global_id: nil, context: nil)  &#x21d2; <a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Checks a connection out of the pool.</p>

<p>If there are active connections in the pool, the most recently used connection is returned. Otherwise if the connection pool size is less than the max size, creates a new connection and returns it. Otherwise waits up to the wait timeout and raises Timeout::Error if there are still no active connections and the pool is at max size.</p>

<p>The returned connection counts toward the pool’s max size. When the caller is finished using the connection, the connection should be checked back in via the check_in method.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>:connection_global_id</span>
    <span class='type'>(<code>Integer</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The global id for the connection to check out.</p>
</div>
  </li>
  <li>
    <span class='name'>:context</span>
    <span class='type'>(<code>Mongo::Operation:Context</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>Context of the operation the connection is requested for, if any.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>The checked out connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/PoolClosedError.html" title="Mongo::Error::PoolClosedError (class)">Error::PoolClosedError</a>)</span>
&mdash;    <div class='inline'>
<p>If the pool has been closed.</p>
</div>
  </li>
  <li>
    <span class='type'>(<code>Timeout::Error</code>)</span>
&mdash;    <div class='inline'>
<p>If the connection pool is at maximum size and remains so for longer than the wait timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L366-L393'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='366' data-end='393'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 366</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_check_out'>check_out</span>(<span class='label'>connection_global_id:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_check_invariants'><a href="#check_invariants-instance_method" title="Mongo::Server::ConnectionPool#check_invariants (method)">check_invariants</a></span>

  <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
    <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutStarted.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutStarted (class)">ConnectionCheckOutStarted</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutStarted.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutStarted.new (method)">new</a></span>(<span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span>)
  )

  <span class='id identifier rubyid_raise_if_pool_closed!'><a href="#raise_if_pool_closed!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_pool_closed! (method)">raise_if_pool_closed!</a></span>
  <span class='id identifier rubyid_raise_if_pool_paused_locked!'><a href="#raise_if_pool_paused_locked!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_pool_paused_locked! (method)">raise_if_pool_paused_locked!</a></span>

  <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='id identifier rubyid_retrieve_and_connect_connection'><a href="#retrieve_and_connect_connection-instance_method" title="Mongo::Server::ConnectionPool#retrieve_and_connect_connection (method)">retrieve_and_connect_connection</a></span>(
    <span class='id identifier rubyid_connection_global_id'>connection_global_id</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>
  )

  <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
    <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckedOut.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckedOut (class)">ConnectionCheckedOut</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/ConnectionCheckedOut.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckedOut.new (method)">new</a></span>(<span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='kw'>self</span>)<span class='comma'>,</span>
  )

  <span class='kw'>if</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_connected?'><a href="../Server.html#connected%3F-instance_method" title="Mongo::Server#connected? (method)">connected?</a></span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connection pool for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> checked out a disconnected connection </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_generation'>generation</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_connection'>connection</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_check_invariants'><a href="#check_invariants-instance_method" title="Mongo::Server::ConnectionPool#check_invariants (method)">check_invariants</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="clear-instance_method">
  <h3 class='signature '>
    #<strong>clear</strong>(options = nil)  &#x21d2; <code>true</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Closes all idle connections in the pool and schedules currently checked out connections to be closed when they are checked back into the pool. The pool is paused, it will not create new connections in background and it will fail checkout requests until marked ready.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>options</span>
    <span class='type'>(<code>Hash</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>a customizable set of options</p>
</div>
  </li>
</ul>
    <p class='tag_title'>Options Hash (<tt>options</tt>):</p>
    <ul class='option'>
        <li>
          <span class='name'>:lazy</span>
          <span class='type'>(<code>true</code> | <code>false</code>)</span>
            &mdash; <div class='inline'>
<p>If true, do not close any of the idle connections and instead let them be closed during a subsequent check out operation. Defaults to false.</p>
</div>        </li>
        <li>
          <span class='name'>:interrupt_in_use_connections</span>
          <span class='type'>(<code>true</code> | <code>false</code>)</span>
            &mdash; <div class='inline'>
<p>If true, close all checked out connections immediately. If it is false, do not close any of the checked out connections. Defaults to true.</p>
</div>        </li>
        <li>
          <span class='name'>:service_id</span>
          <span class='type'>(<code>Object</code>)</span>
            &mdash; <div class='inline'>
<p>Clear connections with the specified service id only.</p>
</div>        </li>
    </ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>)</span>
&mdash;    <div class='inline'>
<p>true.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.1.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L520-L528'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='520' data-end='528'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 520</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_clear'>clear</span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_raise_if_closed!'><a href="#raise_if_closed!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_closed! (method)">raise_if_closed!</a></span>

  <span class='kw'>if</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@server</span>.<span class='id identifier rubyid_unknown?'>unknown?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Attempting to clear pool for server </span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span>.<span class='id identifier rubyid_summary'><a href="#summary-instance_method" title="Mongo::Server::ConnectionPool#summary (method)">summary</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> which is known</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_do_clear'><a href="#do_clear-instance_method" title="Mongo::Server::ConnectionPool#do_clear (method)">do_clear</a></span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="clear_pending_connections-instance_method">
  <h3 class='signature priv'>
    #<strong>clear_pending_connections</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Clear and disconnect the pending connections.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1075-L1081'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1075' data-end='1081'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1075</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_clear_pending_connections'>clear_pending_connections</span>
  <span class='kw'>until</span> <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_take'>take</span>(<span class='int'>1</span>).<span class='id identifier rubyid_first'>first</span>
    <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>
    <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="close-instance_method">
  <h3 class='signature '>
    #<strong>close</strong>(options = nil)  &#x21d2; <code>true</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Marks the pool closed, closes all idle connections in the pool and schedules currently checked out connections to be closed when they are checked back into the pool. If force option is true, checked out connections are also closed. Attempts to use the pool after it is closed will raise <a href="../Error/PoolClosedError.html" title="Mongo::Error::PoolClosedError (class)"><code>::Mongo::Error::PoolClosedError</code></a>.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>options</span>
    <span class='type'>(<code>Hash</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>a customizable set of options</p>
</div>
  </li>
</ul>
    <p class='tag_title'>Options Hash (<tt>options</tt>):</p>
    <ul class='option'>
        <li>
          <span class='name'>:force</span>
          <span class='type'>(<code>true</code> | <code>false</code>)</span>
            &mdash; <div class='inline'>
<p>Also close all checked out connections.</p>
</div>        </li>
        <li>
          <span class='name'>:stay_ready</span>
          <span class='type'>(<code>true</code> | <code>false</code>)</span>
            &mdash; <div class='inline'>
<p>For internal driver use only. Whether or not to mark the pool as closed.</p>
</div>        </li>
    </ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>)</span>
&mdash;    <div class='inline'>
<p>Always true.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L644-L682'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='644' data-end='682'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 644</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_close'>close</span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>

  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>||=</span> {}

  <span class='id identifier rubyid_stop_populator'><a href="#stop_populator-instance_method" title="Mongo::Server::ConnectionPool#stop_populator (method)">stop_populator</a></span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='kw'>until</span> <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_pop'>pop</span>
      <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pool_closed'>pool_closed</span>)
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_force'>force</span>]
      <span class='kw'>until</span> <span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_take'>take</span>(<span class='int'>1</span>).<span class='id identifier rubyid_first'>first</span>
        <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pool_closed'>pool_closed</span>)
        <span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_connection'>connection</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>unless</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_stay_ready'>stay_ready</span>]
      <span class='comment'># mark pool as closed before releasing lock so
</span>      <span class='comment'># no connections can be created, checked in, or checked out
</span>      <span class='ivar'>@closed</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='ivar'>@ready</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>end</span>

    <span class='ivar'>@max_connecting_cv</span>.<span class='id identifier rubyid_broadcast'>broadcast</span>
    <span class='ivar'>@size_cv</span>.<span class='id identifier rubyid_broadcast'>broadcast</span>
    <span class='ivar'>@generation_manager</span>.<span class='id identifier rubyid_close_all_pipes'>close_all_pipes</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
    <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/PoolClosed.html" title="Mongo::Monitoring::Event::Cmap::PoolClosed (class)">PoolClosed</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/PoolClosed.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::PoolClosed.new (method)">new</a></span>(<span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  )

  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="close_available_connections-instance_method">
  <h3 class='signature priv'>
    #<strong>close_available_connections</strong>(service_id)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Close the available connections.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connections</span>
    <span class='type'>(<code>Array</code>&lt;<a href="Connection.html" title="Mongo::Server::Connection (class)">Connection</a>&gt;)</span>
&mdash;    <div class='inline'>
<p>A list of connections.</p>
</div>
  </li>
  <li>
    <span class='name'>service_id</span>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The service id.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1037-L1061'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1037' data-end='1061'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1037</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_close_available_connections'>close_available_connections</span>(<span class='id identifier rubyid_service_id'>service_id</span>)
  <span class='kw'>if</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_service_id'>service_id</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_conn'>conn</span> <span class='op'>=</span> <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_detect'>detect</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
        <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_service_id'>service_id</span> <span class='op'>==</span> <span class='id identifier rubyid_service_id'>service_id</span> <span class='op'>&amp;&amp;</span>
        <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_generation'>generation</span> <span class='op'>&lt;</span> <span class='ivar'>@generation_manager</span>.<span class='id identifier rubyid_generation'>generation</span>(<span class='label'>service_id:</span> <span class='id identifier rubyid_service_id'>service_id</span>)
      <span class='kw'>end</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_conn'>conn</span>
        <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_conn'>conn</span>)
        <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_stale'>stale</span><span class='comma'>,</span> <span class='label'>interrupted:</span> <span class='kw'>true</span>)
        <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
      <span class='kw'>else</span>
        <span class='kw'>break</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_delete_if'>delete_if</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_generation'>generation</span> <span class='op'>&lt;</span> <span class='ivar'>@generation_manager</span>.<span class='id identifier rubyid_generation'>generation</span>(<span class='label'>service_id:</span> <span class='id identifier rubyid_service_id'>service_id</span>)
        <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_stale'>stale</span><span class='comma'>,</span> <span class='label'>interrupted:</span> <span class='kw'>true</span>)
        <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
        <span class='kw'>true</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="close_idle_sockets-instance_method">
  <h3 class='signature '>
    #<strong>close_idle_sockets</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Close sockets that have been open for longer than the max idle time,</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>if</span> <span class='id identifier rubyid_the'>the</span> <span class='id identifier rubyid_option'>option</span> <span class='id identifier rubyid_is'>is</span> <span class='id identifier rubyid_set'>set</span>.</code></pre>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L735-L754'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='735' data-end='754'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 735</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_close_idle_sockets'>close_idle_sockets</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_max_idle_time'><a href="#max_idle_time-instance_method" title="Mongo::Server::ConnectionPool#max_idle_time (method)">max_idle_time</a></span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>&lt;</span> <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_length'>length</span>
      <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='ivar'>@available_connections</span>[<span class='id identifier rubyid_i'>i</span>]
      <span class='kw'>if</span> <span class='id identifier rubyid_last_checkin'>last_checkin</span> <span class='op'>=</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_last_checkin'>last_checkin</span>
        <span class='kw'>if</span> (<span class='const'>Time</span>.<span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='id identifier rubyid_last_checkin'>last_checkin</span>) <span class='op'>&gt;</span> <span class='id identifier rubyid_max_idle_time'><a href="#max_idle_time-instance_method" title="Mongo::Server::ConnectionPool#max_idle_time (method)">max_idle_time</a></span>
          <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_idle'>idle</span>)
          <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_delete_at'>delete_at</span>(<span class='id identifier rubyid_i'>i</span>)
          <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
          <span class='kw'>next</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_i'>i</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connect_connection-instance_method">
  <h3 class='signature priv'>
    #<strong>connect_connection</strong>(connection, context = nil)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Attempts to connect (handshake and auth) the connection. If an error is encountered, closes the connection and raises the error.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L995-L1009'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='995' data-end='1009'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 995</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connect_connection'>connect_connection</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_connect!'>connect!</span>(<span class='id identifier rubyid_context'>context</span>)
  <span class='kw'>rescue</span> <span class='const'>Exception</span>
    <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>)
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_exc'>exc</span>
  <span class='ivar'>@server</span>.<span class='id identifier rubyid_unknown!'><a href="../Server.html#unknown!-instance_method" title="Mongo::Server#unknown! (method)">unknown!</a></span>(
    <span class='label'>generation:</span> <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_generation'>generation</span><span class='comma'>,</span>
    <span class='label'>service_id:</span> <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_service_id'>service_id</span><span class='comma'>,</span>
    <span class='label'>stop_push_monitor:</span> <span class='kw'>true</span><span class='comma'>,</span>
  )
  <span class='id identifier rubyid_raise'>raise</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connect_or_raise-instance_method">
  <h3 class='signature priv'>
    #<strong>connect_or_raise</strong>(connection, context)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Connects a connection and raises an exception if the connection cannot be connected. This method also publish corresponding event and ensures that counters and condition variables are updated.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1349-L1368'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1349' data-end='1368'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1349</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connect_or_raise'>connect_or_raise</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)
  <span class='id identifier rubyid_connect_connection'><a href="#connect_connection-instance_method" title="Mongo::Server::ConnectionPool#connect_connection (method)">connect_connection</a></span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)
<span class='kw'>rescue</span> <span class='const'>Exception</span>
  <span class='comment'># Handshake or authentication failed
</span>  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_connection'>connection</span>)
      <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_connection'>connection</span>)
    <span class='kw'>end</span>
    <span class='ivar'>@max_connecting_cv</span>.<span class='id identifier rubyid_signal'>signal</span>
    <span class='ivar'>@size_cv</span>.<span class='id identifier rubyid_signal'>signal</span>
  <span class='kw'>end</span>
  <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
  <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
    <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed (class)">ConnectionCheckOutFailed</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed.new (method)">new</a></span>(
      <span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span>
      <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed (class)">ConnectionCheckOutFailed</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html#CONNECTION_ERROR-constant" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed::CONNECTION_ERROR (constant)">CONNECTION_ERROR</a></span>
    )<span class='comma'>,</span>
  )
  <span class='id identifier rubyid_raise'>raise</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connection_stale_unlocked?-instance_method">
  <h3 class='signature priv'>
    #<strong>connection_stale_unlocked?</strong>(connection)  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Checks whether a connection is stale.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>The connection to check.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the connection is stale.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L958-L961'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='958' data-end='961'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 958</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connection_stale_unlocked?'>connection_stale_unlocked?</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_generation'>generation</span> <span class='op'>!=</span> <span class='id identifier rubyid_generation_unlocked'>generation_unlocked</span>(<span class='label'>service_id:</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_service_id'>service_id</span>) <span class='op'>&amp;&amp;</span>
  <span class='op'>!</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_pinned?'>pinned?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="create_and_add_connection-instance_method">
  <h3 class='signature priv'>
    #<strong>create_and_add_connection</strong>  &#x21d2; <code>true</code> | <code>false</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Create a connection, connect it, and add it to the pool. Also check for stale and interruptable connections and deal with them.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>True if a connection was created and added to the pool, false otherwise</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error.html" title="Mongo::Error (class)">Mongo::Error</a>)</span>
&mdash;    <div class='inline'>
<p>An error encountered during connection connect</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L873-L909'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='873' data-end='909'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 873</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_create_and_add_connection'>create_and_add_connection</span>
  <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@ready</span> <span class='op'>&amp;&amp;</span>
      (<span class='id identifier rubyid_unsynchronized_size'><a href="#unsynchronized_size-instance_method" title="Mongo::Server::ConnectionPool#unsynchronized_size (method)">unsynchronized_size</a></span> <span class='op'>+</span> <span class='ivar'>@connection_requests</span>) <span class='op'>&lt;</span> <span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span> <span class='op'>&amp;&amp;</span>
      <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='ivar'>@max_connecting</span>
    <span class='kw'>then</span>
      <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='id identifier rubyid_create_connection'><a href="#create_connection-instance_method" title="Mongo::Server::ConnectionPool#create_connection (method)">create_connection</a></span>
      <span class='ivar'>@pending_connections</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_connection'>connection</span>
    <span class='kw'>else</span>
      <span class='kw'>return</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_remove_interrupted_connections'><a href="#remove_interrupted_connections-instance_method" title="Mongo::Server::ConnectionPool#remove_interrupted_connections (method)">remove_interrupted_connections</a></span>
      <span class='kw'>return</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_remove_stale_connection'><a href="#remove_stale_connection-instance_method" title="Mongo::Server::ConnectionPool#remove_stale_connection (method)">remove_stale_connection</a></span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_connect_connection'><a href="#connect_connection-instance_method" title="Mongo::Server::ConnectionPool#connect_connection (method)">connect_connection</a></span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>rescue</span> <span class='const'>Exception</span>
    <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
      <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_connection'>connection</span>)
      <span class='ivar'>@max_connecting_cv</span>.<span class='id identifier rubyid_signal'>signal</span>
      <span class='ivar'>@size_cv</span>.<span class='id identifier rubyid_signal'>signal</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@available_connections</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_connection'>connection</span>
    <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_connection'>connection</span>)
    <span class='ivar'>@max_connecting_cv</span>.<span class='id identifier rubyid_signal'>signal</span>
    <span class='ivar'>@size_cv</span>.<span class='id identifier rubyid_signal'>signal</span>
  <span class='kw'>end</span>

  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="create_connection-instance_method">
  <h3 class='signature priv'>
    #<strong>create_connection</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L853-L865'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='853' data-end='865'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 853</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_create_connection'>create_connection</span>
  <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span> <span class='op'>=</span> <span class='ivar'>@generation_manager</span>.<span class='id identifier rubyid_pipe_fds'>pipe_fds</span>(<span class='label'>service_id:</span> <span class='id identifier rubyid_server'><a href="#server-instance_method" title="Mongo::Server::ConnectionPool#server (method)">server</a></span>.<span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_service_id'>service_id</span>)
  <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>.<span class='id identifier rubyid_merge'>merge</span>(
    <span class='label'>connection_pool:</span> <span class='kw'>self</span><span class='comma'>,</span>
    <span class='label'>pipe:</span> <span class='id identifier rubyid_r'>r</span>
    <span class='comment'># Do not pass app metadata - this will be retrieved by the connection
</span>    <span class='comment'># based on the auth needs.
</span>  )
  <span class='kw'>unless</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span>
    <span class='id identifier rubyid_opts'>opts</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_generation'>generation</span>] <span class='op'>=</span> <span class='id identifier rubyid_generation'>generation</span>
  <span class='kw'>end</span>
  <span class='const'><a href="Connection.html" title="Mongo::Server::Connection (class)">Connection</a></span>.<span class='id identifier rubyid_new'><a href="Connection.html#new-class_method" title="Mongo::Server::Connection.new (method)">new</a></span>(<span class='ivar'>@server</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="decrement_connection_requests_and_signal-instance_method">
  <h3 class='signature priv'>
    #<strong>decrement_connection_requests_and_signal</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Decrement connection requests counter and signal the condition variables that the number of unavailable connections has decreased.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1373-L1377'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1373' data-end='1377'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1373</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_decrement_connection_requests_and_signal'>decrement_connection_requests_and_signal</span>
  <span class='ivar'>@connection_requests</span> <span class='op'>-=</span> <span class='int'>1</span>
  <span class='ivar'>@max_connecting_cv</span>.<span class='id identifier rubyid_signal'>signal</span>
  <span class='ivar'>@size_cv</span>.<span class='id identifier rubyid_signal'>signal</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="disconnect!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>disconnect!</strong>(options = nil)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Disconnects the pool.</p>

<p>Does everything that <a href="#clear-instance_method" title="Mongo::Server::ConnectionPool#clear (method)">#clear</a> does, except if the pool is closed this method does nothing but <a href="#clear-instance_method" title="Mongo::Server::ConnectionPool#clear (method)">#clear</a> would raise PoolClosedError.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.1.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L537-L543'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='537' data-end='543'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 537</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_disconnect!'>disconnect!</span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_do_clear'><a href="#do_clear-instance_method" title="Mongo::Server::ConnectionPool#do_clear (method)">do_clear</a></span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>)
<span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolClosedError.html" title="Mongo::Error::PoolClosedError (class)">PoolClosedError</a></span>
  <span class='comment'># The &quot;disconnected&quot; state is between closed and paused.
</span>  <span class='comment'># When we are trying to disconnect the pool, permit the pool to be
</span>  <span class='comment'># already closed.
</span><span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="do_check_in-instance_method">
  <h3 class='signature '>
    #<strong>do_check_in</strong>(connection)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Executes the check in after having already acquired the lock.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>The connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L415-L475'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='415' data-end='475'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 415</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_check_in'>do_check_in</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='comment'># When a connection is interrupted it is checked back into the pool
</span>  <span class='comment'># and closed. The operation that was using the connection before it was
</span>  <span class='comment'># interrupted will attempt to check it back into the pool, and we
</span>  <span class='comment'># should ignore it since its already been closed and removed from the pool.
</span>  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_interrupted?'>interrupted?</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_connection_pool'>connection_pool</span> <span class='op'>==</span> <span class='kw'>self</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Trying to check in a connection which was not checked out by this pool: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection'>connection</span><span class='embexpr_end'>}</span><span class='tstring_content'> checked out from pool </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_connection_pool'>connection_pool</span><span class='embexpr_end'>}</span><span class='tstring_content'> (for </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_connection'>connection</span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Trying to check in a connection which is not currently checked out by this pool: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection'>connection</span><span class='embexpr_end'>}</span><span class='tstring_content'> (for </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Note: if an event handler raises, resource will not be signaled.
</span>  <span class='comment'># This means threads waiting for a connection to free up when
</span>  <span class='comment'># the pool is at max size may time out.
</span>  <span class='comment'># Threads that begin waiting after this method completes (with
</span>  <span class='comment'># the exception) should be fine.
</span>
  <span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='ivar'>@size_cv</span>.<span class='id identifier rubyid_signal'>signal</span>

  <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
    <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckedIn.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckedIn (class)">ConnectionCheckedIn</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/ConnectionCheckedIn.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckedIn.new (method)">new</a></span>(<span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='kw'>self</span>)
  )

  <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_interrupted?'>interrupted?</span>
    <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_stale'>stale</span>)
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_error?'>error?</span>
    <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>)
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>
    <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pool_closed'>pool_closed</span>)
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>
    <span class='comment'># Connection was closed - for example, because it experienced
</span>    <span class='comment'># a network error. Nothing else needs to be done here.
</span>    <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_generation'>generation</span> <span class='op'>!=</span> <span class='id identifier rubyid_generation'>generation</span>(<span class='label'>service_id:</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_service_id'>service_id</span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_pinned?'>pinned?</span>
    <span class='comment'># If connection is marked as pinned, it is used by a transaction
</span>    <span class='comment'># or a series of cursor operations in a load balanced setup.
</span>    <span class='comment'># In this case connection should not be disconnected until
</span>    <span class='comment'># unpinned.
</span>    <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_stale'>stale</span>)
    <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_record_checkin!'>record_checkin!</span>
    <span class='ivar'>@available_connections</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_connection'>connection</span>

    <span class='ivar'>@max_connecting_cv</span>.<span class='id identifier rubyid_signal'>signal</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="do_clear-instance_method">
  <h3 class='signature '>
    #<strong>do_clear</strong>(options = nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L545-L590'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='545' data-end='590'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 545</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_clear'>do_clear</span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_check_invariants'><a href="#check_invariants-instance_method" title="Mongo::Server::ConnectionPool#check_invariants (method)">check_invariants</a></span>

  <span class='id identifier rubyid_service_id'>service_id</span> <span class='op'>=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_service_id'>service_id</span>]

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='comment'># Generation must be bumped before emitting pool cleared event.
</span>    <span class='ivar'>@generation_manager</span>.<span class='id identifier rubyid_bump'>bump</span>(<span class='label'>service_id:</span> <span class='id identifier rubyid_service_id'>service_id</span>)

    <span class='kw'>unless</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_lazy'>lazy</span>]
      <span class='id identifier rubyid_close_available_connections'><a href="#close_available_connections-instance_method" title="Mongo::Server::ConnectionPool#close_available_connections (method)">close_available_connections</a></span>(<span class='id identifier rubyid_service_id'>service_id</span>)
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_interrupt_in_use_connections'>interrupt_in_use_connections</span>]
      <span class='id identifier rubyid_schedule_for_interruption'><a href="#schedule_for_interruption-instance_method" title="Mongo::Server::ConnectionPool#schedule_for_interruption (method)">schedule_for_interruption</a></span>(<span class='ivar'>@checked_out_connections</span><span class='comma'>,</span> <span class='id identifier rubyid_service_id'>service_id</span>)
      <span class='id identifier rubyid_schedule_for_interruption'><a href="#schedule_for_interruption-instance_method" title="Mongo::Server::ConnectionPool#schedule_for_interruption (method)">schedule_for_interruption</a></span>(<span class='ivar'>@pending_connections</span><span class='comma'>,</span> <span class='id identifier rubyid_service_id'>service_id</span>)
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='ivar'>@ready</span>
      <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
        <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/PoolCleared.html" title="Mongo::Monitoring::Event::Cmap::PoolCleared (class)">PoolCleared</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/PoolCleared.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::PoolCleared.new (method)">new</a></span>(
          <span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span>
          <span class='label'>service_id:</span> <span class='id identifier rubyid_service_id'>service_id</span><span class='comma'>,</span>
          <span class='label'>interrupt_in_use_connections:</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span><span class='op'>&amp;.</span><span class='op'>[]</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_interrupt_in_use_connections'>interrupt_in_use_connections</span>)
        )
      )
      <span class='comment'># Only pause the connection pool if the server was marked unknown,
</span>      <span class='comment'># otherwise, allow the retry to be attempted with a ready pool.
</span>      <span class='id identifier rubyid_do_pause'><a href="#do_pause-instance_method" title="Mongo::Server::ConnectionPool#do_pause (method)">do_pause</a></span> <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@server</span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_unknown?'>unknown?</span>
    <span class='kw'>end</span>

    <span class='comment'># Broadcast here to cause all of the threads waiting on the max
</span>    <span class='comment'># connecting to break out of the wait loop and error.
</span>    <span class='ivar'>@max_connecting_cv</span>.<span class='id identifier rubyid_broadcast'>broadcast</span>
    <span class='comment'># Broadcast here to cause all of the threads waiting on the pool size
</span>    <span class='comment'># to break out of the wait loop and error.
</span>    <span class='ivar'>@size_cv</span>.<span class='id identifier rubyid_broadcast'>broadcast</span>
  <span class='kw'>end</span>

  <span class='comment'># &quot;Schedule the background thread&quot; after clearing. This is responsible
</span>  <span class='comment'># for cleaning up stale threads, and interrupting in use connections.
</span>  <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
  <span class='kw'>true</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_check_invariants'><a href="#check_invariants-instance_method" title="Mongo::Server::ConnectionPool#check_invariants (method)">check_invariants</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="do_pause-instance_method">
  <h3 class='signature nodoc'>
    #<strong>do_pause</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Mark the connection pool as paused without acquiring the lock.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L493-L501'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='493' data-end='501'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 493</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_pause'>do_pause</span>
  <span class='kw'>if</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@server</span>.<span class='id identifier rubyid_unknown?'>unknown?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Attempting to pause pool for server </span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span>.<span class='id identifier rubyid_summary'><a href="#summary-instance_method" title="Mongo::Server::ConnectionPool#summary (method)">summary</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> which is known</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@ready</span>

  <span class='ivar'>@ready</span> <span class='op'>=</span> <span class='kw'>false</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="get_connection-instance_method">
  <h3 class='signature priv'>
    #<strong>get_connection</strong>(pid, connection_global_id)  &#x21d2; <a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Retrieves a connection if one is available, otherwise we create a new one. If no connection exists and the pool is at max size, wait until a connection is checked back into the pool.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>pid</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The current process id.</p>
</div>
  </li>
  <li>
    <span class='name'>connection_global_id</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The global id for the connection to check out.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>The checked out connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/PoolClosedError.html" title="Mongo::Error::PoolClosedError (class)">Error::PoolClosedError</a>)</span>
&mdash;    <div class='inline'>
<p>If the pool has been closed.</p>
</div>
  </li>
  <li>
    <span class='type'>(<code>Timeout::Error</code>)</span>
&mdash;    <div class='inline'>
<p>If the connection pool is at maximum size and remains so for longer than the wait timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1210-L1258'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1210' data-end='1258'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1210</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_get_connection'>get_connection</span>(<span class='id identifier rubyid_pid'>pid</span><span class='comma'>,</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='id identifier rubyid_next_available_connection'><a href="#next_available_connection-instance_method" title="Mongo::Server::ConnectionPool#next_available_connection (method)">next_available_connection</a></span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
    <span class='kw'>unless</span> <span class='id identifier rubyid_valid_available_connection?'><a href="#valid_available_connection%3F-instance_method" title="Mongo::Server::ConnectionPool#valid_available_connection? (method)">valid_available_connection?</a></span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_pid'>pid</span><span class='comma'>,</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
      <span class='kw'>return</span> <span class='kw'>nil</span>
    <span class='kw'>end</span>

    <span class='comment'># We&#39;ve got a connection, so we decrement the number of connection
</span>    <span class='comment'># requests.
</span>    <span class='comment'># We do not need to signal condition variable here, because
</span>    <span class='comment'># because the execution will continue, and we signal later.
</span>    <span class='ivar'>@connection_requests</span> <span class='op'>-=</span> <span class='int'>1</span>

    <span class='comment'># If the connection is connected, it&#39;s not considered a
</span>    <span class='comment'># &quot;pending connection&quot;. The pending_connections list represents
</span>    <span class='comment'># the set of connections that are awaiting connection.
</span>    <span class='kw'>unless</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_connected?'><a href="../Server.html#connected%3F-instance_method" title="Mongo::Server#connected? (method)">connected?</a></span>
      <span class='ivar'>@pending_connections</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_connection'>connection</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_connection'>connection</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span>
    <span class='comment'># A particular connection is requested, but it is not available.
</span>    <span class='comment'># If it is nether available not checked out, we should stop here.
</span>    <span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_detect'>detect</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
      <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_global_id'>global_id</span> <span class='op'>==</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span>
    <span class='kw'>end</span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
          <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed (class)">ConnectionCheckOutFailed</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed.new (method)">new</a></span>(
            <span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span>
            <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed (class)">ConnectionCheckOutFailed</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html#CONNECTION_ERROR-constant" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed::CONNECTION_ERROR (constant)">CONNECTION_ERROR</a></span>
          )<span class='comma'>,</span>
        )
        <span class='comment'># We&#39;re going to raise, so we need to decrement the number of
</span>        <span class='comment'># connection requests.
</span>        <span class='id identifier rubyid_decrement_connection_requests_and_signal'><a href="#decrement_connection_requests_and_signal-instance_method" title="Mongo::Server::ConnectionPool#decrement_connection_requests_and_signal (method)">decrement_connection_requests_and_signal</a></span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/MissingConnection.html" title="Mongo::Error::MissingConnection (class)">MissingConnection</a></span>.<span class='id identifier rubyid_new'><a href="../Error.html#new-class_method" title="Mongo::Error.new (method)">new</a></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='comment'># We need a particular connection, and if it is not available
</span>    <span class='comment'># we can wait for an in-progress operation to return
</span>    <span class='comment'># such a connection to the pool.
</span>    <span class='kw'>nil</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='id identifier rubyid_create_connection'><a href="#create_connection-instance_method" title="Mongo::Server::ConnectionPool#create_connection (method)">create_connection</a></span>
    <span class='ivar'>@connection_requests</span> <span class='op'>-=</span> <span class='int'>1</span>
    <span class='ivar'>@pending_connections</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_connection'>connection</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_connection'>connection</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="inspect-instance_method">
  <h3 class='signature '>
    #<strong>inspect</strong>  &#x21d2; <code>String</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get a pretty printed string inspection for the pool.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Inspect the pool.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_pool'><a href="../Server.html#pool-instance_method" title="Mongo::Server#pool (method)">pool</a></span>.<span class='id identifier rubyid_inspect'>inspect</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>The pool inspection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L692-L703'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='692' data-end='703'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 692</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_inspect'>inspect</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;Mongo::Server::ConnectionPool:0x</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_object_id'>object_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> min_size=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> max_size=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>wait_timeout=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_wait_timeout'><a href="#wait_timeout-instance_method" title="Mongo::Server::ConnectionPool#wait_timeout (method)">wait_timeout</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> closed&gt;</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_ready?'><a href="#ready%3F-instance_method" title="Mongo::Server::ConnectionPool#ready? (method)">ready?</a></span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;Mongo::Server::ConnectionPool:0x</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_object_id'>object_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> min_size=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> max_size=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>wait_timeout=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_wait_timeout'><a href="#wait_timeout-instance_method" title="Mongo::Server::ConnectionPool#wait_timeout (method)">wait_timeout</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> paused&gt;</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;Mongo::Server::ConnectionPool:0x</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_object_id'>object_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> min_size=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> max_size=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>wait_timeout=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_wait_timeout'><a href="#wait_timeout-instance_method" title="Mongo::Server::ConnectionPool#wait_timeout (method)">wait_timeout</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> current_size=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_size'><a href="#size-instance_method" title="Mongo::Server::ConnectionPool#size (method)">size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> available=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_available_count'><a href="#available_count-instance_method" title="Mongo::Server::ConnectionPool#available_count (method)">available_count</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="max_idle_time-instance_method">
  <h3 class='signature '>
    #<strong>max_idle_time</strong>  &#x21d2; <code>Float</code> | <code>nil</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>The maximum seconds a socket can remain idle since it has been checked in to the pool, if set.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Float</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The max socket idle time in seconds.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L228-L230'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='228' data-end='230'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 228</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_max_idle_time'>max_idle_time</span>
  <span class='ivar'>@max_idle_time</span> <span class='op'>||=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_idle_time'>max_idle_time</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="max_size-instance_method">
  <h3 class='signature '>
    #<strong>max_size</strong>  &#x21d2; <code>Integer</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get the maximum size of the connection pool.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The maximum size of the connection pool.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L193-L195'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='193' data-end='195'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 193</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_max_size'>max_size</span>
  <span class='ivar'>@max_size</span> <span class='op'>||=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_size'>max_size</span>] <span class='op'>||</span> [<span class='const'><a href="#DEFAULT_MAX_SIZE-constant" title="Mongo::Server::ConnectionPool::DEFAULT_MAX_SIZE (constant)">DEFAULT_MAX_SIZE</a></span><span class='comma'>,</span> <span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span>].<span class='id identifier rubyid_max'>max</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="maybe_raise_pool_cleared!-instance_method">
  <h3 class='signature priv'>
    #<strong>maybe_raise_pool_cleared!</strong>(connection, e)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>If the connection was interrupted, raise a pool cleared error. If it wasn’t interrupted raise the original error.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>The</span>
    <span class='type'>(<a href="Connection.html" title="Mongo::Server::Connection (class)">Connection</a>)</span>
&mdash;    <div class='inline'>
<p>connection.</p>
</div>
  </li>
  <li>
    <span class='name'>The</span>
    <span class='type'>(<a href="../Error.html" title="Mongo::Error (class)">Mongo::Error</a>)</span>
&mdash;    <div class='inline'>
<p>original error.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error.html" title="Mongo::Error (class)">Mongo::Error</a> | <a href="../Error/PoolClearedError.html" title="Mongo::Error::PoolClearedError (class)">Mongo::Error::PoolClearedError</a>)</span>
&mdash;    <div class='inline'>
<p>A PoolClearedError if the connection was interrupted, the original error if not.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L982-L991'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='982' data-end='991'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 982</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_maybe_raise_pool_cleared!'>maybe_raise_pool_cleared!</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span><span class='op'>&amp;.</span><span class='id identifier rubyid_interrupted?'>interrupted?</span>
    <span class='id identifier rubyid_err'>err</span> <span class='op'>=</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolClearedError.html" title="Mongo::Error::PoolClearedError (class)">PoolClearedError</a></span>.<span class='id identifier rubyid_new'><a href="../Error/PoolClearedError.html#new-class_method" title="Mongo::Error::PoolClearedError.new (method)">new</a></span>(<span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_server'><a href="#server-instance_method" title="Mongo::Server::ConnectionPool#server (method)">server</a></span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_server'><a href="#server-instance_method" title="Mongo::Server::ConnectionPool#server (method)">server</a></span>.<span class='id identifier rubyid_pool_internal'><a href="../Server.html#pool_internal-instance_method" title="Mongo::Server#pool_internal (method)">pool_internal</a></span>).<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_err'>err</span><span class='op'>|</span>
      <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_labels'>labels</span>.<span class='id identifier rubyid_each'>each</span> { <span class='op'>|</span><span class='id identifier rubyid_l'>l</span><span class='op'>|</span> <span class='id identifier rubyid_err'>err</span>.<span class='id identifier rubyid_add_label'>add_label</span>(<span class='id identifier rubyid_l'>l</span>) }
    <span class='kw'>end</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_err'>err</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="min_size-instance_method">
  <h3 class='signature '>
    #<strong>min_size</strong>  &#x21d2; <code>Integer</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get the minimum size of the connection pool.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The minimum size of the connection pool.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L202-L204'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='202' data-end='204'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 202</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_min_size'>min_size</span>
  <span class='ivar'>@min_size</span> <span class='op'>||=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_size'>min_size</span>] <span class='op'>||</span> <span class='const'><a href="#DEFAULT_MIN_SIZE-constant" title="Mongo::Server::ConnectionPool::DEFAULT_MIN_SIZE (constant)">DEFAULT_MIN_SIZE</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="next_available_connection-instance_method">
  <h3 class='signature priv'>
    #<strong>next_available_connection</strong>(connection_global_id)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the next available connection, optionally with given global id. If no suitable connections are available, returns nil.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L837-L851'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='837' data-end='851'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 837</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_next_available_connection'>next_available_connection</span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
  <span class='id identifier rubyid_raise_unless_locked!'><a href="#raise_unless_locked!-instance_method" title="Mongo::Server::ConnectionPool#raise_unless_locked! (method)">raise_unless_locked!</a></span>

  <span class='kw'>if</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span>
    <span class='id identifier rubyid_conn'>conn</span> <span class='op'>=</span> <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_detect'>detect</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
      <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_global_id'>global_id</span> <span class='op'>==</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_conn'>conn</span>
      <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_conn'>conn</span>)
    <span class='kw'>end</span>
    <span class='id identifier rubyid_conn'>conn</span>
  <span class='kw'>else</span>
    <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_pop'>pop</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pause-instance_method">
  <h3 class='signature '>
    #<strong>pause</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Mark the connection pool as paused.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L478-L488'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='478' data-end='488'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 478</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_pause'>pause</span>
  <span class='id identifier rubyid_raise_if_closed!'><a href="#raise_if_closed!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_closed! (method)">raise_if_closed!</a></span>

  <span class='id identifier rubyid_check_invariants'><a href="#check_invariants-instance_method" title="Mongo::Server::ConnectionPool#check_invariants (method)">check_invariants</a></span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_do_pause'><a href="#do_pause-instance_method" title="Mongo::Server::ConnectionPool#do_pause (method)">do_pause</a></span>
  <span class='kw'>end</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_check_invariants'><a href="#check_invariants-instance_method" title="Mongo::Server::ConnectionPool#check_invariants (method)">check_invariants</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="populate-instance_method">
  <h3 class='signature nodoc'>
    #<strong>populate</strong>  &#x21d2; <code>true</code> | <code>false</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>This method does three things:</p>
<ol><li>
<p>Creates and adds a connection to the pool, if the pool’s size is below min_size. Retries once if a socket-related error is encountered during this process and raises if a second error or a non socket-related error occurs.</p>
</li><li>
<p>Removes stale connections from the connection pool.</p>
</li><li>
<p>Interrupts connections marked for interruption.</p>
</li></ol>

<p>Used by the pool populator background thread.</p>

<p>occured, or the non socket-related error</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether this method should be called again to create more connections.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/AuthError.html" title="Mongo::Error::AuthError (class)">Error::AuthError</a>, <a href="../Error.html" title="Mongo::Error (class)">Error</a>)</span>
&mdash;    <div class='inline'>
<p>The second socket-related error raised if a retry</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L793-L805'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='793' data-end='805'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 793</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_populate'>populate</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>

  <span class='kw'>begin</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_create_and_add_connection'><a href="#create_and_add_connection-instance_method" title="Mongo::Server::ConnectionPool#create_and_add_connection (method)">create_and_add_connection</a></span>
  <span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='comment'># an error was encountered while connecting the connection,
</span>    <span class='comment'># ignore this first error and try again.
</span>    <span class='id identifier rubyid_log_warn'>log_warn</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Populator failed to connect a connection for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'>. It will retry.</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_create_and_add_connection'><a href="#create_and_add_connection-instance_method" title="Mongo::Server::ConnectionPool#create_and_add_connection (method)">create_and_add_connection</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="raise_check_out_timeout!-instance_method">
  <h3 class='signature priv'>
    #<strong>raise_check_out_timeout!</strong>(connection_global_id)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>The lock should be acquired when calling this method.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/ConnectionCheckOutTimeout.html" title="Mongo::Error::ConnectionCheckOutTimeout (class)">Error::ConnectionCheckOutTimeout</a>)</span>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1084-L1108'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1084' data-end='1108'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1084</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_raise_check_out_timeout!'>raise_check_out_timeout!</span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
  <span class='id identifier rubyid_raise_unless_locked!'><a href="#raise_unless_locked!-instance_method" title="Mongo::Server::ConnectionPool#raise_unless_locked! (method)">raise_unless_locked!</a></span>

  <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
    <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed (class)">ConnectionCheckOutFailed</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed.new (method)">new</a></span>(
      <span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span>
      <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed (class)">ConnectionCheckOutFailed</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html#TIMEOUT-constant" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed::TIMEOUT (constant)">TIMEOUT</a></span><span class='comma'>,</span>
    )<span class='comma'>,</span>
  )

  <span class='id identifier rubyid_connection_global_id_msg'>connection_global_id_msg</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> for connection </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection_global_id'>connection_global_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Timed out attempting to check out a connection </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>from pool for </span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection_global_id_msg'>connection_global_id_msg</span><span class='embexpr_end'>}</span><span class='tstring_content'> after </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_wait_timeout'><a href="#wait_timeout-instance_method" title="Mongo::Server::ConnectionPool#wait_timeout (method)">wait_timeout</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> sec. </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connections in pool: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> available, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> checked out, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> pending, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@connection_requests</span><span class='embexpr_end'>}</span><span class='tstring_content'> connections requests </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(max size: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/ConnectionCheckOutTimeout.html" title="Mongo::Error::ConnectionCheckOutTimeout (class)">ConnectionCheckOutTimeout</a></span>.<span class='id identifier rubyid_new'><a href="../Error/ConnectionCheckOutTimeout.html#new-class_method" title="Mongo::Error::ConnectionCheckOutTimeout.new (method)">new</a></span>(<span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='label'>address:</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="raise_check_out_timeout_locked!-instance_method">
  <h3 class='signature priv'>
    #<strong>raise_check_out_timeout_locked!</strong>(connection_global_id)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1110-L1114'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1110' data-end='1114'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1110</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_raise_check_out_timeout_locked!'>raise_check_out_timeout_locked!</span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_raise_check_out_timeout!'><a href="#raise_check_out_timeout!-instance_method" title="Mongo::Server::ConnectionPool#raise_check_out_timeout! (method)">raise_check_out_timeout!</a></span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="raise_if_closed!-instance_method">
  <h3 class='signature priv'>
    #<strong>raise_if_closed!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Asserts that the pool has not been closed.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/PoolClosedError.html" title="Mongo::Error::PoolClosedError (class)">Error::PoolClosedError</a>)</span>
&mdash;    <div class='inline'>
<p>If the pool has been closed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L968-L972'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='968' data-end='972'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 968</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_raise_if_closed!'>raise_if_closed!</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolClosedError.html" title="Mongo::Error::PoolClosedError (class)">PoolClosedError</a></span>.<span class='id identifier rubyid_new'><a href="../Error/PoolClosedError.html#new-class_method" title="Mongo::Error::PoolClosedError.new (method)">new</a></span>(<span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="raise_if_not_ready!-instance_method">
  <h3 class='signature priv'>
    #<strong>raise_if_not_ready!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>The lock should be acquired when calling this method.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1151-L1155'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1151' data-end='1155'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1151</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_raise_if_not_ready!'>raise_if_not_ready!</span>
  <span class='id identifier rubyid_raise_unless_locked!'><a href="#raise_unless_locked!-instance_method" title="Mongo::Server::ConnectionPool#raise_unless_locked! (method)">raise_unless_locked!</a></span>
  <span class='id identifier rubyid_raise_if_pool_closed!'><a href="#raise_if_pool_closed!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_pool_closed! (method)">raise_if_pool_closed!</a></span>
  <span class='id identifier rubyid_raise_if_pool_paused!'><a href="#raise_if_pool_paused!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_pool_paused! (method)">raise_if_pool_paused!</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="raise_if_pool_closed!-instance_method">
  <h3 class='signature priv'>
    #<strong>raise_if_pool_closed!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1116-L1126'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1116' data-end='1126'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1116</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_raise_if_pool_closed!'>raise_if_pool_closed!</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>
    <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
      <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed (class)">ConnectionCheckOutFailed</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed.new (method)">new</a></span>(
        <span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span>
        <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed (class)">ConnectionCheckOutFailed</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html#POOL_CLOSED-constant" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed::POOL_CLOSED (constant)">POOL_CLOSED</a></span>
      )<span class='comma'>,</span>
    )
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolClosedError.html" title="Mongo::Error::PoolClosedError (class)">PoolClosedError</a></span>.<span class='id identifier rubyid_new'><a href="../Error/PoolClosedError.html#new-class_method" title="Mongo::Error::PoolClosedError.new (method)">new</a></span>(<span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="raise_if_pool_paused!-instance_method">
  <h3 class='signature priv'>
    #<strong>raise_if_pool_paused!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1128-L1142'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1128' data-end='1142'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1128</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_raise_if_pool_paused!'>raise_if_pool_paused!</span>
  <span class='id identifier rubyid_raise_unless_locked!'><a href="#raise_unless_locked!-instance_method" title="Mongo::Server::ConnectionPool#raise_unless_locked! (method)">raise_unless_locked!</a></span>

  <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@ready</span>
    <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
      <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed (class)">ConnectionCheckOutFailed</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed.new (method)">new</a></span>(
        <span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span>
        <span class='comment'># CMAP spec decided to conflate pool paused with all the other
</span>        <span class='comment'># possible non-timeout errors.
</span>        <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed (class)">ConnectionCheckOutFailed</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/ConnectionCheckOutFailed.html#CONNECTION_ERROR-constant" title="Mongo::Monitoring::Event::Cmap::ConnectionCheckOutFailed::CONNECTION_ERROR (constant)">CONNECTION_ERROR</a></span><span class='comma'>,</span>
      )<span class='comma'>,</span>
    )
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolPausedError.html" title="Mongo::Error::PoolPausedError (class)">PoolPausedError</a></span>.<span class='id identifier rubyid_new'><a href="../Error/PoolPausedError.html#new-class_method" title="Mongo::Error::PoolPausedError.new (method)">new</a></span>(<span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="raise_if_pool_paused_locked!-instance_method">
  <h3 class='signature priv'>
    #<strong>raise_if_pool_paused_locked!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1144-L1148'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1144' data-end='1148'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1144</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_raise_if_pool_paused_locked!'>raise_if_pool_paused_locked!</span>
  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_raise_if_pool_paused!'><a href="#raise_if_pool_paused!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_pool_paused! (method)">raise_if_pool_paused!</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="raise_unless_locked!-instance_method">
  <h3 class='signature priv'>
    #<strong>raise_unless_locked!</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1157-L1161'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1157' data-end='1161'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1157</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_raise_unless_locked!'>raise_unless_locked!</span>
  <span class='kw'>unless</span> <span class='ivar'>@lock</span>.<span class='id identifier rubyid_owned?'>owned?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>the lock must be owned when calling this method</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ready-instance_method">
  <h3 class='signature ro'>
    #<strong>ready</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Instructs the pool to create and return connections.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L593-L628'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='593' data-end='628'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 593</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ready'>ready</span>
  <span class='id identifier rubyid_raise_if_closed!'><a href="#raise_if_closed!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_closed! (method)">raise_if_closed!</a></span>

  <span class='comment'># TODO: Add this back in RUBY-3174.
</span>  <span class='comment'># if Lint.enabled?
</span>  <span class='comment'>#   unless @server.connected?
</span>  <span class='comment'>#     raise Error::LintError, &quot;Attempting to ready a pool for server #{@server.summary} which is disconnected&quot;
</span>  <span class='comment'>#   end
</span>  <span class='comment'># end
</span>
  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='ivar'>@ready</span>

    <span class='ivar'>@ready</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>

  <span class='comment'># Note that the CMAP spec demands serialization of CMAP events for a
</span>  <span class='comment'># pool. In order to implement this, event publication must be done into
</span>  <span class='comment'># a queue which is synchronized, instead of subscribers being invoked
</span>  <span class='comment'># from the trigger method like this one here inline. On MRI, assuming
</span>  <span class='comment'># the threads yield to others when they stop having work to do, it is
</span>  <span class='comment'># likely that the events would in practice always be published in the
</span>  <span class='comment'># required order. JRuby, being truly concurrent with OS threads,
</span>  <span class='comment'># would not offers such a guarantee.
</span>  <span class='id identifier rubyid_publish_cmap_event'>publish_cmap_event</span>(
    <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap.html" title="Mongo::Monitoring::Event::Cmap (module)">Cmap</a></span><span class='op'>::</span><span class='const'><a href="../Monitoring/Event/Cmap/PoolReady.html" title="Mongo::Monitoring::Event::Cmap::PoolReady (class)">PoolReady</a></span>.<span class='id identifier rubyid_new'><a href="../Monitoring/Event/Cmap/PoolReady.html#new-class_method" title="Mongo::Monitoring::Event::Cmap::PoolReady.new (method)">new</a></span>(<span class='ivar'>@server</span>.<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span><span class='comma'>,</span> <span class='kw'>self</span>)
  )

  <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_populator_io'>populator_io</span><span class='comma'>,</span> <span class='kw'>true</span>)
    <span class='kw'>if</span> <span class='ivar'>@populator</span>.<span class='id identifier rubyid_running?'>running?</span>
      <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
    <span class='kw'>else</span>
      <span class='ivar'>@populator</span>.<span class='id identifier rubyid_run!'>run!</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="remove_interrupted_connections-instance_method">
  <h3 class='signature priv'>
    #<strong>remove_interrupted_connections</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Interrupt connections scheduled for interruption.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L921-L951'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='921' data-end='951'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 921</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_interrupted_connections'>remove_interrupted_connections</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='ivar'>@interrupt_connections</span>.<span class='id identifier rubyid_empty?'>empty?</span>

  <span class='id identifier rubyid_gens'>gens</span> <span class='op'>=</span> <span class='const'>Set</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Server::ConnectionPool.new (method)">new</a></span>
  <span class='kw'>while</span> <span class='id identifier rubyid_conn'>conn</span> <span class='op'>=</span> <span class='ivar'>@interrupt_connections</span>.<span class='id identifier rubyid_pop'>pop</span>
    <span class='kw'>if</span> <span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_conn'>conn</span>)
      <span class='comment'># If the connection has been checked out, mark it as interrupted and it will
</span>      <span class='comment'># be disconnected on check in.
</span>      <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_interrupted!'>interrupted!</span>
      <span class='id identifier rubyid_do_check_in'><a href="#do_check_in-instance_method" title="Mongo::Server::ConnectionPool#do_check_in (method)">do_check_in</a></span>(<span class='id identifier rubyid_conn'>conn</span>)
    <span class='kw'>elsif</span> <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_conn'>conn</span>)
      <span class='comment'># If the connection is pending, disconnect with the interrupted flag.
</span>      <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_stale'>stale</span><span class='comma'>,</span> <span class='label'>interrupted:</span> <span class='kw'>true</span>)
      <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_conn'>conn</span>)
    <span class='kw'>end</span>
    <span class='id identifier rubyid_gens'>gens</span> <span class='op'>&lt;&lt;</span> [ <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_generation'>generation</span><span class='comma'>,</span> <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_service_id'>service_id</span> ]
  <span class='kw'>end</span>

  <span class='comment'># Close the write side of the pipe. Pending connections might be
</span>  <span class='comment'># hanging on the Kernel#select call, so in order to interrupt that,
</span>  <span class='comment'># we also listen for the read side of the pipe in Kernel#select and
</span>  <span class='comment'># close the write side of the pipe here, which will cause select to
</span>  <span class='comment'># wake up and raise an IOError now that the socket is closed.
</span>  <span class='comment'># The read side of the pipe will be scheduled for closing on the next
</span>  <span class='comment'># generation bump.
</span>  <span class='id identifier rubyid_gens'>gens</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_gen'>gen</span><span class='comma'>,</span> <span class='id identifier rubyid_service_id'>service_id</span><span class='op'>|</span>
    <span class='ivar'>@generation_manager</span>.<span class='id identifier rubyid_remove_pipe_fds'>remove_pipe_fds</span>(<span class='id identifier rubyid_gen'>gen</span><span class='comma'>,</span> <span class='label'>service_id:</span> <span class='id identifier rubyid_service_id'>service_id</span>)
  <span class='kw'>end</span>

  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="remove_stale_connection-instance_method">
  <h3 class='signature priv'>
    #<strong>remove_stale_connection</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Removes and disconnects all stale available connections.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L912-L918'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='912' data-end='918'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 912</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_stale_connection'>remove_stale_connection</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_conn'>conn</span> <span class='op'>=</span> <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_detect'>detect</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_method'>method</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_connection_stale_unlocked?'><a href="#connection_stale_unlocked%3F-instance_method" title="Mongo::Server::ConnectionPool#connection_stale_unlocked? (method)">connection_stale_unlocked?</a></span>))
    <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_stale'>stale</span>)
    <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_conn'>conn</span>)
    <span class='kw'>return</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="retrieve_and_connect_connection-instance_method">
  <h3 class='signature priv'>
    #<strong>retrieve_and_connect_connection</strong>(connection_global_id, context = nil)  &#x21d2; <a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Retrieves a connection and connects it.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connection_global_id</span>
    <span class='type'>(<code>Integer</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The global id for the connection to check out.</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<code>Mongo::Operation:Context</code> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>Context of the operation the connection is requested for, if any.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>The checked out connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/PoolClosedError.html" title="Mongo::Error::PoolClosedError (class)">Error::PoolClosedError</a>)</span>
&mdash;    <div class='inline'>
<p>If the pool has been closed.</p>
</div>
  </li>
  <li>
    <span class='type'>(<code>Timeout::Error</code>)</span>
&mdash;    <div class='inline'>
<p>If the connection pool is at maximum size and remains so for longer than the wait timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1272-L1302'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1272' data-end='1302'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1272</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_retrieve_and_connect_connection'>retrieve_and_connect_connection</span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span> <span class='op'>=</span>  <span class='kw'>nil</span>)
  <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>=</span> <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>+</span> <span class='id identifier rubyid_wait_timeout'><a href="#wait_timeout-instance_method" title="Mongo::Server::ConnectionPool#wait_timeout (method)">wait_timeout</a></span>(<span class='id identifier rubyid_context'>context</span>)
  <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='comment'># The first gate to checking out a connection. Make sure the number of
</span>    <span class='comment'># unavailable connections is less than the max pool size.
</span>    <span class='kw'>until</span> <span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span> <span class='op'>==</span> <span class='int'>0</span> <span class='op'>||</span> <span class='id identifier rubyid_unavailable_connections'><a href="#unavailable_connections-instance_method" title="Mongo::Server::ConnectionPool#unavailable_connections (method)">unavailable_connections</a></span> <span class='op'>&lt;</span> <span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span>
      <span class='id identifier rubyid_wait'>wait</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
      <span class='id identifier rubyid_raise_check_out_timeout!'><a href="#raise_check_out_timeout!-instance_method" title="Mongo::Server::ConnectionPool#raise_check_out_timeout! (method)">raise_check_out_timeout!</a></span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>) <span class='kw'>if</span> <span class='id identifier rubyid_wait'>wait</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
      <span class='ivar'>@size_cv</span>.<span class='id identifier rubyid_wait'>wait</span>(<span class='id identifier rubyid_wait'>wait</span>)
      <span class='id identifier rubyid_raise_if_not_ready!'><a href="#raise_if_not_ready!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_not_ready! (method)">raise_if_not_ready!</a></span>
    <span class='kw'>end</span>
    <span class='ivar'>@connection_requests</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='id identifier rubyid_wait_for_connection'><a href="#wait_for_connection-instance_method" title="Mongo::Server::ConnectionPool#wait_for_connection (method)">wait_for_connection</a></span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span><span class='comma'>,</span> <span class='id identifier rubyid_deadline'>deadline</span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_connect_or_raise'><a href="#connect_or_raise-instance_method" title="Mongo::Server::ConnectionPool#connect_or_raise (method)">connect_or_raise</a></span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>) <span class='kw'>unless</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_connected?'><a href="../Server.html#connected%3F-instance_method" title="Mongo::Server#connected? (method)">connected?</a></span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@checked_out_connections</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_connection'>connection</span>
    <span class='kw'>if</span> <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_connection'>connection</span>)
      <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_connection'>connection</span>)
    <span class='kw'>end</span>
    <span class='ivar'>@max_connecting_cv</span>.<span class='id identifier rubyid_signal'>signal</span>
    <span class='comment'># no need to signal size_cv here since the number of unavailable
</span>    <span class='comment'># connections is unchanged.
</span>  <span class='kw'>end</span>

  <span class='id identifier rubyid_connection'>connection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="schedule_for_interruption-instance_method">
  <h3 class='signature priv'>
    #<strong>schedule_for_interruption</strong>(connections, service_id)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Schedule connections of previous generations for interruption.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connections</span>
    <span class='type'>(<code>Array</code>&lt;<a href="Connection.html" title="Mongo::Server::Connection (class)">Connection</a>&gt;)</span>
&mdash;    <div class='inline'>
<p>A list of connections.</p>
</div>
  </li>
  <li>
    <span class='name'>service_id</span>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The service id.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1067-L1072'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1067' data-end='1072'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1067</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_schedule_for_interruption'>schedule_for_interruption</span>(<span class='id identifier rubyid_connections'>connections</span><span class='comma'>,</span> <span class='id identifier rubyid_service_id'>service_id</span>)
  <span class='ivar'>@interrupt_connections</span> <span class='op'>+=</span> <span class='id identifier rubyid_connections'>connections</span>.<span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
    (<span class='op'>!</span><span class='id identifier rubyid_server'><a href="#server-instance_method" title="Mongo::Server::ConnectionPool#server (method)">server</a></span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span> <span class='op'>||</span> <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_service_id'>service_id</span> <span class='op'>==</span> <span class='id identifier rubyid_service_id'>service_id</span>) <span class='op'>&amp;&amp;</span>
    <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_generation'>generation</span> <span class='op'>&lt;</span> <span class='ivar'>@generation_manager</span>.<span class='id identifier rubyid_generation'>generation</span>(<span class='label'>service_id:</span> <span class='id identifier rubyid_service_id'>service_id</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="size-instance_method">
  <h3 class='signature '>
    #<strong>size</strong>  &#x21d2; <code>Integer</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Size of the connection pool.</p>

<p>Includes available and checked out connections.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>Size of the connection pool.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L261-L267'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='261' data-end='267'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 261</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_size'>size</span>
  <span class='id identifier rubyid_raise_if_closed!'><a href="#raise_if_closed!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_closed! (method)">raise_if_closed!</a></span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_unsynchronized_size'><a href="#unsynchronized_size-instance_method" title="Mongo::Server::ConnectionPool#unsynchronized_size (method)">unsynchronized_size</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="stop_populator-instance_method">
  <h3 class='signature nodoc'>
    #<strong>stop_populator</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Stop the background populator thread and clean up any connections created which have not been connected yet.</p>

<p>Used when closing the pool or when terminating the bg thread for testing purposes. In the latter case, this method must be called before the pool is used, to ensure no connections in pending_connections were created in-flow by the check_out method.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L765-L775'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='765' data-end='775'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 765</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_stop_populator'>stop_populator</span>
  <span class='ivar'>@populator</span>.<span class='id identifier rubyid_stop!'>stop!</span>

  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='comment'># If stop_populator is called while populate is running, there may be
</span>    <span class='comment'># connections waiting to be connected, connections which have not yet
</span>    <span class='comment'># been moved to available_connections, or connections moved to available_connections
</span>    <span class='comment'># but not deleted from pending_connections. These should be cleaned up.
</span>    <span class='id identifier rubyid_clear_pending_connections'><a href="#clear_pending_connections-instance_method" title="Mongo::Server::ConnectionPool#clear_pending_connections (method)">clear_pending_connections</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="summary-instance_method">
  <h3 class='signature '>
    #<strong>summary</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>This method is experimental and subject to change.</p>
</div>
  </div>


  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.11.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L321-L333'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='321' data-end='333'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 321</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_summary'>summary</span>
  <span class='ivar'>@lock</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Server::ConnectionPool#closed? (method)">closed?</a></span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>closed</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>elsif</span> <span class='op'>!</span><span class='ivar'>@ready</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>paused</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>else</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ready</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>end</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;ConnectionPool size=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_unsynchronized_size'><a href="#unsynchronized_size-instance_method" title="Mongo::Server::ConnectionPool#unsynchronized_size (method)">unsynchronized_size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_min_size'><a href="#min_size-instance_method" title="Mongo::Server::ConnectionPool#min_size (method)">min_size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_size'><a href="#max_size-instance_method" title="Mongo::Server::ConnectionPool#max_size (method)">max_size</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>) </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>used=</span><span class='embexpr_beg'>#{</span><span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> avail=</span><span class='embexpr_beg'>#{</span><span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> pending=</span><span class='embexpr_beg'>#{</span><span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_state'>state</span><span class='embexpr_end'>}</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="unavailable_connections-instance_method">
  <h3 class='signature nodoc'>
    #<strong>unavailable_connections</strong>  &#x21d2; <code>Integer</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The number of unavailable connections in the pool. Used to calculate whether we have hit max_pool_size.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L282-L284'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='282' data-end='284'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 282</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_unavailable_connections'>unavailable_connections</span>
  <span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='ivar'>@connection_requests</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="unsynchronized_size-instance_method">
  <h3 class='signature priv'>
    #<strong>unsynchronized_size</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the size of the connection pool without acquiring the lock. This method should only be used by other pool methods when they are already holding the lock as Ruby does not allow a thread holding a lock to acquire this lock again.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L273-L275'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='273' data-end='275'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 273</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_unsynchronized_size'>unsynchronized_size</span>
  <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='ivar'>@checked_out_connections</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_length'>length</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="valid_available_connection?-instance_method">
  <h3 class='signature priv'>
    #<strong>valid_available_connection?</strong>(connection, pid, connection_global_id)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1163-L1195'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1163' data-end='1195'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1163</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_valid_available_connection?'>valid_available_connection?</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_pid'>pid</span><span class='comma'>,</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_pid'>pid</span> <span class='op'>!=</span> <span class='id identifier rubyid_pid'>pid</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Detected PID change - Mongo client should have been reconnected (old pid </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_pid'>pid</span><span class='embexpr_end'>}</span><span class='tstring_content'>, new pid </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pid'>pid</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_stale'>stale</span>)
    <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_pinned?'>pinned?</span>
    <span class='comment'># If connection is marked as pinned, it is used by a transaction
</span>    <span class='comment'># or a series of cursor operations in a load balanced setup.
</span>    <span class='comment'># In this case connection should not be disconnected until
</span>    <span class='comment'># unpinned.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_generation'>generation</span> <span class='op'>!=</span> <span class='id identifier rubyid_generation'>generation</span>(
      <span class='label'>service_id:</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_service_id'>service_id</span>
    )
      <span class='comment'># Stale connections should be disconnected in the clear
</span>      <span class='comment'># method, but if any don&#39;t, check again here
</span>      <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_stale'>stale</span>)
      <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_max_idle_time'><a href="#max_idle_time-instance_method" title="Mongo::Server::ConnectionPool#max_idle_time (method)">max_idle_time</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_last_checkin'>last_checkin</span> <span class='op'>&amp;&amp;</span>
      <span class='const'>Time</span>.<span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_last_checkin'>last_checkin</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_max_idle_time'><a href="#max_idle_time-instance_method" title="Mongo::Server::ConnectionPool#max_idle_time (method)">max_idle_time</a></span>
    <span class='kw'>then</span>
      <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_disconnect!'><a href="#disconnect!-instance_method" title="Mongo::Server::ConnectionPool#disconnect! (method)">disconnect!</a></span>(<span class='label'>reason:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_idle'>idle</span>)
      <span class='ivar'>@populate_semaphore</span>.<span class='id identifier rubyid_signal'>signal</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="wait_for_connection-instance_method">
  <h3 class='signature priv'>
    #<strong>wait_for_connection</strong>(connection_global_id, deadline)  &#x21d2; <a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Waits for a connection to become available, or raises is no connection becomes available before the timeout.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connection_global_id</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The global id for the connection to check out.</p>
</div>
  </li>
  <li>
    <span class='name'>deadline</span>
    <span class='type'>(<code>Float</code>)</span>
&mdash;    <div class='inline'>
<p>The time at which to stop waiting.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Connection.html" title="Mongo::Server::Connection (class)">Mongo::Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>The checked out connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0, largely rewritten in 2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L1311-L1343'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1311' data-end='1343'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 1311</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_for_connection'>wait_for_connection</span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span><span class='comma'>,</span> <span class='id identifier rubyid_deadline'>deadline</span>)
  <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='comment'># The second gate to checking out a connection. Make sure 1) there
</span>    <span class='comment'># exists an available connection and 2) we are under max_connecting.
</span>    <span class='kw'>until</span> <span class='ivar'>@available_connections</span>.<span class='id identifier rubyid_any?'>any?</span> <span class='op'>||</span> <span class='ivar'>@pending_connections</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='ivar'>@max_connecting</span>
      <span class='id identifier rubyid_wait'>wait</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_wait'>wait</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
        <span class='comment'># We are going to raise a timeout error, so the connection
</span>        <span class='comment'># request is not going to be fulfilled. Decrement the counter
</span>        <span class='comment'># here.
</span>        <span class='id identifier rubyid_decrement_connection_requests_and_signal'><a href="#decrement_connection_requests_and_signal-instance_method" title="Mongo::Server::ConnectionPool#decrement_connection_requests_and_signal (method)">decrement_connection_requests_and_signal</a></span>
        <span class='id identifier rubyid_raise_check_out_timeout!'><a href="#raise_check_out_timeout!-instance_method" title="Mongo::Server::ConnectionPool#raise_check_out_timeout! (method)">raise_check_out_timeout!</a></span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
      <span class='kw'>end</span>
      <span class='ivar'>@max_connecting_cv</span>.<span class='id identifier rubyid_wait'>wait</span>(<span class='id identifier rubyid_wait'>wait</span>)
      <span class='comment'># We do not need to decrement the connection_requests counter
</span>      <span class='comment'># or signal here because the pool is not ready yet.
</span>      <span class='id identifier rubyid_raise_if_not_ready!'><a href="#raise_if_not_ready!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_not_ready! (method)">raise_if_not_ready!</a></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='id identifier rubyid_get_connection'><a href="#get_connection-instance_method" title="Mongo::Server::ConnectionPool#get_connection (method)">get_connection</a></span>(<span class='const'>Process</span>.<span class='id identifier rubyid_pid'>pid</span><span class='comma'>,</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
    <span class='id identifier rubyid_wait'>wait</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_wait'>wait</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
      <span class='comment'># connection is nil here, it means that get_connection method
</span>      <span class='comment'># did not create a new connection; therefore, it did not decrease
</span>      <span class='comment'># the connection_requests counter. We need to do it here.
</span>      <span class='id identifier rubyid_decrement_connection_requests_and_signal'><a href="#decrement_connection_requests_and_signal-instance_method" title="Mongo::Server::ConnectionPool#decrement_connection_requests_and_signal (method)">decrement_connection_requests_and_signal</a></span>
      <span class='id identifier rubyid_raise_check_out_timeout!'><a href="#raise_check_out_timeout!-instance_method" title="Mongo::Server::ConnectionPool#raise_check_out_timeout! (method)">raise_check_out_timeout!</a></span>(<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_connection'>connection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="wait_timeout-instance_method">
  <h3 class='signature '>
    #<strong>wait_timeout</strong>(context = nil)  &#x21d2; <code>Float</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>The time to wait, in seconds, for a connection to become available.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<code>Mongo::Operation:Context</code> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>Context of the operation the connection is requested for, if any.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Float</code>)</span>
&mdash;    <div class='inline'>
<p>The queue wait timeout.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.9.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L214-L220'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='214' data-end='220'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 214</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_timeout'>wait_timeout</span>(<span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_context'>context</span><span class='op'>&amp;.</span><span class='id identifier rubyid_remaining_timeout_sec'>remaining_timeout_sec</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionPool#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_wait_timeout'>wait_timeout</span>] <span class='op'>||</span> <span class='const'><a href="#DEFAULT_WAIT_TIMEOUT-constant" title="Mongo::Server::ConnectionPool::DEFAULT_WAIT_TIMEOUT (constant)">DEFAULT_WAIT_TIMEOUT</a></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_context'>context</span><span class='op'>&amp;.</span><span class='id identifier rubyid_remaining_timeout_sec'>remaining_timeout_sec</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="with_connection-instance_method">
  <h3 class='signature '>
    #<strong>with_connection</strong>(connection_global_id: nil, context: nil)  &#x21d2; <code>Object</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Yield the block to a connection, while handling check in/check out logic.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Execute with a connection.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_pool'><a href="../Server.html#pool-instance_method" title="Mongo::Server#pool (method)">pool</a></span>.<span class='id identifier rubyid_with_connection'>with_connection</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
  <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_read'>read</span>
<span class='kw'>end</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the block.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_pool.rb#L715-L729'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='715' data-end='729'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_pool.rb', line 715</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_with_connection'>with_connection</span>(<span class='label'>connection_global_id:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_raise_if_closed!'><a href="#raise_if_closed!-instance_method" title="Mongo::Server::ConnectionPool#raise_if_closed! (method)">raise_if_closed!</a></span>

  <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='id identifier rubyid_check_out'><a href="#check_out-instance_method" title="Mongo::Server::ConnectionPool#check_out (method)">check_out</a></span>(
    <span class='label'>connection_global_id:</span> <span class='id identifier rubyid_connection_global_id'>connection_global_id</span><span class='comma'>,</span>
    <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>
  )
  <span class='kw'>yield</span>(<span class='id identifier rubyid_connection'>connection</span>)
<span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/ConnectionPerished.html" title="Mongo::Error::ConnectionPerished (class)">ConnectionPerished</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_maybe_raise_pool_cleared!'><a href="#maybe_raise_pool_cleared!-instance_method" title="Mongo::Server::ConnectionPool#maybe_raise_pool_cleared! (method)">maybe_raise_pool_cleared!</a></span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span>)
<span class='kw'>ensure</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span>
    <span class='id identifier rubyid_check_in'><a href="#check_in-instance_method" title="Mongo::Server::ConnectionPool#check_in (method)">check_in</a></span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>