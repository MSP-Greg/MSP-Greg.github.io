<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Server::ConnectionCommon &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Server::ConnectionCommon",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongo master</a> &raquo; 
      <a href='../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../Server.html" title="Mongo::Server (class)">Server</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ConnectionCommon&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Server::ConnectionCommon</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Subclasses:</div>
        <div class='box_22'>
          <a href="Connection.html" title="Mongo::Server::Connection (class)">Connection</a>, <a href="ConnectionBase.html" title="Mongo::Server::ConnectionBase (class)">ConnectionBase</a>, <span class='nodoc_h'>Mongo::Server::PendingConnection</span>, <span class='nodoc_h'>Mongo::Server::Monitor::Connection</span>, <span class='nodoc_h'>Mongo::Server::PushMonitor::Connection</span>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L28'>lib/mongo/server/connection_common.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Although methods of this module are part of the public API, the fact that these methods are defined on this module and not on the classes which include this module is not part of the public API.</p>
</div>
  </div>


<p>Common methods used by both monitoring and non-monitoring connections.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='HELLO_DOC-constant' class='summary_signature'>HELLO_DOC =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L112-L112'># File 'lib/mongo/server/connection_common.rb', line 112</a>    <pre class='code ruby'><span class='const'>BSON</span><span class='op'>::</span><span class='const'>Document</span>.<span class='id identifier rubyid_new'><a href="../Server.html#new-class_method" title="Mongo::Server.new (method)">new</a></span>({ <span class='label'>hello:</span> <span class='int'>1</span> }).<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
  <li>
    <span id='LEGACY_HELLO_DOC-constant' class='summary_signature'>LEGACY_HELLO_DOC =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L114-L114'># File 'lib/mongo/server/connection_common.rb', line 114</a>    <pre class='code ruby'><span class='const'>BSON</span><span class='op'>::</span><span class='const'>Document</span>.<span class='id identifier rubyid_new'><a href="../Server.html#new-class_method" title="Mongo::Server.new (method)">new</a></span>({ <span class='label'>isMaster:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>helloOk:</span> <span class='kw'>true</span> }).<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#compressor-instance_method" title="#compressor (instance method)">#<strong>compressor</strong>  &#x21d2; String | nil </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>The compressor negotiated during the handshake for this connection, if any.</p></div>
    </div>
  </li>
  <li class='deprecated'>
    <span class='summary_signature ro deprecated'>
      <a href="#connected%3F-instance_method" title="#connected? (instance method)">#<strong>connected?</strong>  &#x21d2; true, false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='deprecated note title'>deprecated</span>
    <span class='summary_desc'><strong>Deprecated.</strong>
      <div class='inline'></div>    </span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#pid-instance_method" title="#pid (instance method)">#<strong>pid</strong>  &#x21d2; Integer </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#socket-instance_method" title="#socket (instance method)">#<strong>socket</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#handshake_command-instance_method" title="#handshake_command (instance method)">#<strong>handshake_command</strong>(handshake_document)  &#x21d2; Protocol::Message </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Build a command that should be used for connection handshake.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#handshake_document-instance_method" title="#handshake_document (instance method)">#<strong>handshake_document</strong>(app_metadata, speculative_auth_doc: nil, load_balancer: false, server_api: nil)  &#x21d2; BSON::Document </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Build a document that should be used for connection handshake.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#add_server_diagnostics-instance_method" title="#add_server_diagnostics (instance method)">#<strong>add_server_diagnostics</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Yields to the block and, if the block raises an exception, adds a note to the exception with the address of the specified server.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#ensure_connected-instance_method" title="#ensure_connected (instance method)">#<strong>ensure_connected</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#set_compressor!-instance_method" title="#set_compressor! (instance method)">#<strong>set_compressor!</strong>(reply)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#ssl_options-instance_method" title="#ssl_options (instance method)">#<strong>ssl_options</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="compressor-instance_method">
  <h3 class='signature ro first'>
    #<strong>compressor</strong>  &#x21d2; <code>String</code> | <code>nil</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>The compressor negotiated during the handshake for this connection, if any.</p>

<p>This attribute is nil for connections that haven’t completed the handshake yet, and for connections that negotiated no compression.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The compressor.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L37-L37'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='37' data-end='37'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_common.rb', line 37</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_compressor'>compressor</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="connected?-instance_method">
  <h3 class='signature ro  deprecated'>
    #<strong>connected?</strong>  &#x21d2; <code>true</code>, <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <div class="note deprecated"><strong>Deprecated.</strong> <div class='inline'></div></div>

<p>Determine if the connection is currently connected.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Is the connection connected?</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_connected?'>connected?</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>, <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>If connected.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L47-L49'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='47' data-end='49'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_common.rb', line 47</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_connected?'>connected?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='id identifier rubyid_socket'><a href="#socket-instance_method" title="Mongo::Server::ConnectionCommon#socket (method)">socket</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pid-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>pid</strong>  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>pid The process id when the connection was created.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L53-L53'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='53' data-end='53'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_common.rb', line 53</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pid'>pid</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="socket-instance_method">
  <h3 class='signature ro priv'>
    #<strong>socket</strong>   <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L116-L116'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='116' data-end='116'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_common.rb', line 116</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_socket'>socket</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="add_server_diagnostics-instance_method">
  <h3 class='signature priv first'>
    #<strong>add_server_diagnostics</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Yields to the block and, if the block raises an exception, adds a note to the exception with the address of the specified server.</p>

<p>This method is intended to add server address information to exceptions raised during execution of operations on servers.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L145-L174'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='145' data-end='174'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_common.rb', line 145</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add_server_diagnostics'>add_server_diagnostics</span>
  <span class='kw'>yield</span>
<span class='comment'># Note that the exception should already have been mapped to a
</span><span class='comment'># Mongo::Error subclass when it gets to this method.
</span><span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='comment'># Server::Monitor::Connection does not reference its server, but
</span>  <span class='comment'># knows its address. Server::Connection delegates the address to its
</span>  <span class='comment'># server.
</span>  <span class='id identifier rubyid_note'>note</span> <span class='op'>=</span> <span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>on </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span>.<span class='id identifier rubyid_seed'>seed</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>if</span> <span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>)
    <span class='id identifier rubyid_note'>note</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, connection </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_generation'>generation</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='comment'># Non-monitoring connections have service id.
</span>  <span class='comment'># Monitoring connections do not.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_service_id'>service_id</span>) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_service_id'>service_id</span>
    <span class='id identifier rubyid_note'>note</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, service id </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_service_id'>service_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='id identifier rubyid_note'>note</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_generation'>generation</span>)
    <span class='comment'># Non-monitoring connections
</span>    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_generation'>generation</span> <span class='op'>=</span> <span class='id identifier rubyid_generation'>generation</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_global_id'>global_id</span>)
      <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_connection_global_id'>connection_global_id</span> <span class='op'>=</span> <span class='id identifier rubyid_global_id'>global_id</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>)
      <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_service_id'>service_id</span> <span class='op'>=</span> <span class='id identifier rubyid_service_id'>service_id</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ensure_connected-instance_method">
  <h3 class='signature priv'>
    #<strong>ensure_connected</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L189-L205'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='189' data-end='205'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_common.rb', line 189</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ensure_connected'>ensure_connected</span>
  <span class='kw'>begin</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_socket'><a href="#socket-instance_method" title="Mongo::Server::ConnectionCommon#socket (method)">socket</a></span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connection </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_generation'>generation</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'> for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span>.<span class='id identifier rubyid_seed'>seed</span><span class='embexpr_end'>}</span><span class='tstring_content'> is not connected</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='ivar'>@error</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/ConnectionPerished.html" title="Mongo::Error::ConnectionPerished (class)">ConnectionPerished</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connection </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_generation'>generation</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'> for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span>.<span class='id identifier rubyid_seed'>seed</span><span class='embexpr_end'>}</span><span class='tstring_content'> is perished</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='kw'>yield</span> <span class='id identifier rubyid_socket'><a href="#socket-instance_method" title="Mongo::Server::ConnectionCommon#socket (method)">socket</a></span>
    <span class='id identifier rubyid_success'>success</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='id identifier rubyid_result'>result</span>
  <span class='kw'>ensure</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_success'>success</span>
      <span class='ivar'>@error</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handshake_command-instance_method">
  <h3 class='signature nodoc'>
    #<strong>handshake_command</strong>(handshake_document)  &#x21d2; <a href="../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Protocol::Message</a> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Build a command that should be used for connection handshake.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>handshake_document</span>
    <span class='type'>(<code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>Document that should be sent to a server for handshake purpose.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>Command that should be sent to a server for handshake purposes.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L94-L107'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='94' data-end='107'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_common.rb', line 94</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handshake_command'>handshake_command</span>(<span class='id identifier rubyid_handshake_document'><a href="#handshake_document-instance_method" title="Mongo::Server::ConnectionCommon#handshake_document (method)">handshake_document</a></span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_handshake_document'><a href="#handshake_document-instance_method" title="Mongo::Server::ConnectionCommon#handshake_document (method)">handshake_document</a></span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apiVersion</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>||</span> <span class='id identifier rubyid_handshake_document'><a href="#handshake_document-instance_method" title="Mongo::Server::ConnectionCommon#handshake_document (method)">handshake_document</a></span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>loadBalanced</span><span class='tstring_end'>&#39;</span></span>]
    <span class='const'><a href="../Protocol.html" title="Mongo::Protocol (module)">Protocol</a></span><span class='op'>::</span><span class='const'><a href="../Protocol/Msg.html" title="Mongo::Protocol::Msg (class)">Msg</a></span>.<span class='id identifier rubyid_new'><a href="../Protocol/Msg.html#new-class_method" title="Mongo::Protocol::Msg.new (method)">new</a></span>(
      []<span class='comma'>,</span> {}<span class='comma'>,</span> <span class='id identifier rubyid_handshake_document'><a href="#handshake_document-instance_method" title="Mongo::Server::ConnectionCommon#handshake_document (method)">handshake_document</a></span>.<span class='id identifier rubyid_merge'>merge</span>({<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$db</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='const'><a href="../Database.html" title="Mongo::Database (class)">Database</a></span><span class='op'>::</span><span class='const'><a href="../Database.html#ADMIN-constant" title="Mongo::Database::ADMIN (constant)">ADMIN</a></span>})
    )
  <span class='kw'>else</span>
    <span class='const'><a href="../Protocol.html" title="Mongo::Protocol (module)">Protocol</a></span><span class='op'>::</span><span class='const'><a href="../Protocol/Query.html" title="Mongo::Protocol::Query (class)">Query</a></span>.<span class='id identifier rubyid_new'><a href="../Protocol/Query.html#new-class_method" title="Mongo::Protocol::Query.new (method)">new</a></span>(
      <span class='const'><a href="../Database.html" title="Mongo::Database (class)">Database</a></span><span class='op'>::</span><span class='const'><a href="../Database.html#ADMIN-constant" title="Mongo::Database::ADMIN (constant)">ADMIN</a></span><span class='comma'>,</span>
      <span class='const'><a href="../Database.html" title="Mongo::Database (class)">Database</a></span><span class='op'>::</span><span class='const'><a href="../Database.html#COMMAND-constant" title="Mongo::Database::COMMAND (constant)">COMMAND</a></span><span class='comma'>,</span>
      <span class='id identifier rubyid_handshake_document'><a href="#handshake_document-instance_method" title="Mongo::Server::ConnectionCommon#handshake_document (method)">handshake_document</a></span><span class='comma'>,</span>
      <span class='symbeg'>:</span><span class='id identifier rubyid_limit'>limit</span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>1</span>
    )
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handshake_document-instance_method">
  <h3 class='signature nodoc'>
    #<strong>handshake_document</strong>(app_metadata, speculative_auth_doc: nil, load_balancer: false, server_api: nil)  &#x21d2; <code>BSON::Document</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Build a document that should be used for connection handshake.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>app_metadata</span>
    <span class='type'>(<a href="AppMetadata.html" title="Mongo::Server::AppMetadata (class)">Server::AppMetadata</a>)</span>
&mdash;    <div class='inline'>
<p>Application metadata</p>
</div>
  </li>
  <li>
    <span class='name'>speculative_auth_doc</span>
    <span class='type'>(<code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>The speculative authentication document, if any.</p>
</div>
  </li>
  <li>
    <span class='name'>load_balancer</span>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether the connection is to a load balancer.</p>
</div>
  </li>
  <li>
    <span class='name'>server_api</span>
    <span class='type'>(<code>Hash</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>server_api <a href="../Server.html" title="Mongo::Server (class)"><code>::Mongo::Server</code></a> API version.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>Document that should be sent to a server for handshake purposes.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L68-L83'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='68' data-end='83'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_common.rb', line 68</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handshake_document'>handshake_document</span>(<span class='id identifier rubyid_app_metadata'>app_metadata</span><span class='comma'>,</span> <span class='label'>speculative_auth_doc:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>load_balancer:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>server_api:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_serv_api'>serv_api</span> <span class='op'>=</span> <span class='id identifier rubyid_app_metadata'>app_metadata</span>.<span class='id identifier rubyid_server_api'>server_api</span> <span class='op'>||</span> <span class='id identifier rubyid_server_api'>server_api</span>
  <span class='id identifier rubyid_document'>document</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_serv_api'>serv_api</span>
               <span class='const'><a href="#HELLO_DOC-constant" title="Mongo::Server::ConnectionCommon::HELLO_DOC (constant)">HELLO_DOC</a></span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_transform_server_api'>transform_server_api</span>(<span class='id identifier rubyid_serv_api'>serv_api</span>))
             <span class='kw'>else</span>
               <span class='const'><a href="#LEGACY_HELLO_DOC-constant" title="Mongo::Server::ConnectionCommon::LEGACY_HELLO_DOC (constant)">LEGACY_HELLO_DOC</a></span>
             <span class='kw'>end</span>
  <span class='id identifier rubyid_document'>document</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_app_metadata'>app_metadata</span>.<span class='id identifier rubyid_validated_document'>validated_document</span>).<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_doc'>doc</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_speculative_auth_doc'>speculative_auth_doc</span>
      <span class='id identifier rubyid_doc'>doc</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>speculativeAuthenticate:</span> <span class='id identifier rubyid_speculative_auth_doc'>speculative_auth_doc</span>)
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_load_balancer'>load_balancer</span>
      <span class='id identifier rubyid_doc'>doc</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>loadBalanced:</span> <span class='kw'>true</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="set_compressor!-instance_method">
  <h3 class='signature priv'>
    #<strong>set_compressor!</strong>(reply)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L118-L138'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='118' data-end='138'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_common.rb', line 118</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_set_compressor!'>set_compressor!</span>(<span class='id identifier rubyid_reply'>reply</span>)
  <span class='id identifier rubyid_server_compressors'>server_compressors</span> <span class='op'>=</span> <span class='id identifier rubyid_reply'>reply</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>compression</span><span class='tstring_end'>&#39;</span></span>]

  <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_compressors'>compressors</span>]
    <span class='kw'>if</span> <span class='id identifier rubyid_intersection'>intersection</span> <span class='op'>=</span> (<span class='id identifier rubyid_server_compressors'>server_compressors</span> <span class='op'>&amp;</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_compressors'>compressors</span>])
      <span class='ivar'>@compressor</span> <span class='op'>=</span> <span class='id identifier rubyid_intersection'>intersection</span>.<span class='id identifier rubyid_first'>first</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_server_compressors'>server_compressors</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The server at </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> has no compression algorithms in common with those requested. </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Server algorithms: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server_compressors'>server_compressors</span>.<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span>)<span class='embexpr_end'>}</span><span class='tstring_content'>; </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Requested algorithms: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_compressors'>compressors</span>].<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span>)<span class='embexpr_end'>}</span><span class='tstring_content'>. </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Compression will not be used</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The server at </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> did not advertise compression support. </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Requested algorithms: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_compressors'>compressors</span>].<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span>)<span class='embexpr_end'>}</span><span class='tstring_content'>. </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Compression will not be used</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_log_warn'>log_warn</span>(<span class='id identifier rubyid_msg'>msg</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ssl_options-instance_method">
  <h3 class='signature priv'>
    #<strong>ssl_options</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_common.rb#L176-L187'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='176' data-end='187'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_common.rb', line 176</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ssl_options'>ssl_options</span>
  <span class='ivar'>@ssl_options</span> <span class='op'>||=</span> <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_ssl'>ssl</span>]
    <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>.<span class='id identifier rubyid_select'>select</span> { <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span>.<span class='id identifier rubyid_to_s'>to_s</span>.<span class='id identifier rubyid_start_with?'>start_with?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ssl</span><span class='tstring_end'>&#39;</span></span>) }
  <span class='kw'>else</span>
    <span class='comment'># Due to the way options are propagated from the client, if we
</span>    <span class='comment'># decide that we don&#39;t want to use TLS we need to have the :ssl
</span>    <span class='comment'># option explicitly set to false or the value provided to the
</span>    <span class='comment'># connection might be overwritten by the default inherited from
</span>    <span class='comment'># the client.
</span>    {<span class='label'>ssl:</span> <span class='kw'>false</span>}
  <span class='kw'>end</span>.<span class='id identifier rubyid_freeze'>freeze</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>