<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Server::ConnectionBase &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Server::ConnectionBase",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongo master</a> &raquo; 
      <a href='../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../Server.html" title="Mongo::Server (class)">Server</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ConnectionBase&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Server::ConnectionBase</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Subclasses:</div>
        <div class='box_22'>
          <a href="Connection.html" title="Mongo::Server::Connection (class)">Connection</a>, <span class='nodoc_h'>Mongo::Server::PendingConnection</span>
        </div>
      </td>
    </tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          Forwardable,
          <a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)"><code>ConnectionCommon</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="../Monitoring/Publishable.html" title="Mongo::Monitoring::Publishable (module)"><code>::Mongo::Monitoring::Publishable</code></a>,
          <a href="../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a>,
          <a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)"><code>ConnectionCommon</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2 o'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)">Mongo::Server::ConnectionCommon</a></span>
        <ul class='fullTree'>
          <li>Object</li>
          <li class='next'><a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)">Mongo::Server::ConnectionCommon</a></li>
          <li class='next'>Mongo::Server::ConnectionBase</li>
        </ul>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L28'>lib/mongo/server/connection_base.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Although methods of this module are part of the public API, the fact that these methods are defined on this module and not on the classes which include this module is not part of the public API.</p>
</div>
  </div>


<p>This class encapsulates common connection functionality.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='DEFAULT_MAX_BSON_OBJECT_SIZE-constant' class='summary_signature nodoc'>DEFAULT_MAX_BSON_OBJECT_SIZE =</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The maximum allowed size in bytes that a user-supplied document may take up when serialized, if the server’s hello response does not include maxBsonObjectSize field.</p>

<p>The commands that are sent to the server may exceed this size by <a href="#MAX_BSON_COMMAND_OVERHEAD-constant" title="Mongo::Server::ConnectionBase::MAX_BSON_COMMAND_OVERHEAD (constant)">MAX_BSON_COMMAND_OVERHEAD</a>.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L40-L40'># File 'lib/mongo/server/connection_base.rb', line 40</a>    <pre class='code ruby'><span class='int'>16777216</span></pre>
  </li>
  <li>
    <span id='MAX_BSON_COMMAND_OVERHEAD-constant' class='summary_signature nodoc'>MAX_BSON_COMMAND_OVERHEAD =</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>The additional overhead allowed for command data (i.e. fields added to the command document by the driver, as opposed to documents provided by the user) when serializing a complete command to BSON.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L47-L47'># File 'lib/mongo/server/connection_base.rb', line 47</a>    <pre class='code ruby'><span class='int'>16384</span></pre>
  </li>
  <li>
    <span id='REDUCED_MAX_BSON_SIZE-constant' class='summary_signature nodoc'>REDUCED_MAX_BSON_SIZE =</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L50-L50'># File 'lib/mongo/server/connection_base.rb', line 50</a>    <pre class='code ruby'><span class='int'>2097152</span></pre>
  </li>
</ul>
  <h3 class='inherited'><a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)"><code>ConnectionCommon</code></a> - Inherited</h3>
  <p  class='inherited'>
    <a href="ConnectionCommon.html#HELLO_DOC-constant" title="Mongo::Server::ConnectionCommon::HELLO_DOC (constant)">HELLO_DOC</a>, 
    <a href="ConnectionCommon.html#LEGACY_HELLO_DOC-constant" title="Mongo::Server::ConnectionCommon::LEGACY_HELLO_DOC (constant)">LEGACY_HELLO_DOC</a>
  </p>
  <h3 class='inherited'><a href="../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="../Loggable.html#PREFIX-constant" title="Mongo::Loggable::PREFIX (constant)">PREFIX</a>
  </p>
</div>

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#description-instance_method" title="#description (instance method)">#<strong>description</strong>  &#x21d2; Server::Description </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the server description for this connection, derived from the hello response for the handshake performed on this connection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#options-instance_method" title="#options (instance method)">#<strong>options</strong>  &#x21d2; Hash </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#server-instance_method" title="#server (instance method)">#<strong>server</strong>  &#x21d2; Mongo::Address </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>

<h3 class='inherited'><a href="../Monitoring/Publishable.html" title="Mongo::Monitoring::Publishable (module)"><code>::Mongo::Monitoring::Publishable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="../Monitoring/Publishable.html#monitoring-instance_method" title="Mongo::Monitoring::Publishable#monitoring (method)">#monitoring</a>,
        <a class='i_m ro priv' href="../Monitoring/Publishable.html#monitoring%3F-instance_method" title="Mongo::Monitoring::Publishable#monitoring? (method)">#monitoring?</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)"><code>ConnectionCommon</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ro' href="ConnectionCommon.html#compressor-instance_method" title="Mongo::Server::ConnectionCommon#compressor (method)">#compressor</a></td>
      <td><div class='inline'><p>The compressor negotiated during the handshake for this connection, if any.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ro deprecated' href="ConnectionCommon.html#connected%3F-instance_method" title="Mongo::Server::ConnectionCommon#connected? (method)">#connected?</a></td>
      <td><div class='inline'><p>Determine if the connection is currently connected.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ro nodoc' href="ConnectionCommon.html#pid-instance_method" title="Mongo::Server::ConnectionCommon#pid (method)">#pid</a>,
        <a class='i_m ro priv' href="ConnectionCommon.html#socket-instance_method" title="Mongo::Server::ConnectionCommon#socket (method)">#socket</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#app_metadata-instance_method" title="#app_metadata (instance method)">#<strong>app_metadata</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#dispatch-instance_method" title="#dispatch (instance method)">#<strong>dispatch</strong>(messages, context, options = {})  &#x21d2; Protocol::Message | nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Dispatch a single message to the connection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#generation-instance_method" title="#generation (instance method)">#<strong>generation</strong>  &#x21d2; Integer | nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p><a href="Connection.html" title="Mongo::Server::Connection (class)"><code>Connection</code></a> pool generation from which this connection was created.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#service_id-instance_method" title="#service_id (instance method)">#<strong>service_id</strong>  &#x21d2; nil | Object </a>
    </span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#deliver-instance_method" title="#deliver (instance method)">#<strong>deliver</strong>(message, context, options = {})  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#serialize-instance_method" title="#serialize (instance method)">#<strong>serialize</strong>(message, context, buffer = BSON::ByteBuffer.new)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>

<h3 class='inherited'><a href="../Monitoring/Publishable.html" title="Mongo::Monitoring::Publishable (module)"><code>::Mongo::Monitoring::Publishable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="../Monitoring/Publishable.html#publish_cmap_event-instance_method" title="Mongo::Monitoring::Publishable#publish_cmap_event (method)">#publish_cmap_event</a>,
        <a class='i_m deprecated' href="../Monitoring/Publishable.html#publish_event-instance_method" title="Mongo::Monitoring::Publishable#publish_event (method)">#publish_event</a>,
        <a class='i_m ' href="../Monitoring/Publishable.html#publish_sdam_event-instance_method" title="Mongo::Monitoring::Publishable#publish_sdam_event (method)">#publish_sdam_event</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_completed-instance_method" title="Mongo::Monitoring::Publishable#command_completed (method)">#command_completed</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_failed-instance_method" title="Mongo::Monitoring::Publishable#command_failed (method)">#command_failed</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_started-instance_method" title="Mongo::Monitoring::Publishable#command_started (method)">#command_started</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_succeeded-instance_method" title="Mongo::Monitoring::Publishable#command_succeeded (method)">#command_succeeded</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#duration-instance_method" title="Mongo::Monitoring::Publishable#duration (method)">#duration</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_debug-instance_method" title="Mongo::Loggable#log_debug (method)">#log_debug</a></td>
      <td><div class='inline'><p>Convenience method to log debug messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_error-instance_method" title="Mongo::Loggable#log_error (method)">#log_error</a></td>
      <td><div class='inline'><p>Convenience method to log error messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_fatal-instance_method" title="Mongo::Loggable#log_fatal (method)">#log_fatal</a></td>
      <td><div class='inline'><p>Convenience method to log fatal messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_info-instance_method" title="Mongo::Loggable#log_info (method)">#log_info</a></td>
      <td><div class='inline'><p>Convenience method to log info messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_warn-instance_method" title="Mongo::Loggable#log_warn (method)">#log_warn</a></td>
      <td><div class='inline'><p>Convenience method to log warn messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#logger-instance_method" title="Mongo::Loggable#logger (method)">#logger</a></td>
      <td><div class='inline'><p>Get the logger instance.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="../Loggable.html#_mongo_log_prefix-instance_method" title="Mongo::Loggable#_mongo_log_prefix (method)">#_mongo_log_prefix</a>,
        <a class='i_m priv' href="../Loggable.html#format_message-instance_method" title="Mongo::Loggable#format_message (method)">#format_message</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)"><code>ConnectionCommon</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="ConnectionCommon.html#handshake_command-instance_method" title="Mongo::Server::ConnectionCommon#handshake_command (method)">#handshake_command</a></td>
      <td><div class='inline'><p>Build a command that should be used for connection handshake.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="ConnectionCommon.html#handshake_document-instance_method" title="Mongo::Server::ConnectionCommon#handshake_document (method)">#handshake_document</a></td>
      <td><div class='inline'><p>Build a document that should be used for connection handshake.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="ConnectionCommon.html#add_server_diagnostics-instance_method" title="Mongo::Server::ConnectionCommon#add_server_diagnostics (method)">#add_server_diagnostics</a></td>
      <td><div class='inline'><p>Yields to the block and, if the block raises an exception, adds a note to the exception with the address of the specified server.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="ConnectionCommon.html#ensure_connected-instance_method" title="Mongo::Server::ConnectionCommon#ensure_connected (method)">#ensure_connected</a>,
        <a class='i_m priv' href="ConnectionCommon.html#set_compressor!-instance_method" title="Mongo::Server::ConnectionCommon#set_compressor! (method)">#set_compressor!</a>,
        <a class='i_m priv' href="ConnectionCommon.html#ssl_options-instance_method" title="Mongo::Server::ConnectionCommon#ssl_options (method)">#ssl_options</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="description-instance_method">
  <h3 class='signature ro  nodoc first'>
    #<strong>description</strong>  &#x21d2; <a href="Description.html" title="Mongo::Server::Description (class)">Server::Description</a>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>A connection object that hasn’t yet connected (handshaken and authenticated, if authentication is required) does not have a description. While handshaking and authenticating the driver must be using global defaults, in particular not assuming that the properties of a particular connection are the same as properties of other connections made to the same address (since the server on the other end could have been shut down and a different server version could have been launched).</p>
</div>
  </div>


<p>Returns the server description for this connection, derived from the hello response for the handshake performed on this connection.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Description.html" title="Mongo::Server::Description (class)">Server::Description</a>)</span>
&mdash;    <div class='inline'>
<p><a href="../Server.html" title="Mongo::Server (class)"><code>::Mongo::Server</code></a> description for this connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L82-L82'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='82' data-end='82'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_base.rb', line 82</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_description'>description</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="options-instance_method">
  <h3 class='signature ro'>
    #<strong>options</strong>  &#x21d2; <code>Hash</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>options The passed in options.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L53-L53'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='53' data-end='53'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_base.rb', line 53</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_options'>options</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="server-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>server</strong>  &#x21d2; <a href="../Address.html" title="Mongo::Address (class)">Mongo::Address</a>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Address.html" title="Mongo::Address (class)">Mongo::Address</a>)</span>
&mdash;    <div class='inline'>
<p>address The address to connect to.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L58-L58'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='58' data-end='58'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_base.rb', line 58</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_server'>server</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="app_metadata-instance_method">
  <h3 class='signature  first'>
    #<strong>app_metadata</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L107-L122'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='107' data-end='122'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_base.rb', line 107</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_app_metadata'>app_metadata</span>
  <span class='ivar'>@app_metadata</span> <span class='op'>||=</span> <span class='kw'>begin</span>
    <span class='id identifier rubyid_same'>same</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='const'><a href="AppMetadata.html" title="Mongo::Server::AppMetadata (class)">AppMetadata</a></span><span class='op'>::</span><span class='const'><a href="AppMetadata.html#AUTH_OPTION_KEYS-constant" title="Mongo::Server::AppMetadata::AUTH_OPTION_KEYS (constant)">AUTH_OPTION_KEYS</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionBase#options (method)">options</a></span>[<span class='id identifier rubyid_key'>key</span>] <span class='op'>!=</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionBase#options (method)">options</a></span>[<span class='id identifier rubyid_key'>key</span>]
        <span class='id identifier rubyid_same'>same</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='kw'>break</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_same'>same</span>
      <span class='ivar'>@server</span>.<span class='id identifier rubyid_app_metadata'>app_metadata</span>
    <span class='kw'>else</span>
      <span class='const'><a href="AppMetadata.html" title="Mongo::Server::AppMetadata (class)">AppMetadata</a></span>.<span class='id identifier rubyid_new'><a href="AppMetadata.html#new-class_method" title="Mongo::Server::AppMetadata.new (method)">new</a></span>(<span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionBase#options (method)">options</a></span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='label'>purpose:</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_app_metadata'>app_metadata</span>.<span class='id identifier rubyid_purpose'>purpose</span>))
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="deliver-instance_method">
  <h3 class='signature priv'>
    #<strong>deliver</strong>(message, context, options = {})   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/SocketError.html" title="Mongo::Error::SocketError (class)">Error::SocketError</a> | <a href="../Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">Error::SocketTimeoutError</a>)</span>
&mdash;    <div class='inline'>
<p>When there is a network error.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L167-L214'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='167' data-end='214'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_base.rb', line 167</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_deliver'>deliver</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionBase#options (method)">options</a></span> <span class='op'>=</span> {})
  <span class='kw'>if</span> <span class='const'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span>.<span class='id identifier rubyid_enabled?'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@socket</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Trying to deliver a message over a disconnected connection (to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='id identifier rubyid_serialize'><a href="#serialize-instance_method" title="Mongo::Server::ConnectionBase#serialize (method)">serialize</a></span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)
  <span class='id identifier rubyid_ensure_connected'>ensure_connected</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_socket'>socket</span><span class='op'>|</span>
    <span class='id identifier rubyid_operation_id'>operation_id</span> <span class='op'>=</span> <span class='const'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span>.<span class='id identifier rubyid_next_operation_id'><a href="../Monitoring.html#next_operation_id-class_method" title="Mongo::Monitoring.next_operation_id (method)">next_operation_id</a></span>
    <span class='id identifier rubyid_started_event'>started_event</span> <span class='op'>=</span> <span class='id identifier rubyid_command_started'>command_started</span>(<span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_payload'>payload</span><span class='comma'>,</span>
      <span class='label'>socket_object_id:</span> <span class='id identifier rubyid_socket'>socket</span>.<span class='id identifier rubyid_object_id'>object_id</span><span class='comma'>,</span> <span class='label'>connection_id:</span> <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span>
      <span class='label'>connection_generation:</span> <span class='id identifier rubyid_generation'><a href="#generation-instance_method" title="Mongo::Server::ConnectionBase#generation (method)">generation</a></span><span class='comma'>,</span>
      <span class='label'>server_connection_id:</span> <span class='id identifier rubyid_description'><a href="#description-instance_method" title="Mongo::Server::ConnectionBase#description (method)">description</a></span>.<span class='id identifier rubyid_server_connection_id'>server_connection_id</span><span class='comma'>,</span>
      <span class='label'>service_id:</span> <span class='id identifier rubyid_description'><a href="#description-instance_method" title="Mongo::Server::ConnectionBase#description (method)">description</a></span>.<span class='id identifier rubyid_service_id'><a href="#service_id-instance_method" title="Mongo::Server::ConnectionBase#service_id (method)">service_id</a></span><span class='comma'>,</span>
    )
    <span class='id identifier rubyid_start'>start</span> <span class='op'>=</span> <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_add_server_diagnostics'>add_server_diagnostics</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_socket'>socket</span>.<span class='id identifier rubyid_write'>write</span>(<span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_to_s'>to_s</span>)
        <span class='kw'>if</span> <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_replyable?'>replyable?</span>
          <span class='const'><a href="../Protocol.html" title="Mongo::Protocol (module)">Protocol</a></span><span class='op'>::</span><span class='const'><a href="../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Message</a></span>.<span class='id identifier rubyid_deserialize'><a href="../Protocol/Message.html#deserialize-class_method" title="Mongo::Protocol::Message.deserialize (method)">deserialize</a></span>(<span class='id identifier rubyid_socket'>socket</span><span class='comma'>,</span> <span class='id identifier rubyid_max_message_size'>max_message_size</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_request_id'>request_id</span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionBase#options (method)">options</a></span>)
        <span class='kw'>else</span>
          <span class='kw'>nil</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='id identifier rubyid_total_duration'>total_duration</span> <span class='op'>=</span> <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>-</span> <span class='id identifier rubyid_start'>start</span>
      <span class='id identifier rubyid_command_failed'>command_failed</span>(<span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_payload'>payload</span><span class='comma'>,</span>
        <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_total_duration'>total_duration</span><span class='comma'>,</span>
        <span class='label'>started_event:</span> <span class='id identifier rubyid_started_event'>started_event</span><span class='comma'>,</span>
        <span class='label'>server_connection_id:</span> <span class='id identifier rubyid_description'><a href="#description-instance_method" title="Mongo::Server::ConnectionBase#description (method)">description</a></span>.<span class='id identifier rubyid_server_connection_id'>server_connection_id</span><span class='comma'>,</span>
        <span class='label'>service_id:</span> <span class='id identifier rubyid_description'><a href="#description-instance_method" title="Mongo::Server::ConnectionBase#description (method)">description</a></span>.<span class='id identifier rubyid_service_id'><a href="#service_id-instance_method" title="Mongo::Server::ConnectionBase#service_id (method)">service_id</a></span><span class='comma'>,</span>
      )
      <span class='id identifier rubyid_raise'>raise</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_total_duration'>total_duration</span> <span class='op'>=</span> <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_monotonic_time'>monotonic_time</span> <span class='op'>-</span> <span class='id identifier rubyid_start'>start</span>
      <span class='id identifier rubyid_command_completed'>command_completed</span>(<span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='id identifier rubyid_operation_id'>operation_id</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_payload'>payload</span><span class='comma'>,</span>
        <span class='id identifier rubyid_total_duration'>total_duration</span><span class='comma'>,</span>
        <span class='label'>started_event:</span> <span class='id identifier rubyid_started_event'>started_event</span><span class='comma'>,</span>
        <span class='label'>server_connection_id:</span> <span class='id identifier rubyid_description'><a href="#description-instance_method" title="Mongo::Server::ConnectionBase#description (method)">description</a></span>.<span class='id identifier rubyid_server_connection_id'>server_connection_id</span><span class='comma'>,</span>
        <span class='label'>service_id:</span> <span class='id identifier rubyid_description'><a href="#description-instance_method" title="Mongo::Server::ConnectionBase#description (method)">description</a></span>.<span class='id identifier rubyid_service_id'><a href="#service_id-instance_method" title="Mongo::Server::ConnectionBase#service_id (method)">service_id</a></span><span class='comma'>,</span>
      )
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_result'>result</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_decrypt?'>decrypt?</span>
      <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_maybe_decrypt'>maybe_decrypt</span>(<span class='id identifier rubyid_context'>context</span>)
    <span class='kw'>end</span>
    <span class='id identifier rubyid_result'>result</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="dispatch-instance_method">
  <h3 class='signature '>
    #<strong>dispatch</strong>(messages, context, options = {})  &#x21d2; <a href="../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Protocol::Message</a> | <code>nil</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>This method is named dispatch since ‘send’ is a core Ruby method on all objects.</p>
</div>
  </div>

  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>For backwards compatibility, this method accepts the messages as an array. However, exactly one message must be given per invocation.</p>
</div>
  </div>


<p>Dispatch a single message to the connection. If the message requires a response, a reply will be returned.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Dispatch the message.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_dispatch'>dispatch</span>([ <span class='id identifier rubyid_insert'>insert</span> ])</code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>messages</span>
    <span class='type'>(<code>Array</code>&lt;<code>Message</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>A one-element array containing the message to dispatch.</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<a href="../Operation/Context.html" title="Mongo::Operation::Context (class)">Operation::Context</a>)</span>
&mdash;    <div class='inline'>
<p>The operation context.</p>
</div>
  </li>
  <li>
    <span class='name'>options</span>
    <span class='type'>(<code>Hash</code>)</span>
    <em class='default'>(defaults to: <tt>{}</tt>)</em>
  </li>
</ul>
    <p class='tag_title'>Options Hash (<tt>options</tt>):</p>
    <ul class='option'>
        <li>
          <span class='name'>:deserialize_as_bson</span>
          <span class='type'>(<code>Boolean</code>)</span>
            &mdash; <div class='inline'>
<p>Whether to deserialize the response to this message using BSON objects in place of native Ruby types wherever possible.</p>
</div>        </li>
    </ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Protocol::Message</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The reply if needed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="../Error/SocketError.html" title="Mongo::Error::SocketError (class)">Error::SocketError</a> | <a href="../Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">Error::SocketTimeoutError</a>)</span>
&mdash;    <div class='inline'>
<p>When there is a network error.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L150-L162'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='150' data-end='162'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_base.rb', line 150</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_dispatch'>dispatch</span>(<span class='id identifier rubyid_messages'>messages</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionBase#options (method)">options</a></span> <span class='op'>=</span> {})
  <span class='comment'># The monitoring code does not correctly handle multiple messages,
</span>  <span class='comment'># and the driver internally does not send more than one message at
</span>  <span class='comment'># a time ever. Thus prohibit multiple message use for now.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_messages'>messages</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>!=</span> <span class='int'>1</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Can only dispatch one message at a time</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_description'><a href="#description-instance_method" title="Mongo::Server::ConnectionBase#description (method)">description</a></span>.<span class='id identifier rubyid_unknown?'>unknown?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InternalDriverError.html" title="Mongo::Error::InternalDriverError (class)">InternalDriverError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cannot dispatch a message on a connection with unknown description: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_description'><a href="#description-instance_method" title="Mongo::Server::ConnectionBase#description (method)">description</a></span>.<span class='id identifier rubyid_inspect'><a href="../Server.html#inspect-instance_method" title="Mongo::Server#inspect (method)">inspect</a></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='id identifier rubyid_messages'>messages</span>.<span class='id identifier rubyid_first'>first</span>
  <span class='id identifier rubyid_deliver'><a href="#deliver-instance_method" title="Mongo::Server::ConnectionBase#deliver (method)">deliver</a></span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionBase#options (method)">options</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="generation-instance_method">
  <h3 class='signature '>
    #<strong>generation</strong>  &#x21d2; <code>Integer</code> | <code>nil</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p><a href="Connection.html" title="Mongo::Server::Connection (class)"><code>Connection</code></a> pool generation from which this connection was created. May be nil.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p><a href="Connection.html" title="Mongo::Server::Connection (class)"><code>Connection</code></a> pool generation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L100-L105'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='100' data-end='105'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_base.rb', line 100</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_generation'>generation</span>
  <span class='comment'># If the connection is to a load balancer, @generation is set
</span>  <span class='comment'># after handshake completes. If the connection is to another server
</span>  <span class='comment'># type, generation is specified during connection creation.
</span>  <span class='ivar'>@generation</span> <span class='op'>||</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionBase#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_generation'>generation</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="serialize-instance_method">
  <h3 class='signature priv'>
    #<strong>serialize</strong>(message, context, buffer = BSON::ByteBuffer.new)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L216-L275'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='216' data-end='275'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_base.rb', line 216</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_serialize'>serialize</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>ByteBuffer</span>.<span class='id identifier rubyid_new'><a href="../Server.html#new-class_method" title="Mongo::Server.new (method)">new</a></span>)
  <span class='comment'># Driver specifications only mandate the fixed 16MiB limit for
</span>  <span class='comment'># serialized BSON documents. However, the server returns its
</span>  <span class='comment'># active serialized BSON document size limit in the hello response,
</span>  <span class='comment'># which is +max_bson_object_size+ below. The +DEFAULT_MAX_BSON_OBJECT_SIZE+
</span>  <span class='comment'># is the 16MiB value mandated by the specifications which we use
</span>  <span class='comment'># only as the default if the server&#39;s hello did not contain
</span>  <span class='comment'># maxBsonObjectSize.
</span>  <span class='id identifier rubyid_max_bson_size'>max_bson_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max_bson_object_size'>max_bson_object_size</span> <span class='op'>||</span> <span class='const'><a href="#DEFAULT_MAX_BSON_OBJECT_SIZE-constant" title="Mongo::Server::ConnectionBase::DEFAULT_MAX_BSON_OBJECT_SIZE (constant)">DEFAULT_MAX_BSON_OBJECT_SIZE</a></span>
  <span class='kw'>if</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_encrypt?'>encrypt?</span>
    <span class='comment'># The client-side encryption specification requires bulk writes to
</span>    <span class='comment'># be split at a reduced maxBsonObjectSize. If this message is a bulk
</span>    <span class='comment'># write and its size exceeds the reduced size limit, the serializer
</span>    <span class='comment'># will raise an exception, which is caught by BulkWrite. BulkWrite
</span>    <span class='comment'># will split the operation into individual writes, which will
</span>    <span class='comment'># not be subject to the reduced maxBsonObjectSize.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_bulk_write?'>bulk_write?</span>
      <span class='comment'># Make the new maximum size equal to the specified reduced size
</span>      <span class='comment'># limit plus the 16KiB overhead allowance.
</span>      <span class='id identifier rubyid_max_bson_size'>max_bson_size</span> <span class='op'>=</span> <span class='const'><a href="#REDUCED_MAX_BSON_SIZE-constant" title="Mongo::Server::ConnectionBase::REDUCED_MAX_BSON_SIZE (constant)">REDUCED_MAX_BSON_SIZE</a></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># RUBY-2234: It is necessary to check that the message size does not
</span>  <span class='comment'># exceed the maximum bson object size before compressing and serializing
</span>  <span class='comment'># the final message.
</span>  <span class='comment'>#
</span>  <span class='comment'># This is to avoid the case where the user performs a bulk write
</span>  <span class='comment'># larger than 16MiB which, when compressed, becomes smaller than 16MiB.
</span>  <span class='comment'># If the driver does not split the bulk writes prior to compression,
</span>  <span class='comment'># the entire operation will be sent to the server, which will raise an
</span>  <span class='comment'># error because the uncompressed operation exceeds the maximum bson size.
</span>  <span class='comment'>#
</span>  <span class='comment'># To address this problem, we serialize the message prior to compression
</span>  <span class='comment'># and raise an exception if the serialized message exceeds the maximum
</span>  <span class='comment'># bson size.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_max_message_size'>max_message_size</span>
    <span class='comment'># Create a separate buffer that contains the un-compressed message
</span>    <span class='comment'># for the purpose of checking its size. Write any pre-existing contents
</span>    <span class='comment'># from the original buffer into the temporary one.
</span>    <span class='id identifier rubyid_temp_buffer'>temp_buffer</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>ByteBuffer</span>.<span class='id identifier rubyid_new'><a href="../Server.html#new-class_method" title="Mongo::Server.new (method)">new</a></span>

    <span class='comment'># TODO: address the fact that this line mutates the buffer.
</span>    <span class='id identifier rubyid_temp_buffer'>temp_buffer</span>.<span class='id identifier rubyid_put_bytes'>put_bytes</span>(<span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_get_bytes'>get_bytes</span>(<span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_length'>length</span>))

    <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_serialize'>serialize</span>(<span class='id identifier rubyid_temp_buffer'>temp_buffer</span><span class='comma'>,</span> <span class='id identifier rubyid_max_bson_size'>max_bson_size</span><span class='comma'>,</span> <span class='const'><a href="#MAX_BSON_COMMAND_OVERHEAD-constant" title="Mongo::Server::ConnectionBase::MAX_BSON_COMMAND_OVERHEAD (constant)">MAX_BSON_COMMAND_OVERHEAD</a></span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_temp_buffer'>temp_buffer</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_max_message_size'>max_message_size</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/MaxMessageSize.html" title="Mongo::Error::MaxMessageSize (class)">MaxMessageSize</a></span>.<span class='id identifier rubyid_new'><a href="../Error/MaxMessageSize.html#new-class_method" title="Mongo::Error::MaxMessageSize.new (method)">new</a></span>(<span class='id identifier rubyid_max_message_size'>max_message_size</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># RUBY-2335: When the un-compressed message is smaller than the maximum
</span>  <span class='comment'># bson size limit, the message will be serialized twice. The operations
</span>  <span class='comment'># layer should be refactored to allow compression on an already-
</span>  <span class='comment'># serialized message.
</span>  <span class='id identifier rubyid_final_message'>final_message</span> <span class='op'>=</span> <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_maybe_compress'>maybe_compress</span>(<span class='id identifier rubyid_compressor'><a href="../Server.html#compressor-instance_method" title="Mongo::Server#compressor (method)">compressor</a></span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Server::ConnectionBase#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_zlib_compression_level'>zlib_compression_level</span>])
  <span class='id identifier rubyid_final_message'>final_message</span>.<span class='id identifier rubyid_serialize'>serialize</span>(<span class='id identifier rubyid_buffer'>buffer</span><span class='comma'>,</span> <span class='id identifier rubyid_max_bson_size'>max_bson_size</span><span class='comma'>,</span> <span class='const'><a href="#MAX_BSON_COMMAND_OVERHEAD-constant" title="Mongo::Server::ConnectionBase::MAX_BSON_COMMAND_OVERHEAD (constant)">MAX_BSON_COMMAND_OVERHEAD</a></span>)

  <span class='id identifier rubyid_buffer'>buffer</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="service_id-instance_method">
  <h3 class='signature '>
    #<strong>service_id</strong>  &#x21d2; <code>nil</code> | <code>Object</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>nil</code> | <code>Object</code>)</span>
&mdash;    <div class='inline'>
<p>The service id, if any.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/connection_base.rb#L92-L94'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='92' data-end='94'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/connection_base.rb', line 92</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_service_id'>service_id</span>
  <span class='id identifier rubyid_description'><a href="#description-instance_method" title="Mongo::Server::ConnectionBase#description (method)">description</a></span><span class='op'>&amp;.</span><span class='id identifier rubyid_service_id'>service_id</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>