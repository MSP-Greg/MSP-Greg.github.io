<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Server::PendingConnection &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Server::PendingConnection",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongo master</a> &raquo; 
      <a href='../../_index.html#alpha_P'>Index (P)</a> &raquo; 
        <a href="../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../Server.html" title="Mongo::Server (class)">Server</a> &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>PendingConnection&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Server::PendingConnection  <span class='private note title'>Private</span>
</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This class is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          Forwardable,
          <a href="ConnectionBase.html" title="Mongo::Server::ConnectionBase (class)"><code>ConnectionBase</code></a>,
          Forwardable,
          <a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)"><code>ConnectionCommon</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="ConnectionBase.html" title="Mongo::Server::ConnectionBase (class)"><code>ConnectionBase</code></a>,
          <a href="../Monitoring/Publishable.html" title="Mongo::Monitoring::Publishable (module)"><code>::Mongo::Monitoring::Publishable</code></a>,
          <a href="../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a>,
          <a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)"><code>ConnectionCommon</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2 o'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="ConnectionBase.html" title="Mongo::Server::ConnectionBase (class)">Mongo::Server::ConnectionBase</a></span>
        <ul class='fullTree'>
          <li>Object</li>
          <li class='next'><a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)">Mongo::Server::ConnectionCommon</a></li>
          <li class='next'><a href="ConnectionBase.html" title="Mongo::Server::ConnectionBase (class)">Mongo::Server::ConnectionBase</a></li>
          <li class='next'>Mongo::Server::PendingConnection</li>
        </ul>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/pending_connection.rb#L24'>lib/mongo/server/pending_connection.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>This class encapsulates connections during handshake and authentication.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
  <h3 class='inherited'><a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)"><code>ConnectionCommon</code></a> - Inherited</h3>
  <p  class='inherited'>
    <a href="ConnectionCommon.html#HELLO_DOC-constant" title="Mongo::Server::ConnectionCommon::HELLO_DOC (constant)">HELLO_DOC</a>, 
    <a href="ConnectionCommon.html#LEGACY_HELLO_DOC-constant" title="Mongo::Server::ConnectionCommon::LEGACY_HELLO_DOC (constant)">LEGACY_HELLO_DOC</a>
  </p>
  <h3 class='inherited'><a href="../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="../Loggable.html#PREFIX-constant" title="Mongo::Loggable::PREFIX (constant)">PREFIX</a>
  </p>
  <h3 class='inherited'><a href="ConnectionBase.html" title="Mongo::Server::ConnectionBase (class)"><code>ConnectionBase</code></a> - Inherited</h3>
  <p  class='inherited'>
    <a class='nodoc' href="ConnectionBase.html#DEFAULT_MAX_BSON_OBJECT_SIZE-constant" title="Mongo::Server::ConnectionBase::DEFAULT_MAX_BSON_OBJECT_SIZE (constant)">DEFAULT_MAX_BSON_OBJECT_SIZE</a>, 
    <a class='nodoc' href="ConnectionBase.html#MAX_BSON_COMMAND_OVERHEAD-constant" title="Mongo::Server::ConnectionBase::MAX_BSON_COMMAND_OVERHEAD (constant)">MAX_BSON_COMMAND_OVERHEAD</a>, 
    <a class='nodoc' href="ConnectionBase.html#REDUCED_MAX_BSON_SIZE-constant" title="Mongo::Server::ConnectionBase::REDUCED_MAX_BSON_SIZE (constant)">REDUCED_MAX_BSON_SIZE</a>
  </p>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(socket, server, monitoring, options = {})  &#x21d2; PendingConnection </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#id-instance_method" title="#id (instance method)">#<strong>id</strong>  &#x21d2; Integer </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>

<h3 class='inherited'><a href="ConnectionBase.html" title="Mongo::Server::ConnectionBase (class)"><code>ConnectionBase</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ro nodoc' href="ConnectionBase.html#description-instance_method" title="Mongo::Server::ConnectionBase#description (method)">#description</a></td>
      <td><div class='inline'><p>Returns the server description for this connection, derived from the hello response for the handshake performed on this connection.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="ConnectionBase.html#options-instance_method" title="Mongo::Server::ConnectionBase#options (method)">#options</a>,
        <a class='i_m ro nodoc' href="ConnectionBase.html#server-instance_method" title="Mongo::Server::ConnectionBase#server (method)">#server</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../Monitoring/Publishable.html" title="Mongo::Monitoring::Publishable (module)"><code>::Mongo::Monitoring::Publishable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="../Monitoring/Publishable.html#monitoring-instance_method" title="Mongo::Monitoring::Publishable#monitoring (method)">#monitoring</a>,
        <a class='i_m ro priv' href="../Monitoring/Publishable.html#monitoring%3F-instance_method" title="Mongo::Monitoring::Publishable#monitoring? (method)">#monitoring?</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)"><code>ConnectionCommon</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ro' href="ConnectionCommon.html#compressor-instance_method" title="Mongo::Server::ConnectionCommon#compressor (method)">#compressor</a></td>
      <td><div class='inline'><p>The compressor negotiated during the handshake for this connection, if any.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ro deprecated' href="ConnectionCommon.html#connected%3F-instance_method" title="Mongo::Server::ConnectionCommon#connected? (method)">#connected?</a></td>
      <td><div class='inline'><p>Determine if the connection is currently connected.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ro nodoc' href="ConnectionCommon.html#pid-instance_method" title="Mongo::Server::ConnectionCommon#pid (method)">#pid</a>,
        <a class='i_m ro priv' href="ConnectionCommon.html#socket-instance_method" title="Mongo::Server::ConnectionCommon#socket (method)">#socket</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#handshake_and_authenticate!-instance_method" title="#handshake_and_authenticate! (instance method)">#<strong>handshake_and_authenticate!</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#authenticate!-instance_method" title="#authenticate! (instance method)">#<strong>authenticate!</strong>(speculative_auth_client_nonce: nil, speculative_auth_mech: nil, speculative_auth_result: nil)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#default_mechanism-instance_method" title="#default_mechanism (instance method)">#<strong>default_mechanism</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#ensure_connected-instance_method" title="#ensure_connected (instance method)">#<strong>ensure_connected</strong> {|@socket| ... } </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#get_handshake_response-instance_method" title="#get_handshake_response (instance method)">#<strong>get_handshake_response</strong>(hello_command)  &#x21d2; Mongo::Protocol::Reply </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Sends the hello command to the server, then receive and deserialize the response.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#handshake!-instance_method" title="#handshake! (instance method)">#<strong>handshake!</strong>(speculative_auth_doc: nil)  &#x21d2; BSON::Document </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#post_handshake-instance_method" title="#post_handshake (instance method)">#<strong>post_handshake</strong>(response, average_rtt, minimum_rtt)  &#x21d2; Server::Description </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>This is a separate method to keep the nesting level down.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#resolved_user-instance_method" title="#resolved_user (instance method)">#<strong>resolved_user</strong>(speculative_auth_mech: nil)  &#x21d2; Auth::User </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>The user as going to be used for authentication.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited'><a href="ConnectionBase.html" title="Mongo::Server::ConnectionBase (class)"><code>ConnectionBase</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="ConnectionBase.html#app_metadata-instance_method" title="Mongo::Server::ConnectionBase#app_metadata (method)">#app_metadata</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="ConnectionBase.html#dispatch-instance_method" title="Mongo::Server::ConnectionBase#dispatch (method)">#dispatch</a></td>
      <td><div class='inline'><p>Dispatch a single message to the connection.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="ConnectionBase.html#generation-instance_method" title="Mongo::Server::ConnectionBase#generation (method)">#generation</a></td>
      <td><div class='inline'><p><a href="Connection.html" title="Mongo::Server::Connection (class)"><code>Connection</code></a> pool generation from which this connection was created.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="ConnectionBase.html#service_id-instance_method" title="Mongo::Server::ConnectionBase#service_id (method)">#service_id</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="ConnectionBase.html#check_timeout!-instance_method" title="Mongo::Server::ConnectionBase#check_timeout! (method)">#check_timeout!</a></td>
      <td><div class='inline'><p>If timeoutMS is set for the operation context, checks whether there is enough time left to send the corresponding message to the server (remaining timeout is bigger than minimum round trip time for the server).</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="ConnectionBase.html#deliver-instance_method" title="Mongo::Server::ConnectionBase#deliver (method)">#deliver</a>,
        <a class='i_m priv' href="ConnectionBase.html#serialize-instance_method" title="Mongo::Server::ConnectionBase#serialize (method)">#serialize</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../Monitoring/Publishable.html" title="Mongo::Monitoring::Publishable (module)"><code>::Mongo::Monitoring::Publishable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="../Monitoring/Publishable.html#publish_cmap_event-instance_method" title="Mongo::Monitoring::Publishable#publish_cmap_event (method)">#publish_cmap_event</a>,
        <a class='i_m deprecated' href="../Monitoring/Publishable.html#publish_event-instance_method" title="Mongo::Monitoring::Publishable#publish_event (method)">#publish_event</a>,
        <a class='i_m ' href="../Monitoring/Publishable.html#publish_sdam_event-instance_method" title="Mongo::Monitoring::Publishable#publish_sdam_event (method)">#publish_sdam_event</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_completed-instance_method" title="Mongo::Monitoring::Publishable#command_completed (method)">#command_completed</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_failed-instance_method" title="Mongo::Monitoring::Publishable#command_failed (method)">#command_failed</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_started-instance_method" title="Mongo::Monitoring::Publishable#command_started (method)">#command_started</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#command_succeeded-instance_method" title="Mongo::Monitoring::Publishable#command_succeeded (method)">#command_succeeded</a>,
        <a class='i_m priv' href="../Monitoring/Publishable.html#duration-instance_method" title="Mongo::Monitoring::Publishable#duration (method)">#duration</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_debug-instance_method" title="Mongo::Loggable#log_debug (method)">#log_debug</a></td>
      <td><div class='inline'><p>Convenience method to log debug messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_error-instance_method" title="Mongo::Loggable#log_error (method)">#log_error</a></td>
      <td><div class='inline'><p>Convenience method to log error messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_fatal-instance_method" title="Mongo::Loggable#log_fatal (method)">#log_fatal</a></td>
      <td><div class='inline'><p>Convenience method to log fatal messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_info-instance_method" title="Mongo::Loggable#log_info (method)">#log_info</a></td>
      <td><div class='inline'><p>Convenience method to log info messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#log_warn-instance_method" title="Mongo::Loggable#log_warn (method)">#log_warn</a></td>
      <td><div class='inline'><p>Convenience method to log warn messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../Loggable.html#logger-instance_method" title="Mongo::Loggable#logger (method)">#logger</a></td>
      <td><div class='inline'><p>Get the logger instance.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="../Loggable.html#_mongo_log_prefix-instance_method" title="Mongo::Loggable#_mongo_log_prefix (method)">#_mongo_log_prefix</a>,
        <a class='i_m priv' href="../Loggable.html#format_message-instance_method" title="Mongo::Loggable#format_message (method)">#format_message</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="ConnectionCommon.html" title="Mongo::Server::ConnectionCommon (class)"><code>ConnectionCommon</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="ConnectionCommon.html#handshake_command-instance_method" title="Mongo::Server::ConnectionCommon#handshake_command (method)">#handshake_command</a></td>
      <td><div class='inline'><p>Build a command that should be used for connection handshake.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="ConnectionCommon.html#handshake_document-instance_method" title="Mongo::Server::ConnectionCommon#handshake_document (method)">#handshake_document</a></td>
      <td><div class='inline'><p>Build a document that should be used for connection handshake.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="ConnectionCommon.html#add_server_diagnostics-instance_method" title="Mongo::Server::ConnectionCommon#add_server_diagnostics (method)">#add_server_diagnostics</a></td>
      <td><div class='inline'><p>Yields to the block and, if the block raises an exception, adds a note to the exception with the address of the specified server.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="ConnectionCommon.html#ensure_connected-instance_method" title="Mongo::Server::ConnectionCommon#ensure_connected (method)">#ensure_connected</a>,
        <a class='i_m priv' href="ConnectionCommon.html#set_compressor!-instance_method" title="Mongo::Server::ConnectionCommon#set_compressor! (method)">#set_compressor!</a>,
        <a class='i_m priv' href="ConnectionCommon.html#ssl_options-instance_method" title="Mongo::Server::ConnectionCommon#ssl_options (method)">#ssl_options</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="id-instance_method">
  <h3 class='signature ro  nodoc first'>
    #<strong>id</strong>  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>The ID for the connection. This is the same ID as that of the regular <a href="Connection.html" title="Mongo::Server::Connection (class)"><code>Connection</code></a> object for which this <code>PendingConnection</code> instance was created.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/pending_connection.rb#L38-L38'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='38' data-end='38'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/pending_connection.rb', line 38</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="authenticate!-instance_method">
  <h3 class='signature priv  nodoc first'>
    #<strong>authenticate!</strong>(speculative_auth_client_nonce: nil, speculative_auth_mech: nil, speculative_auth_result: nil)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>speculative_auth_client_nonce</span>
    <span class='type'>(<code>String</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The client nonce used in speculative auth on this connection that produced the specified speculative auth result.</p>
</div>
  </li>
  <li>
    <span class='name'>speculative_auth_mech</span>
    <span class='type'>(<a href="../../Symbol.html" title="Symbol (class)">Symbol</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p><a href="../Auth.html" title="Mongo::Auth (module)"><code>::Mongo::Auth</code></a> mechanism used for speculative auth, if speculative auth succeeded. If speculative auth was not performed or it failed, this must be nil.</p>
</div>
  </li>
  <li>
    <span class='name'>speculative_auth_result</span>
    <span class='type'>(<code>BSON::Document</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The value of speculativeAuthenticate field of hello response of the handshake on this connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/pending_connection.rb#L189-L215'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='189' data-end='215'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/pending_connection.rb', line 189</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_authenticate!'>authenticate!</span>(
  <span class='label'>speculative_auth_client_nonce:</span> <span class='kw'>nil</span><span class='comma'>,</span>
  <span class='label'>speculative_auth_mech:</span> <span class='kw'>nil</span><span class='comma'>,</span>
  <span class='label'>speculative_auth_result:</span> <span class='kw'>nil</span>
)
  <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>] <span class='op'>||</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_auth_mech'>auth_mech</span>]
    <span class='ivar'>@server</span>.<span class='id identifier rubyid_handle_auth_failure!'><a href="../Server.html#handle_auth_failure!-instance_method" title="Mongo::Server#handle_auth_failure! (method)">handle_auth_failure!</a></span> <span class='kw'>do</span>
      <span class='kw'>begin</span>
        <span class='id identifier rubyid_auth'>auth</span> <span class='op'>=</span> <span class='const'><a href="../Auth.html" title="Mongo::Auth (module)">Auth</a></span>.<span class='id identifier rubyid_get'><a href="../Auth.html#get-instance_method" title="Mongo::Auth#get (method)">get</a></span>(
          <span class='id identifier rubyid_resolved_user'><a href="#resolved_user-instance_method" title="Mongo::Server::PendingConnection#resolved_user (method)">resolved_user</a></span>(<span class='label'>speculative_auth_mech:</span> <span class='id identifier rubyid_speculative_auth_mech'>speculative_auth_mech</span>)<span class='comma'>,</span>
          <span class='kw'>self</span><span class='comma'>,</span>
          <span class='label'>speculative_auth_client_nonce:</span> <span class='id identifier rubyid_speculative_auth_client_nonce'>speculative_auth_client_nonce</span><span class='comma'>,</span>
          <span class='label'>speculative_auth_result:</span> <span class='id identifier rubyid_speculative_auth_result'>speculative_auth_result</span><span class='comma'>,</span>
        )
        <span class='id identifier rubyid_auth'>auth</span>.<span class='id identifier rubyid_login'>login</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_exc'>exc</span>
        <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to authenticate to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_warn_bg_exception'>warn_bg_exception</span>(<span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_exc'>exc</span><span class='comma'>,</span>
          <span class='label'>logger:</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_logger'>logger</span>]<span class='comma'>,</span>
          <span class='label'>log_prefix:</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_log_prefix'>log_prefix</span>]<span class='comma'>,</span>
          <span class='label'>bg_error_backtrace:</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_bg_error_backtrace'>bg_error_backtrace</span>]<span class='comma'>,</span>
        )
        <span class='id identifier rubyid_raise'>raise</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="default_mechanism-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>default_mechanism</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/pending_connection.rb#L288-L302'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='288' data-end='302'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/pending_connection.rb', line 288</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_default_mechanism'>default_mechanism</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Trying to query default mechanism when handshake has not completed</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_scram_sha_1_enabled?'>scram_sha_1_enabled?</span>
    <span class='kw'>if</span> <span class='ivar'>@sasl_supported_mechanisms</span><span class='op'>&amp;.</span><span class='id identifier rubyid_include?'>include?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SCRAM-SHA-256</span><span class='tstring_end'>&#39;</span></span>)
      <span class='symbeg'>:</span><span class='id identifier rubyid_scram256'>scram256</span>
    <span class='kw'>else</span>
      <span class='symbeg'>:</span><span class='id identifier rubyid_scram'>scram</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_mongodb_cr'>mongodb_cr</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ensure_connected-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>ensure_connected</strong> {|@socket| ... }  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Yields:</p>
<ul class='yield'>
  <li>
    <span class='type'>(@<code>socket</code>)</span>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/pending_connection.rb#L217-L219'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='217' data-end='219'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/pending_connection.rb', line 217</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ensure_connected'>ensure_connected</span>
  <span class='kw'>yield</span> <span class='ivar'>@socket</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="get_handshake_response-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>get_handshake_response</strong>(hello_command)  &#x21d2; <a href="../Protocol/Reply.html" title="Mongo::Protocol::Reply (class)">Mongo::Protocol::Reply</a>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Sends the hello command to the server, then receive and deserialize the response.</p>

<p>This method is extracted to be mocked in the tests.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>Command</span>
    <span class='type'>(<a href="../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Protocol::Message</a>)</span>
&mdash;    <div class='inline'>
<p>that should be sent to a server for handshake purposes.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Protocol/Reply.html" title="Mongo::Protocol::Reply (class)">Mongo::Protocol::Reply</a>)</span>
&mdash;    <div class='inline'>
<p>Deserialized server response.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/pending_connection.rb#L122-L129'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='122' data-end='129'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/pending_connection.rb', line 122</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_get_handshake_response'>get_handshake_response</span>(<span class='id identifier rubyid_hello_command'>hello_command</span>)
  <span class='ivar'>@server</span>.<span class='id identifier rubyid_round_trip_time_calculator'><a href="../Server.html#round_trip_time_calculator-instance_method" title="Mongo::Server#round_trip_time_calculator (method)">round_trip_time_calculator</a></span>.<span class='id identifier rubyid_measure'>measure</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_add_server_diagnostics'>add_server_diagnostics</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_socket'>socket</span>.<span class='id identifier rubyid_write'>write</span>(<span class='id identifier rubyid_hello_command'>hello_command</span>.<span class='id identifier rubyid_serialize'>serialize</span>.<span class='id identifier rubyid_to_s'>to_s</span>)
      <span class='const'><a href="../Protocol.html" title="Mongo::Protocol (module)">Protocol</a></span><span class='op'>::</span><span class='const'><a href="../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Message</a></span>.<span class='id identifier rubyid_deserialize'><a href="../Protocol/Message.html#deserialize-class_method" title="Mongo::Protocol::Message.deserialize (method)">deserialize</a></span>(<span class='id identifier rubyid_socket'>socket</span><span class='comma'>,</span> <span class='const'><a href="../Protocol.html" title="Mongo::Protocol (module)">Protocol</a></span><span class='op'>::</span><span class='const'><a href="../Protocol/Message.html" title="Mongo::Protocol::Message (class)">Message</a></span><span class='op'>::</span><span class='const'><a href="../Protocol/Message.html#MAX_MESSAGE_SIZE-constant" title="Mongo::Protocol::Message::MAX_MESSAGE_SIZE (constant)">MAX_MESSAGE_SIZE</a></span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handshake!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>handshake!</strong>(speculative_auth_doc: nil)  &#x21d2; <code>BSON::Document</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>speculative_auth_doc</span>
    <span class='type'>(<code>BSON::Document</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The document to provide in speculativeAuthenticate field of handshake command.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>The document of the handshake response for this particular connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/pending_connection.rb#L136-L178'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='136' data-end='178'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/pending_connection.rb', line 136</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handshake!'>handshake!</span>(<span class='label'>speculative_auth_doc:</span> <span class='kw'>nil</span>)
  <span class='kw'>unless</span> <span class='id identifier rubyid_socket'>socket</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InternalDriverError.html" title="Mongo::Error::InternalDriverError (class)">InternalDriverError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cannot handshake because there is no usable socket (for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_hello_command'>hello_command</span> <span class='op'>=</span> <span class='id identifier rubyid_handshake_command'>handshake_command</span>(
    <span class='id identifier rubyid_handshake_document'>handshake_document</span>(
      <span class='id identifier rubyid_app_metadata'>app_metadata</span><span class='comma'>,</span>
      <span class='label'>speculative_auth_doc:</span> <span class='id identifier rubyid_speculative_auth_doc'>speculative_auth_doc</span><span class='comma'>,</span>
      <span class='label'>load_balancer:</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span><span class='comma'>,</span>
      <span class='label'>server_api:</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_server_api'>server_api</span>]
    )
  )
  <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@server</span>.<span class='id identifier rubyid_handle_handshake_failure!'><a href="../Server.html#handle_handshake_failure!-instance_method" title="Mongo::Server#handle_handshake_failure! (method)">handle_handshake_failure!</a></span> <span class='kw'>do</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='id identifier rubyid_get_handshake_response'><a href="#get_handshake_response-instance_method" title="Mongo::Server::PendingConnection#get_handshake_response (method)">get_handshake_response</a></span>(<span class='id identifier rubyid_hello_command'>hello_command</span>)
      <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='const'><a href="../Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="../Operation/Result.html" title="Mongo::Operation::Result (class)">Result</a></span>.<span class='id identifier rubyid_new'><a href="../Operation/Result.html#new-class_method" title="Mongo::Operation::Result.new (method)">new</a></span>([<span class='id identifier rubyid_response'>response</span>])
      <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_validate!'>validate!</span>
      <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_first'>first</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_exc'>exc</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to handshake with </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'><a href="../Utils.html" title="Mongo::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_warn_bg_exception'>warn_bg_exception</span>(<span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_exc'>exc</span><span class='comma'>,</span>
        <span class='label'>logger:</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_logger'>logger</span>]<span class='comma'>,</span>
        <span class='label'>log_prefix:</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_log_prefix'>log_prefix</span>]<span class='comma'>,</span>
        <span class='label'>bg_error_backtrace:</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_bg_error_backtrace'>bg_error_backtrace</span>]<span class='comma'>,</span>
      )
      <span class='id identifier rubyid_raise'>raise</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_force_load_balancer?'><a href="../Server.html#force_load_balancer%3F-instance_method" title="Mongo::Server#force_load_balancer? (method)">force_load_balancer?</a></span>
    <span class='id identifier rubyid_doc'>doc</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>serviceId</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>||=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fake:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rand'>rand</span>(<span class='int'>2</span><span class='op'>**</span><span class='int'>32</span><span class='op'>-</span><span class='int'>1</span>)<span class='op'>+</span><span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_post_handshake'><a href="#post_handshake-instance_method" title="Mongo::Server::PendingConnection#post_handshake (method)">post_handshake</a></span>(
    <span class='id identifier rubyid_doc'>doc</span><span class='comma'>,</span>
    <span class='ivar'>@server</span>.<span class='id identifier rubyid_round_trip_time_calculator'><a href="../Server.html#round_trip_time_calculator-instance_method" title="Mongo::Server#round_trip_time_calculator (method)">round_trip_time_calculator</a></span>.<span class='id identifier rubyid_average_round_trip_time'>average_round_trip_time</span><span class='comma'>,</span>
    <span class='ivar'>@server</span>.<span class='id identifier rubyid_round_trip_time_calculator'><a href="../Server.html#round_trip_time_calculator-instance_method" title="Mongo::Server#round_trip_time_calculator (method)">round_trip_time_calculator</a></span>.<span class='id identifier rubyid_minimum_round_trip_time'>minimum_round_trip_time</span>
  )

  <span class='id identifier rubyid_doc'>doc</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handshake_and_authenticate!-instance_method">
  <h3 class='signature nodoc'>
    #<strong>handshake_and_authenticate!</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/pending_connection.rb#L40-L109'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='40' data-end='109'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/pending_connection.rb', line 40</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handshake_and_authenticate!'>handshake_and_authenticate!</span>
  <span class='id identifier rubyid_speculative_auth_doc'>speculative_auth_doc</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>] <span class='op'>||</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_auth_mech'>auth_mech</span>]
    <span class='comment'># To create an Auth instance, we need to specify the mechanism,
</span>    <span class='comment'># but at this point we don&#39;t know the mechanism that ultimately
</span>    <span class='comment'># will be used (since this depends on the data returned by
</span>    <span class='comment'># the handshake, specifically server version).
</span>    <span class='comment'># However, we know that only 4.4+ servers support speculative
</span>    <span class='comment'># authentication, and those servers also generally support
</span>    <span class='comment'># SCRAM-SHA-256. We expect that user accounts created for 4.4+
</span>    <span class='comment'># servers would generally allow SCRAM-SHA-256 authentication;
</span>    <span class='comment'># user accounts migrated from pre-4.4 servers may only allow
</span>    <span class='comment'># SCRAM-SHA-1. The use of SCRAM-SHA-256 by default is thus
</span>    <span class='comment'># sensible, and it is also mandated by the speculative auth spec.
</span>    <span class='comment'># If no mechanism was specified and we are talking to a 3.0+
</span>    <span class='comment'># server, we&#39;ll send speculative auth document, the server will
</span>    <span class='comment'># ignore it and we&#39;ll perform authentication using explicit
</span>    <span class='comment'># command after having defaulted the mechanism later to CR.
</span>    <span class='comment'># If no mechanism was specified and we are talking to a 4.4+
</span>    <span class='comment'># server and the user account doesn&#39;t allow SCRAM-SHA-256, we will
</span>    <span class='comment'># authenticate in a separate command with SCRAM-SHA-1 after
</span>    <span class='comment'># going through SCRAM mechanism negotiation.
</span>    <span class='id identifier rubyid_default_options'>default_options</span> <span class='op'>=</span> <span class='const'><a href="../Options.html" title="Mongo::Options (module)">Options</a></span><span class='op'>::</span><span class='const'><a href="../Options/Redacted.html" title="Mongo::Options::Redacted (class)">Redacted</a></span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Server::PendingConnection.new (method)">new</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_auth_mech'>auth_mech</span> <span class='op'>=&gt;</span> <span class='symbeg'>:</span><span class='id identifier rubyid_scram256'>scram256</span>)
    <span class='id identifier rubyid_speculative_auth_user'>speculative_auth_user</span> <span class='op'>=</span> <span class='const'><a href="../Auth.html" title="Mongo::Auth (module)">Auth</a></span><span class='op'>::</span><span class='const'><a href="../Auth/User.html" title="Mongo::Auth::User (class)">User</a></span>.<span class='id identifier rubyid_new'><a href="../Auth/User.html#new-class_method" title="Mongo::Auth::User.new (method)">new</a></span>(<span class='id identifier rubyid_default_options'>default_options</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>))
    <span class='id identifier rubyid_speculative_auth'>speculative_auth</span> <span class='op'>=</span> <span class='const'><a href="../Auth.html" title="Mongo::Auth (module)">Auth</a></span>.<span class='id identifier rubyid_get'><a href="../Auth.html#get-instance_method" title="Mongo::Auth#get (method)">get</a></span>(<span class='id identifier rubyid_speculative_auth_user'>speculative_auth_user</span><span class='comma'>,</span> <span class='kw'>self</span>)
    <span class='id identifier rubyid_speculative_auth_doc'>speculative_auth_doc</span> <span class='op'>=</span> <span class='id identifier rubyid_speculative_auth'>speculative_auth</span>.<span class='id identifier rubyid_conversation'>conversation</span>.<span class='id identifier rubyid_speculative_auth_document'>speculative_auth_document</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_handshake!'><a href="#handshake!-instance_method" title="Mongo::Server::PendingConnection#handshake! (method)">handshake!</a></span>(<span class='label'>speculative_auth_doc:</span> <span class='id identifier rubyid_speculative_auth_doc'>speculative_auth_doc</span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_unknown?'>unknown?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InternalDriverError.html" title="Mongo::Error::InternalDriverError (class)">InternalDriverError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connection description cannot be unknown after successful handshake: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_inspect'><a href="../Server.html#inspect-instance_method" title="Mongo::Server#inspect (method)">inspect</a></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_speculative_auth_doc'>speculative_auth_doc</span> <span class='op'>&amp;&amp;</span> (<span class='id identifier rubyid_speculative_auth_result'>speculative_auth_result</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>speculativeAuthenticate</span><span class='tstring_end'>&#39;</span></span>])
      <span class='kw'>unless</span> <span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_scram_sha_1_enabled?'>scram_sha_1_enabled?</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InvalidServerAuthResponse.html" title="Mongo::Error::InvalidServerAuthResponse (class)">InvalidServerAuthResponse</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Speculative auth succeeded on a pre-3.0 server</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='kw'>case</span> <span class='id identifier rubyid_speculative_auth_user'>speculative_auth_user</span>.<span class='id identifier rubyid_mechanism'>mechanism</span>
      <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_mongodb_x509'>mongodb_x509</span>
        <span class='comment'># Done
</span>      <span class='comment'># We default auth mechanism to scram256, but if user specified
</span>      <span class='comment'># scram explicitly we may be able to authenticate speculatively
</span>      <span class='comment'># with scram.
</span>      <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_scram'>scram</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_scram256'>scram256</span>
        <span class='id identifier rubyid_authenticate!'><a href="#authenticate!-instance_method" title="Mongo::Server::PendingConnection#authenticate! (method)">authenticate!</a></span>(
          <span class='label'>speculative_auth_client_nonce:</span> <span class='id identifier rubyid_speculative_auth'>speculative_auth</span>.<span class='id identifier rubyid_conversation'>conversation</span>.<span class='id identifier rubyid_client_nonce'>client_nonce</span><span class='comma'>,</span>
          <span class='label'>speculative_auth_mech:</span> <span class='id identifier rubyid_speculative_auth_user'>speculative_auth_user</span>.<span class='id identifier rubyid_mechanism'>mechanism</span><span class='comma'>,</span>
          <span class='label'>speculative_auth_result:</span> <span class='id identifier rubyid_speculative_auth_result'>speculative_auth_result</span><span class='comma'>,</span>
        )
      <span class='kw'>else</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InternalDriverError.html" title="Mongo::Error::InternalDriverError (class)">InternalDriverError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Speculative auth unexpectedly succeeded for mechanism </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_speculative_auth_user'>speculative_auth_user</span>.<span class='id identifier rubyid_mechanism'>mechanism</span>.<span class='id identifier rubyid_inspect'><a href="../Server.html#inspect-instance_method" title="Mongo::Server#inspect (method)">inspect</a></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_arbiter?'>arbiter?</span>
      <span class='id identifier rubyid_authenticate!'><a href="#authenticate!-instance_method" title="Mongo::Server::PendingConnection#authenticate! (method)">authenticate!</a></span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='comma'>,</span> <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/AuthError.html" title="Mongo::Error::AuthError (class)">AuthError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_exc'>exc</span>
    <span class='id identifier rubyid_exc'>exc</span>.<span class='id identifier rubyid_service_id'>service_id</span> <span class='op'>=</span> <span class='id identifier rubyid_service_id'>service_id</span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_unknown?'>unknown?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/InternalDriverError.html" title="Mongo::Error::InternalDriverError (class)">InternalDriverError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connection description cannot be unknown after successful authentication: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_inspect'><a href="../Server.html#inspect-instance_method" title="Mongo::Server#inspect (method)">inspect</a></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_mongos?'>mongos?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/BadLoadBalancerTarget.html" title="Mongo::Error::BadLoadBalancerTarget (class)">BadLoadBalancerTarget</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Load-balanced operation requires being connected a mongos, but the server at </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span>.<span class='id identifier rubyid_seed'>seed</span><span class='embexpr_end'>}</span><span class='tstring_content'> reported itself as </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span>.<span class='id identifier rubyid_server_type'>server_type</span>.<span class='id identifier rubyid_to_s'>to_s</span>.<span class='id identifier rubyid_gsub'>gsub</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>_</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> </span><span class='tstring_end'>&#39;</span></span>)<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="post_handshake-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>post_handshake</strong>(response, average_rtt, minimum_rtt)  &#x21d2; <a href="Description.html" title="Mongo::Server::Description (class)">Server::Description</a>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>This is a separate method to keep the nesting level down.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="Description.html" title="Mongo::Server::Description (class)">Server::Description</a>)</span>
&mdash;    <div class='inline'>
<p>The server description calculated from the handshake response for this particular connection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/pending_connection.rb#L225-L249'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='225' data-end='249'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/pending_connection.rb', line 225</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_post_handshake'>post_handshake</span>(<span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_average_rtt'>average_rtt</span><span class='comma'>,</span> <span class='id identifier rubyid_minimum_rtt'>minimum_rtt</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&quot;</span></span>] <span class='op'>==</span> <span class='int'>1</span>
    <span class='comment'># Auth mechanism is entirely dependent on the contents of
</span>    <span class='comment'># hello response *for this connection*.
</span>    <span class='comment'># Hello received by the monitoring connection should advertise
</span>    <span class='comment'># the same wire protocol, but if it doesn&#39;t, we use whatever
</span>    <span class='comment'># the monitoring connection advertised for filling out the
</span>    <span class='comment'># server description and whatever the non-monitoring connection
</span>    <span class='comment'># (that&#39;s this one) advertised for performing auth on that
</span>    <span class='comment'># connection.
</span>    <span class='ivar'>@sasl_supported_mechanisms</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saslSupportedMechs</span><span class='tstring_end'>&#39;</span></span>]
    <span class='id identifier rubyid_set_compressor!'>set_compressor!</span>(<span class='id identifier rubyid_response'>response</span>)
  <span class='kw'>else</span>
    <span class='ivar'>@sasl_supported_mechanisms</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='ivar'>@description</span> <span class='op'>=</span> <span class='const'><a href="Description.html" title="Mongo::Server::Description (class)">Description</a></span>.<span class='id identifier rubyid_new'><a href="Description.html#new-class_method" title="Mongo::Server::Description.new (method)">new</a></span>(
    <span class='id identifier rubyid_address'><a href="../Server.html#address-instance_method" title="Mongo::Server#address (method)">address</a></span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span>
    <span class='label'>average_round_trip_time:</span> <span class='id identifier rubyid_average_rtt'>average_rtt</span><span class='comma'>,</span>
    <span class='label'>load_balancer:</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span><span class='comma'>,</span>
    <span class='label'>force_load_balancer:</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_connect'>connect</span>] <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_load_balanced'>load_balanced</span><span class='comma'>,</span>
  ).<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_new_description'>new_description</span><span class='op'>|</span>
    <span class='ivar'>@server</span>.<span class='id identifier rubyid_cluster'><a href="../Server.html#cluster-instance_method" title="Mongo::Server#cluster (method)">cluster</a></span>.<span class='id identifier rubyid_run_sdam_flow'>run_sdam_flow</span>(<span class='ivar'>@server</span>.<span class='id identifier rubyid_description'><a href="../Server.html#description-instance_method" title="Mongo::Server#description (method)">description</a></span><span class='comma'>,</span> <span class='id identifier rubyid_new_description'>new_description</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="resolved_user-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>resolved_user</strong>(speculative_auth_mech: nil)  &#x21d2; <a href="../Auth/User.html" title="Mongo::Auth::User (class)">Auth::User</a>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>The user as going to be used for authentication. This user has the auth mechanism set and, if necessary, auth source.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>speculative_auth_mech</span>
    <span class='type'>(<a href="../../Symbol.html" title="Symbol (class)">Symbol</a> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p><a href="../Auth.html" title="Mongo::Auth (module)"><code>::Mongo::Auth</code></a> mechanism used for speculative auth, if speculative auth succeeded. If speculative auth was not performed or it failed, this must be nil.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Auth/User.html" title="Mongo::Auth::User (class)">Auth::User</a>)</span>
&mdash;    <div class='inline'>
<p>The resolved user.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/server/pending_connection.rb#L259-L286'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='259' data-end='286'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/server/pending_connection.rb', line 259</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_resolved_user'>resolved_user</span>(<span class='label'>speculative_auth_mech:</span> <span class='kw'>nil</span>)
  <span class='ivar'>@resolved_user</span> <span class='op'>||=</span> <span class='kw'>begin</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>] <span class='op'>||</span> <span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_auth_mech'>auth_mech</span>]
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>No authentication information specified in the client</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_user_options'>user_options</span> <span class='op'>=</span> <span class='const'><a href="../Options.html" title="Mongo::Options (module)">Options</a></span><span class='op'>::</span><span class='const'><a href="../Options/Redacted.html" title="Mongo::Options::Redacted (class)">Redacted</a></span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Server::PendingConnection.new (method)">new</a></span>(
      <span class='comment'># When speculative auth is performed, we always use SCRAM-SHA-256.
</span>      <span class='comment'># At the same time we perform SCRAM mechanism negotiation in the
</span>      <span class='comment'># hello request.
</span>      <span class='comment'># If the credentials we are trying to authenticate with do not
</span>      <span class='comment'># map to an existing user, SCRAM mechanism negotiation will not
</span>      <span class='comment'># return anything which would cause the driver to use
</span>      <span class='comment'># SCRAM-SHA-1. However, on 4.4+ servers speculative auth would
</span>      <span class='comment'># succeed (technically just the first round-trip, not the entire
</span>      <span class='comment'># authentication flow) and we would be continuing it here;
</span>      <span class='comment'># in this case, we must use SCRAM-SHA-256 as the mechanism since
</span>      <span class='comment'># that is what the conversation was started with, even though
</span>      <span class='comment'># SCRAM mechanism negotiation did not return SCRAM-SHA-256 as a
</span>      <span class='comment'># valid mechanism to use for these credentials.
</span>      <span class='symbeg'>:</span><span class='id identifier rubyid_auth_mech'>auth_mech</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_speculative_auth_mech'>speculative_auth_mech</span> <span class='op'>||</span> <span class='id identifier rubyid_default_mechanism'><a href="#default_mechanism-instance_method" title="Mongo::Server::PendingConnection#default_mechanism (method)">default_mechanism</a></span><span class='comma'>,</span>
    ).<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_options'><a href="../Server.html#options-instance_method" title="Mongo::Server#options (method)">options</a></span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_user_options'>user_options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_auth_mech'>auth_mech</span>] <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_mongodb_x509'>mongodb_x509</span>
      <span class='id identifier rubyid_user_options'>user_options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_auth_source'>auth_source</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$external</span><span class='tstring_end'>&#39;</span></span>
    <span class='kw'>end</span>
    <span class='const'><a href="../Auth.html" title="Mongo::Auth (module)">Auth</a></span><span class='op'>::</span><span class='const'><a href="../Auth/User.html" title="Mongo::Auth::User (class)">User</a></span>.<span class='id identifier rubyid_new'><a href="../Auth/User.html#new-class_method" title="Mongo::Auth::User.new (method)">new</a></span>(<span class='id identifier rubyid_user_options'>user_options</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>