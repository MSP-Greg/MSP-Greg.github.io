<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Retryable::ReadWorker &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Retryable::ReadWorker",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongo master</a> &raquo; 
      <a href='../../_index.html#alpha_R'>Index (R)</a> &raquo; 
        <a href="../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../Retryable.html" title="Mongo::Retryable (module)">Retryable</a> &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>ReadWorker&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Retryable::ReadWorker  <span class='private note title'>Private</span>
</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This class is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          <a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)"><code>BaseWorker</code></a>,
          Forwardable
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)"><code>BaseWorker</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2 o'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)">Mongo::Retryable::BaseWorker</a></span>
        <ul class='fullTree'>
          <li>Object</li>
          <li class='next'><a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)">Mongo::Retryable::BaseWorker</a></li>
          <li class='next'>Mongo::Retryable::ReadWorker</li>
        </ul>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/read_worker.rb#L28'>lib/mongo/retryable/read_worker.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Implements the logic around retrying read operations.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 class='h2_sum' id='class_Method_summary'>Class Method Summary</h2>
<div class='div_sum'>

<h3 class='inherited nodoc'><a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)"><code>BaseWorker</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="BaseWorker.html#new-class_method" title="Mongo::Retryable::BaseWorker.new (method)">.new</a></td>
      <td><div class='inline'><p>Constructs a new worker.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_Attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>

<h3 class='inherited nodoc'><a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)"><code>BaseWorker</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro nodoc' href="BaseWorker.html#retryable-instance_method" title="Mongo::Retryable::BaseWorker#retryable (method)">#retryable</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#read_with_one_retry-instance_method" title="#read_with_one_retry (instance method)">#<strong>read_with_one_retry</strong>(options = nil) { ... } &#x21d2; Result </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Execute a read operation with a single retry on network errors.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#read_with_retry-instance_method" title="#read_with_retry (instance method)">#<strong>read_with_retry</strong>(session = nil, server_selector = nil, &amp;block)  &#x21d2; Result </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Execute a read operation with retrying.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#read_with_retry_cursor-instance_method" title="#read_with_retry_cursor (instance method)">#<strong>read_with_retry_cursor</strong>(session, server_selector, view, &amp;block)  &#x21d2; Cursor </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Execute a read operation returning a cursor with retrying.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#deprecated_legacy_read_with_retry-instance_method" title="#deprecated_legacy_read_with_retry (instance method)">#<strong>deprecated_legacy_read_with_retry</strong>(&amp;block)  &#x21d2; Result </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Attempts to do a legacy read_with_retry, without either a session or server_selector.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#legacy_read_with_retry-instance_method" title="#legacy_read_with_retry (instance method)">#<strong>legacy_read_with_retry</strong>(session, server_selector, &amp;block)  &#x21d2; Result </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Attempts to do a “legacy” read with retry.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#modern_read_with_retry-instance_method" title="#modern_read_with_retry (instance method)">#<strong>modern_read_with_retry</strong>(session, server_selector, &amp;block)  &#x21d2; Result </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Attempts to do a “modern” read with retry.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#read_without_retry-instance_method" title="#read_without_retry (instance method)">#<strong>read_without_retry</strong>(session, server_selector, &amp;block)  &#x21d2; Result </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Attempts to do a read <strong>without</strong> a retry; for example, when retries have been explicitly disabled.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#retry_read-instance_method" title="#retry_read (instance method)">#<strong>retry_read</strong>(original_error, session, server_selector, failed_server: nil, &amp;block)  &#x21d2; Result </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>The retry logic of the “modern” read_with_retry implementation.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited nodoc'><a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)"><code>BaseWorker</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="BaseWorker.html#deprecation_warning-instance_method" title="Mongo::Retryable::BaseWorker#deprecation_warning (method)">#deprecation_warning</a></td>
      <td><div class='inline'><p>Logs the given deprecation warning the first time it is called for a given key; after that, it does nothing when given the same key.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="BaseWorker.html#is_retryable_exception%3F-instance_method" title="Mongo::Retryable::BaseWorker#is_retryable_exception? (method)">#is_retryable_exception?</a></td>
      <td><div class='inline'><p>Tests to see if the given exception instance is of a type that can be retried.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="BaseWorker.html#log_retry-instance_method" title="Mongo::Retryable::BaseWorker#log_retry (method)">#log_retry</a></td>
      <td><div class='inline'><p>Log a warning so that any application slow down is immediately obvious.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="BaseWorker.html#retryable_exceptions-instance_method" title="Mongo::Retryable::BaseWorker#retryable_exceptions (method)">#retryable_exceptions</a></td>
      <td><div class='inline'><p>Indicate which exception classes that are generally retryable.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="deprecated_legacy_read_with_retry-instance_method">
  <h3 class='signature priv  nodoc first'>
    #<strong>deprecated_legacy_read_with_retry</strong>(&amp;block)  &#x21d2; <code>Result</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Attempts to do a legacy read_with_retry, without either a session or server_selector. This is a deprecated use-case, and a warning will be issued the first time this is invoked.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>block</span>
    <span class='type'>(<code>Proc</code>)</span>
&mdash;    <div class='inline'>
<p>The block to execute.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Result</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/read_worker.rb#L168-L180'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='168' data-end='180'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/read_worker.rb', line 168</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_deprecated_legacy_read_with_retry'>deprecated_legacy_read_with_retry</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_deprecation_warning'>deprecation_warning</span> <span class='symbeg'>:</span><span class='id identifier rubyid_read_with_retry'><a href="#read_with_retry-instance_method" title="Mongo::Retryable::ReadWorker#read_with_retry (method)">read_with_retry</a></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Legacy read_with_retry invocation - </span><span class='tstring_end'>&#39;</span></span> \
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>please update the application and/or its dependencies</span><span class='tstring_end'>&#39;</span></span>

  <span class='comment'># Since we don&#39;t have a session, we cannot use the modern read retries.
</span>  <span class='comment'># And we need to select a server but we don&#39;t have a server selector.
</span>  <span class='comment'># Use PrimaryPreferred which will work as long as there is a data
</span>  <span class='comment'># bearing node in the cluster; the block may select a different server
</span>  <span class='comment'># which is fine.
</span>  <span class='id identifier rubyid_server_selector'>server_selector</span> <span class='op'>=</span> <span class='const'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span>.<span class='id identifier rubyid_get'><a href="../ServerSelector.html#get-instance_method" title="Mongo::ServerSelector#get (method)">get</a></span>(<span class='label'>mode:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_preferred'>primary_preferred</span>)
  <span class='id identifier rubyid_legacy_read_with_retry'><a href="#legacy_read_with_retry-instance_method" title="Mongo::Retryable::ReadWorker#legacy_read_with_retry (method)">legacy_read_with_retry</a></span>(<span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="legacy_read_with_retry-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>legacy_read_with_retry</strong>(session, server_selector, &amp;block)  &#x21d2; <code>Result</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Attempts to do a “legacy” read with retry. The operation will be attempted multiple times, up to the client’s ‘max_read_retries` setting.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>session</span>
    <span class='type'>(<a href="../Session.html" title="Mongo::Session (class)">Mongo::Session</a>)</span>
&mdash;    <div class='inline'>
<p>The session that the operation is being run on.</p>
</div>
  </li>
  <li>
    <span class='name'>server_selector</span>
    <span class='type'>(<code>Mongo::ServerSelector::Selectable</code>)</span>
&mdash;    <div class='inline'>
<p><a href="../Server.html" title="Mongo::Server (class)"><code>::Mongo::Server</code></a> selector for the operation.</p>
</div>
  </li>
  <li>
    <span class='name'>block</span>
    <span class='type'>(<code>Proc</code>)</span>
&mdash;    <div class='inline'>
<p>The block to execute.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Result</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/read_worker.rb#L213-L230'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='213' data-end='230'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/read_worker.rb', line 213</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_legacy_read_with_retry'>legacy_read_with_retry</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>=</span> <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>?</span> <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>+</span> <span class='int'>1</span> <span class='op'>:</span> <span class='int'>1</span>
  <span class='kw'>yield</span> <span class='id identifier rubyid_select_server'><a href="../Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">select_server</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)
<span class='kw'>rescue</span> <span class='op'>*</span><span class='id identifier rubyid_retryable_exceptions'>retryable_exceptions</span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolError.html" title="Mongo::Error::PoolError (class)">PoolError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_notes'>add_notes</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>legacy retry</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attempt </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_attempt'>attempt</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
  
  <span class='kw'>if</span> <span class='id identifier rubyid_is_retryable_exception?'>is_retryable_exception?</span>(<span class='id identifier rubyid_e'>e</span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span> <span class='kw'>if</span> <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_max_read_retries'>max_read_retries</span> <span class='op'>||</span> <span class='id identifier rubyid_session'>session</span><span class='op'>&amp;.</span><span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_retryable?'>retryable?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_session'>session</span><span class='op'>&amp;.</span><span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span> <span class='kw'>if</span> <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_max_read_retries'>max_read_retries</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>end</span>
  
  <span class='id identifier rubyid_log_retry'>log_retry</span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Legacy read retry</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_sleep'>sleep</span>(<span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_read_retry_interval'>read_retry_interval</span>) <span class='kw'>unless</span> <span class='id identifier rubyid_is_retryable_exception?'>is_retryable_exception?</span>(<span class='id identifier rubyid_e'>e</span>)
  <span class='kw'>retry</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="modern_read_with_retry-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>modern_read_with_retry</strong>(session, server_selector, &amp;block)  &#x21d2; <code>Result</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Attempts to do a “modern” read with retry. Only a single retry will be attempted.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>session</span>
    <span class='type'>(<a href="../Session.html" title="Mongo::Session (class)">Mongo::Session</a>)</span>
&mdash;    <div class='inline'>
<p>The session that the operation is being run on.</p>
</div>
  </li>
  <li>
    <span class='name'>server_selector</span>
    <span class='type'>(<code>Mongo::ServerSelector::Selectable</code>)</span>
&mdash;    <div class='inline'>
<p><a href="../Server.html" title="Mongo::Server (class)"><code>::Mongo::Server</code></a> selector for the operation.</p>
</div>
  </li>
  <li>
    <span class='name'>block</span>
    <span class='type'>(<code>Proc</code>)</span>
&mdash;    <div class='inline'>
<p>The block to execute.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Result</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/read_worker.rb#L192-L200'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='192' data-end='200'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/read_worker.rb', line 192</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_modern_read_with_retry'>modern_read_with_retry</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_select_server'><a href="../Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">select_server</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)
  <span class='kw'>yield</span> <span class='id identifier rubyid_server'>server</span>
<span class='kw'>rescue</span> <span class='op'>*</span><span class='id identifier rubyid_retryable_exceptions'>retryable_exceptions</span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span><span class='comma'>,</span> <span class='const'><a href="../Auth.html" title="Mongo::Auth (module)">Auth</a></span><span class='op'>::</span><span class='const'><a href="../Auth/Unauthorized.html" title="Mongo::Auth::Unauthorized (class)">Unauthorized</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolError.html" title="Mongo::Error::PoolError (class)">PoolError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_notes'>add_notes</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>modern retry</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>attempt 1</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span> <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_is_retryable_exception?'>is_retryable_exception?</span>(<span class='id identifier rubyid_e'>e</span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_write_retryable?'>write_retryable?</span>
  <span class='id identifier rubyid_retry_read'><a href="#retry_read-instance_method" title="Mongo::Retryable::ReadWorker#retry_read (method)">retry_read</a></span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='label'>failed_server:</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_with_one_retry-instance_method">
  <h3 class='signature nodoc'>
    #<strong>read_with_one_retry</strong>(options = nil) { ... } &#x21d2; <code>Result</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>This only retries read operations on socket errors.</p>
</div>
  </div>


<p>Execute a read operation with a single retry on network errors.</p>

<p>This method is used by the driver for some of the internal housekeeping operations. Application-requested reads should use read_with_retry rather than this method.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Execute the read.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_read_with_one_retry'>read_with_one_retry</span> <span class='kw'>do</span>
  <span class='op'>...</span>
<span class='kw'>end</span></code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>options</span>
    <span class='type'>(<code>Hash</code> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p><a href="../Options.html" title="Mongo::Options (module)"><code>::Mongo::Options</code></a>.</p>
</div>
  </li>
</ul>
    <p class='tag_title'>Options Hash (<tt>options</tt>):</p>
    <ul class='option'>
        <li>
          <span class='name'>:retry_message</span>
          <span class='type'>(<code>String</code>)</span>
            &mdash; <div class='inline'>
<p>Message to log when retrying.</p>
</div>        </li>
    </ul>
<p class='tag_title'>Yields:</p>
<ul class='yield'>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p>Calls the provided block with no arguments</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Result</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.2.6</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/read_worker.rb#L149-L157'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='149' data-end='157'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/read_worker.rb', line 149</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_with_one_retry'>read_with_one_retry</span>(<span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='kw'>yield</span>
<span class='kw'>rescue</span> <span class='op'>*</span><span class='id identifier rubyid_retryable_exceptions'>retryable_exceptions</span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolError.html" title="Mongo::Error::PoolError (class)">PoolError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span> <span class='kw'>unless</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_write_retryable?'>write_retryable?</span>

  <span class='id identifier rubyid_retry_message'>retry_message</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_retry_message'>retry_message</span>]
  <span class='id identifier rubyid_log_retry'>log_retry</span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='id identifier rubyid_retry_message'>retry_message</span>)
  <span class='kw'>yield</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_with_retry-instance_method">
  <h3 class='signature nodoc'>
    #<strong>read_with_retry</strong>(session = nil, server_selector = nil, &amp;block)  &#x21d2; <code>Result</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Execute a read operation with retrying.</p>

<p>This method performs server selection for the specified server selector and yields to the provided block, which should execute the initial query operation and return its result. The block will be passed the server selected for the operation. If the block raises an exception, and this exception corresponds to a read retryable error, and read retries are enabled for the client, this method will perform server selection again and yield to the block again (with potentially a different server). If the block returns successfully, the result of the block is returned.</p>

<p>If modern retry reads are on (which is the default), the initial read operation will be retried once. If legacy retry reads are on, the initial read operation will be retried zero or more times depending on the <code>:max_read_retries</code> client setting, the default for which is 1. To disable read retries, turn off modern read retries by setting retry_reads: false and set <code>:max_read_retries</code> to 0 on the client.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Execute the read.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_read_with_retry'>read_with_retry</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
  <span class='op'>...</span>
<span class='kw'>end</span></code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>session</span>
    <span class='type'>(<a href="../Session.html" title="Mongo::Session (class)">Mongo::Session</a> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>The session that the operation is being run on.</p>
</div>
  </li>
  <li>
    <span class='name'>server_selector</span>
    <span class='type'>(<code>Mongo::ServerSelector::Selectable</code> | <code>nil</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p><a href="../Server.html" title="Mongo::Server (class)"><code>::Mongo::Server</code></a> selector for the operation.</p>
</div>
  </li>
  <li>
    <span class='name'>block</span>
    <span class='type'>(<code>Proc</code>)</span>
&mdash;    <div class='inline'>
<p>The block to execute.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Result</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/read_worker.rb#L113-L123'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='113' data-end='123'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/read_worker.rb', line 113</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_with_retry'>read_with_retry</span>(<span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_server_selector'>server_selector</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_deprecated_legacy_read_with_retry'><a href="#deprecated_legacy_read_with_retry-instance_method" title="Mongo::Retryable::ReadWorker#deprecated_legacy_read_with_retry (method)">deprecated_legacy_read_with_retry</a></span>(<span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>elsif</span> <span class='id identifier rubyid_session'>session</span><span class='op'>&amp;.</span><span class='id identifier rubyid_retry_reads?'>retry_reads?</span>
    <span class='id identifier rubyid_modern_read_with_retry'><a href="#modern_read_with_retry-instance_method" title="Mongo::Retryable::ReadWorker#modern_read_with_retry (method)">modern_read_with_retry</a></span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>elsif</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_max_read_retries'>max_read_retries</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='id identifier rubyid_legacy_read_with_retry'><a href="#legacy_read_with_retry-instance_method" title="Mongo::Retryable::ReadWorker#legacy_read_with_retry (method)">legacy_read_with_retry</a></span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_read_without_retry'><a href="#read_without_retry-instance_method" title="Mongo::Retryable::ReadWorker#read_without_retry (method)">read_without_retry</a></span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_with_retry_cursor-instance_method">
  <h3 class='signature nodoc'>
    #<strong>read_with_retry_cursor</strong>(session, server_selector, view, &amp;block)  &#x21d2; <a href="../Cursor.html" title="Mongo::Cursor (class)">Cursor</a> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Execute a read operation returning a cursor with retrying.</p>

<p>This method performs server selection for the specified server selector and yields to the provided block, which should execute the initial query operation and return its result. The block will be passed the server selected for the operation. If the block raises an exception, and this exception corresponds to a read retryable error, and read retries are enabled for the client, this method will perform server selection again and yield to the block again (with potentially a different server). If the block returns successfully, the result of the block (which should be a Mongo::Operation::Result) is used to construct a <a href="../Cursor.html" title="Mongo::Cursor (class)"><code>::Mongo::Cursor</code></a> object for the result set. The cursor is then returned.</p>

<p>If modern retry reads are on (which is the default), the initial read operation will be retried once. If legacy retry reads are on, the initial read operation will be retried zero or more times depending on the <code>:max_read_retries</code> client setting, the default for which is 1. To disable read retries, turn off modern read retries by setting retry_reads: false and set <code>:max_read_retries</code> to 0 on the client.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Execute a read returning a cursor.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_cursor'>cursor</span> <span class='op'>=</span> <span class='id identifier rubyid_read_with_retry_cursor'>read_with_retry_cursor</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='id identifier rubyid_view'>view</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
  <span class='comment'># return a Mongo::Operation::Result
</span>  <span class='op'>...</span>
<span class='kw'>end</span></code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>session</span>
    <span class='type'>(<a href="../Session.html" title="Mongo::Session (class)">Mongo::Session</a>)</span>
&mdash;    <div class='inline'>
<p>The session that the operation is being run on.</p>
</div>
  </li>
  <li>
    <span class='name'>server_selector</span>
    <span class='type'>(<code>Mongo::ServerSelector::Selectable</code>)</span>
&mdash;    <div class='inline'>
<p><a href="../Server.html" title="Mongo::Server (class)"><code>::Mongo::Server</code></a> selector for the operation.</p>
</div>
  </li>
  <li>
    <span class='name'>view</span>
    <span class='type'>(<code>CollectionView</code>)</span>
&mdash;    <div class='inline'>
<p>The <code>CollectionView</code> defining the query.</p>
</div>
  </li>
  <li>
    <span class='name'>block</span>
    <span class='type'>(<code>Proc</code>)</span>
&mdash;    <div class='inline'>
<p>The block to execute.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Cursor.html" title="Mongo::Cursor (class)">Cursor</a>)</span>
&mdash;    <div class='inline'>
<p>The cursor for the result set.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/read_worker.rb#L66-L78'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='66' data-end='78'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/read_worker.rb', line 66</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_with_retry_cursor'>read_with_retry_cursor</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='id identifier rubyid_view'>view</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_read_with_retry'><a href="#read_with_retry-instance_method" title="Mongo::Retryable::ReadWorker#read_with_retry (method)">read_with_retry</a></span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='kw'>yield</span> <span class='id identifier rubyid_server'>server</span>

    <span class='comment'># RUBY-2367: This will be updated to allow the query cache to
</span>    <span class='comment'># cache cursors with multi-batch results.
</span>    <span class='kw'>if</span> <span class='const'><a href="../QueryCache.html" title="Mongo::QueryCache (module)">QueryCache</a></span>.<span class='id identifier rubyid_enabled?'><a href="../QueryCache.html#enabled%3F-class_method" title="Mongo::QueryCache.enabled? (method)">enabled?</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_view'>view</span>.<span class='id identifier rubyid_collection'>collection</span>.<span class='id identifier rubyid_system_collection?'>system_collection?</span>
      <span class='const'><a href="../CachingCursor.html" title="Mongo::CachingCursor (class)">CachingCursor</a></span>.<span class='id identifier rubyid_new'><a href="../Cursor.html#new-class_method" title="Mongo::Cursor.new (method)">new</a></span>(<span class='id identifier rubyid_view'>view</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span>)
    <span class='kw'>else</span>
      <span class='const'><a href="../Cursor.html" title="Mongo::Cursor (class)">Cursor</a></span>.<span class='id identifier rubyid_new'><a href="../Cursor.html#new-class_method" title="Mongo::Cursor.new (method)">new</a></span>(<span class='id identifier rubyid_view'>view</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_without_retry-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>read_without_retry</strong>(session, server_selector, &amp;block)  &#x21d2; <code>Result</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Attempts to do a read <strong>without</strong> a retry; for example, when retries have been explicitly disabled.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>session</span>
    <span class='type'>(<a href="../Session.html" title="Mongo::Session (class)">Mongo::Session</a>)</span>
&mdash;    <div class='inline'>
<p>The session that the operation is being run on.</p>
</div>
  </li>
  <li>
    <span class='name'>server_selector</span>
    <span class='type'>(<code>Mongo::ServerSelector::Selectable</code>)</span>
&mdash;    <div class='inline'>
<p><a href="../Server.html" title="Mongo::Server (class)"><code>::Mongo::Server</code></a> selector for the operation.</p>
</div>
  </li>
  <li>
    <span class='name'>block</span>
    <span class='type'>(<code>Proc</code>)</span>
&mdash;    <div class='inline'>
<p>The block to execute.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Result</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/read_worker.rb#L242-L251'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='242' data-end='251'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/read_worker.rb', line 242</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_without_retry'>read_without_retry</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_select_server'><a href="../Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">select_server</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)

  <span class='kw'>begin</span>
    <span class='kw'>yield</span> <span class='id identifier rubyid_server'>server</span>
  <span class='kw'>rescue</span> <span class='op'>*</span><span class='id identifier rubyid_retryable_exceptions'>retryable_exceptions</span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolError.html" title="Mongo::Error::PoolError (class)">PoolError</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>retries disabled</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="retry_read-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>retry_read</strong>(original_error, session, server_selector, failed_server: nil, &amp;block)  &#x21d2; <code>Result</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>The retry logic of the “modern” read_with_retry implementation.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>original_error</span>
    <span class='type'>(<code>Exception</code>)</span>
&mdash;    <div class='inline'>
<p>The original error that triggered the retry.</p>
</div>
  </li>
  <li>
    <span class='name'>session</span>
    <span class='type'>(<a href="../Session.html" title="Mongo::Session (class)">Mongo::Session</a>)</span>
&mdash;    <div class='inline'>
<p>The session that the operation is being run on.</p>
</div>
  </li>
  <li>
    <span class='name'>server_selector</span>
    <span class='type'>(<code>Mongo::ServerSelector::Selectable</code>)</span>
&mdash;    <div class='inline'>
<p><a href="../Server.html" title="Mongo::Server (class)"><code>::Mongo::Server</code></a> selector for the operation.</p>
</div>
  </li>
  <li>
    <span class='name'>failed_server</span>
    <span class='type'>(<a href="../Server.html" title="Mongo::Server (class)">Mongo::Server</a>)</span>
&mdash;    <div class='inline'>
<p>The server on which the original operation failed.</p>
</div>
  </li>
  <li>
    <span class='name'>block</span>
    <span class='type'>(<code>Proc</code>)</span>
&mdash;    <div class='inline'>
<p>The block to execute.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Result</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/read_worker.rb#L266-L294'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='266' data-end='294'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/read_worker.rb', line 266</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_retry_read'>retry_read</span>(<span class='id identifier rubyid_original_error'>original_error</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='label'>failed_server:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_select_server'><a href="../Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">select_server</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_failed_server'>failed_server</span>)
  <span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/AuthError.html" title="Mongo::Error::AuthError (class)">AuthError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_original_error'>original_error</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>later retry failed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_original_error'>original_error</span>
  <span class='kw'>end</span>
  
  <span class='id identifier rubyid_log_retry'>log_retry</span>(<span class='id identifier rubyid_original_error'>original_error</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Read retry</span><span class='tstring_end'>&#39;</span></span>)
  
  <span class='kw'>begin</span>
    <span class='kw'>yield</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='kw'>true</span>
  <span class='kw'>rescue</span> <span class='op'>*</span><span class='id identifier rubyid_retryable_exceptions'>retryable_exceptions</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_notes'>add_notes</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>modern retry</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>attempt 2</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolError.html" title="Mongo::Error::PoolError (class)">PoolError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>modern retry</span><span class='tstring_end'>&#39;</span></span>)
    <span class='kw'>unless</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_write_retryable?'>write_retryable?</span>
      <span class='id identifier rubyid_original_error'>original_error</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>later retry failed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_original_error'>original_error</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attempt 2</span><span class='tstring_end'>&quot;</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/AuthError.html" title="Mongo::Error::AuthError (class)">AuthError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>modern retry</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_original_error'>original_error</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>later retry failed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_original_error'>original_error</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>