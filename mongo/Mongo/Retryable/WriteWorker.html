<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Retryable::WriteWorker &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Retryable::WriteWorker",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Mongo master</a> &raquo; 
      <a href='../../_index.html#alpha_W'>Index (W)</a> &raquo; 
        <a href="../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../Retryable.html" title="Mongo::Retryable (module)">Retryable</a> &raquo; 
      <span class='title'><a class='nodoc' id='t2_doc_top' href='#'>WriteWorker&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Retryable::WriteWorker  <span class='private note title'>Private</span>
</h1>
  <div class='note nodoc inline-block'>
    <strong>Do not use.  This class is for internal use only.</strong>
  </div>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          <a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)"><code>BaseWorker</code></a>,
          Forwardable
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)"><code>BaseWorker</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2 o'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)">Mongo::Retryable::BaseWorker</a></span>
        <ul class='fullTree'>
          <li>Object</li>
          <li class='next'><a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)">Mongo::Retryable::BaseWorker</a></li>
          <li class='next'>Mongo::Retryable::WriteWorker</li>
        </ul>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L28'>lib/mongo/retryable/write_worker.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Implements the logic around retrying write operations.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 class='h2_sum' id='class_Method_summary'>Class Method Summary</h2>
<div class='div_sum'>

<h3 class='inherited nodoc'><a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)"><code>BaseWorker</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="BaseWorker.html#new-class_method" title="Mongo::Retryable::BaseWorker.new (method)">.new</a></td>
      <td><div class='inline'><p>Constructs a new worker.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_Attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>

<h3 class='inherited nodoc'><a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)"><code>BaseWorker</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro nodoc' href="BaseWorker.html#retryable-instance_method" title="Mongo::Retryable::BaseWorker#retryable (method)">#retryable</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full nodoc'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#nro_write_with_retry-instance_method" title="#nro_write_with_retry (instance method)">#<strong>nro_write_with_retry</strong>(write_concern, context:) {|connection, txn_num, context| ... } </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p><a href="../Retryable.html" title="Mongo::Retryable (module)"><code>::Mongo::Retryable</code></a> writes wrapper for operations not supporting modern retryable writes.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#retry_write_allowed%3F-instance_method" title="#retry_write_allowed? (instance method)">#<strong>retry_write_allowed?</strong>(session, write_concern)  &#x21d2; true | false </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Queries whether the session and write concern support retrying writes.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#write_with_retry-instance_method" title="#write_with_retry (instance method)">#<strong>write_with_retry</strong>(write_concern, ending_transaction: false, context:, &amp;block) {|connection, txn_num, context| ... } &#x21d2; Result </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Implements write retrying functionality by yielding to the passed block one or more times.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#ensure_labeled_retryable!-instance_method" title="#ensure_labeled_retryable! (instance method)">#<strong>ensure_labeled_retryable!</strong>(e, connection_succeeded, session)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Make sure the exception object is labeled ‘RetryableWriteError’.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#ensure_retryable!-instance_method" title="#ensure_retryable! (instance method)">#<strong>ensure_retryable!</strong>(e)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Make sure the exception object supports retryable writes.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#ensure_valid_state!-instance_method" title="#ensure_valid_state! (instance method)">#<strong>ensure_valid_state!</strong>(ending_transaction, session)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Makes sure the state of the arguments is consistent and valid.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#fail_on_operation_failure!-instance_method" title="#fail_on_operation_failure! (instance method)">#<strong>fail_on_operation_failure!</strong>(e, original_error)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Raise either e, or original_error, depending on whether e is appropriately labeled.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#fail_on_other_error!-instance_method" title="#fail_on_other_error! (instance method)">#<strong>fail_on_other_error!</strong>(e, original_error)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Raise the original error (after annotating).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#fail_on_retryable!-instance_method" title="#fail_on_retryable! (instance method)">#<strong>fail_on_retryable!</strong>(e, original_error)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Raise either e, or original_error, depending on whether e is write_retryable.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#legacy_write_with_retry-instance_method" title="#legacy_write_with_retry (instance method)">#<strong>legacy_write_with_retry</strong>(server = nil, context:) {|connection, txn_num, context| ... } </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Implements legacy write retrying functionality by yielding to the passed block one or more times.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#modern_write_with_retry-instance_method" title="#modern_write_with_retry (instance method)">#<strong>modern_write_with_retry</strong>(session, server, context) {|connection, txn_num, context| ... } &#x21d2; Result </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Implements modern write retrying functionality by yielding to the passed block no more than twice.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#raise_unsupported_error-instance_method" title="#raise_unsupported_error (instance method)">#<strong>raise_unsupported_error</strong>(e)  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Retry writes on MMAPv1 should raise an actionable error; append actionable information to the error message and preserve the backtrace.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#retry_write-instance_method" title="#retry_write (instance method)">#<strong>retry_write</strong>(original_error, txn_num, context:, failed_server: nil, &amp;block)  &#x21d2; Result </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Called after a failed write, this will retry the write no more than once.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited nodoc'><a href="BaseWorker.html" title="Mongo::Retryable::BaseWorker (class)"><code>BaseWorker</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="BaseWorker.html#deprecation_warning-instance_method" title="Mongo::Retryable::BaseWorker#deprecation_warning (method)">#deprecation_warning</a></td>
      <td><div class='inline'><p>Logs the given deprecation warning the first time it is called for a given key; after that, it does nothing when given the same key.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="BaseWorker.html#is_retryable_exception%3F-instance_method" title="Mongo::Retryable::BaseWorker#is_retryable_exception? (method)">#is_retryable_exception?</a></td>
      <td><div class='inline'><p>Tests to see if the given exception instance is of a type that can be retried.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="BaseWorker.html#log_retry-instance_method" title="Mongo::Retryable::BaseWorker#log_retry (method)">#log_retry</a></td>
      <td><div class='inline'><p>Log a warning so that any application slow down is immediately obvious.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv nodoc' href="BaseWorker.html#retryable_exceptions-instance_method" title="Mongo::Retryable::BaseWorker#retryable_exceptions (method)">#retryable_exceptions</a></td>
      <td><div class='inline'><p>Indicate which exception classes that are generally retryable.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="ensure_labeled_retryable!-instance_method">
  <h3 class='signature priv  nodoc first'>
    #<strong>ensure_labeled_retryable!</strong>(e, connection_succeeded, session)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Make sure the exception object is labeled ‘RetryableWriteError’. If it isn’t, and should not be, re-raise the exception.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L308-L320'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='308' data-end='320'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 308</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ensure_labeled_retryable!'>ensure_labeled_retryable!</span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_connection_succeeded'>connection_succeeded</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_label?'>label?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RetryableWriteError</span><span class='tstring_end'>&#39;</span></span>)
    <span class='comment'># If there was an error before the connection was successfully
</span>    <span class='comment'># checked out and connected, there was no connection present to use
</span>    <span class='comment'># for adding labels. Therefore, we should check if it is retryable,
</span>    <span class='comment'># and if it is, add the label and retry it.
</span>    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_connection_succeeded'>connection_succeeded</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_in_transaction?'>in_transaction?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_write_retryable?'>write_retryable?</span>
      <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_label'>add_label</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RetryableWriteError</span><span class='tstring_end'>&#39;</span></span>)
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ensure_retryable!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>ensure_retryable!</strong>(e)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Make sure the exception object supports retryable writes. If it does, make sure it has been appropriately labeled. If either condition fails, raise an exception.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L325-L331'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='325' data-end='331'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 325</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ensure_retryable!'>ensure_retryable!</span>(<span class='id identifier rubyid_e'>e</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_unsupported_retryable_write?'>unsupported_retryable_write?</span>
    <span class='id identifier rubyid_raise_unsupported_error'><a href="#raise_unsupported_error-instance_method" title="Mongo::Retryable::WriteWorker#raise_unsupported_error (method)">raise_unsupported_error</a></span>(<span class='id identifier rubyid_e'>e</span>)
  <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_label?'>label?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RetryableWriteError</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="ensure_valid_state!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>ensure_valid_state!</strong>(ending_transaction, session)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Makes sure the state of the arguments is consistent and valid.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>ending_transaction</span>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>True if the write operation is abortTransaction or commitTransaction, false otherwise.</p>
</div>
  </li>
  <li>
    <span class='name'>session</span>
    <span class='type'>(<code>nil</code> | <a href="../Session.html" title="Mongo::Session (class)">Mongo::Session</a>)</span>
&mdash;    <div class='inline'>
<p>The session that the operation is being run on (if any).</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L148-L152'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='148' data-end='152'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 148</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_ensure_valid_state!'>ensure_valid_state!</span>(<span class='id identifier rubyid_ending_transaction'>ending_transaction</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_ending_transaction'>ending_transaction</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_session'>session</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Cannot end a transaction without a session</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="fail_on_operation_failure!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>fail_on_operation_failure!</strong>(e, original_error)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Raise either e, or original_error, depending on whether e is appropriately labeled.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L347-L356'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='347' data-end='356'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 347</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_fail_on_operation_failure!'>fail_on_operation_failure!</span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_original_error'>original_error</span>)
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>modern retry</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_label?'>label?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RetryableWriteError</span><span class='tstring_end'>&#39;</span></span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_label?'>label?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>NoWritesPerformed</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>attempt 2</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_original_error'>original_error</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>later retry failed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_original_error'>original_error</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="fail_on_other_error!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>fail_on_other_error!</strong>(e, original_error)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Raise the original error (after annotating).</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L359-L364'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='359' data-end='364'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 359</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_fail_on_other_error!'>fail_on_other_error!</span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_original_error'>original_error</span>)
  <span class='comment'># Do not need to add &quot;modern retry&quot; here, it should already be on
</span>  <span class='comment'># the first exception.
</span>  <span class='id identifier rubyid_original_error'>original_error</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>later retry failed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_original_error'>original_error</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="fail_on_retryable!-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>fail_on_retryable!</strong>(e, original_error)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Raise either e, or original_error, depending on whether e is write_retryable.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L335-L343'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='335' data-end='343'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 335</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_fail_on_retryable!'>fail_on_retryable!</span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_original_error'>original_error</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_write_retryable?'>write_retryable?</span>
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_notes'>add_notes</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>modern retry</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>attempt 2</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_original_error'>original_error</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>later retry failed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_original_error'>original_error</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="legacy_write_with_retry-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>legacy_write_with_retry</strong>(server = nil, context:) {|connection, txn_num, context| ... }  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Implements legacy write retrying functionality by yielding to the passed block one or more times.</p>

<p>This method is used for operations which are not supported by modern retryable writes, such as delete_many and update_many.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>server</span>
    <span class='type'>(<a href="../Server.html" title="Mongo::Server (class)">Server</a>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>The server which should be used for the operation. If not provided, the current primary will be retrieved from the cluster.</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<code>Context</code>)</span>
&mdash;    <div class='inline'>
<p>The context for the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Yield Parameters:</p>
<ul class='yieldparam'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<code>Connection</code>)</span>
&mdash;    <div class='inline'>
<p>The connection through which the write should be sent.</p>
</div>
  </li>
  <li>
    <span class='name'>txn_num</span>
    <span class='type'>(<code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>nil as transaction number.</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<a href="../Operation/Context.html" title="Mongo::Operation::Context (class)">Operation::Context</a>)</span>
&mdash;    <div class='inline'>
<p>The operation context.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L171-L200'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='171' data-end='200'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 171</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_legacy_write_with_retry'>legacy_write_with_retry</span>(<span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>context:</span>)
  <span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_session'>session</span>

  <span class='comment'># This is the pre-session retry logic, and is not subject to
</span>  <span class='comment'># current retryable write specifications.
</span>  <span class='comment'># In particular it does not retry on SocketError and SocketTimeoutError.
</span>  <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='id identifier rubyid_server'>server</span> <span class='op'>||=</span> <span class='id identifier rubyid_select_server'><a href="../Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">select_server</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='const'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span>.<span class='id identifier rubyid_primary'><a href="../ServerSelector.html#primary-instance_method" title="Mongo::ServerSelector#primary (method)">primary</a></span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)
    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_with_connection'>with_connection</span>(<span class='label'>connection_global_id:</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
      <span class='comment'># Legacy retries do not use txn_num
</span>      <span class='kw'>yield</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_dup'>dup</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>legacy retry</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attempt </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_attempt'>attempt</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
    <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_max_write_retries'>max_write_retries</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_label?'>label?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RetryableWriteError</span><span class='tstring_end'>&#39;</span></span>)
      <span class='id identifier rubyid_log_retry'>log_retry</span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Legacy write retry</span><span class='tstring_end'>&#39;</span></span>)
      <span class='id identifier rubyid_cluster'>cluster</span>.<span class='id identifier rubyid_scan!'>scan!</span>(<span class='kw'>false</span>)
      <span class='kw'>retry</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="modern_write_with_retry-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>modern_write_with_retry</strong>(session, server, context) {|connection, txn_num, context| ... } &#x21d2; <code>Result</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Implements modern write retrying functionality by yielding to the passed block no more than twice.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>session</span>
    <span class='type'>(<a href="../Session.html" title="Mongo::Session (class)">Mongo::Session</a>)</span>
&mdash;    <div class='inline'>
<p>The session that the operation is being run on.</p>
</div>
  </li>
  <li>
    <span class='name'>server</span>
    <span class='type'>(<a href="../Server.html" title="Mongo::Server (class)">Server</a>)</span>
&mdash;    <div class='inline'>
<p>The server which should be used for the operation.</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<a href="../Operation/Context.html" title="Mongo::Operation::Context (class)">Operation::Context</a>)</span>
&mdash;    <div class='inline'>
<p>The context for the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Yield Parameters:</p>
<ul class='yieldparam'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<code>Connection</code>)</span>
&mdash;    <div class='inline'>
<p>The connection through which the write should be sent.</p>
</div>
  </li>
  <li>
    <span class='name'>txn_num</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>Transaction number (NOT the ACID kind).</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<a href="../Operation/Context.html" title="Mongo::Operation::Context (class)">Operation::Context</a>)</span>
&mdash;    <div class='inline'>
<p>The operation context.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Result</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L219-L245'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='219' data-end='245'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 219</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_modern_write_with_retry'>modern_write_with_retry</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_connection_succeeded'>connection_succeeded</span> <span class='op'>=</span> <span class='kw'>false</span>
  
  <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_with_connection'>with_connection</span>(<span class='label'>connection_global_id:</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
    <span class='id identifier rubyid_connection_succeeded'>connection_succeeded</span> <span class='op'>=</span> <span class='kw'>true</span>

    <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_materialize_if_needed'>materialize_if_needed</span>
    <span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_in_transaction?'>in_transaction?</span> <span class='op'>?</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>:</span> <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_next_txn_num'>next_txn_num</span>

    <span class='comment'># The context needs to be duplicated here because we will be using
</span>    <span class='comment'># it later for the retry as well.
</span>    <span class='kw'>yield</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='op'>*</span><span class='id identifier rubyid_retryable_exceptions'>retryable_exceptions</span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolError.html" title="Mongo::Error::PoolError (class)">PoolError</a></span><span class='comma'>,</span> <span class='const'><a href="../Auth.html" title="Mongo::Auth (module)">Auth</a></span><span class='op'>::</span><span class='const'><a href="../Auth/Unauthorized.html" title="Mongo::Auth::Unauthorized (class)">Unauthorized</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_notes'>add_notes</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>modern retry</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>attempt 1</span><span class='tstring_end'>&#39;</span></span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span>)
    <span class='id identifier rubyid_ensure_retryable!'><a href="#ensure_retryable!-instance_method" title="Mongo::Retryable::WriteWorker#ensure_retryable! (method)">ensure_retryable!</a></span>(<span class='id identifier rubyid_e'>e</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_ensure_labeled_retryable!'><a href="#ensure_labeled_retryable!-instance_method" title="Mongo::Retryable::WriteWorker#ensure_labeled_retryable! (method)">ensure_labeled_retryable!</a></span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_connection_succeeded'>connection_succeeded</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)
  <span class='kw'>end</span>

  <span class='comment'># Context#with creates a new context, which is not necessary here
</span>  <span class='comment'># but the API is less prone to misuse this way.
</span>  <span class='id identifier rubyid_retry_write'><a href="#retry_write-instance_method" title="Mongo::Retryable::WriteWorker#retry_write (method)">retry_write</a></span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>is_retry:</span> <span class='kw'>true</span>)<span class='comma'>,</span> <span class='label'>failed_server:</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="nro_write_with_retry-instance_method">
  <h3 class='signature nodoc'>
    #<strong>nro_write_with_retry</strong>(write_concern, context:) {|connection, txn_num, context| ... } 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p><a href="../Retryable.html" title="Mongo::Retryable (module)"><code>::Mongo::Retryable</code></a> writes wrapper for operations not supporting modern retryable writes.</p>

<p>If the driver is configured to use modern retryable writes, this method yields to the passed block exactly once, thus not retrying any writes.</p>

<p>If the driver is configured to use legacy retryable writes, this method delegates to legacy_write_with_retry which performs write retries using legacy logic.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>write_concern</span>
    <span class='type'>(<code>nil</code> | <code>Hash</code> | <a href="../WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">WriteConcern::Base</a>)</span>
&mdash;    <div class='inline'>
<p>The write concern.</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<code>Context</code>)</span>
&mdash;    <div class='inline'>
<p>The context for the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Yield Parameters:</p>
<ul class='yieldparam'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<code>Connection</code>)</span>
&mdash;    <div class='inline'>
<p>The connection through which the write should be sent.</p>
</div>
  </li>
  <li>
    <span class='name'>txn_num</span>
    <span class='type'>(<code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>nil as transaction number.</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<a href="../Operation/Context.html" title="Mongo::Operation::Context (class)">Operation::Context</a>)</span>
&mdash;    <div class='inline'>
<p>The operation context.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L103-L120'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='103' data-end='120'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 103</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_nro_write_with_retry'>nro_write_with_retry</span>(<span class='id identifier rubyid_write_concern'>write_concern</span><span class='comma'>,</span> <span class='label'>context:</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_session'>session</span>
  <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_select_server'><a href="../Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">select_server</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='const'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span>.<span class='id identifier rubyid_primary'><a href="../ServerSelector.html#primary-instance_method" title="Mongo::ServerSelector#primary (method)">primary</a></span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)
  <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span><span class='op'>&amp;.</span><span class='id identifier rubyid_client'>client</span><span class='op'>&amp;.</span><span class='id identifier rubyid_options'>options</span> <span class='op'>||</span> {}
  
  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_retry_writes'>retry_writes</span>]
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_with_connection'>with_connection</span>(<span class='label'>connection_global_id:</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
        <span class='kw'>yield</span> <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>
      <span class='kw'>end</span>
    <span class='kw'>rescue</span> <span class='op'>*</span><span class='id identifier rubyid_retryable_exceptions'>retryable_exceptions</span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolError.html" title="Mongo::Error::PoolError (class)">PoolError</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>retries disabled</span><span class='tstring_end'>&#39;</span></span>)
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_legacy_write_with_retry'><a href="#legacy_write_with_retry-instance_method" title="Mongo::Retryable::WriteWorker#legacy_write_with_retry (method)">legacy_write_with_retry</a></span>(<span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="raise_unsupported_error-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>raise_unsupported_error</strong>(e)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Retry writes on MMAPv1 should raise an actionable error; append actionable information to the error message and preserve the backtrace.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L298-L304'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='298' data-end='304'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 298</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_raise_unsupported_error'>raise_unsupported_error</span>(<span class='id identifier rubyid_e'>e</span>)
  <span class='id identifier rubyid_new_error'>new_error</span> <span class='op'>=</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span>.<span class='id identifier rubyid_new'><a href="../Error/OperationFailure.html#new-class_method" title="Mongo::Error::OperationFailure.new (method)">new</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span>\
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This MongoDB deployment does not support retryable writes. Please add </span><span class='tstring_end'>&quot;</span></span>\
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>retryWrites=false to your connection string or use the retry_writes: false Ruby client option</span><span class='tstring_end'>&quot;</span></span>)
  <span class='id identifier rubyid_new_error'>new_error</span>.<span class='id identifier rubyid_set_backtrace'>set_backtrace</span>(<span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_backtrace'>backtrace</span>)
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_new_error'>new_error</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="retry_write-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>retry_write</strong>(original_error, txn_num, context:, failed_server: nil, &amp;block)  &#x21d2; <code>Result</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Called after a failed write, this will retry the write no more than once.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>original_error</span>
    <span class='type'>(<code>Exception</code>)</span>
&mdash;    <div class='inline'>
<p>The exception that triggered the retry.</p>
</div>
  </li>
  <li>
    <span class='name'>txn_num</span>
    <span class='type'>(<code>Number</code>)</span>
&mdash;    <div class='inline'>
<p>The transaction number.</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<a href="../Operation/Context.html" title="Mongo::Operation::Context (class)">Operation::Context</a>)</span>
&mdash;    <div class='inline'>
<p>The context for the operation.</p>
</div>
  </li>
  <li>
    <span class='name'>failed_server</span>
    <span class='type'>(<a href="../Server.html" title="Mongo::Server (class)">Mongo::Server</a>)</span>
&mdash;    <div class='inline'>
<p>The server on which the original operation failed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Result</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L258-L294'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='258' data-end='294'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 258</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_retry_write'>retry_write</span>(<span class='id identifier rubyid_original_error'>original_error</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span> <span class='label'>context:</span><span class='comma'>,</span> <span class='label'>failed_server:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_session'>session</span>

  <span class='comment'># We do not request a scan of the cluster here, because error handling
</span>  <span class='comment'># for the error which triggered the retry should have updated the
</span>  <span class='comment'># server description and/or topology as necessary (specifically,
</span>  <span class='comment'># a socket error or a not master error should have marked the respective
</span>  <span class='comment'># server unknown). Here we just need to wait for server selection.
</span>  <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_select_server'><a href="../Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">select_server</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='const'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span>.<span class='id identifier rubyid_primary'><a href="../ServerSelector.html#primary-instance_method" title="Mongo::ServerSelector#primary (method)">primary</a></span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_failed_server'>failed_server</span>)
  
  <span class='kw'>unless</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_retry_writes?'>retry_writes?</span>
    <span class='comment'># Do not need to add &quot;modern retry&quot; here, it should already be on
</span>    <span class='comment'># the first exception.
</span>    <span class='id identifier rubyid_original_error'>original_error</span>.<span class='id identifier rubyid_add_note'>add_note</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>did not retry because server selected for retry does not support retryable writes</span><span class='tstring_end'>&#39;</span></span>)

    <span class='comment'># When we want to raise the original error, we must not run the
</span>    <span class='comment'># rescue blocks below that add diagnostics because the diagnostics
</span>    <span class='comment'># added would either be rendundant (e.g. modern retry note) or wrong
</span>    <span class='comment'># (e.g. &quot;attempt 2&quot;, we are raising the exception produced in the
</span>    <span class='comment'># first attempt and haven&#39;t attempted the second time). Use the
</span>    <span class='comment'># special marker class to bypass the ordinarily applicable rescues.
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/RaiseOriginalError.html" title="Mongo::Error::RaiseOriginalError (class)">RaiseOriginalError</a></span>
  <span class='kw'>end</span>
  
  <span class='id identifier rubyid_log_retry'>log_retry</span>(<span class='id identifier rubyid_original_error'>original_error</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Write retry</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_with_connection'>with_connection</span>(<span class='label'>connection_global_id:</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_connection_global_id'>connection_global_id</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
    <span class='kw'>yield</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)
  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='op'>*</span><span class='id identifier rubyid_retryable_exceptions'>retryable_exceptions</span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/PoolError.html" title="Mongo::Error::PoolError (class)">PoolError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_fail_on_retryable!'><a href="#fail_on_retryable!-instance_method" title="Mongo::Retryable::WriteWorker#fail_on_retryable! (method)">fail_on_retryable!</a></span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_original_error'>original_error</span>)
<span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_fail_on_operation_failure!'><a href="#fail_on_operation_failure!-instance_method" title="Mongo::Retryable::WriteWorker#fail_on_operation_failure! (method)">fail_on_operation_failure!</a></span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_original_error'>original_error</span>)
<span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='comma'>,</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/AuthError.html" title="Mongo::Error::AuthError (class)">AuthError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_fail_on_other_error!'><a href="#fail_on_other_error!-instance_method" title="Mongo::Retryable::WriteWorker#fail_on_other_error! (method)">fail_on_other_error!</a></span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_original_error'>original_error</span>)
<span class='kw'>rescue</span> <span class='const'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../Error/RaiseOriginalError.html" title="Mongo::Error::RaiseOriginalError (class)">RaiseOriginalError</a></span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_original_error'>original_error</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="retry_write_allowed?-instance_method">
  <h3 class='signature nodoc'>
    #<strong>retry_write_allowed?</strong>(session, write_concern)  &#x21d2; <code>true</code> | <code>false</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Queries whether the session and write concern support retrying writes.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>session</span>
    <span class='type'>(<a href="../Session.html" title="Mongo::Session (class)">Mongo::Session</a>)</span>
&mdash;    <div class='inline'>
<p>The session that the operation is being run on.</p>
</div>
  </li>
  <li>
    <span class='name'>write_concern</span>
    <span class='type'>(<code>nil</code> | <code>Hash</code> | <a href="../WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">WriteConcern::Base</a>)</span>
&mdash;    <div class='inline'>
<p>The write concern.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>Whether write retries are allowed or not.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.19.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L130-L138'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='130' data-end='138'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 130</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_retry_write_allowed?'>retry_write_allowed?</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_write_concern'>write_concern</span>)
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='id identifier rubyid_session'>session</span><span class='op'>&amp;.</span><span class='id identifier rubyid_retry_writes?'>retry_writes?</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_write_concern'>write_concern</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>true</span>
  <span class='kw'>else</span>
    <span class='const'><a href="../WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span>.<span class='id identifier rubyid_get'><a href="../WriteConcern.html#get-instance_method" title="Mongo::WriteConcern#get (method)">get</a></span>(<span class='id identifier rubyid_write_concern'>write_concern</span>).<span class='id identifier rubyid_acknowledged?'>acknowledged?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="write_with_retry-instance_method">
  <h3 class='signature nodoc'>
    #<strong>write_with_retry</strong>(write_concern, ending_transaction: false, context:, &amp;block) {|connection, txn_num, context| ... } &#x21d2; <code>Result</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>This only retries operations on not master failures, since it is the only case we can be sure a partial write did not already occur.</p>
</div>
  </div>


<p>Implements write retrying functionality by yielding to the passed block one or more times.</p>

<p>If the session is provided (hence, the deployment supports sessions), and modern retry writes are enabled on the client, the modern retry logic is invoked. Otherwise the legacy retry logic is invoked.</p>

<p>If ending_transaction parameter is true, indicating that a transaction is being committed or aborted, the operation is executed exactly once. Note that, since transactions require sessions, this method will raise ArgumentError if ending_transaction is true and session is nil.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Execute the write.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_write_with_retry'>write_with_retry</span> <span class='kw'>do</span>
  <span class='op'>...</span>
<span class='kw'>end</span></code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>write_concern</span>
    <span class='type'>(<code>nil</code> | <code>Hash</code> | <a href="../WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">WriteConcern::Base</a>)</span>
&mdash;    <div class='inline'>
<p>The write concern.</p>
</div>
  </li>
  <li>
    <span class='name'>ending_transaction</span>
    <span class='type'>(<code>true</code> | <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>True if the write operation is abortTransaction or commitTransaction, false otherwise.</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<code>Context</code>)</span>
&mdash;    <div class='inline'>
<p>The context for the operation.</p>
</div>
  </li>
  <li>
    <span class='name'>block</span>
    <span class='type'>(<code>Proc</code>)</span>
&mdash;    <div class='inline'>
<p>The block to execute.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Yield Parameters:</p>
<ul class='yieldparam'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<code>Connection</code>)</span>
&mdash;    <div class='inline'>
<p>The connection through which the write should be sent.</p>
</div>
  </li>
  <li>
    <span class='name'>txn_num</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'>
<p>Transaction number (NOT the ACID kind).</p>
</div>
  </li>
  <li>
    <span class='name'>context</span>
    <span class='type'>(<a href="../Operation/Context.html" title="Mongo::Operation::Context (class)">Operation::Context</a>)</span>
&mdash;    <div class='inline'>
<p>The operation context.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Result</code>)</span>
&mdash;    <div class='inline'>
<p>The result of the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.1.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/retryable/write_worker.rb#L65-L84'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='65' data-end='84'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/retryable/write_worker.rb', line 65</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_write_with_retry'>write_with_retry</span>(<span class='id identifier rubyid_write_concern'>write_concern</span><span class='comma'>,</span> <span class='label'>ending_transaction:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>context:</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_session'>session</span>

  <span class='id identifier rubyid_ensure_valid_state!'><a href="#ensure_valid_state!-instance_method" title="Mongo::Retryable::WriteWorker#ensure_valid_state! (method)">ensure_valid_state!</a></span>(<span class='id identifier rubyid_ending_transaction'>ending_transaction</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)

  <span class='kw'>unless</span> <span class='id identifier rubyid_ending_transaction'>ending_transaction</span> <span class='op'>||</span> <span class='id identifier rubyid_retry_write_allowed?'><a href="#retry_write_allowed%3F-instance_method" title="Mongo::Retryable::WriteWorker#retry_write_allowed? (method)">retry_write_allowed?</a></span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_write_concern'>write_concern</span>)
    <span class='kw'>return</span> <span class='id identifier rubyid_legacy_write_with_retry'><a href="#legacy_write_with_retry-instance_method" title="Mongo::Retryable::WriteWorker#legacy_write_with_retry (method)">legacy_write_with_retry</a></span>(<span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>end</span>

  <span class='comment'># If we are here, session is not nil. A session being nil would have
</span>  <span class='comment'># failed retry_write_allowed? check.
</span>
  <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_select_server'><a href="../Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">select_server</a></span>(<span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='const'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span>.<span class='id identifier rubyid_primary'><a href="../ServerSelector.html#primary-instance_method" title="Mongo::ServerSelector#primary (method)">primary</a></span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span>)

  <span class='kw'>unless</span> <span class='id identifier rubyid_ending_transaction'>ending_transaction</span> <span class='op'>||</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_retry_writes?'>retry_writes?</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_legacy_write_with_retry'><a href="#legacy_write_with_retry-instance_method" title="Mongo::Retryable::WriteWorker#legacy_write_with_retry (method)">legacy_write_with_retry</a></span>(<span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_modern_write_with_retry'><a href="#modern_write_with_retry-instance_method" title="Mongo::Retryable::WriteWorker#modern_write_with_retry (method)">modern_write_with_retry</a></span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>