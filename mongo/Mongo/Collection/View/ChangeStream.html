<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Collection::View::ChangeStream &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Collection::View::ChangeStream",
    relpath = '../../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../../'>Mongo master</a> &raquo; 
      <a href='../../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../../Collection.html" title="Mongo::Collection (class)">Collection</a> &raquo; 
        <a href="../View.html" title="Mongo::Collection::View (class)">View</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ChangeStream&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Collection::View::ChangeStream</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Modules:</div>
      <div class='box_11'>
          <a href="ChangeStream/Retryable.html" title="Mongo::Collection::View::ChangeStream::Retryable (module)"><code>Retryable</code></a>      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          <a href="Aggregation.html" title="Mongo::Collection::View::Aggregation (class)"><code>Aggregation</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="Aggregation.html" title="Mongo::Collection::View::Aggregation (class)"><code>Aggregation</code></a>,
          <a href="Aggregation/Behavior.html" title="Mongo::Collection::View::Aggregation::Behavior (module)"><code>Aggregation::Behavior</code></a>,
          <a href="../../Retryable.html" title="Mongo::Retryable (module)"><code>::Mongo::Retryable</code></a>,
          <a href="../../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a>,
          <a href="Explainable.html" title="Mongo::Collection::View::Explainable (module)"><code>Explainable</code></a>,
          <a href="Iterable.html" title="Mongo::Collection::View::Iterable (module)"><code>Iterable</code></a>,
          <a href="../../CursorHost.html" title="Mongo::CursorHost (module)"><code>::Mongo::CursorHost</code></a>,
          <a href="Immutable.html" title="Mongo::Collection::View::Immutable (module)"><code>Immutable</code></a>,
          Enumerable
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2 o'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="Aggregation.html" title="Mongo::Collection::View::Aggregation (class)">Mongo::Collection::View::Aggregation</a></span>
        <ul class='fullTree'>
          <li>Object</li>
          <li class='next'><a href="Aggregation.html" title="Mongo::Collection::View::Aggregation (class)">Mongo::Collection::View::Aggregation</a></li>
          <li class='next'>Mongo::Collection::View::ChangeStream</li>
        </ul>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2 o'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L39'>lib/mongo/collection/view/change_stream.rb</a><span class='defines'>,<br /><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream/retryable.rb#L21'>lib/mongo/collection/view/change_stream/retryable.rb</a></span>
      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Only available in server versions 3.6 and higher.</p>
</div>
  </div>

  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>ChangeStreams do not work properly with JRuby because of the issue documented here: <a href="https://github.com/jruby/jruby/issues/4212">github.com/jruby/jruby/issues/4212</a>. Namely, JRuby eagerly evaluates #next on an Enumerator in a background green thread, therefore calling #next on the change stream will cause getMores to be called in a loop in the background.</p>
</div>
  </div>


<p>Provides behavior around a <code>$changeStream</code> pipeline stage in the aggregation framework. Specifying this stage allows users to request that notifications are sent for all changes to a particular collection or database.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='CLUSTER-constant' class='summary_signature'>CLUSTER =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../../../Symbol.html" title="Symbol (class)">Symbol</a>)</span>
&mdash;    <div class='inline'>
<p>Used to indicate that the change stream should listen for changes on the entire cluster rather than just the collection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L58-L58'># File 'lib/mongo/collection/view/change_stream.rb', line 58</a>    <pre class='code ruby'><span class='symbeg'>:</span><span class='id identifier rubyid_cluster'>cluster</span></pre>
  </li>
  <li>
    <span id='DATABASE-constant' class='summary_signature'>DATABASE =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../../../Symbol.html" title="Symbol (class)">Symbol</a>)</span>
&mdash;    <div class='inline'>
<p>Used to indicate that the change stream should listen for changes on the entire database rather than just the collection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L52-L52'># File 'lib/mongo/collection/view/change_stream.rb', line 52</a>    <pre class='code ruby'><span class='symbeg'>:</span><span class='id identifier rubyid_database'><a href="../../Collection.html#database-instance_method" title="Mongo::Collection#database (method)">database</a></span></pre>
  </li>
  <li>
    <span id='FULL_DOCUMENT_DEFAULT-constant' class='summary_signature'>FULL_DOCUMENT_DEFAULT =</span>
    <div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>The fullDocument option default value.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
    <a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L46-L46'># File 'lib/mongo/collection/view/change_stream.rb', line 46</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>default</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span></pre>
  </li>
</ul>
  <h3 class='inherited'><a href="Explainable.html" title="Mongo::Collection::View::Explainable (module)"><code>Explainable</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="Explainable.html#ALL_PLANS_EXECUTION-constant" title="Mongo::Collection::View::Explainable::ALL_PLANS_EXECUTION (constant)">ALL_PLANS_EXECUTION</a>, 
    <a href="Explainable.html#EXECUTION_STATS-constant" title="Mongo::Collection::View::Explainable::EXECUTION_STATS (constant)">EXECUTION_STATS</a>, 
    <a href="Explainable.html#QUERY_PLANNER-constant" title="Mongo::Collection::View::Explainable::QUERY_PLANNER (constant)">QUERY_PLANNER</a>
  </p>
  <h3 class='inherited'><a href="../../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="../../Loggable.html#PREFIX-constant" title="Mongo::Loggable::PREFIX (constant)">PREFIX</a>
  </p>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(view, pipeline, changes_for, options = {})  &#x21d2; ChangeStream </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Initialize the change stream for the provided collection view, pipeline and options.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited'><a href="Aggregation.html" title="Mongo::Collection::View::Aggregation (class)"><code>Aggregation</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Aggregation.html#new-class_method" title="Mongo::Collection::View::Aggregation.new (method)">.new</a></td>
      <td><div class='inline'><p>Initialize the aggregation for the provided collection view, pipeline and options.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#closed%3F-instance_method" title="#closed? (instance method)">#<strong>closed?</strong>  &#x21d2; true, false </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>Is the change stream closed?</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#cursor-instance_method" title="#cursor (instance method)">#<strong>cursor</strong>  &#x21d2; Cursor </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#options-instance_method" title="#options (instance method)">#<strong>options</strong>  &#x21d2; BSON::Document </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#for_cluster%3F-instance_method" title="#for_cluster? (instance method)">#<strong>for_cluster?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#for_collection%3F-instance_method" title="#for_collection? (instance method)">#<strong>for_collection?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#for_database%3F-instance_method" title="#for_database? (instance method)">#<strong>for_database?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#resuming%3F-instance_method" title="#resuming? (instance method)">#<strong>resuming?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
</ul>

<h3 class='inherited'><a href="Aggregation.html" title="Mongo::Collection::View::Aggregation (class)"><code>Aggregation</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="Aggregation.html#pipeline-instance_method" title="Mongo::Collection::View::Aggregation#pipeline (method)">#pipeline</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Aggregation/Behavior.html" title="Mongo::Collection::View::Aggregation::Behavior (module)"><code>Aggregation::Behavior</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="Aggregation/Behavior.html#view-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#view (method)">#view</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ro nodoc' href="Aggregation/Behavior.html#write%3F-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#write? (method)">#write?</a></td>
      <td><div class='inline'><p>Whether this aggregation will write its result to a database collection.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Explainable.html" title="Mongo::Collection::View::Explainable (module)"><code>Explainable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro priv' href="Explainable.html#explained%3F-instance_method" title="Mongo::Collection::View::Explainable#explained? (method)">#explained?</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Iterable.html" title="Mongo::Collection::View::Iterable (module)"><code>Iterable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ro priv' href="Iterable.html#prefer_cached_cursor%3F-instance_method" title="Mongo::Collection::View::Iterable#prefer_cached_cursor? (method)">#prefer_cached_cursor?</a></td>
      <td><div class='inline'><p>If the caching cursor is closed and was not fully iterated, the documents we have in it are not the complete result set and we have no way of completing that iteration.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ro priv' href="Iterable.html#use_query_cache%3F-instance_method" title="Mongo::Collection::View::Iterable#use_query_cache? (method)">#use_query_cache?</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../../CursorHost.html" title="Mongo::CursorHost (module)"><code>::Mongo::CursorHost</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ro nodoc' href="../../CursorHost.html#cursor-instance_method" title="Mongo::CursorHost#cursor (method)">#cursor</a></td>
      <td><div class='inline'><p>Returns the cursor associated with this view, if any.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="../../CursorHost.html#timeout_mode-instance_method" title="Mongo::CursorHost#timeout_mode (method)">#timeout_mode</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Immutable.html" title="Mongo::Collection::View::Immutable (module)"><code>Immutable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="Immutable.html#options-instance_method" title="Mongo::Collection::View::Immutable#options (method)">#options</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#close-instance_method" title="#close (instance method)">#<strong>close</strong>(opts = {})  &#x21d2; nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Close the change stream.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#cursor_type-instance_method" title="#cursor_type (instance method)">#<strong>cursor_type</strong>  &#x21d2; Object </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>“change streams are an abstraction around tailable-awaitData cursors…”.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#each-instance_method" title="#each (instance method)">#<strong>each</strong> {|Each| ... } &#x21d2; Enumerator </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Iterate through documents returned by the change stream.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#inspect-instance_method" title="#inspect (instance method)">#<strong>inspect</strong>  &#x21d2; String </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Get a formatted string for use in inspection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#max_await_time_ms-instance_method" title="#max_await_time_ms (instance method)">#<strong>max_await_time_ms</strong>  &#x21d2; Integer | nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the value of the max_await_time_ms option that was passed to this change stream.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#resume_token-instance_method" title="#resume_token (instance method)">#<strong>resume_token</strong>  &#x21d2; BSON::Document | nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the resume token that the stream will use to automatically resume, if one exists.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#timeout_mode-instance_method" title="#timeout_mode (instance method)">#<strong>timeout_mode</strong>  &#x21d2; Object </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>“change streams…implicitly use ITERATION mode”.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#to_enum-instance_method" title="#to_enum (instance method)">#<strong>to_enum</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#try_next-instance_method" title="#try_next (instance method)">#<strong>try_next</strong>  &#x21d2; BSON::Document | nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Return one document from the change stream, if one is available.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#aggregate_spec-instance_method" title="#aggregate_spec (instance method)">#<strong>aggregate_spec</strong>(session, read_preference)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#change_doc-instance_method" title="#change_doc (instance method)">#<strong>change_doc</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#create_cursor!-instance_method" title="#create_cursor! (instance method)">#<strong>create_cursor!</strong>(timeout_ms = nil)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#pipeline-instance_method" title="#pipeline (instance method)">#<strong>pipeline</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#recreate_cursor!-instance_method" title="#recreate_cursor! (instance method)">#<strong>recreate_cursor!</strong>(context = nil)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Recreates the current cursor (typically as a consequence of attempting to resume the change stream).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#send_initial_query-instance_method" title="#send_initial_query (instance method)">#<strong>send_initial_query</strong>(connection, context)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#time_to_bson_timestamp-instance_method" title="#time_to_bson_timestamp (instance method)">#<strong>time_to_bson_timestamp</strong>(time)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>

<h3 class='inherited'><a href="Aggregation.html" title="Mongo::Collection::View::Aggregation (class)"><code>Aggregation</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Aggregation.html#effective_read_preference-instance_method" title="Mongo::Collection::View::Aggregation#effective_read_preference (method)">#effective_read_preference</a></td>
      <td><div class='inline'><p>Return effective read preference for the operation.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Aggregation.html#initial_query_op-instance_method" title="Mongo::Collection::View::Aggregation#initial_query_op (method)">#initial_query_op</a>,
        <a class='i_m priv' href="Aggregation.html#new-instance_method" title="Mongo::Collection::View::Aggregation#new (method)">#new</a>,
        <a class='i_m priv' href="Aggregation.html#send_initial_query-instance_method" title="Mongo::Collection::View::Aggregation#send_initial_query (method)">#send_initial_query</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Aggregation/Behavior.html" title="Mongo::Collection::View::Aggregation::Behavior (module)"><code>Aggregation::Behavior</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Aggregation/Behavior.html#allow_disk_use-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#allow_disk_use (method)">#allow_disk_use</a></td>
      <td><div class='inline'><p>Set to true if disk usage is allowed during the aggregation.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Aggregation/Behavior.html#explain-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#explain (method)">#explain</a></td>
      <td><div class='inline'><p>Get the explain plan for the aggregation.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m nodoc' href="Aggregation/Behavior.html#timeout_ms-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#timeout_ms (method)">#timeout_ms</a>,
        <a class='i_m priv' href="Aggregation/Behavior.html#aggregate_spec-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#aggregate_spec (method)">#aggregate_spec</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Aggregation/Behavior.html#cache_options-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#cache_options (method)">#cache_options</a></td>
      <td><div class='inline'><p>Skip, sort, limit, projection are specified as pipeline stages rather than as options.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv nodoc' href="Aggregation/Behavior.html#operation_timeouts-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#operation_timeouts (method)">#operation_timeouts</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Aggregation/Behavior.html#perform_setup-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#perform_setup (method)">#perform_setup</a></td>
      <td><div class='inline'><p>Common setup for all classes that include this behavior; the constructor should invoke this method.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Aggregation/Behavior.html#server_selector-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#server_selector (method)">#server_selector</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../../Retryable.html" title="Mongo::Retryable (module)"><code>::Mongo::Retryable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="../../Retryable.html#read_worker-instance_method" title="Mongo::Retryable#read_worker (method)">#read_worker</a></td>
      <td><div class='inline'><p>Returns the read worker for handling retryable reads.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="../../Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">#select_server</a></td>
      <td><div class='inline'><p>This is a separate method to make it possible for the test suite to assert that server selection is performed during retry attempts.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="../../Retryable.html#write_worker-instance_method" title="Mongo::Retryable#write_worker (method)">#write_worker</a></td>
      <td><div class='inline'><p>Returns the write worker for handling retryable writes.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#log_debug-instance_method" title="Mongo::Loggable#log_debug (method)">#log_debug</a></td>
      <td><div class='inline'><p>Convenience method to log debug messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#log_error-instance_method" title="Mongo::Loggable#log_error (method)">#log_error</a></td>
      <td><div class='inline'><p>Convenience method to log error messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#log_fatal-instance_method" title="Mongo::Loggable#log_fatal (method)">#log_fatal</a></td>
      <td><div class='inline'><p>Convenience method to log fatal messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#log_info-instance_method" title="Mongo::Loggable#log_info (method)">#log_info</a></td>
      <td><div class='inline'><p>Convenience method to log info messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#log_warn-instance_method" title="Mongo::Loggable#log_warn (method)">#log_warn</a></td>
      <td><div class='inline'><p>Convenience method to log warn messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#logger-instance_method" title="Mongo::Loggable#logger (method)">#logger</a></td>
      <td><div class='inline'><p>Get the logger instance.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="../../Loggable.html#_mongo_log_prefix-instance_method" title="Mongo::Loggable#_mongo_log_prefix (method)">#_mongo_log_prefix</a>,
        <a class='i_m priv' href="../../Loggable.html#format_message-instance_method" title="Mongo::Loggable#format_message (method)">#format_message</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Explainable.html" title="Mongo::Collection::View::Explainable (module)"><code>Explainable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Explainable.html#explain-instance_method" title="Mongo::Collection::View::Explainable#explain (method)">#explain</a></td>
      <td><div class='inline'><p>Get the query plan for the query.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Explainable.html#explain_options-instance_method" title="Mongo::Collection::View::Explainable#explain_options (method)">#explain_options</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Iterable.html" title="Mongo::Collection::View::Iterable (module)"><code>Iterable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Iterable.html#close_query-instance_method" title="Mongo::Collection::View::Iterable#close_query (method)">#close_query</a></td>
      <td><div class='inline'><p>Cleans up resources associated with this query.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Iterable.html#each-instance_method" title="Mongo::Collection::View::Iterable#each (method)">#each</a></td>
      <td><div class='inline'><p>Iterate through documents returned by a query with this <a href="../View.html" title="Mongo::Collection::View (class)"><code>::Mongo::Collection::View</code></a>.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Iterable.html#kill_cursors-instance_method" title="Mongo::Collection::View::Iterable#kill_cursors (method)">#kill_cursors</a></td>
      <td><div class='inline'><p>Alias for <a href="Iterable.html#close_query-instance_method" title="Mongo::Collection::View::Iterable#close_query (method)">Iterable#close_query</a>.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Iterable.html#cache_options-instance_method" title="Mongo::Collection::View::Iterable#cache_options (method)">#cache_options</a>,
        <a class='i_m priv' href="Iterable.html#cached_cursor-instance_method" title="Mongo::Collection::View::Iterable#cached_cursor (method)">#cached_cursor</a>,
        <a class='i_m priv' href="Iterable.html#compute_limit_for_cached_query-instance_method" title="Mongo::Collection::View::Iterable#compute_limit_for_cached_query (method)">#compute_limit_for_cached_query</a>,
        <a class='i_m priv' href="Iterable.html#initial_query_op-instance_method" title="Mongo::Collection::View::Iterable#initial_query_op (method)">#initial_query_op</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Iterable.html#maybe_set_tailable_options-instance_method" title="Mongo::Collection::View::Iterable#maybe_set_tailable_options (method)">#maybe_set_tailable_options</a></td>
      <td><div class='inline'><p>Add tailable cusror options to the command specifiction if needed.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Iterable.html#new_cursor_for_iteration-instance_method" title="Mongo::Collection::View::Iterable#new_cursor_for_iteration (method)">#new_cursor_for_iteration</a></td>
      <td><div class='inline'><p>Start a new cursor for use when iterating (via #each).</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Iterable.html#oplog_replay-instance_method" title="Mongo::Collection::View::Iterable#oplog_replay (method)">#oplog_replay</a>,
        <a class='i_m priv' href="Iterable.html#select_cursor-instance_method" title="Mongo::Collection::View::Iterable#select_cursor (method)">#select_cursor</a>,
        <a class='i_m priv' href="Iterable.html#send_initial_query-instance_method" title="Mongo::Collection::View::Iterable#send_initial_query (method)">#send_initial_query</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../../CursorHost.html" title="Mongo::CursorHost (module)"><code>::Mongo::CursorHost</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="../../CursorHost.html#validate_timeout_mode!-instance_method" title="Mongo::CursorHost#validate_timeout_mode! (method)">#validate_timeout_mode!</a></td>
      <td><div class='inline'><p>Ensure the timeout mode is appropriate for other options that have been given.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Immutable.html" title="Mongo::Collection::View::Immutable (module)"><code>Immutable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Immutable.html#configure-instance_method" title="Mongo::Collection::View::Immutable#configure (method)">#configure</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(view, pipeline, changes_for, options = {})  &#x21d2; <code>ChangeStream</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Initialize the change stream for the provided collection view, pipeline and options.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Create the new change stream view.</p>
</div></p>
      <pre class='example code ruby'><code><span class='const'>ChangeStream</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span><span class='comma'>,</span> <span class='id identifier rubyid_pipeline'><a href="#pipeline-instance_method" title="Mongo::Collection::View::ChangeStream#pipeline (method)">pipeline</a></span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Collection::View::ChangeStream#options (method)">options</a></span>)</code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>view</span>
    <span class='type'>(<a href="../View.html" title="Mongo::Collection::View (class)">Collection::View</a>)</span>
&mdash;    <div class='inline'>
<p>The collection view.</p>
</div>
  </li>
  <li>
    <span class='name'>pipeline</span>
    <span class='type'>(<code>Array</code>&lt;<code>Hash</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The pipeline of operators to filter the change notifications.</p>
</div>
  </li>
  <li>
    <span class='name'>options</span>
    <span class='type'>(<code>Hash</code>)</span>
    <em class='default'>(defaults to: <tt>{}</tt>)</em>
&mdash;    <div class='inline'>
<p>The change stream options.</p>
</div>
  </li>
</ul>
    <p class='tag_title'>Options Hash (<tt>options</tt>):</p>
    <ul class='option'>
        <li>
          <span class='name'>:full_document</span>
          <span class='type'>(<code>String</code>)</span>
            &mdash; <div class='inline'>
<p>Allowed values: nil, ‘default’, ‘updateLookup’, ‘whenAvailable’, ‘required’.</p>

<p>The default is to not send a value (i.e. nil), which is equivalent to ‘default’. By default, the change notification for partial updates will include a delta describing the changes to the document.</p>

<p>When set to ‘updateLookup’, the change notification for partial updates will include both a delta describing the changes to the document as well as a copy of the entire document that was changed from some time after the change occurred.</p>

<p>When set to ‘whenAvailable’, configures the change stream to return the post-image of the modified document for replace and update change events if the post-image for this event is available.</p>

<p>When set to ‘required’, the same behavior as ‘whenAvailable’ except that an error is raised if the post-image is not available.</p>
</div>        </li>
        <li>
          <span class='name'>:full_document_before_change</span>
          <span class='type'>(<code>String</code>)</span>
            &mdash; <div class='inline'>
<p>Allowed values: nil, ‘whenAvailable’, ‘required’, ‘off’.</p>

<p>The default is to not send a value (i.e. nil), which is equivalent to ‘off’.</p>

<p>When set to ‘whenAvailable’, configures the change stream to return the pre-image of the modified document for replace, update, and delete change events if it is available.</p>

<p>When set to ‘required’, the same behavior as ‘whenAvailable’ except that an error is raised if the pre-image is not available.</p>
</div>        </li>
        <li>
          <span class='name'>:resume_after</span>
          <span class='type'>(<code>BSON::Document</code>, <code>Hash</code>)</span>
            &mdash; <div class='inline'>
<p>Specifies the logical starting point for the new change stream.</p>
</div>        </li>
        <li>
          <span class='name'>:max_await_time_ms</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>The maximum amount of time for the server to wait on new documents to satisfy a change stream query.</p>
</div>        </li>
        <li>
          <span class='name'>:batch_size</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>The number of documents to return per batch.</p>
</div>        </li>
        <li>
          <span class='name'>:collation</span>
          <span class='type'>(<code>BSON::Document</code>, <code>Hash</code>)</span>
            &mdash; <div class='inline'>
<p>The collation to use.</p>
</div>        </li>
        <li>
          <span class='name'>:start_at_operation_time</span>
          <span class='type'>(<code>BSON::Timestamp</code>)</span>
            &mdash; <div class='inline'>
<p>Only return changes that occurred at or after the specified timestamp. Any command run against the server will return a cluster time that can be used here. Only recognized by server versions 4.0+.</p>
</div>        </li>
        <li>
          <span class='name'>:start_after</span>
          <span class='type'>(<code>Bson::Document</code>, <code>Hash</code>)</span>
            &mdash; <div class='inline'>
<p>Similar to <code>:resume_after</code>, this option takes a resume token and starts a new change stream returning the first notification after the token. This will allow users to watch collections that have been dropped and recreated or newly renamed collections without missing any notifications.</p>
</div>        </li>
        <li>
          <span class='name'>:comment</span>
          <span class='type'>(<code>Object</code>)</span>
            &mdash; <div class='inline'>
<p>A user-provided comment to attach to this command.</p>
</div>        </li>
        <li>
          <span class='name'>:show_expanded_events</span>
          <span class='type'>(<code>Boolean</code>)</span>
            &mdash; <div class='inline'>
<p>Enables the server to send the ‘expanded’ list of change stream events. The list of additional events included with this flag set are: createIndexes, dropIndexes, modify, create, shardCollection, reshardCollection, refineCollectionShardKey.</p>

<p>The server will report an error if <code>startAfter</code> and <code>resumeAfter</code> are both specified.</p>
</div>        </li>
    </ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L133-L151'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='133' data-end='151'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 133</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span><span class='comma'>,</span> <span class='id identifier rubyid_pipeline'><a href="#pipeline-instance_method" title="Mongo::Collection::View::ChangeStream#pipeline (method)">pipeline</a></span><span class='comma'>,</span> <span class='id identifier rubyid_changes_for'>changes_for</span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Collection::View::ChangeStream#options (method)">options</a></span> <span class='op'>=</span> {})
  <span class='comment'># change stream cursors can only be :iterable, so we don&#39;t allow
</span>  <span class='comment'># timeout_mode to be specified.
</span>  <span class='id identifier rubyid_perform_setup'>perform_setup</span>(<span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Collection::View::ChangeStream#options (method)">options</a></span><span class='comma'>,</span> <span class='label'>forbid:</span> <span class='qsymbols'><span class='qsymbols_beg'>%i[</span><span class='words_sep'> </span><span class='tstring_content'>timeout_mode</span><span class='words_sep'> </span><span class='tstring_end'>]</span></span>) <span class='kw'>do</span>
    <span class='ivar'>@changes_for</span> <span class='op'>=</span> <span class='id identifier rubyid_changes_for'>changes_for</span>
    <span class='ivar'>@change_stream_filters</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'><a href="#pipeline-instance_method" title="Mongo::Collection::View::ChangeStream#pipeline (method)">pipeline</a></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_pipeline'><a href="#pipeline-instance_method" title="Mongo::Collection::View::ChangeStream#pipeline (method)">pipeline</a></span>.<span class='id identifier rubyid_dup'>dup</span>
    <span class='ivar'>@start_after</span> <span class='op'>=</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_start_after'>start_after</span>]
  <span class='kw'>end</span>

  <span class='comment'># The resume token tracked by the change stream, used only
</span>  <span class='comment'># when there is no cursor, or no cursor resume token
</span>  <span class='ivar'>@resume_token</span> <span class='op'>=</span> <span class='ivar'>@start_after</span> <span class='op'>||</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_resume_after'>resume_after</span>]

  <span class='id identifier rubyid_create_cursor!'><a href="#create_cursor!-instance_method" title="Mongo::Collection::View::ChangeStream#create_cursor! (method)">create_cursor!</a></span>

  <span class='comment'># We send different parameters when we resume a change stream
</span>  <span class='comment'># compared to when we send the first query
</span>  <span class='ivar'>@resuming</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="closed?-instance_method">
  <h3 class='signature ro first'>
    #<strong>closed?</strong>  &#x21d2; <code>true</code>, <code>false</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Is the change stream closed?</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Determine whether the change stream is closed.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_stream'>stream</span>.<span class='id identifier rubyid_closed?'>closed?</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>true</code>, <code>false</code>)</span>
&mdash;    <div class='inline'>
<p>If the change stream is closed.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L273-L275'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='273' data-end='275'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 273</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_closed?'>closed?</span>
  <span class='ivar'>@cursor</span>.<span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cursor-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>cursor</strong>  &#x21d2; <a href="../../Cursor.html" title="Mongo::Cursor (class)">Cursor</a>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../../Cursor.html" title="Mongo::Cursor (class)">Cursor</a>)</span>
&mdash;    <div class='inline'>
<p>the underlying cursor for this operation</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L67-L67'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='67' data-end='67'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 67</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cursor'>cursor</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="for_cluster?-instance_method">
  <h3 class='signature ro priv'>
    #<strong>for_cluster?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L328-L330'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='328' data-end='330'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 328</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_for_cluster?'>for_cluster?</span>
  <span class='ivar'>@changes_for</span> <span class='op'>==</span> <span class='const'><a href="#CLUSTER-constant" title="Mongo::Collection::View::ChangeStream::CLUSTER (constant)">CLUSTER</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="for_collection?-instance_method">
  <h3 class='signature ro priv'>
    #<strong>for_collection?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L336-L338'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='336' data-end='338'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 336</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_for_collection?'>for_collection?</span>
  <span class='op'>!</span><span class='id identifier rubyid_for_cluster?'><a href="#for_cluster%3F-instance_method" title="Mongo::Collection::View::ChangeStream#for_cluster? (method)">for_cluster?</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_for_database?'><a href="#for_database%3F-instance_method" title="Mongo::Collection::View::ChangeStream#for_database? (method)">for_database?</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="for_database?-instance_method">
  <h3 class='signature ro priv'>
    #<strong>for_database?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L332-L334'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='332' data-end='334'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 332</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_for_database?'>for_database?</span>
  <span class='ivar'>@changes_for</span> <span class='op'>==</span> <span class='const'><a href="#DATABASE-constant" title="Mongo::Collection::View::ChangeStream::DATABASE (constant)">DATABASE</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="options-instance_method">
  <h3 class='signature ro'>
    #<strong>options</strong>  &#x21d2; <code>BSON::Document</code>  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>The change stream options.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L63-L63'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='63'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_options'>options</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="resuming?-instance_method">
  <h3 class='signature ro priv'>
    #<strong>resuming?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L456-L458'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='456' data-end='458'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 456</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_resuming?'>resuming?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='ivar'>@resuming</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="aggregate_spec-instance_method">
  <h3 class='signature priv first'>
    #<strong>aggregate_spec</strong>(session, read_preference)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L379-L383'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='379' data-end='383'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 379</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_aggregate_spec'>aggregate_spec</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_read_preference'><a href="../../Collection.html#read_preference-instance_method" title="Mongo::Collection#read_preference (method)">read_preference</a></span>)
  <span class='kw'>super</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_read_preference'><a href="../../Collection.html#read_preference-instance_method" title="Mongo::Collection#read_preference (method)">read_preference</a></span>).<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_spec'>spec</span><span class='op'>|</span>
    <span class='id identifier rubyid_spec'>spec</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_selector'><a href="../View.html#selector-instance_method" title="Mongo::Collection::View#selector (method)">selector</a></span>][<span class='symbeg'>:</span><span class='id identifier rubyid_aggregate'><a href="../../Collection.html#aggregate-instance_method" title="Mongo::Collection#aggregate (method)">aggregate</a></span>] <span class='op'>=</span> <span class='int'>1</span> <span class='kw'>unless</span> <span class='id identifier rubyid_for_collection?'><a href="#for_collection%3F-instance_method" title="Mongo::Collection::View::ChangeStream#for_collection? (method)">for_collection?</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="change_doc-instance_method">
  <h3 class='signature priv'>
    #<strong>change_doc</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L385-L435'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='385' data-end='435'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 385</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_change_doc'>change_doc</span>
  {}.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_doc'>doc</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_full_document'>full_document</span>]
      <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_fullDocument'>fullDocument</span>] <span class='op'>=</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_full_document'>full_document</span>]
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_full_document_before_change'>full_document_before_change</span>]
      <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_fullDocumentBeforeChange'>fullDocumentBeforeChange</span>] <span class='op'>=</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_full_document_before_change'>full_document_before_change</span>]
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='ivar'>@options</span>.<span class='id identifier rubyid_key?'>key?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_show_expanded_events'>show_expanded_events</span>)
      <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_showExpandedEvents'>showExpandedEvents</span>] <span class='op'>=</span> <span class='ivar'>@options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_show_expanded_events'>show_expanded_events</span>]
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_resuming?'><a href="#resuming%3F-instance_method" title="Mongo::Collection::View::ChangeStream#resuming? (method)">resuming?</a></span>
      <span class='comment'># We have a resume token once we retrieved any documents.
</span>      <span class='comment'># However, if the first getMore fails and the user didn&#39;t pass
</span>      <span class='comment'># a resume token we won&#39;t have a resume token to use.
</span>      <span class='comment'># Use start_at_operation time in this case
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_resume_token'><a href="#resume_token-instance_method" title="Mongo::Collection::View::ChangeStream#resume_token (method)">resume_token</a></span>
        <span class='comment'># Spec says we need to remove both startAtOperationTime and startAfter if
</span>        <span class='comment'># either was passed in by user, thus we won&#39;t forward them
</span>        <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_resumeAfter'>resumeAfter</span>] <span class='op'>=</span> <span class='id identifier rubyid_resume_token'><a href="#resume_token-instance_method" title="Mongo::Collection::View::ChangeStream#resume_token (method)">resume_token</a></span>
      <span class='kw'>elsif</span> <span class='ivar'>@start_at_operation_time_supported</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@start_at_operation_time</span>
        <span class='comment'># It is crucial to check @start_at_operation_time_supported
</span>        <span class='comment'># here - we may have switched to an older server that
</span>        <span class='comment'># does not support operation times and therefore shouldn&#39;t
</span>        <span class='comment'># try to send one to it!
</span>        <span class='comment'>#
</span>        <span class='comment'># @start_at_operation_time is already a BSON::Timestamp
</span>        <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_startAtOperationTime'>startAtOperationTime</span>] <span class='op'>=</span> <span class='ivar'>@start_at_operation_time</span>
      <span class='kw'>else</span>
        <span class='comment'># Can&#39;t resume if we don&#39;t have either
</span>        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../../Error/MissingResumeToken.html" title="Mongo::Error::MissingResumeToken (class)">MissingResumeToken</a></span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='kw'>if</span> <span class='ivar'>@start_after</span>
        <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_startAfter'>startAfter</span>] <span class='op'>=</span> <span class='ivar'>@start_after</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_resume_token'><a href="#resume_token-instance_method" title="Mongo::Collection::View::ChangeStream#resume_token (method)">resume_token</a></span>
        <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_resumeAfter'>resumeAfter</span>] <span class='op'>=</span> <span class='id identifier rubyid_resume_token'><a href="#resume_token-instance_method" title="Mongo::Collection::View::ChangeStream#resume_token (method)">resume_token</a></span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Collection::View::ChangeStream#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_start_at_operation_time'>start_at_operation_time</span>]
        <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_startAtOperationTime'>startAtOperationTime</span>] <span class='op'>=</span> <span class='id identifier rubyid_time_to_bson_timestamp'><a href="#time_to_bson_timestamp-instance_method" title="Mongo::Collection::View::ChangeStream#time_to_bson_timestamp (method)">time_to_bson_timestamp</a></span>(
          <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Collection::View::ChangeStream#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_start_at_operation_time'>start_at_operation_time</span>])
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_doc'>doc</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_allChangesForCluster'>allChangesForCluster</span>] <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_for_cluster?'><a href="#for_cluster%3F-instance_method" title="Mongo::Collection::View::ChangeStream#for_cluster? (method)">for_cluster?</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="close-instance_method">
  <h3 class='signature '>
    #<strong>close</strong>(opts = {})  &#x21d2; <code>nil</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>This method attempts to close the cursor used by the change stream, which in turn closes the server-side change stream cursor. This method ignores any errors that occur when closing the server-side cursor.</p>
</div>
  </div>


<p>Close the change stream.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Close the change stream.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_stream'>stream</span>.<span class='id identifier rubyid_close'>close</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>Always nil.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L254-L263'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='254' data-end='263'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 254</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_close'>close</span>(<span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> {})
  <span class='kw'>unless</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Collection::View::ChangeStream#closed? (method)">closed?</a></span>
    <span class='kw'>begin</span>
      <span class='ivar'>@cursor</span>.<span class='id identifier rubyid_close'>close</span>(<span class='id identifier rubyid_opts'>opts</span>)
    <span class='kw'>rescue</span> <span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../../Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span><span class='op'>::</span><span class='const'><a href="../../Error/OperationFailure/Family.html" title="Mongo::Error::OperationFailure::Family (module)">Family</a></span><span class='comma'>,</span> <span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../../Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span><span class='comma'>,</span> <span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../../Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span><span class='comma'>,</span> <span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../../Error/MissingConnection.html" title="Mongo::Error::MissingConnection (class)">MissingConnection</a></span>
      <span class='comment'># ignore
</span>    <span class='kw'>end</span>
    <span class='ivar'>@cursor</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="create_cursor!-instance_method">
  <h3 class='signature priv'>
    #<strong>create_cursor!</strong>(timeout_ms = nil)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L340-L373'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='340' data-end='373'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 340</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_create_cursor!'>create_cursor!</span>(<span class='id identifier rubyid_timeout_ms'><a href="../View.html#timeout_ms-instance_method" title="Mongo::Collection::View#timeout_ms (method)">timeout_ms</a></span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='comment'># clear the cache because we may get a newer or an older server
</span>  <span class='comment'># (rolling upgrades)
</span>  <span class='ivar'>@start_at_operation_time_supported</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_get_session'>get_session</span>(<span class='ivar'>@options</span>)
  <span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'><a href="../../Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="../../Operation/Context.html" title="Mongo::Operation::Context (class)">Context</a></span>.<span class='id identifier rubyid_new'><a href="../../Operation/Context.html#new-class_method" title="Mongo::Operation::Context.new (method)">new</a></span>(<span class='label'>client:</span> <span class='id identifier rubyid_client'>client</span><span class='comma'>,</span> <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='label'>view:</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='label'>operation_timeouts:</span> <span class='id identifier rubyid_timeout_ms'><a href="../View.html#timeout_ms-instance_method" title="Mongo::Collection::View#timeout_ms (method)">timeout_ms</a></span> <span class='op'>?</span> { <span class='label'>operation_timeout_ms:</span> <span class='id identifier rubyid_timeout_ms'><a href="../View.html#timeout_ms-instance_method" title="Mongo::Collection::View#timeout_ms (method)">timeout_ms</a></span> } <span class='op'>:</span> <span class='id identifier rubyid_operation_timeouts'><a href="../View.html#operation_timeouts-instance_method" title="Mongo::Collection::View#operation_timeouts (method)">operation_timeouts</a></span>)

  <span class='id identifier rubyid_start_at_operation_time'>start_at_operation_time</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_start_at_operation_time_supported'>start_at_operation_time_supported</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='ivar'>@cursor</span> <span class='op'>=</span> <span class='id identifier rubyid_read_with_retry_cursor'>read_with_retry_cursor</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'><a href="../../Collection.html#server_selector-instance_method" title="Mongo::Collection#server_selector (method)">server_selector</a></span><span class='comma'>,</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_with_connection'>with_connection</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
      <span class='id identifier rubyid_start_at_operation_time_supported'>start_at_operation_time_supported</span> <span class='op'>=</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_server_version_gte?'>server_version_gte?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>4.0</span><span class='tstring_end'>&#39;</span></span>)

      <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_send_initial_query'><a href="#send_initial_query-instance_method" title="Mongo::Collection::View::ChangeStream#send_initial_query (method)">send_initial_query</a></span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)

      <span class='kw'>if</span> <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_replies'>replies</span>.<span class='id identifier rubyid_first'>first</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_replies'>replies</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_documents'>documents</span>.<span class='id identifier rubyid_first'>first</span>
        <span class='id identifier rubyid_start_at_operation_time'>start_at_operation_time</span> <span class='op'>=</span> <span class='id identifier rubyid_doc'>doc</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>operationTime</span><span class='tstring_end'>&#39;</span></span>]
      <span class='kw'>else</span>
        <span class='comment'># The above may set @start_at_operation_time to nil
</span>        <span class='comment'># if it was not in the document for some reason,
</span>        <span class='comment'># for consistency set it to nil here as well.
</span>        <span class='comment'># NB: since this block may be executed more than once, each
</span>        <span class='comment'># execution must write to start_at_operation_time either way.
</span>        <span class='id identifier rubyid_start_at_operation_time'>start_at_operation_time</span> <span class='op'>=</span> <span class='kw'>nil</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_result'>result</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='ivar'>@start_at_operation_time</span> <span class='op'>=</span> <span class='id identifier rubyid_start_at_operation_time'>start_at_operation_time</span>
  <span class='ivar'>@start_at_operation_time_supported</span> <span class='op'>=</span> <span class='id identifier rubyid_start_at_operation_time_supported'>start_at_operation_time_supported</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cursor_type-instance_method">
  <h3 class='signature '>
    #<strong>cursor_type</strong>  &#x21d2; <code>Object</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>“change streams are an abstraction around tailable-awaitData cursors…”</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p><code>:tailable_await</code></p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L307-L309'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='307' data-end='309'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 307</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cursor_type'>cursor_type</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_tailable_await'>tailable_await</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="each-instance_method">
  <h3 class='signature '>
    #<strong>each</strong> {|Each| ... } &#x21d2; <code>Enumerator</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Iterate through documents returned by the change stream.</p>

<p>This method retries once per error on resumable errors (two consecutive errors result in the second error being raised, an error which is recovered from resets the error count to zero).</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Iterate through the stream of documents.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_stream'>stream</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_document'>document</span><span class='op'>|</span>
  <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_document'>document</span>
<span class='kw'>end</span></code></pre>
  </div>
<p class='tag_title'>Yield Parameters:</p>
<ul class='yieldparam'>
  <li>
    <span class='name'>Each</span>
    <span class='type'>(<code>BSON::Document</code>)</span>
&mdash;    <div class='inline'>
<p>change stream document.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Enumerator</code>)</span>
&mdash;    <div class='inline'>
<p>The enumerator.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L169-L177'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='169' data-end='177'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 169</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_each'>each</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>StopIteration</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Collection::View::ChangeStream.new (method)">new</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Collection::View::ChangeStream#closed? (method)">closed?</a></span>
  <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_document'>document</span> <span class='op'>=</span> <span class='id identifier rubyid_try_next'><a href="#try_next-instance_method" title="Mongo::Collection::View::ChangeStream#try_next (method)">try_next</a></span>
    <span class='kw'>yield</span> <span class='id identifier rubyid_document'>document</span> <span class='kw'>if</span> <span class='id identifier rubyid_document'>document</span>
  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='const'>StopIteration</span>
  <span class='kw'>return</span> <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="inspect-instance_method">
  <h3 class='signature '>
    #<strong>inspect</strong>  &#x21d2; <code>String</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Get a formatted string for use in inspection.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Inspect the change stream object.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_stream'>stream</span>.<span class='id identifier rubyid_inspect'>inspect</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'>
<p>The change stream inspection.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L285-L288'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='285' data-end='288'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 285</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_inspect'>inspect</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;Mongo::Collection::View:ChangeStream:0x</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_object_id'>object_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> filters=</span><span class='embexpr_beg'>#{</span><span class='ivar'>@change_stream_filters</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>options=</span><span class='embexpr_beg'>#{</span><span class='ivar'>@options</span><span class='embexpr_end'>}</span><span class='tstring_content'> resume_token=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_resume_token'><a href="#resume_token-instance_method" title="Mongo::Collection::View::ChangeStream#resume_token (method)">resume_token</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="max_await_time_ms-instance_method">
  <h3 class='signature '>
    #<strong>max_await_time_ms</strong>  &#x21d2; <code>Integer</code> | <code>nil</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the value of the max_await_time_ms option that was passed to this change stream.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>the max_await_time_ms value</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L322-L324'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='322' data-end='324'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 322</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_max_await_time_ms'>max_await_time_ms</span>
  <span class='id identifier rubyid_options'><a href="#options-instance_method" title="Mongo::Collection::View::ChangeStream#options (method)">options</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_await_time_ms'>max_await_time_ms</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pipeline-instance_method">
  <h3 class='signature priv'>
    #<strong>pipeline</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L375-L377'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='375' data-end='377'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 375</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
  [{ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$changeStream</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_change_doc'><a href="#change_doc-instance_method" title="Mongo::Collection::View::ChangeStream#change_doc (method)">change_doc</a></span> }] <span class='op'>+</span> <span class='ivar'>@change_stream_filters</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="recreate_cursor!-instance_method">
  <h3 class='signature priv'>
    #<strong>recreate_cursor!</strong>(context = nil)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Recreates the current cursor (typically as a consequence of attempting to resume the change stream)</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L462-L467'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='462' data-end='467'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 462</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_recreate_cursor!'>recreate_cursor!</span>(<span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='ivar'>@timed_out</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='id identifier rubyid_close'><a href="#close-instance_method" title="Mongo::Collection::View::ChangeStream#close (method)">close</a></span>
  <span class='id identifier rubyid_create_cursor!'><a href="#create_cursor!-instance_method" title="Mongo::Collection::View::ChangeStream#create_cursor! (method)">create_cursor!</a></span>(<span class='id identifier rubyid_context'>context</span><span class='op'>&amp;.</span><span class='id identifier rubyid_remaining_timeout_ms'>remaining_timeout_ms</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="resume_token-instance_method">
  <h3 class='signature '>
    #<strong>resume_token</strong>  &#x21d2; <code>BSON::Document</code> | <code>nil</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the resume token that the stream will use to automatically resume, if one exists.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Get the change stream resume token.</p>
</div></p>
      <pre class='example code ruby'><code><span class='id identifier rubyid_stream'>stream</span>.<span class='id identifier rubyid_resume_token'>resume_token</span></code></pre>
  </div>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>BSON::Document</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>The change stream resume token.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.10.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L299-L302'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='299' data-end='302'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 299</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_resume_token'>resume_token</span>
  <span class='id identifier rubyid_cursor_resume_token'>cursor_resume_token</span> <span class='op'>=</span> <span class='ivar'>@cursor</span>.<span class='id identifier rubyid_resume_token'>resume_token</span> <span class='kw'>if</span> <span class='ivar'>@cursor</span>
  <span class='id identifier rubyid_cursor_resume_token'>cursor_resume_token</span> <span class='op'>||</span> <span class='ivar'>@resume_token</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="send_initial_query-instance_method">
  <h3 class='signature priv'>
    #<strong>send_initial_query</strong>(connection, context)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L437-L443'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='437' data-end='443'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 437</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_send_initial_query'>send_initial_query</span>(<span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span>)
  <span class='id identifier rubyid_initial_query_op'>initial_query_op</span>(<span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span>.<span class='id identifier rubyid_read_preference'><a href="../../Collection.html#read_preference-instance_method" title="Mongo::Collection#read_preference (method)">read_preference</a></span>)
    .<span class='id identifier rubyid_execute_with_connection'>execute_with_connection</span>(
      <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span>
      <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span>
    )
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="time_to_bson_timestamp-instance_method">
  <h3 class='signature priv'>
    #<strong>time_to_bson_timestamp</strong>(time)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L445-L454'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='445' data-end='454'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 445</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_time_to_bson_timestamp'>time_to_bson_timestamp</span>(<span class='id identifier rubyid_time'>time</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_time'>time</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'>Time</span>)
    <span class='id identifier rubyid_seconds'>seconds</span> <span class='op'>=</span> <span class='id identifier rubyid_time'>time</span>.<span class='id identifier rubyid_to_f'>to_f</span>
    <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Timestamp</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Collection::View::ChangeStream.new (method)">new</a></span>(<span class='id identifier rubyid_seconds'>seconds</span>.<span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> ((<span class='id identifier rubyid_seconds'>seconds</span> <span class='op'>-</span> <span class='id identifier rubyid_seconds'>seconds</span>.<span class='id identifier rubyid_to_i'>to_i</span>) <span class='op'>*</span> <span class='int'>1000000</span>).<span class='id identifier rubyid_to_i'>to_i</span>)
  <span class='kw'>elsif</span> <span class='id identifier rubyid_time'>time</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'>BSON</span><span class='op'>::</span><span class='const'>Timestamp</span>)
    <span class='id identifier rubyid_time'>time</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Time must be a Time or a BSON::Timestamp instance</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="timeout_mode-instance_method">
  <h3 class='signature '>
    #<strong>timeout_mode</strong>  &#x21d2; <code>Object</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>“change streams…implicitly use ITERATION mode”</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p><code>:iteration</code></p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L314-L316'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='314' data-end='316'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 314</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_timeout_mode'>timeout_mode</span>
  <span class='symbeg'>:</span><span class='id identifier rubyid_iteration'>iteration</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="to_enum-instance_method">
  <h3 class='signature '>
    #<strong>to_enum</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.5.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L227-L236'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='227' data-end='236'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 227</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_to_enum'>to_enum</span>
  <span class='id identifier rubyid_enum'>enum</span> <span class='op'>=</span> <span class='kw'>super</span>
  <span class='id identifier rubyid_enum'>enum</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_instance_variable_set'>instance_variable_set</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@obj</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='kw'>class</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_enum'>enum</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_try_next'><a href="#try_next-instance_method" title="Mongo::Collection::View::ChangeStream#try_next (method)">try_next</a></span>
      <span class='ivar'>@obj</span>.<span class='id identifier rubyid_try_next'><a href="#try_next-instance_method" title="Mongo::Collection::View::ChangeStream#try_next (method)">try_next</a></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_enum'>enum</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="try_next-instance_method">
  <h3 class='signature '>
    #<strong>try_next</strong>  &#x21d2; <code>BSON::Document</code> | <code>nil</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return one document from the change stream, if one is available.</p>

<p>Retries once on a resumable error.</p>

<p>Raises StopIteration if the change stream is closed.</p>

<p>This method will wait up to max_await_time_ms milliseconds for changes from the server, and if no changes are received it will return nil.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>BSON::Document</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>A change stream document.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<code>StopIteration</code>)</span>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.6.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/change_stream.rb#L191-L225'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='191' data-end='225'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/change_stream.rb', line 191</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_try_next'>try_next</span>
  <span class='id identifier rubyid_recreate_cursor!'><a href="#recreate_cursor!-instance_method" title="Mongo::Collection::View::ChangeStream#recreate_cursor! (method)">recreate_cursor!</a></span> <span class='kw'>if</span> <span class='ivar'>@timed_out</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>StopIteration</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Collection::View::ChangeStream.new (method)">new</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_closed?'><a href="#closed%3F-instance_method" title="Mongo::Collection::View::ChangeStream#closed? (method)">closed?</a></span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='ivar'>@cursor</span>.<span class='id identifier rubyid_try_next'>try_next</span>
  <span class='kw'>rescue</span> <span class='const'><a href="../../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='comment'># &quot;If a next call fails with a timeout error, drivers MUST NOT
</span>    <span class='comment'># invalidate the change stream. The subsequent next call MUST
</span>    <span class='comment'># perform a resume attempt to establish a new change stream on the
</span>    <span class='comment'># server...&quot;
</span>    <span class='comment'>#
</span>    <span class='comment'># However, SocketTimeoutErrors are TimeoutErrors, but are also
</span>    <span class='comment'># change-stream-resumable. To preserve existing (specified) behavior,
</span>    <span class='comment'># We only count timeouts when the error is not also
</span>    <span class='comment'># change-stream-resumable.
</span>    <span class='ivar'>@timed_out</span> <span class='op'>=</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../../../Mongo.html" title="Mongo (module)">Mongo</a></span><span class='op'>::</span><span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../../Error/TimeoutError.html" title="Mongo::Error::TimeoutError (class)">TimeoutError</a></span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_change_stream_resumable?'>change_stream_resumable?</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='kw'>unless</span> <span class='ivar'>@timed_out</span> <span class='op'>||</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_change_stream_resumable?'>change_stream_resumable?</span>

    <span class='ivar'>@resume_token</span> <span class='op'>=</span> <span class='ivar'>@cursor</span>.<span class='id identifier rubyid_resume_token'><a href="#resume_token-instance_method" title="Mongo::Collection::View::ChangeStream#resume_token (method)">resume_token</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span> <span class='kw'>if</span> <span class='ivar'>@timed_out</span>

    <span class='id identifier rubyid_recreate_cursor!'><a href="#recreate_cursor!-instance_method" title="Mongo::Collection::View::ChangeStream#recreate_cursor! (method)">recreate_cursor!</a></span>(<span class='ivar'>@cursor</span>.<span class='id identifier rubyid_context'>context</span>)
    <span class='kw'>retry</span>
  <span class='kw'>end</span>

  <span class='comment'># We need to verify each doc has an _id, so we
</span>  <span class='comment'># have a resume token to work with
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_doc'>doc</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_doc'>doc</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../../Error.html" title="Mongo::Error (class)">Error</a></span><span class='op'>::</span><span class='const'><a href="../../Error/MissingResumeToken.html" title="Mongo::Error::MissingResumeToken (class)">MissingResumeToken</a></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_doc'>doc</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>