<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Mongo::Collection::View::Aggregation &mdash; Mongo master</title>

<link rel='stylesheet'  type='text/css' href='../../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Mongo::Collection::View::Aggregation",
    relpath = '../../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../../'>Mongo master</a> &raquo; 
      <a href='../../../_index.html#alpha_A'>Index (A)</a> &raquo; 
        <a href="../../../Mongo.html" title="Mongo (module)">Mongo</a> &raquo; 
        <a href="../../Collection.html" title="Mongo::Collection (class)">Collection</a> &raquo; 
        <a href="../View.html" title="Mongo::Collection::View (class)">View</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Aggregation&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Mongo::Collection::View::Aggregation</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Modules:</div>
      <div class='box_11'>
          <a href="Aggregation/Behavior.html" title="Mongo::Collection::View::Aggregation::Behavior (module)"><code>Behavior</code></a>      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Subclasses:</div>
        <div class='box_22'>
          <a href="ChangeStream.html" title="Mongo::Collection::View::ChangeStream (class)">ChangeStream</a>
        </div>
      </td>
    </tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          Forwardable
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="Aggregation/Behavior.html" title="Mongo::Collection::View::Aggregation::Behavior (module)"><code>Behavior</code></a>,
          <a href="../../Retryable.html" title="Mongo::Retryable (module)"><code>::Mongo::Retryable</code></a>,
          <a href="../../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a>,
          <a href="Explainable.html" title="Mongo::Collection::View::Explainable (module)"><code>Explainable</code></a>,
          <a href="Iterable.html" title="Mongo::Collection::View::Iterable (module)"><code>Iterable</code></a>,
          <a href="../../CursorHost.html" title="Mongo::CursorHost (module)"><code>::Mongo::CursorHost</code></a>,
          <a href="Immutable.html" title="Mongo::Collection::View::Immutable (module)"><code>Immutable</code></a>,
          Enumerable
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2 o'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/aggregation.rb#L27'>lib/mongo/collection/view/aggregation.rb</a><span class='defines'>,<br /><a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/aggregation/behavior.rb#L6'>lib/mongo/collection/view/aggregation/behavior.rb</a></span>
      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Provides behavior around an aggregation pipeline on a collection view.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
  <h3 class='inherited'><a href="Explainable.html" title="Mongo::Collection::View::Explainable (module)"><code>Explainable</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="Explainable.html#ALL_PLANS_EXECUTION-constant" title="Mongo::Collection::View::Explainable::ALL_PLANS_EXECUTION (constant)">ALL_PLANS_EXECUTION</a>, 
    <a href="Explainable.html#EXECUTION_STATS-constant" title="Mongo::Collection::View::Explainable::EXECUTION_STATS (constant)">EXECUTION_STATS</a>, 
    <a href="Explainable.html#QUERY_PLANNER-constant" title="Mongo::Collection::View::Explainable::QUERY_PLANNER (constant)">QUERY_PLANNER</a>
  </p>
  <h3 class='inherited'><a href="../../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="../../Loggable.html#PREFIX-constant" title="Mongo::Loggable::PREFIX (constant)">PREFIX</a>
  </p>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(view, pipeline, options = {})  &#x21d2; Aggregation </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Initialize the aggregation for the provided collection view, pipeline and options.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#pipeline-instance_method" title="#pipeline (instance method)">#<strong>pipeline</strong>  &#x21d2; Array&lt;Hash&gt; </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
</ul>

<h3 class='inherited'><a href="Aggregation/Behavior.html" title="Mongo::Collection::View::Aggregation::Behavior (module)"><code>Behavior</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="Aggregation/Behavior.html#view-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#view (method)">#view</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ro nodoc' href="Aggregation/Behavior.html#write%3F-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#write? (method)">#write?</a></td>
      <td><div class='inline'><p>Whether this aggregation will write its result to a database collection.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Explainable.html" title="Mongo::Collection::View::Explainable (module)"><code>Explainable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro priv' href="Explainable.html#explained%3F-instance_method" title="Mongo::Collection::View::Explainable#explained? (method)">#explained?</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Iterable.html" title="Mongo::Collection::View::Iterable (module)"><code>Iterable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ro priv' href="Iterable.html#prefer_cached_cursor%3F-instance_method" title="Mongo::Collection::View::Iterable#prefer_cached_cursor? (method)">#prefer_cached_cursor?</a></td>
      <td><div class='inline'><p>If the caching cursor is closed and was not fully iterated, the documents we have in it are not the complete result set and we have no way of completing that iteration.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ro priv' href="Iterable.html#use_query_cache%3F-instance_method" title="Mongo::Collection::View::Iterable#use_query_cache? (method)">#use_query_cache?</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../../CursorHost.html" title="Mongo::CursorHost (module)"><code>::Mongo::CursorHost</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ro nodoc' href="../../CursorHost.html#cursor-instance_method" title="Mongo::CursorHost#cursor (method)">#cursor</a></td>
      <td><div class='inline'><p>Returns the cursor associated with this view, if any.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="../../CursorHost.html#timeout_mode-instance_method" title="Mongo::CursorHost#timeout_mode (method)">#timeout_mode</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Immutable.html" title="Mongo::Collection::View::Immutable (module)"><code>Immutable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="Immutable.html#options-instance_method" title="Mongo::Collection::View::Immutable#options (method)">#options</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature priv'>
      <a href="#effective_read_preference-instance_method" title="#effective_read_preference (instance method)">#<strong>effective_read_preference</strong>(connection)  &#x21d2; Hash | nil </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Return effective read preference for the operation.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#initial_query_op-instance_method" title="#initial_query_op (instance method)">#<strong>initial_query_op</strong>(session, read_preference = nil)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#new-instance_method" title="#new (instance method)">#<strong>new</strong>(options)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#send_initial_query-instance_method" title="#send_initial_query (instance method)">#<strong>send_initial_query</strong>(server, context, operation: nil)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>

<h3 class='inherited'><a href="Aggregation/Behavior.html" title="Mongo::Collection::View::Aggregation::Behavior (module)"><code>Behavior</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Aggregation/Behavior.html#allow_disk_use-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#allow_disk_use (method)">#allow_disk_use</a></td>
      <td><div class='inline'><p>Set to true if disk usage is allowed during the aggregation.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Aggregation/Behavior.html#explain-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#explain (method)">#explain</a></td>
      <td><div class='inline'><p>Get the explain plan for the aggregation.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m nodoc' href="Aggregation/Behavior.html#timeout_ms-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#timeout_ms (method)">#timeout_ms</a>,
        <a class='i_m priv' href="Aggregation/Behavior.html#aggregate_spec-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#aggregate_spec (method)">#aggregate_spec</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Aggregation/Behavior.html#cache_options-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#cache_options (method)">#cache_options</a></td>
      <td><div class='inline'><p>Skip, sort, limit, projection are specified as pipeline stages rather than as options.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv nodoc' href="Aggregation/Behavior.html#operation_timeouts-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#operation_timeouts (method)">#operation_timeouts</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Aggregation/Behavior.html#perform_setup-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#perform_setup (method)">#perform_setup</a></td>
      <td><div class='inline'><p>Common setup for all classes that include this behavior; the constructor should invoke this method.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Aggregation/Behavior.html#server_selector-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#server_selector (method)">#server_selector</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../../Retryable.html" title="Mongo::Retryable (module)"><code>::Mongo::Retryable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="../../Retryable.html#read_worker-instance_method" title="Mongo::Retryable#read_worker (method)">#read_worker</a></td>
      <td><div class='inline'><p>Returns the read worker for handling retryable reads.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="../../Retryable.html#select_server-instance_method" title="Mongo::Retryable#select_server (method)">#select_server</a></td>
      <td><div class='inline'><p>This is a separate method to make it possible for the test suite to assert that server selection is performed during retry attempts.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="../../Retryable.html#write_worker-instance_method" title="Mongo::Retryable#write_worker (method)">#write_worker</a></td>
      <td><div class='inline'><p>Returns the write worker for handling retryable writes.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../../Loggable.html" title="Mongo::Loggable (module)"><code>::Mongo::Loggable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#log_debug-instance_method" title="Mongo::Loggable#log_debug (method)">#log_debug</a></td>
      <td><div class='inline'><p>Convenience method to log debug messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#log_error-instance_method" title="Mongo::Loggable#log_error (method)">#log_error</a></td>
      <td><div class='inline'><p>Convenience method to log error messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#log_fatal-instance_method" title="Mongo::Loggable#log_fatal (method)">#log_fatal</a></td>
      <td><div class='inline'><p>Convenience method to log fatal messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#log_info-instance_method" title="Mongo::Loggable#log_info (method)">#log_info</a></td>
      <td><div class='inline'><p>Convenience method to log info messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#log_warn-instance_method" title="Mongo::Loggable#log_warn (method)">#log_warn</a></td>
      <td><div class='inline'><p>Convenience method to log warn messages with the standard prefix.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../../Loggable.html#logger-instance_method" title="Mongo::Loggable#logger (method)">#logger</a></td>
      <td><div class='inline'><p>Get the logger instance.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="../../Loggable.html#_mongo_log_prefix-instance_method" title="Mongo::Loggable#_mongo_log_prefix (method)">#_mongo_log_prefix</a>,
        <a class='i_m priv' href="../../Loggable.html#format_message-instance_method" title="Mongo::Loggable#format_message (method)">#format_message</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Explainable.html" title="Mongo::Collection::View::Explainable (module)"><code>Explainable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Explainable.html#explain-instance_method" title="Mongo::Collection::View::Explainable#explain (method)">#explain</a></td>
      <td><div class='inline'><p>Get the query plan for the query.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Explainable.html#explain_options-instance_method" title="Mongo::Collection::View::Explainable#explain_options (method)">#explain_options</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Iterable.html" title="Mongo::Collection::View::Iterable (module)"><code>Iterable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Iterable.html#close_query-instance_method" title="Mongo::Collection::View::Iterable#close_query (method)">#close_query</a></td>
      <td><div class='inline'><p>Cleans up resources associated with this query.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Iterable.html#each-instance_method" title="Mongo::Collection::View::Iterable#each (method)">#each</a></td>
      <td><div class='inline'><p>Iterate through documents returned by a query with this <a href="../View.html" title="Mongo::Collection::View (class)"><code>::Mongo::Collection::View</code></a>.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Iterable.html#kill_cursors-instance_method" title="Mongo::Collection::View::Iterable#kill_cursors (method)">#kill_cursors</a></td>
      <td><div class='inline'><p>Alias for <a href="Iterable.html#close_query-instance_method" title="Mongo::Collection::View::Iterable#close_query (method)">Iterable#close_query</a>.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Iterable.html#cache_options-instance_method" title="Mongo::Collection::View::Iterable#cache_options (method)">#cache_options</a>,
        <a class='i_m priv' href="Iterable.html#cached_cursor-instance_method" title="Mongo::Collection::View::Iterable#cached_cursor (method)">#cached_cursor</a>,
        <a class='i_m priv' href="Iterable.html#compute_limit_for_cached_query-instance_method" title="Mongo::Collection::View::Iterable#compute_limit_for_cached_query (method)">#compute_limit_for_cached_query</a>,
        <a class='i_m priv' href="Iterable.html#initial_query_op-instance_method" title="Mongo::Collection::View::Iterable#initial_query_op (method)">#initial_query_op</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Iterable.html#maybe_set_tailable_options-instance_method" title="Mongo::Collection::View::Iterable#maybe_set_tailable_options (method)">#maybe_set_tailable_options</a></td>
      <td><div class='inline'><p>Add tailable cusror options to the command specifiction if needed.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Iterable.html#new_cursor_for_iteration-instance_method" title="Mongo::Collection::View::Iterable#new_cursor_for_iteration (method)">#new_cursor_for_iteration</a></td>
      <td><div class='inline'><p>Start a new cursor for use when iterating (via #each).</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Iterable.html#oplog_replay-instance_method" title="Mongo::Collection::View::Iterable#oplog_replay (method)">#oplog_replay</a>,
        <a class='i_m priv' href="Iterable.html#select_cursor-instance_method" title="Mongo::Collection::View::Iterable#select_cursor (method)">#select_cursor</a>,
        <a class='i_m priv' href="Iterable.html#send_initial_query-instance_method" title="Mongo::Collection::View::Iterable#send_initial_query (method)">#send_initial_query</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../../CursorHost.html" title="Mongo::CursorHost (module)"><code>::Mongo::CursorHost</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m nodoc' href="../../CursorHost.html#validate_timeout_mode!-instance_method" title="Mongo::CursorHost#validate_timeout_mode! (method)">#validate_timeout_mode!</a></td>
      <td><div class='inline'><p>Ensure the timeout mode is appropriate for other options that have been given.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Immutable.html" title="Mongo::Collection::View::Immutable (module)"><code>Immutable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Immutable.html#configure-instance_method" title="Mongo::Collection::View::Immutable#configure (method)">#configure</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(view, pipeline, options = {})  &#x21d2; <code>Aggregation</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Initialize the aggregation for the provided collection view, pipeline and options.</p>

  </div>
</div>
<div class='tags'>
    <div class='examples'>
    <p class='tag_title'>Examples:</p>
        <p class='example_title'><div class='inline'>
<p>Create the new aggregation view.</p>
</div></p>
      <pre class='example code ruby'><code><span class='const'>Aggregation</span>.<span class='id identifier rubyid_view'><a href="Aggregation/Behavior.html#view-instance_method" title="Mongo::Collection::View::Aggregation::Behavior#view (method)">view</a></span>.<span class='id identifier rubyid_new'><a href="../View.html#new-class_method" title="Mongo::Collection::View.new (method)">new</a></span>(<span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span><span class='comma'>,</span> <span class='id identifier rubyid_pipeline'><a href="#pipeline-instance_method" title="Mongo::Collection::View::Aggregation#pipeline (method)">pipeline</a></span>)</code></pre>
  </div>
<p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>view</span>
    <span class='type'>(<a href="../View.html" title="Mongo::Collection::View (class)">Collection::View</a>)</span>
&mdash;    <div class='inline'>
<p>The collection view.</p>
</div>
  </li>
  <li>
    <span class='name'>pipeline</span>
    <span class='type'>(<code>Array</code>&lt;<code>Hash</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>The pipeline of operations.</p>
</div>
  </li>
  <li>
    <span class='name'>options</span>
    <span class='type'>(<code>Hash</code>)</span>
    <em class='default'>(defaults to: <tt>{}</tt>)</em>
&mdash;    <div class='inline'>
<p>The aggregation options.</p>
</div>
  </li>
</ul>
    <p class='tag_title'>Options Hash (<tt>options</tt>):</p>
    <ul class='option'>
        <li>
          <span class='name'>:allow_disk_use</span>
          <span class='type'>(<code>true</code>, <code>false</code>)</span>
            &mdash; <div class='inline'>
<p>Set to true if disk usage is allowed during the aggregation.</p>
</div>        </li>
        <li>
          <span class='name'>:batch_size</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>The number of documents to return per batch.</p>
</div>        </li>
        <li>
          <span class='name'>:bypass_document_validation</span>
          <span class='type'>(<code>true</code>, <code>false</code>)</span>
            &mdash; <div class='inline'>
<p>Whether or not to skip document level validation.</p>
</div>        </li>
        <li>
          <span class='name'>:collation</span>
          <span class='type'>(<code>Hash</code>)</span>
            &mdash; <div class='inline'>
<p>The collation to use.</p>
</div>        </li>
        <li>
          <span class='name'>:comment</span>
          <span class='type'>(<code>Object</code>)</span>
            &mdash; <div class='inline'>
<p>A user-provided comment to attach to this command.</p>
</div>        </li>
        <li>
          <span class='name'>:hint</span>
          <span class='type'>(<code>String</code>)</span>
            &mdash; <div class='inline'>
<p>The index to use for the aggregation.</p>
</div>        </li>
        <li>
          <span class='name'>:let</span>
          <span class='type'>(<code>Hash</code>)</span>
            &mdash; <div class='inline'>
<p>Mapping of variables to use in the pipeline. See the server documentation for details.</p>
</div>        </li>
        <li>
          <span class='name'>:max_time_ms</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>The maximum amount of time in milliseconds to allow the aggregation to run. This option is deprecated, use <code>:timeout_ms</code> instead.</p>
</div>        </li>
        <li>
          <span class='name'>:session</span>
          <span class='type'>(<a href="../../Session.html" title="Mongo::Session (class)">Session</a>)</span>
            &mdash; <div class='inline'>
<p>The session to use.</p>
</div>        </li>
        <li>
          <span class='name'>:timeout_mode</span>
          <span class='type'>(<code>:cursor_lifetime</code> | <code>:iteration</code>)</span>
            &mdash; <div class='inline'>
<p>How to interpret <code>:timeout_ms</code> (whether it applies to the lifetime of the cursor, or per iteration).</p>
</div>        </li>
        <li>
          <span class='name'>:timeout_ms</span>
          <span class='type'>(<code>Integer</code>)</span>
            &mdash; <div class='inline'>
<p>The operation timeout in milliseconds. Must be a non-negative integer. An explicit value of 0 means infinite. The default value is unset which means the value is inherited from the collection or the database or the client.</p>
</div>        </li>
    </ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/aggregation.rb#L71-L78'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='71' data-end='78'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/aggregation.rb', line 71</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span><span class='comma'>,</span> <span class='id identifier rubyid_pipeline'><a href="#pipeline-instance_method" title="Mongo::Collection::View::Aggregation#pipeline (method)">pipeline</a></span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="../../Collection.html#options-instance_method" title="Mongo::Collection#options (method)">options</a></span> <span class='op'>=</span> {})
  <span class='id identifier rubyid_perform_setup'>perform_setup</span>(<span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="../../Collection.html#options-instance_method" title="Mongo::Collection#options (method)">options</a></span>) <span class='kw'>do</span>
    <span class='ivar'>@pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'><a href="#pipeline-instance_method" title="Mongo::Collection::View::Aggregation#pipeline (method)">pipeline</a></span>.<span class='id identifier rubyid_dup'>dup</span>
    <span class='kw'>unless</span> <span class='const'><a href="../../../Mongo.html" title="Mongo (module)">Mongo</a></span>.<span class='id identifier rubyid_broken_view_aggregate'>broken_view_aggregate</span> <span class='op'>||</span> <span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span>.<span class='id identifier rubyid_filter'><a href="../View.html#filter-instance_method" title="Mongo::Collection::View#filter (method)">filter</a></span>.<span class='id identifier rubyid_empty?'>empty?</span>
      <span class='ivar'>@pipeline</span>.<span class='id identifier rubyid_unshift'>unshift</span>(<span class='symbeg'>:</span><span class='gvar'>$match</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span>.<span class='id identifier rubyid_filter'><a href="../View.html#filter-instance_method" title="Mongo::Collection::View#filter (method)">filter</a></span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="pipeline-instance_method">
  <h3 class='signature ro first'>
    #<strong>pipeline</strong>  &#x21d2; <code>Array</code>&lt;<code>Hash</code>&gt;  <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Array</code>&lt;<code>Hash</code>&gt;)</span>
&mdash;    <div class='inline'>
<p>pipeline The aggregation pipeline.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/aggregation.rb#L32-L32'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='32' data-end='32'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/aggregation.rb', line 32</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pipeline'>pipeline</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="effective_read_preference-instance_method">
  <h3 class='signature priv first'>
    #<strong>effective_read_preference</strong>(connection)  &#x21d2; <code>Hash</code> | <code>nil</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return effective read preference for the operation.</p>

<p>If the pipeline contains $merge or $out, and read preference specified by user is secondary or secondary_preferred, and target server is below 5.0, than this method returns primary read preference, because the aggregation will be routed to primary. Otherwise return the original read preference.</p>

<p>See <a href="https://github.com/mongodb/specifications/blob/master/source/crud/crud.md#read-preferences-and-server-selection">github.com/mongodb/specifications/blob/master/source/crud/crud.md#read-preferences-and-server-selection</a></p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>connection</span>
    <span class='type'>(<a href="../../Server/Connection.html" title="Mongo::Server::Connection (class)">Server::Connection</a>)</span>
&mdash;    <div class='inline'>
<p>The connection which will be used for the operation.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code> | <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>read preference hash that should be sent with this command.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/aggregation.rb#L104-L121'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='104' data-end='121'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/aggregation.rb', line 104</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_effective_read_preference'>effective_read_preference</span>(<span class='id identifier rubyid_connection'>connection</span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span>.<span class='id identifier rubyid_read_preference'><a href="../../Collection.html#read_preference-instance_method" title="Mongo::Collection#read_preference (method)">read_preference</a></span>
  <span class='kw'>return</span> <span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span>.<span class='id identifier rubyid_read_preference'><a href="../../Collection.html#read_preference-instance_method" title="Mongo::Collection#read_preference (method)">read_preference</a></span> <span class='kw'>unless</span> <span class='id identifier rubyid_write?'>write?</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span>.<span class='id identifier rubyid_read_preference'><a href="../../Collection.html#read_preference-instance_method" title="Mongo::Collection#read_preference (method)">read_preference</a></span> <span class='kw'>unless</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_secondary'>secondary</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_secondary_preferred'>secondary_preferred</span>].<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span>.<span class='id identifier rubyid_read_preference'><a href="../../Collection.html#read_preference-instance_method" title="Mongo::Collection#read_preference (method)">read_preference</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_mode'>mode</span>])

  <span class='id identifier rubyid_primary_read_preference'>primary_read_preference</span> <span class='op'>=</span> {<span class='label'>mode:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary'>primary</span>}
  <span class='id identifier rubyid_description'>description</span> <span class='op'>=</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_description'>description</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_primary?'>primary?</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Routing the Aggregation operation to the primary server</span><span class='tstring_end'>&quot;</span></span>)
    <span class='id identifier rubyid_primary_read_preference'>primary_read_preference</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_mongos?'>mongos?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_description'>description</span>.<span class='id identifier rubyid_features'>features</span>.<span class='id identifier rubyid_merge_out_on_secondary_enabled?'>merge_out_on_secondary_enabled?</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Routing the Aggregation operation to the primary server</span><span class='tstring_end'>&quot;</span></span>)
    <span class='id identifier rubyid_primary_read_preference'>primary_read_preference</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span>.<span class='id identifier rubyid_read_preference'><a href="../../Collection.html#read_preference-instance_method" title="Mongo::Collection#read_preference (method)">read_preference</a></span>
  <span class='kw'>end</span>

<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="initial_query_op-instance_method">
  <h3 class='signature priv'>
    #<strong>initial_query_op</strong>(session, read_preference = nil)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/aggregation.rb#L86-L88'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='86' data-end='88'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/aggregation.rb', line 86</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initial_query_op'>initial_query_op</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_read_preference'><a href="../../Collection.html#read_preference-instance_method" title="Mongo::Collection#read_preference (method)">read_preference</a></span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='const'><a href="../../Operation.html" title="Mongo::Operation (module)">Operation</a></span><span class='op'>::</span><span class='const'><a href="../../Operation/Aggregate.html" title="Mongo::Operation::Aggregate (class)">Aggregate</a></span>.<span class='id identifier rubyid_new'><a href="../../Operation/Specifiable.html#initialize-instance_method" title="Mongo::Operation::Specifiable#initialize (method)">new</a></span>(<span class='id identifier rubyid_aggregate_spec'>aggregate_spec</span>(<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_read_preference'><a href="../../Collection.html#read_preference-instance_method" title="Mongo::Collection#read_preference (method)">read_preference</a></span>))
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="new-instance_method">
  <h3 class='signature priv'>
    #<strong>new</strong>(options)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/aggregation.rb#L82-L84'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='82' data-end='84'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/aggregation.rb', line 82</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_options'><a href="../../Collection.html#options-instance_method" title="Mongo::Collection#options (method)">options</a></span>)
  <span class='const'>Aggregation</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Mongo::Collection::View::Aggregation.new (method)">new</a></span>(<span class='id identifier rubyid_view'><a href="../View.html#view-instance_method" title="Mongo::Collection::View#view (method)">view</a></span><span class='comma'>,</span> <span class='id identifier rubyid_pipeline'><a href="#pipeline-instance_method" title="Mongo::Collection::View::Aggregation#pipeline (method)">pipeline</a></span><span class='comma'>,</span> <span class='id identifier rubyid_options'><a href="../../Collection.html#options-instance_method" title="Mongo::Collection#options (method)">options</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="send_initial_query-instance_method">
  <h3 class='signature priv'>
    #<strong>send_initial_query</strong>(server, context, operation: nil)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Since:</p>
<ul class='since'>
  <li>
    <div class='inline'>
<p>2.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/mongodb/mongo-ruby-driver/blob/master/lib/mongo/collection/view/aggregation.rb#L123-L145'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='123' data-end='145'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/mongo/collection/view/aggregation.rb', line 123</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_send_initial_query'>send_initial_query</span>(<span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='label'>operation:</span> <span class='kw'>nil</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_load_balancer?'>load_balancer?</span>
    <span class='comment'># Connection will be checked in when cursor is drained.
</span>    <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_pool'>pool</span>.<span class='id identifier rubyid_check_out'>check_out</span>(<span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>)
    <span class='id identifier rubyid_initial_query_op'><a href="#initial_query_op-instance_method" title="Mongo::Collection::View::Aggregation#initial_query_op (method)">initial_query_op</a></span>(
      <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span>
      <span class='id identifier rubyid_effective_read_preference'><a href="#effective_read_preference-instance_method" title="Mongo::Collection::View::Aggregation#effective_read_preference (method)">effective_read_preference</a></span>(<span class='id identifier rubyid_connection'>connection</span>)
    ).<span class='id identifier rubyid_execute_with_connection'>execute_with_connection</span>(
      <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span>
      <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>
    )
  <span class='kw'>else</span>
    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_with_connection'>with_connection</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_connection'>connection</span><span class='op'>|</span>
      <span class='id identifier rubyid_initial_query_op'><a href="#initial_query_op-instance_method" title="Mongo::Collection::View::Aggregation#initial_query_op (method)">initial_query_op</a></span>(
        <span class='id identifier rubyid_context'>context</span>.<span class='id identifier rubyid_session'>session</span><span class='comma'>,</span>
        <span class='id identifier rubyid_effective_read_preference'><a href="#effective_read_preference-instance_method" title="Mongo::Collection::View::Aggregation#effective_read_preference (method)">effective_read_preference</a></span>(<span class='id identifier rubyid_connection'>connection</span>)
      ).<span class='id identifier rubyid_execute_with_connection'>execute_with_connection</span>(
        <span class='id identifier rubyid_connection'>connection</span><span class='comma'>,</span>
        <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span>
      )
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>