<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: WEBrick::HTTPProxyServer &mdash; webrick Ruby-2.1.10 p492</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/custom.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/common.css' />

<script type='text/javascript'>
  var pathId = "WEBrick::HTTPProxyServer",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
  <svg id='y_wait' class='' viewBox='0 0 90 90'></svg>
  <div id='tbl_cont'>
    <div id='y_list' class='d h'>
      <button id='list_sizer' class='y_sizer' title='LIST Resizer'></button>
      <header id='list_header'>
        <div id='list_title'>&#160;</div>
        <div id='list_menu'><span>&#160;</span></div>
        <input  id='list_search_text' type='search' placeholder='Search' size='12' value='' autocomplete='off' class='search_input'/>
        <svg id='list_search_icon' viewBox='0 0 30 30'>
          <path class='s_main' d='M21.189,17.213C22.022,15.726,22.5,14.014,22.5,12.188C22.5,6.493,17.884,1.875,12.188,1.875S1.875,6.493,1.875,12.188C1.875,17.882,6.491,22.5,12.188,22.5c1.826,0,3.536-0.48,5.025-1.311l6.113,6.113C23.873,27.851,24.593,28.125,25.313,28.125s1.44-0.274,1.989-0.823c1.099-1.099,1.099-2.878,0-3.977L21.189,17.213z M12.188,19.329c-3.943,0-7.14-3.197-7.14-7.142c0.0-3.943,3.197-7.14,7.14-7.14c3.941,0,7.14,3.195,7.14,7.14C19.328,16.133,16.129,19.329,12.188,19.329z'/>
          <path class='s_clear' d='M 4.414, 1.586 A 1,1 0 1,0 1.586, 4.414 L 21.586,24.414 A 1,1 0 1,0 24.414,21.586 z' />
          <path class='s_clear' d='M 1.586,21.586 A 1,1 0 1,0 4.414,24.414 L 24.414, 4.414 A 1,1 0 1,0 21.586, 1.586 z' />
        </svg>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All'></button>
      </header>
      <nav id= 'list_nav' class='y_nav l_nav'>
        <ul id='list_items'></ul>
      </nav>
    </div>
    <div id='y_toc' class='f h'>
      <button id='toc_sizer' class='y_sizer' title='TOC Resizer'></button>
      <header id='toc_header'>
        <div>Table of Contents</div>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All' ></button>
      </header>
      <nav id= 'toc_nav' class='y_nav t_nav'>
      <ol id='toc_items'></ol>
      </nav>
    </div>
    <div id='y_main' tabindex='-1'>
      <header id='y_header'>
        <div id='y_menu'>
          <a href='../../../index.html'>Home</a> &raquo; 
          <a href='../../index.html'>Ruby-2.1.10</a> &raquo; 
          <a href='../index.html'>webrick</a> &raquo; 
          <a href='../_index.html'>Index (H)</a> &raquo; 
          <a href="../WEBrick.html" title="WEBrick (module)">WEBrick</a> &raquo; 
          <span class='title'>HTTPProxyServer</span>
        </div>

        <div id='y_measure_em' class='y_measure'></div>
        <div id='y_measure_vh' class='y_measure'></div>
        <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
        <a id='list_href' href="../class_list.html"></a>
        <div id='hdr_button'>
          <button id='src' class='c' title='Source Show / Hide'>S<svg class='c' viewBox='0 0 36 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
              <rect x='20' y='0'  width='4'  height='28' rx='1.0' ry='1.0'/>
            </svg><svg class='o' viewBox='0 0 34 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
            </svg></button>
          <button id='list_loc' class='d' title='LIST Location'>L<svg class='f' viewBox='0 0 36 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='toc_loc' class='f' title='TOC Location'>T<svg class='f' viewBox='0 0 34 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='list_vis' title='LIST Show / Hide'>LIST</button>
          <button id='toc_vis' title='TOC Show / Hide'>TOC</button>
        </div>
        <div id='y_debug'></div>
      </header>
<div id='content' class='class'>

<h1>Class: WEBrick::HTTPProxyServer</h1>

<table class='y_box'>
<colgroup>
  <col class='box_1' />
  <col class='box_2' />
</colgroup>
  <tr>
    <td class='box_1'>Inherits:</td>
    <td class='box_rel'>
      <span class='inheritName'><a href="HTTPServer.html" title="WEBrick::HTTPServer (class)">HTTPServer</a></span>
      <ul class='fullTree'>
        <li>Object</li>
        <li class='next'><a href="GenericServer.html" title="WEBrick::GenericServer (class)">GenericServer</a></li>
        <li class='next'><a href="HTTPServer.html" title="WEBrick::HTTPServer (class)">HTTPServer</a></li>
        <li class='next'>WEBrick::HTTPProxyServer</li>
      </ul>
      <a href='#' class='inheritanceTree'>show all</a>
    </td>
  </tr>





  <tr>
  <td class='box_1'>Defined in:</td>
  <td class='box_rel'><div class='box_max'>
<a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L70'>lib/webrick/httpproxy.rb</a></div>  </td>
  </tr>
</table>
<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>An HTTP Proxy server which proxies GET, HEAD and POST requests.</p>

<p>To create a simple proxy server:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>webrick</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>webrick/httpproxy</span><span class='tstring_end'>&#39;</span></span>

<span class='id identifier rubyid_proxy'>proxy</span> <span class='op'>=</span> <span class='const'><a href="../WEBrick.html" title="WEBrick (module)">WEBrick</a></span><span class='op'>::</span><span class='const'>HTTPProxyServer</span><span class='period'>.</span><span class='id identifier rubyid_new'><a href="#new-class_method" title="WEBrick::HTTPProxyServer.new (method)">new</a></span> <span class='label'>Port:</span> <span class='int'>8000</span>

<span class='id identifier rubyid_trap'>trap</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&#39;</span></span>  <span class='kw'>do</span> <span class='id identifier rubyid_proxy'>proxy</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>end</span>
<span class='id identifier rubyid_trap'>trap</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span> <span class='id identifier rubyid_proxy'>proxy</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>end</span>

<span class='id identifier rubyid_proxy'>proxy</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>
</code></pre>

<p>See <a href="#new-class_method" title="WEBrick::HTTPProxyServer.new (method)">HTTPProxyServer.new</a> for proxy-specific configuration items.</p>

<h3 id="label-Modifying+proxied+responses">Modifying proxied responses</h3>

<p>To modify content the proxy server returns use the
<code>:ProxyContentHandler</code> option:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_handler'>handler</span> <span class='op'>=</span> <span class='id identifier rubyid_proc'>proc</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='op'>|</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_res'>res</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>content-type</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/plain</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>then</span>
    <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nThis content was proxied!\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_proxy'>proxy</span> <span class='op'>=</span>
  <span class='const'><a href="../WEBrick.html" title="WEBrick (module)">WEBrick</a></span><span class='op'>::</span><span class='const'>HTTPProxyServer</span><span class='period'>.</span><span class='id identifier rubyid_new'><a href="#new-class_method" title="WEBrick::HTTPProxyServer.new (method)">new</a></span> <span class='label'>Port:</span> <span class='int'>8000</span><span class='comma'>,</span> <span class='label'>ProxyContentHandler:</span> <span class='id identifier rubyid_handler'>handler</span>
</code></pre>


  </div>
</div>
<div class="tags">
  
</div>
<h2 id='t2_cnst'>Constant Summary<small><a href="#" class="summary_toggle">collapse</a></small></h2>

  <dl class="constants summary full">
    <dt id='HopByHop-constant'>
      HopByHop =
    </dt>
    <dd>
      <div class="docstring">
  <div class="discussion">
    
<p>Some header fields should not be transferred.</p>


  </div>
</div>
<div class="tags">
  
</div>      <pre class='code'><span class='qwords_beg'>%w( </span><span class='tstring_content'>connection</span><span class='words_sep'> </span><span class='tstring_content'>keep-alive</span><span class='words_sep'> </span><span class='tstring_content'>proxy-authenticate</span><span class='words_sep'> </span><span class='tstring_content'>upgrade</span><span class='words_sep'>
</span><span class='tstring_content'>proxy-authorization</span><span class='words_sep'> </span><span class='tstring_content'>te</span><span class='words_sep'> </span><span class='tstring_content'>trailers</span><span class='words_sep'> </span><span class='tstring_content'>transfer-encoding</span><span class='words_sep'> )</span></pre>
    </dd>
    <dt id='ShouldNotTransfer-constant'>
      ShouldNotTransfer =
    </dt>
    <dd>
            <pre class='code'><span class='qwords_beg'>%w( </span><span class='tstring_content'>set-cookie</span><span class='words_sep'> </span><span class='tstring_content'>proxy-connection</span><span class='words_sep'> )</span></pre>
    </dd>
  </dl>





  <h2>Instance Attribute Summary</h2>
  
  <h3 class="inherited">Attributes inherited from <a href="GenericServer.html" title="WEBrick::GenericServer (class)">GenericServer</a></h3>
  <p class="inherited"><a href="GenericServer.html#config-instance_method" title="WEBrick::GenericServer#config (method)">#config</a>, <a href="GenericServer.html#listeners-instance_method" title="WEBrick::GenericServer#listeners (method)">#listeners</a>, <a href="GenericServer.html#logger-instance_method" title="WEBrick::GenericServer#logger (method)">#logger</a>, <a href="GenericServer.html#status-instance_method" title="WEBrick::GenericServer#status (method)">#status</a>, <a href="GenericServer.html#tokens-instance_method" title="WEBrick::GenericServer#tokens (method)">#tokens</a></p>

<h2>Class Method Summary
  <small><a href='#' class='summary_toggle'>collapse</a></small>
</h2>

  <ul class='summary'>
    <li>
      <span class="summary_signature">
        <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(config = {}, default = Config::HTTP)  &#x21d2; HTTPProxyServer </a>
      </span>
      <span class='note title constructor'>constructor</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Proxy server configurations.</p>
</div>
      </span>
    </li>
  </ul>
<h2>Instance Method Summary
  <small><a href='#' class='summary_toggle'>collapse</a></small>
</h2>

  <ul class='summary'>
    <li>
      <span class="summary_signature">
        <a href="#choose_header-instance_method" title="#choose_header (instance method)">#<strong>choose_header</strong>(src, dst)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#do_CONNECT-instance_method" title="#do_CONNECT (instance method)">#<strong>do_CONNECT</strong>(req, res)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#do_GET-instance_method" title="#do_GET (instance method)">#<strong>do_GET</strong>(req, res)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#do_HEAD-instance_method" title="#do_HEAD (instance method)">#<strong>do_HEAD</strong>(req, res)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#do_OPTIONS-instance_method" title="#do_OPTIONS (instance method)">#<strong>do_OPTIONS</strong>(req, res)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#do_POST-instance_method" title="#do_POST (instance method)">#<strong>do_POST</strong>(req, res)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#perform_proxy_request-instance_method" title="#perform_proxy_request (instance method)">#<strong>perform_proxy_request</strong>(req, res)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#proxy_auth-instance_method" title="#proxy_auth (instance method)">#<strong>proxy_auth</strong>(req, res)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#proxy_service-instance_method" title="#proxy_service (instance method)">#<strong>proxy_service</strong>(req, res)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#proxy_uri-instance_method" title="#proxy_uri (instance method)">#<strong>proxy_uri</strong>(req, res)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#service-instance_method" title="#service (instance method)">#<strong>service</strong>(req, res)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>:stopdoc:</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#set_cookie-instance_method" title="#set_cookie (instance method)">#<strong>set_cookie</strong>(src, dst)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'>
<p><code>Net::HTTP</code> is stupid about the multiple header fields.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#set_via-instance_method" title="#set_via (instance method)">#<strong>set_via</strong>(h)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#setup_proxy_header-instance_method" title="#setup_proxy_header (instance method)">#<strong>setup_proxy_header</strong>(req, res)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#setup_upstream_proxy_authentication-instance_method" title="#setup_upstream_proxy_authentication (instance method)">#<strong>setup_upstream_proxy_authentication</strong>(req, res, header)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#split_field-instance_method" title="#split_field (instance method)">#<strong>split_field</strong>(f)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
  </ul>



  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <a href="HTTPServer.html" title="WEBrick::HTTPServer (class)">HTTPServer</a></h3>
  <p class="inherited"><a href="HTTPServer.html#access_log-instance_method" title="WEBrick::HTTPServer#access_log (method)">#access_log</a>, <a href="HTTPServer.html#lookup_server-instance_method" title="WEBrick::HTTPServer#lookup_server (method)">#lookup_server</a>, <a href="HTTPServer.html#mount-instance_method" title="WEBrick::HTTPServer#mount (method)">#mount</a>, <a href="HTTPServer.html#mount_proc-instance_method" title="WEBrick::HTTPServer#mount_proc (method)">#mount_proc</a>, <a href="HTTPServer.html#run-instance_method" title="WEBrick::HTTPServer#run (method)">#run</a>, <a href="HTTPServer.html#search_servlet-instance_method" title="WEBrick::HTTPServer#search_servlet (method)">#search_servlet</a>, <a href="HTTPServer.html#unmount-instance_method" title="WEBrick::HTTPServer#unmount (method)">#unmount</a>, <a href="HTTPServer.html#virtual_host-instance_method" title="WEBrick::HTTPServer#virtual_host (method)">#virtual_host</a></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <a href="GenericServer.html" title="WEBrick::GenericServer (class)">GenericServer</a></h3>
  <p class="inherited"><a href="GenericServer.html#%5B%5D-instance_method" title="WEBrick::GenericServer#[] (method)">#[]</a>, <a href="GenericServer.html#accept_client-instance_method" title="WEBrick::GenericServer#accept_client (method)">#accept_client</a>, <a href="GenericServer.html#call_callback-instance_method" title="WEBrick::GenericServer#call_callback (method)">#call_callback</a>, <a href="GenericServer.html#listen-instance_method" title="WEBrick::GenericServer#listen (method)">#listen</a>, <a href="GenericServer.html#run-instance_method" title="WEBrick::GenericServer#run (method)">#run</a>, <a href="GenericServer.html#setup_ssl_context-instance_method" title="WEBrick::GenericServer#setup_ssl_context (method)">#setup_ssl_context</a>, <a href="GenericServer.html#shutdown-instance_method" title="WEBrick::GenericServer#shutdown (method)">#shutdown</a>, <a href="GenericServer.html#ssl_context-instance_method" title="WEBrick::GenericServer#ssl_context (method)">#ssl_context</a>, <a href="GenericServer.html#start-instance_method" title="WEBrick::GenericServer#start (method)">#start</a>, <a href="GenericServer.html#start_thread-instance_method" title="WEBrick::GenericServer#start_thread (method)">#start_thread</a>, <a href="GenericServer.html#stop-instance_method" title="WEBrick::GenericServer#stop (method)">#stop</a></p>
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>
  <section class='method_details first' id="new-class_method">
  <h3 class='signature first'>
  .<strong>new</strong>(config = {}, default = Config::HTTP)  &#x21d2; <tt><a href="" title="WEBrick::HTTPProxyServer (class)">HTTPProxyServer</a></tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Proxy server configurations.  The proxy server handles the following
configuration items in addition to those supported by HTTPServer:</p>
<dl class="rdoc-list note-list"><dt>:ProxyAuthProc
<dd>
<p>Called with a request and response to authorize a request</p>
</dd><dt>:ProxyVia
<dd>
<p>Appended to the via header</p>
</dd><dt>:ProxyURI
<dd>
<p>The proxy server&#39;s URI</p>
</dd><dt>:ProxyContentHandler
<dd>
<p>Called with a request and response and allows modification of the response</p>
</dd><dt>:ProxyTimeout
<dd>
<p>Sets the proxy timeouts to 30 seconds for open and 60 seconds for read
operations</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L85'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


85
86
87
88
89</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 85</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_config'>config</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='id identifier rubyid_default'>default</span><span class='op'>=</span><span class='const'>Config</span><span class='op'>::</span><span class='const'>HTTP</span><span class='rparen'>)</span>
  <span class='kw'>super</span><span class='lparen'>(</span><span class='id identifier rubyid_config'>config</span><span class='comma'>,</span> <span class='id identifier rubyid_default'>default</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='ivar'>@config</span>
  <span class='ivar'>@via</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:HTTPVersion</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:ServerName</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:Port</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
<h2 class='y_details'>Instance Method Details</h2>
  <section class='method_details first' id="choose_header-instance_method">
  <h3 class='signature first'>
  #<strong>choose_header</strong>(src, dst)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L244'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


244
245
246
247
248
249
250
251
252
253
254
255
256</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 244</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_choose_header'>choose_header</span><span class='lparen'>(</span><span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_dst'>dst</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_connections'>connections</span> <span class='op'>=</span> <span class='id identifier rubyid_split_field'>split_field</span><span class='lparen'>(</span><span class='id identifier rubyid_src'>src</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>connection</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_src'>src</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
    <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
    <span class='kw'>if</span> <span class='const'><a href="#HopByHop-constant" title="WEBrick::HTTPProxyServer::HopByHop (constant)">HopByHop</a></span><span class='period'>.</span><span class='id identifier rubyid_member?'>member?</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>          <span class='op'>||</span> <span class='comment'># RFC2616: 13.5.1
</span>       <span class='id identifier rubyid_connections'>connections</span><span class='period'>.</span><span class='id identifier rubyid_member?'>member?</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>       <span class='op'>||</span> <span class='comment'># RFC2616: 14.10
</span>       <span class='const'><a href="#ShouldNotTransfer-constant" title="WEBrick::HTTPProxyServer::ShouldNotTransfer (constant)">ShouldNotTransfer</a></span><span class='period'>.</span><span class='id identifier rubyid_member?'>member?</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>    <span class='comment'># pragmatics
</span>      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>choose_header: `</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_key'>key</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>next</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_dst'>dst</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="do_CONNECT-instance_method">
  <h3 class='signature'>
  #<strong>do_CONNECT</strong>(req, res)  
</h3>
<div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<tt>HTTPStatus::InternalServerError</tt>)</span>
  </li>
</ul>

</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L134'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 134</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_CONNECT'>do_CONNECT</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='comment'># Proxy Authentication
</span>  <span class='id identifier rubyid_proxy_auth'>proxy_auth</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_ua'>ua</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:WEBrickSocket</span><span class='rbracket'>]</span>  <span class='comment'># User-Agent
</span>  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="HTTPStatus.html" title="WEBrick::HTTPStatus (module)">HTTPStatus</a></span><span class='op'>::</span><span class='const'>InternalServerError</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[BUG] cannot get socket</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_ua'>ua</span>

  <span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='id identifier rubyid_req'>req</span><span class='period'>.</span><span class='id identifier rubyid_unparsed_uri'>unparsed_uri</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
  <span class='comment'># Proxy authentication for upstream proxy server
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_proxy'>proxy</span> <span class='op'>=</span> <span class='id identifier rubyid_proxy_uri'>proxy_uri</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_proxy_request_line'>proxy_request_line</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_content'> HTTP/1.0</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_proxy'>proxy</span><span class='period'>.</span><span class='id identifier rubyid_userinfo'>userinfo</span>
      <span class='id identifier rubyid_credentials'>credentials</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Basic </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='lbracket'>[</span><span class='id identifier rubyid_proxy'>proxy</span><span class='period'>.</span><span class='id identifier rubyid_userinfo'>userinfo</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>m</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='id identifier rubyid_proxy'>proxy</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_proxy'>proxy</span><span class='period'>.</span><span class='id identifier rubyid_port'>port</span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: upstream proxy is `</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_os'>os</span> <span class='op'>=</span> <span class='const'>TCPSocket</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='rparen'>)</span>     <span class='comment'># origin server
</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_proxy'>proxy</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: sending a Request-Line</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_os'>os</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_proxy_request_line'>proxy_request_line</span> <span class='op'>&lt;&lt;</span> <span class='const'><a href="../WEBrick.html#CRLF-constant" title="WEBrick::CRLF (constant)">CRLF</a></span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: &gt; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_proxy_request_line'>proxy_request_line</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_credentials'>credentials</span>
        <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: sending a credentials</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_os'>os</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Proxy-Authorization: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_credentials'>credentials</span> <span class='op'>&lt;&lt;</span> <span class='const'><a href="../WEBrick.html#CRLF-constant" title="WEBrick::CRLF (constant)">CRLF</a></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_os'>os</span> <span class='op'>&lt;&lt;</span> <span class='const'><a href="../WEBrick.html#CRLF-constant" title="WEBrick::CRLF (constant)">CRLF</a></span>
      <span class='id identifier rubyid_proxy_status_line'>proxy_status_line</span> <span class='op'>=</span> <span class='id identifier rubyid_os'>os</span><span class='period'>.</span><span class='id identifier rubyid_gets'>gets</span><span class='lparen'>(</span><span class='const'><a href="../WEBrick.html#LF-constant" title="WEBrick::LF (constant)">LF</a></span><span class='rparen'>)</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: read a Status-Line form the upstream server</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: &lt; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_proxy_status_line'>proxy_status_line</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>%r{</span><span class='tstring_content'>^HTTP/\d\.\d\s+200\s*</span><span class='regexp_end'>}</span></span> <span class='op'>=~</span> <span class='id identifier rubyid_proxy_status_line'>proxy_status_line</span>
        <span class='kw'>while</span> <span class='id identifier rubyid_line'>line</span> <span class='op'>=</span> <span class='id identifier rubyid_os'>os</span><span class='period'>.</span><span class='id identifier rubyid_gets'>gets</span><span class='lparen'>(</span><span class='const'><a href="../WEBrick.html#LF-constant" title="WEBrick::LF (constant)">LF</a></span><span class='rparen'>)</span>
          <span class='kw'>break</span> <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A(</span><span class='embexpr_beg'>#{</span><span class='const'><a href="../WEBrick.html#CRLF-constant" title="WEBrick::CRLF (constant)">CRLF</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>|</span><span class='embexpr_beg'>#{</span><span class='const'><a href="../WEBrick.html#LF-constant" title="WEBrick::LF (constant)">LF</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>)\z</span><span class='regexp_end'>/om</span></span> <span class='op'>=~</span> <span class='id identifier rubyid_line'>line</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="HTTPStatus.html" title="WEBrick::HTTPStatus (module)">HTTPStatus</a></span><span class='op'>::</span><span class='const'>BadGateway</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_content'>: succeeded</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'><a href="HTTPStatus.html" title="WEBrick::HTTPStatus (module)">HTTPStatus</a></span><span class='op'>::</span><span class='const'>RC_OK</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_content'>: failed `</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_set_error'>set_error</span><span class='lparen'>(</span><span class='id identifier rubyid_ex'>ex</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="HTTPStatus.html" title="WEBrick::HTTPStatus (module)">HTTPStatus</a></span><span class='op'>::</span><span class='const'><a href="HTTPStatus/EOFError.html" title="WEBrick::HTTPStatus::EOFError (class)">EOFError</a></span>
  <span class='kw'>ensure</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_handler'>handler</span> <span class='op'>=</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyContentHandler</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_handler'>handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_send_response'>send_response</span><span class='lparen'>(</span><span class='id identifier rubyid_ua'>ua</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_access_log'>access_log</span><span class='lparen'>(</span><span class='ivar'>@config</span><span class='comma'>,</span> <span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>

    <span class='comment'># Should clear request-line not to send the response twice.
</span>    <span class='comment'># see: HTTPServer#run
</span>    <span class='id identifier rubyid_req'>req</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='const'><a href="../WEBrick.html#NullReader-constant" title="WEBrick::NullReader (constant)">NullReader</a></span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_fds'>fds</span> <span class='op'>=</span> <span class='const'>IO</span><span class='op'>::</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_ua'>ua</span><span class='comma'>,</span> <span class='id identifier rubyid_os'>os</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_fds'>fds</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_member?'>member?</span><span class='lparen'>(</span><span class='id identifier rubyid_ua'>ua</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_buf'>buf</span> <span class='op'>=</span> <span class='id identifier rubyid_ua'>ua</span><span class='period'>.</span><span class='id identifier rubyid_sysread'>sysread</span><span class='lparen'>(</span><span class='int'>1024</span><span class='rparen'>)</span><span class='semicolon'>;</span>
        <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span><span class='embexpr_end'>}</span><span class='tstring_content'> byte from User-Agent</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_os'>os</span><span class='period'>.</span><span class='id identifier rubyid_syswrite'>syswrite</span><span class='lparen'>(</span><span class='id identifier rubyid_buf'>buf</span><span class='rparen'>)</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_fds'>fds</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_member?'>member?</span><span class='lparen'>(</span><span class='id identifier rubyid_os'>os</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_buf'>buf</span> <span class='op'>=</span> <span class='id identifier rubyid_os'>os</span><span class='period'>.</span><span class='id identifier rubyid_sysread'>sysread</span><span class='lparen'>(</span><span class='int'>1024</span><span class='rparen'>)</span><span class='semicolon'>;</span>
        <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span><span class='embexpr_end'>}</span><span class='tstring_content'> byte from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_ua'>ua</span><span class='period'>.</span><span class='id identifier rubyid_syswrite'>syswrite</span><span class='lparen'>(</span><span class='id identifier rubyid_buf'>buf</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
    <span class='id identifier rubyid_os'>os</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_content'>: closed</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="HTTPStatus.html" title="WEBrick::HTTPStatus (module)">HTTPStatus</a></span><span class='op'>::</span><span class='const'><a href="HTTPStatus/EOFError.html" title="WEBrick::HTTPStatus::EOFError (class)">EOFError</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="do_GET-instance_method">
  <h3 class='signature'>
  #<strong>do_GET</strong>(req, res)  
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L214'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


214
215
216
217
218</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 214</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_GET'>do_GET</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_perform_proxy_request'>perform_proxy_request</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_http'>http</span><span class='comma'>,</span> <span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span><span class='op'>|</span>
    <span class='id identifier rubyid_http'>http</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="do_HEAD-instance_method">
  <h3 class='signature'>
  #<strong>do_HEAD</strong>(req, res)  
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L220'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


220
221
222
223
224</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 220</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_HEAD'>do_HEAD</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_perform_proxy_request'>perform_proxy_request</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_http'>http</span><span class='comma'>,</span> <span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span><span class='op'>|</span>
    <span class='id identifier rubyid_http'>http</span><span class='period'>.</span><span class='id identifier rubyid_head'>head</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="do_OPTIONS-instance_method">
  <h3 class='signature'>
  #<strong>do_OPTIONS</strong>(req, res)  
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L232'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


232
233
234</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 232</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_OPTIONS'>do_OPTIONS</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_res'>res</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>allow</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GET,HEAD,POST,OPTIONS,CONNECT</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="do_POST-instance_method">
  <h3 class='signature'>
  #<strong>do_POST</strong>(req, res)  
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L226'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


226
227
228
229
230</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 226</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_POST'>do_POST</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_perform_proxy_request'>perform_proxy_request</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_http'>http</span><span class='comma'>,</span> <span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span><span class='op'>|</span>
    <span class='id identifier rubyid_http'>http</span><span class='period'>.</span><span class='id identifier rubyid_post'>post</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_req'>req</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="perform_proxy_request-instance_method">
  <h3 class='signature'>
  #<strong>perform_proxy_request</strong>(req, res)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L305'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 305</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_perform_proxy_request'>perform_proxy_request</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_uri'>uri</span> <span class='op'>=</span> <span class='id identifier rubyid_req'>req</span><span class='period'>.</span><span class='id identifier rubyid_request_uri'>request_uri</span>
  <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='id identifier rubyid_path'>path</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>?</span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span> <span class='kw'>if</span> <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span>
  <span class='id identifier rubyid_header'>header</span> <span class='op'>=</span> <span class='id identifier rubyid_setup_proxy_header'>setup_proxy_header</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_upstream'>upstream</span> <span class='op'>=</span> <span class='id identifier rubyid_setup_upstream_proxy_authentication'>setup_upstream_proxy_authentication</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='id identifier rubyid_http'>http</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_upstream'>upstream</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_upstream'>upstream</span><span class='period'>.</span><span class='id identifier rubyid_port'>port</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_http'>http</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyTimeout</span><span class='rbracket'>]</span>
      <span class='comment'>##################################   these issues are
</span>      <span class='id identifier rubyid_http'>http</span><span class='period'>.</span><span class='id identifier rubyid_open_timeout'>open_timeout</span> <span class='op'>=</span> <span class='int'>30</span>   <span class='comment'># secs  #   necessary (maybe because
</span>      <span class='id identifier rubyid_http'>http</span><span class='period'>.</span><span class='id identifier rubyid_read_timeout'>read_timeout</span> <span class='op'>=</span> <span class='int'>60</span>   <span class='comment'># secs  #   Ruby&#39;s bug, but why?)
</span>      <span class='comment'>##################################
</span>    <span class='kw'>end</span>
    <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='kw'>yield</span><span class='lparen'>(</span><span class='id identifier rubyid_http'>http</span><span class='comma'>,</span> <span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Persistent connection requirements are mysterious for me.
</span>  <span class='comment'># So I will close the connection in every response.
</span>  <span class='id identifier rubyid_res'>res</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>proxy-connection</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>close</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_res'>res</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>connection</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>close</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Convert Net::HTTP::HTTPResponse to WEBrick::HTTPResponse
</span>  <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
  <span class='id identifier rubyid_choose_header'>choose_header</span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_set_cookie'>set_cookie</span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_set_via'>set_via</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="proxy_auth-instance_method">
  <h3 class='signature'>
  #<strong>proxy_auth</strong>(req, res)  
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L102'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


102
103
104
105
106
107</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 102</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_proxy_auth'>proxy_auth</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_proc'>proc</span> <span class='op'>=</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyAuthProc</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_proc'>proc</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_req'>req</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>proxy-authorization</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="proxy_service-instance_method">
  <h3 class='signature'>
  #<strong>proxy_service</strong>(req, res)  
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L114'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 114</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_proxy_service'>proxy_service</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='comment'># Proxy Authentication
</span>  <span class='id identifier rubyid_proxy_auth'>proxy_auth</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>

  <span class='kw'>begin</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>do_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_req'>req</span><span class='period'>.</span><span class='id identifier rubyid_request_method'>request_method</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>NoMethodError</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="HTTPStatus.html" title="WEBrick::HTTPStatus (module)">HTTPStatus</a></span><span class='op'>::</span><span class='const'>MethodNotAllowed</span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unsupported method `</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_req'>req</span><span class='period'>.</span><span class='id identifier rubyid_request_method'>request_method</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_err'>err</span>
    <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_err'>err</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_err'>err</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="HTTPStatus.html" title="WEBrick::HTTPStatus (module)">HTTPStatus</a></span><span class='op'>::</span><span class='const'>ServiceUnavailable</span><span class='comma'>,</span> <span class='id identifier rubyid_err'>err</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
  <span class='kw'>end</span>

  <span class='comment'># Process contents
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_handler'>handler</span> <span class='op'>=</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyContentHandler</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_handler'>handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="proxy_uri-instance_method">
  <h3 class='signature'>
  #<strong>proxy_uri</strong>(req, res)  
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L109'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


109
110
111
112</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 109</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_proxy_uri'>proxy_uri</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='comment'># should return upstream proxy server&#39;s URI
</span>  <span class='kw'>return</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyURI</span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="service-instance_method">
  <h3 class='signature'>
  #<strong>service</strong>(req, res)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>:stopdoc:</p>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L92'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


92
93
94
95
96
97
98
99
100</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 92</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_service'>service</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_req'>req</span><span class='period'>.</span><span class='id identifier rubyid_request_method'>request_method</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_do_CONNECT'>do_CONNECT</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_req'>req</span><span class='period'>.</span><span class='id identifier rubyid_unparsed_uri'>unparsed_uri</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>%r!</span><span class='tstring_content'>^http://</span><span class='regexp_end'>!</span></span>
    <span class='id identifier rubyid_proxy_service'>proxy_service</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='kw'>super</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="set_cookie-instance_method">
  <h3 class='signature'>
  #<strong>set_cookie</strong>(src, dst)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class="docstring">
  <div class="discussion">
    
<p><code>Net::HTTP</code> is stupid about the multiple header fields. Here is workaround:</p>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L260'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


260
261
262
263
264
265
266
267
268
269
270
271
272
273
274</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 260</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_set_cookie'>set_cookie</span><span class='lparen'>(</span><span class='id identifier rubyid_src'>src</span><span class='comma'>,</span> <span class='id identifier rubyid_dst'>dst</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='id identifier rubyid_src'>src</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>set-cookie</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_cookies'>cookies</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>,\s*</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_token'>token</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^[^=]+;</span><span class='regexp_end'>/o</span></span> <span class='op'>=~</span> <span class='id identifier rubyid_token'>token</span>
        <span class='id identifier rubyid_cookies'>cookies</span><span class='lbracket'>[</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_token'>token</span>
      <span class='kw'>elsif</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>=</span><span class='regexp_end'>/o</span></span> <span class='op'>=~</span> <span class='id identifier rubyid_token'>token</span>
        <span class='id identifier rubyid_cookies'>cookies</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_token'>token</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_cookies'>cookies</span><span class='lbracket'>[</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_token'>token</span>
      <span class='kw'>end</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_dst'>dst</span><span class='period'>.</span><span class='id identifier rubyid_cookies'>cookies</span><span class='period'>.</span><span class='id identifier rubyid_replace'>replace</span><span class='lparen'>(</span><span class='id identifier rubyid_cookies'>cookies</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="set_via-instance_method">
  <h3 class='signature'>
  #<strong>set_via</strong>(h)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L276'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


276
277
278
279
280
281
282
283
284</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 276</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_set_via'>set_via</span><span class='lparen'>(</span><span class='id identifier rubyid_h'>h</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyVia</span><span class='rbracket'>]</span>
    <span class='kw'>if</span>  <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>via</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>via</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='ivar'>@via</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>via</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@via</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="setup_proxy_header-instance_method">
  <h3 class='signature'>
  #<strong>setup_proxy_header</strong>(req, res)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L286'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


286
287
288
289
290
291
292</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 286</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_setup_proxy_header'>setup_proxy_header</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='comment'># Choose header fields to transfer
</span>  <span class='id identifier rubyid_header'>header</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_choose_header'>choose_header</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_set_via'>set_via</span><span class='lparen'>(</span><span class='id identifier rubyid_header'>header</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_header'>header</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="setup_upstream_proxy_authentication-instance_method">
  <h3 class='signature'>
  #<strong>setup_upstream_proxy_authentication</strong>(req, res, header)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L294'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


294
295
296
297
298
299
300
301
302
303</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 294</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_setup_upstream_proxy_authentication'>setup_upstream_proxy_authentication</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_upstream'>upstream</span> <span class='op'>=</span> <span class='id identifier rubyid_proxy_uri'>proxy_uri</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_upstream'>upstream</span><span class='period'>.</span><span class='id identifier rubyid_userinfo'>userinfo</span>
      <span class='id identifier rubyid_header'>header</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>proxy-authorization</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Basic </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='lbracket'>[</span><span class='id identifier rubyid_upstream'>upstream</span><span class='period'>.</span><span class='id identifier rubyid_userinfo'>userinfo</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>m</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_upstream'>upstream</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='const'><a href="../WEBrick.html#FakeProxyURI-constant" title="WEBrick::FakeProxyURI (constant)">FakeProxyURI</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="split_field-instance_method">
  <h3 class='signature'>
  #<strong>split_field</strong>(f)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/ruby_2_1/lib/webrick/httpproxy.rb#L242'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


242</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/webrick/httpproxy.rb', line 242</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_split_field'>split_field</span><span class='lparen'>(</span><span class='id identifier rubyid_f'>f</span><span class='rparen'>)</span> <span class='id identifier rubyid_f'>f</span> <span class='op'>?</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>,\s+</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_collect'>collect</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span> <span class='id identifier rubyid_i'>i</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span> <span class='rbrace'>}</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<div id='footer'>
  Generated by
  <a href='http://yardoc.org' title='Yay! A Ruby Documentation Tool' target="_parent">yard</a>
  0.9.5 with <a href='https://msp-greg.github.io/yard-t2/' title='yard-t2' target="_parent">yard-t2</a> 0.6.0 (ruby-2.3.2p135)
</div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</div> <!-- tbl_cont -->
</body>
</html>