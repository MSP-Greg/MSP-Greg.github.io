<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Concurrent::ThreadSafe::Util::Adder &mdash; Concurrent Ruby master</title>

<link rel='stylesheet'  type='text/css' href='../../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Concurrent::ThreadSafe::Util::Adder",
    relpath = '../../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../../'>Concurrent</a> &raquo; 
      <a href='../../../_index.html#alpha_A'>Index (A)</a> &raquo; 
        <a href="../../../Concurrent.html" title="Concurrent (module)">Concurrent</a> &raquo; 
        <a href="../../ThreadSafe.html" title="Concurrent::ThreadSafe (module)">ThreadSafe</a> &raquo; 
        <a href="../Util.html" title="Concurrent::ThreadSafe::Util (module)">Util</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Adder&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Concurrent::ThreadSafe::Util::Adder</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          <a href="Striped64.html" title="Concurrent::ThreadSafe::Util::Striped64 (class)"><code>Striped64</code></a>,
          <a href="Volatile.html" title="Concurrent::ThreadSafe::Util::Volatile (module)"><code>Volatile</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="Striped64.html" title="Concurrent::ThreadSafe::Util::Striped64 (class)"><code>Striped64</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2 o'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="Striped64.html" title="Concurrent::ThreadSafe::Util::Striped64 (class)">Concurrent::ThreadSafe::Util::Striped64</a></span>
        <ul class='fullTree'>
          <li><a href="../../../Object.html" title="Object (class)"><code>::Object</code></a></li>
          <li class='next'><a href="Striped64.html" title="Concurrent::ThreadSafe::Util::Striped64 (class)">Concurrent::ThreadSafe::Util::Striped64</a></li>
          <li class='next'>Concurrent::ThreadSafe::Util::Adder</li>
        </ul>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb#L33'>lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>A Ruby port of the Doug Lea’s jsr166e.LongAdder class version 1.8 available in public domain.</p>

<p>Original source code available here: <a href="http://gee.cs.oswego.edu/cgi-bin/viewcvs.cgi/jsr166/src/jsr166e/LongAdder.java?revision=1.8">gee.cs.oswego.edu/cgi-bin/viewcvs.cgi/jsr166/src/jsr166e/LongAdder.java?revision=1.8</a></p>

<p>One or more variables that together maintain an initially zero sum. When updates (method <a href="#add-instance_method" title="Concurrent::ThreadSafe::Util::Adder#add (method)">#add</a>) are contended across threads, the set of variables may grow dynamically to reduce contention. Method <a href="#sum-instance_method" title="Concurrent::ThreadSafe::Util::Adder#sum (method)">#sum</a> returns the current total combined across the variables maintaining the sum.</p>

<p>This class is usually preferable to single <code>Atomic</code> reference when multiple threads update a common sum that is used for purposes such as collecting statistics, not for fine-grained synchronization control.  Under low update contention, the two classes have similar characteristics. But under high contention, expected throughput of this class is significantly higher, at the expense of higher space consumption.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
  <h3 class='inherited'><a href="Striped64.html" title="Concurrent::ThreadSafe::Util::Striped64 (class)"><code>Striped64</code></a> - Inherited</h3>
  <p  class='inherited'>
    <a href="Striped64.html#THREAD_LOCAL_KEY-constant" title="Concurrent::ThreadSafe::Util::Striped64::THREAD_LOCAL_KEY (constant)">THREAD_LOCAL_KEY</a>
  </p>
</div>

<h2 class='h2_sum' id='class_Method_summary'>Class Method Summary</h2>
<div class='div_sum'>

<h3 class='inherited'><a href="Striped64.html" title="Concurrent::ThreadSafe::Util::Striped64 (class)"><code>Striped64</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="Striped64.html#new-class_method" title="Concurrent::ThreadSafe::Util::Striped64.new (method)">.new</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Volatile.html" title="Concurrent::ThreadSafe::Util::Volatile (module)"><code>Volatile</code></a> - Extended</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Volatile.html#attr_volatile-instance_method" title="Concurrent::ThreadSafe::Util::Volatile#attr_volatile (method)">attr_volatile</a></td>
      <td><div class='inline'><p>Provides <code>volatile</code> (in the JVM’s sense) attribute accessors implemented atop of <a href="../../AtomicReference.html" title="Concurrent::AtomicReference (class)"><code>AtomicReference</code></a>.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_Attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>

<h3 class='inherited'><a href="Striped64.html" title="Concurrent::ThreadSafe::Util::Striped64 (class)"><code>Striped64</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro priv' href="Striped64.html#free%3F-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#free? (method)">#free?</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m rw priv' href="Striped64.html#hash_code-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#hash_code (method)">#hash_code</a></td>
      <td><div class='inline'><p>A thread-local hash code accessor.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m rw priv' href="Striped64.html#hash_code=-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#hash_code= (method)">#hash_code=</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#add-instance_method" title="#add (instance method)">#<strong>add</strong>(x)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Adds the given value.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#decrement-instance_method" title="#decrement (instance method)">#<strong>decrement</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#increment-instance_method" title="#increment (instance method)">#<strong>increment</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#reset-instance_method" title="#reset (instance method)">#<strong>reset</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#sum-instance_method" title="#sum (instance method)">#<strong>sum</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the current sum.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited'><a href="Striped64.html" title="Concurrent::ThreadSafe::Util::Striped64 (class)"><code>Striped64</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="Striped64.html#busy%3F-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#busy? (method)">#busy?</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Striped64.html#retry_update-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#retry_update (method)">#retry_update</a></td>
      <td><div class='inline'><p>Handles cases of updates involving initialization, resizing, creating new Cells, and/or contention.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Striped64.html#cas_base_computed-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#cas_base_computed (method)">#cas_base_computed</a>,
        <a class='i_m priv' href="Striped64.html#expand_table_unless_stale-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#expand_table_unless_stale (method)">#expand_table_unless_stale</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Striped64.html#internal_reset-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#internal_reset (method)">#internal_reset</a></td>
      <td><div class='inline'><p>Sets base and all <code>cells</code> to the given value.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Striped64.html#try_in_busy-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#try_in_busy (method)">#try_in_busy</a>,
        <a class='i_m priv' href="Striped64.html#try_initialize_cells-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#try_initialize_cells (method)">#try_initialize_cells</a>,
        <a class='i_m priv' href="Striped64.html#try_to_install_new_cell-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#try_to_install_new_cell (method)">#try_to_install_new_cell</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <p class='notice'>This class inherits a constructor from <a href="Striped64.html#new-class_method" title="Concurrent::ThreadSafe::Util::Striped64.new (method)">Concurrent::ThreadSafe::Util::Striped64</a></p>
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="add-instance_method">
  <h3 class='signature  first'>
    #<strong>add</strong>(x)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Adds the given value.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb#L35-L43'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='35' data-end='43'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb', line 35</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add'>add</span>(<span class='id identifier rubyid_x'>x</span>)
  <span class='kw'>if</span> (<span class='id identifier rubyid_current_cells'>current_cells</span> <span class='op'>=</span> <span class='id identifier rubyid_cells'>cells</span>) <span class='op'>||</span> <span class='op'>!</span><span class='id identifier rubyid_cas_base_computed'>cas_base_computed</span> {<span class='op'>|</span><span class='id identifier rubyid_current_base'>current_base</span><span class='op'>|</span> <span class='id identifier rubyid_current_base'>current_base</span> <span class='op'>+</span> <span class='id identifier rubyid_x'>x</span>}
    <span class='id identifier rubyid_was_uncontended'>was_uncontended</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='id identifier rubyid_hash'>hash</span>            <span class='op'>=</span> <span class='id identifier rubyid_hash_code'>hash_code</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_current_cells'>current_cells</span> <span class='op'>&amp;&amp;</span> (<span class='id identifier rubyid_cell'>cell</span> <span class='op'>=</span> <span class='id identifier rubyid_current_cells'>current_cells</span>.<span class='id identifier rubyid_volatile_get_by_hash'>volatile_get_by_hash</span>(<span class='id identifier rubyid_hash'>hash</span>)) <span class='op'>&amp;&amp;</span> (<span class='id identifier rubyid_was_uncontended'>was_uncontended</span> <span class='op'>=</span> <span class='id identifier rubyid_cell'>cell</span>.<span class='id identifier rubyid_cas_computed'>cas_computed</span> {<span class='op'>|</span><span class='id identifier rubyid_current_value'>current_value</span><span class='op'>|</span> <span class='id identifier rubyid_current_value'>current_value</span> <span class='op'>+</span> <span class='id identifier rubyid_x'>x</span>})
      <span class='id identifier rubyid_retry_update'>retry_update</span>(<span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_hash'>hash</span><span class='comma'>,</span> <span class='id identifier rubyid_was_uncontended'>was_uncontended</span>) {<span class='op'>|</span><span class='id identifier rubyid_current_value'>current_value</span><span class='op'>|</span> <span class='id identifier rubyid_current_value'>current_value</span> <span class='op'>+</span> <span class='id identifier rubyid_x'>x</span>}
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="decrement-instance_method">
  <h3 class='signature '>
    #<strong>decrement</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb#L49-L51'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='49' data-end='51'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb', line 49</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_decrement'>decrement</span>
  <span class='id identifier rubyid_add'><a href="#add-instance_method" title="Concurrent::ThreadSafe::Util::Adder#add (method)">add</a></span>(<span class='op'>-</span><span class='int'>1</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="increment-instance_method">
  <h3 class='signature '>
    #<strong>increment</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb#L45-L47'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='45' data-end='47'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb', line 45</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_increment'>increment</span>
  <span class='id identifier rubyid_add'><a href="#add-instance_method" title="Concurrent::ThreadSafe::Util::Adder#add (method)">add</a></span>(<span class='int'>1</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="reset-instance_method">
  <h3 class='signature '>
    #<strong>reset</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb#L68-L70'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='68' data-end='70'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb', line 68</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_reset'>reset</span>
  <span class='id identifier rubyid_internal_reset'>internal_reset</span>(<span class='int'>0</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="sum-instance_method">
  <h3 class='signature '>
    #<strong>sum</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the current sum.  The returned value is <em>NOT</em> an atomic snapshot: Invocation in the absence of concurrent updates returns an accurate result, but concurrent updates that occur while the sum is being calculated might not be incorporated.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb#L58-L66'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='58' data-end='66'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/adder.rb', line 58</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_sum'>sum</span>
  <span class='id identifier rubyid_x'>x</span> <span class='op'>=</span> <span class='id identifier rubyid_base'>base</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_current_cells'>current_cells</span> <span class='op'>=</span> <span class='id identifier rubyid_cells'>cells</span>
    <span class='id identifier rubyid_current_cells'>current_cells</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cell'>cell</span><span class='op'>|</span>
      <span class='id identifier rubyid_x'>x</span> <span class='op'>+=</span> <span class='id identifier rubyid_cell'>cell</span>.<span class='id identifier rubyid_value'>value</span> <span class='kw'>if</span> <span class='id identifier rubyid_cell'>cell</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_x'>x</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>