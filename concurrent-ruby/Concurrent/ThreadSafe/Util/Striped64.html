<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Concurrent::ThreadSafe::Util::Striped64 &mdash; Concurrent Ruby master</title>

<link rel='stylesheet'  type='text/css' href='../../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Concurrent::ThreadSafe::Util::Striped64",
    relpath = '../../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../../'>Concurrent</a> &raquo; 
      <a href='../../../_index.html#alpha_S'>Index (S)</a> &raquo; 
        <a href="../../../Concurrent.html" title="Concurrent (module)">Concurrent</a> &raquo; 
        <a href="../../ThreadSafe.html" title="Concurrent::ThreadSafe (module)">ThreadSafe</a> &raquo; 
        <a href="../Util.html" title="Concurrent::ThreadSafe::Util (module)">Util</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Striped64&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Concurrent::ThreadSafe::Util::Striped64</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a href="Striped64/Cell.html" title="Concurrent::ThreadSafe::Util::Striped64::Cell (class)"><code>Cell</code></a>      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Subclasses:</div>
        <div class='box_22'>
          <a href="Adder.html" title="Concurrent::ThreadSafe::Util::Adder (class)">Adder</a>
        </div>
      </td>
    </tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          <a href="Volatile.html" title="Concurrent::ThreadSafe::Util::Volatile (module)"><code>Volatile</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="../../../Object.html" title="Object (class)">Object</a></span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L77'>lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>A Ruby port of the Doug Lea’s jsr166e.Striped64 class version 1.6 available in public domain.</p>

<p>Original source code available here: <a href="http://gee.cs.oswego.edu/cgi-bin/viewcvs.cgi/jsr166/src/jsr166e/Striped64.java?revision=1.6">gee.cs.oswego.edu/cgi-bin/viewcvs.cgi/jsr166/src/jsr166e/Striped64.java?revision=1.6</a></p>

<p>Class holding common representation and mechanics for classes supporting dynamic striping on 64bit values.</p>

<p>This class maintains a lazily-initialized table of atomically updated variables, plus an extra <code>base</code> field. The table size is a power of two. Indexing uses masked per-thread hash codes. Nearly all methods on this class are private, accessed directly by subclasses.</p>

<p>Table entries are of class <a href="Striped64/Cell.html" title="Concurrent::ThreadSafe::Util::Striped64::Cell (class)"><code>Cell</code></a>; a variant of AtomicLong padded to reduce cache contention on most processors. Padding is overkill for most Atomics because they are usually irregularly scattered in memory and thus don’t interfere much with each other. But Atomic objects residing in arrays will tend to be placed adjacent to each other, and so will most often share cache lines (with a huge negative performance impact) without this precaution.</p>

<p>In part because <a href="Striped64/Cell.html" title="Concurrent::ThreadSafe::Util::Striped64::Cell (class)"><code>Cell</code></a>s are relatively large, we avoid creating them until they are needed. When there is no contention, all updates are made to the <code>base</code> field. Upon first contention (a failed CAS on <code>base</code> update), the table is initialized to size 2. The table size is doubled upon further contention until reaching the nearest power of two greater than or equal to the number of CPUS. Table slots remain empty (<code>nil</code>) until they are needed.</p>

<p>A single spinlock (<code>busy</code>) is used for initializing and resizing the table, as well as populating slots with new <a href="Striped64/Cell.html" title="Concurrent::ThreadSafe::Util::Striped64::Cell (class)"><code>Cell</code></a>s. There is no need for a blocking lock: When the lock is not available, threads try other slots (or the base). During these retries, there is increased contention and reduced locality, which is still better than alternatives.</p>

<p>Per-thread hash codes are initialized to random values. Contention and/or table collisions are indicated by failed CASes when performing an update operation (see method <a href="#retry_update-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#retry_update (method)">#retry_update</a>). Upon a collision, if the table size is less than the capacity, it is doubled in size unless some other thread holds the lock. If a hashed slot is empty, and lock is available, a new <a href="Striped64/Cell.html" title="Concurrent::ThreadSafe::Util::Striped64::Cell (class)"><code>Cell</code></a> is created. Otherwise, if the slot exists, a CAS is tried. Retries proceed by “double hashing”, using a secondary hash (XorShift) to try to find a free slot.</p>

<p>The table size is capped because, when there are more threads than CPUs, supposing that each thread were bound to a CPU, there would exist a perfect hash function mapping threads to slots that eliminates collisions. When we reach capacity, we search for this mapping by randomly varying the hash codes of colliding threads. Because search is random, and collisions only become known via CAS failures, convergence can be slow, and because threads are typically not bound to CPUS forever, may not occur at all. However, despite these limitations, observed contention rates are typically low in these cases.</p>

<p>It is possible for a <a href="Striped64/Cell.html" title="Concurrent::ThreadSafe::Util::Striped64::Cell (class)"><code>Cell</code></a> to become unused when threads that once hashed to it terminate, as well as in the case where doubling the table causes no thread to hash to it under expanded mask. We do not try to detect or remove such cells, under the assumption that for long-running instances, observed contention levels will recur, so the cells will eventually be needed again; and for short-lived ones, it does not matter.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='THREAD_LOCAL_KEY-constant' class='summary_signature'>THREAD_LOCAL_KEY =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>Static per-thread hash code key. Shared across all instances to reduce Thread locals pollution and because adjustments due to collisions in one table are likely to be appropriate for others.</p>

  </div>
</div>
    <a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L172-L172'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 172</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>.hash_code</span><span class='tstring_end'>&quot;</span></span>.<span class='id identifier rubyid_to_sym'>to_sym</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>  &#x21d2; Striped64 </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>

<h3 class='inherited'><a href="Volatile.html" title="Concurrent::ThreadSafe::Util::Volatile (module)"><code>Volatile</code></a> - Extended</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Volatile.html#attr_volatile-instance_method" title="Concurrent::ThreadSafe::Util::Volatile#attr_volatile (method)">attr_volatile</a></td>
      <td><div class='inline'><p>Provides <code>volatile</code> (in the JVM’s sense) attribute accessors implemented atop of <a href="../../AtomicReference.html" title="Concurrent::AtomicReference (class)"><code>AtomicReference</code></a>.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#free%3F-instance_method" title="#free? (instance method)">#<strong>free?</strong>  &#x21d2; Boolean </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature rw priv'>
      <a href="#hash_code-instance_method" title="#hash_code (instance method)">#<strong>hash_code</strong>  </a>
    </span>
    <span class='note title rw'>rw</span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>A thread-local hash code accessor.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature rw priv'>
      <a href="#hash_code=-instance_method" title="#hash_code= (instance method)">#<strong>hash_code=</strong>(hash)  </a>
    </span>
    <span class='note title rw'>rw</span>
    <span class='note title private'>private</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#busy%3F-instance_method" title="#busy? (instance method)">#<strong>busy?</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#retry_update-instance_method" title="#retry_update (instance method)">#<strong>retry_update</strong>(x, hash_code, was_uncontended)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Handles cases of updates involving initialization, resizing, creating new Cells, and/or contention.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#cas_base_computed-instance_method" title="#cas_base_computed (instance method)">#<strong>cas_base_computed</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#expand_table_unless_stale-instance_method" title="#expand_table_unless_stale (instance method)">#<strong>expand_table_unless_stale</strong>(current_cells)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#internal_reset-instance_method" title="#internal_reset (instance method)">#<strong>internal_reset</strong>(initial_value)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Sets base and all <code>cells</code> to the given value.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#try_in_busy-instance_method" title="#try_in_busy (instance method)">#<strong>try_in_busy</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#try_initialize_cells-instance_method" title="#try_initialize_cells (instance method)">#<strong>try_initialize_cells</strong>(x, hash)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#try_to_install_new_cell-instance_method" title="#try_to_install_new_cell (instance method)">#<strong>try_to_install_new_cell</strong>(new_cell, hash)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>  &#x21d2; <code>Striped64</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L112-L116'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='112' data-end='116'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 112</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'><a href="../../../Concurrent.html#initialize-instance_method" title="Concurrent#initialize (method)">initialize</a></span>
  <span class='kw'>super</span>()
  <span class='kw'>self</span>.<span class='id identifier rubyid_busy'>busy</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_base'>base</span> <span class='op'>=</span> <span class='int'>0</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="free?-instance_method">
  <h3 class='signature ro priv first'>
    #<strong>free?</strong>  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L199-L201'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='199' data-end='201'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 199</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_free?'>free?</span>
  <span class='op'>!</span><span class='id identifier rubyid_busy?'><a href="#busy%3F-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#busy? (method)">busy?</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="hash_code-instance_method">
  <h3 class='signature rw priv'>
    #<strong>hash_code</strong>   <span class="extras">(<span class='rw'>rw</span>, <span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>A thread-local hash code accessor. The code is initially random, but may be set to a different value upon collisions.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L176-L178'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='176' data-end='178'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 176</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_hash_code'>hash_code</span>
  <span class='const'>Thread</span>.<span class='id identifier rubyid_current'>current</span>[<span class='const'><a href="#THREAD_LOCAL_KEY-constant" title="Concurrent::ThreadSafe::Util::Striped64::THREAD_LOCAL_KEY (constant)">THREAD_LOCAL_KEY</a></span>] <span class='op'>||=</span> <span class='const'><a href="XorShiftRandom.html" title="Concurrent::ThreadSafe::Util::XorShiftRandom (module)">XorShiftRandom</a></span>.<span class='id identifier rubyid_get'><a href="XorShiftRandom.html#get-instance_method" title="Concurrent::ThreadSafe::Util::XorShiftRandom#get (method)">get</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="hash_code=-instance_method">
  <h3 class='signature rw priv'>
    #<strong>hash_code=</strong>(hash)   <span class="extras">(<span class='rw'>rw</span>, <span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L180-L182'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='180' data-end='182'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 180</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_hash_code='>hash_code=</span>(<span class='id identifier rubyid_hash'>hash</span>)
  <span class='const'>Thread</span>.<span class='id identifier rubyid_current'>current</span>[<span class='const'><a href="#THREAD_LOCAL_KEY-constant" title="Concurrent::ThreadSafe::Util::Striped64::THREAD_LOCAL_KEY (constant)">THREAD_LOCAL_KEY</a></span>] <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="busy?-instance_method">
  <h3 class='signature  first'>
    #<strong>busy?</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L110-L110'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='110' data-end='110'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 110</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_alias_method'>alias_method</span> <span class='symbeg'>:</span><span class='id identifier rubyid_busy?'>busy?</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_busy'>busy</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cas_base_computed-instance_method">
  <h3 class='signature priv'>
    #<strong>cas_base_computed</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L195-L197'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='195' data-end='197'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 195</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cas_base_computed'>cas_base_computed</span>
  <span class='id identifier rubyid_cas_base'>cas_base</span>(<span class='id identifier rubyid_current_base'>current_base</span> <span class='op'>=</span> <span class='id identifier rubyid_base'>base</span><span class='comma'>,</span> <span class='kw'>yield</span>(<span class='id identifier rubyid_current_base'>current_base</span>))
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="expand_table_unless_stale-instance_method">
  <h3 class='signature priv'>
    #<strong>expand_table_unless_stale</strong>(current_cells)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L215-L223'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='215' data-end='223'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 215</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_expand_table_unless_stale'>expand_table_unless_stale</span>(<span class='id identifier rubyid_current_cells'>current_cells</span>)
  <span class='id identifier rubyid_try_in_busy'><a href="#try_in_busy-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#try_in_busy (method)">try_in_busy</a></span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_current_cells'>current_cells</span> <span class='op'>==</span> <span class='id identifier rubyid_cells'>cells</span> <span class='comment'># Recheck under lock
</span>      <span class='id identifier rubyid_new_cells'>new_cells</span> <span class='op'>=</span> <span class='id identifier rubyid_current_cells'>current_cells</span>.<span class='id identifier rubyid_next_in_size_table'>next_in_size_table</span>
      <span class='id identifier rubyid_current_cells'>current_cells</span>.<span class='id identifier rubyid_each_with_index'>each_with_index</span> {<span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span> <span class='id identifier rubyid_new_cells'>new_cells</span>.<span class='id identifier rubyid_volatile_set'>volatile_set</span>(<span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span>)}
      <span class='kw'>self</span>.<span class='id identifier rubyid_cells'>cells</span> <span class='op'>=</span> <span class='id identifier rubyid_new_cells'>new_cells</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="internal_reset-instance_method">
  <h3 class='signature priv'>
    #<strong>internal_reset</strong>(initial_value)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Sets base and all <code>cells</code> to the given value.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L185-L193'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='185' data-end='193'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 185</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_internal_reset'>internal_reset</span>(<span class='id identifier rubyid_initial_value'>initial_value</span>)
  <span class='id identifier rubyid_current_cells'>current_cells</span> <span class='op'>=</span> <span class='id identifier rubyid_cells'>cells</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_base'>base</span>     <span class='op'>=</span> <span class='id identifier rubyid_initial_value'>initial_value</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_current_cells'>current_cells</span>
    <span class='id identifier rubyid_current_cells'>current_cells</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cell'>cell</span><span class='op'>|</span>
      <span class='id identifier rubyid_cell'>cell</span>.<span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_initial_value'>initial_value</span> <span class='kw'>if</span> <span class='id identifier rubyid_cell'>cell</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="retry_update-instance_method">
  <h3 class='signature '>
    #<strong>retry_update</strong>(x, hash_code, was_uncontended)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Handles cases of updates involving initialization, resizing, creating new Cells, and/or contention. See above for explanation. This method suffers the usual non-modularity problems of optimistic retry code, relying on rechecked sets of reads.</p>

<p>Arguments:</p>
<dl class="rdoc-list label-list"><dt><code>x</code></dt>
<dd>
<p>the value</p>
</dd><dt><code>hash_code</code></dt>
<dd>
<p>hash code used</p>
</dd><dt><code>x</code></dt>
<dd>
<p>false if CAS failed before call</p>
</dd></dl>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L131-L165'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='131' data-end='165'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 131</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_retry_update'>retry_update</span>(<span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_hash_code'><a href="#hash_code-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#hash_code (method)">hash_code</a></span><span class='comma'>,</span> <span class='id identifier rubyid_was_uncontended'>was_uncontended</span>) <span class='comment'># :yields: current_value
</span>  <span class='id identifier rubyid_hash'>hash</span>     <span class='op'>=</span> <span class='id identifier rubyid_hash_code'><a href="#hash_code-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#hash_code (method)">hash_code</a></span>
  <span class='id identifier rubyid_collided'>collided</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='comment'># True if last slot nonempty
</span>  <span class='kw'>while</span> <span class='kw'>true</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_current_cells'>current_cells</span> <span class='op'>=</span> <span class='id identifier rubyid_cells'>cells</span>
      <span class='kw'>if</span> <span class='op'>!</span>(<span class='id identifier rubyid_cell'>cell</span> <span class='op'>=</span> <span class='id identifier rubyid_current_cells'>current_cells</span>.<span class='id identifier rubyid_volatile_get_by_hash'>volatile_get_by_hash</span>(<span class='id identifier rubyid_hash'>hash</span>))
        <span class='kw'>if</span> <span class='id identifier rubyid_busy?'><a href="#busy%3F-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#busy? (method)">busy?</a></span>
          <span class='id identifier rubyid_collided'>collided</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='kw'>else</span> <span class='comment'># Try to attach new Cell
</span>          <span class='kw'>if</span> <span class='id identifier rubyid_try_to_install_new_cell'><a href="#try_to_install_new_cell-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#try_to_install_new_cell (method)">try_to_install_new_cell</a></span>(<span class='const'><a href="Striped64/Cell.html" title="Concurrent::ThreadSafe::Util::Striped64::Cell (class)">Cell</a></span>.<span class='id identifier rubyid_new'><a href="../../AtomicReference.html#new-class_method" title="Concurrent::AtomicReference.new (method)">new</a></span>(<span class='id identifier rubyid_x'>x</span>)<span class='comma'>,</span> <span class='id identifier rubyid_hash'>hash</span>) <span class='comment'># Optimistically create and try to insert new cell
</span>            <span class='kw'>break</span>
          <span class='kw'>else</span>
            <span class='kw'>redo</span> <span class='comment'># Slot is now non-empty
</span>          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_was_uncontended'>was_uncontended</span> <span class='comment'># CAS already known to fail
</span>        <span class='id identifier rubyid_was_uncontended'>was_uncontended</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='comment'># Continue after rehash
</span>      <span class='kw'>elsif</span> <span class='id identifier rubyid_cell'>cell</span>.<span class='id identifier rubyid_cas_computed'>cas_computed</span> {<span class='op'>|</span><span class='id identifier rubyid_current_value'>current_value</span><span class='op'>|</span> <span class='kw'>yield</span> <span class='id identifier rubyid_current_value'>current_value</span>}
        <span class='kw'>break</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_current_cells'>current_cells</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>&gt;=</span> <span class='const'><a href="../Util.html#CPU_COUNT-constant" title="Concurrent::ThreadSafe::Util::CPU_COUNT (constant)">CPU_COUNT</a></span> <span class='op'>||</span> <span class='id identifier rubyid_cells'>cells</span> <span class='op'>!=</span> <span class='id identifier rubyid_current_cells'>current_cells</span> <span class='comment'># At max size or stale
</span>        <span class='id identifier rubyid_collided'>collided</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_collided'>collided</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_expand_table_unless_stale'><a href="#expand_table_unless_stale-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#expand_table_unless_stale (method)">expand_table_unless_stale</a></span>(<span class='id identifier rubyid_current_cells'>current_cells</span>)
        <span class='id identifier rubyid_collided'>collided</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='kw'>redo</span> <span class='comment'># Retry with expanded table
</span>      <span class='kw'>else</span>
        <span class='id identifier rubyid_collided'>collided</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><a href="XorShiftRandom.html" title="Concurrent::ThreadSafe::Util::XorShiftRandom (module)">XorShiftRandom</a></span>.<span class='id identifier rubyid_xorshift'><a href="XorShiftRandom.html#xorshift-instance_method" title="Concurrent::ThreadSafe::Util::XorShiftRandom#xorshift (method)">xorshift</a></span>(<span class='id identifier rubyid_hash'>hash</span>)

    <span class='kw'>elsif</span> <span class='id identifier rubyid_try_initialize_cells'><a href="#try_initialize_cells-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#try_initialize_cells (method)">try_initialize_cells</a></span>(<span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_hash'>hash</span>) <span class='op'>||</span> <span class='id identifier rubyid_cas_base_computed'><a href="#cas_base_computed-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#cas_base_computed (method)">cas_base_computed</a></span> {<span class='op'>|</span><span class='id identifier rubyid_current_base'>current_base</span><span class='op'>|</span> <span class='kw'>yield</span> <span class='id identifier rubyid_current_base'>current_base</span>}
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_hash_code'><a href="#hash_code-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#hash_code (method)">hash_code</a></span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="try_in_busy-instance_method">
  <h3 class='signature priv'>
    #<strong>try_in_busy</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L234-L242'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='234' data-end='242'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 234</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_try_in_busy'>try_in_busy</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_cas_busy'>cas_busy</span>(<span class='kw'>false</span><span class='comma'>,</span> <span class='kw'>true</span>)
    <span class='kw'>begin</span>
      <span class='kw'>yield</span>
    <span class='kw'>ensure</span>
      <span class='kw'>self</span>.<span class='id identifier rubyid_busy'>busy</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="try_initialize_cells-instance_method">
  <h3 class='signature priv'>
    #<strong>try_initialize_cells</strong>(x, hash)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L203-L213'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='203' data-end='213'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 203</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_try_initialize_cells'>try_initialize_cells</span>(<span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_hash'>hash</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_free?'><a href="#free%3F-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#free? (method)">free?</a></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_cells'>cells</span>
    <span class='id identifier rubyid_try_in_busy'><a href="#try_in_busy-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#try_in_busy (method)">try_in_busy</a></span> <span class='kw'>do</span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_cells'>cells</span> <span class='comment'># Recheck under lock
</span>        <span class='id identifier rubyid_new_cells'>new_cells</span> <span class='op'>=</span> <span class='const'><a href="PowerOfTwoTuple.html" title="Concurrent::ThreadSafe::Util::PowerOfTwoTuple (class)">PowerOfTwoTuple</a></span>.<span class='id identifier rubyid_new'><a href="PowerOfTwoTuple.html#new-class_method" title="Concurrent::ThreadSafe::Util::PowerOfTwoTuple.new (method)">new</a></span>(<span class='int'>2</span>)
        <span class='id identifier rubyid_new_cells'>new_cells</span>.<span class='id identifier rubyid_volatile_set_by_hash'>volatile_set_by_hash</span>(<span class='id identifier rubyid_hash'>hash</span><span class='comma'>,</span> <span class='const'><a href="Striped64/Cell.html" title="Concurrent::ThreadSafe::Util::Striped64::Cell (class)">Cell</a></span>.<span class='id identifier rubyid_new'><a href="../../AtomicReference.html#new-class_method" title="Concurrent::AtomicReference.new (method)">new</a></span>(<span class='id identifier rubyid_x'>x</span>))
        <span class='kw'>self</span>.<span class='id identifier rubyid_cells'>cells</span> <span class='op'>=</span> <span class='id identifier rubyid_new_cells'>new_cells</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="try_to_install_new_cell-instance_method">
  <h3 class='signature priv'>
    #<strong>try_to_install_new_cell</strong>(new_cell, hash)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb#L225-L232'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='225' data-end='232'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/thread_safe/util/striped64.rb', line 225</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_try_to_install_new_cell'>try_to_install_new_cell</span>(<span class='id identifier rubyid_new_cell'>new_cell</span><span class='comma'>,</span> <span class='id identifier rubyid_hash'>hash</span>)
  <span class='id identifier rubyid_try_in_busy'><a href="#try_in_busy-instance_method" title="Concurrent::ThreadSafe::Util::Striped64#try_in_busy (method)">try_in_busy</a></span> <span class='kw'>do</span>
    <span class='comment'># Recheck under lock
</span>    <span class='kw'>if</span> (<span class='id identifier rubyid_current_cells'>current_cells</span> <span class='op'>=</span> <span class='id identifier rubyid_cells'>cells</span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_current_cells'>current_cells</span>.<span class='id identifier rubyid_volatile_get'>volatile_get</span>(<span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_current_cells'>current_cells</span>.<span class='id identifier rubyid_hash_to_index'>hash_to_index</span>(<span class='id identifier rubyid_hash'>hash</span>))
      <span class='id identifier rubyid_current_cells'>current_cells</span>.<span class='id identifier rubyid_volatile_set'>volatile_set</span>(<span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_new_cell'>new_cell</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>