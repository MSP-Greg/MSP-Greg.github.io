<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Concurrent::RubyExchanger &mdash; Concurrent RubyÂ master</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Concurrent::RubyExchanger",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Concurrent</a> &raquo; 
      <a href='../_index.html#alpha_R'>Index (R)</a> &raquo; 
        <a href="../Concurrent.html" title="Concurrent (module)">Concurrent</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>RubyExchanger&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Concurrent::RubyExchanger</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a href="RubyExchanger/Node.html" title="Concurrent::RubyExchanger::Node (class)"><code>Node</code></a>      </div>
    </td></tr>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          <a href="AbstractExchanger.html" title="Concurrent::AbstractExchanger (class)"><code>AbstractExchanger</code></a>,
          <a href="Synchronization/Object.html" title="Concurrent::Synchronization::Object (class)"><code>Synchronization::Object</code></a>,
          <a href="Synchronization/AbstractObject.html" title="Concurrent::Synchronization::AbstractObject (class)"><code>Synchronization::AbstractObject</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="AbstractExchanger.html" title="Concurrent::AbstractExchanger (class)"><code>AbstractExchanger</code></a>,
          <a href="Synchronization/Object.html" title="Concurrent::Synchronization::Object (class)"><code>Synchronization::Object</code></a>,
          <a href="Synchronization/Volatile.html" title="Concurrent::Synchronization::Volatile (module)"><code>Synchronization::Volatile</code></a>,
          <a href="Synchronization/AbstractObject.html" title="Concurrent::Synchronization::AbstractObject (class)"><code>Synchronization::AbstractObject</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2 o'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="AbstractExchanger.html" title="Concurrent::AbstractExchanger (class)">Concurrent::AbstractExchanger</a></span>
        <ul class='fullTree'>
          <li><a href="../Object.html" title="Object (class)"><code>::Object</code></a></li>
          <li class='next'><a href="Synchronization/AbstractObject.html" title="Concurrent::Synchronization::AbstractObject (class)">Concurrent::Synchronization::AbstractObject</a></li>
          <li class='next'><a href="Synchronization/Object.html" title="Concurrent::Synchronization::Object (class)">Concurrent::Synchronization::Object</a></li>
          <li class='next'><a href="AbstractExchanger.html" title="Concurrent::AbstractExchanger (class)">Concurrent::AbstractExchanger</a></li>
          <li class='next'>Concurrent::RubyExchanger</li>
        </ul>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/exchanger.rb#L129'>lib/concurrent-ruby/concurrent/exchanger.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>**Private Implementation:** This abstraction is a private, internal implementation detail. It should never be used directly.</p>
</div>
  </div>


  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
  <h3 class='inherited'><a href="AbstractExchanger.html" title="Concurrent::AbstractExchanger (class)"><code>AbstractExchanger</code></a> - Inherited</h3>
  <p  class='inherited'>
    <a class='priv ' href="AbstractExchanger.html#CANCEL-constant" title="Concurrent::AbstractExchanger::CANCEL (constant)">CANCEL</a>
  </p>
</div>

<h2 class='h2_sum' id='class_Attribute_summary'>Class Attribute Summary</h2>
<div class='div_sum'>

<h3 class='inherited'><a href="Synchronization/Object.html" title="Concurrent::Synchronization::Object (class)"><code>Synchronization::Object</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ro' href="Synchronization/Object.html#safe_initialization%3F-class_method" title="Concurrent::Synchronization::Object.safe_initialization? (method)">.safe_initialization?</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- class_attribute_summary -->

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>  &#x21d2; RubyExchanger </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>

<h3 class='inherited'><a href="AbstractExchanger.html" title="Concurrent::AbstractExchanger (class)"><code>AbstractExchanger</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="AbstractExchanger.html#new-class_method" title="Concurrent::AbstractExchanger.new (method)">.new</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Synchronization/Object.html" title="Concurrent::Synchronization::Object (class)"><code>Synchronization::Object</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="Synchronization/Object.html#atomic_attribute%3F-class_method" title="Concurrent::Synchronization::Object.atomic_attribute? (method)">.atomic_attribute?</a>,
        <a class='i_m ' href="Synchronization/Object.html#atomic_attributes-class_method" title="Concurrent::Synchronization::Object.atomic_attributes (method)">.atomic_attributes</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Synchronization/Object.html#attr_atomic-class_method" title="Concurrent::Synchronization::Object.attr_atomic (method)">.attr_atomic</a></td>
      <td><div class='inline'><p>Creates methods for reading and writing to a instance variable with volatile (Java) semantic as <code>.attr_volatile</code> does.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Synchronization/Object.html#attr_volatile-class_method" title="Concurrent::Synchronization::Object.attr_volatile (method)">.attr_volatile</a></td>
      <td><div class='inline'><p>Creates methods for reading and writing (as <code>attr_accessor</code> does) to a instance variable with volatile (Java) semantic.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Synchronization/Object.html#ensure_safe_initialization_when_final_fields_are_present-class_method" title="Concurrent::Synchronization::Object.ensure_safe_initialization_when_final_fields_are_present (method)">.ensure_safe_initialization_when_final_fields_are_present</a></td>
      <td><div class='inline'><p>For testing purposes, quite slow.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="Synchronization/Object.html#new-class_method" title="Concurrent::Synchronization::Object.new (method)">.new</a></td>
      <td><div class='inline'><p>Has to be called by children.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="Synchronization/Object.html#safe_initialization!-class_method" title="Concurrent::Synchronization::Object.safe_initialization! (method)">.safe_initialization!</a>,
        <a class='i_m priv' href="Synchronization/Object.html#define_initialize_atomic_fields-class_method" title="Concurrent::Synchronization::Object.define_initialize_atomic_fields (method)">.define_initialize_atomic_fields</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Synchronization/AbstractObject.html" title="Concurrent::Synchronization::AbstractObject (class)"><code>Synchronization::AbstractObject</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="Synchronization/AbstractObject.html#attr_volatile-class_method" title="Concurrent::Synchronization::AbstractObject.attr_volatile (method)">.attr_volatile</a>,
        <a class='i_m ' href="Synchronization/AbstractObject.html#new-class_method" title="Concurrent::Synchronization::AbstractObject.new (method)">.new</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature priv'>
      <a href="#do_exchange-instance_method" title="#do_exchange (instance method)">#<strong>do_exchange</strong>(value, timeout)  &#x21d2; Object, CANCEL </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Waits for another thread to arrive at this exchange point (unless the current thread is interrupted), and then transfers the given object to it, receiving its object in return.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited'><a href="AbstractExchanger.html" title="Concurrent::AbstractExchanger (class)"><code>AbstractExchanger</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="AbstractExchanger.html#exchange-instance_method" title="Concurrent::AbstractExchanger#exchange (method)">#exchange</a></td>
      <td><div class='inline'><p>Waits for another thread to arrive at this exchange point (unless the current thread is interrupted), and then transfers the given object to it, receiving its object in return.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="AbstractExchanger.html#exchange!-instance_method" title="Concurrent::AbstractExchanger#exchange! (method)">#exchange!</a></td>
      <td><div class='inline'><p>Waits for another thread to arrive at this exchange point (unless the current thread is interrupted), and then transfers the given object to it, receiving its object in return.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="AbstractExchanger.html#try_exchange-instance_method" title="Concurrent::AbstractExchanger#try_exchange (method)">#try_exchange</a></td>
      <td><div class='inline'><p>Waits for another thread to arrive at this exchange point (unless the current thread is interrupted), and then transfers the given object to it, receiving its object in return.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="AbstractExchanger.html#do_exchange-instance_method" title="Concurrent::AbstractExchanger#do_exchange (method)">#do_exchange</a></td>
      <td><div class='inline'><p>Waits for another thread to arrive at this exchange point (unless the current thread is interrupted), and then transfers the given object to it, receiving its object in return.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Synchronization/Object.html" title="Concurrent::Synchronization::Object (class)"><code>Synchronization::Object</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Synchronization/Object.html#__initialize_atomic_fields__-instance_method" title="Concurrent::Synchronization::Object#__initialize_atomic_fields__ (method)">#__initialize_atomic_fields__</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Synchronization/Volatile.html" title="Concurrent::Synchronization::Volatile (module)"><code>Synchronization::Volatile</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="Synchronization/Volatile.html#full_memory_barrier-instance_method" title="Concurrent::Synchronization::Volatile#full_memory_barrier (method)">#full_memory_barrier</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="Synchronization/AbstractObject.html" title="Concurrent::Synchronization::AbstractObject (class)"><code>Synchronization::AbstractObject</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m priv' href="Synchronization/AbstractObject.html#full_memory_barrier-instance_method" title="Concurrent::Synchronization::AbstractObject#full_memory_barrier (method)">#full_memory_barrier</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>  &#x21d2; <code>RubyExchanger</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/exchanger.rb#L159-L161'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='159' data-end='161'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/exchanger.rb', line 159</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'><a href="../Concurrent.html#initialize-instance_method" title="Concurrent#initialize (method)">initialize</a></span>
  <span class='kw'>super</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="do_exchange-instance_method">
  <h3 class='signature priv first'>
    #<strong>do_exchange</strong>(value, timeout)  &#x21d2; <a href="../Object.html" title="Object (class)">Object</a>, <code>CANCEL</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Waits for another thread to arrive at this exchange point (unless the current thread is interrupted), and then transfers the given object to it, receiving its object in return. The timeout value indicates the approximate number of seconds the method should block while waiting for the exchange. When the timeout value is <code>nil</code> the method will block indefinitely.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>value</span>
    <span class='type'>(<a href="../Object.html" title="Object (class)">Object</a>)</span>
&mdash;    <div class='inline'>
<p>the value to exchange with another thread</p>
</div>
  </li>
  <li>
    <span class='name'>timeout</span>
    <span class='type'>(<code>Numeric</code>, <code>nil</code>)</span>
&mdash;    <div class='inline'>
<p>in seconds, <code>nil</code> blocks indefinitely</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../Object.html" title="Object (class)">Object</a>, <code>CANCEL</code>)</span>
&mdash;    <div class='inline'>
<p>the value exchanged by the other thread; <code>CANCEL</code> on timeout</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby-concurrency/concurrent-ruby/blob/master/lib/concurrent-ruby/concurrent/exchanger.rb#L170-L288'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='170' data-end='288'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/concurrent-ruby/concurrent/exchanger.rb', line 170</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_do_exchange'>do_exchange</span>(<span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span>)

  <span class='comment'># ALGORITHM
</span>  <span class='comment'>#
</span>  <span class='comment'># From the original Java version:
</span>  <span class='comment'>#
</span>  <span class='comment'># &gt; The basic idea is to maintain a &quot;slot&quot;, which is a reference to
</span>  <span class='comment'># &gt; a Node containing both an Item to offer and a &quot;hole&quot; waiting to
</span>  <span class='comment'># &gt; get filled in.  If an incoming &quot;occupying&quot; thread sees that the
</span>  <span class='comment'># &gt; slot is null, it CAS&#39;es (compareAndSets) a Node there and waits
</span>  <span class='comment'># &gt; for another to invoke exchange.  That second &quot;fulfilling&quot; thread
</span>  <span class='comment'># &gt; sees that the slot is non-null, and so CASes it back to null,
</span>  <span class='comment'># &gt; also exchanging items by CASing the hole, plus waking up the
</span>  <span class='comment'># &gt; occupying thread if it is blocked.  In each case CAS&#39;es may
</span>  <span class='comment'># &gt; fail because a slot at first appears non-null but is null upon
</span>  <span class='comment'># &gt; CAS, or vice-versa.  So threads may need to retry these
</span>  <span class='comment'># &gt; actions.
</span>  <span class='comment'>#
</span>  <span class='comment'># This version:
</span>  <span class='comment'>#
</span>  <span class='comment'># An exchange occurs between an &quot;occupier&quot; thread and a &quot;fulfiller&quot; thread.
</span>  <span class='comment'># The &quot;slot&quot; is used to setup this interaction. The first thread in the
</span>  <span class='comment'># exchange puts itself into the slot (occupies) and waits for a fulfiller.
</span>  <span class='comment'># The second thread removes the occupier from the slot and attempts to
</span>  <span class='comment'># perform the exchange. Removing the occupier also frees the slot for
</span>  <span class='comment'># another occupier/fulfiller pair.
</span>  <span class='comment'>#
</span>  <span class='comment'># Because the occupier and the fulfiller are operating independently and
</span>  <span class='comment'># because there may be contention with other threads, any failed operation
</span>  <span class='comment'># indicates contention. Both the occupier and the fulfiller operate within
</span>  <span class='comment'># spin loops. Any failed actions along the happy path will cause the thread
</span>  <span class='comment'># to repeat the loop and try again.
</span>  <span class='comment'>#
</span>  <span class='comment'># When a timeout value is given the thread must be cognizant of time spent
</span>  <span class='comment'># in the spin loop. The remaining time is checked every loop. When the time
</span>  <span class='comment'># runs out the thread will exit.
</span>  <span class='comment'>#
</span>  <span class='comment'># A &quot;node&quot; is the data structure used to perform the exchange. Only the
</span>  <span class='comment'># occupier&#39;s node is necessary. It&#39;s the node used for the exchange.
</span>  <span class='comment'># Each node has an &quot;item,&quot; a &quot;hole&quot; (self), and a &quot;latch.&quot; The item is the
</span>  <span class='comment'># node&#39;s initial value. It never changes. It&#39;s what the fulfiller returns on
</span>  <span class='comment'># success. The occupier&#39;s hole is where the fulfiller put its item. It&#39;s the
</span>  <span class='comment'># item that the occupier returns on success. The latch is used for synchronization.
</span>  <span class='comment'># Because a thread may act as either an occupier or fulfiller (or possibly
</span>  <span class='comment'># both in periods of high contention) every thread creates a node when
</span>  <span class='comment'># the exchange method is first called.
</span>  <span class='comment'>#
</span>  <span class='comment'># The following steps occur within the spin loop. If any actions fail
</span>  <span class='comment'># the thread will loop and try again, so long as there is time remaining.
</span>  <span class='comment'># If time runs out the thread will return CANCEL.
</span>  <span class='comment'>#
</span>  <span class='comment'># Check the slot for an occupier:
</span>  <span class='comment'>#
</span>  <span class='comment'>#   * If the slot is empty try to occupy
</span>  <span class='comment'>#   * If the slot is full try to fulfill
</span>  <span class='comment'>#
</span>  <span class='comment'># Attempt to occupy:
</span>  <span class='comment'>#
</span>  <span class='comment'>#   * Attempt to CAS myself into the slot
</span>  <span class='comment'>#   * Go to sleep and wait to be woken by a fulfiller
</span>  <span class='comment'>#   * If the sleep is successful then the fulfiller completed its happy path
</span>  <span class='comment'>#     - Return the value from my hole (the value given by the fulfiller)
</span>  <span class='comment'>#   * When the sleep fails (time ran out) attempt to cancel the operation
</span>  <span class='comment'>#     - Attempt to CAS myself out of the hole
</span>  <span class='comment'>#     - If successful there is no contention
</span>  <span class='comment'>#       - Return CANCEL
</span>  <span class='comment'>#     - On failure, I am competing with a fulfiller
</span>  <span class='comment'>#       - Attempt to CAS my hole to CANCEL
</span>  <span class='comment'>#       - On success
</span>  <span class='comment'>#         - Let the fulfiller deal with my cancel
</span>  <span class='comment'>#         - Return CANCEL
</span>  <span class='comment'>#       - On failure the fulfiller has completed its happy path
</span>  <span class='comment'>#         - Return th value from my hole (the fulfiller&#39;s value)
</span>  <span class='comment'>#
</span>  <span class='comment'># Attempt to fulfill:
</span>  <span class='comment'>#
</span>  <span class='comment'># * Attempt to CAS the occupier out of the slot
</span>  <span class='comment'>#   - On failure loop again
</span>  <span class='comment'># * Attempt to CAS my item into the occupier&#39;s hole
</span>  <span class='comment'>#   - On failure the occupier is trying to cancel
</span>  <span class='comment'>#     - Loop again
</span>  <span class='comment'>#   - On success we are on the happy path
</span>  <span class='comment'>#     - Wake the sleeping occupier
</span>  <span class='comment'>#     - Return the occupier&#39;s item
</span>
  <span class='id identifier rubyid_value'>value</span>  <span class='op'>=</span> <span class='const'><a href="../Concurrent.html#NULL-constant" title="Concurrent::NULL (constant)">NULL</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='comment'># The sentinel allows nil to be a valid value
</span>  <span class='id identifier rubyid_me'>me</span>     <span class='op'>=</span> <span class='const'><a href="RubyExchanger/Node.html" title="Concurrent::RubyExchanger::Node (class)">Node</a></span>.<span class='id identifier rubyid_new'><a href="RubyExchanger/Node.html#new-class_method" title="Concurrent::RubyExchanger::Node.new (method)">new</a></span>(<span class='id identifier rubyid_value'>value</span>) <span class='comment'># create my node in case I need to occupy
</span>  <span class='id identifier rubyid_end_at'>end_at</span> <span class='op'>=</span> <span class='const'><a href="../Concurrent.html" title="Concurrent (module)">Concurrent</a></span>.<span class='id identifier rubyid_monotonic_time'><a href="../Concurrent.html#monotonic_time-class_method" title="Concurrent.monotonic_time (method)">monotonic_time</a></span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span>.<span class='id identifier rubyid_to_f'>to_f</span> <span class='comment'># The time to give up
</span>
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_other'>other</span> <span class='op'>=</span> <span class='id identifier rubyid_slot'>slot</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_other'>other</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_compare_and_set_slot'>compare_and_set_slot</span>(<span class='id identifier rubyid_other'>other</span><span class='comma'>,</span> <span class='kw'>nil</span>)
      <span class='comment'># try to fulfill
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_other'>other</span>.<span class='id identifier rubyid_compare_and_set_value'>compare_and_set_value</span>(<span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span>)
        <span class='comment'># happy path
</span>        <span class='id identifier rubyid_other'>other</span>.<span class='id identifier rubyid_latch'>latch</span>.<span class='id identifier rubyid_count_down'>count_down</span>
        <span class='kw'>break</span> <span class='id identifier rubyid_other'>other</span>.<span class='id identifier rubyid_item'>item</span>
      <span class='kw'>end</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_other'>other</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_compare_and_set_slot'>compare_and_set_slot</span>(<span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_me'>me</span>)
      <span class='comment'># try to occupy
</span>      <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_end_at'>end_at</span> <span class='op'>-</span> <span class='const'><a href="../Concurrent.html" title="Concurrent (module)">Concurrent</a></span>.<span class='id identifier rubyid_monotonic_time'><a href="../Concurrent.html#monotonic_time-class_method" title="Concurrent.monotonic_time (method)">monotonic_time</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_timeout'>timeout</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_me'>me</span>.<span class='id identifier rubyid_latch'>latch</span>.<span class='id identifier rubyid_wait'>wait</span>(<span class='id identifier rubyid_timeout'>timeout</span>)
        <span class='comment'># happy path
</span>        <span class='kw'>break</span> <span class='id identifier rubyid_me'>me</span>.<span class='id identifier rubyid_value'>value</span>
      <span class='kw'>else</span>
        <span class='comment'># attempt to remove myself from the slot
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_compare_and_set_slot'>compare_and_set_slot</span>(<span class='id identifier rubyid_me'>me</span><span class='comma'>,</span> <span class='kw'>nil</span>)
          <span class='kw'>break</span> <span class='const'><a href="AbstractExchanger.html#CANCEL-constant" title="Concurrent::AbstractExchanger::CANCEL (constant)">CANCEL</a></span>
        <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_me'>me</span>.<span class='id identifier rubyid_compare_and_set_value'>compare_and_set_value</span>(<span class='kw'>nil</span><span class='comma'>,</span> <span class='const'><a href="AbstractExchanger.html#CANCEL-constant" title="Concurrent::AbstractExchanger::CANCEL (constant)">CANCEL</a></span>)
          <span class='comment'># I&#39;ve failed to block the fulfiller
</span>          <span class='kw'>break</span> <span class='id identifier rubyid_me'>me</span>.<span class='id identifier rubyid_value'>value</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='kw'>break</span> <span class='const'><a href="AbstractExchanger.html#CANCEL-constant" title="Concurrent::AbstractExchanger::CANCEL (constant)">CANCEL</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>&amp;&amp;</span> <span class='const'><a href="../Concurrent.html" title="Concurrent (module)">Concurrent</a></span>.<span class='id identifier rubyid_monotonic_time'><a href="../Concurrent.html#monotonic_time-class_method" title="Concurrent.monotonic_time (method)">monotonic_time</a></span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_end_at'>end_at</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_result'>result</span> <span class='op'>==</span> <span class='const'><a href="../Concurrent.html#NULL-constant" title="Concurrent::NULL (constant)">NULL</a></span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>