<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: TZInfo::DataSources::ZoneinfoReader &mdash; TZInfo master</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "TZInfo::DataSources::ZoneinfoReader",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>TZInfo master</a> &raquo; 
      <a href='../../_index.html#alpha_Z'>Index (Z)</a> &raquo; 
        <a href="../../TZInfo.html" title="TZInfo (module)">TZInfo</a> &raquo; 
        <a href="../DataSources.html" title="TZInfo::DataSources (module)">DataSources</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ZoneinfoReader&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: TZInfo::DataSources::ZoneinfoReader</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L12'>lib/tzinfo/data_sources/zoneinfo_reader.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    <p>Reads compiled zoneinfo TZif (\0, 2 or 3) files.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='GENERATE_UP_TO-constant' class='summary_signature priv nodoc'>GENERATE_UP_TO =</span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='docstring'>
  <div class='discussion'>
    <p>The year to generate transitions up to.</p>

  </div>
</div>
<div class='tags'>
  
</div>
    <a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L16-L16'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 16</a>    <pre class='code ruby'><span class='const'>Time</span>.<span class='id identifier rubyid_now'>now</span>.<span class='id identifier rubyid_utc'>utc</span>.<span class='id identifier rubyid_year'>year</span> <span class='op'>+</span> <span class='int'>100</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(posix_tz_parser, string_deduper)  &#x21d2; ZoneinfoReader </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Initializes a new <code>ZoneinfoReader</code>.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#read-instance_method" title="#read (instance method)">#<strong>read</strong>(file_path)  &#x21d2; Object </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Reads a zoneinfo structure from the given path.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#apply_rules_with_transitions-instance_method" title="#apply_rules_with_transitions (instance method)">#<strong>apply_rules_with_transitions</strong>(file, transitions, offsets, rules)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Apply the rules from the TZ string when there were defined transitions.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#apply_rules_without_transitions-instance_method" title="#apply_rules_without_transitions (instance method)">#<strong>apply_rules_without_transitions</strong>(file, first_offset, rules)  &#x21d2; Object </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Apply the rules from the TZ string when there were no defined transitions.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#check_read-instance_method" title="#check_read (instance method)">#<strong>check_read</strong>(file, bytes)  &#x21d2; String </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Reads the given number of bytes from the given file and checks that the correct number of bytes could be read.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#derive_offsets-instance_method" title="#derive_offsets (instance method)">#<strong>derive_offsets</strong>(transitions, offsets)  &#x21d2; Integer </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Zoneinfo files don&#39;t include the offset from standard time (std_offset) for DST periods.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#find_existing_offset-instance_method" title="#find_existing_offset (instance method)">#<strong>find_existing_offset</strong>(offsets, offset)  &#x21d2; TimezoneOffset </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Finds an offset that is equivalent to the one specified in the given <code>Array</code>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#make_signed_int32-instance_method" title="#make_signed_int32 (instance method)">#<strong>make_signed_int32</strong>(long)  &#x21d2; Integer </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Translates an unsigned 32-bit integer (as returned by unpack) to signed 32-bit.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#make_signed_int64-instance_method" title="#make_signed_int64 (instance method)">#<strong>make_signed_int64</strong>(high, low)  &#x21d2; Integer </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Translates a pair of unsigned 32-bit integers (as returned by unpack, most significant first) to a signed 64-bit integer.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#offset_matches_rule%3F-instance_method" title="#offset_matches_rule? (instance method)">#<strong>offset_matches_rule?</strong>(offset, rule_offset)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Determines if the offset from a transition matches the offset from a rule.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#parse-instance_method" title="#parse (instance method)">#<strong>parse</strong>(file)  &#x21d2; Object </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Parses a zoneinfo file and returns either a <a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)"><code>::TZInfo::TimezoneOffset</code></a> that is constantly observed or an <code>Array</code> of <a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)"><code>::TZInfo::TimezoneTransition</code></a>s.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#replace_with_existing_offsets-instance_method" title="#replace_with_existing_offsets (instance method)">#<strong>replace_with_existing_offsets</strong>(offsets, annual_rules)  &#x21d2; AnnualRules </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns a new <a href="../AnnualRules.html" title="TZInfo::AnnualRules (class)"><code>::TZInfo::AnnualRules</code></a> instance with standard and daylight savings offsets replaced with equivalents from an array.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#validate_and_fix_last_defined_transition_offset-instance_method" title="#validate_and_fix_last_defined_transition_offset (instance method)">#<strong>validate_and_fix_last_defined_transition_offset</strong>(file, last_defined, first_rule_offset)  &#x21d2; TimezoneTransition </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Validates the offset indicated to be observed by the rules before the first generated transition against the offset of the last defined transition.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(posix_tz_parser, string_deduper)  &#x21d2; <code>ZoneinfoReader</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Initializes a new <code>ZoneinfoReader</code>.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>posix_tz_parser</span>
    <span class='type'>(<a href="PosixTimeZoneParser.html" title="TZInfo::DataSources::PosixTimeZoneParser (class)">PosixTimeZoneParser</a>)</span>
&mdash;    <div class='inline'><p>a <a href="PosixTimeZoneParser.html" title="TZInfo::DataSources::PosixTimeZoneParser (class)"><code>PosixTimeZoneParser</code></a>
instance to use to parse POSIX-style TZ strings.</p>
</div>
  </li>
  <li>
    <span class='name'>string_deduper</span>
    <span class='type'>(<a href="../StringDeduper.html" title="TZInfo::StringDeduper (class)">StringDeduper</a>)</span>
&mdash;    <div class='inline'><p>a <a href="../StringDeduper.html" title="TZInfo::StringDeduper (class)"><code>::TZInfo::StringDeduper</code></a> instance to use
to dedupe abbreviations.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L25-L28'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='25' data-end='28'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 25</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_posix_tz_parser'>posix_tz_parser</span><span class='comma'>,</span> <span class='id identifier rubyid_string_deduper'>string_deduper</span>)
  <span class='ivar'>@posix_tz_parser</span> <span class='op'>=</span> <span class='id identifier rubyid_posix_tz_parser'>posix_tz_parser</span>
  <span class='ivar'>@string_deduper</span> <span class='op'>=</span> <span class='id identifier rubyid_string_deduper'>string_deduper</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="apply_rules_with_transitions-instance_method">
  <h3 class='signature priv first'>
    #<strong>apply_rules_with_transitions</strong>(file, transitions, offsets, rules)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Apply the rules from the TZ string when there were defined
transitions. Checks for a matching offset with the last transition.
Redefines the last transition if required and if the rules don&#39;t
specific a constant offset, generates transitions until 100 years into
the future (at the time of loading zoneinfo_reader.rb).</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>file</span>
    <span class='type'>(<code>IO</code>)</span>
&mdash;    <div class='inline'><p>the file being processed.</p>
</div>
  </li>
  <li>
    <span class='name'>transitions</span>
    <span class='type'>(<code>Array</code>&lt;<a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)">TimezoneTransition</a>&gt;)</span>
&mdash;    <div class='inline'><p>the defined transitions.</p>
</div>
  </li>
  <li>
    <span class='name'>offsets</span>
    <span class='type'>(<code>Array</code>&lt;<a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a>&gt;)</span>
&mdash;    <div class='inline'><p>the offsets used by the defined
transitions.</p>
</div>
  </li>
  <li>
    <span class='name'>rules</span>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'><p>a <a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)"><code>::TZInfo::TimezoneOffset</code></a> specifying a constant offset or
<a href="../AnnualRules.html" title="TZInfo::AnnualRules (class)"><code>::TZInfo::AnnualRules</code></a> instance specfying transitions.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a>)</span>
&mdash;    <div class='inline'><p>if the first offset does not match the
rules.</p>
</div>
  </li>
  <li>
    <span class='type'>(<a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a>)</span>
&mdash;    <div class='inline'><p>if the previous offset of the first
generated transition does not match the offset of the last defined
transition.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L311-L334'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='311' data-end='334'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 311</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_rules_with_transitions'>apply_rules_with_transitions</span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_transitions'>transitions</span><span class='comma'>,</span> <span class='id identifier rubyid_offsets'>offsets</span><span class='comma'>,</span> <span class='id identifier rubyid_rules'>rules</span>)
  <span class='id identifier rubyid_last_defined'>last_defined</span> <span class='op'>=</span> <span class='id identifier rubyid_transitions'>transitions</span>[<span class='op'>-</span><span class='int'>1</span>]

  <span class='kw'>if</span> <span class='id identifier rubyid_rules'>rules</span>.<span class='id identifier rubyid_kind_of?'>kind_of?</span>(<span class='const'><a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a></span>)
    <span class='id identifier rubyid_transitions'>transitions</span>[<span class='op'>-</span><span class='int'>1</span>] <span class='op'>=</span> <span class='id identifier rubyid_validate_and_fix_last_defined_transition_offset'><a href="#validate_and_fix_last_defined_transition_offset-instance_method" title="TZInfo::DataSources::ZoneinfoReader#validate_and_fix_last_defined_transition_offset (method)">validate_and_fix_last_defined_transition_offset</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_last_defined'>last_defined</span><span class='comma'>,</span> <span class='id identifier rubyid_rules'>rules</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_last_year'>last_year</span> <span class='op'>=</span> <span class='id identifier rubyid_last_defined'>last_defined</span>.<span class='id identifier rubyid_local_end_at'>local_end_at</span>.<span class='id identifier rubyid_to_time'>to_time</span>.<span class='id identifier rubyid_year'>year</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_last_year'>last_year</span> <span class='op'>&lt;=</span> <span class='const'><a href="#GENERATE_UP_TO-constant" title="TZInfo::DataSources::ZoneinfoReader::GENERATE_UP_TO (constant)">GENERATE_UP_TO</a></span>
      <span class='id identifier rubyid_rules'>rules</span> <span class='op'>=</span> <span class='id identifier rubyid_replace_with_existing_offsets'><a href="#replace_with_existing_offsets-instance_method" title="TZInfo::DataSources::ZoneinfoReader#replace_with_existing_offsets (method)">replace_with_existing_offsets</a></span>(<span class='id identifier rubyid_offsets'>offsets</span><span class='comma'>,</span> <span class='id identifier rubyid_rules'>rules</span>)

      <span class='id identifier rubyid_generated'>generated</span> <span class='op'>=</span> <span class='id identifier rubyid_rules'>rules</span>.<span class='id identifier rubyid_transitions'>transitions</span>(<span class='id identifier rubyid_last_year'>last_year</span>).<span class='id identifier rubyid_find_all'>find_all</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
        <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_timestamp_value'>timestamp_value</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_last_defined'>last_defined</span>.<span class='id identifier rubyid_timestamp_value'>timestamp_value</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_offset_matches_rule?'><a href="#offset_matches_rule%3F-instance_method" title="TZInfo::DataSources::ZoneinfoReader#offset_matches_rule? (method)">offset_matches_rule?</a></span>(<span class='id identifier rubyid_last_defined'>last_defined</span>.<span class='id identifier rubyid_offset'>offset</span><span class='comma'>,</span> <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_offset'>offset</span>)
      <span class='kw'>end</span>

      <span class='id identifier rubyid_generated'>generated</span> <span class='op'>+=</span> (<span class='id identifier rubyid_last_year'>last_year</span> <span class='op'>+</span> <span class='int'>1</span>).<span class='id identifier rubyid_upto'>upto</span>(<span class='const'><a href="#GENERATE_UP_TO-constant" title="TZInfo::DataSources::ZoneinfoReader::GENERATE_UP_TO (constant)">GENERATE_UP_TO</a></span>).<span class='id identifier rubyid_flat_map'>flat_map</span> {<span class='op'>|</span><span class='id identifier rubyid_y'>y</span><span class='op'>|</span> <span class='id identifier rubyid_rules'>rules</span>.<span class='id identifier rubyid_transitions'>transitions</span>(<span class='id identifier rubyid_y'>y</span>) }

      <span class='kw'>unless</span> <span class='id identifier rubyid_generated'>generated</span>.<span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_transitions'>transitions</span>[<span class='op'>-</span><span class='int'>1</span>] <span class='op'>=</span> <span class='id identifier rubyid_validate_and_fix_last_defined_transition_offset'><a href="#validate_and_fix_last_defined_transition_offset-instance_method" title="TZInfo::DataSources::ZoneinfoReader#validate_and_fix_last_defined_transition_offset (method)">validate_and_fix_last_defined_transition_offset</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_last_defined'>last_defined</span><span class='comma'>,</span> <span class='id identifier rubyid_generated'>generated</span>[<span class='int'>0</span>].<span class='id identifier rubyid_previous_offset'>previous_offset</span>)
        <span class='id identifier rubyid_transitions'>transitions</span>.<span class='id identifier rubyid_concat'>concat</span>(<span class='id identifier rubyid_generated'>generated</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="apply_rules_without_transitions-instance_method">
  <h3 class='signature priv'>
    #<strong>apply_rules_without_transitions</strong>(file, first_offset, rules)  &#x21d2; <code>Object</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Apply the rules from the TZ string when there were no defined
transitions. Checks for a matching offset. Returns the rules-based
constant offset or generates transitions from 1970 until 100 years into
the future (at the time of loading zoneinfo_reader.rb).</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>file</span>
    <span class='type'>(<code>IO</code>)</span>
&mdash;    <div class='inline'><p>the file being processed.</p>
</div>
  </li>
  <li>
    <span class='name'>first_offset</span>
    <span class='type'>(<a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a>)</span>
&mdash;    <div class='inline'><p>the first offset included in the
file that would normally apply without the rules.</p>
</div>
  </li>
  <li>
    <span class='name'>rules</span>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'><p>a <a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)"><code>::TZInfo::TimezoneOffset</code></a> specifying a constant offset or
<a href="../AnnualRules.html" title="TZInfo::AnnualRules (class)"><code>::TZInfo::AnnualRules</code></a> instance specfying transitions.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'><p>either a <a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)"><code>::TZInfo::TimezoneOffset</code></a> or an <code>Array</code> of
<a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)"><code>::TZInfo::TimezoneTransition</code></a>s.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a>)</span>
&mdash;    <div class='inline'><p>if the first offset does not match the
rules.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L199-L224'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='199' data-end='224'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 199</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_rules_without_transitions'>apply_rules_without_transitions</span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_first_offset'>first_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_rules'>rules</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_rules'>rules</span>.<span class='id identifier rubyid_kind_of?'>kind_of?</span>(<span class='const'><a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a></span>)
    <span class='kw'>unless</span> <span class='id identifier rubyid_offset_matches_rule?'><a href="#offset_matches_rule%3F-instance_method" title="TZInfo::DataSources::ZoneinfoReader#offset_matches_rule? (method)">offset_matches_rule?</a></span>(<span class='id identifier rubyid_first_offset'>first_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_rules'>rules</span>)
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Constant offset POSIX-style TZ string does not match constant offset in file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_rules'>rules</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_transitions'>transitions</span> <span class='op'>=</span> <span class='int'>1970</span>.<span class='id identifier rubyid_upto'>upto</span>(<span class='const'><a href="#GENERATE_UP_TO-constant" title="TZInfo::DataSources::ZoneinfoReader::GENERATE_UP_TO (constant)">GENERATE_UP_TO</a></span>).<span class='id identifier rubyid_flat_map'>flat_map</span> {<span class='op'>|</span><span class='id identifier rubyid_y'>y</span><span class='op'>|</span> <span class='id identifier rubyid_rules'>rules</span>.<span class='id identifier rubyid_transitions'>transitions</span>(<span class='id identifier rubyid_y'>y</span>) }
    <span class='id identifier rubyid_first_transition'>first_transition</span> <span class='op'>=</span> <span class='id identifier rubyid_transitions'>transitions</span>[<span class='int'>0</span>]

    <span class='kw'>unless</span> <span class='id identifier rubyid_offset_matches_rule?'><a href="#offset_matches_rule%3F-instance_method" title="TZInfo::DataSources::ZoneinfoReader#offset_matches_rule? (method)">offset_matches_rule?</a></span>(<span class='id identifier rubyid_first_offset'>first_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_first_transition'>first_transition</span>.<span class='id identifier rubyid_previous_offset'>previous_offset</span>)
      <span class='comment'># Not transitioning from the designated first offset.
</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_offset_matches_rule?'><a href="#offset_matches_rule%3F-instance_method" title="TZInfo::DataSources::ZoneinfoReader#offset_matches_rule? (method)">offset_matches_rule?</a></span>(<span class='id identifier rubyid_first_offset'>first_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_first_transition'>first_transition</span>.<span class='id identifier rubyid_offset'>offset</span>)
        <span class='comment'># Skip an unnecessary transition to the first offset.
</span>        <span class='id identifier rubyid_transitions'>transitions</span>.<span class='id identifier rubyid_shift'>shift</span>
      <span class='kw'>else</span>
        <span class='comment'># The initial offset doesn&#39;t match the ongoing rules. Replace the
</span>        <span class='comment'># previous offset of the first transition.
</span>        <span class='id identifier rubyid_transitions'>transitions</span>[<span class='int'>0</span>] <span class='op'>=</span> <span class='const'><a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)">TimezoneTransition</a></span>.<span class='id identifier rubyid_new'><a href="../TimezoneTransition.html#new-class_method" title="TZInfo::TimezoneTransition.new (method)">new</a></span>(<span class='id identifier rubyid_first_transition'>first_transition</span>.<span class='id identifier rubyid_offset'>offset</span><span class='comma'>,</span> <span class='id identifier rubyid_first_offset'>first_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_first_transition'>first_transition</span>.<span class='id identifier rubyid_timestamp_value'>timestamp_value</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_transitions'>transitions</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="check_read-instance_method">
  <h3 class='signature priv'>
    #<strong>check_read</strong>(file, bytes)  &#x21d2; <code>String</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Reads the given number of bytes from the given file and checks that the
correct number of bytes could be read.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>file</span>
    <span class='type'>(<code>IO</code>)</span>
&mdash;    <div class='inline'><p>the file to read from.</p>
</div>
  </li>
  <li>
    <span class='name'>bytes</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'><p>the number of bytes to read.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'><p>the bytes that were read.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a>)</span>
&mdash;    <div class='inline'><p>if the number of bytes available didn&#39;t
match the number requested.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L76-L84'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='76' data-end='84'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 76</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_check_read'>check_read</span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_bytes'>bytes</span>)
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_read'><a href="#read-instance_method" title="TZInfo::DataSources::ZoneinfoReader#read (method)">read</a></span>(<span class='id identifier rubyid_bytes'>bytes</span>)

  <span class='kw'>unless</span> <span class='id identifier rubyid_result'>result</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='id identifier rubyid_bytes'>bytes</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Expected </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bytes'>bytes</span><span class='embexpr_end'>}</span><span class='tstring_content'> bytes reading &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;, but got </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_result'>result</span> <span class='op'>?</span> <span class='id identifier rubyid_result'>result</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>:</span> <span class='int'>0</span><span class='embexpr_end'>}</span><span class='tstring_content'> bytes</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="derive_offsets-instance_method">
  <h3 class='signature priv'>
    #<strong>derive_offsets</strong>(transitions, offsets)  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Zoneinfo files don&#39;t include the offset from standard time (std_offset)
for DST periods. Derive the base offset (base_utc_offset) where DST is
observed from either the previous or next non-DST period.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>transitions</span>
    <span class='type'>(<code>Array</code>&lt;<code>Hash</code>&gt;)</span>
&mdash;    <div class='inline'><p>an <code>Array</code> of transition hashes.</p>
</div>
  </li>
  <li>
    <span class='name'>offsets</span>
    <span class='type'>(<code>Array</code>&lt;<code>Hash</code>&gt;)</span>
&mdash;    <div class='inline'><p>an <code>Array</code> of offset hashes.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'><p>the index of the offset to be used prior to the first
transition.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L94-L169'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='94' data-end='169'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 94</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_derive_offsets'>derive_offsets</span>(<span class='id identifier rubyid_transitions'>transitions</span><span class='comma'>,</span> <span class='id identifier rubyid_offsets'>offsets</span>)
  <span class='comment'># The first non-DST offset (if there is one) is the offset observed
</span>  <span class='comment'># before the first transition. Fall back to the first DST offset if
</span>  <span class='comment'># there are no non-DST offsets.
</span>  <span class='id identifier rubyid_first_non_dst_offset_index'>first_non_dst_offset_index</span> <span class='op'>=</span> <span class='id identifier rubyid_offsets'>offsets</span>.<span class='id identifier rubyid_index'>index</span> {<span class='op'>|</span><span class='id identifier rubyid_o'>o</span><span class='op'>|</span> <span class='op'>!</span><span class='id identifier rubyid_o'>o</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_is_dst'>is_dst</span>] }
  <span class='id identifier rubyid_first_offset_index'>first_offset_index</span> <span class='op'>=</span> <span class='id identifier rubyid_first_non_dst_offset_index'>first_non_dst_offset_index</span> <span class='op'>||</span> <span class='int'>0</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_first_offset_index'>first_offset_index</span> <span class='kw'>if</span> <span class='id identifier rubyid_transitions'>transitions</span>.<span class='id identifier rubyid_empty?'>empty?</span>

  <span class='comment'># Determine the base_utc_offset of the next non-dst offset at each transition.
</span>  <span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='id identifier rubyid_transitions'>transitions</span>.<span class='id identifier rubyid_reverse_each'>reverse_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_transition'>transition</span><span class='op'>|</span>
    <span class='id identifier rubyid_offset'>offset</span> <span class='op'>=</span> <span class='id identifier rubyid_offsets'>offsets</span>[<span class='id identifier rubyid_transition'>transition</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_offset'>offset</span>]]
    <span class='kw'>if</span> <span class='id identifier rubyid_offset'>offset</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_is_dst'>is_dst</span>]
      <span class='id identifier rubyid_transition'>transition</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span>] <span class='op'>=</span> <span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span> <span class='kw'>if</span> <span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span> <span class='op'>=</span> <span class='id identifier rubyid_offset'>offset</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span>]
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_base_utc_offset_from_previous'>base_utc_offset_from_previous</span> <span class='op'>=</span> <span class='id identifier rubyid_first_non_dst_offset_index'>first_non_dst_offset_index</span> <span class='op'>?</span> <span class='id identifier rubyid_offsets'>offsets</span>[<span class='id identifier rubyid_first_non_dst_offset_index'>first_non_dst_offset_index</span>][<span class='symbeg'>:</span><span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span>] <span class='op'>:</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_defined_offsets'>defined_offsets</span> <span class='op'>=</span> {}

  <span class='id identifier rubyid_transitions'>transitions</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_transition'>transition</span><span class='op'>|</span>
    <span class='id identifier rubyid_offset_index'>offset_index</span> <span class='op'>=</span> <span class='id identifier rubyid_transition'>transition</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_offset'>offset</span>]
    <span class='id identifier rubyid_offset'>offset</span> <span class='op'>=</span> <span class='id identifier rubyid_offsets'>offsets</span>[<span class='id identifier rubyid_offset_index'>offset_index</span>]
    <span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_offset'>offset</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span>]

    <span class='kw'>if</span> <span class='id identifier rubyid_offset'>offset</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_is_dst'>is_dst</span>]
      <span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span> <span class='op'>=</span> <span class='id identifier rubyid_transition'>transition</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span>]

      <span class='id identifier rubyid_difference_to_previous'>difference_to_previous</span> <span class='op'>=</span> (<span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span> <span class='op'>-</span> (<span class='id identifier rubyid_base_utc_offset_from_previous'>base_utc_offset_from_previous</span> <span class='op'>||</span> <span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span>)).<span class='id identifier rubyid_abs'>abs</span>
      <span class='id identifier rubyid_difference_to_next'>difference_to_next</span> <span class='op'>=</span> (<span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span> <span class='op'>-</span> (<span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span> <span class='op'>||</span> <span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span>)).<span class='id identifier rubyid_abs'>abs</span>

      <span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_difference_to_previous'>difference_to_previous</span> <span class='op'>==</span> <span class='int'>3600</span>
        <span class='id identifier rubyid_base_utc_offset_from_previous'>base_utc_offset_from_previous</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_difference_to_next'>difference_to_next</span> <span class='op'>==</span> <span class='int'>3600</span>
        <span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_difference_to_previous'>difference_to_previous</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_difference_to_next'>difference_to_next</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id identifier rubyid_difference_to_previous'>difference_to_previous</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_difference_to_next'>difference_to_next</span> <span class='op'>?</span> <span class='id identifier rubyid_base_utc_offset_from_previous'>base_utc_offset_from_previous</span> <span class='op'>:</span> <span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_difference_to_previous'>difference_to_previous</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id identifier rubyid_base_utc_offset_from_previous'>base_utc_offset_from_previous</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_difference_to_next'>difference_to_next</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id identifier rubyid_base_utc_offset_from_next'>base_utc_offset_from_next</span>
      <span class='kw'>else</span>
        <span class='comment'># No difference, assume a 1 hour offset from standard time.
</span>        <span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span> <span class='op'>-</span> <span class='int'>3600</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_offset'>offset</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span>]
        <span class='id identifier rubyid_offset'>offset</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span>] <span class='op'>=</span> <span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span>
        <span class='id identifier rubyid_defined_offsets'>defined_offsets</span>[<span class='id identifier rubyid_offset'>offset</span>] <span class='op'>=</span> <span class='id identifier rubyid_offset_index'>offset_index</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_offset'>offset</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span>] <span class='op'>!=</span> <span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span>
        <span class='comment'># An earlier transition has already derived a different
</span>        <span class='comment'># base_utc_offset. Define a new offset or reuse an existing identically
</span>        <span class='comment'># defined offset.
</span>        <span class='id identifier rubyid_new_offset'>new_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_offset'>offset</span>.<span class='id identifier rubyid_dup'>dup</span>
        <span class='id identifier rubyid_new_offset'>new_offset</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span>] <span class='op'>=</span> <span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span>

        <span class='id identifier rubyid_offset_index'>offset_index</span> <span class='op'>=</span> <span class='id identifier rubyid_defined_offsets'>defined_offsets</span>[<span class='id identifier rubyid_new_offset'>new_offset</span>]

        <span class='kw'>unless</span> <span class='id identifier rubyid_offset_index'>offset_index</span>
          <span class='id identifier rubyid_offsets'>offsets</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_new_offset'>new_offset</span>
          <span class='id identifier rubyid_offset_index'>offset_index</span> <span class='op'>=</span> <span class='id identifier rubyid_offsets'>offsets</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>1</span>
          <span class='id identifier rubyid_defined_offsets'>defined_offsets</span>[<span class='id identifier rubyid_new_offset'>new_offset</span>] <span class='op'>=</span> <span class='id identifier rubyid_offset_index'>offset_index</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_transition'>transition</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_offset'>offset</span>] <span class='op'>=</span> <span class='id identifier rubyid_offset_index'>offset_index</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_base_utc_offset_from_previous'>base_utc_offset_from_previous</span> <span class='op'>=</span> <span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_first_offset_index'>first_offset_index</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="find_existing_offset-instance_method">
  <h3 class='signature priv'>
    #<strong>find_existing_offset</strong>(offsets, offset)  &#x21d2; <a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Finds an offset that is equivalent to the one specified in the given
<code>Array</code>. Matching is performed with <a href="../TimezoneOffset.html#==-instance_method" title="TZInfo::TimezoneOffset#== (method)">TimezoneOffset#==</a>.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>offsets</span>
    <span class='type'>(<code>Array</code>&lt;<a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a>&gt;)</span>
&mdash;    <div class='inline'><p>an <code>Array</code> to search.</p>
</div>
  </li>
  <li>
    <span class='name'>offset</span>
    <span class='type'>(<a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a>)</span>
&mdash;    <div class='inline'><p>the offset to search for.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a>)</span>
&mdash;    <div class='inline'><p>the matching offset from <code>offsets</code> or <code>nil</code>
if not found.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L233-L235'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='233' data-end='235'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 233</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_find_existing_offset'>find_existing_offset</span>(<span class='id identifier rubyid_offsets'>offsets</span><span class='comma'>,</span> <span class='id identifier rubyid_offset'>offset</span>)
  <span class='id identifier rubyid_offsets'>offsets</span>.<span class='id identifier rubyid_find'>find</span> {<span class='op'>|</span><span class='id identifier rubyid_o'>o</span><span class='op'>|</span> <span class='id identifier rubyid_o'>o</span> <span class='op'>==</span> <span class='id identifier rubyid_offset'>offset</span> }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="make_signed_int32-instance_method">
  <h3 class='signature priv'>
    #<strong>make_signed_int32</strong>(long)  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Translates an unsigned 32-bit integer (as returned by unpack) to signed
32-bit.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>long</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'><p>an unsigned 32-bit integer.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'><p><code>long</code> translated to signed 32-bit.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L52-L54'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='52' data-end='54'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 52</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_make_signed_int32'>make_signed_int32</span>(<span class='id identifier rubyid_long'>long</span>)
  <span class='id identifier rubyid_long'>long</span> <span class='op'>&gt;=</span> <span class='int'>0x80000000</span> <span class='op'>?</span> <span class='id identifier rubyid_long'>long</span> <span class='op'>-</span> <span class='int'>0x100000000</span> <span class='op'>:</span> <span class='id identifier rubyid_long'>long</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="make_signed_int64-instance_method">
  <h3 class='signature priv'>
    #<strong>make_signed_int64</strong>(high, low)  &#x21d2; <code>Integer</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Translates a pair of unsigned 32-bit integers (as returned by unpack,
most significant first) to a signed 64-bit integer.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>high</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'><p>the most significant 32-bits.</p>
</div>
  </li>
  <li>
    <span class='name'>low</span>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'><p>the least significant 32-bits.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Integer</code>)</span>
&mdash;    <div class='inline'><p><code>high</code> and <code>low</code> combined and translated to signed
64-bit.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L63-L66'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='66'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_make_signed_int64'>make_signed_int64</span>(<span class='id identifier rubyid_high'>high</span><span class='comma'>,</span> <span class='id identifier rubyid_low'>low</span>)
  <span class='id identifier rubyid_unsigned'>unsigned</span> <span class='op'>=</span> (<span class='id identifier rubyid_high'>high</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span>) <span class='op'>|</span> <span class='id identifier rubyid_low'>low</span>
  <span class='id identifier rubyid_unsigned'>unsigned</span> <span class='op'>&gt;=</span> <span class='int'>0x8000000000000000</span> <span class='op'>?</span> <span class='id identifier rubyid_unsigned'>unsigned</span> <span class='op'>-</span> <span class='int'>0x10000000000000000</span> <span class='op'>:</span> <span class='id identifier rubyid_unsigned'>unsigned</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="offset_matches_rule?-instance_method">
  <h3 class='signature priv'>
    #<strong>offset_matches_rule?</strong>(offset, rule_offset)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Determines if the offset from a transition matches the offset from a
rule. This is a looser match than equality, not requiring that the
base_utc_offset and std_offset both match (which have to be derived for
transitions, but are known for rules.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>offset</span>
    <span class='type'>(<a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a>)</span>
&mdash;    <div class='inline'><p>an offset from a transition.</p>
</div>
  </li>
  <li>
    <span class='name'>rule_offset</span>
    <span class='type'>(<a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a>)</span>
&mdash;    <div class='inline'><p>an offset from a rule.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Boolean</code>)</span>
&mdash;    <div class='inline'><p>whether the offsets match.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L179-L183'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='179' data-end='183'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 179</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_offset_matches_rule?'>offset_matches_rule?</span>(<span class='id identifier rubyid_offset'>offset</span><span class='comma'>,</span> <span class='id identifier rubyid_rule_offset'>rule_offset</span>)
  <span class='id identifier rubyid_offset'>offset</span>.<span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span> <span class='op'>==</span> <span class='id identifier rubyid_rule_offset'>rule_offset</span>.<span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span> <span class='op'>&amp;&amp;</span>
    <span class='id identifier rubyid_offset'>offset</span>.<span class='id identifier rubyid_dst?'>dst?</span> <span class='op'>==</span> <span class='id identifier rubyid_rule_offset'>rule_offset</span>.<span class='id identifier rubyid_dst?'>dst?</span> <span class='op'>&amp;&amp;</span>
    <span class='id identifier rubyid_offset'>offset</span>.<span class='id identifier rubyid_abbreviation'>abbreviation</span> <span class='op'>==</span> <span class='id identifier rubyid_rule_offset'>rule_offset</span>.<span class='id identifier rubyid_abbreviation'>abbreviation</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="parse-instance_method">
  <h3 class='signature priv'>
    #<strong>parse</strong>(file)  &#x21d2; <code>Object</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Parses a zoneinfo file and returns either a <a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)"><code>::TZInfo::TimezoneOffset</code></a> that is
constantly observed or an <code>Array</code> of <a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)"><code>::TZInfo::TimezoneTransition</code></a>s.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>file</span>
    <span class='type'>(<code>IO</code>)</span>
&mdash;    <div class='inline'><p>the file to be read.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'><p>either a <a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)"><code>::TZInfo::TimezoneOffset</code></a> or an <code>Array</code> of
<a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)"><code>::TZInfo::TimezoneTransition</code></a>s.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a>)</span>
&mdash;    <div class='inline'><p>if the file is not a valid zoneinfo file.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L343-L478'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='343' data-end='478'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 343</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_file'>file</span>)
  <span class='id identifier rubyid_magic'>magic</span><span class='comma'>,</span> <span class='id identifier rubyid_version'>version</span><span class='comma'>,</span> <span class='id identifier rubyid_ttisutccnt'>ttisutccnt</span><span class='comma'>,</span> <span class='id identifier rubyid_ttisstdcnt'>ttisstdcnt</span><span class='comma'>,</span> <span class='id identifier rubyid_leapcnt'>leapcnt</span><span class='comma'>,</span> <span class='id identifier rubyid_timecnt'>timecnt</span><span class='comma'>,</span> <span class='id identifier rubyid_typecnt'>typecnt</span><span class='comma'>,</span> <span class='id identifier rubyid_charcnt'>charcnt</span> <span class='op'>=</span>
    <span class='id identifier rubyid_check_read'><a href="#check_read-instance_method" title="TZInfo::DataSources::ZoneinfoReader#check_read (method)">check_read</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='int'>44</span>).<span class='id identifier rubyid_unpack'>unpack</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>a4 a x15 NNNNNN</span><span class='tstring_end'>&#39;</span></span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_magic'>magic</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TZif</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; does not start with the expected header.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_version'>version</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>2</span><span class='tstring_end'>&#39;</span></span> <span class='op'>||</span> <span class='id identifier rubyid_version'>version</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>3</span><span class='tstring_end'>&#39;</span></span>
    <span class='comment'># Skip the first 32-bit section and read the header of the second 64-bit section
</span>    <span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_seek'>seek</span>(<span class='id identifier rubyid_timecnt'>timecnt</span> <span class='op'>*</span> <span class='int'>5</span> <span class='op'>+</span> <span class='id identifier rubyid_typecnt'>typecnt</span> <span class='op'>*</span> <span class='int'>6</span> <span class='op'>+</span> <span class='id identifier rubyid_charcnt'>charcnt</span> <span class='op'>+</span> <span class='id identifier rubyid_leapcnt'>leapcnt</span> <span class='op'>*</span> <span class='int'>8</span> <span class='op'>+</span> <span class='id identifier rubyid_ttisstdcnt'>ttisstdcnt</span> <span class='op'>+</span> <span class='id identifier rubyid_ttisutccnt'>ttisutccnt</span><span class='comma'>,</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>SEEK_CUR</span>)

    <span class='id identifier rubyid_prev_version'>prev_version</span> <span class='op'>=</span> <span class='id identifier rubyid_version'>version</span>

    <span class='id identifier rubyid_magic'>magic</span><span class='comma'>,</span> <span class='id identifier rubyid_version'>version</span><span class='comma'>,</span> <span class='id identifier rubyid_ttisutccnt'>ttisutccnt</span><span class='comma'>,</span> <span class='id identifier rubyid_ttisstdcnt'>ttisstdcnt</span><span class='comma'>,</span> <span class='id identifier rubyid_leapcnt'>leapcnt</span><span class='comma'>,</span> <span class='id identifier rubyid_timecnt'>timecnt</span><span class='comma'>,</span> <span class='id identifier rubyid_typecnt'>typecnt</span><span class='comma'>,</span> <span class='id identifier rubyid_charcnt'>charcnt</span> <span class='op'>=</span>
      <span class='id identifier rubyid_check_read'><a href="#check_read-instance_method" title="TZInfo::DataSources::ZoneinfoReader#check_read (method)">check_read</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='int'>44</span>).<span class='id identifier rubyid_unpack'>unpack</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>a4 a x15 NNNNNN</span><span class='tstring_end'>&#39;</span></span>)

    <span class='kw'>unless</span> <span class='id identifier rubyid_magic'>magic</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TZif</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&amp;&amp;</span> (<span class='id identifier rubyid_version'>version</span> <span class='op'>==</span> <span class='id identifier rubyid_prev_version'>prev_version</span>)
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; contains an invalid 64-bit section header.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_using_64bit'>using_64bit</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_version'>version</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>3</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_version'>version</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>2</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_version'>version</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\0</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; contains a version of the zoneinfo format that is not currently supported.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_using_64bit'>using_64bit</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_leapcnt'>leapcnt</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; contains leap second data. TZInfo requires zoneinfo files that omit leap seconds.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_transitions'>transitions</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_using_64bit'>using_64bit</span>
    <span class='id identifier rubyid_timecnt'>timecnt</span>.<span class='id identifier rubyid_times'>times</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
      <span class='id identifier rubyid_high'>high</span><span class='comma'>,</span> <span class='id identifier rubyid_low'>low</span> <span class='op'>=</span> <span class='id identifier rubyid_check_read'><a href="#check_read-instance_method" title="TZInfo::DataSources::ZoneinfoReader#check_read (method)">check_read</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='int'>8</span>).<span class='id identifier rubyid_unpack'>unpack</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>NN</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span>)
      <span class='id identifier rubyid_transition_time'>transition_time</span> <span class='op'>=</span> <span class='id identifier rubyid_make_signed_int64'><a href="#make_signed_int64-instance_method" title="TZInfo::DataSources::ZoneinfoReader#make_signed_int64 (method)">make_signed_int64</a></span>(<span class='id identifier rubyid_high'>high</span><span class='comma'>,</span> <span class='id identifier rubyid_low'>low</span>)
      {<span class='label'>at:</span> <span class='id identifier rubyid_transition_time'>transition_time</span>}
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_timecnt'>timecnt</span>.<span class='id identifier rubyid_times'>times</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
      <span class='id identifier rubyid_transition_time'>transition_time</span> <span class='op'>=</span> <span class='id identifier rubyid_make_signed_int32'><a href="#make_signed_int32-instance_method" title="TZInfo::DataSources::ZoneinfoReader#make_signed_int32 (method)">make_signed_int32</a></span>(<span class='id identifier rubyid_check_read'><a href="#check_read-instance_method" title="TZInfo::DataSources::ZoneinfoReader#check_read (method)">check_read</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='int'>4</span>).<span class='id identifier rubyid_unpack'>unpack</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>N</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span>)[<span class='int'>0</span>])
      {<span class='label'>at:</span> <span class='id identifier rubyid_transition_time'>transition_time</span>}
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_check_read'><a href="#check_read-instance_method" title="TZInfo::DataSources::ZoneinfoReader#check_read (method)">check_read</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_timecnt'>timecnt</span>).<span class='id identifier rubyid_unpack'>unpack</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>C*</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span>).<span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_localtime_type'>localtime_type</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid offset referenced by transition in file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_localtime_type'>localtime_type</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_typecnt'>typecnt</span>
    <span class='id identifier rubyid_transitions'>transitions</span>[<span class='id identifier rubyid_i'>i</span>][<span class='symbeg'>:</span><span class='id identifier rubyid_offset'>offset</span>] <span class='op'>=</span> <span class='id identifier rubyid_localtime_type'>localtime_type</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_offsets'>offsets</span> <span class='op'>=</span> <span class='id identifier rubyid_typecnt'>typecnt</span>.<span class='id identifier rubyid_times'>times</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_gmtoff'>gmtoff</span><span class='comma'>,</span> <span class='id identifier rubyid_isdst'>isdst</span><span class='comma'>,</span> <span class='id identifier rubyid_abbrind'>abbrind</span> <span class='op'>=</span> <span class='id identifier rubyid_check_read'><a href="#check_read-instance_method" title="TZInfo::DataSources::ZoneinfoReader#check_read (method)">check_read</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='int'>6</span>).<span class='id identifier rubyid_unpack'>unpack</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>NCC</span><span class='tstring_end'>&#39;</span></span>.<span class='id identifier rubyid_freeze'>freeze</span>)
    <span class='id identifier rubyid_gmtoff'>gmtoff</span> <span class='op'>=</span> <span class='id identifier rubyid_make_signed_int32'><a href="#make_signed_int32-instance_method" title="TZInfo::DataSources::ZoneinfoReader#make_signed_int32 (method)">make_signed_int32</a></span>(<span class='id identifier rubyid_gmtoff'>gmtoff</span>)
    <span class='id identifier rubyid_isdst'>isdst</span> <span class='op'>=</span> <span class='id identifier rubyid_isdst'>isdst</span> <span class='op'>==</span> <span class='int'>1</span>
    {<span class='label'>observed_utc_offset:</span> <span class='id identifier rubyid_gmtoff'>gmtoff</span><span class='comma'>,</span> <span class='label'>is_dst:</span> <span class='id identifier rubyid_isdst'>isdst</span><span class='comma'>,</span> <span class='label'>abbr_index:</span> <span class='id identifier rubyid_abbrind'>abbrind</span>}
  <span class='kw'>end</span>

  <span class='id identifier rubyid_abbrev'>abbrev</span> <span class='op'>=</span> <span class='id identifier rubyid_check_read'><a href="#check_read-instance_method" title="TZInfo::DataSources::ZoneinfoReader#check_read (method)">check_read</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_charcnt'>charcnt</span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_using_64bit'>using_64bit</span>
    <span class='comment'># Skip to the POSIX-style TZ string.
</span>    <span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_seek'>seek</span>(<span class='id identifier rubyid_ttisstdcnt'>ttisstdcnt</span> <span class='op'>+</span> <span class='id identifier rubyid_ttisutccnt'>ttisutccnt</span><span class='comma'>,</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>SEEK_CUR</span>) <span class='comment'># + leapcnt * 8, but leapcnt is checked above and guaranteed to be 0.
</span>    <span class='id identifier rubyid_tz_string_start'>tz_string_start</span> <span class='op'>=</span> <span class='id identifier rubyid_check_read'><a href="#check_read-instance_method" title="TZInfo::DataSources::ZoneinfoReader#check_read (method)">check_read</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='int'>1</span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Expected newline starting POSIX-style TZ string in file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_tz_string_start'>tz_string_start</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_tz_string'>tz_string</span> <span class='op'>=</span> <span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_readline'>readline</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_force_encoding'>force_encoding</span>(<span class='const'>Encoding</span><span class='op'>::</span><span class='const'>UTF_8</span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Expected newline ending POSIX-style TZ string in file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_tz_string'>tz_string</span>.<span class='id identifier rubyid_chomp!'>chomp!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>)

    <span class='kw'>begin</span>
      <span class='id identifier rubyid_rules'>rules</span> <span class='op'>=</span> <span class='ivar'>@posix_tz_parser</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_tz_string'>tz_string</span>)
    <span class='kw'>rescue</span> <span class='const'><a href="InvalidPosixTimeZone.html" title="TZInfo::DataSources::InvalidPosixTimeZone (class)">InvalidPosixTimeZone</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to parse POSIX-style TZ string in file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_rules'>rules</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='comment'># Derive the offsets from standard time (std_offset).
</span>  <span class='id identifier rubyid_first_offset_index'>first_offset_index</span> <span class='op'>=</span> <span class='id identifier rubyid_derive_offsets'><a href="#derive_offsets-instance_method" title="TZInfo::DataSources::ZoneinfoReader#derive_offsets (method)">derive_offsets</a></span>(<span class='id identifier rubyid_transitions'>transitions</span><span class='comma'>,</span> <span class='id identifier rubyid_offsets'>offsets</span>)

  <span class='id identifier rubyid_offsets'>offsets</span> <span class='op'>=</span> <span class='id identifier rubyid_offsets'>offsets</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
    <span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_o'>o</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span>]
    <span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_o'>o</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span>]

    <span class='kw'>if</span> <span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span>
      <span class='comment'># DST offset with base_utc_offset derived by derive_offsets.
</span>      <span class='id identifier rubyid_std_offset'>std_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span> <span class='op'>-</span> <span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_o'>o</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_is_dst'>is_dst</span>]
      <span class='comment'># DST offset unreferenced by a transition (offset in use before the
</span>      <span class='comment'># first transition). No derived base UTC offset, so assume 1 hour
</span>      <span class='comment'># DST.
</span>      <span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span> <span class='op'>-</span> <span class='int'>3600</span>
      <span class='id identifier rubyid_std_offset'>std_offset</span> <span class='op'>=</span> <span class='int'>3600</span>
    <span class='kw'>else</span>
      <span class='comment'># Non-DST offset.
</span>      <span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_observed_utc_offset'>observed_utc_offset</span>
      <span class='id identifier rubyid_std_offset'>std_offset</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_abbrev_start'>abbrev_start</span> <span class='op'>=</span> <span class='id identifier rubyid_o'>o</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_abbr_index'>abbr_index</span>]
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Abbreviation index is out of range in file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_abbrev_start'>abbrev_start</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_abbrev'>abbrev</span>.<span class='id identifier rubyid_length'>length</span>

    <span class='id identifier rubyid_abbrev_end'>abbrev_end</span> <span class='op'>=</span> <span class='id identifier rubyid_abbrev'>abbrev</span>.<span class='id identifier rubyid_index'>index</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_abbrev_start'>abbrev_start</span>)
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Missing abbreviation null terminator in file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_abbrev_end'>abbrev_end</span>

    <span class='id identifier rubyid_abbr'>abbr</span> <span class='op'>=</span> <span class='ivar'>@string_deduper</span>.<span class='id identifier rubyid_dedupe'>dedupe</span>(<span class='const'><a href="../RubyCoreSupport.html" title="TZInfo::RubyCoreSupport (module)">RubyCoreSupport</a></span>.<span class='id identifier rubyid_untaint'><a href="../RubyCoreSupport.html#untaint-class_method" title="TZInfo::RubyCoreSupport.untaint (method)">untaint</a></span>(<span class='id identifier rubyid_abbrev'>abbrev</span>[<span class='id identifier rubyid_abbrev_start'>abbrev_start</span><span class='op'>...</span><span class='id identifier rubyid_abbrev_end'>abbrev_end</span>].<span class='id identifier rubyid_force_encoding'>force_encoding</span>(<span class='const'>Encoding</span><span class='op'>::</span><span class='const'>UTF_8</span>)))

    <span class='const'><a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a></span>.<span class='id identifier rubyid_new'><a href="../TimezoneOffset.html#new-class_method" title="TZInfo::TimezoneOffset.new (method)">new</a></span>(<span class='id identifier rubyid_base_utc_offset'>base_utc_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_std_offset'>std_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_abbr'>abbr</span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_first_offset'>first_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_offsets'>offsets</span>[<span class='id identifier rubyid_first_offset_index'>first_offset_index</span>]


  <span class='kw'>if</span> <span class='id identifier rubyid_transitions'>transitions</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_rules'>rules</span>
      <span class='id identifier rubyid_apply_rules_without_transitions'><a href="#apply_rules_without_transitions-instance_method" title="TZInfo::DataSources::ZoneinfoReader#apply_rules_without_transitions (method)">apply_rules_without_transitions</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_first_offset'>first_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_rules'>rules</span>)
    <span class='kw'>else</span>
      <span class='id identifier rubyid_first_offset'>first_offset</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_previous_offset'>previous_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_first_offset'>first_offset</span>
    <span class='id identifier rubyid_previous_at'>previous_at</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='id identifier rubyid_transitions'>transitions</span> <span class='op'>=</span> <span class='id identifier rubyid_transitions'>transitions</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_offset'>offset</span> <span class='op'>=</span> <span class='id identifier rubyid_offsets'>offsets</span>[<span class='id identifier rubyid_t'>t</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_offset'>offset</span>]]
      <span class='id identifier rubyid_at'>at</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_at'>at</span>]
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Transition at </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_at'>at</span><span class='embexpr_end'>}</span><span class='tstring_content'> is not later than the previous transition at </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_previous_at'>previous_at</span><span class='embexpr_end'>}</span><span class='tstring_content'> in file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_previous_at'>previous_at</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_previous_at'>previous_at</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_at'>at</span>
      <span class='id identifier rubyid_tt'>tt</span> <span class='op'>=</span> <span class='const'><a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)">TimezoneTransition</a></span>.<span class='id identifier rubyid_new'><a href="../TimezoneTransition.html#new-class_method" title="TZInfo::TimezoneTransition.new (method)">new</a></span>(<span class='id identifier rubyid_offset'>offset</span><span class='comma'>,</span> <span class='id identifier rubyid_previous_offset'>previous_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_at'>at</span>)
      <span class='id identifier rubyid_previous_offset'>previous_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_offset'>offset</span>
      <span class='id identifier rubyid_previous_at'>previous_at</span> <span class='op'>=</span> <span class='id identifier rubyid_at'>at</span>
      <span class='id identifier rubyid_tt'>tt</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_apply_rules_with_transitions'><a href="#apply_rules_with_transitions-instance_method" title="TZInfo::DataSources::ZoneinfoReader#apply_rules_with_transitions (method)">apply_rules_with_transitions</a></span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_transitions'>transitions</span><span class='comma'>,</span> <span class='id identifier rubyid_offsets'>offsets</span><span class='comma'>,</span> <span class='id identifier rubyid_rules'>rules</span>) <span class='kw'>if</span> <span class='id identifier rubyid_rules'>rules</span>
    <span class='id identifier rubyid_transitions'>transitions</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read-instance_method">
  <h3 class='signature '>
    #<strong>read</strong>(file_path)  &#x21d2; <code>Object</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Reads a zoneinfo structure from the given path. Returns either a
<a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)"><code>::TZInfo::TimezoneOffset</code></a> that is constantly observed or an <code>Array</code>
<a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)"><code>::TZInfo::TimezoneTransition</code></a>s.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>file_path</span>
    <span class='type'>(<code>String</code>)</span>
&mdash;    <div class='inline'><p>the path of a zoneinfo file.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Object</code>)</span>
&mdash;    <div class='inline'><p>either a <a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)"><code>::TZInfo::TimezoneOffset</code></a> or an <code>Array</code> of
<a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)"><code>::TZInfo::TimezoneTransition</code></a>s.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<code>SecurityError</code>)</span>
&mdash;    <div class='inline'><p>if safe mode is enabled and <code>file_path</code> is
tainted.</p>
</div>
  </li>
  <li>
    <span class='type'>(<a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a>)</span>
&mdash;    <div class='inline'><p>if <code>file_path</code>` does not refer to a valid
zoneinfo file.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L41-L43'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='41' data-end='43'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 41</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read'>read</span>(<span class='id identifier rubyid_file_path'>file_path</span>)
  <span class='const'>File</span>.<span class='id identifier rubyid_open'>open</span>(<span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rb</span><span class='tstring_end'>&#39;</span></span>) { <span class='op'>|</span><span class='id identifier rubyid_file'>file</span><span class='op'>|</span> <span class='id identifier rubyid_parse'><a href="#parse-instance_method" title="TZInfo::DataSources::ZoneinfoReader#parse (method)">parse</a></span>(<span class='id identifier rubyid_file'>file</span>) }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="replace_with_existing_offsets-instance_method">
  <h3 class='signature priv'>
    #<strong>replace_with_existing_offsets</strong>(offsets, annual_rules)  &#x21d2; <a href="../AnnualRules.html" title="TZInfo::AnnualRules (class)">AnnualRules</a>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Returns a new <a href="../AnnualRules.html" title="TZInfo::AnnualRules (class)"><code>::TZInfo::AnnualRules</code></a> instance with standard and daylight savings
offsets replaced with equivalents from an array. This reduces the memory
requirement for loaded time zones by reusing offsets for rule-generated
transitions.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>offsets</span>
    <span class='type'>(<code>Array</code>&lt;<a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a>&gt;)</span>
&mdash;    <div class='inline'><p>an <code>Array</code> to search for
equivalent offsets.</p>
</div>
  </li>
  <li>
    <span class='name'>annual_rules</span>
    <span class='type'>(<a href="../AnnualRules.html" title="TZInfo::AnnualRules (class)">AnnualRules</a>)</span>
&mdash;    <div class='inline'><p>the <a href="../AnnualRules.html" title="TZInfo::AnnualRules (class)"><code>::TZInfo::AnnualRules</code></a> instance to check.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../AnnualRules.html" title="TZInfo::AnnualRules (class)">AnnualRules</a>)</span>
&mdash;    <div class='inline'><p>either a new <a href="../AnnualRules.html" title="TZInfo::AnnualRules (class)"><code>::TZInfo::AnnualRules</code></a> instance with either
the <a href="../AnnualRules.html#std_offset-instance_method" title="TZInfo::AnnualRules#std_offset (method)">std_offset</a> or <a href="../AnnualRules.html#dst_offset-instance_method" title="TZInfo::AnnualRules#dst_offset (method)">dst_offset</a> replaced, or the original instance if no equivalent for
either <a href="../AnnualRules.html#std_offset-instance_method" title="TZInfo::AnnualRules#std_offset (method)">std_offset</a> or <a href="../AnnualRules.html#dst_offset-instance_method" title="TZInfo::AnnualRules#dst_offset (method)">dst_offset</a> could be found.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L250-L259'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='250' data-end='259'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 250</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_replace_with_existing_offsets'>replace_with_existing_offsets</span>(<span class='id identifier rubyid_offsets'>offsets</span><span class='comma'>,</span> <span class='id identifier rubyid_annual_rules'>annual_rules</span>)
  <span class='id identifier rubyid_existing_std_offset'>existing_std_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_find_existing_offset'><a href="#find_existing_offset-instance_method" title="TZInfo::DataSources::ZoneinfoReader#find_existing_offset (method)">find_existing_offset</a></span>(<span class='id identifier rubyid_offsets'>offsets</span><span class='comma'>,</span> <span class='id identifier rubyid_annual_rules'>annual_rules</span>.<span class='id identifier rubyid_std_offset'>std_offset</span>)
  <span class='id identifier rubyid_existing_dst_offset'>existing_dst_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_find_existing_offset'><a href="#find_existing_offset-instance_method" title="TZInfo::DataSources::ZoneinfoReader#find_existing_offset (method)">find_existing_offset</a></span>(<span class='id identifier rubyid_offsets'>offsets</span><span class='comma'>,</span> <span class='id identifier rubyid_annual_rules'>annual_rules</span>.<span class='id identifier rubyid_dst_offset'>dst_offset</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_existing_std_offset'>existing_std_offset</span> <span class='op'>||</span> <span class='id identifier rubyid_existing_dst_offset'>existing_dst_offset</span>
    <span class='const'><a href="../AnnualRules.html" title="TZInfo::AnnualRules (class)">AnnualRules</a></span>.<span class='id identifier rubyid_new'><a href="../AnnualRules.html#new-class_method" title="TZInfo::AnnualRules.new (method)">new</a></span>(<span class='id identifier rubyid_existing_std_offset'>existing_std_offset</span> <span class='op'>||</span> <span class='id identifier rubyid_annual_rules'>annual_rules</span>.<span class='id identifier rubyid_std_offset'>std_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_existing_dst_offset'>existing_dst_offset</span> <span class='op'>||</span> <span class='id identifier rubyid_annual_rules'>annual_rules</span>.<span class='id identifier rubyid_dst_offset'>dst_offset</span><span class='comma'>,</span>
      <span class='id identifier rubyid_annual_rules'>annual_rules</span>.<span class='id identifier rubyid_dst_start_rule'>dst_start_rule</span><span class='comma'>,</span> <span class='id identifier rubyid_annual_rules'>annual_rules</span>.<span class='id identifier rubyid_dst_end_rule'>dst_end_rule</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_annual_rules'>annual_rules</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="validate_and_fix_last_defined_transition_offset-instance_method">
  <h3 class='signature priv'>
    #<strong>validate_and_fix_last_defined_transition_offset</strong>(file, last_defined, first_rule_offset)  &#x21d2; <a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)">TimezoneTransition</a>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    <p>Validates the offset indicated to be observed by the rules before the
first generated transition against the offset of the last defined
transition.</p>

<p>Fix the last defined transition if it differ on just base/std offsets
(which are derived). Raise an error if the observed UTC offset or
abbreviations differ.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>file</span>
    <span class='type'>(<code>IO</code>)</span>
&mdash;    <div class='inline'><p>the file being processed.</p>
</div>
  </li>
  <li>
    <span class='name'>last_defined</span>
    <span class='type'>(<a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)">TimezoneTransition</a>)</span>
&mdash;    <div class='inline'><p>the last defined transition in
the file.</p>
</div>
  </li>
  <li>
    <span class='name'>first_rule_offset</span>
    <span class='type'>(<a href="../TimezoneOffset.html" title="TZInfo::TimezoneOffset (class)">TimezoneOffset</a>)</span>
&mdash;    <div class='inline'><p>the offset the rules indicate
is observed prior to the first rules generated transition.</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)">TimezoneTransition</a>)</span>
&mdash;    <div class='inline'><p>the last defined transition (either the
original instance or a replacement).</p>
</div>
  </li>
</ul>
<p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a>)</span>
&mdash;    <div class='inline'><p>if the offset of <code>last_defined</code> and
<code>first_rule_offset</code> do not match.</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/tzinfo/tzinfo/blob/master/lib/tzinfo/data_sources/zoneinfo_reader.rb#L278-L292'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='278' data-end='292'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/tzinfo/data_sources/zoneinfo_reader.rb', line 278</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_and_fix_last_defined_transition_offset'>validate_and_fix_last_defined_transition_offset</span>(<span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_last_defined'>last_defined</span><span class='comma'>,</span> <span class='id identifier rubyid_first_rule_offset'>first_rule_offset</span>)
  <span class='id identifier rubyid_offset_of_last_defined'>offset_of_last_defined</span> <span class='op'>=</span> <span class='id identifier rubyid_last_defined'>last_defined</span>.<span class='id identifier rubyid_offset'>offset</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_offset_of_last_defined'>offset_of_last_defined</span> <span class='op'>==</span> <span class='id identifier rubyid_first_rule_offset'>first_rule_offset</span>
    <span class='id identifier rubyid_last_defined'>last_defined</span>
  <span class='kw'>else</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_offset_matches_rule?'><a href="#offset_matches_rule%3F-instance_method" title="TZInfo::DataSources::ZoneinfoReader#offset_matches_rule? (method)">offset_matches_rule?</a></span>(<span class='id identifier rubyid_offset_of_last_defined'>offset_of_last_defined</span><span class='comma'>,</span> <span class='id identifier rubyid_first_rule_offset'>first_rule_offset</span>)
      <span class='comment'># The same overall offset, but differing in the base or std
</span>      <span class='comment'># offset (which are derived). Correct by using the rule.
</span>      <span class='const'><a href="../TimezoneTransition.html" title="TZInfo::TimezoneTransition (class)">TimezoneTransition</a></span>.<span class='id identifier rubyid_new'><a href="../TimezoneTransition.html#new-class_method" title="TZInfo::TimezoneTransition.new (method)">new</a></span>(<span class='id identifier rubyid_first_rule_offset'>first_rule_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_last_defined'>last_defined</span>.<span class='id identifier rubyid_previous_offset'>previous_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_last_defined'>last_defined</span>.<span class='id identifier rubyid_timestamp_value'>timestamp_value</span>)
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="InvalidZoneinfoFile.html" title="TZInfo::DataSources::InvalidZoneinfoFile (class)">InvalidZoneinfoFile</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The first offset indicated by the POSIX-style TZ string did not match the final defined offset in file &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>