<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Unicorn::Worker &mdash; Unicorn master</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Unicorn::Worker",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Unicorn master</a> &raquo; 
      <a href='../_index.html#alpha_W'>Index (W)</a> &raquo; 
        <a class='nodoc' href="../Unicorn.html" title="Unicorn (module)">Unicorn</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Worker&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Unicorn::Worker</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="../Object.html" title="Object (class)">Object</a></span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L11'>lib/unicorn/worker.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>This class and its members can be considered a stable interface and will not change in a backwards-incompatible fashion between releases of unicorn.  Knowledge of this class is generally not not needed for most users of unicorn.</p>

<p>Some users may want to access it in the before_fork/after_fork hooks. See the <a href="Configurator.html" title="Unicorn::Configurator (class)"><code>Configurator</code></a> RDoc for examples.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='DROPS-constant' class='summary_signature nodoc'>DROPS =</span>
    <span class='nodoc note title'>Internal use only</span>
    <br/>
    <a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L18-L18'># File 'lib/unicorn/worker.rb', line 18</a>    <pre class='code ruby'>[]</pre>
  </li>
  <li>
    <span id='PER_DROP-constant' class='summary_signature nodoc'>PER_DROP =</span>
    <span class='nodoc note title'>Internal use only</span>
    <br/>
    <a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L17-L17'># File 'lib/unicorn/worker.rb', line 17</a>    <pre class='code ruby'><span class='const'>Raindrops</span><span class='op'>::</span><span class='const'>PAGE_SIZE</span> <span class='op'>/</span> <span class='const'>Raindrops</span><span class='op'>::</span><span class='const'>SIZE</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(nr, pipe = nil)  &#x21d2; Worker </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#master-instance_method" title="#master (instance method)">#<strong>master</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature rw nodoc'>
      <a href="#nr-instance_method" title="#nr (instance method)">#<strong>nr</strong>  </a>
    </span>
    <span class='note title rw'>rw</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature rw nodoc'>
      <a href="#switched-instance_method" title="#switched (instance method)">#<strong>switched</strong>  </a>
    </span>
    <span class='note title rw'>rw</span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature rw nodoc'>
      <a href="#tick-instance_method" title="#tick (instance method)">#<strong>tick</strong>  </a>
    </span>
    <span class='note title rw'>rw</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>called in the master process.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature rw nodoc'>
      <a href="#tick=-instance_method" title="#tick= (instance method)">#<strong>tick=</strong>(value)  </a>
    </span>
    <span class='note title rw'>rw</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>called in the worker process.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro nodoc'>
      <a href="#to_io-instance_method" title="#to_io (instance method)">#<strong>to_io</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p><code>IO.select-compatible</code></p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#user-instance_method" title="#user (instance method)">#<strong>user</strong>(user, group = nil, chroot = false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>In most cases, you should be using the <a href="Configurator.html#user-instance_method" title="Unicorn::Configurator#user (method)">Configurator#user</a> directive instead.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#==-instance_method" title="#== (instance method)">#<strong>==</strong>(other_nr)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>worker objects may be compared to just plain Integers.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#accept_nonblock-instance_method" title="#accept_nonblock (instance method)">#<strong>accept_nonblock</strong>(*_unused)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>this only runs when the Rack app.call is not running act like <code>Socket#accept_nonblock</code>(exception: false).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#atfork_child-instance_method" title="#atfork_child (instance method)">#<strong>atfork_child</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#atfork_parent-instance_method" title="#atfork_parent (instance method)">#<strong>atfork_parent</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>parent does not read.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#close-instance_method" title="#close (instance method)">#<strong>close</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>called in both the master (reaping worker) and worker (SIGQUIT handler).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#fake_sig-instance_method" title="#fake_sig (instance method)">#<strong>fake_sig</strong>(sig)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>call a signal handler immediately without triggering EINTR We do not use the more obvious <code>Process.kill</code>(sig, $$) here since that signal delivery may be deferred.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#quit-instance_method" title="#quit (instance method)">#<strong>quit</strong>  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>master fakes SIGQUIT using this.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature nodoc'>
      <a href="#soft_kill-instance_method" title="#soft_kill (instance method)">#<strong>soft_kill</strong>(sig)  </a>
    </span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>master sends fake signals to children.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature nodoc first'>
    .<strong>new</strong>(nr, pipe = nil)  &#x21d2; <code>Worker</code> 
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L20-L28'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='20' data-end='28'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 20</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_nr'><a href="#nr-instance_method" title="Unicorn::Worker#nr (method)">nr</a></span><span class='comma'>,</span> <span class='id identifier rubyid_pipe'><a href="../Unicorn.html#pipe-class_method" title="Unicorn.pipe (method)">pipe</a></span><span class='op'>=</span><span class='kw'>nil</span>)
  <span class='id identifier rubyid_drop_index'>drop_index</span> <span class='op'>=</span> <span class='id identifier rubyid_nr'><a href="#nr-instance_method" title="Unicorn::Worker#nr (method)">nr</a></span> <span class='op'>/</span> <span class='const'><a href="#PER_DROP-constant" title="Unicorn::Worker::PER_DROP (constant)">PER_DROP</a></span>
  <span class='ivar'>@raindrop</span> <span class='op'>=</span> <span class='const'><a href="#DROPS-constant" title="Unicorn::Worker::DROPS (constant)">DROPS</a></span>[<span class='id identifier rubyid_drop_index'>drop_index</span>] <span class='op'>||=</span> <span class='const'>Raindrops</span>.<span class='id identifier rubyid_new'>new</span>(<span class='const'><a href="#PER_DROP-constant" title="Unicorn::Worker::PER_DROP (constant)">PER_DROP</a></span>)
  <span class='ivar'>@offset</span> <span class='op'>=</span> <span class='id identifier rubyid_nr'><a href="#nr-instance_method" title="Unicorn::Worker#nr (method)">nr</a></span> <span class='op'>%</span> <span class='const'><a href="#PER_DROP-constant" title="Unicorn::Worker::PER_DROP (constant)">PER_DROP</a></span>
  <span class='ivar'>@raindrop</span>[<span class='ivar'>@offset</span>] <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@nr</span> <span class='op'>=</span> <span class='id identifier rubyid_nr'><a href="#nr-instance_method" title="Unicorn::Worker#nr (method)">nr</a></span>
  <span class='ivar'>@switched</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@to_io</span><span class='comma'>,</span> <span class='ivar'>@master</span> <span class='op'>=</span> <span class='id identifier rubyid_pipe'><a href="../Unicorn.html#pipe-class_method" title="Unicorn.pipe (method)">pipe</a></span> <span class='op'>||</span> <span class='const'><a href="../Unicorn.html" title="Unicorn (module)">Unicorn</a></span>.<span class='id identifier rubyid_pipe'><a href="../Unicorn.html#pipe-class_method" title="Unicorn.pipe (method)">pipe</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="master-instance_method">
  <h3 class='signature ro  nodoc first'>
    #<strong>master</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L15-L15'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='15' data-end='15'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 15</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_master'>master</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="nr-instance_method">
  <h3 class='signature rw  nodoc'>
    #<strong>nr</strong>   <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L13-L13'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='13' data-end='13'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 13</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbeg'>:</span><span class='id identifier rubyid_nr'>nr</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_switched'><a href="#switched-instance_method" title="Unicorn::Worker#switched (method)">switched</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="switched-instance_method">
  <h3 class='signature rw  nodoc'>
    #<strong>switched</strong>   <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L13-L13'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='13' data-end='13'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 13</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbeg'>:</span><span class='id identifier rubyid_nr'><a href="#nr-instance_method" title="Unicorn::Worker#nr (method)">nr</a></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_switched'>switched</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="tick-instance_method">
  <h3 class='signature rw  nodoc'>
    #<strong>tick</strong>   <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>called in the master process</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L100-L102'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='100' data-end='102'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 100</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_tick'>tick</span> <span class='comment'># :nodoc:
</span>  <span class='ivar'>@raindrop</span>[<span class='ivar'>@offset</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="tick=-instance_method">
  <h3 class='signature rw  nodoc'>
    #<strong>tick=</strong>(value)   <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>called in the worker process</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L95-L97'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='95' data-end='97'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 95</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_tick='>tick=</span>(<span class='id identifier rubyid_value'>value</span>) <span class='comment'># :nodoc:
</span>  <span class='ivar'>@raindrop</span>[<span class='ivar'>@offset</span>] <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="to_io-instance_method">
  <h3 class='signature ro  nodoc'>
    #<strong>to_io</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p><code>IO.select-compatible</code></p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L14-L14'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='14' data-end='14'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 14</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_to_io'>to_io</span> <span class='comment'># IO.select-compatible</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="==-instance_method">
  <h3 class='signature nodoc first'>
    #<strong>==</strong>(other_nr)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>worker objects may be compared to just plain Integers</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L90-L92'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='90' data-end='92'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 90</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='op'>==</span>(<span class='id identifier rubyid_other_nr'>other_nr</span>) <span class='comment'># :nodoc:
</span>  <span class='ivar'>@nr</span> <span class='op'>==</span> <span class='id identifier rubyid_other_nr'>other_nr</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="accept_nonblock-instance_method">
  <h3 class='signature nodoc'>
    #<strong>accept_nonblock</strong>(*_unused)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>this only runs when the Rack app.call is not running act like <code>Socket#accept_nonblock</code>(exception: false)</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L75-L87'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='75' data-end='87'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 75</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_accept_nonblock'>accept_nonblock</span>(<span class='op'>*</span><span class='id identifier rubyid__unused'>_unused</span>) <span class='comment'># :nodoc:
</span>  <span class='kw'>case</span> <span class='id identifier rubyid_buf'>buf</span> <span class='op'>=</span> <span class='ivar'>@to_io</span>.<span class='id identifier rubyid_read_nonblock'>read_nonblock</span>(<span class='int'>4</span><span class='comma'>,</span> <span class='label'>exception:</span> <span class='kw'>false</span>)
  <span class='kw'>when</span> <span class='const'>String</span>
    <span class='comment'># unpack the buffer and trigger the signal handler
</span>    <span class='id identifier rubyid_signum'>signum</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span>.<span class='id identifier rubyid_unpack'>unpack</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>l</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_fake_sig'><a href="#fake_sig-instance_method" title="Unicorn::Worker#fake_sig (method)">fake_sig</a></span>(<span class='id identifier rubyid_signum'>signum</span>[<span class='int'>0</span>])
    <span class='comment'># keep looping, more signals may be queued
</span>  <span class='kw'>when</span> <span class='kw'>nil</span> <span class='comment'># EOF: master died, but we are at a safe place to exit
</span>    <span class='id identifier rubyid_fake_sig'><a href="#fake_sig-instance_method" title="Unicorn::Worker#fake_sig (method)">fake_sig</a></span>(<span class='symbeg'>:</span><span class='const'>QUIT</span>)
  <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_wait_readable'>wait_readable</span> <span class='comment'># keep waiting
</span>    <span class='kw'>return</span> <span class='symbeg'>:</span><span class='id identifier rubyid_wait_readable'>wait_readable</span>
  <span class='kw'>end</span> <span class='kw'>while</span> <span class='kw'>true</span> <span class='comment'># loop, as multiple signals may be sent
</span><span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="atfork_child-instance_method">
  <h3 class='signature nodoc'>
    #<strong>atfork_child</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L30-L33'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='30' data-end='33'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 30</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_atfork_child'>atfork_child</span> <span class='comment'># :nodoc:
</span>  <span class='comment'># we _must_ close in child, parent just holds this open to signal
</span>  <span class='ivar'>@master</span> <span class='op'>=</span> <span class='ivar'>@master</span>.<span class='id identifier rubyid_close'><a href="#close-instance_method" title="Unicorn::Worker#close (method)">close</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="atfork_parent-instance_method">
  <h3 class='signature nodoc'>
    #<strong>atfork_parent</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>parent does not read</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L41-L43'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='41' data-end='43'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 41</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_atfork_parent'>atfork_parent</span> <span class='comment'># :nodoc:
</span>  <span class='ivar'>@to_io</span> <span class='op'>=</span> <span class='ivar'>@to_io</span>.<span class='id identifier rubyid_close'><a href="#close-instance_method" title="Unicorn::Worker#close (method)">close</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="close-instance_method">
  <h3 class='signature nodoc'>
    #<strong>close</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>called in both the master (reaping worker) and worker (SIGQUIT handler)</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L105-L108'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='105' data-end='108'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 105</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_close'>close</span> <span class='comment'># :nodoc:
</span>  <span class='ivar'>@master</span>.<span class='id identifier rubyid_close'>close</span> <span class='kw'>if</span> <span class='ivar'>@master</span>
  <span class='ivar'>@to_io</span>.<span class='id identifier rubyid_close'>close</span> <span class='kw'>if</span> <span class='ivar'>@to_io</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="fake_sig-instance_method">
  <h3 class='signature nodoc'>
    #<strong>fake_sig</strong>(sig)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>call a signal handler immediately without triggering EINTR We do not use the more obvious <code>Process.kill</code>(sig, $$) here since that signal delivery may be deferred.  We want to avoid signal delivery while the Rack app.call is running because some database drivers (e.g. ruby-pg) may cancel pending requests.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L50-L55'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='50' data-end='55'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 50</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_fake_sig'>fake_sig</span>(<span class='id identifier rubyid_sig'>sig</span>) <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_old_cb'>old_cb</span> <span class='op'>=</span> <span class='id identifier rubyid_trap'>trap</span>(<span class='id identifier rubyid_sig'>sig</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>IGNORE</span><span class='tstring_end'>&quot;</span></span>)
  <span class='id identifier rubyid_old_cb'>old_cb</span>.<span class='id identifier rubyid_call'>call</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_trap'>trap</span>(<span class='id identifier rubyid_sig'>sig</span><span class='comma'>,</span> <span class='id identifier rubyid_old_cb'>old_cb</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="quit-instance_method">
  <h3 class='signature nodoc'>
    #<strong>quit</strong>  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>master fakes SIGQUIT using this</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L36-L38'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='36' data-end='38'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 36</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_quit'>quit</span> <span class='comment'># :nodoc:
</span>  <span class='ivar'>@master</span> <span class='op'>=</span> <span class='ivar'>@master</span>.<span class='id identifier rubyid_close'><a href="#close-instance_method" title="Unicorn::Worker#close (method)">close</a></span> <span class='kw'>if</span> <span class='ivar'>@master</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="soft_kill-instance_method">
  <h3 class='signature nodoc'>
    #<strong>soft_kill</strong>(sig)  
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>master sends fake signals to children</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L58-L71'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='58' data-end='71'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 58</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_soft_kill'>soft_kill</span>(<span class='id identifier rubyid_sig'>sig</span>) <span class='comment'># :nodoc:
</span>  <span class='kw'>case</span> <span class='id identifier rubyid_sig'>sig</span>
  <span class='kw'>when</span> <span class='const'>Integer</span>
    <span class='id identifier rubyid_signum'>signum</span> <span class='op'>=</span> <span class='id identifier rubyid_sig'>sig</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_signum'>signum</span> <span class='op'>=</span> <span class='const'>Signal</span>.<span class='id identifier rubyid_list'>list</span>[<span class='id identifier rubyid_sig'>sig</span>.<span class='id identifier rubyid_to_s'>to_s</span>] <span class='kw'>or</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>BUG: bad signal: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_sig'>sig</span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='comment'># writing and reading 4 bytes on a pipe is atomic on all POSIX platforms
</span>  <span class='comment'># Do not care in the odd case the buffer is full, here.
</span>  <span class='ivar'>@master</span>.<span class='id identifier rubyid_write_nonblock'>write_nonblock</span>([<span class='id identifier rubyid_signum'>signum</span>].<span class='id identifier rubyid_pack'>pack</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>l</span><span class='tstring_end'>&#39;</span></span>)<span class='comma'>,</span> <span class='label'>exception:</span> <span class='kw'>false</span>)
<span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>EPIPE</span>
  <span class='comment'># worker will be reaped soon
</span><span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="user-instance_method">
  <h3 class='signature '>
    #<strong>user</strong>(user, group = nil, chroot = false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>In most cases, you should be using the <a href="Configurator.html#user-instance_method" title="Unicorn::Configurator#user (method)">Configurator#user</a> directive instead.  This method should only be used if you need fine-grained control of exactly when you want to change permissions in your after_fork or after_worker_ready hooks, or if you want to use the chroot support.</p>

<p>Changes the worker process to the specified <code>user</code> and <code>group</code>, and chroots to the current working directory if <code>chroot</code> is set. This is only intended to be called from within the worker process from the <code>after_fork</code> hook.  This should be called in the <code>after_fork</code> hook after any privileged functions need to be run (e.g. to set per-worker CPU affinity, niceness, etc)</p>

<p><code>group</code> can be specified as a string, or as an array of two strings.  If an array of two strings is given, the first string is used as the primary group of the process, and the second is used as the group of the log files.</p>

<p>Any and all errors raised within this method will be propagated directly back to the caller (usually the <code>after_fork</code> hook. These errors commonly include ArgumentError for specifying an invalid user/group and <code>Errno::EPERM</code> for insufficient privileges.</p>

<p>chroot support is only available in unicorn 5.3.0+ user and group switching appeared in unicorn 0.94.0 (2009-11-05)</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/defunkt/unicorn/blob/master/lib/unicorn/worker.rb#L137-L164'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='137' data-end='164'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/unicorn/worker.rb', line 137</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_user'>user</span>(<span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_group'>group</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_chroot'>chroot</span> <span class='op'>=</span> <span class='kw'>false</span>)
  <span class='comment'># we do not protect the caller, checking Process.euid == 0 is
</span>  <span class='comment'># insufficient because modern systems have fine-grained
</span>  <span class='comment'># capabilities.  Let the caller handle any and all errors.
</span>  <span class='id identifier rubyid_uid'>uid</span> <span class='op'>=</span> <span class='const'>Etc</span>.<span class='id identifier rubyid_getpwnam'>getpwnam</span>(<span class='id identifier rubyid_user'>user</span>).<span class='id identifier rubyid_uid'>uid</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_group'>group</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_group'>group</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'>Array</span>)
      <span class='id identifier rubyid_group'>group</span><span class='comma'>,</span> <span class='id identifier rubyid_log_group'>log_group</span> <span class='op'>=</span> <span class='id identifier rubyid_group'>group</span>
      <span class='id identifier rubyid_log_gid'>log_gid</span> <span class='op'>=</span> <span class='const'>Etc</span>.<span class='id identifier rubyid_getgrnam'>getgrnam</span>(<span class='id identifier rubyid_log_group'>log_group</span>).<span class='id identifier rubyid_gid'>gid</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_gid'>gid</span> <span class='op'>=</span> <span class='const'>Etc</span>.<span class='id identifier rubyid_getgrnam'>getgrnam</span>(<span class='id identifier rubyid_group'>group</span>).<span class='id identifier rubyid_gid'>gid</span>
    <span class='id identifier rubyid_log_gid'>log_gid</span> <span class='op'>||=</span> <span class='id identifier rubyid_gid'>gid</span>
  <span class='kw'>end</span>

  <span class='const'><a href="../Unicorn.html" title="Unicorn (module)">Unicorn</a></span><span class='op'>::</span><span class='const'><a href="Util.html" title="Unicorn::Util (module)">Util</a></span>.<span class='id identifier rubyid_chown_logs'><a href="Util.html#chown_logs-class_method" title="Unicorn::Util.chown_logs (method)">chown_logs</a></span>(<span class='id identifier rubyid_uid'>uid</span><span class='comma'>,</span> <span class='id identifier rubyid_log_gid'>log_gid</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_gid'>gid</span> <span class='op'>&amp;&amp;</span> <span class='const'>Process</span>.<span class='id identifier rubyid_egid'>egid</span> <span class='op'>!=</span> <span class='id identifier rubyid_gid'>gid</span>
    <span class='const'>Process</span>.<span class='id identifier rubyid_initgroups'>initgroups</span>(<span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_gid'>gid</span>)
    <span class='const'>Process</span><span class='op'>::</span><span class='const'>GID</span>.<span class='id identifier rubyid_change_privilege'>change_privilege</span>(<span class='id identifier rubyid_gid'>gid</span>)
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_chroot'>chroot</span>
    <span class='id identifier rubyid_chroot'>chroot</span> <span class='op'>=</span> <span class='const'>Dir</span>.<span class='id identifier rubyid_pwd'>pwd</span> <span class='kw'>if</span> <span class='id identifier rubyid_chroot'>chroot</span> <span class='op'>==</span> <span class='kw'>true</span>
    <span class='const'>Dir</span>.<span class='id identifier rubyid_chroot'>chroot</span>(<span class='id identifier rubyid_chroot'>chroot</span>)
    <span class='const'>Dir</span>.<span class='id identifier rubyid_chdir'>chdir</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>end</span>
  <span class='const'>Process</span>.<span class='id identifier rubyid_euid'>euid</span> <span class='op'>!=</span> <span class='id identifier rubyid_uid'>uid</span> <span class='kw'>and</span> <span class='const'>Process</span><span class='op'>::</span><span class='const'>UID</span>.<span class='id identifier rubyid_change_privilege'>change_privilege</span>(<span class='id identifier rubyid_uid'>uid</span>)
  <span class='ivar'>@switched</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>