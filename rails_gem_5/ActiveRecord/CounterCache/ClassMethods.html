<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ActiveRecord::CounterCache::ClassMethods &mdash; Rails 5.2.8.1</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::CounterCache::ClassMethods",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Rails 5.2.8.1</a> &raquo; 
      <a href='../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
        <a href="../CounterCache.html" title="ActiveRecord::CounterCache (module)">CounterCache</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ClassMethods&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: ActiveRecord::CounterCache::ClassMethods</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/v5.2.8.1/activerecord/lib/active_record/counter_cache.rb#L8'>activerecord/lib/active_record/counter_cache.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#decrement_counter-instance_method" title="#decrement_counter (instance method)">#<strong>decrement_counter</strong>(counter_name, id, touch: nil)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Decrement a numeric field by one, via a direct SQL update.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#increment_counter-instance_method" title="#increment_counter (instance method)">#<strong>increment_counter</strong>(counter_name, id, touch: nil)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Increment a numeric field by one, via a direct SQL update.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#reset_counters-instance_method" title="#reset_counters (instance method)">#<strong>reset_counters</strong>(id, *counters, touch: nil)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Resets one or more counter caches to their correct value using an SQL count query.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#update_counters-instance_method" title="#update_counters (instance method)">#<strong>update_counters</strong>(id, counters)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>A generic “counter updater” implementation, intended primarily to be used by <a href="#increment_counter-instance_method" title="ActiveRecord::CounterCache::ClassMethods#increment_counter (method)">#increment_counter</a> and <a href="#decrement_counter-instance_method" title="ActiveRecord::CounterCache::ClassMethods#decrement_counter (method)">#decrement_counter</a>, but which may also be useful on its own.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="decrement_counter-instance_method">
  <h3 class='signature  first'>
    #<strong>decrement_counter</strong>(counter_name, id, touch: nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Decrement a numeric field by one, via a direct SQL update.</p>

<p>This works the same as <a href="#increment_counter-instance_method" title="ActiveRecord::CounterCache::ClassMethods#increment_counter (method)">#increment_counter</a> but reduces the column value by 1 instead of increasing it.</p>

<h4 id="label-Parameters">Parameters</h4>
<ul><li>
<p><code>counter_name</code> - The name of the field that should be decremented.</p>
</li><li>
<p><code>id</code> - The id of the object that should be decremented or an array of ids.</p>
</li><li>
<p><code>:touch</code> - Touch timestamp columns when updating. Pass <code>true</code> to touch <code>updated_at</code> and/or <code>updated_on</code>. Pass a symbol to touch that column or an array of symbols to touch just those ones.</p>
</li></ul>

<h4 id="label-Examples">Examples</h4>

<pre class="code ruby"><code class="ruby"><span class='comment'># Decrement the posts_count column for the record with an id of 5
</span><span class='const'>DiscussionBoard</span>.<span class='id identifier rubyid_decrement_counter'>decrement_counter</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_posts_count'>posts_count</span><span class='comma'>,</span> <span class='int'>5</span>)

<span class='comment'># Decrement the posts_count column for the record with an id of 5
</span><span class='comment'># and update the updated_at value.
</span><span class='const'>DiscussionBoard</span>.<span class='id identifier rubyid_decrement_counter'>decrement_counter</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_posts_count'>posts_count</span><span class='comma'>,</span> <span class='int'>5</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>)</code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v5.2.8.1/activerecord/lib/active_record/counter_cache.rb#L176-L178'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='176' data-end='178'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/counter_cache.rb', line 176</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_decrement_counter'>decrement_counter</span>(<span class='id identifier rubyid_counter_name'>counter_name</span><span class='comma'>,</span> <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_update_counters'><a href="#update_counters-instance_method" title="ActiveRecord::CounterCache::ClassMethods#update_counters (method)">update_counters</a></span>(<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_counter_name'>counter_name</span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>1</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='id identifier rubyid_touch'>touch</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="increment_counter-instance_method">
  <h3 class='signature '>
    #<strong>increment_counter</strong>(counter_name, id, touch: nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Increment a numeric field by one, via a direct SQL update.</p>

<p>This method is used primarily for maintaining counter_cache columns that are used to store aggregate values. For example, a <code>DiscussionBoard</code> may cache posts_count and comments_count to avoid running an SQL query to calculate the number of posts and comments there are, each time it is displayed.</p>

<h4 id="label-Parameters">Parameters</h4>
<ul><li>
<p><code>counter_name</code> - The name of the field that should be incremented.</p>
</li><li>
<p><code>id</code> - The id of the object that should be incremented or an array of ids.</p>
</li><li>
<p><code>:touch</code> - Touch timestamp columns when updating. Pass <code>true</code> to touch <code>updated_at</code> and/or <code>updated_on</code>. Pass a symbol to touch that column or an array of symbols to touch just those ones.</p>
</li></ul>

<h4 id="label-Examples">Examples</h4>

<pre class="code ruby"><code class="ruby"><span class='comment'># Increment the posts_count column for the record with an id of 5
</span><span class='const'>DiscussionBoard</span>.<span class='id identifier rubyid_increment_counter'>increment_counter</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_posts_count'>posts_count</span><span class='comma'>,</span> <span class='int'>5</span>)

<span class='comment'># Increment the posts_count column for the record with an id of 5
</span><span class='comment'># and update the updated_at value.
</span><span class='const'>DiscussionBoard</span>.<span class='id identifier rubyid_increment_counter'>increment_counter</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_posts_count'>posts_count</span><span class='comma'>,</span> <span class='int'>5</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>)</code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v5.2.8.1/activerecord/lib/active_record/counter_cache.rb#L151-L153'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='151' data-end='153'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/counter_cache.rb', line 151</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_increment_counter'>increment_counter</span>(<span class='id identifier rubyid_counter_name'>counter_name</span><span class='comma'>,</span> <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_update_counters'><a href="#update_counters-instance_method" title="ActiveRecord::CounterCache::ClassMethods#update_counters (method)">update_counters</a></span>(<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_counter_name'>counter_name</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='id identifier rubyid_touch'>touch</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="reset_counters-instance_method">
  <h3 class='signature '>
    #<strong>reset_counters</strong>(id, *counters, touch: nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Resets one or more counter caches to their correct value using an SQL count query. This is useful when adding new counter caches, or if the counter has been corrupted or modified directly by SQL.</p>

<h4 id="label-Parameters">Parameters</h4>
<ul><li>
<p><code>id</code> - The id of the object you wish to reset a counter on.</p>
</li><li>
<p><code>counters</code> - One or more association counters to reset. Association name or counter name can be given.</p>
</li><li>
<p><code>:touch</code> - Touch timestamp columns when updating. Pass <code>true</code> to touch <code>updated_at</code> and/or <code>updated_on</code>. Pass a symbol to touch that column or an array of symbols to touch just those ones.</p>
</li></ul>

<h4 id="label-Examples">Examples</h4>

<pre class="code ruby"><code class="ruby"><span class='comment'># For the Post with id #1, reset the comments_count
</span><span class='const'>Post</span>.<span class='id identifier rubyid_reset_counters'>reset_counters</span>(<span class='int'>1</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>)

<span class='comment'># Like above, but also touch the updated_at and/or updated_on
</span><span class='comment'># attributes.
</span><span class='const'>Post</span>.<span class='id identifier rubyid_reset_counters'>reset_counters</span>(<span class='int'>1</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>)</code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v5.2.8.1/activerecord/lib/active_record/counter_cache.rb#L29-L61'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='29' data-end='61'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/counter_cache.rb', line 29</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_reset_counters'>reset_counters</span>(<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_counters'>counters</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_object'>object</span> <span class='op'>=</span> <span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_id'>id</span>)

  <span class='id identifier rubyid_counters'>counters</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_counter_association'>counter_association</span><span class='op'>|</span>
    <span class='id identifier rubyid_has_many_association'>has_many_association</span> <span class='op'>=</span> <span class='id identifier rubyid__reflect_on_association'>_reflect_on_association</span>(<span class='id identifier rubyid_counter_association'>counter_association</span>)
    <span class='kw'>unless</span> <span class='id identifier rubyid_has_many_association'>has_many_association</span>
      <span class='id identifier rubyid_has_many'>has_many</span> <span class='op'>=</span> <span class='id identifier rubyid_reflect_on_all_associations'>reflect_on_all_associations</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_has_many'>has_many</span>)
      <span class='id identifier rubyid_has_many_association'>has_many_association</span> <span class='op'>=</span> <span class='id identifier rubyid_has_many'>has_many</span>.<span class='id identifier rubyid_find'>find</span> { <span class='op'>|</span><span class='id identifier rubyid_association'>association</span><span class='op'>|</span> <span class='id identifier rubyid_association'>association</span>.<span class='id identifier rubyid_counter_cache_column'>counter_cache_column</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_association'>association</span>.<span class='id identifier rubyid_counter_cache_column'>counter_cache_column</span>.<span class='id identifier rubyid_to_sym'>to_sym</span> <span class='op'>==</span> <span class='id identifier rubyid_counter_association'>counter_association</span>.<span class='id identifier rubyid_to_sym'>to_sym</span> }
      <span class='id identifier rubyid_counter_association'>counter_association</span> <span class='op'>=</span> <span class='id identifier rubyid_has_many_association'>has_many_association</span>.<span class='id identifier rubyid_plural_name'>plural_name</span> <span class='kw'>if</span> <span class='id identifier rubyid_has_many_association'>has_many_association</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; has no association called &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_counter_association'>counter_association</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_has_many_association'>has_many_association</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_has_many_association'>has_many_association</span>.<span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Reflection.html" title="ActiveRecord::Reflection (module)">Reflection</a></span><span class='op'>::</span><span class='const'><a href="../Reflection/ThroughReflection.html" title="ActiveRecord::Reflection::ThroughReflection (class)">ThroughReflection</a></span>
      <span class='id identifier rubyid_has_many_association'>has_many_association</span> <span class='op'>=</span> <span class='id identifier rubyid_has_many_association'>has_many_association</span>.<span class='id identifier rubyid_through_reflection'>through_reflection</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_foreign_key'>foreign_key</span>  <span class='op'>=</span> <span class='id identifier rubyid_has_many_association'>has_many_association</span>.<span class='id identifier rubyid_foreign_key'>foreign_key</span>.<span class='id identifier rubyid_to_s'>to_s</span>
    <span class='id identifier rubyid_child_class'>child_class</span>  <span class='op'>=</span> <span class='id identifier rubyid_has_many_association'>has_many_association</span>.<span class='id identifier rubyid_klass'>klass</span>
    <span class='id identifier rubyid_reflection'>reflection</span>   <span class='op'>=</span> <span class='id identifier rubyid_child_class'>child_class</span>.<span class='id identifier rubyid__reflections'>_reflections</span>.<span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_find'>find</span> { <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_belongs_to?'>belongs_to?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_foreign_key'>foreign_key</span>.<span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='id identifier rubyid_foreign_key'>foreign_key</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_counter_cache'>counter_cache</span>].<span class='id identifier rubyid_present?'>present?</span> }
    <span class='id identifier rubyid_counter_name'>counter_name</span> <span class='op'>=</span> <span class='id identifier rubyid_reflection'>reflection</span>.<span class='id identifier rubyid_counter_cache_column'>counter_cache_column</span>

    <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> { <span class='id identifier rubyid_counter_name'>counter_name</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_object'>object</span>.<span class='id identifier rubyid_send'>send</span>(<span class='id identifier rubyid_counter_association'>counter_association</span>).<span class='id identifier rubyid_count'>count</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_all'>all</span>) }

    <span class='kw'>if</span> <span class='id identifier rubyid_touch'>touch</span>
      <span class='id identifier rubyid_names'>names</span> <span class='op'>=</span> <span class='id identifier rubyid_touch'>touch</span> <span class='kw'>if</span> <span class='id identifier rubyid_touch'>touch</span> <span class='op'>!=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_updates'>updates</span>.<span class='id identifier rubyid_merge!'>merge!</span>(<span class='id identifier rubyid_touch_attributes_with_time'>touch_attributes_with_time</span>(<span class='op'>*</span><span class='id identifier rubyid_names'>names</span>))
    <span class='kw'>end</span>

    <span class='id identifier rubyid_unscoped'>unscoped</span>.<span class='id identifier rubyid_where'>where</span>(<span class='id identifier rubyid_primary_key'>primary_key</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_object'>object</span>.<span class='id identifier rubyid_id'>id</span>).<span class='id identifier rubyid_update_all'>update_all</span>(<span class='id identifier rubyid_updates'>updates</span>)
  <span class='kw'>end</span>

  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_counters-instance_method">
  <h3 class='signature '>
    #<strong>update_counters</strong>(id, counters)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>A generic “counter updater” implementation, intended primarily to be used by <a href="#increment_counter-instance_method" title="ActiveRecord::CounterCache::ClassMethods#increment_counter (method)">#increment_counter</a> and <a href="#decrement_counter-instance_method" title="ActiveRecord::CounterCache::ClassMethods#decrement_counter (method)">#decrement_counter</a>, but which may also be useful on its own. It simply does a direct SQL update for the record with the given ID, altering the given hash of counters by the amount given by the corresponding value:</p>

<h4 id="label-Parameters">Parameters</h4>
<ul><li>
<p><code>id</code> - The id of the object you wish to update a counter on or an array of ids.</p>
</li><li>
<p><code>counters</code> - A Hash containing the names of the fields to update as keys and the amount to update the field by as values.</p>
</li><li>
<p><code>:touch</code> option - Touch timestamp columns when updating. If attribute names are passed, they are updated along with updated_at/on attributes.</p>
</li></ul>

<h4 id="label-Examples">Examples</h4>

<pre class="code ruby"><code class="ruby"><span class='comment'># For the Post with id of 5, decrement the comment_count by 1, and
</span><span class='comment'># increment the action_count by 1
</span><span class='const'>Post</span>.<span class='id identifier rubyid_update_counters'>update_counters</span> <span class='int'>5</span><span class='comma'>,</span> <span class='label'>comment_count:</span> <span class='op'>-</span><span class='int'>1</span><span class='comma'>,</span> <span class='label'>action_count:</span> <span class='int'>1</span>
<span class='comment'># Executes the following SQL:
</span><span class='comment'># UPDATE posts
</span><span class='comment'>#    SET comment_count = COALESCE(comment_count, 0) - 1,
</span><span class='comment'>#        action_count = COALESCE(action_count, 0) + 1
</span><span class='comment'>#  WHERE id = 5
</span>
<span class='comment'># For the Posts with id of 10 and 15, increment the comment_count by 1
</span><span class='const'>Post</span>.<span class='id identifier rubyid_update_counters'>update_counters</span> [<span class='int'>10</span><span class='comma'>,</span> <span class='int'>15</span>]<span class='comma'>,</span> <span class='label'>comment_count:</span> <span class='int'>1</span>
<span class='comment'># Executes the following SQL:
</span><span class='comment'># UPDATE posts
</span><span class='comment'>#    SET comment_count = COALESCE(comment_count, 0) + 1
</span><span class='comment'>#  WHERE id IN (10, 15)
</span>
<span class='comment'># For the Posts with id of 10 and 15, increment the comment_count by 1
</span><span class='comment'># and update the updated_at value for each counter.
</span><span class='const'>Post</span>.<span class='id identifier rubyid_update_counters'>update_counters</span> [<span class='int'>10</span><span class='comma'>,</span> <span class='int'>15</span>]<span class='comma'>,</span> <span class='label'>comment_count:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>
<span class='comment'># Executes the following SQL:
</span><span class='comment'># UPDATE posts
</span><span class='comment'>#    SET comment_count = COALESCE(comment_count, 0) + 1,
</span><span class='comment'>#    `updated_at` = &#39;2016-10-13T09:59:23-05:00&#39;
</span><span class='comment'>#  WHERE id IN (10, 15)</span></code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v5.2.8.1/activerecord/lib/active_record/counter_cache.rb#L104-L126'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='104' data-end='126'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/counter_cache.rb', line 104</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_counters'>update_counters</span>(<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_counters'>counters</span>)
  <span class='id identifier rubyid_touch'>touch</span> <span class='op'>=</span> <span class='id identifier rubyid_counters'>counters</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_touch'>touch</span>)

  <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='id identifier rubyid_counters'>counters</span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_counter_name'>counter_name</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
    <span class='id identifier rubyid_operator'>operator</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span> <span class='op'>&lt;</span> <span class='int'>0</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_quoted_column'>quoted_column</span> <span class='op'>=</span> <span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_quote_column_name'>quote_column_name</span>(<span class='id identifier rubyid_counter_name'>counter_name</span>)
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_quoted_column'>quoted_column</span><span class='embexpr_end'>}</span><span class='tstring_content'> = COALESCE(</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_quoted_column'>quoted_column</span><span class='embexpr_end'>}</span><span class='tstring_content'>, 0) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_operator'>operator</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_abs'>abs</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_touch'>touch</span>
    <span class='id identifier rubyid_names'>names</span> <span class='op'>=</span> <span class='id identifier rubyid_touch'>touch</span> <span class='kw'>if</span> <span class='id identifier rubyid_touch'>touch</span> <span class='op'>!=</span> <span class='kw'>true</span>
    <span class='id identifier rubyid_touch_updates'>touch_updates</span> <span class='op'>=</span> <span class='id identifier rubyid_touch_attributes_with_time'>touch_attributes_with_time</span>(<span class='op'>*</span><span class='id identifier rubyid_names'>names</span>)
    <span class='id identifier rubyid_updates'>updates</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_sanitize_sql_for_assignment'>sanitize_sql_for_assignment</span>(<span class='id identifier rubyid_touch_updates'>touch_updates</span>) <span class='kw'>unless</span> <span class='id identifier rubyid_touch_updates'>touch_updates</span>.<span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_id'>id</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../Relation.html" title="ActiveRecord::Relation (class)">Relation</a></span>) <span class='op'>&amp;&amp;</span> <span class='kw'>self</span> <span class='op'>==</span> <span class='id identifier rubyid_id'>id</span>.<span class='id identifier rubyid_klass'>klass</span>
    <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='id identifier rubyid_id'>id</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='id identifier rubyid_unscoped'>unscoped</span>.<span class='id identifier rubyid_where!'>where!</span>(<span class='id identifier rubyid_primary_key'>primary_key</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_id'>id</span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_update_all'>update_all</span> <span class='id identifier rubyid_updates'>updates</span>.<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>