<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Active Record Postgresql &mdash; Rails 5.2.8.1</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "active_record_postgresql",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 5.2.8.1</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Active Record Postgresql&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="http://guides.rubyonrails.org">http://guides.rubyonrails.org</a>.</strong></p>
<h1>Active Record and PostgreSQL</h1>
<p>This guide covers PostgreSQL specific usage of Active Record.</p>
<p>After reading this guide, you will know:</p>
<ul>
<li>How to use PostgreSQL's datatypes.</li>
<li>How to use UUID primary keys.</li>
<li>How to implement full text search with PostgreSQL.</li>
<li>How to back your Active Record models with database views.</li>
</ul>
<hr />
<p>In order to use the PostgreSQL adapter you need to have at least version 9.1
installed. Older versions are not supported.</p>
<p>To get started with PostgreSQL have a look at the
<a href="configuring.html#configuring-a-postgresql-database">configuring <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> guide</a>.
It describes how to properly setup Active Record for PostgreSQL.</p>
<h2>Datatypes</h2>
<p>PostgreSQL offers a number of specific datatypes. Following is a list of types,
that are supported by the PostgreSQL adapter.</p>
<h3>Bytea</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-binary.html" target="_parent" title="type definition">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-binarystring.html" target="_parent" title="functions and operators">functions and operators</a></li>
</ul>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20140207133952_create_documents.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_documents'>documents</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_binary'>binary</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>payload</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='comment'># app/models/document.rb
</span><span class='kw'>class</span> <span class='const'>Document</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_read'>read</span>(<span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_root'><a href="Rails.html#root-class_method" title="Rails.root (method)">root</a></span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tmp/output.pdf</span><span class='tstring_end'>&quot;</span></span>)
<span class='const'>Document</span>.<span class='id identifier rubyid_create'>create</span> <span class='label'>payload:</span> <span class='id identifier rubyid_data'>data</span></code></pre>
<h3>Array</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/arrays.html" target="_parent" title="type definition">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-array.html" target="_parent" title="functions and operators">functions and operators</a></li>
</ul>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20140207133952_create_books.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>title</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>tags</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>array:</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_integer'>integer</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ratings</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>array:</span> <span class='kw'>true</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tags'>tags</span><span class='comma'>,</span> <span class='label'>using:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gin</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_ratings'>ratings</span><span class='comma'>,</span> <span class='label'>using:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gin</span><span class='tstring_end'>&#39;</span></span>

<span class='comment'># app/models/book.rb
</span><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='const'>Book</span>.<span class='id identifier rubyid_create'>create</span> <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Brave New World</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
            <span class='label'>tags:</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fantasy</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fiction</span><span class='tstring_end'>&quot;</span></span>]<span class='comma'>,</span>
            <span class='label'>ratings:</span> [<span class='int'>4</span><span class='comma'>,</span> <span class='int'>5</span>]

<span class='comment'>## Books for a single tag
</span><span class='const'>Book</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;fantasy&#39; = ANY (tags)</span><span class='tstring_end'>&quot;</span></span>)

<span class='comment'>## Books for multiple tags
</span><span class='const'>Book</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tags @&gt; ARRAY[?]::varchar[]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fantasy</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fiction</span><span class='tstring_end'>&quot;</span></span>])

<span class='comment'>## Books with 3 or more ratings
</span><span class='const'>Book</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>array_length(ratings, 1) &gt;= 3</span><span class='tstring_end'>&quot;</span></span>)</code></pre>
<h3>Hstore</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/hstore.html" target="_parent" title="type definition">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/hstore.html#AEN179902" target="_parent" title="functions and operators">functions and operators</a></li>
</ul>
<p>NOTE: You need to enable the <code>hstore</code> extension to use hstore.</p>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131009135255_create_profiles.rb
</span><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Schema.html" title="ActiveRecord::Schema (class)">Schema</a></span>.<span class='id identifier rubyid_define'><a href="ActiveRecord/Schema.html#define-class_method" title="ActiveRecord::Schema.define (method)">define</a></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_enable_extension'>enable_extension</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hstore</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_extension_enabled?'>extension_enabled?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hstore</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_profiles'>profiles</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
    <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_hstore'>hstore</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>settings</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='comment'># app/models/profile.rb
</span><span class='kw'>class</span> <span class='const'>Profile</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='const'>Profile</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>settings:</span> { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>color</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>blue</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>resolution</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>800x600</span><span class='tstring_end'>&quot;</span></span> })

<span class='id identifier rubyid_profile'>profile</span> <span class='op'>=</span> <span class='const'>Profile</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_profile'>profile</span>.<span class='id identifier rubyid_settings'>settings</span> <span class='comment'># =&gt; {&quot;color&quot;=&gt;&quot;blue&quot;, &quot;resolution&quot;=&gt;&quot;800x600&quot;}
</span>
<span class='id identifier rubyid_profile'>profile</span>.<span class='id identifier rubyid_settings'>settings</span> <span class='op'>=</span> {<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>color</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>yellow</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>resolution</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1280x1024</span><span class='tstring_end'>&quot;</span></span>}
<span class='id identifier rubyid_profile'>profile</span>.<span class='id identifier rubyid_save!'>save!</span>

<span class='const'>Profile</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>settings-&gt;&#39;color&#39; = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>yellow</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; #&lt;ActiveRecord::Relation [#&lt;Profile id: 1, settings: {&quot;color&quot;=&gt;&quot;yellow&quot;, &quot;resolution&quot;=&gt;&quot;1280x1024&quot;}&gt;]&gt;</span></code></pre>
<h3>JSON and JSONB</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-json.html" target="_parent" title="type definition">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-json.html" target="_parent" title="functions and operators">functions and operators</a></li>
</ul>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_events.rb
</span><span class='comment'># ... for json datatype:
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_events'>events</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_json'>json</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>payload</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
<span class='comment'># ... or for jsonb datatype:
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_events'>events</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_jsonb'>jsonb</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>payload</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='comment'># app/models/event.rb
</span><span class='kw'>class</span> <span class='const'>Event</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='const'>Event</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>payload:</span> { <span class='label'>kind:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user_renamed</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>change:</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>jack</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>john</span><span class='tstring_end'>&quot;</span></span>]})

<span class='id identifier rubyid_event'>event</span> <span class='op'>=</span> <span class='const'>Event</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_payload'>payload</span> <span class='comment'># =&gt; {&quot;kind&quot;=&gt;&quot;user_renamed&quot;, &quot;change&quot;=&gt;[&quot;jack&quot;, &quot;john&quot;]}
</span>
<span class='comment'>## Query based on JSON document
</span><span class='comment'># The -&gt; operator returns the original JSON type (which might be an object), whereas -&gt;&gt; returns text
</span><span class='const'>Event</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>payload-&gt;&gt;&#39;kind&#39; = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user_renamed</span><span class='tstring_end'>&quot;</span></span>)</code></pre>
<h3>Range Types</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/rangetypes.html" target="_parent" title="type definition">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-range.html" target="_parent" title="functions and operators">functions and operators</a></li>
</ul>
<p>This type is mapped to Ruby <a href="http://www.ruby-doc.org/core-2.2.2/Range.html" target="_parent" title="Range">Range</a> objects.</p>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20130923065404_create_events.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_events'>events</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_daterange'>daterange</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>duration</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='comment'># app/models/event.rb
</span><span class='kw'>class</span> <span class='const'>Event</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='const'>Event</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>duration:</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>2014</span><span class='comma'>,</span> <span class='int'>2</span><span class='comma'>,</span> <span class='int'>11</span>)<span class='op'>..</span><span class='const'><a href="Date.html" title="Date (class)">Date</a></span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>2014</span><span class='comma'>,</span> <span class='int'>2</span><span class='comma'>,</span> <span class='int'>12</span>))

<span class='id identifier rubyid_event'>event</span> <span class='op'>=</span> <span class='const'>Event</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_duration'>duration</span> <span class='comment'># =&gt; Tue, 11 Feb 2014...Thu, 13 Feb 2014
</span>
<span class='comment'>## All Events on a given date
</span><span class='const'>Event</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>duration @&gt; ?::date</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>2014</span><span class='comma'>,</span> <span class='int'>2</span><span class='comma'>,</span> <span class='int'>12</span>))

<span class='comment'>## Working with range bounds
</span><span class='id identifier rubyid_event'>event</span> <span class='op'>=</span> <span class='const'>Event</span>.
  <span class='id identifier rubyid_select'>select</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lower(duration) AS starts_at</span><span class='tstring_end'>&quot;</span></span>).
  <span class='id identifier rubyid_select'>select</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>upper(duration) AS ends_at</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_first'>first</span>

<span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_starts_at'>starts_at</span> <span class='comment'># =&gt; Tue, 11 Feb 2014
</span><span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_ends_at'>ends_at</span> <span class='comment'># =&gt; Thu, 13 Feb 2014</span></code></pre>
<h3>Composite Types</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/rowtypes.html" target="_parent" title="type definition">type definition</a></li>
</ul>
<p>Currently there is no special support for composite types. They are mapped to
normal text columns:</p>
<pre class="code sql"><code class="sql">CREATE TYPE full_address AS
(
  city VARCHAR(90),
  street VARCHAR(90)
);
</code></pre>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20140207133952_create_contacts.rb
</span><span class='id identifier rubyid_execute'>execute</span> <span class='heredoc_beg'>&lt;&lt;-SQL</span>
<span class='tstring_content'> CREATE TYPE full_address AS
 (
   city VARCHAR(90),
   street VARCHAR(90)
 );
</span><span class='heredoc_end'>SQL
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_contacts'>contacts</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_column'>column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_full_address'>full_address</span>
<span class='kw'>end</span>

<span class='comment'># app/models/contact.rb
</span><span class='kw'>class</span> <span class='const'>Contact</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='const'>Contact</span>.<span class='id identifier rubyid_create'>create</span> <span class='label'>address:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(Paris,Champs-Élysées)</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_contact'>contact</span> <span class='op'>=</span> <span class='const'>Contact</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_contact'>contact</span>.<span class='id identifier rubyid_address'>address</span> <span class='comment'># =&gt; &quot;(Paris,Champs-Élysées)&quot;
</span><span class='id identifier rubyid_contact'>contact</span>.<span class='id identifier rubyid_address'>address</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(Paris,Rue Basse)</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_contact'>contact</span>.<span class='id identifier rubyid_save!'>save!</span></code></pre>
<h3>Enumerated Types</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-enum.html" target="_parent" title="type definition">type definition</a></li>
</ul>
<p>Currently there is no special support for enumerated types. They are mapped as
normal text columns:</p>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_articles.rb
</span><span class='kw'>def</span> <span class='id identifier rubyid_up'>up</span>
  <span class='id identifier rubyid_execute'>execute</span> <span class='heredoc_beg'>&lt;&lt;-SQL</span>
<span class='tstring_content'>    CREATE TYPE article_status AS ENUM (&#39;draft&#39;, &#39;published&#39;);
</span><span class='heredoc_end'>  SQL
</span>  <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_articles'>articles</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
    <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_column'>column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_status'>article_status</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='comment'># NOTE: It&#39;s important to drop table before dropping enum.
</span><span class='kw'>def</span> <span class='id identifier rubyid_down'>down</span>
  <span class='id identifier rubyid_drop_table'>drop_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_articles'>articles</span>

  <span class='id identifier rubyid_execute'>execute</span> <span class='heredoc_beg'>&lt;&lt;-SQL</span>
<span class='tstring_content'>    DROP TYPE article_status;
</span><span class='heredoc_end'>  SQL
</span><span class='kw'>end</span>

<span class='comment'># app/models/article.rb
</span><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='const'>Article</span>.<span class='id identifier rubyid_create'>create</span> <span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>draft</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_article'>article</span> <span class='op'>=</span> <span class='const'>Article</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_article'>article</span>.<span class='id identifier rubyid_status'>status</span> <span class='comment'># =&gt; &quot;draft&quot;
</span>
<span class='id identifier rubyid_article'>article</span>.<span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>published</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_article'>article</span>.<span class='id identifier rubyid_save!'>save!</span></code></pre>
<p>To add a new value before/after existing one you should use <a href="https://www.postgresql.org/docs/current/static/sql-altertype.html" target="_parent" title="ALTER TYPE">ALTER TYPE</a>:</p>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20150720144913_add_new_state_to_articles.rb
</span><span class='comment'># NOTE: ALTER TYPE ... ADD VALUE cannot be executed inside of a transaction block so here we are using disable_ddl_transaction!
</span><span class='id identifier rubyid_disable_ddl_transaction!'>disable_ddl_transaction!</span>

<span class='kw'>def</span> <span class='id identifier rubyid_up'>up</span>
  <span class='id identifier rubyid_execute'>execute</span> <span class='heredoc_beg'>&lt;&lt;-SQL</span>
<span class='tstring_content'>    ALTER TYPE article_status ADD VALUE IF NOT EXISTS &#39;archived&#39; AFTER &#39;published&#39;;
</span><span class='heredoc_end'>  SQL
</span><span class='kw'>end</span></code></pre>
<p>NOTE: ENUM values can't be dropped currently. You can read why <a href="https://www.postgresql.org/message-id/29F36C7C98AB09499B1A209D48EAA615B7653DBC8A@mail2a.alliedtesting.com" target="_parent" title="here">here</a>.</p>
<p>Hint: to show all the values of the all enums you have, you should call this query in <code>bin/rails db</code> or <code>psql</code> console:</p>
<pre class="code sql"><code class="sql">SELECT n.nspname AS enum_schema,
       t.typname AS enum_name,
       e.enumlabel AS enum_value
  FROM pg_type t
      JOIN pg_enum e ON t.oid = e.enumtypid
      JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace
</code></pre>
<h3>UUID</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-uuid.html" target="_parent" title="type definition">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/pgcrypto.html#AEN182570" target="_parent" title="pgcrypto generator function">pgcrypto generator function</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/uuid-ossp.html" target="_parent" title="uuid-ossp generator functions">uuid-ossp generator functions</a></li>
</ul>
<p>NOTE: You need to enable the <code>pgcrypto</code> (only PostgreSQL &gt;= 9.4) or <code>uuid-ossp</code>
extension to use uuid.</p>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_revisions.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_revisions'>revisions</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_uuid'>uuid</span> <span class='symbeg'>:</span><span class='id identifier rubyid_identifier'>identifier</span>
<span class='kw'>end</span>

<span class='comment'># app/models/revision.rb
</span><span class='kw'>class</span> <span class='const'>Revision</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='const'>Revision</span>.<span class='id identifier rubyid_create'>create</span> <span class='label'>identifier:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A0EEBC99-9C0B-4EF8-BB6D-6BB9BD380A11</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_revision'>revision</span> <span class='op'>=</span> <span class='const'>Revision</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_revision'>revision</span>.<span class='id identifier rubyid_identifier'>identifier</span> <span class='comment'># =&gt; &quot;a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11&quot;</span></code></pre>
<p>You can use <code>uuid</code> type to define references in migrations:</p>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20150418012400_create_blog.rb
</span><span class='id identifier rubyid_enable_extension'>enable_extension</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pgcrypto</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_extension_enabled?'>extension_enabled?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pgcrypto</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>id:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uuid'>uuid</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gen_random_uuid()</span><span class='tstring_end'>&#39;</span></span>

<span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='label'>id:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uuid'>uuid</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gen_random_uuid()</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='comment'># t.belongs_to :post, type: :uuid
</span>  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_references'>references</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uuid'>uuid</span>
<span class='kw'>end</span>

<span class='comment'># app/models/post.rb
</span><span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>
<span class='kw'>end</span>

<span class='comment'># app/models/comment.rb
</span><span class='kw'>class</span> <span class='const'>Comment</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span>
<span class='kw'>end</span></code></pre>
<p>See <a href="#uuid-primary-keys">this section</a> for more details on using UUIDs as primary key.</p>
<h3>Bit String Types</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-bit.html" target="_parent" title="type definition">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-bitstring.html" target="_parent" title="functions and operators">functions and operators</a></li>
</ul>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_users.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>true</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_column'>column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_settings'>settings</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bit(8)</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='comment'># app/models/device.rb
</span><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='const'>User</span>.<span class='id identifier rubyid_create'>create</span> <span class='label'>settings:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>01010011</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_settings'>settings</span> <span class='comment'># =&gt; &quot;01010011&quot;
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_settings'>settings</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0xAF</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_settings'>settings</span> <span class='comment'># =&gt; 10101111
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_save!'>save!</span></code></pre>
<h3>Network Address Types</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-net-types.html" target="_parent" title="type definition">type definition</a></li>
</ul>
<p>The types <code>inet</code> and <code>cidr</code> are mapped to Ruby
<a href="http://www.ruby-doc.org/stdlib-2.2.2/libdoc/ipaddr/rdoc/IPAddr.html" target="_parent" title="IPAddr">IPAddr</a>
objects. The <code>macaddr</code> type is mapped to normal text.</p>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20140508144913_create_devices.rb
</span><span class='id identifier rubyid_create_table'>create_table</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_devices'>devices</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>true</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_inet'>inet</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ip</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_cidr'>cidr</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>network</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_macaddr'>macaddr</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>address</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='comment'># app/models/device.rb
</span><span class='kw'>class</span> <span class='const'>Device</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='id identifier rubyid_macbook'>macbook</span> <span class='op'>=</span> <span class='const'>Device</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>ip:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>192.168.1.12</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                        <span class='label'>network:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>192.168.2.0/24</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                        <span class='label'>address:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>32:01:16:6d:05:ef</span><span class='tstring_end'>&quot;</span></span>)

<span class='id identifier rubyid_macbook'>macbook</span>.<span class='id identifier rubyid_ip'>ip</span>
<span class='comment'># =&gt; #&lt;IPAddr: IPv4:192.168.1.12/255.255.255.255&gt;
</span>
<span class='id identifier rubyid_macbook'>macbook</span>.<span class='id identifier rubyid_network'>network</span>
<span class='comment'># =&gt; #&lt;IPAddr: IPv4:192.168.2.0/255.255.255.0&gt;
</span>
<span class='id identifier rubyid_macbook'>macbook</span>.<span class='id identifier rubyid_address'>address</span>
<span class='comment'># =&gt; &quot;32:01:16:6d:05:ef&quot;</span></code></pre>
<h3>Geometric Types</h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-geometric.html" target="_parent" title="type definition">type definition</a></li>
</ul>
<p>All geometric types, with the exception of <code>points</code> are mapped to normal text.
A point is casted to an array containing <code>x</code> and <code>y</code> coordinates.</p>
<h2>UUID Primary Keys</h2>
<p>NOTE: You need to enable the <code>pgcrypto</code> (only PostgreSQL &gt;= 9.4) or <code>uuid-ossp</code>
extension to generate random UUIDs.</p>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_devices.rb
</span><span class='id identifier rubyid_enable_extension'>enable_extension</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pgcrypto</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_extension_enabled?'>extension_enabled?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pgcrypto</span><span class='tstring_end'>&#39;</span></span>)
<span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_devices'>devices</span><span class='comma'>,</span> <span class='label'>id:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uuid'>uuid</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gen_random_uuid()</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_kind'>kind</span>
<span class='kw'>end</span>

<span class='comment'># app/models/device.rb
</span><span class='kw'>class</span> <span class='const'>Device</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='id identifier rubyid_device'>device</span> <span class='op'>=</span> <span class='const'>Device</span>.<span class='id identifier rubyid_create'>create</span>
<span class='id identifier rubyid_device'>device</span>.<span class='id identifier rubyid_id'>id</span> <span class='comment'># =&gt; &quot;814865cd-5a1d-4771-9306-4268f188fe9e&quot;</span></code></pre>
<p>NOTE: <code>gen_random_uuid()</code> (from <code>pgcrypto</code>) is assumed if no <code>:default</code> option was
passed to <code>create_table</code>.</p>
<h2>Full Text Search</h2>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_documents.rb
</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_documents'>documents</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>title</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>body</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_documents'>documents</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>to_tsvector(&#39;english&#39;, title || &#39; &#39; || body)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>using:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gin'>gin</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>documents_idx</span><span class='tstring_end'>&#39;</span></span>

<span class='comment'># app/models/document.rb
</span><span class='kw'>class</span> <span class='const'>Document</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='const'>Document</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cats and Dogs</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>body:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>are nice!</span><span class='tstring_end'>&quot;</span></span>)

<span class='comment'>## all documents matching &#39;cat &amp; dog&#39;
</span><span class='const'>Document</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>to_tsvector(&#39;english&#39;, title || &#39; &#39; || body) @@ to_tsquery(?)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                 <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cat &amp; dog</span><span class='tstring_end'>&quot;</span></span>)</code></pre>
<h2>Database Views</h2>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/sql-createview.html" target="_parent" title="view creation">view creation</a></li>
</ul>
<p>Imagine you need to work with a legacy database containing the following table:</p>
<pre class="code ruby"><code class="ruby">rails_pg_guide=# \d &quot;TBL_ART&quot;
                                        Table &quot;public.TBL_ART&quot;
   Column   |            Type             |                         Modifiers
-----------------------------------------------------------------------------------------------------
 INT_ID     | integer                     | not null default nextval(&#39;&quot;TBL_ART_INT_ID_seq&quot;&#39;::regclass)
 STR_TITLE  | character varying           |
 STR_STAT   | character varying           | default &#39;draft&#39;::character varying
 DT_PUBL_AT | timestamp without time zone |
 BL_ARCH    | boolean                     | default false
Indexes:
    &quot;TBL_ART_pkey&quot; PRIMARY KEY, btree (&quot;INT_ID&quot;)</code></pre>
<p>This table does not follow the Rails conventions at all.
Because simple PostgreSQL views are updateable by default,
we can wrap it as follows:</p>
<pre class="code ruby"><code class="ruby"><span class='comment'># db/migrate/20131220144913_create_articles_view.rb
</span><span class='id identifier rubyid_execute'>execute</span> <span class='heredoc_beg'>&lt;&lt;-SQL</span>
<span class='tstring_content'>CREATE VIEW articles AS
  SELECT &quot;INT_ID&quot; AS id,
         &quot;STR_TITLE&quot; AS title,
         &quot;STR_STAT&quot; AS status,
         &quot;DT_PUBL_AT&quot; AS published_at,
         &quot;BL_ARCH&quot; AS archived
  FROM &quot;TBL_ART&quot;
  WHERE &quot;BL_ARCH&quot; = &#39;f&#39;
</span><span class='heredoc_end'>  SQL
</span>
<span class='comment'># app/models/article.rb
</span><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_primary_key'>primary_key</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_archive!'>archive!</span>
    <span class='id identifier rubyid_update_attribute'>update_attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_archived'>archived</span><span class='comma'>,</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='comment'># Usage
</span><span class='id identifier rubyid_first'>first</span> <span class='op'>=</span> <span class='const'>Article</span>.<span class='id identifier rubyid_create!'>create!</span> <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Winter is coming</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                        <span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>published</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                        <span class='label'>published_at:</span> <span class='int'>1</span>.<span class='id identifier rubyid_year'>year</span>.<span class='id identifier rubyid_ago'>ago</span>
<span class='id identifier rubyid_second'>second</span> <span class='op'>=</span> <span class='const'>Article</span>.<span class='id identifier rubyid_create!'>create!</span> <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Brace yourself</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                         <span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>draft</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                         <span class='label'>published_at:</span> <span class='int'>1</span>.<span class='id identifier rubyid_month'>month</span>.<span class='id identifier rubyid_ago'>ago</span>

<span class='const'>Article</span>.<span class='id identifier rubyid_count'>count</span> <span class='comment'># =&gt; 2
</span><span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_archive!'>archive!</span>
<span class='const'>Article</span>.<span class='id identifier rubyid_count'>count</span> <span class='comment'># =&gt; 1</span></code></pre>
<p>NOTE: This application only cares about non-archived <code>Articles</code>. A view also
allows for conditions so we can exclude the archived <code>Articles</code> directly.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>