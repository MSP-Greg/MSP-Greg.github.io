<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Active Storage CHANGELOG &mdash; Rails 7.1.3.2</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "active_storage_CHANGELOG",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 7.1.3.2</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Active Storage CHANGELOG&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h2>Rails 7.1.3.2 (February 21, 2024)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 7.1.3.1 (February 21, 2024)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 7.1.3 (January 16, 2024)</h2>

<ul>
<li><p>Fix N+1 query when fetching preview images for non-image assets.</p>

<p><em>Aaron Patterson &amp; Justin Searls</em></p></li>
<li><p>Fix all Active Storage database related models to respect
<a href="ActiveRecord/Base.html#table_name_prefix-class_method" title="ActiveRecord::Base.table_name_prefix (method)">ActiveRecord::Base.table_name_prefix</a> configuration.</p>

<p><em>Chedli Bourguiba</em></p></li>
<li><p>Fix <code>ActiveStorage::Representations::ProxyController</code> not returning the proper
preview image variant for previewable files.</p>

<p><em>Chedli Bourguiba</em></p></li>
<li><p>Fix <code>ActiveStorage::Representations::ProxyController</code> to proxy untracked
variants.</p>

<p><em>Chedli Bourguiba</em></p></li>
<li><p>Fix direct upload forms when submit button contains nested elements.</p>

<p><em>Marc Köhlbrugge</em></p></li>
<li><p>When using the <code>preprocessed: true</code> option, avoid enqueuing transform jobs
for blobs that are not representable.</p>

<p><em>Chedli Bourguiba</em></p></li>
<li><p>Process preview image variant when calling <code>ActiveStorage::Preview#processed</code>.
For example, <code>attached_pdf.preview(:thumb).processed</code> will now immediately
generate the full-sized preview image and the <code>:thumb</code> variant of it.
Previously, the <code>:thumb</code> variant would not be generated until a further call
to e.g. <code>processed.url</code>.</p>

<p><em>Chedli Bourguiba</em> and <em>Jonathan Hefner</em></p></li>
<li><p>Prevent <a href="ActiveRecord/StrictLoadingViolationError.html" title="ActiveRecord::StrictLoadingViolationError (class)"><code>::ActiveRecord::StrictLoadingViolationError</code></a> when strict loading is
enabled and the variant of an Active Storage preview has already been
processed (for example, by calling <code>ActiveStorage::Preview#url</code>).</p>

<p><em>Jonathan Hefner</em></p></li>
<li><p>Fix <code>preprocessed: true</code> option for named variants of previewable files.</p>

<p><em>Nico Wenterodt</em></p></li>
</ul>

<h2>Rails 7.1.2 (November 10, 2023)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 7.1.1 (October 11, 2023)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 7.1.0 (October 05, 2023)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 7.1.0.rc2 (October 01, 2023)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 7.1.0.rc1 (September 27, 2023)</h2>

<ul>
<li><p>Add <code>expires_at</code> option to <code>ActiveStorage::Blob#signed_id</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rails_blob_path'>rails_blob_path</span>(<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_avatar'>avatar</span><span class='comma'>,</span> <span class='label'>disposition:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attachment</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>expires_at:</span> <span class='int'>30</span>.<span class='id identifier rubyid_minutes'>minutes</span>.<span class='id identifier rubyid_from_now'>from_now</span>)
<span class='op'>&lt;</span><span class='tstring'><span class='tstring_beg'>%=</span><span class='tstring_content'> image_tag rails_blob_path(user.avatar.variant(resize: &quot;100x100&quot;), expires_at: 30.minutes.from_now) %&gt;</span></code></pre>

<p><em>Aki</em></p></li>
<li><p>Allow attaching <a href="File.html" title="File (class)"><code>File</code></a> and <a href="Pathname.html" title="Pathname (class)"><code>Pathname</code></a> when assigning attributes, e.g.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>avatar:</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_open'>open</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>image.jpg</span><span class='tstring_end'>&quot;</span></span>))
<span class='const'>User</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>avatar:</span> <span class='id identifier rubyid_file_fixture'>file_fixture</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>image.jpg</span><span class='tstring_end'>&quot;</span></span>))</code></pre>

<p><em>Dorian Marié</em></p></li>
</ul>

<h2>Rails 7.1.0.beta1 (September 13, 2023)</h2>

<ul>
<li><p>Disables the session in <code>ActiveStorage::Blobs::ProxyController</code>
and <code>ActiveStorage::Representations::ProxyController</code>
in order to allow caching by default in some CDNs as CloudFlare</p>

<p>Fixes #44136</p>

<p><em>Bruno Prieto</em></p></li>
<li><p>Add <code>tags</code> to <a href="ActiveStorage/Analyzer/AudioAnalyzer.html" title="ActiveStorage::Analyzer::AudioAnalyzer (class)"><code>::ActiveStorage::Analyzer::AudioAnalyzer</code></a> output</p>

<p><em>Keaton Roux</em></p></li>
<li><p>Add an option to preprocess variants</p>

<p>ActiveStorage variants are processed on the fly when they are needed but
sometimes we&#39;re sure that they are accessed and want to processed them
upfront.</p>

<p><code>preprocessed</code> option is added when declaring variants.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one_attached'>has_one_attached</span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_attachable'>attachable</span><span class='op'>|</span>
    <span class='id identifier rubyid_attachable'>attachable</span>.<span class='id identifier rubyid_variant'>variant</span> <span class='symbeg'>:</span><span class='id identifier rubyid_thumb'>thumb</span><span class='comma'>,</span> <span class='label'>resize_to_limit:</span> [<span class='int'>100</span><span class='comma'>,</span> <span class='int'>100</span>]<span class='comma'>,</span> <span class='label'>preprocessed:</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p><em>Shouichi Kamiya</em></p></li>
<li><p>Fix variants not included when eager loading multiple records containing a single attachment</p>

<p>When using the <code>with_attached_#{name}</code> scope for a <code>has_one_attached</code> relation,
attachment variants were not eagerly loaded.</p>

<p><em>Russell Porter</em></p></li>
<li><p>Allow an <a href="ActiveStorage.html" title="ActiveStorage (module)"><code>ActiveStorage</code></a> attachment to be removed via a form post</p>

<p>Attachments can already be removed by updating the attachment to be nil such as:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>]).<span class='id identifier rubyid_update!'>update!</span>(<span class='label'>avatar:</span> <span class='kw'>nil</span>)</code></pre>

<p>However, a form cannot post a nil param, it can only post an empty string. But, posting an
empty string would result in an <code>ActiveSupport::MessageVerifier::InvalidSignature: mismatched digest</code>
error being raised, because it&#39;s being treated as a signed blob id.</p>

<p>Now, nil and an empty string are treated as a delete, which allows attachments to be removed via:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>]).<span class='id identifier rubyid_update!'>update!</span>(<span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_require'>require</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>).<span class='id identifier rubyid_permit'>permit</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span>))</code></pre>

<p><em>Nate Matykiewicz</em></p></li>
<li><p>Remove mini_mime usage in favour of marcel.</p>

<p>We have two libraries that are have similar usage. This change removes
dependency on mini_mime and makes use of similar methods from marcel.</p>

<p><em>Vipul A M</em></p></li>
<li><p>Allow destroying active storage variants</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_avatar'>avatar</span>.<span class='id identifier rubyid_variant'>variant</span>(<span class='label'>resize_to_limit:</span> [<span class='int'>100</span><span class='comma'>,</span> <span class='int'>100</span>]).<span class='id identifier rubyid_destroy'>destroy</span></code></pre>

<p><em>Shouichi Kamiya</em>, <em>Yuichiro NAKAGAWA</em>, <em>Ryohei UEDA</em></p></li>
<li><p>Add <code>sample_rate</code> to <a href="ActiveStorage/Analyzer/AudioAnalyzer.html" title="ActiveStorage::Analyzer::AudioAnalyzer (class)"><code>::ActiveStorage::Analyzer::AudioAnalyzer</code></a> output</p>

<p><em>Matija Čupić</em></p></li>
<li><p>Remove deprecated <code>purge</code> and <code>purge_later</code> methods from the attachments association.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated behavior when assigning to a collection of attachments.</p>

<p>Instead of appending to the collection, the collection is now replaced.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <code>ActiveStorage::Current#host</code> and <code>ActiveStorage::Current#host=</code> methods.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated invalid default content types in Active Storage configurations.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Add missing preview event to <a href="ActiveStorage/LogSubscriber.html" title="ActiveStorage::LogSubscriber (class)"><code>::ActiveStorage::LogSubscriber</code></a></p>

<p>A <code>preview</code> event is being instrumented in <a href="ActiveStorage/Previewer.html" title="ActiveStorage::Previewer (class)"><code>::ActiveStorage::Previewer</code></a>.
However it was not added inside ActiveStorage&#39;s LogSubscriber class.</p>

<p>This will allow to have logs for when a preview happens
in the same fashion as all other ActiveStorage events such as
<code>upload</code> and <code>download</code> inside <a href="Rails.html#logger-class_method" title="Rails.logger (method)">Rails.logger</a>.</p>

<p><em>Chedli Bourguiba</em></p></li>
<li><p>Fix retrieving rotation value from FFmpeg on version 5.0+.</p>

<p>In FFmpeg version 5.0+ the rotation value has been removed from tags.
Instead the value can be found in side_data_list. Along with
this update it&#39;s possible to have values of -90, -270 to denote the video
has been rotated.</p>

<p><em>Haroon Ahmed</em></p></li>
<li><p>Touch all corresponding model records after ActiveStorage::Blob is analyzed</p>

<p>This fixes a race condition where a record can be requested and have a cache entry built, before
the initial <code>analyze_later</code> completes, which will not be invalidated until something else
updates the record. This also invalidates cache entries when a blob is re-analyzed, which
is helpful if a bug is fixed in an analyzer or a new analyzer is added.</p>

<p><em>Nate Matykiewicz</em></p></li>
<li><p>Add ability to use pre-defined variants when calling <code>preview</code> or
<code>representation</code> on an attachment.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_one_attached'>has_one_attached</span> <span class='symbeg'>:</span><span class='id identifier rubyid_file'>file</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_attachable'>attachable</span><span class='op'>|</span>
    <span class='id identifier rubyid_attachable'>attachable</span>.<span class='id identifier rubyid_variant'>variant</span> <span class='symbeg'>:</span><span class='id identifier rubyid_thumb'>thumb</span><span class='comma'>,</span> <span class='label'>resize_to_limit:</span> [<span class='int'>100</span><span class='comma'>,</span> <span class='int'>100</span>]
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='op'>&lt;</span><span class='tstring'><span class='tstring_beg'>%=</span><span class='tstring_content'> image_tag user.file.representation(:thumb) %&gt;</span></code></pre>

<p><em>Richard Böhme</em></p></li>
<li><p><a href="Method.html" title="Method (class)"><code>Method</code></a> <code>attach</code> always returns the attachments except when the record
is persisted, unchanged, and saving it fails, in which case it returns <code>nil</code>.</p>

<p><em>Santiago Bartesaghi</em></p></li>
<li><p>Fixes multiple <code>attach</code> calls within transaction not uploading files correctly.</p>

<p>In the following example, the code failed to upload all but the last file to the configured service.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_transaction'><a href="ActiveRecord/Transactions.html#transaction-instance_method" title="ActiveRecord::Transactions#transaction (method)">transaction</a></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_attachments'>attachments</span>.<span class='id identifier rubyid_attach'>attach</span>({
    <span class='label'>content_type:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/plain</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>filename:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dummy.txt</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>io:</span> <span class='op'>::</span><span class='const'>StringIO</span>.<span class='id identifier rubyid_new'>new</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dummy</span><span class='tstring_end'>&quot;</span></span>)<span class='comma'>,</span>
  })
  <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_attachments'>attachments</span>.<span class='id identifier rubyid_attach'>attach</span>({
    <span class='label'>content_type:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/plain</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>filename:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dummy2.txt</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>io:</span> <span class='op'>::</span><span class='const'>StringIO</span>.<span class='id identifier rubyid_new'>new</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dummy2</span><span class='tstring_end'>&quot;</span></span>)<span class='comma'>,</span>
  })
<span class='kw'>end</span>

<span class='id identifier rubyid_assert_equal'>assert_equal</span> <span class='int'>2</span><span class='comma'>,</span> <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_attachments'>attachments</span>.<span class='id identifier rubyid_count'>count</span>
<span class='id identifier rubyid_assert'>assert</span> <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_attachments'>attachments</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_service'>service</span>.<span class='id identifier rubyid_exist?'>exist?</span>(<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_attachments'>attachments</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_key'>key</span>)  <span class='comment'># Fails</span></code></pre>

<p>This was addressed by keeping track of the subchanges pending upload, and uploading them
once the transaction is committed.</p>

<p>Fixes #41661</p>

<p><em>Santiago Bartesaghi</em>, <em>Bruno Vezoli</em>, <em>Juan Roig</em>, <em>Abhay Nikam</em></p></li>
<li><p>Raise an exception if <code>config.active_storage.service</code> is not set.</p>

<p>If Active Storage is configured and <code>config.active_storage.service</code> is not
set in the respective environment&#39;s configuration file, then an exception
is raised with a meaningful message when attempting to use Active Storage.</p>

<p><em>Ghouse Mohamed</em></p></li>
<li><p>Fixes proxy downloads of files over 5mb</p>

<p>Previously, trying to view and/or download files larger than 5mb stored in
services like S3 via proxy mode could return corrupted files at around
5.2mb or cause random halts in the download. Now,
<code>ActiveStorage::Blobs::ProxyController</code> correctly handles streaming these
larger files from the service to the client without any issues.</p>

<p>Fixes #44679</p>

<p><em>Felipe Raul</em></p></li>
<li><p>Saving attachment(s) to a record returns the blob/blobs object</p>

<p>Previously, saving attachments did not return the blob/blobs that
were attached. Now, saving attachments to a record with <code>#attach</code>
method returns the blob or array of blobs that were attached to
the record. If it fails to save the attachment(s), then it returns
<code>false</code>.</p>

<p><em>Ghouse Mohamed</em></p></li>
<li><p>Don&#39;t stream responses in redirect mode</p>

<p>Previously, both redirect mode and proxy mode streamed their
responses which caused a new thread to be created, and could end
up leaking connections in the connection pool. But since redirect
mode doesn&#39;t actually send any data, it doesn&#39;t need to be
streamed.</p>

<p><em>Luke Lau</em></p></li>
<li><p>Safe for direct upload on Libraries or Frameworks</p>

<p>Enable the use of custom headers during direct uploads, which allows for
the inclusion of Authorization bearer tokens or other forms of authorization
tokens through headers.</p>

<p><em>Radamés Roriz</em></p></li>
</ul>

<p>Please check [7-0-stable]) for previous changes.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>