<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Active Record CHANGELOG &mdash; Rails 7.1.3.2</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "active_record_CHANGELOG",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 7.1.3.2</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Active Record CHANGELOG&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<ul>
<li><p>Fix <code>has_one</code> association autosave setting the foreign key attribute when it is unchanged.</p>

<p>This behaviour is also inconsistent with autosaving <code>belongs_to</code> and can have unintended side effects like raising
an <code>ActiveRecord::ReadOnlyAttributeError</code> when the foreign key attribute is marked as read-only.</p>

<p><em>Joshua Young</em></p></li>
<li><p>Fix an issue where <a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)"><code>::ActiveRecord::Encryption</code></a> configurations are not ready before the loading
of Active Record models, when an application is eager loaded. As a result, encrypted attributes
could be misconfigured in some cases.</p>

<p><em>Maxime Réty</em></p></li>
<li><p>Properly synchronize <code>Mysql2Adapter#active?</code> and <code>TrilogyAdapter#active?</code></p>

<p>As well as <code>disconnect!</code> and <code>verify!</code>.</p>

<p>This generally isn&#39;t a big problem as connections must not be shared between
threads, but is required when running transactional tests or system tests
and could lead to a SEGV.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Fix counter caches when the foreign key is composite.</p>

<p>If the model holding the counter cache had a composite primary key,
inserting a dependent record would fail with an <code>ArgumentError</code>
<code>Expected corresponding value for...</code></p>

<p><em>fatkodima</em></p></li>
<li><p>Fix loading of schema cache for multiple databases.</p>

<p>Before this change, if you have multiple databases configured in your
application, and had schema cache present, Rails would load the same
cache to all databases.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Fix eager loading of composite primary key associations.</p>

<p><code>relation.eager_load(:other_model)</code> could load the wrong records if <code>other_model</code>
had a composite primary key.</p>

<p><em>Nikita Vasilevsky</em></p></li>
<li><p>Fix async queries returning a doubly wrapped result when hitting the query cache.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix single quote escapes on default generated MySQL columns</p>

<p>MySQL 5.7.5+ supports generated columns, which can be used to create a column that is computed from an expression.</p>

<p>Previously, the schema dump would output a string with double escapes for generated columns with single quotes in the default expression.</p>

<p>This would result in issues when importing the schema on a fresh instance of a MySQL database.</p>

<p>Now, the string will not be escaped and will be valid Ruby upon importing of the schema.</p>

<p><em>Yash Kapadia</em></p></li>
<li><p>Fix Migrations with versions older than 7.1 validating options given to
<code>t.references</code>.</p>

<p><em>Hartley McGuire</em></p></li>
</ul>

<h2>Rails 7.1.3.2 (February 21, 2024)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 7.1.3.1 (February 21, 2024)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 7.1.3 (January 16, 2024)</h2>

<ul>
<li><p>Fix Migrations with versions older than 7.1 validating options given to
<code>add_reference</code>.</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Ensure <code>reload</code> sets correct owner for each association.</p>

<p><em>Dmytro Savochkin</em></p></li>
<li><p>Fix view runtime for controllers with async queries.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix <code>load_async</code> to work with query cache.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix polymorphic <code>belongs_to</code> to correctly use parent&#39;s <code>query_constraints</code>.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix <code>Preloader</code> to not generate a query for already loaded association with <code>query_constraints</code>.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix multi-database polymorphic preloading with equivalent table names.</p>

<p>When preloading polymorphic associations, if two models pointed to two
tables with the same name but located in different databases, the
preloader would only load one.</p>

<p><em>Ari Summer</em></p></li>
<li><p>Fix <code>encrypted_attribute?</code> to take into account context properties passed to <code>encrypts</code>.</p>

<p><em>Maxime Réty</em></p></li>
<li><p>Fix <code>find_by</code> to work correctly in presence of composite primary keys.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix async queries sometimes returning a raw result if they hit the query cache.</p>

<p><code>ShipPart.async_count</code> could return a raw integer rather than a Promise
if it found the result in the query cache.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix <code>Relation#transaction</code> to not apply a default scope.</p>

<p>The method was incorrectly setting a default scope around its block:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>published:</span> <span class='kw'>true</span>).<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
  <span class='const'>Post</span>.<span class='id identifier rubyid_count'>count</span> <span class='comment'># SELECT COUNT(*) FROM posts WHERE published = FALSE;
</span><span class='kw'>end</span></code></pre>

<p><em>Jean Boussier</em></p></li>
<li><p>Fix calling <code>async_pluck</code> on a <code>none</code> relation.</p>

<p><code>Model.none.async_pluck(:id)</code> was returning a naked value
instead of a promise.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Fix calling <code>load_async</code> on a <code>none</code> relation.</p>

<p><code>Model.none.load_async</code> was returning a broken result.</p>

<p><em>Lucas Mazza</em></p></li>
<li><p>TrilogyAdapter: ignore <code>host</code> if <code>socket</code> parameter is set.</p>

<p>This allows to configure a connection on a UNIX socket via DATABASE_URL:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>DATABASE_URL</span><span class='op'>=</span><span class='id identifier rubyid_trilogy'>trilogy</span><span class='symbeg'>:</span><span class='op'>/</span><span class='op'>/</span><span class='id identifier rubyid_does'>does</span><span class='op'>-</span><span class='kw'>not</span><span class='op'>-</span><span class='id identifier rubyid_matter'>matter</span><span class='op'>/</span><span class='id identifier rubyid_my_db_production?'>my_db_production?</span><span class='id identifier rubyid_socket'>socket</span><span class='op'>=</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>var</span><span class='regexp_end'>/run</span></span><span class='op'>/</span><span class='id identifier rubyid_mysql'>mysql</span>.<span class='id identifier rubyid_sock'>sock</span></code></pre>

<p><em>Jean Boussier</em></p></li>
<li><p>Fix <code>has_secure_token</code> calls the setter method on initialize.</p>

<p><em>Abeid Ahmed</em></p></li>
<li><p>Allow using <code>object_id</code> as a database column name.
It was available before rails 7.1 and may be used as a part of polymorphic relationship to <code>object</code> where <code>object</code> can be any other database record.</p>

<p><em>Mikhail Doronin</em></p></li>
<li><p>Fix <code>rails db:create:all</code> to not touch databases before they are created.</p>

<p><em>fatkodima</em></p></li>
</ul>

<h2>Rails 7.1.2 (November 10, 2023)</h2>

<ul>
<li><p>Fix renaming primary key index when renaming a table with a UUID primary key
in PostgreSQL.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix <code>where(field: values)</code> queries when <code>field</code> is a serialized attribute
(for example, when <code>field</code> uses <code>ActiveRecord::Base.serialize</code> or is a JSON
column).</p>

<p><em>João Alves</em></p></li>
<li><p>Prevent marking broken connections as verified.</p>

<p><em>Daniel Colson</em></p></li>
<li><p>Don&#39;t mark Float::INFINITY as changed when reassigning it</p>

<p>When saving a record with a float infinite value, it shouldn&#39;t mark as changed</p>

<p><em>Maicol Bentancor</em></p></li>
<li><p><code>ActiveRecord::Base.table_name</code> now returns <code>nil</code> instead of raising
&quot;undefined method <code>abstract_class?</code> for Object:Class&quot;.</p>

<p><em>a5-stable</em></p></li>
<li><p>Fix upserting for custom <code>:on_duplicate</code> and <code>:unique_by</code> consisting of all
inserts keys.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fixed an <a href="https://github.com/rails/rails/issues/49809">issue</a> where saving a
record could innappropriately <code>dup</code> its attributes.</p>

<p><em>Jonathan Hefner</em></p></li>
<li><p>Dump schema only for a specific db for rollback/up/down tasks for multiple dbs.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix <code>NoMethodError</code> when casting a PostgreSQL <code>money</code> value that uses a
comma as its radix point and has no leading currency symbol.  For example,
when casting <code>&quot;3,50&quot;</code>.</p>

<p><em>Andreas Reischuck</em> and <em>Jonathan Hefner</em></p></li>
<li><p>Re-enable support for using <code>enum</code> with non-column-backed attributes.
Non-column-backed attributes must be previously declared with an explicit
type. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_attribute'>attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_topic'>topic</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_string'>string</span>
  <span class='id identifier rubyid_enum'>enum</span> <span class='label'>topic:</span> <span class='qsymbols'><span class='qsymbols_beg'>%i[</span><span class='tstring_content'>science</span><span class='words_sep'> </span><span class='tstring_content'>tech</span><span class='words_sep'> </span><span class='tstring_content'>engineering</span><span class='words_sep'> </span><span class='tstring_content'>math</span><span class='tstring_end'>]</span></span>
<span class='kw'>end</span></code></pre>

<p><em>Jonathan Hefner</em></p></li>
<li><p>Raise on <code>foreign_key:</code> being passed as an array in associations</p>

<p><em>Nikita Vasilevsky</em></p></li>
<li><p>Return back maximum allowed PostgreSQL table name to 63 characters.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix detecting <code>IDENTITY</code> columns for PostgreSQL &lt; 10.</p>

<p><em>fatkodima</em></p></li>
</ul>

<h2>Rails 7.1.1 (October 11, 2023)</h2>

<ul>
<li><p>Fix auto populating IDENTITY columns for PostgreSQL.</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix &quot;ArgumentError: wrong number of arguments (given 3, expected 2)&quot; when
down migrating <code>rename_table</code> in older migrations.</p>

<p><em>fatkodima</em></p></li>
<li><p>Do not require the Action Text, Active Storage and Action Mailbox tables
to be present when running when running test on CI.</p>

<p><em>Rafael Mendonça França</em></p></li>
</ul>

<h2>Rails 7.1.0 (October 05, 2023)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 7.1.0.rc2 (October 01, 2023)</h2>

<ul>
<li><p>Remove -shm and -wal SQLite files when <code>rails db:drop</code> is run.</p>

<p><em>Niklas Häusele</em></p></li>
<li><p>Revert the change to raise an <code>ArgumentError</code> when <code>#accepts_nested_attributes_for</code> is declared more than once for
an association in the same class.</p>

<p>The reverted behavior broke the case where the <code>#accepts_nested_attributes_for</code> was defined in a concern and
where overridden in the class that included the concern.</p>

<p><em>Rafael Mendonça França</em></p></li>
</ul>

<h2>Rails 7.1.0.rc1 (September 27, 2023)</h2>

<ul>
<li><p>Better naming for unique constraints support.</p>

<p>Naming unique keys leads to misunderstanding it&#39;s a short-hand of unique indexes.
Just naming it unique constraints is not misleading.</p>

<p>In Rails 7.1.0.beta1 or before:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_unique_key'>add_unique_key</span> <span class='symbeg'>:</span><span class='id identifier rubyid_sections'>sections</span><span class='comma'>,</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_position'>position</span>]<span class='comma'>,</span> <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_deferred'>deferred</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unique_section_position</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_remove_unique_key'>remove_unique_key</span> <span class='symbeg'>:</span><span class='id identifier rubyid_sections'>sections</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unique_section_position</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>Now:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_unique_constraint'>add_unique_constraint</span> <span class='symbeg'>:</span><span class='id identifier rubyid_sections'>sections</span><span class='comma'>,</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_position'>position</span>]<span class='comma'>,</span> <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_deferred'>deferred</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unique_section_position</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_remove_unique_constraint'>remove_unique_constraint</span> <span class='symbeg'>:</span><span class='id identifier rubyid_sections'>sections</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unique_section_position</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Fix duplicate quoting for check constraint expressions in schema dump when using MySQL</p>

<p>A check constraint with an expression, that already contains quotes, lead to an invalid schema
dump with the mysql2 adapter.</p>

<p>Fixes #42424.</p>

<p><em>Felix Tscheulin</em></p></li>
<li><p>Performance tune the SQLite3 adapter connection configuration</p>

<p>For Rails applications, the Write-Ahead-Log in normal syncing mode with a capped journal size, a healthy shared memory buffer and a shared cache will perform, on average, 2× better.</p>

<p><em>Stephen Margheim</em></p></li>
<li><p>Allow SQLite3 <code>busy_handler</code> to be configured with simple max number of <code>retries</code></p>

<p>Retrying busy connections without delay is a preferred practice for performance-sensitive applications. Add support for a <code>database.yml</code> <code>retries</code> integer, which is used in a simple <code>busy_handler</code> function to retry busy connections without exponential backoff up to the max number of <code>retries</code>.</p>

<p><em>Stephen Margheim</em></p></li>
<li><p>The SQLite3 adapter now supports <code>supports_insert_returning?</code></p>

<p>Implementing the full <code>supports_insert_returning?</code> contract means the SQLite3 adapter supports auto-populated columns (#48241) as well as custom primary keys.</p>

<p><em>Stephen Margheim</em></p></li>
<li><p>Ensure the SQLite3 adapter handles default functions with the <code>||</code> concatenation operator</p>

<p>Previously, this default function would produce the static string <code>&quot;&#39;Ruby &#39; || &#39;on &#39; || &#39;Rails&#39;&quot;</code>.
Now, the adapter will appropriately receive and use <code>&quot;Ruby on Rails&quot;</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_change_column_default'>change_column_default</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test_models</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby_on_rails</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(&#39;Ruby &#39; || &#39;on &#39; || &#39;Rails&#39;)</span><span class='tstring_end'>&quot;</span></span> }</code></pre>

<p><em>Stephen Margheim</em></p></li>
<li><p>Dump PostgreSQL schemas as part of the schema dump.</p>

<p><em>Lachlan Sylvester</em></p></li>
</ul>

<h2>Rails 7.1.0.beta1 (September 13, 2023)</h2>

<ul>
<li><p>Encryption now supports <code>support_unencrypted_data</code> being set per-attribute.</p>

<p>You can now opt out of <code>support_unencrypted_data</code> on a specific encrypted attribute.
This only has an effect if <code>ActiveRecord::Encryption.config.support_unencrypted_data == true</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>deterministic:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>support_unencrypted_data:</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>deterministic:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Add instrumentation for Active Record transactions</p>

<p>Allows subscribing to transaction events for tracking/instrumentation. The event payload contains the connection and the outcome (commit, rollback, restart, incomplete), as well as timing details.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/Notifications.html" title="ActiveSupport::Notifications (module)">Notifications</a></span>.<span class='id identifier rubyid_subscribe'><a href="ActiveSupport/Notifications.html#subscribe-class_method" title="ActiveSupport::Notifications.subscribe (method)">subscribe</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>transaction.active_record</span><span class='tstring_end'>&quot;</span></span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_event'>event</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Transaction event occurred!</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='id identifier rubyid_event'>event</span>.<span class='id identifier rubyid_payload'>payload</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_connection'>connection</span>]
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connection: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<p><em>Daniel Colson</em>, <em>Ian Candy</em></p></li>
<li><p>Support composite foreign keys via migration helpers.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Assuming &quot;carts&quot; table has &quot;(shop_id, user_id)&quot; as a primary key.
</span>
<span class='id identifier rubyid_add_foreign_key'>add_foreign_key</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_orders'>orders</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_carts'>carts</span><span class='comma'>,</span> <span class='label'>primary_key:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_shop_id'>shop_id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user_id'>user_id</span>])

<span class='id identifier rubyid_remove_foreign_key'>remove_foreign_key</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_orders'>orders</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_carts'>carts</span><span class='comma'>,</span> <span class='label'>primary_key:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_shop_id'>shop_id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user_id'>user_id</span>])
<span class='id identifier rubyid_foreign_key_exists?'>foreign_key_exists?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_orders'>orders</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_carts'>carts</span><span class='comma'>,</span> <span class='label'>primary_key:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_shop_id'>shop_id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user_id'>user_id</span>])</code></pre>

<p><em>fatkodima</em></p></li>
<li><p>Adds support for <code>if_not_exists</code> when adding a check constraint.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_check_constraint'>add_check_constraint</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>post_type IN (&#39;blog&#39;, &#39;comment&#39;, &#39;share&#39;)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>if_not_exists:</span> <span class='kw'>true</span></code></pre>

<p><em>Cody Cutrer</em></p></li>
<li><p>Raise an <code>ArgumentError</code> when <code>#accepts_nested_attributes_for</code> is declared more than once for an association in
the same class. Previously, the last declaration would silently override the previous one. Overriding in a subclass
is still allowed.</p>

<p><em>Joshua Young</em></p></li>
<li><p>Deprecate <code>rewhere</code> argument on <code>#merge</code>.</p>

<p>The <code>rewhere</code> argument on <code>#merge</code>is deprecated without replacement and
will be removed in Rails 7.2.</p>

<p><em>Adam Hess</em></p></li>
<li><p>Deprecate aliasing non-attributes with <code>alias_attribute</code>.</p>

<p><em>Ian Candy</em></p></li>
<li><p>Fix unscope is not working in specific case</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='int'>1</span><span class='op'>...</span><span class='int'>3</span>).<span class='id identifier rubyid_unscope'>unscope</span>(<span class='label'>where:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>).<span class='id identifier rubyid_to_sql'>to_sql</span> <span class='comment'># &quot;SELECT `posts`.* FROM `posts` WHERE `posts`.`id` &gt;= 1 AND `posts`.`id` &lt; 3&quot;</span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='int'>1</span><span class='op'>...</span><span class='int'>3</span>).<span class='id identifier rubyid_unscope'>unscope</span>(<span class='label'>where:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>).<span class='id identifier rubyid_to_sql'>to_sql</span> <span class='comment'># &quot;SELECT `posts`.* FROM `posts`&quot;</span></code></pre>

<p>Fixes #48094.</p>

<p><em>Kazuya Hatanaka</em></p></li>
<li><p>Change <code>has_secure_token</code> default to <code>on: :initialize</code></p>

<p>Change the new default value from <code>on: :create</code> to <code>on: :initialize</code></p>

<p>Can be controlled by the <code>config.active_record.generate_secure_token_on</code>
configuration:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_generate_secure_token_on'>generate_secure_token_on</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_create'>create</span></code></pre>

<p><em>Sean Doyle</em></p></li>
<li><p>Fix <code>change_column</code> not setting <code>precision: 6</code> on <code>datetime</code> columns when
using 7.0+ Migrations and SQLite.</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Support composite identifiers in <code>to_key</code></p>

<p><code>to_key</code> avoids wrapping <code>#id</code> value into an <a href="Array.html" title="Array (class)"><code>Array</code></a> if <code>#id</code> already an array</p>

<p><em>Nikita Vasilevsky</em></p></li>
<li><p>Add validation option for <code>enum</code></p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Contract</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_enum'>enum</span> <span class='symbeg'>:</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='qwords'><span class='qwords_beg'>%w[</span><span class='tstring_content'>in_progress</span><span class='words_sep'> </span><span class='tstring_content'>completed</span><span class='tstring_end'>]</span></span><span class='comma'>,</span> <span class='label'>validate:</span> <span class='kw'>true</span>
<span class='kw'>end</span>
<span class='const'>Contract</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unknown</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_valid?'>valid?</span> <span class='comment'># =&gt; false
</span><span class='const'>Contract</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>status:</span> <span class='kw'>nil</span>).<span class='id identifier rubyid_valid?'>valid?</span> <span class='comment'># =&gt; false
</span><span class='const'>Contract</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>completed</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_valid?'>valid?</span> <span class='comment'># =&gt; true
</span>
<span class='kw'>class</span> <span class='const'>Contract</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_enum'>enum</span> <span class='symbeg'>:</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='qwords'><span class='qwords_beg'>%w[</span><span class='tstring_content'>in_progress</span><span class='words_sep'> </span><span class='tstring_content'>completed</span><span class='tstring_end'>]</span></span><span class='comma'>,</span> <span class='label'>validate:</span> { <span class='label'>allow_nil:</span> <span class='kw'>true</span> }
<span class='kw'>end</span>
<span class='const'>Contract</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unknown</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_valid?'>valid?</span> <span class='comment'># =&gt; false
</span><span class='const'>Contract</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>status:</span> <span class='kw'>nil</span>).<span class='id identifier rubyid_valid?'>valid?</span> <span class='comment'># =&gt; true
</span><span class='const'>Contract</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>completed</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_valid?'>valid?</span> <span class='comment'># =&gt; true</span></code></pre>

<p><em>Edem Topuzov</em>, <em>Ryuta Kamizono</em></p></li>
<li><p>Allow batching methods to use already loaded relation if available</p>

<p>Calling batch methods on already loaded relations will use the records previously loaded instead of retrieving
them from the database again.</p>

<p><em>Adam Hess</em></p></li>
<li><p>Deprecate <code>read_attribute(:id)</code> returning the primary key if the primary key is not <code>:id</code>.</p>

<p>Starting in Rails 7.2, <code>read_attribute(:id)</code> will return the value of the id column, regardless of the model&#39;s
primary key. To retrieve the value of the primary key, use <code>#id</code> instead. <code>read_attribute(:id)</code> for composite
primary key models will now return the value of the id column.</p>

<p><em>Adrianna Chang</em></p></li>
<li><p>Fix <code>change_table</code> setting datetime precision for 6.1 Migrations</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Fix change_column setting datetime precision for 6.1 Migrations</p>

<p><em>Hartley McGuire</em></p></li>
<li><p>Add <code>ActiveRecord::Base#id_value</code> alias to access the raw value of a record&#39;s id column.</p>

<p>This alias is only provided for models that declare an <code>:id</code> column.</p>

<p><em>Adrianna Chang</em></p></li>
<li><p>Fix previous change tracking for <a href="ActiveRecord/Store.html" title="ActiveRecord::Store (module)"><code>::ActiveRecord::Store</code></a> when using a column with JSON structured database type</p>

<p>Before, the methods to access the changes made during the last save <code>#saved_change_to_key?</code>, <code>#saved_change_to_key</code>, and <code>#key_before_last_save</code> did not work if the store was defined as a <code>store_accessor</code> on a column with a JSON structured database type</p>

<p><em>Robert DiMartino</em></p></li>
<li><p>Fully support <code>NULLS [NOT] DISTINCT</code> for PostgreSQL 15+ indexes.</p>

<p>Previous work was done to allow the index to be created in a migration, but it was not
supported in schema.rb. Additionally, the matching for <code>NULLS [NOT] DISTINCT</code> was not
in the correct order, which could have resulted in inconsistent schema detection.</p>

<p><em>Gregory Jones</em></p></li>
<li><p>Allow escaping of literal colon characters in <code>sanitize_sql_*</code> methods when named bind variables are used</p>

<p><em>Justin Bull</em></p></li>
<li><p>Fix <code>#previously_new_record?</code> to return true for destroyed records.</p>

<p>Before, if a record was created and then destroyed, <code>#previously_new_record?</code> would return true.
Now, any UPDATE or DELETE to a record is considered a change, and will result in <code>#previously_new_record?</code>
returning false.</p>

<p><em>Adrianna Chang</em></p></li>
<li><p>Specify callback in <code>has_secure_token</code></p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_secure_token'>has_secure_token</span> <span class='label'>on:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_initialize'>initialize</span>
<span class='kw'>end</span>

<span class='const'>User</span>.<span class='id identifier rubyid_new'>new</span>.<span class='id identifier rubyid_token'>token</span> <span class='comment'># =&gt; &quot;abc123....&quot;</span></code></pre>

<p><em>Sean Doyle</em></p></li>
<li><p>Fix incrementation of in memory counter caches when associations overlap</p>

<p>When two associations had a similarly named counter cache column, Active Record
could sometime increment the wrong one.</p>

<p><em>Jacopo Beschi</em>, <em>Jean Boussier</em></p></li>
<li><p>Don&#39;t show secrets for Active Record&#39;s <code>Cipher::Aes256Gcm#inspect</code>.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)">Encryption</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption/Cipher.html" title="ActiveRecord::Encryption::Cipher (class)">Cipher</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption/Cipher/Aes256Gcm.html" title="ActiveRecord::Encryption::Cipher::Aes256Gcm (class)">Aes256Gcm</a></span>.<span class='id identifier rubyid_new'><a href="ActiveRecord/Encryption/Cipher/Aes256Gcm.html#new-class_method" title="ActiveRecord::Encryption::Cipher::Aes256Gcm.new (method)">new</a></span>(<span class='id identifier rubyid_secret'>secret</span>).<span class='id identifier rubyid_inspect'><a href="ActiveRecord/Encryption/Cipher/Aes256Gcm.html#inspect-instance_method" title="ActiveRecord::Encryption::Cipher::Aes256Gcm#inspect (method)">inspect</a></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;ActiveRecord::Encryption::Cipher::Aes256Gcm:0x0000000104888038 ... @secret=\&quot;\\xAF\\bFh]LV}q\\nl\\xB2U\\xB3 ... &gt;</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption.html" title="ActiveRecord::Encryption (module)">Encryption</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption/Cipher.html" title="ActiveRecord::Encryption::Cipher (class)">Cipher</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Encryption/Cipher/Aes256Gcm.html" title="ActiveRecord::Encryption::Cipher::Aes256Gcm (class)">Aes256Gcm</a></span>(<span class='id identifier rubyid_secret'>secret</span>).<span class='id identifier rubyid_inspect'><a href="ActiveRecord/Encryption/Cipher/Aes256Gcm.html#inspect-instance_method" title="ActiveRecord::Encryption::Cipher::Aes256Gcm#inspect (method)">inspect</a></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;ActiveRecord::Encryption::Cipher::Aes256Gcm:0x0000000104888038&gt;</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p><em>Petrik de Heus</em></p></li>
<li><p>Bring back the historical behavior of committing transaction on non-local return.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Model</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_model'>model</span>.<span class='id identifier rubyid_save'>save</span>
  <span class='kw'>return</span>
  <span class='id identifier rubyid_other_model'>other_model</span>.<span class='id identifier rubyid_save'>save</span> <span class='comment'># not executed
</span><span class='kw'>end</span></code></pre>

<p>Historically only raised errors would trigger a rollback, but in Ruby <code>2.3</code>, the <code>timeout</code> library
started using <code>throw</code> to interrupt execution which had the adverse effect of committing open transactions.</p>

<p>To solve this, in Active Record 6.1 the behavior was changed to instead rollback the transaction as it was safer
than to potentially commit an incomplete transaction.</p>

<p>Using <code>return</code>, <code>break</code> or <code>throw</code> inside a <code>transaction</code> block was essentially deprecated from Rails 6.1 onwards.</p>

<p>However with the release of <code>timeout 0.4.0</code>, <code>Timeout.timeout</code> now raises an error again, and Active Record is able
to return to its original, less surprising, behavior.</p>

<p>This historical behavior can now be opt-ed in via:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_commit_transaction_on_non_local_return'>commit_transaction_on_non_local_return</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>And is the default for new applications created in Rails 7.1.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Deprecate <code>name</code> argument on <code>#remove_connection</code>.</p>

<p>The <code>name</code> argument is deprecated on <code>#remove_connection</code> without replacement. <code>#remove_connection</code> should be called directly on the class that established the connection.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Fix has_one through singular building with inverse.</p>

<p>Allows building of records from an association with a has_one through a
singular association with inverse. For belongs_to through associations,
linking the foreign key to the primary key model isn&#39;t needed.
For has_one, we cannot build records due to the association not being mutable.</p>

<p><em>Gannon McGibbon</em></p></li>
<li><p>Disable database prepared statements when query logs are enabled</p>

<p>Prepared Statements and Query Logs are incompatible features due to query logs making every query unique.</p>

<p><em>zzak, Jean Boussier</em></p></li>
<li><p>Support decrypting data encrypted non-deterministically with a SHA1 hash digest.</p>

<p>This adds a new Active Record encryption option to support decrypting data encrypted
non-deterministically with a SHA1 hash digest:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_support_sha1_for_non_deterministic_encryption'>support_sha1_for_non_deterministic_encryption</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>The new option addresses a problem when upgrading from 7.0 to 7.1. Due to a bug in how Active Record
Encryption was getting initialized, the key provider used for non-deterministic encryption were using
SHA-1 as its digest class, instead of the one configured globally by Rails via
<code>Rails.application.config.active_support.key_generator_hash_digest_class</code>.</p>

<p><em>Cadu Ribeiro and Jorge Manrubia</em></p></li>
<li><p>Added PostgreSQL migration commands for enum rename, add value, and rename value.</p>

<p><code>rename_enum</code> and <code>rename_enum_value</code> are reversible. Due to Postgres
limitation, <code>add_enum_value</code> is not reversible since you cannot delete enum
values. As an alternative you should drop and recreate the enum entirely.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rename_enum'>rename_enum</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_status'>article_status</span><span class='comma'>,</span> <span class='label'>to:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_enum_value'>add_enum_value</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>archived</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># will be at the end of existing values
</span><span class='id identifier rubyid_add_enum_value'>add_enum_value</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>in review</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>before:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>published</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_add_enum_value'>add_enum_value</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>approved</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>after:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>in review</span><span class='tstring_end'>&quot;</span></span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rename_enum_value'>rename_enum_value</span> <span class='symbeg'>:</span><span class='id identifier rubyid_article_state'>article_state</span><span class='comma'>,</span> <span class='label'>from:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>archived</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>deleted</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p><em>Ray Faddis</em></p></li>
<li><p>Allow composite primary key to be derived from schema</p>

<p>Booting an application with a schema that contains composite primary keys
will not issue warning and won&#39;t <code>nil</code>ify the <code>ActiveRecord::Base#primary_key</code> value anymore.</p>

<p>Given a <code>travel_routes</code> table definition and a <code>TravelRoute</code> model like:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_travel_routes'>travel_routes</span><span class='comma'>,</span> <span class='label'>primary_key:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_origin'>origin</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destination'>destination</span>]<span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>true</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_origin'>origin</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destination'>destination</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>TravelRoute</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span><span class='semicolon'>;</span> <span class='kw'>end</span></code></pre>

<p>The <code>TravelRoute.primary_key</code> value will be automatically derived to <code>[&quot;origin&quot;, &quot;destination&quot;]</code></p>

<p><em>Nikita Vasilevsky</em></p></li>
<li><p>Include the <code>connection_pool</code> with exceptions raised from an adapter.</p>

<p>The <code>connection_pool</code> provides added context such as the connection used
that led to the exception as well as which role and shard.</p>

<p><em>Luan Vieira</em></p></li>
<li><p>Support multiple column ordering for <code>find_each</code>, <code>find_in_batches</code> and <code>in_batches</code>.</p>

<p>When find_each/find_in_batches/in_batches are performed on a table with composite primary keys, ascending or descending order can be selected for each key.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_find_each'>find_each</span>(<span class='label'>order:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_asc'>asc</span>]) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span>
<span class='kw'>end</span></code></pre>

<p><em>Takuya Kurimoto</em></p></li>
<li><p>Fix where on association with has_one/has_many polymorphic relations.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Treasure</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>price_estimates:</span> <span class='const'>PriceEstimate</span>.<span class='id identifier rubyid_all'>all</span>)
<span class='comment'>#=&gt; SELECT (...) WHERE &quot;treasures&quot;.&quot;id&quot; IN (SELECT &quot;price_estimates&quot;.&quot;estimate_of_id&quot; FROM &quot;price_estimates&quot;)</span></code></pre>

<p>Later:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Treasure</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>price_estimates:</span> <span class='const'>PriceEstimate</span>.<span class='id identifier rubyid_all'>all</span>)
<span class='comment'>#=&gt; SELECT (...) WHERE &quot;treasures&quot;.&quot;id&quot; IN (SELECT &quot;price_estimates&quot;.&quot;estimate_of_id&quot; FROM &quot;price_estimates&quot; WHERE &quot;price_estimates&quot;.&quot;estimate_of_type&quot; = &#39;Treasure&#39;)</span></code></pre>

<p><em>Lázaro Nixon</em></p></li>
<li><p>Assign auto populated columns on Active Record record creation.</p>

<p>Changes record creation logic to allow for the <code>auto_increment</code> column to be assigned
immediately after creation regardless of it&#39;s relation to the model&#39;s primary key.</p>

<p>The PostgreSQL adapter benefits the most from the change allowing for any number of auto-populated
columns to be assigned on the object immediately after row insertion utilizing the <code>RETURNING</code> statement.</p>

<p><em>Nikita Vasilevsky</em></p></li>
<li><p>Use the first key in the <code>shards</code> hash from <code>connected_to</code> for the <code>default_shard</code>.</p>

<p>Some applications may not want to use <code>:default</code> as a shard name in their connection model. Unfortunately Active Record expects there to be a <code>:default</code> shard because it must assume a shard to get the right connection from the pool manager. Rather than force applications to manually set this, <code>connects_to</code> can infer the default shard name from the hash of shards and will now assume that the first shard is your default.</p>

<p>For example if your model looked like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ShardRecord</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_abstract_class'>abstract_class</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_connects_to'>connects_to</span> <span class='label'>shards:</span> {
    <span class='label'>shard_one:</span> { <span class='label'>writing:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_shard_one'>shard_one</span> }<span class='comma'>,</span>
    <span class='label'>shard_two:</span> { <span class='label'>writing:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_shard_two'>shard_two</span> }
  }</code></pre>

<p>Then the <code>default_shard</code> for this class would be set to <code>shard_one</code>.</p>

<p>Fixes: #45390</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Fix mutation detection for serialized attributes backed by binary columns.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Add <a href="ActiveRecord.html#disconnect_all!-class_method" title="ActiveRecord.disconnect_all! (method)">ActiveRecord.disconnect_all!</a> method to immediately close all connections from all pools.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Discard connections which may have been left in a transaction.</p>

<p>There are cases where, due to an error, <code>within_new_transaction</code> may unexpectedly leave a connection in an open transaction. In these cases the connection may be reused, and the following may occur:</p>

<ul>
<li>Writes appear to fail when they actually succeed.</li>
<li>Writes appear to succeed when they actually fail.</li>
<li>Reads return stale or uncommitted data.</li>
</ul>

<p>Previously, the following case was detected:</p>

<ul>
<li>An error is encountered during the transaction, then another error is encountered while attempting to roll it back.</li>
</ul>

<p>Now, the following additional cases are detected:</p>

<ul>
<li>An error is encountered just after successfully beginning a transaction.</li>
<li>An error is encountered while committing a transaction, then another error is encountered while attempting to roll it back.</li>
<li>An error is encountered while rolling back a transaction.</li>
</ul>

<p><em>Nick Dower</em></p></li>
<li><p>Active Record query cache now evicts least recently used entries</p>

<p>By default it only keeps the <code>100</code> most recently used queries.</p>

<p>The cache size can be configured via <code>database.yml</code></p>

<pre class="code yaml"><code class="yaml">development:
  adapter: mysql2
  query_cache: 200
</code></pre>

<p>It can also be entirely disabled:</p>

<pre class="code yaml"><code class="yaml">development:
  adapter: mysql2
  query_cache: false
</code></pre>

<p><em>Jean Boussier</em></p></li>
<li><p>Deprecate <code>check_pending!</code> in favor of <code>check_all_pending!</code>.</p>

<p><code>check_pending!</code> will only check for pending migrations on the current database connection or the one passed in. This has been deprecated in favor of <code>check_all_pending!</code> which will find all pending migrations for the database configurations in a given environment.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Make <code>increment_counter</code>/<code>decrement_counter</code> accept an amount argument</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_increment_counter'>increment_counter</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments_count'>comments_count</span><span class='comma'>,</span> <span class='int'>5</span><span class='comma'>,</span> <span class='label'>by:</span> <span class='int'>3</span>)</code></pre>

<p><em>fatkodima</em></p></li>
<li><p>Add support for <code>Array#intersect?</code> to <a href="ActiveRecord/Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a>.</p>

<p><code>Array#intersect?</code> is only available on Ruby 3.1 or later.</p>

<p>This allows the Rubocop <code>Style/ArrayIntersect</code> cop to work with <a href="ActiveRecord/Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a> objects.</p>

<p><em>John Harry Kelly</em></p></li>
<li><p>The deferrable foreign key can be passed to <code>t.references</code>.</p>

<p><em>Hiroyuki Ishii</em></p></li>
<li><p>Deprecate <code>deferrable: true</code> option of <code>add_foreign_key</code>.</p>

<p><code>deferrable: true</code> is deprecated in favor of <code>deferrable: :immediate</code>, and
will be removed in Rails 7.2.</p>

<p>Because <code>deferrable: true</code> and <code>deferrable: :deferred</code> are hard to understand.
Both true and :deferred are truthy values.
This behavior is the same as the deferrable option of the add_unique_key method, added in #46192.</p>

<p><em>Hiroyuki Ishii</em></p></li>
<li><p><code>AbstractAdapter#execute</code> and <code>#exec_query</code> now clear the query cache</p>

<p>If you need to perform a read only SQL query without clearing the query
cache, use <code>AbstractAdapter#select_all</code>.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Make <code>.joins</code> / <code>.left_outer_joins</code> work with CTEs.</p>

<p>For example:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>
 .<span class='id identifier rubyid_with'>with</span>(<span class='label'>commented_posts:</span> <span class='const'>Comment</span>.<span class='id identifier rubyid_select'>select</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_post_id'>post_id</span>).<span class='id identifier rubyid_distinct'>distinct</span>)
 .<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_commented_posts'>commented_posts</span>)
<span class='comment'>#=&gt; WITH (...) SELECT ... INNER JOIN commented_posts on posts.id = commented_posts.post_id</span></code></pre>

<p><em>Vladimir Dementyev</em></p></li>
<li><p>Add a load hook for <a href="ActiveRecord/ConnectionAdapters/Mysql2Adapter.html" title="ActiveRecord::ConnectionAdapters::Mysql2Adapter (class)"><code>::ActiveRecord::ConnectionAdapters::Mysql2Adapter</code></a>
(named <code>active_record_mysql2adapter</code>) to allow for overriding aspects of the
<a href="ActiveRecord/ConnectionAdapters/Mysql2Adapter.html" title="ActiveRecord::ConnectionAdapters::Mysql2Adapter (class)"><code>::ActiveRecord::ConnectionAdapters::Mysql2Adapter</code></a> class. This makes <code>Mysql2Adapter</code>
consistent with <code>PostgreSQLAdapter</code> and <code>SQLite3Adapter</code> that already have load hooks.</p>

<p><em>fatkodima</em></p></li>
<li><p>Introduce adapter for Trilogy database client</p>

<p>Trilogy is a MySQL-compatible database client. Rails applications can use Trilogy
by configuring their <code>config/database.yml</code>:</p>

<pre class="code yaml"><code class="yaml">development:
adapter: trilogy
database: blog_development
pool: 5
</code></pre>

<p>Or by using the <code>DATABASE_URL</code> environment variable:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>DATABASE_URL</span><span class='tstring_end'>&#39;</span></span>] <span class='comment'># =&gt; &quot;trilogy://localhost/blog_development?pool=5&quot;</span></code></pre>

<p><em>Adrianna Chang</em></p></li>
<li><p><code>after_commit</code> callbacks defined on models now execute in the correct order.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_after_commit'>after_commit</span> { <span class='id identifier rubyid_puts'>puts</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>this gets called first</span><span class='tstring_end'>&quot;</span></span>) }
  <span class='id identifier rubyid_after_commit'>after_commit</span> { <span class='id identifier rubyid_puts'>puts</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>this gets called second</span><span class='tstring_end'>&quot;</span></span>) }
<span class='kw'>end</span></code></pre>

<p>Previously, the callbacks executed in the reverse order. To opt in to the new behaviour:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_run_after_transaction_callbacks_in_order_defined'>run_after_transaction_callbacks_in_order_defined</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>This is the default for new apps.</p>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Infer <code>foreign_key</code> when <code>inverse_of</code> is present on <code>has_one</code> and <code>has_many</code> associations.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_citations'>citations</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>book1_id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_book'>book</span></code></pre>

<p>can be simplified to</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_citations'>citations</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_book'>book</span></code></pre>

<p>and the foreign_key will be read from the corresponding <code>belongs_to</code> association.</p>

<p><em>Daniel Whitney</em></p></li>
<li><p>Limit max length of auto generated index names</p>

<p>Auto generated index names are now limited to 62 bytes, which fits within
the default index name length limits for MySQL, Postgres and SQLite.</p>

<p>Any index name over the limit will fallback to the new short format.</p>

<p>Before (too long):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_index_testings_on_foo_and_bar_and_first_name_and_last_name_and_administrator'>index_testings_on_foo_and_bar_and_first_name_and_last_name_and_administrator</span></code></pre>

<p>After (short format):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_idx_on_foo_bar_first_name_last_name_administrator_5939248142'>idx_on_foo_bar_first_name_last_name_administrator_5939248142</span></code></pre>

<p>The short format includes a hash to ensure the name is unique database-wide.</p>

<p><em>Mike Coutermarsh</em></p></li>
<li><p>Introduce a more stable and optimized Marshal serializer for Active Record models.</p>

<p>Can be enabled with <code>config.active_record.marshalling_format_version = 7.1</code>.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Allow specifying where clauses with column-tuple syntax.</p>

<p>Querying through <code>#where</code> now accepts a new tuple-syntax which accepts, as
a key, an array of columns and, as a value, an array of corresponding tuples.
The key specifies a list of columns, while the value is an array of
ordered-tuples that conform to the column list.</p>

<p>For instance:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Cpk::Book =&gt; Cpk::Book(author_id: integer, number: integer, title: string, revision: integer)
</span><span class='comment'># Cpk::Book.primary_key =&gt; [&quot;author_id&quot;, &quot;number&quot;]
</span>
<span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Cpk</span><span class='op'>::</span><span class='const'>Book</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>author_id:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>number:</span> <span class='int'>1</span>)
<span class='const'>Cpk</span><span class='op'>::</span><span class='const'>Book</span>.<span class='id identifier rubyid_where'>where</span>(<span class='const'>Cpk</span><span class='op'>::</span><span class='const'>Book</span>.<span class='id identifier rubyid_primary_key'>primary_key</span> <span class='op'>=&gt;</span> [[<span class='int'>1</span><span class='comma'>,</span> <span class='int'>2</span>]]) <span class='comment'># =&gt; [book]
</span>
<span class='comment'># Topic =&gt; Topic(id: integer, title: string, author_name: string...)
</span>
<span class='const'>Topic</span>.<span class='id identifier rubyid_where'>where</span>([<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_author_name'>author_name</span>] <span class='op'>=&gt;</span> [[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The Alchemist</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Paulo Coelho</span><span class='tstring_end'>&quot;</span></span>]<span class='comma'>,</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Harry Potter</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>J.K Rowling</span><span class='tstring_end'>&quot;</span></span>]])</code></pre>

<p><em>Paarth Madan</em></p></li>
<li><p>Allow warning codes to be ignore when reporting SQL warnings.</p>

<p>Active Record config that can ignore warning codes</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Configure allowlist of warnings that should always be ignored
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_db_warnings_ignore'>db_warnings_ignore</span> <span class='op'>=</span> [
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1062</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='comment'># MySQL Error 1062: Duplicate entry
</span>]</code></pre>

<p>This is supported for the MySQL and PostgreSQL adapters.</p>

<p><em>Nick Borromeo</em></p></li>
<li><p>Introduce <code>:active_record_fixtures</code> lazy load hook.</p>

<p>Hooks defined with this name will be run whenever <code>TestFixtures</code> is included
in a class.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span>.<span class='id identifier rubyid_on_load'><a href="ActiveSupport/LazyLoadHooks.html#on_load-instance_method" title="ActiveSupport::LazyLoadHooks#on_load (method)">on_load</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_active_record_fixtures'>active_record_fixtures</span>) <span class='kw'>do</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_fixture_paths'>fixture_paths</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test/fixtures</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_klass'>klass</span> <span class='op'>=</span> <span class='const'><a href="Class.html" title="Class (class)">Class</a></span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_klass'>klass</span>.<span class='id identifier rubyid_include'>include</span>(<span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/TestFixtures.html" title="ActiveRecord::TestFixtures (module)">TestFixtures</a></span>)

<span class='id identifier rubyid_klass'>klass</span>.<span class='id identifier rubyid_fixture_paths'>fixture_paths</span> <span class='comment'># =&gt; [&quot;test/fixtures&quot;]</span></code></pre>

<p><em>Andrew Novoselac</em></p></li>
<li><p>Introduce <code>TestFixtures#fixture_paths</code>.</p>

<p>Multiple fixture paths can now be specified using the <code>#fixture_paths</code> accessor.
Apps will continue to have <code>test/fixtures</code> as their one fixture path by default,
but additional fixture paths can be specified.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/TestCase.html" title="ActiveSupport::TestCase (class)">TestCase</a></span>.<span class='id identifier rubyid_fixture_paths'><a href="ActiveSupport/TestCase.html#fixture_paths-class_method" title="ActiveSupport::TestCase.fixture_paths (method)">fixture_paths</a></span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>component1/test/fixtures</span><span class='tstring_end'>&quot;</span></span>
<span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/TestCase.html" title="ActiveSupport::TestCase (class)">TestCase</a></span>.<span class='id identifier rubyid_fixture_paths'><a href="ActiveSupport/TestCase.html#fixture_paths-class_method" title="ActiveSupport::TestCase.fixture_paths (method)">fixture_paths</a></span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>component2/test/fixtures</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p><code>TestFixtures#fixture_path</code> is now deprecated.</p>

<p><em>Andrew Novoselac</em></p></li>
<li><p>Adds support for deferrable exclude constraints in PostgreSQL.</p>

<p>By default, exclude constraints in PostgreSQL are checked after each statement.
This works for most use cases, but becomes a major limitation when replacing
records with overlapping ranges by using multiple statements.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_exclusion_constraint'>exclusion_constraint</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>daterange(valid_from, valid_to) WITH &amp;&amp;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_immediate'>immediate</span></code></pre>

<p>Passing <code>deferrable: :immediate</code> checks constraint after each statement,
but allows manually deferring the check using <code>SET CONSTRAINTS ALL DEFERRED</code>
within a transaction. This will cause the excludes to be checked after the transaction.</p>

<p>It&#39;s also possible to change the default behavior from an immediate check
(after the statement), to a deferred check (after the transaction):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_exclusion_constraint'>exclusion_constraint</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>daterange(valid_from, valid_to) WITH &amp;&amp;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_deferred'>deferred</span></code></pre>

<p><em>Hiroyuki Ishii</em></p></li>
<li><p>Respect <code>foreign_type</code> option to <code>delegated_type</code> for <code>{role}_class</code> method.</p>

<p>Usage of <code>delegated_type</code> with non-conventional <code>{role}_type</code> column names can now be specified with <code>foreign_type</code> option.
This option is the same as <code>foreign_type</code> as forwarded to the underlying <code>belongs_to</code> association that <code>delegated_type</code> wraps.</p>

<p><em>Jason Karns</em></p></li>
<li><p>Add support for unique constraints (PostgreSQL-only).</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_unique_key'>add_unique_key</span> <span class='symbeg'>:</span><span class='id identifier rubyid_sections'>sections</span><span class='comma'>,</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_position'>position</span>]<span class='comma'>,</span> <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_deferred'>deferred</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unique_section_position</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_remove_unique_key'>remove_unique_key</span> <span class='symbeg'>:</span><span class='id identifier rubyid_sections'>sections</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unique_section_position</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>See PostgreSQL&#39;s <a href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS">Unique Constraints</a> documentation for more on unique constraints.</p>

<p>By default, unique constraints in PostgreSQL are checked after each statement.
This works for most use cases, but becomes a major limitation when replacing
records with unique column by using multiple statements.</p>

<p>An example of swapping unique columns between records.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># position is unique column
</span><span class='id identifier rubyid_old_item'>old_item</span> <span class='op'>=</span> <span class='const'>Item</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>position:</span> <span class='int'>1</span>)
<span class='id identifier rubyid_new_item'>new_item</span> <span class='op'>=</span> <span class='const'>Item</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>position:</span> <span class='int'>2</span>)

<span class='const'>Item</span>.<span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_old_item'>old_item</span>.<span class='id identifier rubyid_update!'>update!</span>(<span class='label'>position:</span> <span class='int'>2</span>)
  <span class='id identifier rubyid_new_item'>new_item</span>.<span class='id identifier rubyid_update!'>update!</span>(<span class='label'>position:</span> <span class='int'>1</span>)
<span class='kw'>end</span></code></pre>

<p>Using the default behavior, the transaction would fail when executing the
first <code>UPDATE</code> statement.</p>

<p>By passing the <code>:deferrable</code> option to the <code>add_unique_key</code> statement in
migrations, it&#39;s possible to defer this check.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_unique_key'>add_unique_key</span> <span class='symbeg'>:</span><span class='id identifier rubyid_items'>items</span><span class='comma'>,</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_position'>position</span>]<span class='comma'>,</span> <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_immediate'>immediate</span></code></pre>

<p>Passing <code>deferrable: :immediate</code> does not change the behaviour of the previous example,
but allows manually deferring the check using <code>SET CONSTRAINTS ALL DEFERRED</code> within a transaction.
This will cause the unique constraints to be checked after the transaction.</p>

<p>It&#39;s also possible to adjust the default behavior from an immediate
check (after the statement), to a deferred check (after the transaction):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_unique_key'>add_unique_key</span> <span class='symbeg'>:</span><span class='id identifier rubyid_items'>items</span><span class='comma'>,</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_position'>position</span>]<span class='comma'>,</span> <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_deferred'>deferred</span></code></pre>

<p>If you want to change an existing unique index to deferrable, you can use :using_index
to create deferrable unique constraints.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_unique_key'>add_unique_key</span> <span class='symbeg'>:</span><span class='id identifier rubyid_items'>items</span><span class='comma'>,</span> <span class='label'>deferrable:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_deferred'>deferred</span><span class='comma'>,</span> <span class='label'>using_index:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>index_items_on_position</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p><em>Hiroyuki Ishii</em></p></li>
<li><p>Remove deprecated <code>Tasks::DatabaseTasks.schema_file_type</code>.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <code>config.active_record.partial_writes</code>.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> config accessors.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove the <code>:include_replicas</code> argument from <code>configs_for</code>. Use <code>:include_hidden</code> argument instead.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Allow applications to lookup a config via a custom hash key.</p>

<p>If you have registered a custom config or want to find configs where the hash matches a specific key, now you can pass <code>config_key</code> to <code>configs_for</code>. For example if you have a <code>db_config</code> with the key <code>vitess</code> you can look up a database configuration hash by  matching that key.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_configurations'><a href="ActiveRecord/Base.html#configurations-class_method" title="ActiveRecord::Base.configurations (method)">configurations</a></span>.<span class='id identifier rubyid_configs_for'>configs_for</span>(<span class='label'>env_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>development</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>primary</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>config_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_vitess'>vitess</span>)
<span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_configurations'><a href="ActiveRecord/Base.html#configurations-class_method" title="ActiveRecord::Base.configurations (method)">configurations</a></span>.<span class='id identifier rubyid_configs_for'>configs_for</span>(<span class='label'>env_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>development</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>config_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_vitess'>vitess</span>)</code></pre>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Allow applications to register a custom database configuration handler.</p>

<p>Adds a mechanism for registering a custom handler for cases where you want database configurations to respond to custom methods. This is useful for non-Rails database adapters or tools like Vitess that you may want to configure differently from a standard <code>HashConfig</code> or <code>UrlConfig</code>.</p>

<p>Given the following database YAML we want the <code>animals</code> db to create a <code>CustomConfig</code> object instead while the <code>primary</code> database will be a <code>UrlConfig</code>:</p>

<pre class="code yaml"><code class="yaml">development:
  primary:
    url: postgres://localhost/primary
  animals:
    url: postgres://localhost/animals
    custom_config:
      sharded: 1
</code></pre>

<p>To register a custom handler first make a class that has your custom methods:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CustomConfig</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/DatabaseConfigurations.html" title="ActiveRecord::DatabaseConfigurations (class)">DatabaseConfigurations</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/DatabaseConfigurations/UrlConfig.html" title="ActiveRecord::DatabaseConfigurations::UrlConfig (class)">UrlConfig</a></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_sharded?'>sharded?</span>
    <span class='id identifier rubyid_custom_config'>custom_config</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sharded</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='kw'>false</span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_custom_config'>custom_config</span>
      <span class='id identifier rubyid_configuration_hash'>configuration_hash</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_custom_config'>custom_config</span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Then register the config in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/DatabaseConfigurations.html" title="ActiveRecord::DatabaseConfigurations (class)">DatabaseConfigurations</a></span>.<span class='id identifier rubyid_register_db_config_handler'><a href="ActiveRecord/DatabaseConfigurations.html#register_db_config_handler-class_method" title="ActiveRecord::DatabaseConfigurations.register_db_config_handler (method)">register_db_config_handler</a></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_env_name'>env_name</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_key?'>key?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_custom_config'>custom_config</span>)
  <span class='const'>CustomConfig</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_env_name'>env_name</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='id identifier rubyid_config'>config</span>)
<span class='kw'>end</span></code></pre>

<p>When the application is booted, configuration hashes with the <code>:custom_config</code> key will be <code>CustomConfig</code> objects and respond to <code>sharded?</code>. Applications must handle the condition in which Active Record should use their custom handler.</p>

<p><em>Eileen M. Uchitelle and John Crepezzi</em></p></li>
<li><p><code>ActiveRecord::Base.serialize</code> no longer uses YAML by default.</p>

<p>YAML isn&#39;t particularly performant and can lead to security issues
if not used carefully.</p>

<p>Unfortunately there isn&#39;t really any good serializers in Ruby&#39;s stdlib
to replace it.</p>

<p>The obvious choice would be JSON, which is a fine format for this use case,
however the JSON serializer in Ruby&#39;s stdlib isn&#39;t strict enough, as it fallback
to casting unknown types to strings, which could lead to corrupted data.</p>

<p>Some third party JSON libraries like <code>Oj</code> have a suitable strict mode.</p>

<p>So it&#39;s preferable that users choose a serializer based on their own constraints.</p>

<p>The original default can be restored by setting <code>config.active_record.default_column_serializer = YAML</code>.</p>

<p><em>Jean Boussier</em></p></li>
<li><p><code>ActiveRecord::Base.serialize</code> signature changed.</p>

<p>Rather than a single positional argument that accepts two possible
types of values, <code>serialize</code> now accepts two distinct keyword arguments.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_serialize'>serialize</span> <span class='symbeg'>:</span><span class='id identifier rubyid_content'>content</span><span class='comma'>,</span> <span class='const'>JSON</span>
<span class='id identifier rubyid_serialize'>serialize</span> <span class='symbeg'>:</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='comma'>,</span> <span class='const'><a href="Array.html" title="Array (class)">Array</a></span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_serialize'>serialize</span> <span class='symbeg'>:</span><span class='id identifier rubyid_content'>content</span><span class='comma'>,</span> <span class='label'>coder:</span> <span class='const'>JSON</span>
<span class='id identifier rubyid_serialize'>serialize</span> <span class='symbeg'>:</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><a href="Array.html" title="Array (class)">Array</a></span></code></pre>

<p><em>Jean Boussier</em></p></li>
<li><p>YAML columns use <code>YAML.safe_dump</code> if available.</p>

<p>As of <code>psych 5.1.0</code>, <code>YAML.safe_dump</code> can now apply the same permitted
types restrictions than <code>YAML.safe_load</code>.</p>

<p>It&#39;s preferable to ensure the payload only use allowed types when we first
try to serialize it, otherwise you may end up with invalid records in the
database.</p>

<p><em>Jean Boussier</em></p></li>
<li><p><a href="ActiveRecord/QueryLogs.html" title="ActiveRecord::QueryLogs (module)"><code>::ActiveRecord::QueryLogs</code></a> better handle broken encoding.</p>

<p>It&#39;s not uncommon when building queries with BLOB fields to contain
binary data. Unless the call carefully encode the string in ASCII-8BIT
it generally end up being encoded in <code>UTF-8</code>, and <code>QueryLogs</code> would
end up failing on it.</p>

<p><a href="ActiveRecord/QueryLogs.html" title="ActiveRecord::QueryLogs (module)"><code>::ActiveRecord::QueryLogs</code></a> no longer depend on the query to be properly encoded.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Fix a bug where <a href="ActiveRecord/Generators/ModelGenerator.html" title="ActiveRecord::Generators::ModelGenerator (class)"><code>::ActiveRecord::Generators::ModelGenerator</code></a> would not respect create_table_migration template overrides.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rails'>rails</span> <span class='id identifier rubyid_g'>g</span> <span class='id identifier rubyid_model'>model</span> <span class='id identifier rubyid_create_books'>create_books</span> <span class='label'>title:</span><span class='id identifier rubyid_string'>string</span> <span class='label'>content:</span><span class='id identifier rubyid_text'>text</span></code></pre>

<p>will now read from the create_table_migration.rb.tt template in the following locations in order:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_lib'>lib</span><span class='op'>/</span><span class='id identifier rubyid_templates'>templates</span><span class='op'>/</span><span class='id identifier rubyid_active_record'>active_record</span><span class='op'>/</span><span class='id identifier rubyid_model'>model</span><span class='op'>/</span><span class='id identifier rubyid_create_table_migration'>create_table_migration</span>.<span class='id identifier rubyid_rb'>rb</span>
<span class='id identifier rubyid_lib'>lib</span><span class='op'>/</span><span class='id identifier rubyid_templates'>templates</span><span class='op'>/</span><span class='id identifier rubyid_active_record'>active_record</span><span class='op'>/</span><span class='id identifier rubyid_migration'>migration</span><span class='op'>/</span><span class='id identifier rubyid_create_table_migration'>create_table_migration</span>.<span class='id identifier rubyid_rb'>rb</span></code></pre>

<p><em>Spencer Neste</em></p></li>
<li><p><a href="ActiveRecord/Relation.html#explain-instance_method" title="ActiveRecord::Relation#explain (method)">ActiveRecord::Relation#explain</a> now accepts options.</p>

<p>For databases and adapters which support them (currently PostgreSQL
and MySQL), options can be passed to <code>explain</code> to provide more
detailed query plan analysis:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Customer</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='int'>1</span>).<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_orders'>orders</span>).<span class='id identifier rubyid_explain'>explain</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_analyze'>analyze</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_verbose'>verbose</span>)</code></pre>

<p><em>Reid Lynch</em></p></li>
<li><p>Multiple <a href="Arel/Nodes/SqlLiteral.html" title="Arel::Nodes::SqlLiteral (class)"><code>::Arel::Nodes::SqlLiteral</code></a> nodes can now be added together to
form <a href="Arel/Nodes/Fragments.html" title="Arel::Nodes::Fragments (class)"><code>::Arel::Nodes::Fragments</code></a> nodes. This allows joining several pieces
of SQL.</p>

<p><em>Matthew Draper</em>, <em>Ole Friis</em></p></li>
<li><p><code>ActiveRecord::Base#signed_id</code> raises if called on a new record.</p>

<p>Previously it would return an ID that was not usable, since it was based on <code>id = nil</code>.</p>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Allow SQL warnings to be reported.</p>

<p>Active Record configs can be set to enable SQL warning reporting.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Configure action to take when SQL query produces warning
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_db_warnings_action'>db_warnings_action</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_raise'>raise</span>

<span class='comment'># Configure allowlist of warnings that should always be ignored
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_db_warnings_ignore'>db_warnings_ignore</span> <span class='op'>=</span> [
  <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>Invalid utf8mb4 character string</span><span class='regexp_end'>/</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>An exact warning message</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
]</code></pre>

<p>This is supported for the MySQL and PostgreSQL adapters.</p>

<p><em>Adrianna Chang</em>, <em>Paarth Madan</em></p></li>
<li><p>Add <code>#regroup</code> query method as a short-hand for <code>.unscope(:group).group(fields)</code></p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_group'>group</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span>).<span class='id identifier rubyid_regroup'>regroup</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>)
<span class='comment'># SELECT `posts`.`*` FROM `posts` GROUP BY `posts`.`author`</span></code></pre>

<p><em>Danielius Visockas</em></p></li>
<li><p>PostgreSQL adapter method <code>enable_extension</code> now allows parameter to be <code>[schema_name.]&lt;extension_name&gt;</code>
if the extension must be installed on another schema.</p>

<p>Example: <code>enable_extension(&#39;heroku_ext.hstore&#39;)</code></p>

<p><em>Leonardo Luarte</em></p></li>
<li><p>Add <code>:include</code> option to <code>add_index</code>.</p>

<p>Add support for including non-key columns in indexes for PostgreSQL
with the <code>INCLUDE</code> parameter.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_index'>add_index</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>include:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_created_at'>created_at</span>])</code></pre>

<p>will result in:</p>

<pre class="code sql"><code class="sql">CREATE INDEX index_users_on_email USING btree (email) INCLUDE (id, created_at)
</code></pre>

<p><em>Steve Abrams</em></p></li>
<li><p><a href="ActiveRecord/Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a>’s <code>#any?</code>, <code>#none?</code>, and <code>#one?</code> methods take an optional pattern
argument, more closely matching their <a href="Enumerable.html" title="Enumerable (module)"><code>Enumerable</code></a> equivalents.</p>

<p><em>George Claghorn</em></p></li>
<li><p>Add <code>ActiveRecord::Base.normalizes</code> for declaring attribute normalizations.</p>

<p>An attribute normalization is applied when the attribute is assigned or
updated, and the normalized value will be persisted to the database.  The
normalization is also applied to the corresponding keyword argument of query
methods, allowing records to be queried using unnormalized values.</p>

<p>For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_normalizes'>normalizes</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>with:</span> <span class='tlambda'>-&gt;</span> <span class='id identifier rubyid_email'>email</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_email'>email</span>.<span class='id identifier rubyid_strip'>strip</span>.<span class='id identifier rubyid_downcase'>downcase</span> }
  <span class='id identifier rubyid_normalizes'>normalizes</span> <span class='symbeg'>:</span><span class='id identifier rubyid_phone'>phone</span><span class='comma'>,</span> <span class='label'>with:</span> <span class='tlambda'>-&gt;</span> <span class='id identifier rubyid_phone'>phone</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_phone'>phone</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>^0-9</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_delete_prefix'>delete_prefix</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1</span><span class='tstring_end'>&quot;</span></span>) }
<span class='kw'>end</span>

<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> CRUISE-CONTROL@EXAMPLE.COM\n</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_email'>email</span>                  <span class='comment'># =&gt; &quot;cruise-control@example.com&quot;
</span>
<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\tCRUISE-CONTROL@EXAMPLE.COM </span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_email'>email</span>                  <span class='comment'># =&gt; &quot;cruise-control@example.com&quot;
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_email_before_type_cast'>email_before_type_cast</span> <span class='comment'># =&gt; &quot;cruise-control@example.com&quot;
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\tCRUISE-CONTROL@EXAMPLE.COM </span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_count'>count</span>         <span class='comment'># =&gt; 1
</span><span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>([<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>email = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\tCRUISE-CONTROL@EXAMPLE.COM </span><span class='tstring_end'>&quot;</span></span>]).<span class='id identifier rubyid_count'>count</span> <span class='comment'># =&gt; 0
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_exists?'>exists?</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\tCRUISE-CONTROL@EXAMPLE.COM </span><span class='tstring_end'>&quot;</span></span>)         <span class='comment'># =&gt; true
</span><span class='const'>User</span>.<span class='id identifier rubyid_exists?'>exists?</span>([<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>email = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\tCRUISE-CONTROL@EXAMPLE.COM </span><span class='tstring_end'>&quot;</span></span>]) <span class='comment'># =&gt; false
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_normalize_value_for'>normalize_value_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_phone'>phone</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+1 (555) 867-5309</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># =&gt; &quot;5558675309&quot;</span></code></pre>

<p><em>Jonathan Hefner</em></p></li>
<li><p>Hide changes to before_committed! callback behaviour behind flag.</p>

<p>In #46525, behavior around before_committed! callbacks was changed so that callbacks
would run on every enrolled record in a transaction, not just the first copy of a record.
This change in behavior is now controlled by a configuration option,
<code>config.active_record.before_committed_on_all_records</code>. It will be enabled by default on Rails 7.1.</p>

<p><em>Adrianna Chang</em></p></li>
<li><p>The <code>namespaced_controller</code> Query Log tag now matches the <code>controller</code> format</p>

<p>For example, a request processed by <code>NameSpaced::UsersController</code> will now log as:</p>

<pre class="code ruby"><code class="ruby"><span class='symbeg'>:</span><span class='id identifier rubyid_controller'>controller</span> <span class='comment'># &quot;users&quot;
</span><span class='symbeg'>:</span><span class='id identifier rubyid_namespaced_controller'>namespaced_controller</span> <span class='comment'># &quot;name_spaced/users&quot;</span></code></pre>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Return only unique ids from ActiveRecord::Calculations#ids</p>

<p>Updated ActiveRecord::Calculations#ids to only return the unique ids of the base model
when using eager_load, preload and includes.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>id:</span> <span class='int'>1</span>).<span class='id identifier rubyid_comments'>comments</span>.<span class='id identifier rubyid_count'>count</span>
<span class='comment'># =&gt; 5
</span><span class='const'>Post</span>.<span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>).<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='int'>1</span>).<span class='id identifier rubyid_pluck'>pluck</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>)
<span class='comment'># =&gt; [1, 1, 1, 1, 1]
</span><span class='const'>Post</span>.<span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>).<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='int'>1</span>).<span class='id identifier rubyid_ids'>ids</span>
<span class='comment'># =&gt; [1]</span></code></pre>

<p><em>Joshua Young</em></p></li>
<li><p>Stop using <code>LOWER()</code> for case-insensitive queries on <code>citext</code> columns</p>

<p>Previously, <code>LOWER()</code> was added for e.g. uniqueness validations with
<code>case_sensitive: false</code>.
It wasn&#39;t mentioned in the documentation that the index without <code>LOWER()</code>
wouldn&#39;t be used in this case.</p>

<p><em>Phil Pirozhkov</em></p></li>
<li><p>Extract <code>#sync_timezone_changes</code> method in AbstractMysqlAdapter to enable subclasses
to sync database timezone changes without overriding <code>#raw_execute</code>.</p>

<p><em>Adrianna Chang</em>, <em>Paarth Madan</em></p></li>
<li><p>Do not write additional new lines when dumping sql migration versions</p>

<p>This change updates the <code>insert_versions_sql</code> function so that the database insert string containing the current database migration versions does not end with two additional new lines.</p>

<p><em>Misha Schwartz</em></p></li>
<li><p>Fix <code>composed_of</code> value freezing and duplication.</p>

<p>Previously composite values exhibited two confusing behaviors:</p>

<ul>
<li>When reading a compositve value it&#39;d <em>NOT</em> be frozen, allowing it to get out of sync with its underlying database
columns.</li>
<li>When writing a compositve value the argument would be frozen, potentially confusing the caller.</li>
</ul>

<p>Currently, composite values instantiated based on database columns are frozen (addressing the first issue) and
assigned compositve values are duplicated and the duplicate is frozen (addressing the second issue).</p>

<p><em>Greg Navis</em></p></li>
<li><p>Fix redundant updates to the column insensitivity cache</p>

<p>Fixed redundant queries checking column capability for insensitive
comparison.</p>

<p><em>Phil Pirozhkov</em></p></li>
<li><p>Allow disabling methods generated by <code>ActiveRecord.enum</code>.</p>

<p><em>Alfred Dominic</em></p></li>
<li><p>Avoid validating <code>belongs_to</code> association if it has not changed.</p>

<p>Previously, when updating a record, Active Record will perform an extra query to check for the presence of
<code>belongs_to</code> associations (if the presence is configured to be mandatory), even if that attribute hasn&#39;t changed.</p>

<p>Currently, only <code>belongs_to</code>-related columns are checked for presence. It is possible to have orphaned records with
this approach. To avoid this problem, you need to use a foreign key.</p>

<p>This behavior can be controlled by configuration:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_belongs_to_required_validates_foreign_key'>belongs_to_required_validates_foreign_key</span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>

<p>and will be disabled by default with <code>config.load_defaults 7.1</code>.</p>

<p><em>fatkodima</em></p></li>
<li><p><code>has_one</code> and <code>belongs_to</code> associations now define a <code>reset_association</code> method
on the owner model (where <code>association</code> is the name of the association). This
method unloads the cached associate record, if any, and causes the next access
to query it from the database.</p>

<p><em>George Claghorn</em></p></li>
<li><p>Allow per attribute setting of YAML permitted classes (safe load) and unsafe load.</p>

<p><em>Carlos Palhares</em></p></li>
<li><p>Add a build persistence method</p>

<p>Provides a wrapper for <code>new</code>, to provide feature parity with <code>create</code>s
ability to create multiple records from an array of hashes, using the
same notation as the <code>build</code> method on associations.</p>

<p><em>Sean Denny</em></p></li>
<li><p>Raise on assignment to readonly attributes</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_attr_readonly'>attr_readonly</span> <span class='symbeg'>:</span><span class='id identifier rubyid_content'>content</span>
<span class='kw'>end</span>
<span class='const'>Post</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>content:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cannot be updated</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_content'>content</span> <span class='comment'># &quot;cannot be updated&quot;
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_content'>content</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>something else</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># =&gt; ActiveRecord::ReadonlyAttributeError</span></code></pre>

<p>Previously, assignment would succeed but silently not write to the database.</p>

<p>This behavior can be controlled by configuration:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_raise_on_assign_to_attr_readonly'>raise_on_assign_to_attr_readonly</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>and will be enabled by default with <code>config.load_defaults 7.1</code>.</p>

<p><em>Alex Ghiculescu</em>, <em>Hartley McGuire</em></p></li>
<li><p>Allow unscoping of preload and eager_load associations</p>

<p>Added the ability to unscope preload and eager_load associations just like
includes, joins, etc. See ActiveRecord::QueryMethods::VALID_UNSCOPING_VALUES
for the full list of supported unscopable scopes.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_query'>query</span>.<span class='id identifier rubyid_unscope'>unscope</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_eager_load'>eager_load</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_preload'>preload</span>).<span class='id identifier rubyid_group'>group</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>).<span class='id identifier rubyid_select'>select</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>)</code></pre>

<p><em>David Morehouse</em></p></li>
<li><p>Add automatic filtering of encrypted attributes on inspect</p>

<p>This feature is enabled by default but can be disabled with</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_encryption'>encryption</span>.<span class='id identifier rubyid_add_to_filter_parameters'>add_to_filter_parameters</span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>

<p><em>Hartley McGuire</em></p></li>
<li><p>Clear locking column on #dup</p>

<p>This change fixes not to duplicate locking_column like id and timestamps.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_car'>car</span> <span class='op'>=</span> <span class='const'>Car</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_car'>car</span>.<span class='id identifier rubyid_touch'>touch</span>
<span class='id identifier rubyid_car'>car</span>.<span class='id identifier rubyid_lock_version'>lock_version</span> <span class='comment'>#=&gt; 1
</span><span class='id identifier rubyid_car'>car</span>.<span class='id identifier rubyid_dup'>dup</span>.<span class='id identifier rubyid_lock_version'>lock_version</span> <span class='comment'>#=&gt; 0</span></code></pre>

<p><em>Shouichi Kamiya</em>, <em>Seonggi Yang</em>, <em>Ryohei UEDA</em></p></li>
<li><p>Invalidate transaction as early as possible</p>

<p>After rescuing a <code>TransactionRollbackError</code> exception Rails invalidates transactions earlier in the flow
allowing the framework to skip issuing the <code>ROLLBACK</code> statement in more cases.
Only affects adapters that have <code>savepoint_errors_invalidate_transactions?</code> configured as <code>true</code>,
which at this point is only applicable to the <code>mysql2</code> adapter.</p>

<p><em>Nikita Vasilevsky</em></p></li>
<li><p>Allow configuring columns list to be used in SQL queries issued by an <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> object</p>

<p>It is now possible to configure columns list that will be used to build an SQL query clauses when
updating, deleting or reloading an <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> object</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Developer</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_query_constraints'>query_constraints</span> <span class='symbeg'>:</span><span class='id identifier rubyid_company_id'>company_id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_developer'>developer</span> <span class='op'>=</span> <span class='const'>Developer</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_update'>update</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Bob</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># =&gt; UPDATE &quot;developers&quot; SET &quot;name&quot; = &#39;Bob&#39; WHERE &quot;developers&quot;.&quot;company_id&quot; = 1 AND &quot;developers&quot;.&quot;id&quot; = 1</span></code></pre>

<p><em>Nikita Vasilevsky</em></p></li>
<li><p>Adds <code>validate</code> to foreign keys and check constraints in schema.rb</p>

<p>Previously, <code>schema.rb</code> would not record if <code>validate: false</code> had been used when adding a foreign key or check
constraint, so restoring a database from the schema could result in foreign keys or check constraints being
incorrectly validated.</p>

<p><em>Tommy Graves</em></p></li>
<li><p>Adapter <code>#execute</code> methods now accept an <code>allow_retry</code> option. When set to <code>true</code>, the SQL statement will be
retried, up to the database&#39;s configured <code>connection_retries</code> value, upon encountering connection-related errors.</p>

<p><em>Adrianna Chang</em></p></li>
<li><p>Only trigger <code>after_commit :destroy</code> callbacks when a database row is deleted.</p>

<p>This prevents <code>after_commit :destroy</code> callbacks from being triggered again
when <code>destroy</code> is called multiple times on the same record.</p>

<p><em>Ben Sheldon</em></p></li>
<li><p>Fix <code>ciphertext_for</code> for yet-to-be-encrypted values.</p>

<p>Previously, <code>ciphertext_for</code> returned the cleartext of values that had not
yet been encrypted, such as with an unpersisted record:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_body'>body</span>

<span class='id identifier rubyid_post'>post</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>body:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_ciphertext_for'>ciphertext_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_body'>body</span>)
<span class='comment'># =&gt; &quot;{\&quot;p\&quot;:\&quot;abc...&quot;
</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>World</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_ciphertext_for'>ciphertext_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_body'>body</span>)
<span class='comment'># =&gt; &quot;World&quot;</span></code></pre>

<p>Now, <code>ciphertext_for</code> will always return the ciphertext of encrypted
attributes:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_body'>body</span>

<span class='id identifier rubyid_post'>post</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>body:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_ciphertext_for'>ciphertext_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_body'>body</span>)
<span class='comment'># =&gt; &quot;{\&quot;p\&quot;:\&quot;abc...&quot;
</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>World</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_ciphertext_for'>ciphertext_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_body'>body</span>)
<span class='comment'># =&gt; &quot;{\&quot;p\&quot;:\&quot;xyz...&quot;</span></code></pre>

<p><em>Jonathan Hefner</em></p></li>
<li><p>Fix a bug where using groups and counts with long table names would return incorrect results.</p>

<p><em>Shota Toguchi</em>, <em>Yusaku Ono</em></p></li>
<li><p>Fix encryption of column default values.</p>

<p>Previously, encrypted attributes that used column default values appeared to
be encrypted on create, but were not:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Book</span>.<span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>

<span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Book</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_book'>book</span>.<span class='id identifier rubyid_name'>name</span>
<span class='comment'># =&gt; &quot;&lt;untitled&gt;&quot;
</span><span class='id identifier rubyid_book'>book</span>.<span class='id identifier rubyid_name_before_type_cast'>name_before_type_cast</span>
<span class='comment'># =&gt; &quot;{\&quot;p\&quot;:\&quot;abc...&quot;
</span><span class='id identifier rubyid_book'>book</span>.<span class='id identifier rubyid_reload'>reload</span>.<span class='id identifier rubyid_name_before_type_cast'>name_before_type_cast</span>
<span class='comment'># =&gt; &quot;&lt;untitled&gt;&quot;</span></code></pre>

<p>Now, attributes with column default values are encrypted:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Book</span>.<span class='id identifier rubyid_encrypts'>encrypts</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>

<span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Book</span>.<span class='id identifier rubyid_create!'>create!</span>
<span class='id identifier rubyid_book'>book</span>.<span class='id identifier rubyid_name'>name</span>
<span class='comment'># =&gt; &quot;&lt;untitled&gt;&quot;
</span><span class='id identifier rubyid_book'>book</span>.<span class='id identifier rubyid_name_before_type_cast'>name_before_type_cast</span>
<span class='comment'># =&gt; &quot;{\&quot;p\&quot;:\&quot;abc...&quot;
</span><span class='id identifier rubyid_book'>book</span>.<span class='id identifier rubyid_reload'>reload</span>.<span class='id identifier rubyid_name_before_type_cast'>name_before_type_cast</span>
<span class='comment'># =&gt; &quot;{\&quot;p\&quot;:\&quot;abc...&quot;</span></code></pre>

<p><em>Jonathan Hefner</em></p></li>
<li><p>Deprecate delegation from {Base} to <code>connection_handler</code>.</p>

<p>Calling {Base.clear_all_connections!}, {Base.clear_active_connections!}, {Base.clear_reloadable_connections!} and {Base.flush_idle_connections!} is deprecated. Please call these methods on the connection handler directly. In future Rails versions, the delegation from {Base} to the <code>connection_handler</code> will be removed.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Allow ActiveRecord::QueryMethods#reselect to receive hash values, similar to ActiveRecord::QueryMethods#select</p>

<p><em>Sampat Badhe</em></p></li>
<li><p>Validate options when managing columns and tables in migrations.</p>

<p>If an invalid option is passed to a migration method like <code>create_table</code> and <code>add_column</code>, an error will be raised
instead of the option being silently ignored. Validation of the options will only be applied for new migrations
that are created.</p>

<p><em>Guo Xiang Tan</em>, <em>George Wambold</em></p></li>
<li><p>Update query log tags to use the <a href="https://open-telemetry.github.io/opentelemetry-sqlcommenter/">SQLCommenter</a> format by default. See <a href="https://github.com/rails/rails/issues/46179">#46179</a></p>

<p>To opt out of SQLCommenter-formatted query log tags, set <code>config.active_record.query_log_tags_format = :legacy</code>. By default, this is set to <code>:sqlcommenter</code>.</p>

<p><em>Modulitos</em> and <em>Iheanyi</em></p></li>
<li><p>Allow any {ERB} in the database.yml when creating rake tasks.</p>

<p>Any ERB can be used in <code>database.yml</code> even if it accesses environment
configurations.</p>

<p>Deprecates <code>config.active_record.suppress_multiple_database_warning</code>.</p>

<p><em>Eike Send</em></p></li>
<li><p>Add table to error for duplicate column definitions.</p>

<p>If a migration defines duplicate columns for a table, the error message
shows which table it concerns.</p>

<p><em>Petrik de Heus</em></p></li>
<li><p>Fix erroneous nil default precision on virtual datetime columns.</p>

<p>Prior to this change, virtual datetime columns did not have the same
default precision as regular datetime columns, resulting in the following
being erroneously equivalent:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_virtual'>virtual</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='id identifier rubyid_datetime'>datetime</span><span class='comma'>,</span>                 <span class='label'>as:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>expression</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_virtual'>virtual</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='id identifier rubyid_datetime'>datetime</span><span class='comma'>,</span> <span class='label'>precision:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>expression</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>This change fixes the default precision lookup, so virtual and regular
datetime column default precisions match.</p>

<p><em>Sam Bostock</em></p></li>
<li><p>Use connection from <code>#with_raw_connection</code> in <code>#quote_string</code>.</p>

<p>This ensures that the string quoting is wrapped in the reconnect and retry logic
that <code>#with_raw_connection</code> offers.</p>

<p><em>Adrianna Chang</em></p></li>
<li><p>Add <code>expires_at</code> option to <code>signed_id</code>.</p>

<p><em>Shouichi Kamiya</em></p></li>
<li><p>Allow applications to set retry deadline for query retries.</p>

<p>Building on the work done in #44576 and #44591, we extend the logic that automatically
reconnects database connections to take into account a timeout limit. We won&#39;t retry
a query if a given amount of time has elapsed since the query was first attempted. This
value defaults to nil, meaning that all retryable queries are retried regardless of time elapsed,
but this can be changed via the <code>retry_deadline</code> option in the database config.</p>

<p><em>Adrianna Chang</em></p></li>
<li><p>Fix a case where the query cache can return wrong values. See #46044</p>

<p><em>Aaron Patterson</em></p></li>
<li><p>Support MySQL&#39;s ssl-mode option for MySQLDatabaseTasks.</p>

<p>Verifying the identity of the database server requires setting the ssl-mode
option to VERIFY_CA or VERIFY_IDENTITY. This option was previously ignored
for MySQL database tasks like creating a database and dumping the structure.</p>

<p><em>Petrik de Heus</em></p></li>
<li><p>Move {ActiveRecord::InternalMetadata} to an independent object.</p>

<p>{ActiveRecord::InternalMetadata} no longer inherits from {ActiveRecord::Base} and is now an independent object that should be instantiated with a <code>connection</code>. This class is private and should not be used by applications directly. If you want to interact with the schema migrations table, please access it on the connection directly, for example: {ActiveRecord::Base.connection.schema_migration}.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Deprecate quoting {ActiveSupport::Duration} as an integer</p>

<p>Using ActiveSupport::Duration as an interpolated bind parameter in a SQL
string template is deprecated. To avoid this warning, you should explicitly
convert the duration to a more specific database type. For example, if you
want to use a duration as an integer number of seconds:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Record</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>duration = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>1</span>.<span class='id identifier rubyid_hour'>hour</span>.<span class='id identifier rubyid_to_i'>to_i</span>)</code></pre>

<p>If you want to use a duration as an ISO 8601 string:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Record</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>duration = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>1</span>.<span class='id identifier rubyid_hour'>hour</span>.<span class='id identifier rubyid_iso8601'>iso8601</span>)</code></pre>

<p><em>Aram Greenman</em></p></li>
<li><p>Allow {QueryMethods#in_order_of} to order by a string column name.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_in_order_of'>in_order_of</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> [<span class='int'>4</span><span class='comma'>,</span><span class='int'>2</span><span class='comma'>,</span><span class='int'>3</span><span class='comma'>,</span><span class='int'>1</span>]).<span class='id identifier rubyid_to_a'>to_a</span>
<span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>).<span class='id identifier rubyid_in_order_of'>in_order_of</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>authors.name</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> [<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Bob</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Anna</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John</span><span class='tstring_end'>&quot;</span></span>]).<span class='id identifier rubyid_to_a'>to_a</span></code></pre>

<p><em>Igor Kasyanchuk</em></p></li>
<li><p>Move {ActiveRecord::SchemaMigration} to an independent object.</p>

<p>{ActiveRecord::SchemaMigration} no longer inherits from {ActiveRecord::Base} and is now an independent object that should be instantiated with a <code>connection</code>. This class is private and should not be used by applications directly. If you want to interact with the schema migrations table, please access it on the connection directly, for example: {ActiveRecord::Base.connection.schema_migration}.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Deprecate <code>all_connection_pools</code> and make <code>connection_pool_list</code> more explicit.</p>

<p>Following on #45924 <code>all_connection_pools</code> is now deprecated. <code>connection_pool_list</code> will either take an explicit role or applications can opt into the new behavior by passing <code>:all</code>.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Fix connection handler methods to operate on all pools.</p>

<p><code>active_connections?</code>, <code>clear_active_connections!</code>, <code>clear_reloadable_connections!</code>, <code>clear_all_connections!</code>, and <code>flush_idle_connections!</code> now operate on all pools by default. Previously they would default to using the <code>current_role</code> or <code>:writing</code> role unless specified.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Allow ActiveRecord::QueryMethods#select to receive hash values.</p>

<p>Currently, <code>select</code> might receive only raw sql and symbols to define columns and aliases to select.</p>

<p>With this change we can provide <code>hash</code> as argument, for example:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>).<span class='id identifier rubyid_select'>select</span>(<span class='label'>posts:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_created_at'>created_at</span>]<span class='comma'>,</span> <span class='label'>comments:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_author_id'>author_id</span>])
<span class='comment'>#=&gt; &quot;SELECT \&quot;posts\&quot;.\&quot;id\&quot;, \&quot;posts\&quot;.\&quot;title\&quot;, \&quot;posts\&quot;.\&quot;created_at\&quot;, \&quot;comments\&quot;.\&quot;id\&quot;, \&quot;comments\&quot;.\&quot;body\&quot;, \&quot;comments\&quot;.\&quot;author_id\&quot;
</span><span class='comment'>#   FROM \&quot;posts\&quot; INNER JOIN \&quot;comments\&quot; ON \&quot;comments\&quot;.\&quot;post_id\&quot; = \&quot;posts\&quot;.\&quot;id\&quot;&quot;
</span>
<span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>).<span class='id identifier rubyid_select'>select</span>(<span class='label'>posts:</span> { <span class='label'>id:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post_id'>post_id</span><span class='comma'>,</span> <span class='label'>title:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post_title'>post_title</span> }<span class='comma'>,</span> <span class='label'>comments:</span> { <span class='label'>id:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comment_id'>comment_id</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comment_body'>comment_body</span> })
<span class='comment'>#=&gt; &quot;SELECT posts.id as post_id, posts.title as post_title, comments.id as comment_id, comments.body as comment_body
</span><span class='comment'>#    FROM \&quot;posts\&quot; INNER JOIN \&quot;comments\&quot; ON \&quot;comments\&quot;.\&quot;post_id\&quot; = \&quot;posts\&quot;.\&quot;id\&quot;&quot;</span></code></pre>

<p><em>Oleksandr Holubenko</em>, <em>Josef Šimánek</em>, <em>Jean Boussier</em></p></li>
<li><p>Adapts virtual attributes on {ActiveRecord::Persistence#becomes}.</p>

<p>When source and target classes have a different set of attributes adapts
attributes such that the extra attributes from target are added.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>WebUser</span> <span class='op'>&lt;</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_attribute'>attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_is_admin'>is_admin</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_boolean'>boolean</span>
  <span class='id identifier rubyid_after_initialize'>after_initialize</span> <span class='symbeg'>:</span><span class='id identifier rubyid_set_admin'>set_admin</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_set_admin'>set_admin</span>
    <span class='id identifier rubyid_write_attribute'>write_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_is_admin'>is_admin</span><span class='comma'>,</span> <span class='id identifier rubyid_email'>email</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>@ourcompany\.com$</span><span class='regexp_end'>/</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>email@ourcompany.com</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_respond_to?'>respond_to?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_is_admin'>is_admin</span>
<span class='comment'># =&gt; false
</span><span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_becomes'>becomes</span>(<span class='const'>WebUser</span>).<span class='id identifier rubyid_is_admin?'>is_admin?</span>
<span class='comment'># =&gt; true</span></code></pre>

<p><em>Jacopo Beschi</em>, <em>Sampson Crowley</em></p></li>
<li><p>Fix {ActiveRecord::QueryMethods#in_order_of} to include <code>nil</code>s, to match the
behavior of {Enumerable#in_order_of}.</p>

<p>For example, <code>Post.in_order_of(:title, [nil, &quot;foo&quot;])</code> will now include posts
with <code>nil</code> titles, the same as <code>Post.all.to_a.in_order_of(:title, [nil, &quot;foo&quot;])</code>.</p>

<p><em>fatkodima</em></p></li>
<li><p>Optimize <code>add_timestamps</code> to use a single SQL statement.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_timestamps'>add_timestamps</span> <span class='symbeg'>:</span><span class='id identifier rubyid_my_table'>my_table</span></code></pre>

<p>Now results in the following SQL:</p>

<pre class="code sql"><code class="sql">ALTER TABLE &quot;my_table&quot; ADD COLUMN &quot;created_at&quot; datetime(6) NOT NULL, ADD COLUMN &quot;updated_at&quot; datetime(6) NOT NULL
</code></pre>

<p><em>Iliana Hadzhiatanasova</em></p></li>
<li><p>Add <code>drop_enum</code> migration command for PostgreSQL</p>

<p>This does the inverse of <code>create_enum</code>. Before dropping an enum, ensure you have
dropped columns that depend on it.</p>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Adds support for <code>if_exists</code> option when removing a check constraint.</p>

<p>The <code>remove_check_constraint</code> method now accepts an <code>if_exists</code> option. If set
to true an error won&#39;t be raised if the check constraint doesn&#39;t exist.</p>

<p><em>Margaret Parsa</em> and <em>Aditya Bhutani</em></p></li>
<li><p><code>find_or_create_by</code> now try to find a second time if it hits a unicity constraint.</p>

<p><code>find_or_create_by</code> always has been inherently racy, either creating multiple
duplicate records or failing with {ActiveRecord::RecordNotUnique} depending on
whether a proper unicity constraint was set.</p>

<p><code>create_or_find_by</code> was introduced for this use case, however it&#39;s quite wasteful
when the record is expected to exist most of the time, as INSERT require to send
more data than SELECT and require more work from the database. Also on some
databases it can actually consume a primary key increment which is undesirable.</p>

<p>So for case where most of the time the record is expected to exist, <code>find_or_create_by</code>
can be made race-condition free by re-trying the <code>find</code> if the <code>create</code> failed
with {ActiveRecord::RecordNotUnique}. This assumes that the table has the proper
unicity constraints, if not, <code>find_or_create_by</code> will still lead to duplicated records.</p>

<p><em>Jean Boussier</em>, <em>Alex Kitchens</em></p></li>
<li><p>Introduce a simpler constructor API for {ActiveRecord} database adapters.</p>

<p>Previously the adapter had to know how to build a new raw connection to
support reconnect, but also expected to be passed an initial already-
established connection.</p>

<p>When manually creating an adapter instance, it will now accept a single
config hash, and only establish the real connection on demand.</p>

<p><em>Matthew Draper</em></p></li>
<li><p>Avoid redundant <code>SELECT 1</code> connection-validation query during DB pool
checkout when possible.</p>

<p>If the first query run during a request is known to be idempotent, it can be
used directly to validate the connection, saving a network round-trip.</p>

<p><em>Matthew Draper</em></p></li>
<li><p>Automatically reconnect broken database connections when safe, even
mid-request.</p>

<p>When an error occurs while attempting to run a known-idempotent query, and
not inside a transaction, it is safe to immediately reconnect to the
database server and try again, so this is now the default behavior.</p>

<p>This new default should always be safe -- to support that, it&#39;s consciously
conservative about which queries are considered idempotent -- but if
necessary it can be disabled by setting the <code>connection_retries</code> connection
option to <code>0</code>.</p>

<p><em>Matthew Draper</em></p></li>
<li><p>Avoid removing a PostgreSQL extension when there are dependent objects.</p>

<p>Previously, removing an extension also implicitly removed dependent objects. Now, this will raise an error.</p>

<p>You can force removing the extension:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_disable_extension'>disable_extension</span> <span class='symbeg'>:</span><span class='id identifier rubyid_citext'>citext</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cascade'>cascade</span></code></pre>

<p>Fixes #29091.</p>

<p><em>fatkodima</em></p></li>
<li><p>Allow nested functions as safe SQL string</p>

<p><em>Michael Siegfried</em></p></li>
<li><p>Allow <code>destroy_association_async_job=</code> to be configured with a class string instead of a constant.</p>

<p>Defers an autoloading dependency between {ActiveRecord::Base} and {ActiveJob::Base}
and moves the configuration of {ActiveRecord::DestroyAssociationAsyncJob}
from ActiveJob to ActiveRecord.</p>

<p>Deprecates {ActiveRecord::ActiveJobRequiredError} and now raises a {NameError}
if the job class is unloadable or an {ActiveRecord::ConfigurationError} if
<code>dependent: :destroy_async</code> is declared on an association but there is no job
class configured.</p>

<p><em>Ben Sheldon</em></p></li>
<li><p>Fix {ActiveRecord::Store} to serialize as a regular {Hash}</p>

<p>Previously it would serialize as an {ActiveSupport::HashWithIndifferentAccess}
which is wasteful and cause problem with YAML safe_load.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Add <code>timestamptz</code> as a time zone aware type for PostgreSQL</p>

<p>This is required for correctly parsing <code>timestamp with time zone</code> values in your database.</p>

<p>If you don&#39;t want this, you can opt out by adding this initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_time_zone_aware_types'>time_zone_aware_types</span> <span class='op'>-=</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_timestamptz'>timestamptz</span>]</code></pre>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Add new {ActiveRecord::Base.generates_token_for} API.</p>

<p>Currently, <code>signed_id</code> fulfills the role of generating tokens for e.g.
resetting a password.  However, signed IDs cannot reflect record state, so
if a token is intended to be single-use, it must be tracked in a database at
least until it expires.</p>

<p>With <code>generates_token_for</code>, a token can embed data from a record.  When
using the token to fetch the record, the data from the token and the current
data from the record will be compared.  If the two do not match, the token
will be treated as invalid, the same as if it had expired.  For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_secure_password'>has_secure_password</span>

  <span class='id identifier rubyid_generates_token_for'>generates_token_for</span> <span class='symbeg'>:</span><span class='id identifier rubyid_password_reset'>password_reset</span><span class='comma'>,</span> <span class='label'>expires_in:</span> <span class='int'>15</span>.<span class='id identifier rubyid_minutes'>minutes</span> <span class='kw'>do</span>
    <span class='comment'># A password&#39;s BCrypt salt changes when the password is updated.
</span>    <span class='comment'># By embedding (part of) the salt in a token, the token will
</span>    <span class='comment'># expire when the password is updated.
</span>    <span class='const'>BCrypt</span><span class='op'>::</span><span class='const'>Password</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_password_digest'>password_digest</span>).<span class='id identifier rubyid_salt'>salt</span>[<span class='op'>-</span><span class='int'>10</span><span class='op'>..</span>]
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_token'>token</span> <span class='op'>=</span> <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_generate_token_for'>generate_token_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_password_reset'>password_reset</span>)

<span class='const'>User</span>.<span class='id identifier rubyid_find_by_token_for'>find_by_token_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_password_reset'>password_reset</span><span class='comma'>,</span> <span class='id identifier rubyid_token'>token</span>) <span class='comment'># =&gt; user
</span>
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_update!'>update!</span>(<span class='label'>password:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new password</span><span class='tstring_end'>&quot;</span></span>)
<span class='const'>User</span>.<span class='id identifier rubyid_find_by_token_for'>find_by_token_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_password_reset'>password_reset</span><span class='comma'>,</span> <span class='id identifier rubyid_token'>token</span>) <span class='comment'># =&gt; nil</span></code></pre>

<p><em>Jonathan Hefner</em></p></li>
<li><p>Optimize Active Record batching for whole table iterations.</p>

<p>Previously, <code>in_batches</code> got all the ids and constructed an {IN}-based query for each batch.
When iterating over the whole tables, this approach is not optimal as it loads unneeded ids and
{IN} queries with lots of items are slow.</p>

<p>Now, whole table iterations use range iteration (<code>id &gt;= x AND id &lt;= y</code>) by default which can make iteration
several times faster. E.g., tested on a PostgreSQL table with 10 million records: querying (<code>253s</code> vs <code>30s</code>),
updating (<code>288s</code> vs <code>124s</code>), deleting (<code>268s</code> vs <code>83s</code>).</p>

<p>Only whole table iterations use this style of iteration by default. You can disable this behavior by passing <code>use_ranges: false</code>.
If you iterate over the table and the only condition is, e.g., <code>archived_at: nil</code> (and only a tiny fraction
of the records are archived), it makes sense to opt in to this approach:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Project</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>archived_at:</span> <span class='kw'>nil</span>).<span class='id identifier rubyid_in_batches'>in_batches</span>(<span class='label'>use_ranges:</span> <span class='kw'>true</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_relation'>relation</span><span class='op'>|</span>
  <span class='comment'># do something
</span><span class='kw'>end</span></code></pre>

<p>See #45414 for more details.</p>

<p><em>fatkodima</em></p></li>
<li><p><code>.with</code> query method added. Construct common table expressions with ease and get {ActiveRecord::Relation} back.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>posts_with_comments:</span> <span class='const'>Post</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>comments_count &gt; ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span>))
<span class='comment'># =&gt; ActiveRecord::Relation
</span><span class='comment'># WITH posts_with_comments AS (SELECT * FROM posts WHERE (comments_count &gt; 0)) SELECT * FROM posts</span></code></pre>

<p><em>Vlado Cingel</em></p></li>
<li><p>Don&#39;t establish a new connection if an identical pool exists already.</p>

<p>Previously, if <code>establish_connection</code> was called on a class that already had an established connection, the existing connection would be removed regardless of whether it was the same config. Now if a pool is found with the same values as the new connection, the existing connection will be returned instead of creating a new one.</p>

<p>This has a slight change in behavior if application code is depending on a new connection being established regardless of whether it&#39;s identical to an existing connection. If the old behavior is desirable, applications should call {ActiveRecord::Base#remove_connection} before establishing a new one. Calling <code>establish_connection</code> with a different config works the same way as it did previously.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Update <code>db:prepare</code> task to load schema when an uninitialized database exists, and dump schema after migrations.</p>

<p><em>Ben Sheldon</em></p></li>
<li><p>Fix supporting timezone awareness for <code>tsrange</code> and <code>tstzrange</code> array columns.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># In database migrations
</span><span class='id identifier rubyid_add_column'>add_column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_shops'>shops</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_open_hours'>open_hours</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tsrange'>tsrange</span><span class='comma'>,</span> <span class='label'>array:</span> <span class='kw'>true</span>
<span class='comment'># In app config
</span><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_time_zone_aware_types'>time_zone_aware_types</span> <span class='op'>+=</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_tsrange'>tsrange</span>]
<span class='comment'># In the code times are properly converted to app time zone
</span><span class='const'>Shop</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>open_hours:</span> [<span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_current'><a href="Time.html#current-class_method" title="Time.current (method)">current</a></span><span class='op'>..</span><span class='int'>8</span>.<span class='id identifier rubyid_hour'>hour</span>.<span class='id identifier rubyid_from_now'>from_now</span>])</code></pre>

<p><em>Wojciech Wnętrzak</em></p></li>
<li><p>Introduce strategy pattern for executing migrations.</p>

<p>By default, migrations will use a strategy object that delegates the method
to the connection adapter. Consumers can implement custom strategy objects
to change how their migrations run.</p>

<p><em>Adrianna Chang</em></p></li>
<li><p>Add adapter option disallowing foreign keys</p>

<p>This adds a new option to be added to <code>database.yml</code> which enables skipping
foreign key constraints usage even if the underlying database supports them.</p>

<p>Usage:</p>

<pre class="code yaml"><code class="yaml">development:
    &lt;&lt;: *default
    database: storage/development.sqlite3
    foreign_keys: false
</code></pre>

<p><em>Paulo Barros</em></p></li>
<li><p>Add configurable deprecation warning for singular associations</p>

<p>This adds a deprecation warning when using the plural name of a singular associations in <code>where</code>.
It is possible to opt into the new more performant behavior with <code>config.active_record.allow_deprecated_singular_associations_name = false</code></p>

<p><em>Adam Hess</em></p></li>
<li><p>Run transactional callbacks on the freshest instance to save a given
record within a transaction.</p>

<p>When multiple Active Record instances change the same record within a
transaction, Rails runs <code>after_commit</code> or <code>after_rollback</code> callbacks for
only one of them. <code>config.active_record.run_commit_callbacks_on_first_saved_instances_in_transaction</code>
was added to specify how Rails chooses which instance receives the
callbacks. The framework defaults were changed to use the new logic.</p>

<p>When <code>config.active_record.run_commit_callbacks_on_first_saved_instances_in_transaction</code>
is <code>true</code>, transactional callbacks are run on the first instance to save,
even though its instance state may be stale.</p>

<p>When it is <code>false</code>, which is the new framework default starting with version
7.1, transactional callbacks are run on the instances with the freshest
instance state. Those instances are chosen as follows:</p>

<ul>
<li>In general, run transactional callbacks on the last instance to save a
given record within the transaction.</li>
<li>There are two exceptions:

<ul>
<li>If the record is created within the transaction, then updated by
another instance, <code>after_create_commit</code> callbacks will be run on the
second instance. This is instead of the <code>after_update_commit</code>
callbacks that would naively be run based on that instance’s state.</li>
<li>If the record is destroyed within the transaction, then
<code>after_destroy_commit</code> callbacks will be fired on the last destroyed
instance, even if a stale instance subsequently performed an update
(which will have affected 0 rows).</li>
</ul></li>
</ul>

<p><em>Cameron Bothner and Mitch Vollebregt</em></p></li>
<li><p>Enable strict strings mode for {SQLite3Adapter}.</p>

<p>Configures SQLite with a strict strings mode, which disables double-quoted string literals.</p>

<p>SQLite has some quirks around double-quoted string literals.
It first tries to consider double-quoted strings as identifier names, but if they don&#39;t exist
it then considers them as string literals. Because of this, typos can silently go unnoticed.
For example, it is possible to create an index for a non existing column.
See <a href="https://www.sqlite.org/quirks.html#double_quoted_string_literals_are_accepted">SQLite documentation</a> for more details.</p>

<p>If you don&#39;t want this behavior, you can disable it via:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/application.rb
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_sqlite3_adapter_strict_strings_by_default'>sqlite3_adapter_strict_strings_by_default</span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>

<p>Fixes #27782.</p>

<p><em>fatkodima</em>, <em>Jean Boussier</em></p></li>
<li><p>Resolve issue where a relation cache_version could be left stale.</p>

<p>Previously, when <code>reset</code> was called on a relation object it did not reset the cache_versions
ivar. This led to a confusing situation where despite having the correct data the relation
still reported a stale cache_version.</p>

<p>Usage:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_developers'>developers</span> <span class='op'>=</span> <span class='const'>Developer</span>.<span class='id identifier rubyid_all'>all</span>
<span class='id identifier rubyid_developers'>developers</span>.<span class='id identifier rubyid_cache_version'>cache_version</span>

<span class='const'>Developer</span>.<span class='id identifier rubyid_update_all'>update_all</span>(<span class='label'>updated_at:</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span>.<span class='id identifier rubyid_utc'>utc</span> <span class='op'>+</span> <span class='int'>1</span>.<span class='id identifier rubyid_second'>second</span>)

<span class='id identifier rubyid_developers'>developers</span>.<span class='id identifier rubyid_cache_version'>cache_version</span> <span class='comment'># Stale cache_version
</span><span class='id identifier rubyid_developers'>developers</span>.<span class='id identifier rubyid_reset'>reset</span>
<span class='id identifier rubyid_developers'>developers</span>.<span class='id identifier rubyid_cache_version'>cache_version</span> <span class='comment'># Returns the current correct cache_version</span></code></pre>

<p>Fixes #45341.</p>

<p><em>Austen Madden</em></p></li>
<li><p>Add support for exclusion constraints (PostgreSQL-only).</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_exclusion_constraint'>add_exclusion_constraint</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invoices'>invoices</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>daterange(start_date, end_date) WITH &amp;&amp;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>using:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gist'>gist</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>invoices_date_overlap</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_remove_exclusion_constraint'>remove_exclusion_constraint</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invoices'>invoices</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>invoices_date_overlap</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>See PostgreSQL&#39;s <a href="https://www.postgresql.org/docs/12/sql-createtable.html#SQL-CREATETABLE-EXCLUDE"><code>CREATE TABLE ... EXCLUDE ...</code></a> documentation for more on exclusion constraints.</p>

<p><em>Alex Robbin</em></p></li>
<li><p><code>change_column_null</code> raises if a non-boolean argument is provided</p>

<p>Previously if you provided a non-boolean argument, <code>change_column_null</code> would
treat it as truthy and make your column nullable. This could be surprising, so now
the input must be either <code>true</code> or <code>false</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_change_column_null'>change_column_null</span> <span class='symbeg'>:</span><span class='id identifier rubyid_table'>table</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_column'>column</span><span class='comma'>,</span> <span class='kw'>true</span> <span class='comment'># good
</span><span class='id identifier rubyid_change_column_null'>change_column_null</span> <span class='symbeg'>:</span><span class='id identifier rubyid_table'>table</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_column'>column</span><span class='comma'>,</span> <span class='kw'>false</span> <span class='comment'># good
</span><span class='id identifier rubyid_change_column_null'>change_column_null</span> <span class='symbeg'>:</span><span class='id identifier rubyid_table'>table</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_column'>column</span><span class='comma'>,</span> <span class='label'>from:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>to:</span> <span class='kw'>false</span> <span class='comment'># raises (previously this made the column nullable)</span></code></pre>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Enforce limit on table names length.</p>

<p>Fixes #45130.</p>

<p><em>fatkodima</em></p></li>
<li><p>Adjust the minimum MariaDB version for check constraints support.</p>

<p><em>Eddie Lebow</em></p></li>
<li><p>Fix Hstore deserialize regression.</p>

<p><em>edsharp</em></p></li>
<li><p>Add validity for PostgreSQL indexes.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_index_exists?'>index_exists?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>valid:</span> <span class='kw'>true</span>)
<span class='id identifier rubyid_connection'>connection</span>.<span class='id identifier rubyid_indexes'>indexes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span>).<span class='id identifier rubyid_select'>select</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_valid?'>valid?</span>)</code></pre>

<p><em>fatkodima</em></p></li>
<li><p>Fix eager loading for models without primary keys.</p>

<p><em>Anmol Chopra</em>, <em>Matt Lawrence</em>, and <em>Jonathan Hefner</em></p></li>
<li><p>Avoid validating a unique field if it has not changed and is backed by a unique index.</p>

<p>Previously, when saving a record, Active Record will perform an extra query to check for the
uniqueness of each attribute having a <code>uniqueness</code> validation, even if that attribute hasn&#39;t changed.
If the database has the corresponding unique index, then this validation can never fail for persisted
records, and we could safely skip it.</p>

<p><em>fatkodima</em></p></li>
<li><p>Stop setting <code>sql_auto_is_null</code></p>

<p>Since version 5.5 the default has been off, we no longer have to manually turn it off.</p>

<p><em>Adam Hess</em></p></li>
<li><p>Fix <code>touch</code> to raise an error for readonly columns.</p>

<p><em>fatkodima</em></p></li>
<li><p>Add ability to ignore tables by regexp for SQL schema dumps.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/SchemaDumper.html" title="ActiveRecord::SchemaDumper (class)">SchemaDumper</a></span>.<span class='id identifier rubyid_ignore_tables'><a href="ActiveRecord/SchemaDumper.html#ignore_tables-class_method" title="ActiveRecord::SchemaDumper.ignore_tables (method)">ignore_tables</a></span> <span class='op'>=</span> [<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^_</span><span class='regexp_end'>/</span></span>]</code></pre>

<p><em>fatkodima</em></p></li>
<li><p>Avoid queries when performing calculations on contradictory relations.</p>

<p>Previously calculations would make a query even when passed a
contradiction, such as <code>User.where(id: []).count</code>. We no longer perform a
query in that scenario.</p>

<p>This applies to the following calculations: <code>count</code>, <code>sum</code>, <code>average</code>,
<code>minimum</code> and <code>maximum</code></p>

<p><em>Luan Vieira, John Hawthorn and Daniel Colson</em></p></li>
<li><p>Allow using aliased attributes with <code>insert_all</code>/<code>upsert_all</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_alias_attribute'>alias_attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>
<span class='kw'>end</span>

<span class='const'>Book</span>.<span class='id identifier rubyid_insert_all'>insert_all</span> [{ <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Remote</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>author_id:</span> <span class='int'>1</span> }]<span class='comma'>,</span> <span class='label'>returning:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span></code></pre>

<p><em>fatkodima</em></p></li>
<li><p>Support encrypted attributes on columns with default db values.</p>

<p>This adds support for encrypted attributes defined on columns with default values.
It will encrypt those values at creation time. Before, it would raise an
error unless <code>config.active_record.encryption.support_unencrypted_data</code> was true.</p>

<p><em>Jorge Manrubia</em> and <em>Dima Fatko</em></p></li>
<li><p>Allow overriding <code>reading_request?</code> in {DatabaseSelector::Resolver}</p>

<p>The default implementation checks if a request is a <code>get?</code> or <code>head?</code>,
but you can now change it to anything you like. If the method returns true,
{Resolver#read} gets called meaning the request could be served by the
replica database.</p>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Remove {ActiveRecord.legacy_connection_handling}.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p><code>rails db:schema:{dump,load}</code> now checks {ENV[&quot;SCHEMA_FORMAT&quot;]} before config</p>

<p>Since <code>rails db:structure:{dump,load}</code> was deprecated there wasn&#39;t a simple
way to dump a schema to both SQL and Ruby formats. You can now do this with
an environment variable. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>SCHEMA_FORMAT</span><span class='op'>=</span><span class='id identifier rubyid_sql'>sql</span> <span class='id identifier rubyid_rake'>rake</span> <span class='label'>db:</span><span class='label'>schema:</span><span class='id identifier rubyid_dump'>dump</span></code></pre>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Fixed MariaDB default function support.</p>

<p>Defaults would be written wrong in &quot;db/schema.rb&quot; and not work correctly
if using <code>db:schema:load</code>. Further more the function name would be
added as string content when saving new records.</p>

<p><em>kaspernj</em></p></li>
<li><p>Add <code>active_record.destroy_association_async_batch_size</code> configuration</p>

<p>This allows applications to specify the maximum number of records that will
be destroyed in a single background job by the <code>dependent: :destroy_async</code>
association option. By default, the current behavior will remain the same:
when a parent record is destroyed, all dependent records will be destroyed
in a single background job. If the number of dependent records is greater
than this configuration, the records will be destroyed in multiple
background jobs.</p>

<p><em>Nick Holden</em></p></li>
<li><p>Fix <code>remove_foreign_key</code> with <code>:if_exists</code> option when foreign key actually exists.</p>

<p><em>fatkodima</em></p></li>
<li><p>Remove <code>--no-comments</code> flag in structure dumps for PostgreSQL</p>

<p>This broke some apps that used custom schema comments. If you don&#39;t want
comments in your structure dump, you can use:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Tasks.html" title="ActiveRecord::Tasks (module)">Tasks</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Tasks/DatabaseTasks.html" title="ActiveRecord::Tasks::DatabaseTasks (module)">DatabaseTasks</a></span>.<span class='id identifier rubyid_structure_dump_flags'><a href="ActiveRecord/Tasks/DatabaseTasks.html#structure_dump_flags-class_method" title="ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags (method)">structure_dump_flags</a></span> <span class='op'>=</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>--no-comments</span><span class='tstring_end'>&#39;</span></span>]</code></pre>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Reduce the memory footprint of fixtures accessors.</p>

<p>Until now fixtures accessors were eagerly defined using <code>define_method</code>.
So the memory usage was directly dependent of the number of fixtures and
test suites.</p>

<p>Instead fixtures accessors are now implemented with <code>method_missing</code>,
so they incur much less memory and CPU overhead.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Fix <code>config.active_record.destroy_association_async_job</code> configuration</p>

<p><code>config.active_record.destroy_association_async_job</code> should allow
applications to specify the job that will be used to destroy associated
records in the background for <code>has_many</code> associations with the
<code>dependent: :destroy_async</code> option. Previously, that was ignored, which
meant the default {ActiveRecord::DestroyAssociationAsyncJob} always
destroyed records in the background.</p>

<p><em>Nick Holden</em></p></li>
<li><p>Fix <code>change_column_comment</code> to preserve column&#39;s AUTO_INCREMENT in the MySQL adapter</p>

<p><em>fatkodima</em></p></li>
<li><p>Fix quoting of {ActiveSupport::Duration} and {Rational} numbers in the MySQL adapter.</p>

<p><em>Kevin McPhillips</em></p></li>
<li><p>Allow column name with COLLATE (e.g., title COLLATE &quot;C&quot;) as safe SQL string</p>

<p><em>Shugo Maeda</em></p></li>
<li><p>Permit underscores in the VERSION argument to database rake tasks.</p>

<p><em>Eddie Lebow</em></p></li>
<li><p>Reversed the order of {INSERT} statements in <code>structure.sql</code> dumps</p>

<p>This should decrease the likelihood of merge conflicts. New migrations
will now be added at the top of the list.</p>

<p>For existing apps, there will be a large diff the next time <code>structure.sql</code>
is generated.</p>

<p><em>Alex Ghiculescu</em>, <em>Matt Larraz</em></p></li>
<li><p>Fix PG.connect keyword arguments deprecation warning on ruby 2.7</p>

<p>Fixes #44307.</p>

<p><em>Nikita Vasilevsky</em></p></li>
<li><p>Fix dropping DB connections after serialization failures and deadlocks.</p>

<p>Prior to 6.1.4, serialization failures and deadlocks caused rollbacks to be
issued for both real transactions and savepoints. This breaks MySQL which
disallows rollbacks of savepoints following a deadlock.</p>

<p>6.1.4 removed these rollbacks, for both transactions and savepoints, causing
the DB connection to be left in an unknown state and thus discarded.</p>

<p>These rollbacks are now restored, except for savepoints on MySQL.</p>

<p><em>Thomas Morgan</em></p></li>
<li><p>Make {ActiveRecord::ConnectionPool} Fiber-safe</p>

<p>When {ActiveSupport::IsolatedExecutionState.isolation_level} is set to <code>:fiber</code>,
the connection pool now supports multiple Fibers from the same Thread checking
out connections from the pool.</p>

<p><em>Alex Matchneer</em></p></li>
<li><p>Add <code>update_attribute!</code> to {ActiveRecord::Persistence}</p>

<p>Similar to <code>update_attribute</code>, but raises {ActiveRecord::RecordNotSaved} when a <code>before_*</code> callback throws <code>:abort</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Topic</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_save'>before_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_check_title'>check_title</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_check_title'>check_title</span>
    <span class='id identifier rubyid_throw'>throw</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_abort'>abort</span>) <span class='kw'>if</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abort</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_topic'>topic</span> <span class='op'>=</span> <span class='const'>Topic</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Test Title</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># #=&gt; #&lt;Topic title: &quot;Test Title&quot;&gt;
</span><span class='id identifier rubyid_topic'>topic</span>.<span class='id identifier rubyid_update_attribute!'>update_attribute!</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Another Title</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># #=&gt; #&lt;Topic title: &quot;Another Title&quot;&gt;
</span><span class='id identifier rubyid_topic'>topic</span>.<span class='id identifier rubyid_update_attribute!'>update_attribute!</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>abort</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># raises ActiveRecord::RecordNotSaved</span></code></pre>

<p><em>Drew Tempelmeyer</em></p></li>
<li><p>Avoid loading every record in {ActiveRecord::Relation#pretty_print}</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Before
</span><span class='id identifier rubyid_pp'>pp</span> <span class='const'>Foo</span>.<span class='id identifier rubyid_all'>all</span> <span class='comment'># Loads the whole table.
</span>
<span class='comment'># After
</span><span class='id identifier rubyid_pp'>pp</span> <span class='const'>Foo</span>.<span class='id identifier rubyid_all'>all</span> <span class='comment'># Shows 10 items and an ellipsis.</span></code></pre>

<p><em>Ulysse Buonomo</em></p></li>
<li><p>Change {QueryMethods#in_order_of} to drop records not listed in values.</p>

<p><code>in_order_of</code> now filters down to the values provided, to match the behavior of the {Enumerable} version.</p>

<p><em>Kevin Newton</em></p></li>
<li><p>Allow named expression indexes to be revertible.</p>

<p>Previously, the following code would raise an error in a reversible migration executed while rolling back, due to the index name not being used in the index removal.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_index'>add_index</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_settings'>settings</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(data-&gt;&#39;property&#39;)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>using:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gin'>gin</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_index_settings_data_property'>index_settings_data_property</span>)</code></pre>

<p>Fixes #43331.</p>

<p><em>Oliver Günther</em></p></li>
<li><p>Fix incorrect argument in PostgreSQL structure dump tasks.</p>

<p>Updating the <code>--no-comment</code> argument added in Rails 7 to the correct <code>--no-comments</code> argument.</p>

<p><em>Alex Dent</em></p></li>
<li><p>Fix migration compatibility to create SQLite references/belongs_to column as integer when migration version is 6.0.</p>

<p>Reference/belongs_to in migrations with version 6.0 were creating columns as
bigint instead of integer for the SQLite Adapter.</p>

<p><em>Marcelo Lauxen</em></p></li>
<li><p>Fix {QueryMethods#in_order_of} to handle empty order list.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_in_order_of'>in_order_of</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> []).<span class='id identifier rubyid_to_a'>to_a</span></code></pre>

<p>Also more explicitly set the column as secondary order, so that any other
value is still ordered.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Fix quoting of column aliases generated by calculation methods.</p>

<p>Since the alias is derived from the table name, we can&#39;t assume the result
is a valid identifier.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Test</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_table_name'>table_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1abc</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
<span class='const'>Test</span>.<span class='id identifier rubyid_group'>group</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>).<span class='id identifier rubyid_count'>count</span>
<span class='comment'># syntax error at or near &quot;1&quot; (ActiveRecord::StatementInvalid)
</span><span class='comment'># LINE 1: SELECT COUNT(*) AS count_all, &quot;1abc&quot;.&quot;id&quot; AS 1abc_id FROM &quot;1...</span></code></pre>

<p><em>Jean Boussier</em></p></li>
<li><p>Add <code>authenticate_by</code> when using <code>has_secure_password</code>.</p>

<p><code>authenticate_by</code> is intended to replace code like the following, which
returns early when a user with a matching email is not found:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span>)<span class='op'>&amp;.</span><span class='id identifier rubyid_authenticate'>authenticate</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>Such code is vulnerable to timing-based enumeration attacks, wherein an
attacker can determine if a user account with a given email exists. After
confirming that an account exists, the attacker can try passwords associated
with that email address from other leaked databases, in case the user
re-used a password across multiple sites (a common practice). Additionally,
knowing an account email address allows the attacker to attempt a targeted
phishing (&quot;spear phishing&quot;) attack.</p>

<p><code>authenticate_by</code> addresses the vulnerability by taking the same amount of
time regardless of whether a user with a matching email is found:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_authenticate_by'>authenticate_by</span>(<span class='label'>email:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>password:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p><em>Jonathan Hefner</em></p></li>
</ul>

<p>Please check [7-0-stable]) for previous changes.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>