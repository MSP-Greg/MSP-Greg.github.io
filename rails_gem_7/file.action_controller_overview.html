<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Action Controller Overview &mdash; Rails 7.2.2.2</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "action_controller_overview",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 7.2.2.2</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Action Controller Overview&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1>Action Controller Overview</h1>

<p>In this guide, you will learn how controllers work and how they fit into the request cycle in your application.</p>

<p>After reading this guide, you will know how to:</p>

<ul>
<li>Follow the flow of a request through a controller.</li>
<li>Restrict parameters passed to your controller.</li>
<li>Store data in the session or cookies, and why.</li>
<li>Work with action callbacks to execute code during request processing.</li>
<li>Use Action Controller&#39;s built-in HTTP authentication.</li>
<li>Stream data directly to the user&#39;s browser.</li>
<li>Filter sensitive parameters, so they do not appear in the application&#39;s log.</li>
<li>Deal with exceptions that may be raised during request processing.</li>
<li>Use the built-in health check end-point for load balancers and uptime monitors.</li>
</ul>

<hr>

<h2>What Does a Controller Do?</h2>

<p>Action Controller is the C in <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">MVC</a>. After the router has determined which controller to use for a request, the controller is responsible for making sense of the request and producing the appropriate output. Luckily, Action Controller does most of the groundwork for you and uses smart conventions to make this as straightforward as possible.</p>

<p>For most conventional <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a> applications, the controller will receive the request (this is invisible to you as the developer), fetch or save data from a model, and use a view to create HTML output. If your controller needs to do things a little differently, that&#39;s not a problem, this is just the most common way for a controller to work.</p>

<p>A controller can thus be thought of as a middleman between models and views. It makes the model data available to the view, so it can display that data to the user, and it saves or updates user data to the model.</p>

<p>NOTE: For more details on the routing process, see <a href="routing.html">Rails Routing from the Outside In</a>.</p>

<h2>Controller Naming Convention</h2>

<p>The naming convention of controllers in <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> favors pluralization of the last word in the controller&#39;s name, although it is not strictly required (e.g. <code>ApplicationController</code>). For example, <code>ClientsController</code> is preferable to <code>ClientController</code>, <code>SiteAdminsController</code> is preferable to <code>SiteAdminController</code> or <code>SitesAdminsController</code>, and so on.</p>

<p>Following this convention will allow you to use the default route generators (e.g. <code>resources</code>, etc) without needing to qualify each <code>:path</code> or <code>:controller</code>, and will keep named route helpers&#39; usage consistent throughout your application. See <a href="layouts_and_rendering.html">Layouts and Rendering Guide</a> for more details.</p>

<p>NOTE: The controller naming convention differs from the naming convention of models, which are expected to be named in singular form.</p>

<h2>Methods and Actions</h2>

<p>A controller is a Ruby class which inherits from <code>ApplicationController</code> and has methods just like any other class. When your application receives a request, the routing will determine which controller and action to run, then <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> creates an instance of that controller and runs the method with the same name as the action.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ClientsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>As an example, if a user goes to <code>/clients/new</code> in your application to add a new client, Rails will create an instance of <code>ClientsController</code> and call its <code>new</code> method. Note that the empty method from the example above would work just fine because Rails will by default render the <code>new.html.erb</code> view unless the action says otherwise. By creating a new <code>Client</code>, the <code>new</code> method can make a <code>@client</code> instance variable accessible in the view:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span></code></pre>

<p>The <a href="layouts_and_rendering.html">Layouts and Rendering Guide</a> explains this in more detail.</p>

<p><code>ApplicationController</code> inherits from <a href="https://api.rubyonrails.org/classes/ActionController/Base.html"><a href="ActionController/Base.html" title="ActionController::Base (class)"><code>::ActionController::Base</code></a></a>, which defines a number of helpful methods. This guide will cover some of these, but if you&#39;re curious to see what&#39;s in there, you can see all of them in the <a href="https://api.rubyonrails.org/classes/ActionController.html">API documentation</a> or in the source itself.</p>

<p>Only public methods are callable as actions. It is a best practice to lower the visibility of methods (with <code>private</code> or <code>protected</code>) which are not intended to be actions, like auxiliary methods or filters.</p>

<p>WARNING: Some method names are reserved by Action Controller. Accidentally redefining them as actions, or even as auxiliary methods, could result in <code>SystemStackError</code>. If you limit your controllers to only RESTful <a href="routing.html#resource-routing-the-rails-default">Resource Routing</a> actions you should not need to worry about this.</p>

<p>NOTE: If you must use a reserved method as an action name, one workaround is to use a custom route to map the reserved method name to your non-reserved action method.</p>

<h2>Parameters</h2>

<p>You will probably want to access data sent in by the user or other parameters in your controller actions. There are two kinds of parameters possible in a web application. The first are parameters that are sent as part of the URL, called query string parameters. The query string is everything after &quot;?&quot; in the URL. The second type of parameter is usually referred to as POST data. This information usually comes from an HTML form which has been filled in by the user. It&#39;s called POST data because it can only be sent as part of an HTTP POST request. Rails does not make any distinction between query string parameters and POST parameters, and both are available in the <a href="https://api.rubyonrails.org/classes/ActionController/StrongParameters.html#method-i-params"><code>params</code></a> hash in your controller:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ClientsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># This action uses query string parameters because it gets run
</span>  <span class='comment'># by an HTTP GET request, but this does not make any difference
</span>  <span class='comment'># to how the parameters are accessed. The URL for
</span>  <span class='comment'># this action would look like this to list activated
</span>  <span class='comment'># clients: /clients?status=activated
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_status'>status</span>] <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>activated</span><span class='tstring_end'>&quot;</span></span>
      <span class='ivar'>@clients</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_activated'>activated</span>
    <span class='kw'>else</span>
      <span class='ivar'>@clients</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_inactivated'>inactivated</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># This action uses POST parameters. They are most likely coming
</span>  <span class='comment'># from an HTML form that the user has submitted. The URL for
</span>  <span class='comment'># this RESTful request will be &quot;/clients&quot;, and the data will be
</span>  <span class='comment'># sent as part of the request body.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='ivar'>@client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_client'>client</span>])
    <span class='kw'>if</span> <span class='ivar'>@client</span>.<span class='id identifier rubyid_save'>save</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@client</span>
    <span class='kw'>else</span>
      <span class='comment'># This line overrides the default rendering behavior, which
</span>      <span class='comment'># would have been to render the &quot;create&quot; view.
</span>      <span class='id identifier rubyid_render'>render</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Hash and Array Parameters</h3>

<p>The <code>params</code> hash is not limited to one-dimensional keys and values. It can contain nested arrays and hashes. To send an array of values, append an empty pair of square brackets &quot;[]&quot; to the key name:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>GET</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>clients?ids[]=1&amp;ids[]=2&amp;ids[]=3</span></code></pre>

<p>NOTE: The actual URL in this example will be encoded as &quot;/clients?ids%5b%5d=1&amp;ids%5b%5d=2&amp;ids%5b%5d=3&quot; as the &quot;[&quot; and &quot;]&quot; characters are not allowed in URLs. Most of the time you don&#39;t have to worry about this because the browser will encode it for you, and Rails will decode it automatically, but if you ever find yourself having to send those requests to the server manually you should keep this in mind.</p>

<p>The value of <code>params[:ids]</code> will now be <code>[&quot;1&quot;, &quot;2&quot;, &quot;3&quot;]</code>. Note that parameter values are always strings; Rails does not attempt to guess or cast the type.</p>

<p>NOTE: Values such as <code>[nil]</code> or <code>[nil, nil, ...]</code> in <code>params</code> are replaced
with <code>[]</code> for security reasons by default. See <a href="security.html#unsafe-query-generation">Security Guide</a>
for more information.</p>

<p>To send a hash, you include the key name inside the brackets:</p>

<pre class="code xml"><code class="xml">&lt;form accept-charset=&quot;UTF-8&quot; action=&quot;/clients&quot; method=&quot;post&quot;&gt;
  &lt;input type=&quot;text&quot; name=&quot;client[name]&quot; value=&quot;Acme&quot; /&gt;
  &lt;input type=&quot;text&quot; name=&quot;client[phone]&quot; value=&quot;12345&quot; /&gt;
  &lt;input type=&quot;text&quot; name=&quot;client[address][postcode]&quot; value=&quot;12345&quot; /&gt;
  &lt;input type=&quot;text&quot; name=&quot;client[address][city]&quot; value=&quot;Carrot City&quot; /&gt;
&lt;/form&gt;
</code></pre>

<p>When this form is submitted, the value of <code>params[:client]</code> will be <code>{ &quot;name&quot; =&gt; &quot;Acme&quot;, &quot;phone&quot; =&gt; &quot;12345&quot;, &quot;address&quot; =&gt; { &quot;postcode&quot; =&gt; &quot;12345&quot;, &quot;city&quot; =&gt; &quot;Carrot City&quot; } }</code>. Note the nested hash in <code>params[:client][:address]</code>.</p>

<p>The <code>params</code> object acts like a Hash, but lets you use symbols and strings interchangeably as keys.</p>

<h3>JSON Parameters</h3>

<p>If your application exposes an API, you are likely to be accepting parameters in JSON format. If the &quot;Content-Type&quot; header of your request is set to &quot;application/json&quot;, Rails will automatically load your parameters into the <code>params</code> hash, which you can access as you would normally.</p>

<p>So for example, if you are sending this JSON content:</p>

<pre class="code json"><code class="json">{ &quot;company&quot;: { &quot;name&quot;: &quot;acme&quot;, &quot;address&quot;: &quot;123 Carrot Street&quot; } }
</code></pre>

<p>Your controller will receive <code>params[:company]</code> as <code>{ &quot;name&quot; =&gt; &quot;acme&quot;, &quot;address&quot; =&gt; &quot;123 Carrot Street&quot; }</code>.</p>

<p>Also, if you&#39;ve turned on <code>config.wrap_parameters</code> in your initializer or called <a href="https://api.rubyonrails.org/classes/ActionController/ParamsWrapper/Options/ClassMethods.html#method-i-wrap_parameters"><code>wrap_parameters</code></a> in your controller, you can safely omit the root element in the JSON parameter. In this case, the parameters will be cloned and wrapped with a key chosen based on your controller&#39;s name. So the above JSON request can be written as:</p>

<pre class="code json"><code class="json">{ &quot;name&quot;: &quot;acme&quot;, &quot;address&quot;: &quot;123 Carrot Street&quot; }
</code></pre>

<p>And, assuming that you&#39;re sending the data to <code>CompaniesController</code>, it would then be wrapped within the <code>:company</code> key like this:</p>

<pre class="code ruby"><code class="ruby">{ <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>acme</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>address:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>123 Carrot Street</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>company:</span> { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>acme</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>address:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>123 Carrot Street</span><span class='tstring_end'>&quot;</span></span> } }</code></pre>

<p>You can customize the name of the key or specific parameters you want to wrap by consulting the <a href="https://api.rubyonrails.org/classes/ActionController/ParamsWrapper.html">API documentation</a></p>

<p>NOTE: Support for parsing XML parameters has been extracted into a gem named <code>actionpack-xml_parser</code>.</p>

<h3>Routing Parameters</h3>

<p>The <code>params</code> hash will always contain the <code>:controller</code> and <code>:action</code> keys, but you should use the methods <a href="https://api.rubyonrails.org/classes/ActionController/Metal.html#method-i-controller_name"><code>controller_name</code></a> and <a href="https://api.rubyonrails.org/classes/AbstractController/Base.html#method-i-action_name"><code>action_name</code></a> instead to access these values. Any other parameters defined by the routing, such as <code>:id</code>, will also be available. As an example, consider a listing of clients where the list can show either active or inactive clients. We can add a route that captures the <code>:status</code> parameter in a &quot;pretty&quot; URL:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/clients/:status</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>clients#index</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>foo:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>In this case, when a user opens the URL <code>/clients/active</code>, <code>params[:status]</code> will be set to &quot;active&quot;. When this route is used, <code>params[:foo]</code> will also be set to &quot;bar&quot;, as if it were passed in the query string. Your controller will also receive <code>params[:action]</code> as &quot;index&quot; and <code>params[:controller]</code> as &quot;clients&quot;.</p>

<h3>Composite Key Parameters</h3>

<p>Composite key parameters contain multiple values in one parameter. For this reason, we need to be able to extract each value and pass them to Active Record. We can leverage the <code>extract_value</code> method for this use-case.</p>

<p>Given the following controller:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>BooksController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
    <span class='comment'># Extract the composite ID value from URL parameters.
</span>    <span class='id identifier rubyid_id'>id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_extract_value'>extract_value</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>)
    <span class='comment'># Find the book using the composite ID.
</span>    <span class='ivar'>@book</span> <span class='op'>=</span> <span class='const'>Book</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_id'>id</span>)
    <span class='comment'># use the default rendering behaviour to render the show view.
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>And the following route:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/books/:id</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>books#show</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>When a user opens the URL <code>/books/4_2</code>, the controller will extract the composite
key value <code>[&quot;4&quot;, &quot;2&quot;]</code> and pass it to <code>Book.find</code> to render the right record in the view.
The <code>extract_value</code> method may be used to extract arrays out of any delimited parameters.</p>

<h3><code>default_url_options</code></h3>

<p>You can set global default parameters for URL generation by defining a method called <code>default_url_options</code> in your controller. Such a method must return a hash with the desired defaults, whose keys must be symbols:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_default_url_options'>default_url_options</span>
    { <span class='label'>locale:</span> <span class='const'><a href="I18n.html" title="I18n (module)">I18n</a></span>.<span class='id identifier rubyid_locale'>locale</span> }
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>These options will be used as a starting point when generating URLs, so it&#39;s possible they&#39;ll be overridden by the options passed to <code>url_for</code> calls.</p>

<p>If you define <code>default_url_options</code> in <code>ApplicationController</code>, as in the example above, these defaults will be used for all URL generation. The method can also be defined in a specific controller, in which case it only affects URLs generated there.</p>

<p>In a given request, the method is not actually called for every single generated URL. For performance reasons, the returned hash is cached, and there is at most one invocation per request.</p>

<h3>Strong Parameters</h3>

<p>With strong parameters, Action Controller parameters are forbidden to
be used in Active Model mass assignments until they have been
permitted. This means that you&#39;ll have to make a conscious decision about
which attributes to permit for mass update. This is a better security
practice to help prevent accidentally allowing users to update sensitive
model attributes.</p>

<p>In addition, parameters can be marked as required and will flow through a
predefined raise/rescue flow that will result in a 400 Bad Request being
returned if not all required parameters are passed in.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>PeopleController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='comment'># This will raise an ActiveModel::ForbiddenAttributesError exception
</span>  <span class='comment'># because it&#39;s using mass assignment without an explicit permit
</span>  <span class='comment'># step.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='const'>Person</span>.<span class='id identifier rubyid_create'>create</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_person'>person</span>])
  <span class='kw'>end</span>

  <span class='comment'># This will pass with flying colors as long as there&#39;s a person key
</span>  <span class='comment'># in the parameters, otherwise it&#39;ll raise an
</span>  <span class='comment'># ActionController::ParameterMissing exception, which will get
</span>  <span class='comment'># caught by ActionController::Base and turned into a 400 Bad
</span>  <span class='comment'># Request error.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_update'>update</span>
    <span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='id identifier rubyid_current_account'>current_account</span>.<span class='id identifier rubyid_people'>people</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])
    <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_update!'>update!</span>(<span class='id identifier rubyid_person_params'>person_params</span>)
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_person'>person</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># Using a private method to encapsulate the permissible parameters
</span>    <span class='comment'># is just a good pattern since you&#39;ll be able to reuse the same
</span>    <span class='comment'># permit list between create and update. Also, you can specialize
</span>    <span class='comment'># this method with per-user checking of permissible attributes.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_person_params'>person_params</span>
      <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_require'>require</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_person'>person</span>).<span class='id identifier rubyid_permit'>permit</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_age'>age</span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h4>Permitted Scalar Values</h4>

<p>Calling <a href="https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-permit"><code>permit</code></a> like:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_permit'>permit</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>)</code></pre>

<p>permits the specified key (<code>:id</code>) for inclusion if it appears in <code>params</code> and
it has a permitted scalar value associated. Otherwise, the key is going
to be filtered out, so arrays, hashes, or any other objects cannot be
injected.</p>

<p>The permitted scalar types are <a href="String.html" title="String (class)"><code>String</code></a>, <a href="Symbol.html" title="Symbol (class)"><code>Symbol</code></a>, <a href="NilClass.html" title="NilClass (class)"><code>NilClass</code></a>,
<a href="Numeric.html" title="Numeric (class)"><code>Numeric</code></a>, <a href="TrueClass.html" title="TrueClass (class)"><code>TrueClass</code></a>, <a href="FalseClass.html" title="FalseClass (class)"><code>FalseClass</code></a>, <a href="Date.html" title="Date (class)"><code>Date</code></a>, <a href="Time.html" title="Time (class)"><code>Time</code></a>, <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a>,
<code>StringIO</code>, <a href="IO.html" title="IO (class)"><code>IO</code></a>, <a href="ActionDispatch/Http/UploadedFile.html" title="ActionDispatch::Http::UploadedFile (class)"><code>::ActionDispatch::Http::UploadedFile</code></a>, and
<code>Rack::Test::UploadedFile</code>.</p>

<p>To declare that the value in <code>params</code> must be an array of permitted
scalar values, map the key to an empty array:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_permit'>permit</span>(<span class='label'>id:</span> [])</code></pre>

<p>Sometimes it is not possible or convenient to declare the valid keys of
a hash parameter or its internal structure. Just map to an empty hash:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_permit'>permit</span>(<span class='label'>preferences:</span> {})</code></pre>

<p>but be careful because this opens the door to arbitrary input. In this
case, <code>permit</code> ensures values in the returned structure are permitted
scalars and filters out anything else.</p>

<p>To permit an entire hash of parameters, the <a href="https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-permit-21"><code>permit!</code></a> method can be
used:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_require'>require</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_log_entry'>log_entry</span>).<span class='id identifier rubyid_permit!'>permit!</span></code></pre>

<p>This marks the <code>:log_entry</code> parameters hash and any sub-hash of it as
permitted and does not check for permitted scalars, anything is accepted.
Extreme care should be taken when using <code>permit!</code>, as it will allow all current
and future model attributes to be mass-assigned.</p>

<h4>Nested Parameters</h4>

<p>You can also use <code>permit</code> on nested parameters, like:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_permit'>permit</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> { <span class='label'>emails:</span> [] }<span class='comma'>,</span>
              <span class='label'>friends:</span> [ <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
                         { <span class='label'>family:</span> [ <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span> ]<span class='comma'>,</span> <span class='label'>hobbies:</span> [] }])</code></pre>

<p>This declaration permits the <code>name</code>, <code>emails</code>, and <code>friends</code>
attributes. It is expected that <code>emails</code> will be an array of permitted
scalar values, and that <code>friends</code> will be an array of resources with
specific attributes: they should have a <code>name</code> attribute (any
permitted scalar values allowed), a <code>hobbies</code> attribute as an array of
permitted scalar values, and a <code>family</code> attribute which is restricted
to having a <code>name</code> (any permitted scalar values allowed here, too).</p>

<h4>More Examples</h4>

<p>You may want to also use the permitted attributes in your <code>new</code>
action. This raises the problem that you can&#39;t use <a href="https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-require"><code>require</code></a> on the
root key because, normally, it does not exist when calling <code>new</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># using `fetch` you can supply a default and use
</span><span class='comment'># the Strong Parameters API from there.
</span><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_blog'>blog</span><span class='comma'>,</span> {}).<span class='id identifier rubyid_permit'>permit</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>)</code></pre>

<p>The model class method <code>accepts_nested_attributes_for</code> allows you to
update and destroy associated records. This is based on the <code>id</code> and <code>_destroy</code>
parameters:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># permit :id and :_destroy
</span><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_require'>require</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>).<span class='id identifier rubyid_permit'>permit</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>books_attributes:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid__destroy'>_destroy</span>])</code></pre>

<p>Hashes with integer keys are treated differently, and you can declare
the attributes as if they were direct children. You get these kinds of
parameters when you use <code>accepts_nested_attributes_for</code> in combination
with a <code>has_many</code> association:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># To permit the following data:
</span><span class='comment'># {&quot;book&quot; =&gt; {&quot;title&quot; =&gt; &quot;Some Book&quot;,
</span><span class='comment'>#             &quot;chapters_attributes&quot; =&gt; { &quot;1&quot; =&gt; {&quot;title&quot; =&gt; &quot;First Chapter&quot;},
</span><span class='comment'>#                                        &quot;2&quot; =&gt; {&quot;title&quot; =&gt; &quot;Second Chapter&quot;}}}}
</span>
<span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_require'>require</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_book'>book</span>).<span class='id identifier rubyid_permit'>permit</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='label'>chapters_attributes:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span>])</code></pre>

<p>Imagine a scenario where you have parameters representing a product
name, and a hash of arbitrary data associated with that product, and
you want to permit the product name attribute and also the whole
data hash:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_product_params'>product_params</span>
  <span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_require'>require</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_product'>product</span>).<span class='id identifier rubyid_permit'>permit</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>data:</span> {})
<span class='kw'>end</span></code></pre>

<h4>Outside the Scope of Strong Parameters</h4>

<p>The strong parameter API was designed with the most common use cases
in mind. It is not meant as a silver bullet to handle all of your
parameter filtering problems. However, you can easily mix the API with your
own code to adapt to your situation.</p>

<h2>Session</h2>

<p>Your application has a session for each user in which you can store small amounts of data that will be persisted between requests. The session is only available in the controller and the view and can use one of several of different storage mechanisms:</p>

<ul>
<li><a href="https://api.rubyonrails.org/classes/ActionDispatch/Session/CookieStore.html"><a href="ActionDispatch/Session/CookieStore.html" title="ActionDispatch::Session::CookieStore (class)"><code>::ActionDispatch::Session::CookieStore</code></a></a> - Stores everything on the client.</li>
<li><a href="https://api.rubyonrails.org/classes/ActionDispatch/Session/CacheStore.html"><a href="ActionDispatch/Session/CacheStore.html" title="ActionDispatch::Session::CacheStore (class)"><code>::ActionDispatch::Session::CacheStore</code></a></a> - Stores the data in the Rails cache.</li>
<li><a href="https://api.rubyonrails.org/classes/ActionDispatch/Session/MemCacheStore.html"><a href="ActionDispatch/Session/MemCacheStore.html" title="ActionDispatch::Session::MemCacheStore (class)"><code>::ActionDispatch::Session::MemCacheStore</code></a></a> - Stores the data in a memcached cluster (this is a legacy implementation; consider using <code>CacheStore</code> instead).</li>
<li><a href="https://github.com/rails/activerecord-session_store"><code>ActionDispatch::Session::ActiveRecordStore</code></a> -
Stores the data in a database using Active Record (requires the
<a href="https://github.com/rails/activerecord-session_store"><code>activerecord-session_store</code></a> gem)</li>
<li>A custom store or a store provided by a third party gem</li>
</ul>

<p>All session stores use a cookie to store a unique ID for each session (you must use a cookie, Rails will not allow you to pass the session ID in the URL as this is less secure).</p>

<p>For most stores, this ID is used to look up the session data on the server, e.g. in a database table. There is one exception, and that is the default and recommended session store - the CookieStore - which stores all session data in the cookie itself (the ID is still available to you if you need it). This has the advantage of being very lightweight, and it requires zero setup in a new application to use the session. The cookie data is cryptographically signed to make it tamper-proof. And it is also encrypted so anyone with access to it can&#39;t read its contents. (Rails will not accept it if it has been edited).</p>

<p>The CookieStore can store around 4 kB of data - much less than the others - but this is usually enough. Storing large amounts of data in the session is discouraged no matter which session store your application uses. You should especially avoid storing complex objects (such as model instances) in the session, as the server might not be able to reassemble them between requests, which will result in an error.</p>

<p>If your user sessions don&#39;t store critical data or don&#39;t need to be around for long periods (for instance if you just use the flash for messaging), you can consider using <a href="ActionDispatch/Session/CacheStore.html" title="ActionDispatch::Session::CacheStore (class)"><code>::ActionDispatch::Session::CacheStore</code></a>. This will store sessions using the cache implementation you have configured for your application. The advantage of this is that you can use your existing cache infrastructure for storing sessions without requiring any additional setup or administration. The downside, of course, is that the sessions will be ephemeral and could disappear at any time.</p>

<p>Read more about session storage in the <a href="security.html">Security Guide</a>.</p>

<p>If you need a different session storage mechanism, you can change it in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_session_store'>session_store</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cache_store'>cache_store</span></code></pre>

<p>See <a href="configuring.html#config-session-store"><code>config.session_store</code></a> in the
configuration guide for more information.</p>

<p>Rails sets up a session key (the name of the cookie) when signing the session data. These can also be changed in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Be sure to restart your server when you modify this file.
</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_session_store'>session_store</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cookie_store'>cookie_store</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>_your_app_session</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>You can also pass a <code>:domain</code> key and specify the domain name for the cookie:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Be sure to restart your server when you modify this file.
</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_session_store'>session_store</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cookie_store'>cookie_store</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>_your_app_session</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>domain:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.example.com</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>Rails sets up (for the CookieStore) a secret key used for signing the session data in <code>config/credentials.yml.enc</code>. This can be changed with <code>bin/rails credentials:edit</code>.</p>

<pre class="code yaml"><code class="yaml"># aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: 492f...
</code></pre>

<p>NOTE: Changing the secret_key_base when using the <code>CookieStore</code> will invalidate all existing sessions.</p>

<h3>Accessing the Session</h3>

<p>In your controller, you can access the session through the <code>session</code> instance method.</p>

<p>NOTE: Sessions are lazily loaded. If you don&#39;t access sessions in your action&#39;s code, they will not be loaded. Hence, you will never need to disable sessions, just not accessing them will do the job.</p>

<p>Session values are stored using key/value pairs like a hash:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># Finds the User with the ID stored in the session with the key
</span>    <span class='comment'># :current_user_id This is a common way to handle user login in
</span>    <span class='comment'># a Rails application; logging in sets the session value and
</span>    <span class='comment'># logging out removes it.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_current_user'>current_user</span>
      <span class='ivar'>@_current_user</span> <span class='op'>||=</span> <span class='id identifier rubyid_session'>session</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_current_user_id'>current_user_id</span>] <span class='op'>&amp;&amp;</span>
        <span class='const'>User</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>id:</span> <span class='id identifier rubyid_session'>session</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_current_user_id'>current_user_id</span>])
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>To store something in the session, just assign it to the key like a hash:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>LoginsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># &quot;Create&quot; a login, aka &quot;log the user in&quot;
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_authenticate'>authenticate</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_username'>username</span>]<span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_password'>password</span>])
      <span class='comment'># Save the user ID in the session so it can be used in
</span>      <span class='comment'># subsequent requests
</span>      <span class='id identifier rubyid_session'>session</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_current_user_id'>current_user_id</span>] <span class='op'>=</span> <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_id'>id</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>To remove something from the session, delete the key/value pair:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>LoginsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># &quot;Delete&quot; a login, aka &quot;log the user out&quot;
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_destroy'>destroy</span>
    <span class='comment'># Remove the user id from the session
</span>    <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_current_user_id'>current_user_id</span>)
    <span class='comment'># Clear the memoized current user
</span>    <span class='ivar'>@_current_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_see_other'>see_other</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>To reset the entire session, use <a href="https://api.rubyonrails.org/classes/ActionController/Metal.html#method-i-reset_session"><code>reset_session</code></a>.</p>

<h3>The Flash</h3>

<p>The flash is a special part of the session which is cleared with each request. This means that values stored there will only be available in the next request, which is useful for passing error messages, etc.</p>

<p>The flash is accessed via the <a href="https://api.rubyonrails.org/classes/ActionDispatch/Flash/RequestMethods.html#method-i-flash"><code>flash</code></a> method. Like the session, the flash is represented as a hash.</p>

<p>Let&#39;s use the act of logging out as an example. The controller can send a message which will be displayed to the user on the next request:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>LoginsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_session'>session</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_current_user_id'>current_user_id</span>)
    <span class='id identifier rubyid_flash'>flash</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_notice'>notice</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You have successfully logged out.</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_see_other'>see_other</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Note that it is also possible to assign a flash message as part of the redirection. You can assign <code>:notice</code>, <code>:alert</code> or the general-purpose <code>:flash</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span><span class='comma'>,</span> <span class='label'>notice:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You have successfully logged out.</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span><span class='comma'>,</span> <span class='label'>alert:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You&#39;re stuck here!</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_url'>root_url</span><span class='comma'>,</span> <span class='label'>flash:</span> { <span class='label'>referral_code:</span> <span class='int'>1234</span> }</code></pre>

<p>The <code>destroy</code> action redirects to the application&#39;s <code>root_url</code>, where the message will be displayed. Note that it&#39;s entirely up to the next action to decide what, if anything, it will do with what the previous action put in the flash. It&#39;s conventional to display any error alerts or notices from the flash in the application&#39;s layout:</p>

<pre class="code xml"><code class="xml">&lt;html&gt;
  &lt;!-- &lt;head/&gt; --&gt;
  &lt;body&gt;
    &lt;% flash.each do |name, msg| -%&gt;
      &lt;%= content_tag :div, msg, class: name %&gt;
    &lt;% end -%&gt;

    &lt;!-- more content --&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>This way, if an action sets a notice or an alert message, the layout will display it automatically.</p>

<p>You can pass anything that the session can store; you&#39;re not limited to notices and alerts:</p>

<pre class="code xml"><code class="xml">&lt;% if flash[:just_signed_up] %&gt;
  &lt;p class=&quot;welcome&quot;&gt;Welcome to our site!&lt;/p&gt;
&lt;% end %&gt;
</code></pre>

<p>If you want a flash value to be carried over to another request, use <a href="https://api.rubyonrails.org/classes/ActionDispatch/Flash/FlashHash.html#method-i-keep"><code>flash.keep</code></a>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MainController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># Let&#39;s say this action corresponds to root_url, but you want
</span>  <span class='comment'># all requests here to be redirected to UsersController#index.
</span>  <span class='comment'># If an action sets the flash and redirects here, the values
</span>  <span class='comment'># would normally be lost when another redirect happens, but you
</span>  <span class='comment'># can use &#39;keep&#39; to make it persist for another request.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
    <span class='comment'># Will persist all flash values.
</span>    <span class='id identifier rubyid_flash'>flash</span>.<span class='id identifier rubyid_keep'>keep</span>

    <span class='comment'># You can also use a key to keep only some kind of value.
</span>    <span class='comment'># flash.keep(:notice)
</span>    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_users_url'>users_url</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h4><code>flash.now</code></h4>

<p>By default, adding values to the flash will make them available to the next request, but sometimes you may want to access those values in the same request. For example, if the <code>create</code> action fails to save a resource, and you render the <code>new</code> template directly, that&#39;s not going to result in a new request, but you may still want to display a message using the flash. To do this, you can use <a href="https://api.rubyonrails.org/classes/ActionDispatch/Flash/FlashHash.html#method-i-now"><code>flash.now</code></a> in the same way you use the normal <code>flash</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ClientsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='ivar'>@client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_client_params'>client_params</span>)
    <span class='kw'>if</span> <span class='ivar'>@client</span>.<span class='id identifier rubyid_save'>save</span>
      <span class='comment'># ...
</span>    <span class='kw'>else</span>
      <span class='id identifier rubyid_flash'>flash</span>.<span class='id identifier rubyid_now'>now</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Could not save client</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_render'>render</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h2>Cookies</h2>

<p>Your application can store small amounts of data on the client - called cookies - that will be persisted across requests and even sessions. Rails provides easy access to cookies via the <a href="https://api.rubyonrails.org/classes/ActionController/Cookies.html#method-i-cookies"><code>cookies</code></a> method, which - much like the <code>session</code> - works like a hash:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CommentsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>
    <span class='comment'># Auto-fill the commenter&#39;s name if it has been stored in a cookie
</span>    <span class='ivar'>@comment</span> <span class='op'>=</span> <span class='const'>Comment</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>author:</span> <span class='id identifier rubyid_cookies'>cookies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_commenter_name'>commenter_name</span>])
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='ivar'>@comment</span> <span class='op'>=</span> <span class='const'>Comment</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_comment_params'>comment_params</span>)
    <span class='kw'>if</span> <span class='ivar'>@comment</span>.<span class='id identifier rubyid_save'>save</span>
      <span class='id identifier rubyid_flash'>flash</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_notice'>notice</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Thanks for your comment!</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_remember_name'>remember_name</span>]
        <span class='comment'># Remember the commenter&#39;s name.
</span>        <span class='id identifier rubyid_cookies'>cookies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_commenter_name'>commenter_name</span>] <span class='op'>=</span> <span class='ivar'>@comment</span>.<span class='id identifier rubyid_author'>author</span>
      <span class='kw'>else</span>
        <span class='comment'># Delete cookie for the commenter&#39;s name cookie, if any.
</span>        <span class='id identifier rubyid_cookies'>cookies</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_commenter_name'>commenter_name</span>)
      <span class='kw'>end</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@comment</span>.<span class='id identifier rubyid_article'>article</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_render'>render</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Note that while for session values you can set the key to <code>nil</code>, to delete a cookie value you should use <code>cookies.delete(:key)</code>.</p>

<p>Rails also provides a signed cookie jar and an encrypted cookie jar for storing
sensitive data. The signed cookie jar appends a cryptographic signature on the
cookie values to protect their integrity. The encrypted cookie jar encrypts the
values in addition to signing them, so that they cannot be read by the end-user.
Refer to the <a href="https://api.rubyonrails.org/classes/ActionDispatch/Cookies.html">API documentation</a>
for more details.</p>

<p>These special cookie jars use a serializer to serialize the assigned values into
strings and deserialize them into Ruby objects on read. You can specify which
serializer to use via <a href="configuring.html#config-action-dispatch-cookies-serializer"><code>config.action_dispatch.cookies_serializer</code></a>.</p>

<p>The default serializer for new applications is <code>:json</code>. Be aware that JSON has
limited support for roundtripping Ruby objects. For example, <a href="Date.html" title="Date (class)"><code>Date</code></a>, <a href="Time.html" title="Time (class)"><code>Time</code></a>, and
<a href="Symbol.html" title="Symbol (class)"><code>Symbol</code></a> objects (including <a href="Hash.html" title="Hash (class)"><code>Hash</code></a> keys) will be serialized and deserialized
into <a href="String.html" title="String (class)"><code>String</code></a>s:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CookiesController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_set_cookie'>set_cookie</span>
    <span class='id identifier rubyid_cookies'>cookies</span>.<span class='id identifier rubyid_encrypted'>encrypted</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_expiration_date'>expiration_date</span>] <span class='op'>=</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span>.<span class='id identifier rubyid_tomorrow'><a href="Date.html#tomorrow-class_method" title="Date.tomorrow (method)">tomorrow</a></span> <span class='comment'># =&gt; Thu, 20 Mar 2014
</span>    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>read_cookie</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_read_cookie'>read_cookie</span>
    <span class='id identifier rubyid_cookies'>cookies</span>.<span class='id identifier rubyid_encrypted'>encrypted</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_expiration_date'>expiration_date</span>] <span class='comment'># =&gt; &quot;2014-03-20&quot;
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>If you need to store these or more complex objects, you may need to manually
convert their values when reading them in subsequent requests.</p>

<p>If you use the cookie session store, the above applies to the <code>session</code> and
<code>flash</code> hash as well.</p>

<h2>Rendering</h2>

<p>ActionController makes rendering HTML, XML, or JSON data effortless. If you&#39;ve generated a controller using scaffolding, it would look something like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UsersController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
    <span class='ivar'>@users</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_all'>all</span>
    <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_html'>html</span> <span class='comment'># index.html.erb
</span>      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_xml'>xml</span>  { <span class='id identifier rubyid_render'>render</span> <span class='label'>xml:</span> <span class='ivar'>@users</span> }
      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_json'>json</span> { <span class='id identifier rubyid_render'>render</span> <span class='label'>json:</span> <span class='ivar'>@users</span> }
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>You may notice in the above code that we&#39;re using <code>render xml: @users</code>, not <code>render xml: @users.to_xml</code>. If the object is not a String, then Rails will automatically invoke <code>to_xml</code> for us.</p>

<p>You can learn more about rendering in the <a href="layouts_and_rendering.html">Layouts and Rendering
Guide</a>.</p>

<h2>Action callbacks</h2>

<p>Action callbacks are methods that are run &quot;before&quot;, &quot;after&quot; or &quot;around&quot; a controller action.</p>

<p>Action callbacks are inherited, so if you set one on an <code>ApplicationController</code>, it will be run on every controller in your application.</p>

<p>&quot;before&quot; action callbacks are registered via <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-before_action"><code>before_action</code></a>. They may halt the request cycle. A common &quot;before&quot; action callback is one which requires that a user is logged in for an action to be run. You can define the method this way:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_action'>before_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_require_login'>require_login</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_require_login'>require_login</span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_logged_in?'>logged_in?</span>
        <span class='id identifier rubyid_flash'>flash</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You must be logged in to access this section</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_new_login_url'>new_login_url</span> <span class='comment'># halts request cycle
</span>      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The method simply stores an error message in the flash and redirects to the login form if the user is not logged in. If a &quot;before&quot; action callback renders or redirects, the controller action will not run. If there are additional action callbacks scheduled to run after that one, they are also cancelled.</p>

<p>In this example, the action callback is added to <code>ApplicationController</code> and thus all controllers in the application inherit it. This will make everything in the application require the user to be logged in to use it. For obvious reasons (the user wouldn&#39;t be able to log in in the first place!), not all controllers or actions should require this. You can prevent this action callback from running before particular actions with <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-skip_before_action"><code>skip_before_action</code></a>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>LoginsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='id identifier rubyid_skip_before_action'>skip_before_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_require_login'>require_login</span><span class='comma'>,</span> <span class='label'>only:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_create'>create</span>]
<span class='kw'>end</span></code></pre>

<p>Now, the <code>LoginsController</code>&#39;s <code>new</code> and <code>create</code> actions will work as before without requiring the user to be logged in. The <code>:only</code> option is used to skip this action callback only for these actions, and there is also an <code>:except</code> option which works the other way. These options can be used when adding action callbacks too, so you can add a callback which only runs for selected actions in the first place.</p>

<p>NOTE: Calling the same action callback multiple times with different options will not work,
since the last action callback definition will overwrite the previous ones.</p>

<h3>After Action and Around Action Callbacks</h3>

<p>In addition to &quot;before&quot; action callback, you can also run action callbacks after a controller action has been executed, or both before and after.</p>

<p>&quot;after&quot; action callbacks are registered via <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-after_action"><code>after_action</code></a>. They are similar to &quot;before&quot; action callbacks, but because the controller action has already been run they have access to the response data that&#39;s about to be sent to the client. Obviously, &quot;after&quot; action callbacks cannot stop the action from running. Please note that &quot;after&quot; action callbacks are executed only after a successful controller action, but not when an exception is raised in the request cycle.</p>

<p>&quot;around&quot; action callbacks are registered via <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-around_action"><code>around_action</code></a>. They are responsible for running their associated actions by yielding, similar to how Rack middlewares work.</p>

<p>For example, in a website where changes have an approval workflow, an administrator could preview them easily by applying them within a transaction:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ChangesController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='id identifier rubyid_around_action'>around_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_wrap_in_transaction'>wrap_in_transaction</span><span class='comma'>,</span> <span class='label'>only:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_show'>show</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_wrap_in_transaction'>wrap_in_transaction</span>
      <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_transaction'><a href="ActiveRecord/Transactions.html#transaction-instance_method" title="ActiveRecord::Transactions#transaction (method)">transaction</a></span> <span class='kw'>do</span>
        <span class='kw'>begin</span>
          <span class='kw'>yield</span>
        <span class='kw'>ensure</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Rollback.html" title="ActiveRecord::Rollback (class)">Rollback</a></span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Note that an &quot;around&quot; action callback also wraps rendering. In particular, in the example above, if the view itself reads from the database (e.g. via a scope), it will do so within the transaction and thus present the data to preview.</p>

<p>You can choose not to yield and build the response yourself, in which case the controller action will not be run.</p>

<h3>Other Ways to Use Action Callbacks</h3>

<p>While the most common way to use action callbacks is by creating private methods and using <code>before_action</code>, <code>after_action</code>, or <code>around_action</code> to add them, there are two other ways to do the same thing.</p>

<p>The first is to use a block directly with the <code>*_action</code> methods. The block receives the controller as an argument. The <code>require_login</code> action callback from above could be rewritten to use a block:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_action'>before_action</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_controller'>controller</span><span class='op'>|</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_controller'>controller</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_logged_in?'>logged_in?</span>)
      <span class='id identifier rubyid_flash'>flash</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You must be logged in to access this section</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_new_login_url'>new_login_url</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Note that the action callback, in this case, uses <code>send</code> because the <code>logged_in?</code> method is private, and the action callback does not run in the scope of the controller. This is not the recommended way to implement this particular action callback, but in simpler cases, it might be useful.</p>

<p>Specifically for <code>around_action</code>, the block also yields in the <code>action</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_around_action'>around_action</span> { <span class='op'>|</span><span class='id identifier rubyid__controller'>_controller</span><span class='comma'>,</span> <span class='id identifier rubyid_action'>action</span><span class='op'>|</span> <span class='id identifier rubyid_time'>time</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_action'>action</span>) }</code></pre>

<p>The second way is to use a class (actually, any object that responds to the right methods will do) to handle the callback action. This is useful in cases that are more complex and cannot be implemented in a readable and reusable way using the two other methods. As an example, you could rewrite the login action callback again to use a class:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_action'>before_action</span> <span class='const'>LoginActionCallback</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>LoginActionCallback</span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_before'>before</span>(<span class='id identifier rubyid_controller'>controller</span>)
    <span class='kw'>unless</span> <span class='id identifier rubyid_controller'>controller</span>.<span class='id identifier rubyid_send'>send</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_logged_in?'>logged_in?</span>)
      <span class='id identifier rubyid_controller'>controller</span>.<span class='id identifier rubyid_flash'>flash</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You must be logged in to access this section</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_controller'>controller</span>.<span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_controller'>controller</span>.<span class='id identifier rubyid_new_login_url'>new_login_url</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Again, this is not an ideal example for this action callback, because it&#39;s not run in the scope of the controller but gets the controller passed as an argument. The class must implement a method with the same name as the action callback, so for the <code>before_action</code> action callback, the class must implement a <code>before</code> method, and so on. The <code>around</code> method must <code>yield</code> to execute the action.</p>

<h2>Request Forgery Protection</h2>

<p>Cross-site request forgery is a type of attack in which a site tricks a user into making requests on another site, possibly adding, modifying, or deleting data on that site without the user&#39;s knowledge or permission.</p>

<p>The first step to avoid this is to make sure all &quot;destructive&quot; actions (create, update, and destroy) can only be accessed with non-GET requests. If you&#39;re following RESTful conventions you&#39;re already doing this. However, a malicious site can still send a non-GET request to your site quite easily, and that&#39;s where the request forgery protection comes in. As the name says, it protects from forged requests.</p>

<p>The way this is done is to add a non-guessable token which is only known to your server to each request. This way, if a request comes in without the proper token, it will be denied access.</p>

<p>If you generate a form like this:</p>

<pre class="code xml"><code class="xml">&lt;%= form_with model: @user do |form| %&gt;
  &lt;%= form.text_field :username %&gt;
  &lt;%= form.text_field :password %&gt;
&lt;% end %&gt;
</code></pre>

<p>You will see how the token gets added as a hidden field:</p>

<pre class="code xml"><code class="xml">&lt;form accept-charset=&quot;UTF-8&quot; action=&quot;/users/1&quot; method=&quot;post&quot;&gt;
&lt;input type=&quot;hidden&quot;
       value=&quot;67250ab105eb5ad10851c00a5621854a23af5489&quot;
       name=&quot;authenticity_token&quot;/&gt;
&lt;!-- fields --&gt;
&lt;/form&gt;
</code></pre>

<p>Rails adds this token to every form that&#39;s generated using the <a href="form_helpers.html">form helpers</a>, so most of the time you don&#39;t have to worry about it. If you&#39;re writing a form manually or need to add the token for another reason, it&#39;s available through the method <code>form_authenticity_token</code>:</p>

<p>The <code>form_authenticity_token</code> generates a valid authentication token. That&#39;s useful in places where Rails does not add it automatically, like in custom Ajax calls.</p>

<p>The <a href="security.html">Security Guide</a> has more about this, and a lot of other security-related issues that you should be aware of when developing a web application.</p>

<h2>The Request and Response Objects</h2>

<p>In every controller, there are two accessor methods pointing to the request and the response objects associated with the request cycle that is currently in execution. The <a href="https://api.rubyonrails.org/classes/ActionController/Base.html#method-i-request"><code>request</code></a> method contains an instance of <a href="https://api.rubyonrails.org/classes/ActionDispatch/Request.html"><a href="ActionDispatch/Request.html" title="ActionDispatch::Request (class)"><code>::ActionDispatch::Request</code></a></a> and the <a href="https://api.rubyonrails.org/classes/ActionController/Base.html#method-i-response"><code>response</code></a> method returns a response object representing what is going to be sent back to the client.</p>

<h3>The <code>request</code> Object</h3>

<p>The request object contains a lot of useful information about the request coming in from the client. To get a full list of the available methods, refer to the <a href="https://api.rubyonrails.org/classes/ActionDispatch/Request.html">Rails API documentation</a> and <a href="https://www.rubydoc.info/github/rack/rack/Rack/Request">Rack Documentation</a>. Among the properties that you can access on this object are:</p>

<table><thead>
<tr>
<th>Property of <code>request</code></th>
<th>Purpose</th>
</tr>
</thead><tbody>
<tr>
<td><code>host</code></td>
<td>The hostname used for this request.</td>
</tr>
<tr>
<td><code>domain(n=2)</code></td>
<td>The hostname&#39;s first <code>n</code> segments, starting from the right (the TLD).</td>
</tr>
<tr>
<td><code>format</code></td>
<td>The content type requested by the client.</td>
</tr>
<tr>
<td><code>method</code></td>
<td>The HTTP method used for the request.</td>
</tr>
<tr>
<td><code>get?</code>, <code>post?</code>, <code>patch?</code>, <code>put?</code>, <code>delete?</code>, <code>head?</code></td>
<td>Returns true if the HTTP method is GET/POST/PATCH/PUT/DELETE/HEAD.</td>
</tr>
<tr>
<td><code>headers</code></td>
<td>Returns a hash containing the headers associated with the request.</td>
</tr>
<tr>
<td><code>port</code></td>
<td>The port number (integer) used for the request.</td>
</tr>
<tr>
<td><code>protocol</code></td>
<td>Returns a string containing the protocol used plus &quot;://&quot;, for example &quot;http://&quot;.</td>
</tr>
<tr>
<td><code>query_string</code></td>
<td>The query string part of the URL, i.e., everything after &quot;?&quot;.</td>
</tr>
<tr>
<td><code>remote_ip</code></td>
<td>The IP address of the client.</td>
</tr>
<tr>
<td><code>url</code></td>
<td>The entire URL used for the request.</td>
</tr>
</tbody></table>

<h4><code>path_parameters</code>, <code>query_parameters</code>, and <code>request_parameters</code></h4>

<p>Rails collects all of the parameters sent along with the request in the <code>params</code> hash, whether they are sent as part of the query string, or the post body. The request object has three accessors that give you access to these parameters depending on where they came from. The <a href="https://api.rubyonrails.org/classes/ActionDispatch/Request.html#method-i-query_parameters"><code>query_parameters</code></a> hash contains parameters that were sent as part of the query string while the <a href="https://api.rubyonrails.org/classes/ActionDispatch/Request.html#method-i-request_parameters"><code>request_parameters</code></a> hash contains parameters sent as part of the post body. The <a href="https://api.rubyonrails.org/classes/ActionDispatch/Http/Parameters.html#method-i-path_parameters"><code>path_parameters</code></a> hash contains parameters that were recognized by the routing as being part of the path leading to this particular controller and action.</p>

<h3>The <code>response</code> Object</h3>

<p>The response object is not usually used directly, but is built up during the execution of the action and rendering of the data that is being sent back to the user, but sometimes - like in an after action callback - it can be useful to access the response directly. Some of these accessor methods also have setters, allowing you to change their values. To get a full list of the available methods, refer to the <a href="https://api.rubyonrails.org/classes/ActionDispatch/Response.html">Rails API documentation</a> and <a href="https://www.rubydoc.info/github/rack/rack/Rack/Response">Rack Documentation</a>.</p>

<table><thead>
<tr>
<th>Property of <code>response</code></th>
<th>Purpose</th>
</tr>
</thead><tbody>
<tr>
<td><code>body</code></td>
<td>This is the string of data being sent back to the client. This is most often HTML.</td>
</tr>
<tr>
<td><code>status</code></td>
<td>The HTTP status code for the response, like 200 for a successful request or 404 for file not found.</td>
</tr>
<tr>
<td><code>location</code></td>
<td>The URL the client is being redirected to, if any.</td>
</tr>
<tr>
<td><code>content_type</code></td>
<td>The content type of the response.</td>
</tr>
<tr>
<td><code>charset</code></td>
<td>The character set being used for the response. Default is &quot;utf-8&quot;.</td>
</tr>
<tr>
<td><code>headers</code></td>
<td>Headers used for the response.</td>
</tr>
</tbody></table>

<h4>Setting Custom Headers</h4>

<p>If you want to set custom headers for a response then <code>response.headers</code> is the place to do it. The headers attribute is a hash which maps header names to their values, and Rails will set some of them automatically. If you want to add or change a header, just assign it to <code>response.headers</code> this way:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_headers'>headers</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>application/pdf</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>NOTE: In the above case it would make more sense to use the <code>content_type</code> setter directly.</p>

<h2>HTTP Authentications</h2>

<p>Rails comes with three built-in HTTP authentication mechanisms:</p>

<ul>
<li>Basic Authentication</li>
<li>Digest Authentication</li>
<li>Token Authentication</li>
</ul>

<h3>HTTP Basic Authentication</h3>

<p>HTTP basic authentication is an authentication scheme that is supported by the majority of browsers and other HTTP clients. As an example, consider an administration section which will only be available by entering a username, and a password into the browser&#39;s HTTP basic dialog window. Using the built-in authentication only requires you to use one method, <a href="https://api.rubyonrails.org/classes/ActionController/HttpAuthentication/Basic/ControllerMethods/ClassMethods.html#method-i-http_basic_authenticate_with"><code>http_basic_authenticate_with</code></a>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>AdminsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='id identifier rubyid_http_basic_authenticate_with'>http_basic_authenticate_with</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>humbaba</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>password:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>5baa61e4</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<p>With this in place, you can create namespaced controllers that inherit from <code>AdminsController</code>. The action callback will thus be run for all actions in those controllers, protecting them with HTTP basic authentication.</p>

<h3>HTTP Digest Authentication</h3>

<p>HTTP digest authentication is superior to the basic authentication as it does not require the client to send an unencrypted password over the network (though HTTP basic authentication is safe over HTTPS). Using digest authentication with Rails only requires using one method, <a href="https://api.rubyonrails.org/classes/ActionController/HttpAuthentication/Digest/ControllerMethods.html#method-i-authenticate_or_request_with_http_digest"><code>authenticate_or_request_with_http_digest</code></a>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>AdminsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='const'>USERS</span> <span class='op'>=</span> { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lifo</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span> }

  <span class='id identifier rubyid_before_action'>before_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_authenticate'>authenticate</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_authenticate'>authenticate</span>
      <span class='id identifier rubyid_authenticate_or_request_with_http_digest'>authenticate_or_request_with_http_digest</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_username'>username</span><span class='op'>|</span>
        <span class='const'>USERS</span>[<span class='id identifier rubyid_username'>username</span>]
      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>As seen in the example above, the <code>authenticate_or_request_with_http_digest</code> block takes only one argument - the username. And the block returns the password. Returning <code>false</code> or <code>nil</code> from the <code>authenticate_or_request_with_http_digest</code> will cause authentication failure.</p>

<h3>HTTP Token Authentication</h3>

<p>HTTP token authentication is a scheme to enable the usage of Bearer tokens in the HTTP <code>Authorization</code> header. There are many token formats available and describing them is outside the scope of this document.</p>

<p>As an example, suppose you want to use an authentication token that has been issued in advance to perform authentication and access. Implementing token authentication with Rails only requires using one method, <a href="https://api.rubyonrails.org/classes/ActionController/HttpAuthentication/Token/ControllerMethods.html#method-i-authenticate_or_request_with_http_token"><code>authenticate_or_request_with_http_token</code></a>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>PostsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='const'>TOKEN</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>secret</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_before_action'>before_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_authenticate'>authenticate</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_authenticate'>authenticate</span>
      <span class='id identifier rubyid_authenticate_or_request_with_http_token'>authenticate_or_request_with_http_token</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_token'>token</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='op'>|</span>
        <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/SecurityUtils.html" title="ActiveSupport::SecurityUtils (module)">SecurityUtils</a></span>.<span class='id identifier rubyid_secure_compare'><a href="ActiveSupport/SecurityUtils.html#secure_compare-class_method" title="ActiveSupport::SecurityUtils.secure_compare (method)">secure_compare</a></span>(<span class='id identifier rubyid_token'>token</span><span class='comma'>,</span> <span class='const'>TOKEN</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>As seen in the example above, the <code>authenticate_or_request_with_http_token</code> block takes two arguments - the token and a <a href="Hash.html" title="Hash (class)"><code>Hash</code></a> containing the options that were parsed from the HTTP <code>Authorization</code> header. The block should return <code>true</code> if the authentication is successful. Returning <code>false</code> or <code>nil</code> on it will cause an authentication failure.</p>

<h2>Streaming and File Downloads</h2>

<p>Sometimes you may want to send a file to the user instead of rendering an HTML page. All controllers in Rails have the <a href="https://api.rubyonrails.org/classes/ActionController/DataStreaming.html#method-i-send_data"><code>send_data</code></a> and the <a href="https://api.rubyonrails.org/classes/ActionController/DataStreaming.html#method-i-send_file"><code>send_file</code></a> methods, which will both stream data to the client. <code>send_file</code> is a convenience method that lets you provide the name of a file on the disk, and it will stream the contents of that file for you.</p>

<p>To stream data to the client, use <code>send_data</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prawn</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>class</span> <span class='const'>ClientsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># Generates a PDF document with information on the client and
</span>  <span class='comment'># returns it. The user will get the PDF as a file download.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_download_pdf'>download_pdf</span>
    <span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='id identifier rubyid_generate_pdf'>generate_pdf</span>(<span class='id identifier rubyid_client'>client</span>)<span class='comma'>,</span>
              <span class='label'>filename:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>.pdf</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
              <span class='label'>type:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>application/pdf</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_generate_pdf'>generate_pdf</span>(<span class='id identifier rubyid_client'>client</span>)
      <span class='const'>Prawn</span><span class='op'>::</span><span class='const'>Document</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_text'>text</span> <span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>align:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_center'>center</span>
        <span class='id identifier rubyid_text'>text</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Address: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_text'>text</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Email: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>.<span class='id identifier rubyid_render'>render</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The <code>download_pdf</code> action in the example above will call a private method which actually generates the PDF document and returns it as a string. This string will then be streamed to the client as a file download, and a filename will be suggested to the user. Sometimes when streaming files to the user, you may not want them to download the file. Take images, for example, which can be embedded into HTML pages. To tell the browser a file is not meant to be downloaded, you can set the <code>:disposition</code> option to &quot;inline&quot;. The opposite and default value for this option is &quot;attachment&quot;.</p>

<h3>Sending Files</h3>

<p>If you want to send a file that already exists on disk, use the <code>send_file</code> method.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ClientsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># Stream a file that has already been generated and stored on disk.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_download_pdf'>download_pdf</span>
    <span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])
    <span class='id identifier rubyid_send_file'>send_file</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_root'><a href="Rails.html#root-class_method" title="Rails.root (method)">root</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>/files/clients/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'>.pdf</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
              <span class='label'>filename:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_client'>client</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>.pdf</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
              <span class='label'>type:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>application/pdf</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>This will read and stream the file 4 kB at the time, avoiding loading the entire file into memory at once. You can turn off streaming with the <code>:stream</code> option or adjust the block size with the <code>:buffer_size</code> option.</p>

<p>If <code>:type</code> is not specified, it will be guessed from the file extension specified in <code>:filename</code>. If the content-type is not registered for the extension, <code>application/octet-stream</code> will be used.</p>

<p>WARNING: Be careful when using data coming from the client (params, cookies, etc.) to locate the file on disk, as this is a security risk that might allow someone to gain access to files they are not meant to.</p>

<p>TIP: It is not recommended that you stream static files through Rails if you can instead keep them in a public folder on your web server. It is much more efficient to let the user download the file directly using Apache or another web server, keeping the request from unnecessarily going through the whole Rails stack.</p>

<h3>RESTful Downloads</h3>

<p>While <code>send_data</code> works just fine, if you are creating a RESTful application having separate actions for file downloads is usually not necessary. In REST terminology, the PDF file from the example above can be considered just another representation of the client resource. Rails provides a slick way of doing &quot;RESTful&quot; downloads. Here&#39;s how you can rewrite the example so that the PDF download is a part of the <code>show</code> action, without any streaming:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ClientsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># The user can request to receive this resource as HTML or PDF.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
    <span class='ivar'>@client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])

    <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_html'>html</span>
      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_pdf'>pdf</span> { <span class='id identifier rubyid_render'>render</span> <span class='label'>pdf:</span> <span class='id identifier rubyid_generate_pdf'>generate_pdf</span>(<span class='ivar'>@client</span>) }
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>You can call any method on <code>format</code> that is an extension registered as a MIME type by Rails.
Rails already registers common MIME types like <code>&quot;text/html&quot;</code> and <code>&quot;application/pdf&quot;</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mime.html" title="Mime (module)">Mime</a></span><span class='op'>::</span><span class='const'><a href="Mime/Type.html" title="Mime::Type (class)">Type</a></span>.<span class='id identifier rubyid_lookup_by_extension'><a href="Mime/Type.html#lookup_by_extension-class_method" title="Mime::Type.lookup_by_extension (method)">lookup_by_extension</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_pdf'>pdf</span>)
<span class='comment'># =&gt; &quot;application/pdf&quot;</span></code></pre>

<p>If you need additional MIME types, call <a href="https://api.rubyonrails.org/classes/Mime/Type.html#method-c-register"><a href="Mime/Type.html#register-class_method" title="Mime::Type.register (method)">Mime::Type.register</a></a> in the file <code>config/initializers/mime_types.rb</code>. For example, this is how you would register the Rich Text Format (RTF):</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Mime.html" title="Mime (module)">Mime</a></span><span class='op'>::</span><span class='const'><a href="Mime/Type.html" title="Mime::Type (class)">Type</a></span>.<span class='id identifier rubyid_register'><a href="Mime/Type.html#register-class_method" title="Mime::Type.register (method)">register</a></span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>application/rtf</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_rtf'>rtf</span>)</code></pre>

<p>NOTE: Configuration files are not reloaded on each request, so you have to restart the server for their changes to take effect.</p>

<p>Now the user can request to get a PDF version of a client just by adding &quot;.pdf&quot; to the URL:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>GET</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>clients</span><span class='regexp_end'>/</span></span><span class='int'>1</span>.<span class='id identifier rubyid_pdf'>pdf</span></code></pre>

<h3>Live Streaming of Arbitrary Data</h3>

<p>Rails allows you to stream more than just files. In fact, you can stream anything
you would like in a response object. The <a href="https://api.rubyonrails.org/classes/ActionController/Live.html"><a href="ActionController/Live.html" title="ActionController::Live (module)"><code>::ActionController::Live</code></a></a> module allows
you to create a persistent connection with a browser. Using this module, you will
be able to send arbitrary data to the browser at specific points in time.</p>

<h4>Incorporating Live Streaming</h4>

<p>Including <a href="ActionController/Live.html" title="ActionController::Live (module)"><code>::ActionController::Live</code></a> inside of your controller class will provide
all actions inside the controller the ability to stream data. You can mix in
the module like so:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MyController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Live.html" title="ActionController::Live (module)">Live</a></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_stream'>stream</span>
    <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_headers'>headers</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/event-stream</span><span class='tstring_end'>&#39;</span></span>
    <span class='int'>100</span>.<span class='id identifier rubyid_times'>times</span> {
      <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_stream'>stream</span>.<span class='id identifier rubyid_write'>write</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello world\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_sleep'>sleep</span> <span class='int'>1</span>
    }
  <span class='kw'>ensure</span>
    <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_stream'>stream</span>.<span class='id identifier rubyid_close'>close</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The above code will keep a persistent connection with the browser and send 100
messages of <code>&quot;hello world\n&quot;</code>, each one second apart.</p>

<p>There are a couple of things to notice in the above example. We need to make
sure to close the response stream. Forgetting to close the stream will leave
the socket open forever. We also have to set the content type to <code>text/event-stream</code>
before we write to the response stream. This is because headers cannot be written
after the response has been committed (when <code>response.committed?</code> returns a truthy
value), which occurs when you <code>write</code> or <code>commit</code> the response stream.</p>

<h4>Example Usage</h4>

<p>Let&#39;s suppose that you were making a Karaoke machine, and a user wants to get the
lyrics for a particular song. Each <code>Song</code> has a particular number of lines and
each line takes time <code>num_beats</code> to finish singing.</p>

<p>If we wanted to return the lyrics in Karaoke fashion (only sending the line when
the singer has finished the previous line), then we could use <a href="ActionController/Live.html" title="ActionController::Live (module)"><code>::ActionController::Live</code></a>
as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>LyricsController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Live.html" title="ActionController::Live (module)">Live</a></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
    <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_headers'>headers</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/event-stream</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_song'>song</span> <span class='op'>=</span> <span class='const'>Song</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])

    <span class='id identifier rubyid_song'>song</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span>
      <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_stream'>stream</span>.<span class='id identifier rubyid_write'>write</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_lyrics'>lyrics</span>
      <span class='id identifier rubyid_sleep'>sleep</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_num_beats'>num_beats</span>
    <span class='kw'>end</span>
  <span class='kw'>ensure</span>
    <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_stream'>stream</span>.<span class='id identifier rubyid_close'>close</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The above code sends the next line only after the singer has completed the previous
line.</p>

<h4>Streaming Considerations</h4>

<p>Streaming arbitrary data is an extremely powerful tool. As shown in the previous
examples, you can choose when and what to send across a response stream. However,
you should also note the following things:</p>

<ul>
<li>Each response stream creates a new thread and copies over the thread local
variables from the original thread. Having too many thread local variables can
negatively impact performance. Similarly, a large number of threads can also
hinder performance.</li>
<li>Failing to close the response stream will leave the corresponding socket open
forever. Make sure to call <code>close</code> whenever you are using a response stream.</li>
<li>WEBrick servers buffer all responses, and so including <a href="ActionController/Live.html" title="ActionController::Live (module)"><code>::ActionController::Live</code></a>
will not work. You must use a web server which does not automatically buffer
responses.</li>
</ul>

<h2>Log Filtering</h2>

<p>Rails keeps a log file for each environment in the <code>log</code> folder. These are extremely useful when debugging what&#39;s actually going on in your application, but in a live application you may not want every bit of information to be stored in the log file.</p>

<h3>Parameters Filtering</h3>

<p>You can filter out sensitive request parameters from your log files by
appending them to <a href="configuring.html#config-filter-parameters"><code>config.filter_parameters</code></a> in the application configuration.
These parameters will be marked [FILTERED] in the log.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_filter_parameters'>filter_parameters</span> <span class='op'>&lt;&lt;</span> <span class='symbeg'>:</span><span class='id identifier rubyid_password'>password</span></code></pre>

<p>NOTE: Provided parameters will be filtered out by partial matching regular
expression. Rails adds a list of default filters, including <code>:passw</code>,
<code>:secret</code>, and <code>:token</code>, in the appropriate initializer
(<code>initializers/filter_parameter_logging.rb</code>) to handle typical application
parameters like <code>password</code>, <code>password_confirmation</code> and <code>my_token</code>.</p>

<h3>Redirects Filtering</h3>

<p>Sometimes it&#39;s desirable to filter out from log files some sensitive locations your application is redirecting to.
You can do that by using the <code>config.filter_redirect</code> configuration option:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_filter_redirect'>filter_redirect</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>s3.amazonaws.com</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>You can set it to a String, a Regexp, or an array of both.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_filter_redirect'>filter_redirect</span>.<span class='id identifier rubyid_concat'>concat</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>s3.amazonaws.com</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>private_path</span><span class='regexp_end'>/</span></span>]</code></pre>

<p>Matching URLs will be replaced with &#39;[FILTERED]&#39;. However, if you only wish to filter the parameters, not the whole URLs,
please take a look at <a href="#parameters-filtering">Parameters Filtering</a>.</p>

<h2>Rescue</h2>

<p>Most likely your application is going to contain bugs or otherwise throw an exception that needs to be handled. For example, if the user follows a link to a resource that no longer exists in the database, Active Record will throw the <a href="ActiveRecord/RecordNotFound.html" title="ActiveRecord::RecordNotFound (class)"><code>::ActiveRecord::RecordNotFound</code></a> exception.</p>

<p>Rails default exception handling displays a &quot;500 Server Error&quot; message for all exceptions. If the request was made locally, a nice traceback and some added information gets displayed, so you can figure out what went wrong and deal with it. If the request was remote Rails will just display a simple &quot;500 Server Error&quot; message to the user, or a &quot;404 Not Found&quot; if there was a routing error, or a record could not be found. Sometimes you might want to customize how these errors are caught and how they&#39;re displayed to the user. There are several levels of exception handling available in a Rails application:</p>

<h3>The Default 500 and 404 Templates</h3>

<p>By default, in the production environment the application will render either a 404, or a 500 error message. In the development environment all unhandled exceptions are simply raised. These messages are contained in static HTML files in the public folder, in <code>404.html</code> and <code>500.html</code> respectively. You can customize these files to add some extra information and style, but remember that they are static HTML; i.e. you can&#39;t use ERB, SCSS, CoffeeScript, or layouts for them.</p>

<h3><code>rescue_from</code></h3>

<p>If you want to do something a bit more elaborate when catching errors, you can use <a href="https://api.rubyonrails.org/classes/ActiveSupport/Rescuable/ClassMethods.html#method-i-rescue_from"><code>rescue_from</code></a>, which handles exceptions of a certain type (or multiple types) in an entire controller and its subclasses.</p>

<p>When an exception occurs which is caught by a <code>rescue_from</code> directive, the exception object is passed to the handler. The handler can be a method or a <code>Proc</code> object passed to the <code>:with</code> option. You can also use a block directly instead of an explicit <code>Proc</code> object.</p>

<p>Here&#39;s how you can use <code>rescue_from</code> to intercept all <a href="ActiveRecord/RecordNotFound.html" title="ActiveRecord::RecordNotFound (class)"><code>::ActiveRecord::RecordNotFound</code></a> errors and do something with them.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_rescue_from'>rescue_from</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/RecordNotFound.html" title="ActiveRecord::RecordNotFound (class)">RecordNotFound</a></span><span class='comma'>,</span> <span class='label'>with:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_record_not_found'>record_not_found</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_record_not_found'>record_not_found</span>
      <span class='id identifier rubyid_render'>render</span> <span class='label'>plain:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>404 Not Found</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>status:</span> <span class='int'>404</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Of course, this example is anything but elaborate and doesn&#39;t improve on the default exception handling at all, but once you can catch all those exceptions you&#39;re free to do whatever you want with them. For example, you could create custom exception classes that will be thrown when a user doesn&#39;t have access to a certain section of your application:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationController</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Base.html" title="ActionController::Base (class)">Base</a></span>
  <span class='id identifier rubyid_rescue_from'>rescue_from</span> <span class='const'>User</span><span class='op'>::</span><span class='const'>NotAuthorized</span><span class='comma'>,</span> <span class='label'>with:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user_not_authorized'>user_not_authorized</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_user_not_authorized'>user_not_authorized</span>
      <span class='id identifier rubyid_flash'>flash</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_error'>error</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You don&#39;t have access to this section.</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_redirect_back'>redirect_back</span>(<span class='label'>fallback_location:</span> <span class='id identifier rubyid_root_path'>root_path</span>)
    <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>ClientsController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># Check that the user has the right authorization to access clients.
</span>  <span class='id identifier rubyid_before_action'>before_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_check_authorization'>check_authorization</span>

  <span class='comment'># Note how the actions don&#39;t have to worry about all the auth stuff.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit'>edit</span>
    <span class='ivar'>@client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># If the user is not authorized, just throw the exception.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_check_authorization'>check_authorization</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>User</span><span class='op'>::</span><span class='const'>NotAuthorized</span> <span class='kw'>unless</span> <span class='id identifier rubyid_current_user'>current_user</span>.<span class='id identifier rubyid_admin?'>admin?</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>WARNING: Using <code>rescue_from</code> with <a href="Exception.html" title="Exception (class)"><code>Exception</code></a> or <code>StandardError</code> would cause serious side-effects as it prevents Rails from handling exceptions properly. As such, it is not recommended to do so unless there is a strong reason.</p>

<p>NOTE: When running in the production environment, all
<a href="ActiveRecord/RecordNotFound.html" title="ActiveRecord::RecordNotFound (class)"><code>::ActiveRecord::RecordNotFound</code></a> errors render the 404 error page. Unless you need
a custom behavior you don&#39;t need to handle this.</p>

<p>NOTE: Certain exceptions are only rescuable from the <code>ApplicationController</code> class, as they are raised before the controller gets initialized, and the action gets executed.</p>

<h2>Force HTTPS Protocol</h2>

<p>If you&#39;d like to ensure that communication to your controller is only possible
via HTTPS, you should do so by enabling the <a href="https://api.rubyonrails.org/classes/ActionDispatch/SSL.html"><a href="ActionDispatch/SSL.html" title="ActionDispatch::SSL (class)"><code>::ActionDispatch::SSL</code></a></a> middleware via
<a href="configuring.html#config-force-ssl"><code>config.force_ssl</code></a> in your environment configuration.</p>

<h2>Built-in Health Check Endpoint</h2>

<p>Rails also comes with a built-in health check endpoint that is reachable at the <code>/up</code> path. This endpoint will return a 200 status code if the app has booted with no exceptions, and a 500 status code otherwise.</p>

<p>In production, many applications are required to report their status upstream, whether it&#39;s to an uptime monitor that will page an engineer when things go wrong, or a load balancer or Kubernetes controller used to determine a pod&#39;s health. This health check is designed to be a one-size fits all that will work in many situations.</p>

<p>While any newly generated Rails applications will have the health check at <code>/up</code>, you can configure the path to be anything you&#39;d like in your &quot;config/routes.rb&quot;:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_routes'>routes</span>.<span class='id identifier rubyid_draw'>draw</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>healthz</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rails/health#show</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_rails_health_check'>rails_health_check</span>
<span class='kw'>end</span></code></pre>

<p>The health check will now be accessible via the <code>/healthz</code> path.</p>

<p>NOTE: This endpoint does not reflect the status of all of your application&#39;s dependencies, such as the database or redis cluster. Replace &quot;rails/health#show&quot; with your own controller action if you have application specific needs.</p>

<p>Think carefully about what you want to check as it can lead to situations where your application is being restarted due to a third-party service going bad. Ideally, you should design your application to handle those outages gracefully.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>