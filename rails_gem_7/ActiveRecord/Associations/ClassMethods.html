<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ActiveRecord::Associations::ClassMethods &mdash; Rails 7.2.3</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::Associations::ClassMethods",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Rails 7.2.3</a> &raquo; 
      <a href='../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
        <a class='nodoc' href="../Associations.html" title="ActiveRecord::Associations (module)">Associations</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ClassMethods&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: ActiveRecord::Associations::ClassMethods</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/v7.2.3/activerecord/lib/active_record/associations.rb#L1010'>activerecord/lib/active_record/associations.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Associations are a set of macro-like class methods for tying objects together through foreign keys. They express relationships like “Project has one Project Manager” or “Project belongs to a Portfolio”. Each macro adds a number of methods to the class which are specialized according to the collection or association symbol and the options hash. It works much the same way as Ruby’s own <code>attr*</code> methods.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Project</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span>              <span class='symbeg'>:</span><span class='id identifier rubyid_portfolio'>portfolio</span>
  <span class='id identifier rubyid_has_one'><a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">has_one</a></span>                 <span class='symbeg'>:</span><span class='id identifier rubyid_project_manager'>project_manager</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span>                <span class='symbeg'>:</span><span class='id identifier rubyid_milestones'>milestones</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'><a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">has_and_belongs_to_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_categories'>categories</span>
<span class='kw'>end</span></code></pre>

<p>The project class now has the following methods (and more) to ease the traversal and manipulation of its relationships:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_project'>project</span> <span class='op'>=</span> <span class='const'>Project</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_portfolio'>portfolio</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_portfolio'>portfolio</span> <span class='op'>=</span> <span class='const'>Portfolio</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_reload_portfolio'>reload_portfolio</span>

<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_project_manager'>project_manager</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_project_manager'>project_manager</span> <span class='op'>=</span> <span class='const'>ProjectManager</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_reload_project_manager'>reload_project_manager</span>

<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>.<span class='id identifier rubyid_empty?'>empty?</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>.<span class='id identifier rubyid_size'>size</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span> <span class='op'>&lt;&lt;</span> <span class='const'>Milestone</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='const'>Milestone</span>.<span class='id identifier rubyid_first'>first</span>)
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>.<span class='id identifier rubyid_destroy'>destroy</span>(<span class='const'>Milestone</span>.<span class='id identifier rubyid_first'>first</span>)
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>.<span class='id identifier rubyid_find'>find</span>(<span class='const'>Milestone</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_id'>id</span>)
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>.<span class='id identifier rubyid_build'>build</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>.<span class='id identifier rubyid_create'>create</span>

<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_categories'>categories</span>.<span class='id identifier rubyid_empty?'>empty?</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_categories'>categories</span>.<span class='id identifier rubyid_size'>size</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_categories'>categories</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_categories'>categories</span> <span class='op'>&lt;&lt;</span> <span class='const'>Category</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_categories'>categories</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_category1'>category1</span>)
<span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_categories'>categories</span>.<span class='id identifier rubyid_destroy'>destroy</span>(<span class='id identifier rubyid_category1'>category1</span>)</code></pre>

<h4 id="label-A+word+of+warning">A word of warning</h4>

<p>Don’t create associations that have the same name as <a href="../Core.html" title="ActiveRecord::Core (module)">instance methods</a> of <a href="../Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a>. Since the association adds a method with that name to its model, using an association with the same name as one provided by <a href="../Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> will override the method inherited through <a href="../Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> and will break things. For instance, <code>attributes</code> and <code>connection</code> would be bad choices for association names, because those names already exist in the list of <a href="../Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> instance methods.</p>

<h3 id="label-Auto-generated+methods">Auto-generated methods</h3>

<p>See also “Instance Public methods” below ( from <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> ) for more details.</p>

<h4 id="label-Singular+associations+-28one-to-one-29">Singular associations (one-to-one)</h4>

<pre class="code ruby"><code class="ruby">                                  <span class='op'>|</span>            <span class='op'>|</span>  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span>  <span class='op'>|</span>
<span class='id identifier rubyid_generated'>generated</span> <span class='id identifier rubyid_methods'>methods</span>                 <span class='op'>|</span> <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='op'>|</span> <span class='symbeg'>:</span><span class='id identifier rubyid_polymorphic'>polymorphic</span> <span class='op'>|</span> <span class='id identifier rubyid_has_one'><a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">has_one</a></span>
<span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>+</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span>
<span class='id identifier rubyid_other'>other</span>                             <span class='op'>|</span>     <span class='const'>X</span>      <span class='op'>|</span>      <span class='const'>X</span>       <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_other'>other</span><span class='op'>=</span>(<span class='id identifier rubyid_other'>other</span>)                     <span class='op'>|</span>     <span class='const'>X</span>      <span class='op'>|</span>      <span class='const'>X</span>       <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_build_other'>build_other</span>(<span class='id identifier rubyid_attributes'>attributes</span><span class='op'>=</span>{})        <span class='op'>|</span>     <span class='const'>X</span>      <span class='op'>|</span>              <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_create_other'>create_other</span>(<span class='id identifier rubyid_attributes'>attributes</span><span class='op'>=</span>{})       <span class='op'>|</span>     <span class='const'>X</span>      <span class='op'>|</span>              <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_create_other!'>create_other!</span>(<span class='id identifier rubyid_attributes'>attributes</span><span class='op'>=</span>{})      <span class='op'>|</span>     <span class='const'>X</span>      <span class='op'>|</span>              <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_reload_other'>reload_other</span>                      <span class='op'>|</span>     <span class='const'>X</span>      <span class='op'>|</span>      <span class='const'>X</span>       <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_other_changed?'>other_changed?</span>                    <span class='op'>|</span>     <span class='const'>X</span>      <span class='op'>|</span>      <span class='const'>X</span>       <span class='op'>|</span>
<span class='id identifier rubyid_other_previously_changed?'>other_previously_changed?</span>         <span class='op'>|</span>     <span class='const'>X</span>      <span class='op'>|</span>      <span class='const'>X</span>       <span class='op'>|</span></code></pre>

<h4 id="label-Collection+associations+-28one-to-many+-2F+many-to-many-29">Collection associations (one-to-many / many-to-many)</h4>

<pre class="code ruby"><code class="ruby">                                  <span class='op'>|</span>       <span class='op'>|</span>          <span class='op'>|</span> <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span>
<span class='id identifier rubyid_generated'>generated</span> <span class='id identifier rubyid_methods'>methods</span>                 <span class='op'>|</span> <span class='id identifier rubyid_habtm'>habtm</span> <span class='op'>|</span> <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='op'>|</span> <span class='symbeg'>:</span><span class='id identifier rubyid_through'>through</span>
<span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>+</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span>
<span class='id identifier rubyid_others'>others</span>                            <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span><span class='op'>=</span>(<span class='id identifier rubyid_other'>other</span><span class='comma'>,</span><span class='id identifier rubyid_other'>other</span><span class='comma'>,</span><span class='op'>...</span>)          <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_other_ids'>other_ids</span>                         <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_other_ids'>other_ids</span><span class='op'>=</span>(<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span><span class='op'>...</span>)             <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span><span class='op'>&lt;&lt;</span>                          <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_push'>push</span>                       <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_concat'>concat</span>                     <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_build'>build</span>(<span class='id identifier rubyid_attributes'>attributes</span><span class='op'>=</span>{})       <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_create'>create</span>(<span class='id identifier rubyid_attributes'>attributes</span><span class='op'>=</span>{})      <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='id identifier rubyid_attributes'>attributes</span><span class='op'>=</span>{})     <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_size'>size</span>                       <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_length'>length</span>                     <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_count'>count</span>                      <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_sum'>sum</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)                 <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_empty?'>empty?</span>                     <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_clear'>clear</span>                      <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_other'>other</span><span class='comma'>,</span><span class='id identifier rubyid_other'>other</span><span class='comma'>,</span><span class='op'>...</span>)    <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_delete_all'>delete_all</span>                 <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_destroy'>destroy</span>(<span class='id identifier rubyid_other'>other</span><span class='comma'>,</span><span class='id identifier rubyid_other'>other</span><span class='comma'>,</span><span class='op'>...</span>)   <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_destroy_all'>destroy_all</span>                <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_find'>find</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)                <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_exists?'>exists?</span>                    <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_distinct'>distinct</span>                   <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_reset'>reset</span>                      <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span>
<span class='id identifier rubyid_others'>others</span>.<span class='id identifier rubyid_reload'>reload</span>                     <span class='op'>|</span>   <span class='const'>X</span>   <span class='op'>|</span>    <span class='const'>X</span>     <span class='op'>|</span>    <span class='const'>X</span></code></pre>

<h4 id="label-Overriding+generated+methods">Overriding generated methods</h4>

<p><a href="Association.html" title="ActiveRecord::Associations::Association (class)"><code>Association</code></a> methods are generated in a module included into the model class, making overrides easy. The original generated method can thus be called with <code>super</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Car</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_owner'>owner</span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_old_owner'>old_owner</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_owner='>owner=</span>(<span class='id identifier rubyid_new_owner'>new_owner</span>)
    <span class='kw'>self</span>.<span class='id identifier rubyid_old_owner'>old_owner</span> <span class='op'>=</span> <span class='kw'>self</span>.<span class='id identifier rubyid_owner'>owner</span>
    <span class='kw'>super</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The association methods module is included immediately after the generated attributes methods module, meaning an association will override the methods for an attribute with the same name.</p>

<h3 id="label-Cardinality+and+associations">Cardinality and associations</h3>

<p>Active Record associations can be used to describe one-to-one, one-to-many, and many-to-many relationships between models. Each model uses an association to describe its role in the relation. The <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> association is always used in the model that has the foreign key.</p>

<h4 id="label-One-to-one">One-to-one</h4>

<p>Use <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a> in the base, and <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> in the associated model.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Employee</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_one'><a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">has_one</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_office'>office</span>
<span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Office</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_employee'>employee</span>    <span class='comment'># foreign key - employee_id
</span><span class='kw'>end</span></code></pre>

<h4 id="label-One-to-many">One-to-many</h4>

<p>Use <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> in the base, and <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> in the associated model.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Manager</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_employees'>employees</span>
<span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Employee</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_manager'>manager</span>     <span class='comment'># foreign key - manager_id
</span><span class='kw'>end</span></code></pre>

<h4 id="label-Many-to-many">Many-to-many</h4>

<p>There are two ways to build a many-to-many relationship.</p>

<p>The first way uses a <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> association with the <code>:through</code> option and a join model, so there are two stages of associations.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Assignment</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_programmer'>programmer</span>  <span class='comment'># foreign key - programmer_id
</span>  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_project'>project</span>     <span class='comment'># foreign key - project_id
</span><span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Programmer</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_assignments'>assignments</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_projects'>projects</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_assignments'>assignments</span>
<span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Project</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_assignments'>assignments</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_programmers'>programmers</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_assignments'>assignments</span>
<span class='kw'>end</span></code></pre>

<p>For the second way, use <a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">#has_and_belongs_to_many</a> in both models. This requires a join table that has no corresponding model or primary key.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Programmer</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'><a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">has_and_belongs_to_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_projects'>projects</span>       <span class='comment'># foreign keys in the join table
</span><span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Project</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'><a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">has_and_belongs_to_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_programmers'>programmers</span>    <span class='comment'># foreign keys in the join table
</span><span class='kw'>end</span></code></pre>

<p>Choosing which way to build a many-to-many relationship is not always simple. If you need to work with the relationship model as its own entity, use <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> <code>:through</code>. Use <a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">#has_and_belongs_to_many</a> when working with legacy schemas or when you never work directly with the relationship itself.</p>

<h3 id="label-Is+it+a+-7B-23belongs_to-7D+or+-7B-23has_one-7D+association-3F">Is it a <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> or <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a> association?</h3>

<p>Both express a 1-1 relationship. The difference is mostly where to place the foreign key, which goes on the table for the class declaring the <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> relationship.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='comment'># I reference an account.
</span>  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_account'>account</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='comment'># One user references me.
</span>  <span class='id identifier rubyid_has_one'><a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">has_one</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>
<span class='kw'>end</span></code></pre>

<p>The tables for these classes could look something like:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>CREATE</span> <span class='const'>TABLE</span> <span class='id identifier rubyid_users'>users</span> (
  <span class='id identifier rubyid_id'>id</span> <span class='id identifier rubyid_bigint'>bigint</span> <span class='const'>NOT</span> <span class='const'>NULL</span> <span class='id identifier rubyid_auto_increment'>auto_increment</span><span class='comma'>,</span>
  <span class='id identifier rubyid_account_id'>account_id</span> <span class='id identifier rubyid_bigint'>bigint</span> <span class='id identifier rubyid_default'>default</span> <span class='const'>NULL</span><span class='comma'>,</span>
  <span class='id identifier rubyid_name'>name</span> <span class='id identifier rubyid_varchar'>varchar</span> <span class='id identifier rubyid_default'>default</span> <span class='const'>NULL</span><span class='comma'>,</span>
  <span class='const'>PRIMARY</span> <span class='const'>KEY</span>  (<span class='id identifier rubyid_id'>id</span>)
)

<span class='const'>CREATE</span> <span class='const'>TABLE</span> <span class='id identifier rubyid_accounts'>accounts</span> (
  <span class='id identifier rubyid_id'>id</span> <span class='id identifier rubyid_bigint'>bigint</span> <span class='const'>NOT</span> <span class='const'>NULL</span> <span class='id identifier rubyid_auto_increment'>auto_increment</span><span class='comma'>,</span>
  <span class='id identifier rubyid_name'>name</span> <span class='id identifier rubyid_varchar'>varchar</span> <span class='id identifier rubyid_default'>default</span> <span class='const'>NULL</span><span class='comma'>,</span>
  <span class='const'>PRIMARY</span> <span class='const'>KEY</span>  (<span class='id identifier rubyid_id'>id</span>)
)</code></pre>

<h3 id="label-Unsaved+objects+and+associations">Unsaved objects and associations</h3>

<p>You can manipulate objects and associations before they are saved to the database, but there is some special behavior you should be aware of, mostly involving the saving of associated objects.</p>

<p>You can set the <code>:autosave</code> option on a <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a>, <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a>, <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a>, or <a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">#has_and_belongs_to_many</a> association. Setting it to <code>true</code> will <em>always</em> save the members, whereas setting it to <code>false</code> will <em>never</em> save the members. More details about <code>:autosave</code> option is available at <a href="../AutosaveAssociation.html" title="ActiveRecord::AutosaveAssociation (module)"><code>::ActiveRecord::AutosaveAssociation</code></a>.</p>

<h4 id="label-One-to-one+associations">One-to-one associations</h4>
<ul><li>
<p>Assigning an object to a <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a> association automatically saves that object and the object being replaced (if there is one), in order to update their foreign keys - except if the parent object is unsaved (<code>new_record? == true</code>).</p>
</li><li>
<p>If either of these saves fail (due to one of the objects being invalid), an ActiveRecord::RecordNotSaved exception is raised and the assignment is cancelled.</p>
</li><li>
<p>If you wish to assign an object to a <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a> association without saving it, use the <code>#build_association</code> method (documented below). The object being replaced will still be saved to update its foreign key.</p>
</li><li>
<p>Assigning an object to a <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> association does not save the object, since the foreign key field belongs on the parent. It does not save the parent either.</p>
</li></ul>

<h4 id="label-Collections">Collections</h4>
<ul><li>
<p>Adding an object to a collection (#has_many or <a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">#has_and_belongs_to_many</a>) automatically saves that object, except if the parent object (the owner of the collection) is not yet stored in the database.</p>
</li><li>
<p>If saving any of the objects being added to a collection (via <code>push</code> or similar) fails, then <code>push</code> returns <code>false</code>.</p>
</li><li>
<p>If saving fails while replacing the collection (via <code>association=</code>), an ActiveRecord::RecordNotSaved exception is raised and the assignment is cancelled.</p>
</li><li>
<p>You can add an object to a collection without automatically saving it by using the <code>collection.build</code> method (documented below).</p>
</li><li>
<p>All unsaved (<code>new_record? == true</code>) members of the collection are automatically saved when the parent is saved.</p>
</li></ul>

<h3 id="label-Customizing+the+query">Customizing the query</h3>

<p>Associations are built from <a href="../Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a> objects, and you can use the <a href="../Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a> syntax to customize them. For example, to add a condition:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Blog</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_published_posts'>published_posts</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>published:</span> <span class='kw'>true</span>) }<span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Post</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></code></pre>

<p>Inside the <code>-&gt; { ... }</code> block you can use all of the usual <a href="../Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a> methods.</p>

<h4 id="label-Accessing+the+owner+object">Accessing the owner object</h4>

<p>Sometimes it is useful to have access to the owner object when building the query. The owner is passed as a parameter to the block. For example, the following association would find all events that occur on the user’s birthday:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_birthday_events'>birthday_events</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_user'>user</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>starts_on:</span> <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_birthday'>birthday</span>) }<span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Event</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></code></pre>

<p>Note: Joining or eager loading such associations is not possible because those operations happen before instance creation. Such associations <em>can</em> be preloaded, but doing so will perform N+1 queries because there will be a different scope for each record (similar to preloading polymorphic scopes).</p>

<h3 id="label-Association+callbacks">Association callbacks</h3>

<p>Similar to the normal callbacks that hook into the life cycle of an Active Record object, you can also define callbacks that get triggered when you add an object to or remove an object from an association collection.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Firm</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_clients'>clients</span><span class='comma'>,</span>
           <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy'>destroy</span><span class='comma'>,</span>
           <span class='label'>after_add:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_congratulate_client'>congratulate_client</span><span class='comma'>,</span>
           <span class='label'>after_remove:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_after_remove'>log_after_remove</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_congratulate_client'>congratulate_client</span>(<span class='id identifier rubyid_record'>record</span>)
    <span class='comment'># ...
</span>  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_log_after_remove'>log_after_remove</span>(<span class='id identifier rubyid_record'>record</span>)
    <span class='comment'># ...
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>It’s possible to stack callbacks by passing them as an array. Example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Firm</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_clients'>clients</span><span class='comma'>,</span>
           <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy'>destroy</span><span class='comma'>,</span>
           <span class='label'>after_add:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_congratulate_client'>congratulate_client</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> (<span class='id identifier rubyid_firm'>firm</span><span class='comma'>,</span> <span class='id identifier rubyid_record'>record</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_log'>log</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>after_adding</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_record'>record</span>.<span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> }]<span class='comma'>,</span>
           <span class='label'>after_remove:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_log_after_remove'>log_after_remove</span>
<span class='kw'>end</span></code></pre>

<p>Possible callbacks are: <code>before_add</code>, <code>after_add</code>, <code>before_remove</code>, and <code>after_remove</code>.</p>

<p>If any of the <code>before_add</code> callbacks throw an exception, the object will not be added to the collection.</p>

<p>Similarly, if any of the <code>before_remove</code> callbacks throw an exception, the object will not be removed from the collection.</p>

<p>Note: To trigger remove callbacks, you must use <code>destroy</code> / <code>destroy_all</code> methods. For example:</p>
<ul><li>
<p><code>firm.clients.destroy(client)</code></p>
</li><li>
<p><code>firm.clients.destroy(*clients)</code></p>
</li><li>
<p><code>firm.clients.destroy_all</code></p>
</li></ul>

<p><code>delete</code> / <code>delete_all</code> methods like the following do <strong>not</strong> trigger remove callbacks:</p>
<ul><li>
<p><code>firm.clients.delete(client)</code></p>
</li><li>
<p><code>firm.clients.delete(*clients)</code></p>
</li><li>
<p><code>firm.clients.delete_all</code></p>
</li></ul>

<h3 id="label-Association+extensions">Association extensions</h3>

<p>The proxy objects that control the access to associations can be extended through anonymous modules. This is especially beneficial for adding new finders, creators, and other factory-type methods that are only used as part of this association.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_people'>people</span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_find_or_create_by_name'>find_or_create_by_name</span>(<span class='id identifier rubyid_name'>name</span>)
      <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='id identifier rubyid_last_name'>last_name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>2</span>)
      <span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span>(<span class='label'>first_name:</span> <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='label'>last_name:</span> <span class='id identifier rubyid_last_name'>last_name</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='const'>Account</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_people'>people</span>.<span class='id identifier rubyid_find_or_create_by_name'>find_or_create_by_name</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>David Heinemeier Hansson</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_first_name'>first_name</span> <span class='comment'># =&gt; &quot;David&quot;
</span><span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_last_name'>last_name</span>  <span class='comment'># =&gt; &quot;Heinemeier Hansson&quot;</span></code></pre>

<p>If you need to share the same extensions between many associations, you can use a named extension module.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>FindOrCreateByNameExtension</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_find_or_create_by_name'>find_or_create_by_name</span>(<span class='id identifier rubyid_name'>name</span>)
    <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='id identifier rubyid_last_name'>last_name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>2</span>)
    <span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span>(<span class='label'>first_name:</span> <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='label'>last_name:</span> <span class='id identifier rubyid_last_name'>last_name</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_people'>people</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_extending'>extending</span> <span class='const'>FindOrCreateByNameExtension</span> }
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Company</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_people'>people</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_extending'>extending</span> <span class='const'>FindOrCreateByNameExtension</span> }
<span class='kw'>end</span></code></pre>

<p>Some extensions can only be made to work with knowledge of the association’s internals. Extensions can access relevant state using the following methods (where <code>items</code> is the name of the association):</p>
<ul><li>
<p><code>record.association(:items).owner</code> - Returns the object the association is part of.</p>
</li><li>
<p><code>record.association(:items).reflection</code> - Returns the reflection object that describes the association.</p>
</li><li>
<p><code>record.association(:items).target</code> - Returns the associated object for <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> and <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a>, or the collection of associated objects for #has_many and #has_and_belongs_to_many.</p>
</li></ul>

<p>However, inside the actual extension code, you will not have access to the <code>record</code> as above. In this case, you can access <code>proxy_association</code>. For example, <code>record.association(:items)</code> and <code>record.items.proxy_association</code> will return the same object, allowing you to make calls like <code>proxy_association.owner</code> inside association extensions.</p>

<h3 id="label-Association+Join+Models">Association Join Models</h3>

<p>Has Many associations can be configured with the <code>:through</code> option to use an explicit join model to retrieve the data. This operates similarly to a <a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">#has_and_belongs_to_many</a> association. The advantage is that you’re able to add validations, callbacks, and extra attributes on the join model. Consider the following schema:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_authorships'>authorships</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_authorships'>authorships</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Authorship</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_book'>book</span>
<span class='kw'>end</span>

<span class='ivar'>@author</span> <span class='op'>=</span> <span class='const'>Author</span>.<span class='id identifier rubyid_first'>first</span>
<span class='ivar'>@author</span>.<span class='id identifier rubyid_authorships'>authorships</span>.<span class='id identifier rubyid_collect'>collect</span> { <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span>.<span class='id identifier rubyid_book'>book</span> } <span class='comment'># selects all books that the author&#39;s authorships belong to
</span><span class='ivar'>@author</span>.<span class='id identifier rubyid_books'>books</span>                              <span class='comment'># selects all books by using the Authorship join model</span></code></pre>

<p>You can also go through a <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> association on the join model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Firm</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span>   <span class='symbeg'>:</span><span class='id identifier rubyid_clients'>clients</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span>   <span class='symbeg'>:</span><span class='id identifier rubyid_invoices'>invoices</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_clients'>clients</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Client</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_firm'>firm</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span>   <span class='symbeg'>:</span><span class='id identifier rubyid_invoices'>invoices</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Invoice</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_client'>client</span>
<span class='kw'>end</span>

<span class='ivar'>@firm</span> <span class='op'>=</span> <span class='const'>Firm</span>.<span class='id identifier rubyid_first'>first</span>
<span class='ivar'>@firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_flat_map'>flat_map</span> { <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span>.<span class='id identifier rubyid_invoices'>invoices</span> } <span class='comment'># select all invoices for all clients of the firm
</span><span class='ivar'>@firm</span>.<span class='id identifier rubyid_invoices'>invoices</span>                            <span class='comment'># selects all invoices by going through the Client join model</span></code></pre>

<p>Similarly you can go through a <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a> association on the join model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Group</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span>   <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span>   <span class='symbeg'>:</span><span class='id identifier rubyid_avatars'>avatars</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_group'>group</span>
  <span class='id identifier rubyid_has_one'><a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">has_one</a></span>    <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Avatar</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>
<span class='kw'>end</span>

<span class='ivar'>@group</span> <span class='op'>=</span> <span class='const'>Group</span>.<span class='id identifier rubyid_first'>first</span>
<span class='ivar'>@group</span>.<span class='id identifier rubyid_users'>users</span>.<span class='id identifier rubyid_collect'>collect</span> { <span class='op'>|</span><span class='id identifier rubyid_u'>u</span><span class='op'>|</span> <span class='id identifier rubyid_u'>u</span>.<span class='id identifier rubyid_avatar'>avatar</span> }.<span class='id identifier rubyid_compact'>compact</span> <span class='comment'># select all avatars for all users in the group
</span><span class='ivar'>@group</span>.<span class='id identifier rubyid_avatars'>avatars</span>                                <span class='comment'># selects all avatars by going through the User join model.</span></code></pre>

<p>An important caveat with going through <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a> or <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> associations on the join model is that these associations are <strong>read-only</strong>. For example, the following would not work following the previous example:</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@group</span>.<span class='id identifier rubyid_avatars'>avatars</span> <span class='op'>&lt;&lt;</span> <span class='const'>Avatar</span>.<span class='id identifier rubyid_new'>new</span>   <span class='comment'># this would work if User belonged_to Avatar rather than the other way around
</span><span class='ivar'>@group</span>.<span class='id identifier rubyid_avatars'>avatars</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='ivar'>@group</span>.<span class='id identifier rubyid_avatars'>avatars</span>.<span class='id identifier rubyid_last'>last</span>)  <span class='comment'># so would this</span></code></pre>

<h4 id="label-Setting+Inverses">Setting Inverses</h4>

<p>If you are using a <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> on the join model, it is a good idea to set the <code>:inverse_of</code> option on the <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a>, which will mean that the following example works correctly (where <code>tags</code> is a <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> <code>:through</code> association):</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@post</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_first'>first</span>
<span class='ivar'>@tag</span> <span class='op'>=</span> <span class='ivar'>@post</span>.<span class='id identifier rubyid_tags'>tags</span>.<span class='id identifier rubyid_build'>build</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby</span><span class='tstring_end'>&quot;</span></span>
<span class='ivar'>@tag</span>.<span class='id identifier rubyid_save'>save</span></code></pre>

<p>The last line ought to save the through record (a <code>Tagging</code>). This will only work if the <code>:inverse_of</code> is set:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Tagging</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_tag'>tag</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_taggings'>taggings</span>
<span class='kw'>end</span></code></pre>

<p>If you do not set the <code>:inverse_of</code> record, the association will do its best to match itself up with the correct inverse. Automatic inverse detection only works on <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a>, <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a>, and <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> associations.</p>

<p><code>:foreign_key</code> and <code>:through</code> options on the associations will also prevent the association’s inverse from being found automatically, as will a custom scopes in some cases. See further details in the <a href="https://guides.rubyonrails.org/association_basics.html#bi-directional-associations" target="_parent" title="Active Record {ActiveRecord::Associations">Active Record {ActiveRecord::Associations</a> guide}.</p>

<p>The automatic guessing of the inverse association uses a heuristic based on the name of the class, so it may not work for all associations, especially the ones with non-standard names.</p>

<p>You can turn off the automatic detection of inverse associations by setting the <code>:inverse_of</code> option to <code>false</code> like so:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Tagging</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_tag'>tag</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='kw'>false</span>
<span class='kw'>end</span></code></pre>

<h3 id="label-Nested+Associations">Nested Associations</h3>

<p>You can actually specify <strong>any</strong> association with the <code>:through</code> option, including an association which has a <code>:through</code> option itself. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_commenters'>commenters</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Comment</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_commenter'>commenter</span>
<span class='kw'>end</span>

<span class='ivar'>@author</span> <span class='op'>=</span> <span class='const'>Author</span>.<span class='id identifier rubyid_first'>first</span>
<span class='ivar'>@author</span>.<span class='id identifier rubyid_commenters'>commenters</span> <span class='comment'># =&gt; People who commented on posts written by the author</span></code></pre>

<p>An equivalent way of setting up this association this would be:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_commenters'>commenters</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_commenters'>commenters</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Comment</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_commenter'>commenter</span>
<span class='kw'>end</span></code></pre>

<p>When using a nested association, you will not be able to modify the association because there is not enough information to know what modification to make. For example, if you tried to add a <code>Commenter</code> in the example above, there would be no way to tell how to set up the intermediate <code>Post</code> and <code>Comment</code> objects.</p>

<h3 id="label-Polymorphic+Associations">Polymorphic Associations</h3>

<p>Polymorphic associations on models are not restricted on what types of models they can be associated with. Rather, they specify an interface that a <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> association must adhere to.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Asset</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_attachable'>attachable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_assets'>assets</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_attachable'>attachable</span>         <span class='comment'># The :as option specifies the polymorphic interface to use.
</span><span class='kw'>end</span>

<span class='ivar'>@asset</span>.<span class='id identifier rubyid_attachable'>attachable</span> <span class='op'>=</span> <span class='ivar'>@post</span></code></pre>

<p>This works by using a type column in addition to a foreign key to specify the associated record. In the Asset example, you’d need an <code>attachable_id</code> integer column and an <code>attachable_type</code> string column.</p>

<p>Using polymorphic associations in combination with single table inheritance (STI) is a little tricky. In order for the associations to work as expected, ensure that you store the base model for the STI models in the type column of the polymorphic association. To continue with the asset example above, suppose there are guest posts and member posts that use the posts table for STI. In this case, there must be a <code>type</code> column in the posts table.</p>

<p>Note: The <code>attachable_type=</code> method is being called when assigning an <code>attachable</code>. The <code>class_name</code> of the <code>attachable</code> is passed as a <a href="../../String.html" title="String (class)"><code>::String</code></a>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Asset</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_attachable'>attachable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_attachable_type='>attachable_type=</span>(<span class='id identifier rubyid_class_name'>class_name</span>)
     <span class='kw'>super</span>(<span class='id identifier rubyid_class_name'>class_name</span>.<span class='id identifier rubyid_constantize'>constantize</span>.<span class='id identifier rubyid_base_class'>base_class</span>.<span class='id identifier rubyid_to_s'>to_s</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='comment'># because we store &quot;Post&quot; in attachable_type now dependent: :destroy will work
</span>  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_assets'>assets</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_attachable'>attachable</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy'>destroy</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>GuestPost</span> <span class='op'>&lt;</span> <span class='const'>Post</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>MemberPost</span> <span class='op'>&lt;</span> <span class='const'>Post</span>
<span class='kw'>end</span></code></pre>

<h3 id="label-Caching">Caching</h3>

<p>All of the methods are built on a simple caching principle that will keep the result of the last query around unless specifically instructed not to. The cache is even shared across methods to make it even cheaper to use the macro-added methods without worrying too much about performance at the first go.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>             <span class='comment'># fetches milestones from the database
</span><span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>.<span class='id identifier rubyid_size'>size</span>        <span class='comment'># uses the milestone cache
</span><span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>.<span class='id identifier rubyid_empty?'>empty?</span>      <span class='comment'># uses the milestone cache
</span><span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>.<span class='id identifier rubyid_reload'>reload</span>.<span class='id identifier rubyid_size'>size</span> <span class='comment'># fetches milestones from the database
</span><span class='id identifier rubyid_project'>project</span>.<span class='id identifier rubyid_milestones'>milestones</span>             <span class='comment'># uses the milestone cache</span></code></pre>

<h3 id="label-Eager+loading+of+associations">Eager loading of associations</h3>

<p>Eager loading is a way to find objects of a certain class and a number of named associations. It is one of the easiest ways to prevent the dreaded N+1 problem in which fetching 100 posts that each need to display their author triggers 101 database queries. Through the use of eager loading, the number of queries will be reduced from 101 to 2.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span>   <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>
<span class='kw'>end</span></code></pre>

<p>Consider the following loop using the class above:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_all'>all</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_post'>post</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Post:            </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_title'>title</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Written by:      </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_author'>author</span>.<span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Last comment on: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_comments'>comments</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_created_on'>created_on</span>
<span class='kw'>end</span></code></pre>

<p>To iterate over these one hundred posts, we’ll generate 201 database queries. Let’s first just optimize it for retrieving the author:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_post'>post</span><span class='op'>|</span></code></pre>

<p>This references the name of the <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> association that also used the <code>:author</code> symbol. After loading the posts, <code>find</code> will collect the <code>author_id</code> from each one and load all of the referenced authors with one query. Doing so will cut down the number of queries from 201 to 102.</p>

<p>We can improve upon the situation further by referencing both associations in the finder with:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_post'>post</span><span class='op'>|</span></code></pre>

<p>This will load all comments with a single query. This reduces the total number of queries to 3. In general, the number of queries will be 1 plus the number of associations named (except if some of the associations are polymorphic <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> - see below).</p>

<p>To include a deep hierarchy of associations, use a hash:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span><span class='comma'>,</span> { <span class='label'>comments:</span> { <span class='label'>author:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gravatar'>gravatar</span> } }).<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_post'>post</span><span class='op'>|</span></code></pre>

<p>The above code will load all the comments and all of their associated authors and gravatars. You can mix and match any combination of symbols, arrays, and hashes to retrieve the associations you want to load.</p>

<p>All of this power shouldn’t fool you into thinking that you can pull out huge amounts of data with no performance penalty just because you’ve reduced the number of queries. The database still needs to send all the data to Active Record and it still needs to be processed. So it’s no catch-all for performance problems, but it’s a great way to cut down on the number of queries in a situation as the one described above.</p>

<p>Since only one table is loaded at a time, conditions or orders cannot reference tables other than the main one. If this is the case, Active Record falls back to the previously used <code>LEFT OUTER JOIN</code> based strategy. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_includes'>includes</span>([<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>]).<span class='id identifier rubyid_where'>where</span>([<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>comments.approved = ?</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>true</span>])</code></pre>

<p>This will result in a single SQL query with joins along the lines of: <code>LEFT OUTER JOIN comments ON comments.post_id = posts.id</code> and <code>LEFT OUTER JOIN authors ON authors.id = posts.author_id</code>. Note that using conditions like this can have unintended consequences. In the above example, posts with no approved comments are not returned at all because the conditions apply to the SQL statement as a whole and not just to the association.</p>

<p>You must disambiguate column references for this fallback to happen, for example <code>order: &quot;author.name DESC&quot;</code> will work but <code>order: &quot;name DESC&quot;</code> will not.</p>

<p>If you want to load all posts (including posts with no approved comments), then write your own <code>LEFT OUTER JOIN</code> query using <code>ON</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LEFT OUTER JOIN comments ON comments.post_id = posts.id AND comments.approved = &#39;1&#39;</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>In this case, it is usually more natural to include an association which has conditions defined on it:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_approved_comments'>approved_comments</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>approved:</span> <span class='kw'>true</span>) }<span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Comment</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='const'>Post</span>.<span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_approved_comments'>approved_comments</span>)</code></pre>

<p>This will load posts and eager load the <code>approved_comments</code> association, which contains only those comments that have been approved.</p>

<p>If you eager load an association with a specified <code>:limit</code> option, it will be ignored, returning all the associated objects:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Picture</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_most_recent_comments'>most_recent_comments</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_order'>order</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>id DESC</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_limit'>limit</span>(<span class='int'>10</span>) }<span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Comment</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='const'>Picture</span>.<span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_most_recent_comments'>most_recent_comments</span>).<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_most_recent_comments'>most_recent_comments</span> <span class='comment'># =&gt; returns all associated comments.</span></code></pre>

<p>Eager loading is supported with polymorphic associations.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Address</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_addressable'>addressable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>A call that tries to eager load the addressable model</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Address</span>.<span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_addressable'>addressable</span>)</code></pre>

<p>This will execute one query to load the addresses and load the addressables with one query per addressable type. For example, if all the addressables are either of class Person or Company, then a total of 3 queries will be executed. The list of addressable types to load is determined on the back of the addresses loaded. This is not supported if Active Record has to fall back to the previous implementation of eager loading and will raise <a href="../EagerLoadPolymorphicError.html" title="ActiveRecord::EagerLoadPolymorphicError (class)"><code>::ActiveRecord::EagerLoadPolymorphicError</code></a>. The reason is that the parent model’s type is a column value so its corresponding table name cannot be put in the <code>FROM+/+JOIN</code> clauses of that query.</p>

<h3 id="label-Table+Aliasing">Table Aliasing</h3>

<p>Active Record uses table aliasing in the case that a table is referenced multiple times in a join. If a table is referenced only once, the standard table name is used. The second time, the table is aliased as <code>#{reflection_name}_#{parent_table_name}</code>. Indexes are appended for any more successive uses of the table name.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>)
<span class='comment'># SELECT ... FROM posts INNER JOIN comments ON ...
</span><span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_special_comments'>special_comments</span>) <span class='comment'># STI
</span><span class='comment'># SELECT ... FROM posts INNER JOIN comments ON ... AND comments.type = &#39;SpecialComment&#39;
</span><span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_special_comments'>special_comments</span>) <span class='comment'># special_comments is the reflection name, posts is the parent table name
</span><span class='comment'># SELECT ... FROM posts INNER JOIN comments ON ... INNER JOIN comments special_comments_posts</span></code></pre>

<p>Acts as tree example:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>TreeMixin</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_children'>children</span>)
<span class='comment'># SELECT ... FROM mixins INNER JOIN mixins childrens_mixins ...
</span><span class='const'>TreeMixin</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='label'>children:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_parent'>parent</span>)
<span class='comment'># SELECT ... FROM mixins INNER JOIN mixins childrens_mixins ...
</span><span class='comment'>#                        INNER JOIN parents_mixins ...
</span><span class='const'>TreeMixin</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='label'>children:</span> {<span class='label'>parent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_children'>children</span>})
<span class='comment'># SELECT ... FROM mixins INNER JOIN mixins childrens_mixins ...
</span><span class='comment'>#                        INNER JOIN parents_mixins ...
</span><span class='comment'>#                        INNER JOIN mixins childrens_mixins_2</span></code></pre>

<p>Has and Belongs to Many join tables use the same idea, but add a <code>_join</code> suffix:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_categories'>categories</span>)
<span class='comment'># SELECT ... FROM posts INNER JOIN categories_posts ... INNER JOIN categories ...
</span><span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='label'>categories:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>)
<span class='comment'># SELECT ... FROM posts INNER JOIN categories_posts ... INNER JOIN categories ...
</span><span class='comment'>#                       INNER JOIN categories_posts posts_categories_join INNER JOIN posts posts_categories
</span><span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='label'>categories:</span> {<span class='label'>posts:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_categories'>categories</span>})
<span class='comment'># SELECT ... FROM posts INNER JOIN categories_posts ... INNER JOIN categories ...
</span><span class='comment'>#                       INNER JOIN categories_posts posts_categories_join INNER JOIN posts posts_categories
</span><span class='comment'>#                       INNER JOIN categories_posts categories_posts_join INNER JOIN categories categories_posts_2</span></code></pre>

<p>If you wish to specify your own custom joins using <a href="../QueryMethods.html#joins-instance_method" title="ActiveRecord::QueryMethods#joins (method)">QueryMethods#joins</a> method, those table names will take precedence over the eager associations:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>).<span class='id identifier rubyid_joins'>joins</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>inner join comments ...</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># SELECT ... FROM posts INNER JOIN comments_posts ON ... INNER JOIN comments ...
</span><span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_special_comments'>special_comments</span>).<span class='id identifier rubyid_joins'>joins</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>inner join comments ...</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># SELECT ... FROM posts INNER JOIN comments comments_posts ON ...
</span><span class='comment'>#                       INNER JOIN comments special_comments_posts ...
</span><span class='comment'>#                       INNER JOIN comments ...</span></code></pre>

<p>Table aliases are automatically truncated according to the maximum length of table identifiers according to the specific database.</p>

<h3 id="label-Modules">Modules</h3>

<p>By default, associations will look for objects within the current module scope. Consider:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>MyApplication</span>
  <span class='kw'>module</span> <span class='const'>Business</span>
    <span class='kw'>class</span> <span class='const'>Firm</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
      <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_clients'>clients</span>
    <span class='kw'>end</span>

    <span class='kw'>class</span> <span class='const'>Client</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span><span class='semicolon'>;</span> <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>When <code>Firm#clients</code> is called, it will in turn call <code>MyApplication::Business::Client.find_all_by_firm_id(firm.id)</code>. If you want to associate with a class in another module scope, this can be done by specifying the complete class name.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>MyApplication</span>
  <span class='kw'>module</span> <span class='const'>Business</span>
    <span class='kw'>class</span> <span class='const'>Firm</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span><span class='semicolon'>;</span> <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>module</span> <span class='const'>Billing</span>
    <span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
      <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_firm'>firm</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MyApplication::Business::Firm</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3 id="label-Bi-directional+associations">Bi-directional associations</h3>

<p>When you specify an association, there is usually an association on the associated model that specifies the same relationship in reverse. For example, with the following models:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Dungeon</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_traps'>traps</span>
  <span class='id identifier rubyid_has_one'><a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">has_one</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_evil_wizard'>evil_wizard</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Trap</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_dungeon'>dungeon</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>EvilWizard</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_dungeon'>dungeon</span>
<span class='kw'>end</span></code></pre>

<p>The <code>traps</code> association on <code>Dungeon</code> and the <code>dungeon</code> association on <code>Trap</code> are the inverse of each other, and the inverse of the <code>dungeon</code> association on <code>EvilWizard</code> is the <code>evil_wizard</code> association on <code>Dungeon</code> (and vice-versa). By default, Active Record can guess the inverse of the association based on the name of the class. The result is the following:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_d'>d</span> <span class='op'>=</span> <span class='const'>Dungeon</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='id identifier rubyid_d'>d</span>.<span class='id identifier rubyid_traps'>traps</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_d'>d</span>.<span class='id identifier rubyid_object_id'>object_id</span> <span class='op'>==</span> <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_dungeon'>dungeon</span>.<span class='id identifier rubyid_object_id'>object_id</span> <span class='comment'># =&gt; true</span></code></pre>

<p>The <code>Dungeon</code> instances <code>d</code> and <code>t.dungeon</code> in the above example refer to the same in-memory instance since the association matches the name of the class. The result would be the same if we added <code>:inverse_of</code> to our model definitions:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Dungeon</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_traps'>traps</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_dungeon'>dungeon</span>
  <span class='id identifier rubyid_has_one'><a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">has_one</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_evil_wizard'>evil_wizard</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_dungeon'>dungeon</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Trap</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_dungeon'>dungeon</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_traps'>traps</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>EvilWizard</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'><a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">belongs_to</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_dungeon'>dungeon</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_evil_wizard'>evil_wizard</span>
<span class='kw'>end</span></code></pre>

<p>For more information, see the documentation for the <code>:inverse_of</code> option and the <a href="https://guides.rubyonrails.org/association_basics.html#bi-directional-associations" target="_parent" title="Active Record {ActiveRecord::Associations">Active Record {ActiveRecord::Associations</a> guide}.</p>

<h3 id="label-Deleting+from+associations">Deleting from associations</h3>

<h4 id="label-Dependent+associations">Dependent associations</h4>

<p><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a>, <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a>, and <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> associations support the <code>:dependent</code> option. This allows you to specify that associated records should be deleted when the owner is deleted.</p>

<p>For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span>
  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy'>destroy</span>
<span class='kw'>end</span>
<span class='const'>Author</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>1</span>).<span class='id identifier rubyid_destroy'>destroy</span> <span class='comment'># =&gt; Will destroy all of the author&#39;s posts, too</span></code></pre>

<p>The <code>:dependent</code> option can have different values which specify how the deletion is done. For more information, see the documentation for this option on the different specific association types. When no option is given, the behavior is to do nothing with the associated records when destroying a record.</p>

<p>Note that <code>:dependent</code> is implemented using Rails’ callback system, which works by processing callbacks in order. Therefore, other callbacks declared either before or after the <code>:dependent</code> option can affect what it does.</p>

<p>Note that <code>:dependent</code> option is ignored for <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a> <code>:through</code> associations.</p>

<h4 id="label-Delete+or+destroy-3F">Delete or destroy?</h4>

<p><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> and <a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">#has_and_belongs_to_many</a> associations have the methods <code>destroy</code>, <code>delete</code>, <code>destroy_all</code> and <code>delete_all</code>.</p>

<p>For <a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">#has_and_belongs_to_many</a>, <code>delete</code> and <code>destroy</code> are the same: they cause the records in the join table to be removed.</p>

<p>For <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a>, <code>destroy</code> and <code>destroy_all</code> will always call the <code>destroy</code> method of the record(s) being removed so that callbacks are run. However <code>delete</code> and <code>delete_all</code> will either do the deletion according to the strategy specified by the <code>:dependent</code> option, or if no <code>:dependent</code> option is given, then it will follow the default strategy. The default strategy is to do nothing (leave the foreign keys with the parent ids set), except for <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> <code>:through</code>, where the default strategy is <code>delete_all</code> (delete the join records, without running their callbacks).</p>

<p>There is also a <code>clear</code> method which is the same as <code>delete_all</code>, except that it returns the association rather than the records which have been deleted.</p>

<h4 id="label-What+gets+deleted-3F">What gets deleted?</h4>

<p>There is a potential pitfall here: <a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">#has_and_belongs_to_many</a> and <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> <code>:through</code> associations have records in join tables, as well as the associated records. So when we call one of these deletion methods, what exactly should be deleted?</p>

<p>The answer is that it is assumed that deletion on an association is about removing the <em>link</em> between the owner and the associated object(s), rather than necessarily the associated objects themselves. So with <a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">#has_and_belongs_to_many</a> and <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> <code>:through</code>, the join records will be deleted, but the associated records won’t.</p>

<p>This makes sense if you think about it: if you were to call <code>post.tags.delete(Tag.find_by(name: &#39;food&#39;))</code> you would want the ‘food’ tag to be unlinked from the post, rather than for the tag itself to be removed from the database.</p>

<p>However, there are examples where this strategy doesn’t make sense. For example, suppose a person has many projects, and each project has many tasks. If we deleted one of a person’s tasks, we would probably not want the project to be deleted. In this scenario, the delete method won’t actually work: it can only be used if the association on the join model is a <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a>. In other situations you are expected to perform operations directly on either the associated records or the <code>:through</code> association.</p>

<p>With a regular <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> there is no distinction between the “associated records” and the “link”, so there is only one choice for what gets deleted.</p>

<p>With <a href="#has_and_belongs_to_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_and_belongs_to_many (method)">#has_and_belongs_to_many</a> and <a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">#has_many</a> <code>:through</code>, if you want to delete the associated records themselves, you can always do something along the lines of <code>person.tasks.each(&amp;:destroy)</code>.</p>

<h3 id="label-Type+safety+with+-7BActiveRecord-3A-3AAssociationTypeMismatch-7D">Type safety with <a href="../AssociationTypeMismatch.html" title="ActiveRecord::AssociationTypeMismatch (class)"><code>::ActiveRecord::AssociationTypeMismatch</code></a></h3>

<p>If you attempt to assign an object to an association that doesn’t match the inferred or specified <code>:class_name</code>, you’ll get an <a href="../AssociationTypeMismatch.html" title="ActiveRecord::AssociationTypeMismatch (class)"><code>::ActiveRecord::AssociationTypeMismatch</code></a>.</p>

<h3 id="label-Options">Options</h3>

<p>All of the association macros can be specialized through options. This makes cases more complex than the simple and guessable ones possible.</p>

  </div>
</div>
</div>
<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#belongs_to-instance_method" title="#belongs_to (instance method)">#<strong>belongs_to</strong>(name, scope = nil, **options)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Specifies a one-to-one association with another class.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#has_and_belongs_to_many-instance_method" title="#has_and_belongs_to_many (instance method)">#<strong>has_and_belongs_to_many</strong>(name, scope = nil, **options, &amp;extension)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Specifies a many-to-many relationship with another class.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#has_many-instance_method" title="#has_many (instance method)">#<strong>has_many</strong>(name, scope = nil, **options, &amp;extension)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Specifies a one-to-many association.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#has_one-instance_method" title="#has_one (instance method)">#<strong>has_one</strong>(name, scope = nil, **options)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Specifies a one-to-one association with another class.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="belongs_to-instance_method">
  <h3 class='signature  first'>
    #<strong>belongs_to</strong>(name, scope = nil, **options)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Specifies a one-to-one association with another class. This method should only be used if this class contains the foreign key. If the other class contains the foreign key, then you should use <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a> instead. See <a href="rdoc-ref:Associations::ClassMethods@Is+it+a+-23belongs_to+or+-23has_one+association-3F">Is it a belongs_to or has_one association?</a> for more detail on when to use <a href="#has_one-instance_method" title="ActiveRecord::Associations::ClassMethods#has_one (method)">#has_one</a> and when to use <code>#belongs_to</code>.</p>

<p>Methods will be added for retrieval and query for a single associated object, for which this object holds an id:</p>

<p><a href="../Associations.html#association-instance_method" title="ActiveRecord::Associations#association (method)">ActiveRecord::Associations#association</a> is a placeholder for the symbol passed as the <code>name</code> argument, so <code>belongs_to :author</code> would add among others <code>author.nil?</code>.</p>
<dl class="rdoc-list label-list"><dt><code>association</code></dt>
<dd>
<p>Returns the associated object. <code>nil</code> is returned if none is found.</p>
</dd><dt><code>association=(associate)</code></dt>
<dd>
<p>Assigns the associate object, extracts the primary key, and sets it as the foreign key. No modification or deletion of existing records takes place.</p>
</dd><dt><code>build_association(attributes = {})</code></dt>
<dd>
<p>Returns a new object of the associated type that has been instantiated with <code>attributes</code> and linked to this object through a foreign key, but has not yet been saved.</p>
</dd><dt><code>create_association(attributes = {})</code></dt>
<dd>
<p>Returns a new object of the associated type that has been instantiated with <code>attributes</code>, linked to this object through a foreign key, and that has already been saved (if it passed the validation).</p>
</dd><dt><code>create_association!(attributes = {})</code></dt>
<dd>
<p>Does the same as <code>create_association</code>, but raises ActiveRecord::RecordInvalid if the record is invalid.</p>
</dd><dt><code>reload_association</code></dt>
<dd>
<p>Returns the associated object, forcing a database read.</p>
</dd><dt><code>reset_association</code></dt>
<dd>
<p>Unloads the associated object. The next access will query it from the database.</p>
</dd><dt><code>association_changed?</code></dt>
<dd>
<p>Returns true if a new associate object has been assigned and the next save will update the foreign key.</p>
</dd><dt><code>association_previously_changed?</code></dt>
<dd>
<p>Returns true if the previous save updated the association to reference a new associate object.</p>
</dd></dl>

<h4 id="label-Example">Example</h4>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>
<span class='kw'>end</span></code></pre>

<p>Declaring <code>belongs_to :author</code> adds the following methods (and more):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_post'>post</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>7</span>)
<span class='id identifier rubyid_author'>author</span> <span class='op'>=</span> <span class='const'>Author</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>19</span>)

<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_author'>author</span>           <span class='comment'># similar to Author.find(post.author_id)
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_author'>author</span> <span class='op'>=</span> <span class='id identifier rubyid_author'>author</span>  <span class='comment'># similar to post.author_id = author.id
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_build_author'>build_author</span>     <span class='comment'># similar to post.author = Author.new
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_create_author'>create_author</span>    <span class='comment'># similar to post.author = Author.new; post.author.save; post.author
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_create_author!'>create_author!</span>   <span class='comment'># similar to post.author = Author.new; post.author.save!; post.author
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_reload_author'>reload_author</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_reset_author'>reset_author</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_author_changed?'>author_changed?</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_author_previously_changed?'>author_previously_changed?</span></code></pre>

<h4 id="label-Scopes">Scopes</h4>

<p>You can pass a second argument <code>scope</code> as a callable (i.e. proc or lambda) to retrieve a specific record or customize the generated query when you access the associated object.</p>

<p>Scope examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_firm'>firm</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='int'>2</span>) }
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_friends'>friends</span>) }
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_level'>level</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_game'>game</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>game_level &gt; ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_game'>game</span>.<span class='id identifier rubyid_current_level'>current_level</span>) }</code></pre>

<h4 id="label-Options">Options</h4>

<p>The declaration can also include an <code>options</code> hash to specialize the behavior of the association.</p>
<dl class="rdoc-list label-list"><dt><code>:class_name</code></dt>
<dd>
<p>Specify the class name of the association. Use it only if that name can’t be inferred from the association name. So <code>belongs_to :author</code> will by default be linked to the Author class, but if the real class name is Person, you’ll have to specify it with this option.</p>
</dd><dt><code>:foreign_key</code></dt>
<dd>
<p>Specify the foreign key used for the association. By default this is guessed to be the name of the association with an “_id” suffix. So a class that defines a <code>belongs_to :person</code> association will use “person_id” as the default <code>:foreign_key</code>. Similarly, <code>belongs_to :favorite_person, class_name: &quot;Person&quot;</code> will use a foreign key of “favorite_person_id”.</p>

<p>Setting the <code>:foreign_key</code> option prevents automatic detection of the association’s inverse, so it is generally a good idea to set the <code>:inverse_of</code> option as well.</p>
</dd><dt><code>:foreign_type</code></dt>
<dd>
<p>Specify the column used to store the associated object’s type, if this is a polymorphic association. By default this is guessed to be the name of the association with a “_type” suffix. So a class that defines a <code>belongs_to :taggable, polymorphic: true</code> association will use “taggable_type” as the default <code>:foreign_type</code>.</p>
</dd><dt><code>:primary_key</code></dt>
<dd>
<p>Specify the method that returns the primary key of associated object used for the association. By default this is <code>id</code>.</p>
</dd><dt><code>:dependent</code></dt>
<dd>
<p>If set to <code>:destroy</code>, the associated object is destroyed when this object is. If set to <code>:delete</code>, the associated object is deleted <strong>without</strong> calling its destroy method. If set to <code>:destroy_async</code>, the associated object is scheduled to be destroyed in a background job. This option should not be specified when #belongs_to is used in conjunction with a #has_many relationship on another class because of the potential to leave orphaned records behind.</p>
</dd><dt><code>:counter_cache</code></dt>
<dd>
<p>Caches the number of belonging objects on the associate class through the use of CounterCache::ClassMethods#increment_counter and CounterCache::ClassMethods#decrement_counter. The counter cache is incremented when an object of this class is created and decremented when it’s destroyed. This requires that a column named <code>#{table_name}_count</code> (such as <code>comments_count</code> for a belonging Comment class) is used on the associate class (such as a Post class) - that is the migration for <code>#{table_name}_count</code> is created on the associate class (such that <code>Post.comments_count</code> will return the count cached). You can also specify a custom counter cache column by providing a column name instead of a <code>true+/+false</code> value to this option (e.g., <code>counter_cache: :my_custom_counter</code>.)</p>

<p>Starting to use counter caches on existing large tables can be troublesome, because the column values must be backfilled separately of the column addition (to not lock the table for too long) and before the use of <code>:counter_cache</code> (otherwise methods like <code>size</code>/<code>any?</code>/etc, which use counter caches internally, can produce incorrect results). To safely backfill the values while keeping counter cache columns updated with the child records creation/removal and to avoid the mentioned methods use the possibly incorrect counter cache column values and always get the results from the database, use <code>counter_cache: { active: false }</code>. If you also need to specify a custom column name, use <code>counter_cache: { active: false, column: :my_custom_counter }</code>.</p>

<p>Note: If you’ve enabled the counter cache, then you may want to add the counter cache attribute to the <code>attr_readonly</code> list in the associated classes (e.g. <code>class Post; attr_readonly :comments_count; end</code>).</p>
</dd><dt><code>:polymorphic</code></dt>
<dd>
<p>Specify this association is a polymorphic association by passing <code>true</code>. Note: Since polymorphic associations rely on storing class names in the database, make sure to update the class names in the <code>*_type</code> polymorphic type column of the corresponding rows.</p>
</dd><dt><code>:validate</code></dt>
<dd>
<p>When set to <code>true</code>, validates new objects added to association when saving the parent object. <code>false</code> by default. If you want to ensure associated objects are revalidated on every update, use <code>validates_associated</code>.</p>
</dd><dt><code>:autosave</code></dt>
<dd>
<p>If true, always save the associated object or destroy it if marked for destruction, when saving the parent object. If false, never save or destroy the associated object. By default, only save the associated object if it’s a new record.</p>

<p>Note that NestedAttributes::ClassMethods#accepts_nested_attributes_for sets <code>:autosave</code> to <code>true</code>.</p>
</dd><dt><code>:touch</code></dt>
<dd>
<p>If true, the associated object will be touched (the <code>updated_at</code> / <code>updated_on</code> attributes set to current time) when this record is either saved or destroyed. If you specify a symbol, that attribute will be updated with the current time in addition to the <code>updated_at</code> / <code>updated_on</code> attribute. Please note that no validation will be performed when touching, and only the <code>after_touch</code>, <code>after_commit</code>, and <code>after_rollback</code> callbacks will be executed.</p>
</dd><dt><code>:inverse_of</code></dt>
<dd>
<p>Specifies the name of the #has_one or #has_many association on the associated object that is the inverse of this #belongs_to association. See <a href="Associations::ClassMethods.html#label-Bi-directional+associations" title="Bi-directional associations">Bi-directional associations</a> for more detail.</p>
</dd><dt><code>:optional</code></dt>
<dd>
<p>When set to <code>true</code>, the association will not have its presence validated.</p>
</dd><dt><code>:required</code></dt>
<dd>
<p>When set to <code>true</code>, the association will also have its presence validated. This will validate the association itself, not the id. You can use <code>:inverse_of</code> to avoid an extra query during validation. NOTE: <code>required</code> is set to <code>true</code> by default and is deprecated. If you don’t want to have association presence validated, use <code>optional: true</code>.</p>
</dd><dt><code>:default</code></dt>
<dd>
<p>Provide a callable (i.e. proc or lambda) to specify that the association should be initialized with a particular record before validation. Please note that callable won’t be executed if the record exists.</p>
</dd><dt><code>:strict_loading</code></dt>
<dd>
<p>Enforces strict loading every time the associated record is loaded through this association.</p>
</dd><dt><code>:ensuring_owner_was</code></dt>
<dd>
<p>Specifies an instance method to be called on the owner. The method must return true in order for the associated records to be deleted in a background job.</p>
</dd><dt><code>:query_constraints</code></dt>
<dd>
<p>Serves as a composite foreign key. Defines the list of columns to be used to query the associated object. This is an optional option. By default Rails will attempt to derive the value automatically. When the value is set the Array size must match associated model’s primary key or <code>query_constraints</code> size.</p>
</dd></dl>

<p>Option examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_firm'>firm</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>client_of</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_person'>person</span><span class='comma'>,</span> <span class='label'>primary_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>person_name</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Person</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>author_id</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_valid_coupon'>valid_coupon</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_o'>o</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>discounts &gt; ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span>.<span class='id identifier rubyid_payments_count'>payments_count</span> }<span class='comma'>,</span>
                          <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Coupon</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>coupon_id</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_attachable'>attachable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_project'>project</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_readonly'>readonly</span> }
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post'>post</span><span class='comma'>,</span> <span class='label'>counter_cache:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comment'>comment</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_company'>company</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_employees_last_updated_at'>employees_last_updated_at</span>
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='label'>optional:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_account'>account</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_company'>company</span>.<span class='id identifier rubyid_account'>account</span> }
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_account'>account</span><span class='comma'>,</span> <span class='label'>strict_loading:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_note'>note</span><span class='comma'>,</span> <span class='label'>query_constraints:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_organization_id'>organization_id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_note_id'>note_id</span>]</code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v7.2.3/activerecord/lib/active_record/associations.rb#L1659-L1662'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1659' data-end='1662'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/associations.rb', line 1659</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_belongs_to'>belongs_to</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>)
  <span class='id identifier rubyid_reflection'>reflection</span> <span class='op'>=</span> <span class='const'><a href="Builder.html" title="ActiveRecord::Associations::Builder (module)">Builder</a></span><span class='op'>::</span><span class='const'><a href="Builder/BelongsTo.html" title="ActiveRecord::Associations::Builder::BelongsTo (class)">BelongsTo</a></span>.<span class='id identifier rubyid_build'><a href="Builder/Association.html#build-class_method" title="ActiveRecord::Associations::Builder::Association.build (method)">build</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_scope'>scope</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span>)
  <span class='const'><a href="../Reflection.html" title="ActiveRecord::Reflection (module)">Reflection</a></span>.<span class='id identifier rubyid_add_reflection'><a href="../Reflection.html#add_reflection-class_method" title="ActiveRecord::Reflection.add_reflection (method)">add_reflection</a></span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_reflection'>reflection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="has_and_belongs_to_many-instance_method">
  <h3 class='signature '>
    #<strong>has_and_belongs_to_many</strong>(name, scope = nil, **options, &amp;extension)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Specifies a many-to-many relationship with another class. This associates two classes via an intermediate join table. Unless the join table is explicitly specified as an option, it is guessed using the lexical order of the class names. So a join between Developer and Project will give the default join table name of “developers_projects” because “D” precedes “P” alphabetically. Note that this precedence is calculated using the <code>&lt;</code> operator for <a href="../../String.html" title="String (class)"><code>::String</code></a>. This means that if the strings are of different lengths, and the strings are equal when compared up to the shortest length, then the longer string is considered of higher lexical precedence than the shorter one. For example, one would expect the tables “paper_boxes” and “papers” to generate a join table name of “papers_paper_boxes” because of the length of the name “paper_boxes”, but it in fact generates a join table name of “paper_boxes_papers”. Be aware of this caveat, and use the custom <code>:join_table</code> option if you need to. If your tables share a common prefix, it will only appear once at the beginning. For example, the tables “catalog_categories” and “catalog_products” generate a join table name of “catalog_categories_products”.</p>

<p>The join table should not have a primary key or a model associated with it. You must manually generate the join table with a migration such as this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateDevelopersProjectsJoinTable</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Migration.html" title="ActiveRecord::Migration (class)">Migration</a></span>[<span class='float'>7.2</span>]
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_join_table'>create_join_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_developers'>developers</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_projects'>projects</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>It’s also a good idea to add indexes to each of those columns to speed up the joins process. However, in MySQL it is advised to add a compound index for both of the columns as MySQL only uses one index per table during the lookup.</p>

<p>Adds the following methods for retrieval and query:</p>

<p><code>collection</code> is a placeholder for the symbol passed as the <code>name</code> argument, so <code>has_and_belongs_to_many :categories</code> would add among others <code>categories.empty?</code>.</p>
<dl class="rdoc-list label-list"><dt><code>collection</code></dt>
<dd>
<p>Returns a Relation of all the associated objects. An empty Relation is returned if none are found.</p>
</dd><dt><code>collection&lt;&lt;(object, ...)</code></dt>
<dd>
<p>Adds one or more objects to the collection by creating associations in the join table (<code>collection.push</code> and <code>collection.concat</code> are aliases to this method). Note that this operation instantly fires update SQL without waiting for the save or update call on the parent object, unless the parent object is a new record.</p>
</dd><dt><code>collection.delete(object, ...)</code></dt>
<dd>
<p>Removes one or more objects from the collection by removing their associations from the join table. This does not destroy the objects.</p>
</dd><dt><code>collection.destroy(object, ...)</code></dt>
<dd>
<p>Removes one or more objects from the collection by running destroy on each association in the join table, overriding any dependent option. This does not destroy the objects.</p>
</dd><dt><code>collection=objects</code></dt>
<dd>
<p>Replaces the collection’s content by deleting and adding objects as appropriate.</p>
</dd><dt><code>collection_singular_ids</code></dt>
<dd>
<p>Returns an array of the associated objects’ ids.</p>
</dd><dt><code>collection_singular_ids=ids</code></dt>
<dd>
<p>Replace the collection by the objects identified by the primary keys in <code>ids</code>.</p>
</dd><dt><code>collection.clear</code></dt>
<dd>
<p>Removes every object from the collection. This does not destroy the objects.</p>
</dd><dt><code>collection.empty?</code></dt>
<dd>
<p>Returns <code>true</code> if there are no associated objects.</p>
</dd><dt><code>collection.size</code></dt>
<dd>
<p>Returns the number of associated objects.</p>
</dd><dt><code>collection.find(id)</code></dt>
<dd>
<p>Finds an associated object responding to the <code>id</code> and that meets the condition that it has to be associated with this object. Uses the same rules as ActiveRecord::FinderMethods#find.</p>
</dd><dt><code>collection.exists?(...)</code></dt>
<dd>
<p>Checks whether an associated object with the given conditions exists. Uses the same rules as ActiveRecord::FinderMethods#exists?.</p>
</dd><dt><code>collection.build(attributes = {})</code></dt>
<dd>
<p>Returns a new object of the collection type that has been instantiated with <code>attributes</code> and linked to this object through the join table, but has not yet been saved.</p>
</dd><dt><code>collection.create(attributes = {})</code></dt>
<dd>
<p>Returns a new object of the collection type that has been instantiated with <code>attributes</code>, linked to this object through the join table, and that has already been saved (if it passed the validation).</p>
</dd><dt><code>collection.reload</code></dt>
<dd>
<p>Returns a Relation of all of the associated objects, forcing a database read. An empty Relation is returned if none are found.</p>
</dd></dl>

<h4 id="label-Example">Example</h4>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Developer</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_projects'>projects</span>
<span class='kw'>end</span></code></pre>

<p>Declaring <code>has_and_belongs_to_many :projects</code> adds the following methods (and more):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_developer'>developer</span> <span class='op'>=</span> <span class='const'>Developer</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>11</span>)
<span class='id identifier rubyid_project'>project</span>   <span class='op'>=</span> <span class='const'>Project</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>9</span>)

<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_project'>project</span>
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_project'>project</span>)
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_destroy'>destroy</span>(<span class='id identifier rubyid_project'>project</span>)
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span> <span class='op'>=</span> [<span class='id identifier rubyid_project'>project</span>]
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_project_ids'>project_ids</span>
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_project_ids'>project_ids</span> <span class='op'>=</span> [<span class='int'>9</span>]
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_clear'>clear</span>
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_empty?'>empty?</span>
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_size'>size</span>
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>9</span>)
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_exists?'>exists?</span>(<span class='int'>9</span>)
<span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_build'>build</span>  <span class='comment'># similar to Project.new(developer_id: 11)
</span><span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_create'>create</span> <span class='comment'># similar to Project.create(developer_id: 11)
</span><span class='id identifier rubyid_developer'>developer</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_reload'>reload</span></code></pre>

<p>The declaration may include an <code>options</code> hash to specialize the behavior of the association.</p>

<h4 id="label-Scopes">Scopes</h4>

<p>You can pass a second argument <code>scope</code> as a callable (i.e. proc or lambda) to retrieve a specific set of records or customize the generated query when you access the associated collection.</p>

<p>Scope examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_projects'>projects</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_milestones'>milestones</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_manager'>manager</span>) }
<span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_categories'>categories</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_post'>post</span>) <span class='tlambeg'>{</span>
  <span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>default_category = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_default_category'>default_category</span>)
}</code></pre>

<h4 id="label-Extensions">Extensions</h4>

<p>The <code>extension</code> argument allows you to pass a block into a has_and_belongs_to_many association. This is useful for adding new finders, creators, and other factory-type methods to be used as part of the association.</p>

<p>Extension examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_contractors'>contractors</span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_find_or_create_by_name'>find_or_create_by_name</span>(<span class='id identifier rubyid_name'>name</span>)
    <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='id identifier rubyid_last_name'>last_name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>2</span>)
    <span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span>(<span class='label'>first_name:</span> <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='label'>last_name:</span> <span class='id identifier rubyid_last_name'>last_name</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h4 id="label-Options">Options</h4>
<dl class="rdoc-list label-list"><dt><code>:class_name</code></dt>
<dd>
<p>Specify the class name of the association. Use it only if that name can’t be inferred from the association name. So <code>has_and_belongs_to_many :projects</code> will by default be linked to the Project class, but if the real class name is SuperProject, you’ll have to specify it with this option.</p>
</dd><dt><code>:join_table</code></dt>
<dd>
<p>Specify the name of the join table if the default based on lexical order isn’t what you want. <strong>WARNING:</strong> If you’re overwriting the table name of either class, the <code>table_name</code> method MUST be declared underneath any #has_and_belongs_to_many declaration in order to work.</p>
</dd><dt><code>:foreign_key</code></dt>
<dd>
<p>Specify the foreign key used for the association. By default this is guessed to be the name of this class in lower-case and “_id” suffixed. So a Person class that makes a #has_and_belongs_to_many association to Project will use “person_id” as the default <code>:foreign_key</code>.</p>

<p>Setting the <code>:foreign_key</code> option prevents automatic detection of the association’s inverse, so it is generally a good idea to set the <code>:inverse_of</code> option as well.</p>
</dd><dt><code>:association_foreign_key</code></dt>
<dd>
<p>Specify the foreign key used for the association on the receiving side of the association. By default this is guessed to be the name of the associated class in lower-case and “_id” suffixed. So if a Person class makes a #has_and_belongs_to_many association to Project, the association will use “project_id” as the default <code>:association_foreign_key</code>.</p>
</dd><dt><code>:validate</code></dt>
<dd>
<p>When set to <code>true</code>, validates new objects added to association when saving the parent object. <code>true</code> by default. If you want to ensure associated objects are revalidated on every update, use <code>validates_associated</code>.</p>
</dd><dt><code>:autosave</code></dt>
<dd>
<p>If true, always save the associated objects or destroy them if marked for destruction, when saving the parent object. If false, never save or destroy the associated objects. By default, only save associated objects that are new records.</p>

<p>Note that NestedAttributes::ClassMethods#accepts_nested_attributes_for sets <code>:autosave</code> to <code>true</code>.</p>
</dd><dt><code>:strict_loading</code></dt>
<dd>
<p>Enforces strict loading every time an associated record is loaded through this association.</p>
</dd></dl>

<p>Option examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_projects'>projects</span>
<span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_projects'>projects</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_milestones'>milestones</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_manager'>manager</span>) }
<span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_nations'>nations</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Country</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_categories'>categories</span><span class='comma'>,</span> <span class='label'>join_table:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prods_cats</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_categories'>categories</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_readonly'>readonly</span> }
<span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_categories'>categories</span><span class='comma'>,</span> <span class='label'>strict_loading:</span> <span class='kw'>true</span></code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v7.2.3/activerecord/lib/active_record/associations.rb#L1840-L1876'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1840' data-end='1876'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/associations.rb', line 1840</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_extension'>extension</span>)
  <span class='id identifier rubyid_habtm_reflection'>habtm_reflection</span> <span class='op'>=</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Reflection.html" title="ActiveRecord::Reflection (module)">Reflection</a></span><span class='op'>::</span><span class='const'><a href="../Reflection/HasAndBelongsToManyReflection.html" title="ActiveRecord::Reflection::HasAndBelongsToManyReflection (class)">HasAndBelongsToManyReflection</a></span>.<span class='id identifier rubyid_new'><a href="../Reflection/AssociationReflection.html#new-class_method" title="ActiveRecord::Reflection::AssociationReflection.new (method)">new</a></span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_scope'>scope</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='kw'>self</span>)

  <span class='id identifier rubyid_builder'>builder</span> <span class='op'>=</span> <span class='const'><a href="Builder.html" title="ActiveRecord::Associations::Builder (module)">Builder</a></span><span class='op'>::</span><span class='const'><a href="Builder/HasAndBelongsToMany.html" title="ActiveRecord::Associations::Builder::HasAndBelongsToMany (class)">HasAndBelongsToMany</a></span>.<span class='id identifier rubyid_new'><a href="Builder/HasAndBelongsToMany.html#new-class_method" title="ActiveRecord::Associations::Builder::HasAndBelongsToMany.new (method)">new</a></span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span>

  <span class='id identifier rubyid_join_model'>join_model</span> <span class='op'>=</span> <span class='id identifier rubyid_builder'>builder</span>.<span class='id identifier rubyid_through_model'>through_model</span>

  <span class='id identifier rubyid_const_set'>const_set</span> <span class='id identifier rubyid_join_model'>join_model</span>.<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_join_model'>join_model</span>
  <span class='id identifier rubyid_private_constant'>private_constant</span> <span class='id identifier rubyid_join_model'>join_model</span>.<span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_middle_reflection'>middle_reflection</span> <span class='op'>=</span> <span class='id identifier rubyid_builder'>builder</span>.<span class='id identifier rubyid_middle_reflection'>middle_reflection</span> <span class='id identifier rubyid_join_model'>join_model</span>

  <span class='const'><a href="Builder.html" title="ActiveRecord::Associations::Builder (module)">Builder</a></span><span class='op'>::</span><span class='const'><a href="Builder/HasMany.html" title="ActiveRecord::Associations::Builder::HasMany (class)">HasMany</a></span>.<span class='id identifier rubyid_define_callbacks'><a href="Builder/CollectionAssociation.html#define_callbacks-class_method" title="ActiveRecord::Associations::Builder::CollectionAssociation.define_callbacks (method)">define_callbacks</a></span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_middle_reflection'>middle_reflection</span>
  <span class='const'><a href="../Reflection.html" title="ActiveRecord::Reflection (module)">Reflection</a></span>.<span class='id identifier rubyid_add_reflection'><a href="../Reflection.html#add_reflection-class_method" title="ActiveRecord::Reflection.add_reflection (method)">add_reflection</a></span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_middle_reflection'>middle_reflection</span>.<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_middle_reflection'>middle_reflection</span>
  <span class='id identifier rubyid_middle_reflection'>middle_reflection</span>.<span class='id identifier rubyid_parent_reflection'>parent_reflection</span> <span class='op'>=</span> <span class='id identifier rubyid_habtm_reflection'>habtm_reflection</span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="../../Module.html" title="Module (class)">Module</a></span>.<span class='id identifier rubyid_new'>new</span> {
    <span class='id identifier rubyid_class_eval'>class_eval</span> <span class='heredoc_beg'>&lt;&lt;-RUBY</span><span class='comma'>,</span> <span class='kw'>__FILE__</span><span class='comma'>,</span> <span class='kw'>__LINE__</span> <span class='op'>+</span> <span class='int'>1</span>
<span class='tstring_content'>      def destroy_associations
        association(:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_middle_reflection'>middle_reflection</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>).delete_all(:delete_all)
        association(:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>).reset
        super
      end
</span><span class='heredoc_end'>    RUBY
</span>  }

  <span class='id identifier rubyid_hm_options'>hm_options</span> <span class='op'>=</span> {}
  <span class='id identifier rubyid_hm_options'>hm_options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_through'>through</span>] <span class='op'>=</span> <span class='id identifier rubyid_middle_reflection'>middle_reflection</span>.<span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_hm_options'>hm_options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_source'>source</span>] <span class='op'>=</span> <span class='id identifier rubyid_join_model'>join_model</span>.<span class='id identifier rubyid_right_reflection'>right_reflection</span>.<span class='id identifier rubyid_name'>name</span>

  [<span class='symbeg'>:</span><span class='id identifier rubyid_before_add'>before_add</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_after_add'>after_add</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_before_remove'>before_remove</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_after_remove'>after_remove</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_autosave'>autosave</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_validate'>validate</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_join_table'>join_table</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_class_name'>class_name</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_extend'>extend</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_strict_loading'>strict_loading</span>].<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span>
    <span class='id identifier rubyid_hm_options'>hm_options</span>[<span class='id identifier rubyid_k'>k</span>] <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='id identifier rubyid_k'>k</span>] <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>.<span class='id identifier rubyid_key?'>key?</span> <span class='id identifier rubyid_k'>k</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_has_many'><a href="#has_many-instance_method" title="ActiveRecord::Associations::ClassMethods#has_many (method)">has_many</a></span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_scope'>scope</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_hm_options'>hm_options</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_extension'>extension</span>
  <span class='id identifier rubyid__reflections'>_reflections</span>[<span class='id identifier rubyid_name'>name</span>].<span class='id identifier rubyid_parent_reflection'>parent_reflection</span> <span class='op'>=</span> <span class='id identifier rubyid_habtm_reflection'>habtm_reflection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="has_many-instance_method">
  <h3 class='signature '>
    #<strong>has_many</strong>(name, scope = nil, **options, &amp;extension)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Specifies a one-to-many association. The following methods for retrieval and query of collections of associated objects will be added:</p>

<p><code>collection</code> is a placeholder for the symbol passed as the <code>name</code> argument, so <code>has_many :clients</code> would add among others <code>clients.empty?</code>.</p>
<dl class="rdoc-list label-list"><dt><code>collection</code></dt>
<dd>
<p>Returns a Relation of all the associated objects. An empty Relation is returned if none are found.</p>
</dd><dt><code>collection&lt;&lt;(object, ...)</code></dt>
<dd>
<p>Adds one or more objects to the collection by setting their foreign keys to the collection’s primary key. Note that this operation instantly fires update SQL without waiting for the save or update call on the parent object, unless the parent object is a new record. This will also run validations and callbacks of associated object(s).</p>
</dd><dt><code>collection.delete(object, ...)</code></dt>
<dd>
<p>Removes one or more objects from the collection by setting their foreign keys to <code>NULL</code>. Objects will be in addition destroyed if they’re associated with <code>dependent: :destroy</code>, and deleted if they’re associated with <code>dependent: :delete_all</code>.</p>

<p>If the <code>:through</code> option is used, then the join records are deleted (rather than nullified) by default, but you can specify <code>dependent: :destroy</code> or <code>dependent: :nullify</code> to override this.</p>
</dd><dt><code>collection.destroy(object, ...)</code></dt>
<dd>
<p>Removes one or more objects from the collection by running <code>destroy</code> on each record, regardless of any dependent option, ensuring callbacks are run.</p>

<p>If the <code>:through</code> option is used, then the join records are destroyed instead, not the objects themselves.</p>
</dd><dt><code>collection=objects</code></dt>
<dd>
<p>Replaces the collections content by deleting and adding objects as appropriate. If the <code>:through</code> option is true callbacks in the join models are triggered except destroy callbacks, since deletion is direct by default. You can specify <code>dependent: :destroy</code> or <code>dependent: :nullify</code> to override this.</p>
</dd><dt><code>collection_singular_ids</code></dt>
<dd>
<p>Returns an array of the associated objects’ ids</p>
</dd><dt><code>collection_singular_ids=ids</code></dt>
<dd>
<p>Replace the collection with the objects identified by the primary keys in <code>ids</code>. This method loads the models and calls <code>collection=</code>. See above.</p>
</dd><dt><code>collection.clear</code></dt>
<dd>
<p>Removes every object from the collection. This destroys the associated objects if they are associated with <code>dependent: :destroy</code>, deletes them directly from the database if <code>dependent: :delete_all</code>, otherwise sets their foreign keys to <code>NULL</code>. If the <code>:through</code> option is true no destroy callbacks are invoked on the join models. Join models are directly deleted.</p>
</dd><dt><code>collection.empty?</code></dt>
<dd>
<p>Returns <code>true</code> if there are no associated objects.</p>
</dd><dt><code>collection.size</code></dt>
<dd>
<p>Returns the number of associated objects.</p>
</dd><dt><code>collection.find(...)</code></dt>
<dd>
<p>Finds an associated object according to the same rules as ActiveRecord::FinderMethods#find.</p>
</dd><dt><code>collection.exists?(...)</code></dt>
<dd>
<p>Checks whether an associated object with the given conditions exists. Uses the same rules as ActiveRecord::FinderMethods#exists?.</p>
</dd><dt><code>collection.build(attributes = {}, ...)</code></dt>
<dd>
<p>Returns one or more new objects of the collection type that have been instantiated with <code>attributes</code> and linked to this object through a foreign key, but have not yet been saved.</p>
</dd><dt><code>collection.create(attributes = {})</code></dt>
<dd>
<p>Returns a new object of the collection type that has been instantiated with <code>attributes</code>, linked to this object through a foreign key, and that has already been saved (if it passed the validation). <strong>Note</strong>: This only works if the base model already exists in the DB, not if it is a new (unsaved) record!</p>
</dd><dt><code>collection.create!(attributes = {})</code></dt>
<dd>
<p>Does the same as <code>collection.create</code>, but raises ActiveRecord::RecordInvalid if the record is invalid.</p>
</dd><dt><code>collection.reload</code></dt>
<dd>
<p>Returns a Relation of all of the associated objects, forcing a database read. An empty Relation is returned if none are found.</p>
</dd></dl>

<h4 id="label-Example">Example</h4>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Firm</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_clients'>clients</span>
<span class='kw'>end</span></code></pre>

<p>Declaring <code>has_many :clients</code> adds the following methods (and more):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_firm'>firm</span> <span class='op'>=</span> <span class='const'>Firm</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>2</span>)
<span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'>Client</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>6</span>)

<span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>                       <span class='comment'># similar to Client.where(firm_id: 2)
</span><span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_client'>client</span>
<span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='id identifier rubyid_client'>client</span>)
<span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_destroy'>destroy</span>(<span class='id identifier rubyid_client'>client</span>)
<span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span> <span class='op'>=</span> [<span class='id identifier rubyid_client'>client</span>]
<span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_client_ids'>client_ids</span>
<span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_client_ids'>client_ids</span> <span class='op'>=</span> [<span class='int'>6</span>]
<span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_clear'>clear</span>
<span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_empty?'>empty?</span>                <span class='comment'># similar to firm.clients.size == 0
</span><span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_size'>size</span>                  <span class='comment'># similar to Client.count &quot;firm_id = 2&quot;
</span><span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_find'>find</span>                  <span class='comment'># similar to Client.where(firm_id: 2).find(6)
</span><span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_exists?'>exists?</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ACME</span><span class='tstring_end'>&#39;</span></span>) <span class='comment'># similar to Client.exists?(name: &#39;ACME&#39;, firm_id: 2)
</span><span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_build'>build</span>                 <span class='comment'># similar to Client.new(firm_id: 2)
</span><span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_create'>create</span>                <span class='comment'># similar to Client.create(firm_id: 2)
</span><span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_create!'>create!</span>               <span class='comment'># similar to Client.create!(firm_id: 2)
</span><span class='id identifier rubyid_firm'>firm</span>.<span class='id identifier rubyid_clients'>clients</span>.<span class='id identifier rubyid_reload'>reload</span></code></pre>

<p>The declaration can also include an <code>options</code> hash to specialize the behavior of the association.</p>

<h4 id="label-Scopes">Scopes</h4>

<p>You can pass a second argument <code>scope</code> as a callable (i.e. proc or lambda) to retrieve a specific set of records or customize the generated query when you access the associated collection.</p>

<p>Scope examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>author_id:</span> <span class='int'>1</span>) }
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_employees'>employees</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_address'>address</span>) }
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_blog'>blog</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>max_post_length &gt; ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_blog'>blog</span>.<span class='id identifier rubyid_max_post_length'>max_post_length</span>) }</code></pre>

<h4 id="label-Extensions">Extensions</h4>

<p>The <code>extension</code> argument allows you to pass a block into a has_many association. This is useful for adding new finders, creators, and other factory-type methods to be used as part of the association.</p>

<p>Extension examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_employees'>employees</span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_find_or_create_by_name'>find_or_create_by_name</span>(<span class='id identifier rubyid_name'>name</span>)
    <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='id identifier rubyid_last_name'>last_name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>2</span>)
    <span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span>(<span class='label'>first_name:</span> <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='label'>last_name:</span> <span class='id identifier rubyid_last_name'>last_name</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h4 id="label-Options">Options</h4>
<dl class="rdoc-list label-list"><dt><code>:class_name</code></dt>
<dd>
<p>Specify the class name of the association. Use it only if that name can’t be inferred from the association name. So <code>has_many :products</code> will by default be linked to the <code>Product</code> class, but if the real class name is <code>SpecialProduct</code>, you’ll have to specify it with this option.</p>
</dd><dt><code>:foreign_key</code></dt>
<dd>
<p>Specify the foreign key used for the association. By default this is guessed to be the name of this class in lower-case and “_id” suffixed. So a Person class that makes a #has_many association will use “person_id” as the default <code>:foreign_key</code>.</p>

<p>Setting the <code>:foreign_key</code> option prevents automatic detection of the association’s inverse, so it is generally a good idea to set the <code>:inverse_of</code> option as well.</p>
</dd><dt><code>:foreign_type</code></dt>
<dd>
<p>Specify the column used to store the associated object’s type, if this is a polymorphic association. By default this is guessed to be the name of the polymorphic association specified on “as” option with a “_type” suffix. So a class that defines a <code>has_many :tags, as: :taggable</code> association will use “taggable_type” as the default <code>:foreign_type</code>.</p>
</dd><dt><code>:primary_key</code></dt>
<dd>
<p>Specify the name of the column to use as the primary key for the association. By default this is <code>id</code>.</p>
</dd><dt><code>:dependent</code></dt>
<dd>
<p>Controls what happens to the associated objects when their owner is destroyed. Note that these are implemented as callbacks, and Rails executes callbacks in order. Therefore, other similar callbacks may affect the <code>:dependent</code> behavior, and the <code>:dependent</code> behavior may affect other callbacks.</p>
<ul><li>
<p><code>nil</code> do nothing (default).</p>
</li><li>
<p><code>:destroy</code> causes all the associated objects to also be destroyed.</p>
</li><li>
<p><code>:destroy_async</code> destroys all the associated objects in a background job. <strong>WARNING:</strong> Do not use this option if the association is backed by foreign key constraints in your database. The foreign key constraint actions will occur inside the same transaction that deletes its owner.</p>
</li><li>
<p><code>:delete_all</code> causes all the associated objects to be deleted directly from the database (so callbacks will not be executed).</p>
</li><li>
<p><code>:nullify</code> causes the foreign keys to be set to <code>NULL</code>. Polymorphic type will also be nullified on polymorphic associations. Callbacks are not executed.</p>
</li><li>
<p><code>:restrict_with_exception</code> causes an ActiveRecord::DeleteRestrictionError exception to be raised if there are any associated records.</p>
</li><li>
<p><code>:restrict_with_error</code> causes an error to be added to the owner if there are any associated objects.</p>
</li></ul>

<p>If using with the <code>:through</code> option, the association on the join model must be a #belongs_to, and the records which get deleted are the join records, rather than the associated records.</p>

<p>If using <code>dependent: :destroy</code> on a scoped association, only the scoped objects are destroyed. For example, if a Post model defines <code>has_many :comments, -&gt; { where published: true }, dependent: :destroy</code> and <code>destroy</code> is called on a post, only published comments are destroyed. This means that any unpublished comments in the database would still contain a foreign key pointing to the now deleted post.</p>
</dd><dt><code>:counter_cache</code></dt>
<dd>
<p>This option can be used to configure a custom named <code>:counter_cache.</code> You only need this option, when you customized the name of your <code>:counter_cache</code> on the #belongs_to association.</p>
</dd><dt><code>:as</code></dt>
<dd>
<p>Specifies a polymorphic interface (See #belongs_to).</p>
</dd><dt><code>:through</code></dt>
<dd>
<p>Specifies an association through which to perform the query. This can be any other type of association, including other <code>:through</code> associations. Options for <code>:class_name</code>, <code>:primary_key</code> and <code>:foreign_key</code> are ignored, as the association uses the source reflection.</p>

<p>If the association on the join model is a #belongs_to, the collection can be modified and the records on the <code>:through</code> model will be automatically created and removed as appropriate. Otherwise, the collection is read-only, so you should manipulate the <code>:through</code> association directly.</p>

<p>If you are going to modify the association (rather than just read from it), then it is a good idea to set the <code>:inverse_of</code> option on the source association on the join model. This allows associated records to be built which will automatically create the appropriate join model records when they are saved. See <a href="Associations::ClassMethods.html#label-Association+Join+Models" title="Association Join Models">Association Join Models</a> and <a href="Associations::ClassMethods.html#label-Setting+Inverses" title="Setting Inverses">Setting Inverses</a> for more detail.</p>
</dd><dt><code>:disable_joins</code></dt>
<dd>
<p>Specifies whether joins should be skipped for an association. If set to true, two or more queries will be generated. Note that in some cases, if order or limit is applied, it will be done in-memory due to database limitations. This option is only applicable on <code>has_many :through</code> associations as <code>has_many</code> alone do not perform a join.</p>
</dd><dt><code>:source</code></dt>
<dd>
<p>Specifies the source association name used by #has_many <code>:through</code> queries. Only use it if the name cannot be inferred from the association. <code>has_many :subscribers, through: :subscriptions</code> will look for either <code>:subscribers</code> or <code>:subscriber</code> on Subscription, unless a <code>:source</code> is given.</p>
</dd><dt><code>:source_type</code></dt>
<dd>
<p>Specifies type of the source association used by #has_many <code>:through</code> queries where the source association is a polymorphic #belongs_to.</p>
</dd><dt><code>:validate</code></dt>
<dd>
<p>When set to <code>true</code>, validates new objects added to association when saving the parent object. <code>true</code> by default. If you want to ensure associated objects are revalidated on every update, use <code>validates_associated</code>.</p>
</dd><dt><code>:autosave</code></dt>
<dd>
<p>If true, always save the associated objects or destroy them if marked for destruction, when saving the parent object. If false, never save or destroy the associated objects. By default, only save associated objects that are new records. This option is implemented as a <code>before_save</code> callback. Because callbacks are run in the order they are defined, associated objects may need to be explicitly saved in any user-defined <code>before_save</code> callbacks.</p>

<p>Note that NestedAttributes::ClassMethods#accepts_nested_attributes_for sets <code>:autosave</code> to <code>true</code>.</p>
</dd><dt><code>:inverse_of</code></dt>
<dd>
<p>Specifies the name of the #belongs_to association on the associated object that is the inverse of this #has_many association. See <a href="Associations::ClassMethods.html#label-Bi-directional+associations" title="Bi-directional associations">Bi-directional associations</a> for more detail.</p>
</dd><dt><code>:extend</code></dt>
<dd>
<p>Specifies a module or array of modules that will be extended into the association object returned. Useful for defining methods on associations, especially when they should be shared between multiple association objects.</p>
</dd><dt><code>:strict_loading</code></dt>
<dd>
<p>When set to <code>true</code>, enforces strict loading every time the associated record is loaded through this association.</p>
</dd><dt><code>:ensuring_owner_was</code></dt>
<dd>
<p>Specifies an instance method to be called on the owner. The method must return true in order for the associated records to be deleted in a background job.</p>
</dd><dt><code>:query_constraints</code></dt>
<dd>
<p>Serves as a composite foreign key. Defines the list of columns to be used to query the associated object. This is an optional option. By default Rails will attempt to derive the value automatically. When the value is set the Array size must match associated model’s primary key or <code>query_constraints</code> size.</p>
</dd><dt><code>:index_errors</code></dt>
<dd>
<p>Allows differentiation of multiple validation errors from the association records, by including an index in the error attribute name, e.g. <code>.level</code>. When set to <code>true</code>, the index is based on association order, i.e. database order, with yet to be persisted new records placed at the end. When set to <code>:nested_attributes_order</code>, the index is based on the record order received by nested attributes setter, when accepts_nested_attributes_for is used.</p>
</dd></dl>

<p>Option examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_order'>order</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>posted_on</span><span class='tstring_end'>&quot;</span></span>) }
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>) }
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_people'>people</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>deleted:</span> <span class='kw'>false</span>).<span class='id identifier rubyid_order'>order</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span>) }<span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Person</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tracks'>tracks</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_order'>order</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>position</span><span class='tstring_end'>&quot;</span></span>) }<span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy'>destroy</span>
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_nullify'>nullify</span>
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tags'>tags</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_taggable'>taggable</span>
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reports'>reports</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_readonly'>readonly</span> }
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_subscribers'>subscribers</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_subscriptions'>subscriptions</span><span class='comma'>,</span> <span class='label'>source:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_subscribers'>subscribers</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_subscriptions'>subscriptions</span><span class='comma'>,</span> <span class='label'>disable_joins:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='label'>strict_loading:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='label'>query_constraints:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_blog_id'>blog_id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_post_id'>post_id</span>]
<span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span><span class='comma'>,</span> <span class='label'>index_errors:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_nested_attributes_order'>nested_attributes_order</span></code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v7.2.3/activerecord/lib/active_record/associations.rb#L1272-L1275'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1272' data-end='1275'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/associations.rb', line 1272</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_has_many'>has_many</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_extension'>extension</span>)
  <span class='id identifier rubyid_reflection'>reflection</span> <span class='op'>=</span> <span class='const'><a href="Builder.html" title="ActiveRecord::Associations::Builder (module)">Builder</a></span><span class='op'>::</span><span class='const'><a href="Builder/HasMany.html" title="ActiveRecord::Associations::Builder::HasMany (class)">HasMany</a></span>.<span class='id identifier rubyid_build'><a href="Builder/Association.html#build-class_method" title="ActiveRecord::Associations::Builder::Association.build (method)">build</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_scope'>scope</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_extension'>extension</span>)
  <span class='const'><a href="../Reflection.html" title="ActiveRecord::Reflection (module)">Reflection</a></span>.<span class='id identifier rubyid_add_reflection'><a href="../Reflection.html#add_reflection-class_method" title="ActiveRecord::Reflection.add_reflection (method)">add_reflection</a></span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_reflection'>reflection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="has_one-instance_method">
  <h3 class='signature '>
    #<strong>has_one</strong>(name, scope = nil, **options)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Specifies a one-to-one association with another class. This method should only be used if the other class contains the foreign key. If the current class contains the foreign key, then you should use <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a> instead. See <a href="rdoc-ref:Associations::ClassMethods@Is+it+a+-23belongs_to+or+-23has_one+association-3F">Is it a belongs_to or has_one association?</a> for more detail on when to use <code>#has_one</code> and when to use <a href="#belongs_to-instance_method" title="ActiveRecord::Associations::ClassMethods#belongs_to (method)">#belongs_to</a>.</p>

<p>The following methods for retrieval and query of a single associated object will be added:</p>

<p><a href="../Associations.html#association-instance_method" title="ActiveRecord::Associations#association (method)">ActiveRecord::Associations#association</a> is a placeholder for the symbol passed as the <code>name</code> argument, so <code>has_one :manager</code> would add among others <code>manager.nil?</code>.</p>
<dl class="rdoc-list label-list"><dt><code>association</code></dt>
<dd>
<p>Returns the associated object. <code>nil</code> is returned if none is found.</p>
</dd><dt><code>association=(associate)</code></dt>
<dd>
<p>Assigns the associate object, extracts the primary key, sets it as the foreign key, and saves the associate object. To avoid database inconsistencies, permanently deletes an existing associated object when assigning a new one, even if the new one isn’t saved to database.</p>
</dd><dt><code>build_association(attributes = {})</code></dt>
<dd>
<p>Returns a new object of the associated type that has been instantiated with <code>attributes</code> and linked to this object through a foreign key, but has not yet been saved.</p>
</dd><dt><code>create_association(attributes = {})</code></dt>
<dd>
<p>Returns a new object of the associated type that has been instantiated with <code>attributes</code>, linked to this object through a foreign key, and that has already been saved (if it passed the validation).</p>
</dd><dt><code>create_association!(attributes = {})</code></dt>
<dd>
<p>Does the same as <code>create_association</code>, but raises ActiveRecord::RecordInvalid if the record is invalid.</p>
</dd><dt><code>reload_association</code></dt>
<dd>
<p>Returns the associated object, forcing a database read.</p>
</dd><dt><code>reset_association</code></dt>
<dd>
<p>Unloads the associated object. The next access will query it from the database.</p>
</dd></dl>

<h4 id="label-Example">Example</h4>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_beneficiary'>beneficiary</span>
<span class='kw'>end</span></code></pre>

<p>Declaring <code>has_one :beneficiary</code> adds the following methods (and more):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_account'>account</span> <span class='op'>=</span> <span class='const'>Account</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>5</span>)
<span class='id identifier rubyid_beneficiary'>beneficiary</span> <span class='op'>=</span> <span class='const'>Beneficiary</span>.<span class='id identifier rubyid_find'>find</span>(<span class='int'>8</span>)

<span class='id identifier rubyid_account'>account</span>.<span class='id identifier rubyid_beneficiary'>beneficiary</span>               <span class='comment'># similar to Beneficiary.find_by(account_id: 5)
</span><span class='id identifier rubyid_account'>account</span>.<span class='id identifier rubyid_beneficiary'>beneficiary</span> <span class='op'>=</span> <span class='id identifier rubyid_beneficiary'>beneficiary</span> <span class='comment'># similar to beneficiary.update(account_id: 5)
</span><span class='id identifier rubyid_account'>account</span>.<span class='id identifier rubyid_build_beneficiary'>build_beneficiary</span>         <span class='comment'># similar to Beneficiary.new(account_id: 5)
</span><span class='id identifier rubyid_account'>account</span>.<span class='id identifier rubyid_create_beneficiary'>create_beneficiary</span>        <span class='comment'># similar to Beneficiary.create(account_id: 5)
</span><span class='id identifier rubyid_account'>account</span>.<span class='id identifier rubyid_create_beneficiary!'>create_beneficiary!</span>       <span class='comment'># similar to Beneficiary.create!(account_id: 5)
</span><span class='id identifier rubyid_account'>account</span>.<span class='id identifier rubyid_reload_beneficiary'>reload_beneficiary</span>
<span class='id identifier rubyid_account'>account</span>.<span class='id identifier rubyid_reset_beneficiary'>reset_beneficiary</span></code></pre>

<h4 id="label-Scopes">Scopes</h4>

<p>You can pass a second argument <code>scope</code> as a callable (i.e. proc or lambda) to retrieve a specific record or customize the generated query when you access the associated object.</p>

<p>Scope examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>comment_id:</span> <span class='int'>1</span>) }
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_employer'>employer</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_company'>company</span>) }
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_latest_post'>latest_post</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_blog'>blog</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>created_at &gt; ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_blog'>blog</span>.<span class='id identifier rubyid_enabled_at'>enabled_at</span>) }</code></pre>

<h4 id="label-Options">Options</h4>

<p>The declaration can also include an <code>options</code> hash to specialize the behavior of the association.</p>

<p>Options are:</p>
<dl class="rdoc-list label-list"><dt><code>:class_name</code></dt>
<dd>
<p>Specify the class name of the association. Use it only if that name can’t be inferred from the association name. So <code>has_one :manager</code> will by default be linked to the Manager class, but if the real class name is Person, you’ll have to specify it with this option.</p>
</dd><dt><code>:dependent</code></dt>
<dd>
<p>Controls what happens to the associated object when its owner is destroyed:</p>
<ul><li>
<p><code>nil</code> do nothing (default).</p>
</li><li>
<p><code>:destroy</code> causes the associated object to also be destroyed</p>
</li><li>
<p><code>:destroy_async</code> causes the associated object to be destroyed in a background job. <strong>WARNING:</strong> Do not use this option if the association is backed by foreign key constraints in your database. The foreign key constraint actions will occur inside the same transaction that deletes its owner.</p>
</li><li>
<p><code>:delete</code> causes the associated object to be deleted directly from the database (so callbacks will not execute)</p>
</li><li>
<p><code>:nullify</code> causes the foreign key to be set to <code>NULL</code>. Polymorphic type column is also nullified on polymorphic associations. Callbacks are not executed.</p>
</li><li>
<p><code>:restrict_with_exception</code> causes an ActiveRecord::DeleteRestrictionError exception to be raised if there is an associated record</p>
</li><li>
<p><code>:restrict_with_error</code> causes an error to be added to the owner if there is an associated object</p>
</li></ul>

<p>Note that <code>:dependent</code> option is ignored when using <code>:through</code> option.</p>
</dd><dt><code>:foreign_key</code></dt>
<dd>
<p>Specify the foreign key used for the association. By default this is guessed to be the name of this class in lower-case and “_id” suffixed. So a Person class that makes a #has_one association will use “person_id” as the default <code>:foreign_key</code>.</p>

<p>Setting the <code>:foreign_key</code> option prevents automatic detection of the association’s inverse, so it is generally a good idea to set the <code>:inverse_of</code> option as well.</p>
</dd><dt><code>:foreign_type</code></dt>
<dd>
<p>Specify the column used to store the associated object’s type, if this is a polymorphic association. By default this is guessed to be the name of the polymorphic association specified on “as” option with a “_type” suffix. So a class that defines a <code>has_one :tag, as: :taggable</code> association will use “taggable_type” as the default <code>:foreign_type</code>.</p>
</dd><dt><code>:primary_key</code></dt>
<dd>
<p>Specify the method that returns the primary key used for the association. By default this is <code>id</code>.</p>
</dd><dt><code>:as</code></dt>
<dd>
<p>Specifies a polymorphic interface (See #belongs_to).</p>
</dd><dt><code>:through</code></dt>
<dd>
<p>Specifies a Join Model through which to perform the query. Options for <code>:class_name</code>, <code>:primary_key</code>, and <code>:foreign_key</code> are ignored, as the association uses the source reflection. You can only use a <code>:through</code> query through a #has_one or #belongs_to association on the join model.</p>

<p>If the association on the join model is a #belongs_to, the collection can be modified and the records on the <code>:through</code> model will be automatically created and removed as appropriate. Otherwise, the collection is read-only, so you should manipulate the <code>:through</code> association directly.</p>

<p>If you are going to modify the association (rather than just read from it), then it is a good idea to set the <code>:inverse_of</code> option on the source association on the join model. This allows associated records to be built which will automatically create the appropriate join model records when they are saved. See <a href="Associations::ClassMethods.html#label-Association+Join+Models" title="Association Join Models">Association Join Models</a> and <a href="Associations::ClassMethods.html#label-Setting+Inverses" title="Setting Inverses">Setting Inverses</a> for more detail.</p>
</dd><dt><code>:disable_joins</code></dt>
<dd>
<p>Specifies whether joins should be skipped for an association. If set to true, two or more queries will be generated. Note that in some cases, if order or limit is applied, it will be done in-memory due to database limitations. This option is only applicable on <code>has_one :through</code> associations as <code>has_one</code> alone does not perform a join.</p>
</dd><dt><code>:source</code></dt>
<dd>
<p>Specifies the source association name used by #has_one <code>:through</code> queries. Only use it if the name cannot be inferred from the association. <code>has_one :favorite, through: :favorites</code> will look for a <code>:favorite</code> on Favorite, unless a <code>:source</code> is given.</p>
</dd><dt><code>:source_type</code></dt>
<dd>
<p>Specifies type of the source association used by #has_one <code>:through</code> queries where the source association is a polymorphic #belongs_to.</p>
</dd><dt><code>:validate</code></dt>
<dd>
<p>When set to <code>true</code>, validates new objects added to association when saving the parent object. <code>false</code> by default. If you want to ensure associated objects are revalidated on every update, use <code>validates_associated</code>.</p>
</dd><dt><code>:autosave</code></dt>
<dd>
<p>If <code>true</code>, always saves the associated object or destroys it if marked for destruction, when saving the parent object. If <code>false</code>, never save or destroy the associated object.</p>

<p>By default, only saves the associated object if it’s a new record. Setting this option to <code>true</code> also enables validations on the associated object unless explicitly disabled with <code>validate: false</code>. This is because saving an object with invalid associated objects would fail, so any associated objects will go through validation checks.</p>

<p>Note that NestedAttributes::ClassMethods#accepts_nested_attributes_for sets <code>:autosave</code> to <code>true</code>.</p>
</dd><dt><code>:touch</code></dt>
<dd>
<p>If true, the associated object will be touched (the <code>updated_at</code> / <code>updated_on</code> attributes set to current time) when this record is either saved or destroyed. If you specify a symbol, that attribute will be updated with the current time in addition to the <code>updated_at</code> / <code>updated_on</code> attribute. Please note that no validation will be performed when touching, and only the <code>after_touch</code>, <code>after_commit</code>, and <code>after_rollback</code> callbacks will be executed.</p>
</dd><dt><code>:inverse_of</code></dt>
<dd>
<p>Specifies the name of the #belongs_to association on the associated object that is the inverse of this #has_one association. See <a href="Associations::ClassMethods.html#label-Bi-directional+associations" title="Bi-directional associations">Bi-directional associations</a> for more detail.</p>
</dd><dt><code>:required</code></dt>
<dd>
<p>When set to <code>true</code>, the association will also have its presence validated. This will validate the association itself, not the id. You can use <code>:inverse_of</code> to avoid an extra query during validation.</p>
</dd><dt><code>:strict_loading</code></dt>
<dd>
<p>Enforces strict loading every time the associated record is loaded through this association.</p>
</dd><dt><code>:ensuring_owner_was</code></dt>
<dd>
<p>Specifies an instance method to be called on the owner. The method must return true in order for the associated records to be deleted in a background job.</p>
</dd><dt><code>:query_constraints</code></dt>
<dd>
<p>Serves as a composite foreign key. Defines the list of columns to be used to query the associated object. This is an optional option. By default Rails will attempt to derive the value automatically. When the value is set the Array size must match associated model’s primary key or <code>query_constraints</code> size.</p>
</dd></dl>

<p>Option examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_credit_card'>credit_card</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy'>destroy</span>  <span class='comment'># destroys the associated credit card
</span><span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_credit_card'>credit_card</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_nullify'>nullify</span>  <span class='comment'># updates the associated records foreign
</span>                                              <span class='comment'># key value to NULL rather than destroying it
</span><span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_last_comment'>last_comment</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_order'>order</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>posted_on</span><span class='tstring_end'>&#39;</span></span>) }<span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Comment</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_project_manager'>project_manager</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>role:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>project_manager</span><span class='tstring_end'>&#39;</span></span>) }<span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Person</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_attachment'>attachment</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_attachable'>attachable</span>
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_boss'>boss</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_readonly'>readonly</span> }
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_club'>club</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_membership'>membership</span>
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_club'>club</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_membership'>membership</span><span class='comma'>,</span> <span class='label'>disable_joins:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_address'>primary_address</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>primary:</span> <span class='kw'>true</span>) }<span class='comma'>,</span> <span class='label'>through:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_addressables'>addressables</span><span class='comma'>,</span> <span class='label'>source:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_addressable'>addressable</span>
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_credit_card'>credit_card</span><span class='comma'>,</span> <span class='label'>required:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_credit_card'>credit_card</span><span class='comma'>,</span> <span class='label'>strict_loading:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_employment_record_book'>employment_record_book</span><span class='comma'>,</span> <span class='label'>query_constraints:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_organization_id'>organization_id</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_employee_id'>employee_id</span>]</code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v7.2.3/activerecord/lib/active_record/associations.rb#L1468-L1471'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='1468' data-end='1471'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/associations.rb', line 1468</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_has_one'>has_one</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span>)
  <span class='id identifier rubyid_reflection'>reflection</span> <span class='op'>=</span> <span class='const'><a href="Builder.html" title="ActiveRecord::Associations::Builder (module)">Builder</a></span><span class='op'>::</span><span class='const'><a href="Builder/HasOne.html" title="ActiveRecord::Associations::Builder::HasOne (class)">HasOne</a></span>.<span class='id identifier rubyid_build'><a href="Builder/Association.html#build-class_method" title="ActiveRecord::Associations::Builder::Association.build (method)">build</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_scope'>scope</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span>)
  <span class='const'><a href="../Reflection.html" title="ActiveRecord::Reflection (module)">Reflection</a></span>.<span class='id identifier rubyid_add_reflection'><a href="../Reflection.html#add_reflection-class_method" title="ActiveRecord::Reflection.add_reflection (method)">add_reflection</a></span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_reflection'>reflection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>