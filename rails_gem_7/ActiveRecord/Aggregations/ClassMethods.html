<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ActiveRecord::Aggregations::ClassMethods &mdash; Rails 7.1.3.2</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::Aggregations::ClassMethods",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Rails 7.1.3.2</a> &raquo; 
      <a href='../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
        <a href="../Aggregations.html" title="ActiveRecord::Aggregations (module)">Aggregations</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ClassMethods&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: ActiveRecord::Aggregations::ClassMethods</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Extended In:</div>
      <div class='box_11'>
        <a href="../Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a>
      </div>
    </td></tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/v7.1.3.2/activerecord/lib/active_record/aggregations.rb#L183'>activerecord/lib/active_record/aggregations.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Active Record implements aggregation through a macro-like class method called <a href="#composed_of-instance_method" title="ActiveRecord::Aggregations::ClassMethods#composed_of (method)">#composed_of</a> for representing attributes as value objects. It expresses relationships like “Account [is] composed of Money [among other things]” or “Person [is] composed of [an] address”. Each call to the macro adds a description of how the value objects are created from the attributes of the entity object (when the entity is initialized either as a new object or from finding an existing object) and how it can be turned back into attributes (when the entity is saved to the database).</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Customer</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_composed_of'><a href="#composed_of-instance_method" title="ActiveRecord::Aggregations::ClassMethods#composed_of (method)">composed_of</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_balance'>balance</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Money</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>mapping:</span> { <span class='label'>balance:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_amount'>amount</span> }
  <span class='id identifier rubyid_composed_of'><a href="#composed_of-instance_method" title="ActiveRecord::Aggregations::ClassMethods#composed_of (method)">composed_of</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='label'>mapping:</span> { <span class='label'>address_street:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_street'>street</span><span class='comma'>,</span> <span class='label'>address_city:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_city'>city</span> }
<span class='kw'>end</span></code></pre>

<p>The customer class now has the following methods to manipulate the value objects:</p>
<ul><li>
<p><code>Customer#balance, {Customer#balance=}(money)</code></p>
</li><li>
<p><code>Customer#address, {Customer#address=}(address)</code></p>
</li></ul>

<p>These methods will operate with value objects like the ones described below:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Money</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Comparable</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_currency'>currency</span>
  <span class='const'>EXCHANGE_RATES</span> <span class='op'>=</span> { <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USD_TO_DKK</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>6</span> }

  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span> <span class='id identifier rubyid_currency'>currency</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USD</span><span class='tstring_end'>&quot;</span></span>)
    <span class='ivar'>@amount</span><span class='comma'>,</span> <span class='ivar'>@currency</span> <span class='op'>=</span> <span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span> <span class='id identifier rubyid_currency'>currency</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_exchange_to'>exchange_to</span>(<span class='id identifier rubyid_other_currency'>other_currency</span>)
    <span class='id identifier rubyid_exchanged_amount'>exchanged_amount</span> <span class='op'>=</span> (<span class='id identifier rubyid_amount'>amount</span> <span class='op'>*</span> <span class='const'>EXCHANGE_RATES</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_currency'>currency</span><span class='embexpr_end'>}</span><span class='tstring_content'>_TO_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_other_currency'>other_currency</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>]).<span class='id identifier rubyid_floor'>floor</span>
    <span class='const'>Money</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_exchanged_amount'>exchanged_amount</span><span class='comma'>,</span> <span class='id identifier rubyid_other_currency'>other_currency</span>)
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='op'>==</span>(<span class='id identifier rubyid_other_money'>other_money</span>)
    <span class='id identifier rubyid_amount'>amount</span> <span class='op'>==</span> <span class='id identifier rubyid_other_money'>other_money</span>.<span class='id identifier rubyid_amount'>amount</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_currency'>currency</span> <span class='op'>==</span> <span class='id identifier rubyid_other_money'>other_money</span>.<span class='id identifier rubyid_currency'>currency</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='op'>&lt;=&gt;</span>(<span class='id identifier rubyid_other_money'>other_money</span>)
    <span class='kw'>if</span> <span class='id identifier rubyid_currency'>currency</span> <span class='op'>==</span> <span class='id identifier rubyid_other_money'>other_money</span>.<span class='id identifier rubyid_currency'>currency</span>
      <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&lt;=&gt;</span> <span class='id identifier rubyid_other_money'>other_money</span>.<span class='id identifier rubyid_amount'>amount</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&lt;=&gt;</span> <span class='id identifier rubyid_other_money'>other_money</span>.<span class='id identifier rubyid_exchange_to'>exchange_to</span>(<span class='id identifier rubyid_currency'>currency</span>).<span class='id identifier rubyid_amount'>amount</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Address</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_street'>street</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_city'>city</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_street'>street</span><span class='comma'>,</span> <span class='id identifier rubyid_city'>city</span>)
    <span class='ivar'>@street</span><span class='comma'>,</span> <span class='ivar'>@city</span> <span class='op'>=</span> <span class='id identifier rubyid_street'>street</span><span class='comma'>,</span> <span class='id identifier rubyid_city'>city</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_close_to?'>close_to?</span>(<span class='id identifier rubyid_other_address'>other_address</span>)
    <span class='id identifier rubyid_city'>city</span> <span class='op'>==</span> <span class='id identifier rubyid_other_address'>other_address</span>.<span class='id identifier rubyid_city'>city</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='op'>==</span>(<span class='id identifier rubyid_other_address'>other_address</span>)
    <span class='id identifier rubyid_city'>city</span> <span class='op'>==</span> <span class='id identifier rubyid_other_address'>other_address</span>.<span class='id identifier rubyid_city'>city</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_street'>street</span> <span class='op'>==</span> <span class='id identifier rubyid_other_address'>other_address</span>.<span class='id identifier rubyid_street'>street</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Now it’s possible to access attributes from the database through the value objects instead. If you choose to name the composition the same as the attribute’s name, it will be the only way to access that attribute. That’s the case with our <code>balance</code> attribute. You interact with the value objects just like you would with any other attribute:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_balance'>balance</span> <span class='op'>=</span> <span class='const'>Money</span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>20</span>)     <span class='comment'># sets the Money value object and the attribute
</span><span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_balance'>balance</span>                     <span class='comment'># =&gt; Money value object
</span><span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_balance'>balance</span>.<span class='id identifier rubyid_exchange_to'>exchange_to</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DKK</span><span class='tstring_end'>&quot;</span></span>)  <span class='comment'># =&gt; Money.new(120, &quot;DKK&quot;)
</span><span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_balance'>balance</span> <span class='op'>&gt;</span> <span class='const'>Money</span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>10</span>)     <span class='comment'># =&gt; true
</span><span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_balance'>balance</span> <span class='op'>==</span> <span class='const'>Money</span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>20</span>)    <span class='comment'># =&gt; true
</span><span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_balance'>balance</span> <span class='op'>&lt;</span> <span class='const'>Money</span>.<span class='id identifier rubyid_new'>new</span>(<span class='int'>5</span>)      <span class='comment'># =&gt; false</span></code></pre>

<p>Value objects can also be composed of multiple attributes, such as the case of Address. The order of the mappings will determine the order of the parameters.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_address_street'>address_street</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hyancintvej</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_address_city'>address_city</span>   <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Copenhagen</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_address'>address</span>        <span class='comment'># =&gt; Address.new(&quot;Hyancintvej&quot;, &quot;Copenhagen&quot;)
</span>
<span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_address'>address</span> <span class='op'>=</span> <span class='const'>Address</span>.<span class='id identifier rubyid_new'>new</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>May Street</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Chicago</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_address_street'>address_street</span> <span class='comment'># =&gt; &quot;May Street&quot;
</span><span class='id identifier rubyid_customer'>customer</span>.<span class='id identifier rubyid_address_city'>address_city</span>   <span class='comment'># =&gt; &quot;Chicago&quot;</span></code></pre>

<h3 id="label-Writing+value+objects">Writing value objects</h3>

<p>Value objects are immutable and interchangeable objects that represent a given value, such as a Money object representing $5. Two Money objects both representing $5 should be equal (through methods such as <code>==</code> and <code><=></code> from Comparable if ranking makes sense). This is unlike entity objects where equality is determined by identity. An entity class such as Customer can easily have two different objects that both have an address on Hyancintvej. Entity identity is determined by object or relational unique identifiers (such as primary keys). Normal <a href="../Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> classes are entity objects.</p>

<p>It’s also important to treat the value objects as immutable. Don’t allow the Money object to have its amount changed after creation. Create a new Money object with the new value instead. The <code>Money#exchange_to</code> method is an example of this. It returns a new value object instead of changing its own values. Active Record won’t persist value objects that have been changed through means other than the writer method.</p>

<p>The immutable requirement is enforced by Active Record by freezing any object assigned as a value object. Attempting to change it afterwards will result in a <code>RuntimeError</code>.</p>

<p>Read more about value objects on <a href="http://c2.com/cgi/wiki?ValueObject">c2.com/cgi/wiki?ValueObject</a> and on the dangers of not keeping value objects immutable on <a href="http://c2.com/cgi/wiki?ValueObjectsShouldBeImmutable">c2.com/cgi/wiki?ValueObjectsShouldBeImmutable</a></p>

<h3 id="label-Custom+constructors+and+converters">Custom constructors and converters</h3>

<p>By default value objects are initialized by calling the <code>new</code> constructor of the value class passing each of the mapped attributes, in the order specified by the <code>:mapping</code> option, as arguments. If the value class doesn’t support this convention then <a href="#composed_of-instance_method" title="ActiveRecord::Aggregations::ClassMethods#composed_of (method)">#composed_of</a> allows a custom constructor to be specified.</p>

<p>When a new value is assigned to the value object, the default assumption is that the new value is an instance of the value class. Specifying a custom converter allows the new value to be automatically converted to an instance of value class if necessary.</p>

<p>For example, the <code>NetworkResource</code> model has <code>network_address</code> and <code>cidr_range</code> attributes that should be aggregated using the <code>NetAddr::CIDR</code> value class (<a href="https://www.rubydoc.info/gems/netaddr/1.5.0/NetAddr/CIDR">www.rubydoc.info/gems/netaddr/1.5.0/NetAddr/CIDR</a>). The constructor for the value class is called <code>create</code> and it expects a CIDR address string as a parameter. New values can be assigned to the value object using either another <code>NetAddr::CIDR</code> object, a string or an array. The <code>:constructor</code> and <code>:converter</code> options can be used to meet these requirements:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>NetworkResource</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_composed_of'><a href="#composed_of-instance_method" title="ActiveRecord::Aggregations::ClassMethods#composed_of (method)">composed_of</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_cidr'>cidr</span><span class='comma'>,</span>
              <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>NetAddr::CIDR</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
              <span class='label'>mapping:</span> { <span class='label'>network_address:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_network'>network</span><span class='comma'>,</span> <span class='label'>cidr_range:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_bits'>bits</span> }<span class='comma'>,</span>
              <span class='label'>allow_nil:</span> <span class='kw'>true</span><span class='comma'>,</span>
              <span class='label'>constructor:</span> <span class='const'>Proc</span>.<span class='id identifier rubyid_new'>new</span> { <span class='op'>|</span><span class='id identifier rubyid_network_address'>network_address</span><span class='comma'>,</span> <span class='id identifier rubyid_cidr_range'>cidr_range</span><span class='op'>|</span> <span class='const'>NetAddr</span><span class='op'>::</span><span class='const'>CIDR</span>.<span class='id identifier rubyid_create'>create</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_network_address'>network_address</span><span class='embexpr_end'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cidr_range'>cidr_range</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>) }<span class='comma'>,</span>
              <span class='label'>converter:</span> <span class='const'>Proc</span>.<span class='id identifier rubyid_new'>new</span> { <span class='op'>|</span><span class='id identifier rubyid_value'>value</span><span class='op'>|</span> <span class='const'>NetAddr</span><span class='op'>::</span><span class='const'>CIDR</span>.<span class='id identifier rubyid_create'>create</span>(<span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../../Array.html" title="Array (class)">Array</a></span>) <span class='op'>?</span> <span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/</span><span class='tstring_end'>&#39;</span></span>) <span class='op'>:</span> <span class='id identifier rubyid_value'>value</span>) }
<span class='kw'>end</span>

<span class='comment'># This calls the :constructor
</span><span class='id identifier rubyid_network_resource'>network_resource</span> <span class='op'>=</span> <span class='const'>NetworkResource</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>network_address:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>192.168.0.1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>cidr_range:</span> <span class='int'>24</span>)

<span class='comment'># These assignments will both use the :converter
</span><span class='id identifier rubyid_network_resource'>network_resource</span>.<span class='id identifier rubyid_cidr'>cidr</span> <span class='op'>=</span> [ <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>192.168.2.1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>8</span> ]
<span class='id identifier rubyid_network_resource'>network_resource</span>.<span class='id identifier rubyid_cidr'>cidr</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>192.168.0.1/24</span><span class='tstring_end'>&#39;</span></span>

<span class='comment'># This assignment won&#39;t use the :converter as the value is already an instance of the value class
</span><span class='id identifier rubyid_network_resource'>network_resource</span>.<span class='id identifier rubyid_cidr'>cidr</span> <span class='op'>=</span> <span class='const'>NetAddr</span><span class='op'>::</span><span class='const'>CIDR</span>.<span class='id identifier rubyid_create'>create</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>192.168.2.1/8</span><span class='tstring_end'>&#39;</span></span>)

<span class='comment'># Saving and then reloading will use the :constructor on reload
</span><span class='id identifier rubyid_network_resource'>network_resource</span>.<span class='id identifier rubyid_save'>save</span>
<span class='id identifier rubyid_network_resource'>network_resource</span>.<span class='id identifier rubyid_reload'><a href="../Aggregations.html#reload-instance_method" title="ActiveRecord::Aggregations#reload (method)">reload</a></span></code></pre>

<h3 id="label-Finding+records+by+a+value+object">Finding records by a value object</h3>

<p>Once a <a href="#composed_of-instance_method" title="ActiveRecord::Aggregations::ClassMethods#composed_of (method)">#composed_of</a> relationship is specified for a model, records can be loaded from the database by specifying an instance of the value object in the conditions hash. The following example finds all customers with <code>address_street</code> equal to “May Street” and <code>address_city</code> equal to “Chicago”:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Customer</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>address:</span> <span class='const'>Address</span>.<span class='id identifier rubyid_new'>new</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>May Street</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Chicago</span><span class='tstring_end'>&quot;</span></span>))</code></pre>

  </div>
</div>
</div>
<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#composed_of-instance_method" title="#composed_of (instance method)">#<strong>composed_of</strong>(part_id, options = {})  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Adds reader and writer methods for manipulating a value object: <code>composed_of :address</code> adds <code>address</code> and <code>address=(new_address)</code> methods.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="composed_of-instance_method">
  <h3 class='signature  first'>
    #<strong>composed_of</strong>(part_id, options = {})  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Adds reader and writer methods for manipulating a value object: <code>composed_of :address</code> adds <code>address</code> and <code>address=(new_address)</code> methods.</p>

<p>Options are:</p>
<ul><li>
<p><code>:class_name</code> - Specifies the class name of the association. Use it only if that name can’t be inferred from the part id. So <code>composed_of :address</code> will by default be linked to the Address class, but if the real class name is <code>CompanyAddress</code>, you’ll have to specify it with this option.</p>
</li><li>
<p><code>:mapping</code> - Specifies the mapping of entity attributes to attributes of the value object. Each mapping is represented as a key-value pair where the key is the name of the entity attribute and the value is the name of the attribute in the value object. The order in which mappings are defined determines the order in which attributes are sent to the value class constructor. The mapping can be written as a hash or as an array of pairs.</p>
</li><li>
<p><code>:allow_nil</code> - Specifies that the value object will not be instantiated when all mapped attributes are <code>nil</code>. Setting the value object to <code>nil</code> has the effect of writing <code>nil</code> to all mapped attributes. This defaults to <code>false</code>.</p>
</li><li>
<p><code>:constructor</code> - A symbol specifying the name of the constructor method or a Proc that is called to initialize the value object. The constructor is passed all of the mapped attributes, in the order that they are defined in the <code>:mapping option</code>, as arguments and uses them to instantiate a <code>:class_name</code> object. The default is <code>:new</code>.</p>
</li><li>
<p><code>:converter</code> - A symbol specifying the name of a class method of <code>:class_name</code> or a Proc that is called when a new value is assigned to the value object. The converter is passed the single value that is used in the assignment and is only called if the new value is not an instance of <code>:class_name</code>. If <code>:allow_nil</code> is set to true, the converter can return <code>nil</code> to skip the assignment.</p>
</li></ul>

<p>Option examples:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_composed_of'>composed_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_temperature'>temperature</span><span class='comma'>,</span> <span class='label'>mapping:</span> { <span class='label'>reading:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_celsius'>celsius</span> }
<span class='id identifier rubyid_composed_of'>composed_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_balance'>balance</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Money</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>mapping:</span> { <span class='label'>balance:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_amount'>amount</span> }
<span class='id identifier rubyid_composed_of'>composed_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='label'>mapping:</span> { <span class='label'>address_street:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_street'>street</span><span class='comma'>,</span> <span class='label'>address_city:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_city'>city</span> }
<span class='id identifier rubyid_composed_of'>composed_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='label'>mapping:</span> [ <span class='qwords'><span class='qwords_beg'>%w(</span><span class='tstring_content'>address_street</span><span class='words_sep'> </span><span class='tstring_content'>street</span><span class='tstring_end'>)</span></span><span class='comma'>,</span> <span class='qwords'><span class='qwords_beg'>%w(</span><span class='tstring_content'>address_city</span><span class='words_sep'> </span><span class='tstring_content'>city</span><span class='tstring_end'>)</span></span> ]
<span class='id identifier rubyid_composed_of'>composed_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gps_location'>gps_location</span>
<span class='id identifier rubyid_composed_of'>composed_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_gps_location'>gps_location</span><span class='comma'>,</span> <span class='label'>allow_nil:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_composed_of'>composed_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_ip_address'>ip_address</span><span class='comma'>,</span>
            <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>IPAddr</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
            <span class='label'>mapping:</span> { <span class='label'>ip:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_to_i'>to_i</span> }<span class='comma'>,</span>
            <span class='label'>constructor:</span> <span class='const'>Proc</span>.<span class='id identifier rubyid_new'>new</span> { <span class='op'>|</span><span class='id identifier rubyid_ip'>ip</span><span class='op'>|</span> <span class='const'><a href="../../IPAddr.html" title="IPAddr (class)">IPAddr</a></span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_ip'>ip</span><span class='comma'>,</span> <span class='const'>Socket</span><span class='op'>::</span><span class='const'>AF_INET</span>) }<span class='comma'>,</span>
            <span class='label'>converter:</span> <span class='const'>Proc</span>.<span class='id identifier rubyid_new'>new</span> { <span class='op'>|</span><span class='id identifier rubyid_ip'>ip</span><span class='op'>|</span> <span class='id identifier rubyid_ip'>ip</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../../Integer.html" title="Integer (class)">Integer</a></span>) <span class='op'>?</span> <span class='const'><a href="../../IPAddr.html" title="IPAddr (class)">IPAddr</a></span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_ip'>ip</span><span class='comma'>,</span> <span class='const'>Socket</span><span class='op'>::</span><span class='const'>AF_INET</span>) <span class='op'>:</span> <span class='const'><a href="../../IPAddr.html" title="IPAddr (class)">IPAddr</a></span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_ip'>ip</span>.<span class='id identifier rubyid_to_s'>to_s</span>) }</code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v7.1.3.2/activerecord/lib/active_record/aggregations.rb#L225-L245'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='225' data-end='245'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/aggregations.rb', line 225</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_composed_of'>composed_of</span>(<span class='id identifier rubyid_part_id'>part_id</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> {})
  <span class='id identifier rubyid_options'>options</span>.<span class='id identifier rubyid_assert_valid_keys'>assert_valid_keys</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_class_name'>class_name</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_mapping'>mapping</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_allow_nil'>allow_nil</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_constructor'>constructor</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_converter'>converter</span>)

  <span class='kw'>unless</span> <span class='kw'>self</span> <span class='op'>&lt;</span> <span class='const'><a href="../Aggregations.html" title="ActiveRecord::Aggregations (module)">Aggregations</a></span>
    <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="../Aggregations.html" title="ActiveRecord::Aggregations (module)">Aggregations</a></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_name'>name</span>        <span class='op'>=</span> <span class='id identifier rubyid_part_id'>part_id</span>.<span class='id identifier rubyid_id2name'>id2name</span>
  <span class='id identifier rubyid_class_name'>class_name</span>  <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_class_name'>class_name</span>]  <span class='op'>||</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_camelize'>camelize</span>
  <span class='id identifier rubyid_mapping'>mapping</span>     <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_mapping'>mapping</span>]     <span class='op'>||</span> [ <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span> ]
  <span class='id identifier rubyid_mapping'>mapping</span>     <span class='op'>=</span> [ <span class='id identifier rubyid_mapping'>mapping</span> ] <span class='kw'>unless</span> <span class='id identifier rubyid_mapping'>mapping</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../../Array.html" title="Array (class)">Array</a></span>)
  <span class='id identifier rubyid_allow_nil'>allow_nil</span>   <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_allow_nil'>allow_nil</span>]   <span class='op'>||</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_constructor'>constructor</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_constructor'>constructor</span>] <span class='op'>||</span> <span class='symbeg'>:</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_converter'>converter</span>   <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_converter'>converter</span>]

  <span class='id identifier rubyid_reader_method'>reader_method</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_class_name'>class_name</span><span class='comma'>,</span> <span class='id identifier rubyid_mapping'>mapping</span><span class='comma'>,</span> <span class='id identifier rubyid_allow_nil'>allow_nil</span><span class='comma'>,</span> <span class='id identifier rubyid_constructor'>constructor</span>)
  <span class='id identifier rubyid_writer_method'>writer_method</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_class_name'>class_name</span><span class='comma'>,</span> <span class='id identifier rubyid_mapping'>mapping</span><span class='comma'>,</span> <span class='id identifier rubyid_allow_nil'>allow_nil</span><span class='comma'>,</span> <span class='id identifier rubyid_converter'>converter</span>)

  <span class='id identifier rubyid_reflection'>reflection</span> <span class='op'>=</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Reflection.html" title="ActiveRecord::Reflection (module)">Reflection</a></span>.<span class='id identifier rubyid_create'><a href="../Reflection.html#create-class_method" title="ActiveRecord::Reflection.create (method)">create</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_composed_of'>composed_of</span><span class='comma'>,</span> <span class='id identifier rubyid_part_id'>part_id</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='const'><a href="../Reflection.html" title="ActiveRecord::Reflection (module)">Reflection</a></span>.<span class='id identifier rubyid_add_aggregate_reflection'><a href="../Reflection.html#add_aggregate_reflection-class_method" title="ActiveRecord::Reflection.add_aggregate_reflection (method)">add_aggregate_reflection</a></span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_part_id'>part_id</span><span class='comma'>,</span> <span class='id identifier rubyid_reflection'>reflection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>