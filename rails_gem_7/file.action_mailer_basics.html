<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Action Mailer Basics &mdash; Rails 7.2.2.2</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "action_mailer_basics",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 7.2.2.2</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Action Mailer Basics&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1>Action Mailer Basics</h1>

<p>This guide covers sending emails from your <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> application.</p>

<p>After reading this guide, you will know:</p>

<ul>
<li>How to generate and edit Action Mailer classes and mailer views.</li>
<li>How to send attachments and multipart emails.</li>
<li>How to use Action Mailer callbacks.</li>
<li>How to configure Action Mailer for your environment.</li>
<li>How to preview emails and test your Action Mailer classes.</li>
</ul>

<hr>

<h2>What is Action Mailer?</h2>

<p>Action Mailer allows you to send emails from your <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> application. It&#39;s one of
the two email related components in the <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> framework. The other is <a href="action_mailbox_basics.html">Action
Mailbox</a>, which deals with <em>receiving</em> emails.</p>

<p>Action Mailer uses classes (called &quot;mailers&quot;) and views to create and configure
the email to send. Mailers are classes that inherit from
<a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html"><a href="ActionMailer/Base.html" title="ActionMailer::Base (class)"><code>::ActionMailer::Base</code></a></a>. Mailer classes are similar to controller classes. Both
have:</p>

<ul>
<li>Instance variables that are accessible in views.</li>
<li>The ability to use layouts and partials.</li>
<li>The ability to access a params hash.</li>
<li>Actions and associated views in <code>app/views</code>.</li>
</ul>

<h2>Creating a Mailer and Views</h2>

<p>This section will provide a step-by-step guide to sending email with Action
Mailer. Here are the details of each step.</p>

<h3>Generate the Mailer</h3>

<p>First, you use the &quot;mailer&quot; generator to create the Mailer related classes:</p>

<pre class="code bash"><code class="bash">$ bin/rails generate mailer User
create  app/mailers/user_mailer.rb
invoke  erb
create    app/views/user_mailer
invoke  test_unit
create    test/mailers/user_mailer_test.rb
create    test/mailers/previews/user_mailer_preview.rb
</code></pre>

<p>Like the <code>UserMailer</code> below, all generated Mailer classes inherit from
<code>ApplicationMailer</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/mailers/user_mailer.rb
</span><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
<span class='kw'>end</span></code></pre>

<p>The <code>ApplicationMailer</code> class inherits from <a href="ActionMailer/Base.html" title="ActionMailer::Base (class)"><code>::ActionMailer::Base</code></a>, and can be
used to define attributes common to all Mailers:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/mailers/application_mailer.rb
</span><span class='kw'>class</span> <span class='const'>ApplicationMailer</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionMailer.html" title="ActionMailer (module)">ActionMailer</a></span><span class='op'>::</span><span class='const'><a href="ActionMailer/Base.html" title="ActionMailer::Base (class)">Base</a></span>
  <span class='id identifier rubyid_default'>default</span> <span class='label'>from:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>from@example.com</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_layout'>layout</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mailer</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></code></pre>

<p>If you don&#39;t want to use a generator, you can also manually add a file to the
<code>app/mailers</code> directory. Make sure that your class inherits from
<code>ApplicationMailer</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/mailers/custom_mailer.rb
</span><span class='kw'>class</span> <span class='const'>CustomMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
<span class='kw'>end</span></code></pre>

<h3>Edit the Mailer</h3>

<p>The <code>UserMailer</code> in <code>app/mailers/user_mailer.rb</code> initially doesn&#39;t have any methods. So next, we add
methods (aka actions) to the mailer that will send specific emails.</p>

<p>Mailers have methods called &quot;actions&quot; and they use views to structure their
content, similar to controllers. While a controller generates HTML content to
send back to the client, a Mailer creates a message to be delivered via email.</p>

<p>Let&#39;s add a method called <code>welcome_email</code> to the <code>UserMailer</code>, that will send an
email to the user&#39;s registered email address:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_default'>default</span> <span class='label'>from:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>notifications@example.com</span><span class='tstring_end'>&quot;</span></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_welcome_email'>welcome_email</span>
    <span class='ivar'>@user</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>]
    <span class='ivar'>@url</span>  <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://example.com/login</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_mail'>mail</span>(<span class='label'>to:</span> <span class='ivar'>@user</span>.<span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='label'>subject:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Welcome to My Awesome Site</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: The method names in mailers do not have to end in <code>_email</code>.</p>

<p>Here is a quick explanation of the Mailer related methods used above:</p>

<ul>
<li>The <a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-c-default"><code>default</code></a> method sets default values for all emails sent from <em>this</em>
mailer. In this case, we use it to set the <code>:from</code> header value for all
messages in this class. This can be overridden on a per-email basis.</li>
<li>The <a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-i-mail"><code>mail</code></a> method creates the actual email message. We use it to specify
the values of headers like <code>:to</code> and <code>:subject</code> per email.</li>
</ul>

<p>There is also the <a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-i-headers"><code>headers</code></a> method (not used above), which is used to
specify email headers with a hash or by calling <code>headers[:field_name] = &#39;value&#39;</code>.</p>

<p>It is possible to specify an action directly while using the generator like
this:</p>

<pre class="code bash"><code class="bash">$ bin/rails generate mailer User welcome_email
</code></pre>

<p>The above will generate the <code>UserMailer</code> with an empty <code>welcome_email</code> method.</p>

<p>You can also send multiple emails from a single mailer class. It can be
convenient to group related emails together. For example, the above <code>UserMailer</code>
can have a <code>goodbye_email</code> (and corresponding view) in addition to the
<code>welcome_email</code>.</p>

<h3>Create a Mailer View</h3>

<p>Next, for the <code>welcome_email</code> action, you&#39;ll need to create a matching view in a
file called <code>welcome_email.html.erb</code> in the <code>app/views/user_mailer/</code> directory.
Here is a sample HTML template that can be used for the welcome email:</p>

<pre class="code xml"><code class="xml">&lt;h1&gt;Welcome to example.com, &lt;%= @user.name %&gt;&lt;/h1&gt;
&lt;p&gt;
  You have successfully signed up to example.com,
  your username is: &lt;%= @user.login %&gt;.&lt;br&gt;
&lt;/p&gt;
&lt;p&gt;
  To login to the site, just follow this link: &lt;%= link_to &#39;login`, login_url %&gt;.
&lt;/p&gt;
&lt;p&gt;Thanks for joining and have a great day!&lt;/p&gt;
</code></pre>

<p>NOTE: the above is the content of the <code>&lt;body&gt;</code> tag. It will be embedded in the
default mailer layout, which contains the <code>&lt;html&gt;</code> tag. See <a href="#mailer-views-and-layouts">Mailer
layouts</a> for more.</p>

<p>You can also create a text version of the above email and store it in
<code>welcome_email.text.erb</code> in the <code>app/views/user_mailer/</code> directory (notice the
<code>.text.erb</code> extension vs. the <code>html.erb</code>). Sending both formats is considered
best practice because, in case of HTML rendering issues, the text version can
serve as a reliable fallback. Here is a sample text email:</p>

<pre class="code erb"><code class="erb">Welcome to example.com, &lt;%= @user.name %&gt;
===============================================

You have successfully signed up to example.com,
your username is: &lt;%= @user.login %&gt;.

To login to the site, just follow this link: &lt;%= @url %&gt;.

Thanks for joining and have a great day!
</code></pre>

<p>Notice that in both HTML and text email templates you can use the instance
variables <code>@user</code> and <code>@url</code>.</p>

<p>Now, when you call the <code>mail</code> method, Action Mailer will detect the two
templates(text and HTML) and automatically generate a <code>multipart/alternative</code>
email.</p>

<h3>Call the Mailer</h3>

<p>Once you have a mailer class and view set up, the next step is to actually call
the mailer method that renders the email view (i.e. sends the email). Mailers
can be thought of as another way of rendering views. Controller actions render a
view to be sent over the HTTP protocol. Mailer actions render a view and send it
through email protocols instead.</p>

<p>Let&#39;s see an example of using the <code>UserMailer</code> to send a welcome email when a
user is successfully created.</p>

<p>First, let&#39;s create a <code>User</code> scaffold:</p>

<pre class="code bash"><code class="bash">$ bin/rails generate scaffold user name email login
$ bin/rails db:migrate
</code></pre>

<p>Next, we edit the <code>create</code> action in the <code>UserController</code> to send a welcome
email when a new user is created. We do this by inserting a call to
<code>UserMailer.with(user: @user).welcome_email</code> right after the user is
successfully saved.</p>

<p>NOTE: We use <a href="https://api.rubyonrails.org/classes/ActionMailer/MessageDelivery.html#method-i-deliver_later"><code>deliver_later</code></a> to enqueue the email to be sent later. This
way, the controller action will continue without waiting for the email sending
code to run. The <code>deliver_later</code> method is backed by <a href="active_job_basics.html#action-mailer">Active
Job</a>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UsersController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># ...
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
    <span class='ivar'>@user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_user_params'>user_params</span>)

    <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='ivar'>@user</span>.<span class='id identifier rubyid_save'>save</span>
        <span class='comment'># Tell the UserMailer to send a welcome email after save
</span>        <span class='const'>UserMailer</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>user:</span> <span class='ivar'>@user</span>).<span class='id identifier rubyid_welcome_email'>welcome_email</span>.<span class='id identifier rubyid_deliver_later'>deliver_later</span>

        <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_html'>html</span> { <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_user_url'>user_url</span>(<span class='ivar'>@user</span>)<span class='comma'>,</span> <span class='label'>notice:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User was successfully created.</span><span class='tstring_end'>&quot;</span></span> }
        <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_json'>json</span> { <span class='id identifier rubyid_render'>render</span> <span class='symbeg'>:</span><span class='id identifier rubyid_show'>show</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_created'>created</span><span class='comma'>,</span> <span class='label'>location:</span> <span class='ivar'>@user</span> }
      <span class='kw'>else</span>
        <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_html'>html</span> { <span class='id identifier rubyid_render'>render</span> <span class='symbeg'>:</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unprocessable_entity'>unprocessable_entity</span> }
        <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_json'>json</span> { <span class='id identifier rubyid_render'>render</span> <span class='label'>json:</span> <span class='ivar'>@user</span>.<span class='id identifier rubyid_errors'>errors</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_unprocessable_entity'>unprocessable_entity</span> }
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># ...
</span><span class='kw'>end</span></code></pre>

<p>Any key-value pair passed to <a href="https://api.rubyonrails.org/classes/ActionMailer/Parameterized/ClassMethods.html#method-i-with"><code>with</code></a> becomes the <code>params</code> for the Mailer
action. For example, <code>with(user: @user, account: @user.account)</code> makes
<code>params[:user]</code> and <code>params[:account]</code> available in the Mailer action.</p>

<p>With the above mailer, view, and controller set up, if you create a new <code>User</code>,
you can examine the logs to see the welcome email being sent. The log file will
show the text and HTML versions being sent, like this:</p>

<pre class="code bash"><code class="bash">[ActiveJob] [ActionMailer::MailDeliveryJob] [ec4b3786-b9fc-4b5e-8153-9153095e1cbf] Delivered mail 6661f55087e34_1380c7eb86934d@Bhumis-MacBook-Pro.local.mail (19.9ms)
[ActiveJob] [ActionMailer::MailDeliveryJob] [ec4b3786-b9fc-4b5e-8153-9153095e1cbf] Date: Thu, 06 Jun 2024 12:43:44 -0500
From: notifications@example.com
To: test@gmail.com
Message-ID: &lt;6661f55087e34_1380c7eb86934d@Bhumis-MacBook-Pro.local.mail&gt;
Subject: Welcome to My Awesome Site
Mime-Version: 1.0
Content-Type: multipart/alternative;
 boundary=&quot;--==_mimepart_6661f55086194_1380c7eb869259&quot;;
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_6661f55086194_1380c7eb869259
Content-Type: text/plain;

...

----==_mimepart_6661f55086194_1380c7eb869259
Content-Type: text/html;

...
</code></pre>

<p>You can also call the mailer from the Rails console and send emails, perhaps
useful as a test before you have a controller action set up. The below will send
the same <code>welcome_email</code> as above:</p>

<pre class="code irb"><code class="irb">irb&gt; user = User.first
irb&gt; UserMailer.with(user: user).welcome_email.deliver_later
</code></pre>

<p>If you want to send emails right away (from a cronjob for example) you can call
<a href="https://api.rubyonrails.org/classes/ActionMailer/MessageDelivery.html#method-i-deliver_now"><code>deliver_now</code></a>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>SendWeeklySummary</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='const'>User</span>.<span class='id identifier rubyid_find_each'>find_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_user'>user</span><span class='op'>|</span>
      <span class='const'>UserMailer</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>user:</span> <span class='id identifier rubyid_user'>user</span>).<span class='id identifier rubyid_weekly_summary'>weekly_summary</span>.<span class='id identifier rubyid_deliver_now'>deliver_now</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>A method like <code>weekly_summary</code> from <code>UserMailer</code> would return an
<a href="https://api.rubyonrails.org/classes/ActionMailer/MessageDelivery.html"><a href="ActionMailer/MessageDelivery.html" title="ActionMailer::MessageDelivery (class)"><code>::ActionMailer::MessageDelivery</code></a></a> object, which has the methods <code>deliver_now</code>
or <code>deliver_later</code> to send itself now or later. The
<a href="ActionMailer/MessageDelivery.html" title="ActionMailer::MessageDelivery (class)"><code>::ActionMailer::MessageDelivery</code></a> object is a wrapper around a
<a href="https://api.rubyonrails.org/classes/Mail/Message.html"><a href="Mail/Message.html" title="Mail::Message (class)"><code>::Mail::Message</code></a></a>. If you want to inspect, alter, or do anything else with the
<a href="Mail/Message.html" title="Mail::Message (class)"><code>::Mail::Message</code></a> object you can access it with the <a href="https://api.rubyonrails.org/classes/ActionMailer/MessageDelivery.html#method-i-message"><code>message</code></a> method on the
<a href="ActionMailer/MessageDelivery.html" title="ActionMailer::MessageDelivery (class)"><code>::ActionMailer::MessageDelivery</code></a> object.</p>

<p>Here is an example of the <code>MessageDelivery</code> object from the Rails console
example above:</p>

<pre class="code irb"><code class="irb">irb&gt; UserMailer.with(user: user).weekly_summary
#&lt;ActionMailer::MailDeliveryJob:0x00007f84cb0367c0
 @_halted_callback_hook_called=nil,
 @_scheduled_at_time=nil,
 @arguments=
  [&quot;UserMailer&quot;,
   &quot;welcome_email&quot;,
   &quot;deliver_now&quot;,
   {:params=&gt;
     {:user=&gt;
       #&lt;User:0x00007f84c9327198
        id: 1,
        name: &quot;Bhumi&quot;,
        email: &quot;hi@gmail.com&quot;,
        login: &quot;Bhumi&quot;,
        created_at: Thu, 06 Jun 2024 17:43:44.424064000 UTC +00:00,
        updated_at: Thu, 06 Jun 2024 17:43:44.424064000 UTC +00:00&gt;},
    :args=&gt;[]}],
 @exception_executions={},
 @executions=0,
 @job_id=&quot;07747748-59cc-4e88-812a-0d677040cd5a&quot;,
 @priority=nil,
</code></pre>

<h2>Multipart Emails and Attachments</h2>

<p>The <code>multipart</code> MIME type represents a document that&#39;s comprised of multiple component parts, each of which may have its own individual MIME type (such as the <code>text/html</code> and <code>text/plain</code>). The <code>multipart</code> type encapsulates sending multiple files together in one transaction such as attaching multiple files to an email for example.</p>

<h3>Adding Attachments</h3>

<p>You can add an attachment with Action Mailer by passing the file name and
content to the <a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-i-attachments">attachments
method</a>.
Action Mailer will automatically guess the <code>mime_type</code>, set the <code>encoding</code>, and
create the attachment.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_attachments'>attachments</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>filename.jpg</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_read'>read</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/path/to/filename.jpg</span><span class='tstring_end'>&#39;</span></span>)</code></pre>

<p>When the <code>mail</code> method is triggered, it will send a multipart email with an
attachment, properly nested with the top level being <code>multipart/mixed</code> and the
first part being a <code>multipart/alternative</code> containing the plain text and HTML
email messages.</p>

<p>The other way to send attachments is to specify the file name, MIME-type and
encoding headers, and content. Action Mailer will use the settings you pass in.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_encoded_content'>encoded_content</span> <span class='op'>=</span> <span class='const'>SpecialEncode</span>(<span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_read'>read</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/path/to/filename.jpg</span><span class='tstring_end'>&#39;</span></span>))
<span class='id identifier rubyid_attachments'>attachments</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>filename.jpg</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> {
  <span class='label'>mime_type:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/gzip</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>encoding:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SpecialEncoding</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>content:</span> <span class='id identifier rubyid_encoded_content'>encoded_content</span>
}</code></pre>

<p>NOTE: Action Mailer will automatically Base64 encode an attachment. If you want
something different, you can encode your content and pass in the encoded content
as well as the encoding in a <a href="Hash.html" title="Hash (class)"><code>Hash</code></a> to the <code>attachments</code> method. If you specify
an encoding, Action Mailer will not try to Base64 encode the attachment.</p>

<h3>Making Inline Attachments</h3>

<p>Sometimes, you may want to send an attachment (e.g. image) inline, so it appears
within the email body.</p>

<p>In order to do this, first, you turn an attachment into an inline attachment by
calling <code>#inline</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_welcome'>welcome</span>
  <span class='id identifier rubyid_attachments'>attachments</span>.<span class='id identifier rubyid_inline'>inline</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>image.jpg</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_read'>read</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/path/to/image.jpg</span><span class='tstring_end'>&#39;</span></span>)
<span class='kw'>end</span></code></pre>

<p>Then in the view, you can reference <code>attachments</code> as a hash and specify the file
you want to show inline. You can call <code>url</code> on the hash and pass the result into
the
<a href="https://api.rubyonrails.org/classes/ActionView/Helpers/AssetTagHelper.html#method-i-image_tag"><code>image_tag</code></a>
method:</p>

<pre class="code xml"><code class="xml">&lt;p&gt;Hello there, this is the image you requested:&lt;/p&gt;

&lt;%= image_tag attachments[&#39;image.jpg&#39;].url %&gt;
</code></pre>

<p>Since this is a standard call to <code>image_tag</code> you can pass in an options hash
after the attachment URL as well:</p>

<pre class="code xml"><code class="xml">&lt;p&gt;Hello there, this is our image&lt;/p&gt;

&lt;%= image_tag attachments[&#39;image.jpg&#39;].url, alt: &#39;My Photo&#39;, class: &#39;photos&#39; %&gt;
</code></pre>

<h3>Multipart Emails</h3>

<p>As demonstrated in <a href="#create-a-mailer-view">Create a Mailer View</a>, Action Mailer
will automatically send multipart emails if you have different templates for the
same action. For example, if you have a <code>UserMailer</code> with
<code>welcome_email.text.erb</code> and <code>welcome_email.html.erb</code> in
<code>app/views/user_mailer</code>, Action Mailer will automatically send a multipart email
with both the HTML and text versions included as separate parts.</p>

<p>The <a href="https://github.com/mikel/mail">Mail</a> gem has helper methods for making a
<code>multipart/alternate</code> email for <code>text/plain</code> and <code>text/html</code> <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types">MIME
types</a>
and you can manually create any other type of MIME email.</p>

<p>NOTE: The order of the parts getting inserted is determined by the
<code>:parts_order</code> inside of the <a href="ActionMailer/Base.html#default-class_method" title="ActionMailer::Base.default (method)">ActionMailer::Base.default</a> method.</p>

<p>Multipart is also used when you send attachments with email.</p>

<h2>Mailer Views and Layouts</h2>

<p>Action Mailer uses view files to specify the content to be sent in emails.
Mailer views are located in the <code>app/views/name_of_mailer_class</code> directory by
default. Similar to a controller view, the name of the file matches the name of
the mailer method.</p>

<p>Mailer views are rendered within a layout, similar to controller views. Mailer
layouts are located in <code>app/views/layouts</code>. The default layout is
<code>mailer.html.erb</code> and <code>mailer.text.erb</code>. This sections covers various features
around mailer views and layouts.</p>

<h3>Configuring Custom View Paths</h3>

<p>It is possible to change the default mailer view for your action in various
ways, as shown below.</p>

<p>There is a <code>template_path</code> and <code>template_name</code> option to the <code>mail</code> method:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_default'>default</span> <span class='label'>from:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>notifications@example.com</span><span class='tstring_end'>&#39;</span></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_welcome_email'>welcome_email</span>
    <span class='ivar'>@user</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>]
    <span class='ivar'>@url</span>  <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>http://example.com/login</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_mail'>mail</span>(<span class='label'>to:</span> <span class='ivar'>@user</span>.<span class='id identifier rubyid_email'>email</span><span class='comma'>,</span>
         <span class='label'>subject:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Welcome to My Awesome Site</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
         <span class='label'>template_path:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>notifications</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
         <span class='label'>template_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&#39;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The above configures the <code>mail</code> method to look for a template with the name
<code>hello</code> in the <code>app/views/notifications</code> directory.  You can also specify an
array of paths for <code>template_path</code>, and they will be searched in order.</p>

<p>If you need more flexibility, you can also pass a block and render a specific
template. You can also render plain text inline without using a template file:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_default'>default</span> <span class='label'>from:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>notifications@example.com</span><span class='tstring_end'>&#39;</span></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_welcome_email'>welcome_email</span>
    <span class='ivar'>@user</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>]
    <span class='ivar'>@url</span>  <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>http://example.com/login</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_mail'>mail</span>(<span class='label'>to:</span> <span class='ivar'>@user</span>.<span class='id identifier rubyid_email'>email</span><span class='comma'>,</span>
         <span class='label'>subject:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Welcome to My Awesome Site</span><span class='tstring_end'>&#39;</span></span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_html'>html</span> { <span class='id identifier rubyid_render'>render</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>another_template</span><span class='tstring_end'>&#39;</span></span> }
      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_text'>text</span> { <span class='id identifier rubyid_render'>render</span> <span class='label'>plain:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&#39;</span></span> }
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>This will render the template <code>another_template.html.erb</code> for the HTML part and
&quot;hello&quot; for the text part. The
<a href="https://api.rubyonrails.org/classes/ActionController/Rendering.html#method-i-render">render</a>
method is the same one used inside of Action Controller, so you can use all the
same options, such as <code>:plain</code>, <code>:inline</code>, etc.</p>

<p>Lastly, if you need to render a template located outside of the default
<code>app/views/mailer_name/</code> directory, you can apply the <a href="https://api.rubyonrails.org/classes/ActionView/ViewPaths/ClassMethods.html#method-i-prepend_view_path"><code>prepend_view_path</code></a>,
like so:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_prepend_view_path'>prepend_view_path</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>custom/path/to/mailer/view</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># This will try to load &quot;custom/path/to/mailer/view/welcome_email&quot; template
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_welcome_email'>welcome_email</span>
    <span class='comment'># ...
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>There is also an <a href="https://api.rubyonrails.org/classes/ActionView/ViewPaths/ClassMethods.html#method-i-append_view_path"><code>append_view_path</code></a> method.</p>

<h3>Generating URLs in Action Mailer Views</h3>

<p>In order to add URLs to your mailer, you need set the <code>host</code> value to your
application&#39;s domain first. This is because, unlike controllers, the mailer
instance doesn&#39;t have any context about the incoming request.</p>

<p>You can configure the default <code>host</code> across the application in
<code>config/application.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_default_url_options'>default_url_options</span> <span class='op'>=</span> { <span class='label'>host:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>example.com</span><span class='tstring_end'>&#39;</span></span> }</code></pre>

<p>Once the <code>host</code> is configured, it is recommended that email views use the
<code>*_url</code> with the full URL, and not the <code>*_path</code> helpers with relative URL. Since
email clients do not have web request context, <code>*_path</code> helpers have no base URL
to form complete web addresses.</p>

<p>For example, instead of:</p>

<pre class="code xml"><code class="xml">&lt;%= link_to &#39;welcome&#39;, welcome_path %&gt;
</code></pre>

<p>Use:</p>

<pre class="code xml"><code class="xml">&lt;%= link_to &#39;welcome&#39;, welcome_url %&gt;
</code></pre>

<p>By using the full URL, your links will work correctly in your emails.</p>

<h4>Generating URLs with <code>url_for</code></h4>

<p>The <a href="https://api.rubyonrails.org/classes/ActionView/RoutingUrlFor.html#method-i-url_for"><code>url_for</code></a> helper generates a full URL, by default, in templates.</p>

<p>If you haven&#39;t configured the <code>:host</code> option globally, you&#39;ll need to pass it to
<code>url_for</code>.</p>

<pre class="code xml"><code class="xml">&lt;%= url_for(host: &#39;example.com&#39;,
            controller: &#39;welcome&#39;,
            action: &#39;greeting&#39;) %&gt;
</code></pre>

<h4>Generating URLs with Named Routes</h4>

<p>Similar to other URLs, you need to use the <code>*_url</code> variant of named route
helpers in emails as well.</p>

<p>You either configure the <code>:host</code> option globally or make sure to pass it to the
URL helper:</p>

<pre class="code xml"><code class="xml">&lt;%= user_url(@user, host: &#39;example.com&#39;) %&gt;
</code></pre>

<h3>Adding Images in Action Mailer Views</h3>

<p>In order to use the <code>image_tag</code> helper in emails, you need to specify the
<code>:asset_host</code> parameter. This is because a mailer instance doesn&#39;t have any
context about the incoming request.</p>

<p>Usually the <code>:asset_host</code> is consistent across the application, so you can
configure it globally in <code>config/application.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_asset_host'>asset_host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>http://example.com</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>NOTE: Because we can&#39;t infer the protocol from the request, you&#39;ll need to
specify a protocol such as <code>http://</code> or <code>https://</code> in the <code>:asset_host</code> config.</p>

<p>Now you can display an image inside your email.</p>

<pre class="code xml"><code class="xml">&lt;%= image_tag &#39;image.jpg&#39; %&gt;
</code></pre>

<h3>Caching Mailer View</h3>

<p>You can perform fragment caching in mailer views, similar to application views,
using the <a href="https://api.rubyonrails.org/classes/ActionView/Helpers/CacheHelper.html#method-i-cache"><code>cache</code></a> method.</p>

<pre class="code xml"><code class="xml">&lt;% cache do %&gt;
  &lt;%= @company.name %&gt;
&lt;% end %&gt;
</code></pre>

<p>And to use this feature, you need to enable it in your application&#39;s
<code>config/environments/*.rb</code> file:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_perform_caching'>perform_caching</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>Fragment caching is also supported in multipart emails. Read more about caching
in the <a href="caching_with_rails.html">Rails caching guide</a>.</p>

<h3>Action Mailer Layouts</h3>

<p>Just like controller layouts, you can also have mailer layouts. Mailer layouts
are located in <code>app/views/layouts</code>. Here is the default layout:</p>

<pre class="code html"><code class="html"># app/views/layouts/mailer.html.erb
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;
    &lt;style&gt;
      /* Email styles need to be inline */
    &lt;/style&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;%= yield %&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>The above layout is in a file <code>mailer.html.erb</code>. The default layout name is
specified in the <code>ApplicationMailer</code>, as we saw earlier with the line <code>layout
&quot;mailer&quot;</code> in the <a href="#generate-the-mailer">Generate Mailer</a> section. Similar to
controller layouts, you use <code>yield</code> to render the mailer view inside the layout.</p>

<p>To use a different layout for a given mailer, call <a href="https://api.rubyonrails.org/classes/ActionView/Layouts/ClassMethods.html#method-i-layout"><code>layout</code></a>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_layout'>layout</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>awesome</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># Use awesome.(html|text).erb as the layout
</span><span class='kw'>end</span></code></pre>

<p>To use a specific layout for a given email, you can pass in a <code>layout:
&#39;layout_name&#39;</code> option to the render call inside the format block:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_welcome_email'>welcome_email</span>
    <span class='id identifier rubyid_mail'>mail</span>(<span class='label'>to:</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>].<span class='id identifier rubyid_email'>email</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_html'>html</span> { <span class='id identifier rubyid_render'>render</span> <span class='label'>layout:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my_layout</span><span class='tstring_end'>&#39;</span></span> }
      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_text'>text</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The above will render the HTML part using the <code>my_layout.html.erb</code> file and the
text part with the usual <code>user_mailer.text.erb</code> file.</p>

<h2>Sending Email</h2>

<h3>Sending Email to Multiple Recipients</h3>

<p>It is possible to send an email to more than one recipient by setting the <code>:to</code>
field to a list of email addresses. The list of emails can be an array or a
single string with the addresses separated by commas.</p>

<p>For example, to inform all admins of a new registration:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>AdminMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_default'>default</span> <span class='label'>to:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='const'>Admin</span>.<span class='id identifier rubyid_pluck'>pluck</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_email'>email</span>) }<span class='comma'>,</span>
          <span class='label'>from:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>notification@example.com</span><span class='tstring_end'>&#39;</span></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_new_registration'>new_registration</span>(<span class='id identifier rubyid_user'>user</span>)
    <span class='ivar'>@user</span> <span class='op'>=</span> <span class='id identifier rubyid_user'>user</span>
    <span class='id identifier rubyid_mail'>mail</span>(<span class='label'>subject:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>New User Signup: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@user</span>.<span class='id identifier rubyid_email'>email</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The same format can be used to add multiple carbon copy (cc) and blind carbon
copy (bcc) recipients, by setting the <code>:cc</code> and <code>:bcc</code> keys respectively
(similarly to the <code>:to</code> field).</p>

<h3>Sending Email with Name</h3>

<p>It&#39;s possible to show the name, in addition to the email address, of the person
who receives the email or sends the email.</p>

<p>To show the name of the person when they receive the email, you can use
<a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-i-email_address_with_name"><code>email_address_with_name</code></a> method in <code>to:</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_welcome_email'>welcome_email</span>
  <span class='ivar'>@user</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>]
  <span class='id identifier rubyid_mail'>mail</span>(
    <span class='label'>to:</span> <span class='id identifier rubyid_email_address_with_name'>email_address_with_name</span>(<span class='ivar'>@user</span>.<span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='ivar'>@user</span>.<span class='id identifier rubyid_name'>name</span>)<span class='comma'>,</span>
    <span class='label'>subject:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Welcome to My Awesome Site</span><span class='tstring_end'>&#39;</span></span>
  )
<span class='kw'>end</span></code></pre>

<p>The same method in <code>from:</code> works to display the name of the sender:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_default'>default</span> <span class='label'>from:</span> <span class='id identifier rubyid_email_address_with_name'>email_address_with_name</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>notification@example.com</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Example Company Notifications</span><span class='tstring_end'>&#39;</span></span>)
<span class='kw'>end</span></code></pre>

<p>If the name is blank (<code>nil</code> or empty string), it returns the email address.</p>

<h3>Sending Email with Subject Translation</h3>

<p>If you don&#39;t pass a subject to the mail method, Action Mailer will try to find
it in your translations. See the <a href="i18n.html#translations-for-action-mailer-e-mail-subjects">Internationalization
Guide</a> for more.</p>

<h3>Sending Emails without Template Rendering</h3>

<p>There may be cases in which you want to skip the template rendering step and
instead supply the email body as a string. You can achieve this using the
<code>:body</code> option. Remember to set the <code>:content_type</code> option, such as setting it
to <code>text/html</code> below. Rails will default to <code>text/plain</code> as the content type.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_welcome_email'>welcome_email</span>
    <span class='id identifier rubyid_mail'>mail</span>(<span class='label'>to:</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>].<span class='id identifier rubyid_email'>email</span><span class='comma'>,</span>
         <span class='label'>body:</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_email_body'>email_body</span>]<span class='comma'>,</span>
         <span class='label'>content_type:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/html</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
         <span class='label'>subject:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Already rendered!</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Sending Emails with Dynamic Delivery Options</h3>

<p>If you wish to override the default delivery
<a href="#action-mailer-configuration">configuration</a> (e.g. SMTP credentials) while
delivering emails, you can do this using <code>delivery_method_options</code> in the mailer
action.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_welcome_email'>welcome_email</span>
    <span class='ivar'>@user</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>]
    <span class='ivar'>@url</span>  <span class='op'>=</span> <span class='id identifier rubyid_user_url'>user_url</span>(<span class='ivar'>@user</span>)
    <span class='id identifier rubyid_delivery_options'>delivery_options</span> <span class='op'>=</span> { <span class='label'>user_name:</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_company'>company</span>].<span class='id identifier rubyid_smtp_user'>smtp_user</span><span class='comma'>,</span>
                         <span class='label'>password:</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_company'>company</span>].<span class='id identifier rubyid_smtp_password'>smtp_password</span><span class='comma'>,</span>
                         <span class='label'>address:</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_company'>company</span>].<span class='id identifier rubyid_smtp_host'>smtp_host</span> }
    <span class='id identifier rubyid_mail'>mail</span>(<span class='label'>to:</span> <span class='ivar'>@user</span>.<span class='id identifier rubyid_email'>email</span><span class='comma'>,</span>
         <span class='label'>subject:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Please see the Terms and Conditions attached</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
         <span class='label'>delivery_method_options:</span> <span class='id identifier rubyid_delivery_options'>delivery_options</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h2>Action Mailer Callbacks</h2>

<p>Action Mailer allows for you to specify a <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-before_action"><code>before_action</code></a>,
<a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-after_action"><code>after_action</code></a>, and <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-around_action"><code>around_action</code></a> to configure the message, and
<a href="https://api.rubyonrails.org/classes/ActionMailer/Callbacks/ClassMethods.html#method-i-before_deliver"><code>before_deliver</code></a>, <a href="https://api.rubyonrails.org/classes/ActionMailer/Callbacks/ClassMethods.html#method-i-after_deliver"><code>after_deliver</code></a> and <a href="https://api.rubyonrails.org/classes/ActionMailer/Callbacks/ClassMethods.html#method-i-around_deliver"><code>around_deliver</code></a> to control
the delivery.</p>

<p>Callbacks can be specified with a block or a symbol representing a method name
in the mailer class, similar to other callbacks (in controllers or models).</p>

<p>Here are some examples of when you may use one of these callbacks with mailers.</p>

<h3><code>before_action</code></h3>

<p>You can use a <code>before_action</code> to set instance variables, populate the mail
object with defaults, or insert default headers and attachments.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>InvitationsMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_before_action'>before_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_set_inviter_and_invitee'>set_inviter_and_invitee</span>
  <span class='id identifier rubyid_before_action'>before_action</span> { <span class='ivar'>@account</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_inviter'>inviter</span>].<span class='id identifier rubyid_account'>account</span> }

  <span class='id identifier rubyid_default'>default</span> <span class='label'>to:</span>       <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='ivar'>@invitee</span>.<span class='id identifier rubyid_email_address'>email_address</span> }<span class='comma'>,</span>
          <span class='label'>from:</span>     <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_common_address'>common_address</span>(<span class='ivar'>@inviter</span>) }<span class='comma'>,</span>
          <span class='label'>reply_to:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='ivar'>@inviter</span>.<span class='id identifier rubyid_email_address_with_name'>email_address_with_name</span> }

  <span class='kw'>def</span> <span class='id identifier rubyid_account_invitation'>account_invitation</span>
    <span class='id identifier rubyid_mail'>mail</span> <span class='label'>subject:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@inviter</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> invited you to their Basecamp (</span><span class='embexpr_beg'>#{</span><span class='ivar'>@account</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_project_invitation'>project_invitation</span>
    <span class='ivar'>@project</span>    <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_project'>project</span>]
    <span class='ivar'>@summarizer</span> <span class='op'>=</span> <span class='const'>ProjectInvitationSummarizer</span>.<span class='id identifier rubyid_new'>new</span>(<span class='ivar'>@project</span>.<span class='id identifier rubyid_bucket'>bucket</span>)

    <span class='id identifier rubyid_mail'>mail</span> <span class='label'>subject:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@inviter</span>.<span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_familiar'>familiar</span><span class='embexpr_end'>}</span><span class='tstring_content'> added you to a project in Basecamp (</span><span class='embexpr_beg'>#{</span><span class='ivar'>@account</span>.<span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_set_inviter_and_invitee'>set_inviter_and_invitee</span>
      <span class='ivar'>@inviter</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_inviter'>inviter</span>]
      <span class='ivar'>@invitee</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_invitee'>invitee</span>]
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3><code>after_action</code></h3>

<p>You can use an <code>after_action</code> callback with a similar setup as a <code>before_action</code>
but also have access to instance variables that were set in your mailer action.</p>

<p>You can also use an <code>after_action</code> to override delivery method settings by
updating <code>mail.delivery_method.settings</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_before_action'>before_action</span> { <span class='ivar'>@business</span><span class='comma'>,</span> <span class='ivar'>@user</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_business'>business</span>]<span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_user'>user</span>] }

  <span class='id identifier rubyid_after_action'>after_action</span> <span class='symbeg'>:</span><span class='id identifier rubyid_set_delivery_options'>set_delivery_options</span><span class='comma'>,</span>
               <span class='symbeg'>:</span><span class='id identifier rubyid_prevent_delivery_to_guests'>prevent_delivery_to_guests</span><span class='comma'>,</span>
               <span class='symbeg'>:</span><span class='id identifier rubyid_set_business_headers'>set_business_headers</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_feedback_message'>feedback_message</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_campaign_message'>campaign_message</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_set_delivery_options'>set_delivery_options</span>
      <span class='comment'># You have access to the mail instance,
</span>      <span class='comment'># @business and @user instance variables here
</span>      <span class='kw'>if</span> <span class='ivar'>@business</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@business</span>.<span class='id identifier rubyid_has_smtp_settings?'>has_smtp_settings?</span>
        <span class='id identifier rubyid_mail'>mail</span>.<span class='id identifier rubyid_delivery_method'>delivery_method</span>.<span class='id identifier rubyid_settings'>settings</span>.<span class='id identifier rubyid_merge!'>merge!</span>(<span class='ivar'>@business</span>.<span class='id identifier rubyid_smtp_settings'>smtp_settings</span>)
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_prevent_delivery_to_guests'>prevent_delivery_to_guests</span>
      <span class='kw'>if</span> <span class='ivar'>@user</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@user</span>.<span class='id identifier rubyid_guest?'>guest?</span>
        <span class='id identifier rubyid_mail'>mail</span>.<span class='id identifier rubyid_perform_deliveries'>perform_deliveries</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_set_business_headers'>set_business_headers</span>
      <span class='kw'>if</span> <span class='ivar'>@business</span>
        <span class='id identifier rubyid_headers'>headers</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>X-SMTPAPI-CATEGORY</span><span class='tstring_end'>&quot;</span></span>] <span class='op'>=</span> <span class='ivar'>@business</span>.<span class='id identifier rubyid_code'>code</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3><code>after_deliver</code></h3>

<p>You could use an <code>after_deliver</code> to record the delivery of the message. It also
allows observer/interceptor-like behaviors, but with access to the full mailer
context.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_after_deliver'>after_deliver</span> <span class='symbeg'>:</span><span class='id identifier rubyid_mark_delivered'>mark_delivered</span>
  <span class='id identifier rubyid_before_deliver'>before_deliver</span> <span class='symbeg'>:</span><span class='id identifier rubyid_sandbox_staging'>sandbox_staging</span>
  <span class='id identifier rubyid_after_deliver'>after_deliver</span> <span class='symbeg'>:</span><span class='id identifier rubyid_observe_delivery'>observe_delivery</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_feedback_message'>feedback_message</span>
    <span class='ivar'>@feedback</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_feedback'>feedback</span>]
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_mark_delivered'>mark_delivered</span>
      <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_feedback'>feedback</span>].<span class='id identifier rubyid_touch'>touch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_delivered_at'>delivered_at</span>)
    <span class='kw'>end</span>

    <span class='comment'># An Interceptor alternative.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sandbox_staging'>sandbox_staging</span>
      <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_to'>to</span> <span class='op'>=</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sandbox@example.com</span><span class='tstring_end'>&#39;</span></span>] <span class='kw'>if</span> <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_env'><a href="Rails.html#env-class_method" title="Rails.env (method)">env</a></span>.<span class='id identifier rubyid_staging?'>staging?</span>
    <span class='kw'>end</span>

    <span class='comment'># A callback has more context than the comparable Observer example.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_observe_delivery'>observe_delivery</span>
      <span class='const'>EmailDelivery</span>.<span class='id identifier rubyid_log'>log</span>(<span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='kw'>self</span>.<span class='id identifier rubyid_class'>class</span><span class='comma'>,</span> <span class='id identifier rubyid_action_name'>action_name</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span>)
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Mailer callbacks abort further processing if <code>body</code> is set to a non-nil value.
<code>before_deliver</code> can abort with <code>throw :abort</code>.</p>

<h2>Action Mailer View Helpers</h2>

<p>Action Mailer views have access to most of the same helpers as regular views.</p>

<p>There are also some Action Mailer-specific helper methods available in
<a href="https://api.rubyonrails.org/classes/ActionMailer/MailHelper.html"><a href="ActionMailer/MailHelper.html" title="ActionMailer::MailHelper (module)"><code>::ActionMailer::MailHelper</code></a></a>. For example, these allow accessing the mailer
instance from your view with <a href="https://api.rubyonrails.org/classes/ActionMailer/MailHelper.html#method-i-mailer"><code>mailer</code></a>, and accessing the
message as <a href="https://api.rubyonrails.org/classes/ActionMailer/MailHelper.html#method-i-message"><code>message</code></a>:</p>

<pre class="code xml"><code class="xml">&lt;%= stylesheet_link_tag mailer.name.underscore %&gt;
&lt;h1&gt;&lt;%= message.subject %&gt;&lt;/h1&gt;
</code></pre>

<h2>Action Mailer Configuration</h2>

<p>This section shows some example configurations for Action Mailer.</p>

<p>For more details on the various configuration options, see the <a href="configuring.html#configuring-action-mailer">Configuring
Rails Applications</a> guide. You can
specify configuration options in environment specific files such as
production.rb.</p>

<h3>Example Action Mailer Configuration</h3>

<p>Here is an example using the <code>:sendmail</code> delivery method, added to a
<code>config/environments/$RAILS_ENV.rb</code> file:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_delivery_method'>delivery_method</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_sendmail'>sendmail</span>
<span class='comment'># Defaults to:
</span><span class='comment'># config.action_mailer.sendmail_settings = {
</span><span class='comment'>#   location: &#39;/usr/sbin/sendmail&#39;,
</span><span class='comment'>#   arguments: %w[ -i ]
</span><span class='comment'># }
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_perform_deliveries'>perform_deliveries</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_raise_delivery_errors'>raise_delivery_errors</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_default_options'>default_options</span> <span class='op'>=</span> { <span class='label'>from:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>no-reply@example.com</span><span class='tstring_end'>&#39;</span></span> }</code></pre>

<h3>Action Mailer Configuration for Gmail</h3>

<p>Add this to your <code>config/environments/$RAILS_ENV.rb</code> file to send via Gmail:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_delivery_method'>delivery_method</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_smtp'>smtp</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_smtp_settings'>smtp_settings</span> <span class='op'>=</span> {
  <span class='label'>address:</span>         <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>smtp.gmail.com</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>port:</span>            <span class='int'>587</span><span class='comma'>,</span>
  <span class='label'>domain:</span>          <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>example.com</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>user_name:</span>       <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_credentials'>credentials</span>.<span class='id identifier rubyid_dig'>dig</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_smtp'>smtp</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_user_name'>user_name</span>)<span class='comma'>,</span>
  <span class='label'>password:</span>        <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_credentials'>credentials</span>.<span class='id identifier rubyid_dig'>dig</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_smtp'>smtp</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_password'>password</span>)<span class='comma'>,</span>
  <span class='label'>authentication:</span>  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>plain</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>enable_starttls:</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='label'>open_timeout:</span>    <span class='int'>5</span><span class='comma'>,</span>
  <span class='label'>read_timeout:</span>    <span class='int'>5</span> }</code></pre>

<p>NOTE: Google <a href="https://support.google.com/accounts/answer/6010255">blocks
sign-ins</a> from apps it deems
less secure. You can <a href="https://www.google.com/settings/security/lesssecureapps">change your Gmail settings</a> to allow the
attempts. If your Gmail account has 2-factor authentication enabled, then you
will need to set an <a href="https://myaccount.google.com/apppasswords">app password</a>
and use that instead of your regular password.</p>

<h2>Previewing and Testing Mailers</h2>

<p>You can find detailed instructions on how to test your mailers in the <a href="testing.html#testing-your-mailers">testing
guide</a>.</p>

<h3>Previewing Emails</h3>

<p>You can preview rendered email templates visually by visiting a special Action
Mailer preview URL. To set up a preview for <code>UserMailer</code>, create a class named
<code>UserMailerPreview</code> in the <code>test/mailers/previews/</code> directory. To see the
preview of <code>welcome_email</code> from <code>UserMailer</code>, implement a method that has the
same name in <code>UserMailerPreview</code> and call <code>UserMailer.welcome_email</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMailerPreview</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionMailer.html" title="ActionMailer (module)">ActionMailer</a></span><span class='op'>::</span><span class='const'><a href="ActionMailer/Preview.html" title="ActionMailer::Preview (class)">Preview</a></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_welcome_email'>welcome_email</span>
    <span class='const'>UserMailer</span>.<span class='id identifier rubyid_with'>with</span>(<span class='label'>user:</span> <span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span>).<span class='id identifier rubyid_welcome_email'>welcome_email</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Now the preview will be available at
<a href="http://localhost:3000/rails/mailers/user_mailer/welcome_email">http://localhost:3000/rails/mailers/user_mailer/welcome_email</a>.</p>

<p>If you change something in the mailer view at
<code>app/views/user_mailer/welcome_email.html.erb</code> or the mailer itself, the preview
will automatically be updated. A list of previews are also available in
<a href="http://localhost:3000/rails/mailers">http://localhost:3000/rails/mailers</a>.</p>

<p>By default, these preview classes live in <code>test/mailers/previews</code>. This can be
configured using the <code>preview_paths</code> option. For example, if you want to add
<code>lib/mailer_previews</code> to it, you can configure it in <code>config/application.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_preview_paths'>preview_paths</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_root'><a href="Rails.html#root-class_method" title="Rails.root (method)">root</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>/lib/mailer_previews</span><span class='tstring_end'>&quot;</span></span></code></pre>

<h3>Rescuing Errors</h3>

<p>Rescue blocks inside of a mailer method cannot rescue errors that occur outside
of rendering. For example, record deserialization errors in a background job, or
errors from a third-party mail delivery service.</p>

<p>To rescue errors that occur during any part of the mailing process, use
<a href="https://api.rubyonrails.org/classes/ActiveSupport/Rescuable/ClassMethods.html#method-i-rescue_from">rescue_from</a>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>NotifierMailer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationMailer</span>
  <span class='id identifier rubyid_rescue_from'>rescue_from</span> <span class='const'><a href="ActiveJob.html" title="ActiveJob (module)">ActiveJob</a></span><span class='op'>::</span><span class='const'><a href="ActiveJob/DeserializationError.html" title="ActiveJob::DeserializationError (class)">DeserializationError</a></span> <span class='kw'>do</span>
    <span class='comment'># ...
</span>  <span class='kw'>end</span>

  <span class='id identifier rubyid_rescue_from'>rescue_from</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SomeThirdPartyService::ApiError</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='comment'># ...
</span>  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_notify'>notify</span>(<span class='id identifier rubyid_recipient'>recipient</span>)
    <span class='id identifier rubyid_mail'>mail</span>(<span class='label'>to:</span> <span class='id identifier rubyid_recipient'>recipient</span><span class='comma'>,</span> <span class='label'>subject:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Notification</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h2>Intercepting and Observing Emails</h2>

<p>Action Mailer provides hooks into the Mail observer and interceptor methods.
These allow you to register classes that are called during the mail delivery
life cycle of every email sent.</p>

<h3>Intercepting Emails</h3>

<p>Interceptors allow you to make modifications to emails before they are handed
off to the delivery agents. An interceptor class must implement the
<code>.delivering_email(message)</code> method which will be called before the email is
sent.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>SandboxEmailInterceptor</span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_delivering_email'>delivering_email</span>(<span class='id identifier rubyid_message'>message</span>)
    <span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_to'>to</span> <span class='op'>=</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sandbox@example.com</span><span class='tstring_end'>&#39;</span></span>]
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>The interceptor needs to be registered using the <code>interceptors</code> config option.
You can do this in an initializer file like
<code>config/initializers/mail_interceptors.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_configure'>configure</span> <span class='kw'>do</span>
  <span class='kw'>if</span> <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_env'><a href="Rails.html#env-class_method" title="Rails.env (method)">env</a></span>.<span class='id identifier rubyid_staging?'>staging?</span>
    <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_interceptors'>interceptors</span> <span class='op'>=</span> <span class='qwords'><span class='qwords_beg'>%w[</span><span class='tstring_content'>SandboxEmailInterceptor</span><span class='tstring_end'>]</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: The example above uses a custom environment called &quot;staging&quot; for a
production-like server but for testing purposes. You can read <a href="configuring.html#creating-rails-environments">Creating Rails
Environments</a> for more information
about custom Rails environments.</p>

<h3>Observing Emails</h3>

<p>Observers give you access to the email message <em>after</em> it has been sent. An
observer class must implement the <code>:delivered_email(message)</code> method, which will
be called after the email is sent.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>EmailDeliveryObserver</span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_delivered_email'>delivered_email</span>(<span class='id identifier rubyid_message'>message</span>)
    <span class='const'>EmailDelivery</span>.<span class='id identifier rubyid_log'>log</span>(<span class='id identifier rubyid_message'>message</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Similar to interceptors, you must register observers using the <code>observers</code>
config option. You can do this in an initializer file like
<code>config/initializers/mail_observers.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_configure'>configure</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_observers'>observers</span> <span class='op'>=</span> <span class='qwords'><span class='qwords_beg'>%w[</span><span class='tstring_content'>EmailDeliveryObserver</span><span class='tstring_end'>]</span></span>
<span class='kw'>end</span></code></pre>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>