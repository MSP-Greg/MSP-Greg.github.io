<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Bundler::CompactIndexClient::Updater &mdash; bundler  Ruby-3.3.9 p170</title>

<link rel='stylesheet'  type='text/css' href='../../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Bundler::CompactIndexClient::Updater",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../../'>Ruby-3.3.9</a> &raquo; 
      <a href='../../'>bundler</a> &raquo; 
      <a href='../../_index.html#alpha_U'>Index (U)</a> &raquo; 
        <a href="../../Bundler.html" title="Bundler (module)">Bundler</a> &raquo; 
        <a href="../CompactIndexClient.html" title="Bundler::CompactIndexClient (class)">CompactIndexClient</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Updater&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Bundler::CompactIndexClient::Updater</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Exceptions:</div>
      <div class='box_11'>
          <a href="Updater/MismatchedChecksumError.html" title="Bundler::CompactIndexClient::Updater::MismatchedChecksumError (class)"><code>MismatchedChecksumError</code></a>      </div>
    </td></tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L5'>lib/bundler/compact_index_client/updater.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(fetcher)  &#x21d2; Updater </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#update-instance_method" title="#update (instance method)">#<strong>update</strong>(remote_path, local_path, etag_path)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#append-instance_method" title="#append (instance method)">#<strong>append</strong>(remote_path, local_path, etag_path)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#byte_sequence-instance_method" title="#byte_sequence (instance method)">#<strong>byte_sequence</strong>(value)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Unwrap surrounding colons (byte sequence) The wrapping characters must be matched or we return nil.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#etag_for_request-instance_method" title="#etag_for_request (instance method)">#<strong>etag_for_request</strong>(etag_path)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#etag_from_response-instance_method" title="#etag_from_response (instance method)">#<strong>etag_from_response</strong>(response)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#generate_etag-instance_method" title="#generate_etag (instance method)">#<strong>generate_etag</strong>(etag_path, file)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>When first releasing this opaque etag feature, we want to generate the old MD5 etag based on the content of the file.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#parse_digests-instance_method" title="#parse_digests (instance method)">#<strong>parse_digests</strong>(response)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Unwraps and returns a Hash of digest algorithms and base64 values according to RFC 8941 Structured Field Values for HTTP.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#replace-instance_method" title="#replace (instance method)">#<strong>replace</strong>(remote_path, local_path, etag_path)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>request without range header to get the full file or a 304 Not Modified.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#request_headers-instance_method" title="#request_headers (instance method)">#<strong>request_headers</strong>(etag, range_start = nil)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(fetcher)  &#x21d2; <code>Updater</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L12-L14'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='12' data-end='14'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/bundler/compact_index_client/updater.rb', line 12</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_fetcher'>fetcher</span>)
  <span class='ivar'>@fetcher</span> <span class='op'>=</span> <span class='id identifier rubyid_fetcher'>fetcher</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="append-instance_method">
  <h3 class='signature priv first'>
    #<strong>append</strong>(remote_path, local_path, etag_path)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L26-L48'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='26' data-end='48'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/bundler/compact_index_client/updater.rb', line 26</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_append'>append</span>(<span class='id identifier rubyid_remote_path'>remote_path</span><span class='comma'>,</span> <span class='id identifier rubyid_local_path'>local_path</span><span class='comma'>,</span> <span class='id identifier rubyid_etag_path'>etag_path</span>)
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='id identifier rubyid_local_path'>local_path</span>.<span class='id identifier rubyid_file?'>file?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_local_path'>local_path</span>.<span class='id identifier rubyid_size'>size</span>.<span class='id identifier rubyid_nonzero?'>nonzero?</span>

  <span class='const'><a href="CacheFile.html" title="Bundler::CompactIndexClient::CacheFile (class)">CacheFile</a></span>.<span class='id identifier rubyid_copy'><a href="CacheFile.html#copy-class_method" title="Bundler::CompactIndexClient::CacheFile.copy (method)">copy</a></span>(<span class='id identifier rubyid_local_path'>local_path</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_file'>file</span><span class='op'>|</span>
    <span class='id identifier rubyid_etag'>etag</span> <span class='op'>=</span> <span class='id identifier rubyid_etag_path'>etag_path</span>.<span class='id identifier rubyid_read'>read</span>.<span class='id identifier rubyid_tap'>tap</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_chomp!'>chomp!</span>) <span class='kw'>if</span> <span class='id identifier rubyid_etag_path'>etag_path</span>.<span class='id identifier rubyid_file?'>file?</span>
    <span class='id identifier rubyid_etag'>etag</span> <span class='op'>||=</span> <span class='id identifier rubyid_generate_etag'><a href="#generate_etag-instance_method" title="Bundler::CompactIndexClient::Updater#generate_etag (method)">generate_etag</a></span>(<span class='id identifier rubyid_etag_path'>etag_path</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span>) <span class='comment'># Remove this after 2.5.0 has been out for a while.
</span>
    <span class='comment'># Subtract a byte to ensure the range won&#39;t be empty.
</span>    <span class='comment'># Avoids 416 (Range Not Satisfiable) responses.
</span>    <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='ivar'>@fetcher</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_remote_path'>remote_path</span><span class='comma'>,</span> <span class='id identifier rubyid_request_headers'><a href="#request_headers-instance_method" title="Bundler::CompactIndexClient::Updater#request_headers (method)">request_headers</a></span>(<span class='id identifier rubyid_etag'>etag</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>-</span> <span class='int'>1</span>))
    <span class='kw'>break</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../../Gem.html" title="Gem (module)">Gem</a></span><span class='op'>::</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTPNotModified</span>)

    <span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_digests'>digests</span> <span class='op'>=</span> <span class='id identifier rubyid_parse_digests'><a href="#parse_digests-instance_method" title="Bundler::CompactIndexClient::Updater#parse_digests (method)">parse_digests</a></span>(<span class='id identifier rubyid_response'>response</span>)
    <span class='comment'># server may ignore Range and return the full response
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../../Gem.html" title="Gem (module)">Gem</a></span><span class='op'>::</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTPPartialContent</span>)
      <span class='kw'>break</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_append'>append</span>(<span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_byteslice'>byteslice</span>(<span class='int'>1</span><span class='op'>..</span><span class='op'>-</span><span class='int'>1</span>))
    <span class='kw'>else</span>
      <span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_write'>write</span>(<span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_body'>body</span>)
    <span class='kw'>end</span>
    <span class='const'><a href="CacheFile.html" title="Bundler::CompactIndexClient::CacheFile (class)">CacheFile</a></span>.<span class='id identifier rubyid_write'><a href="CacheFile.html#write-class_method" title="Bundler::CompactIndexClient::CacheFile.write (method)">write</a></span>(<span class='id identifier rubyid_etag_path'>etag_path</span><span class='comma'>,</span> <span class='id identifier rubyid_etag_from_response'><a href="#etag_from_response-instance_method" title="Bundler::CompactIndexClient::Updater#etag_from_response (method)">etag_from_response</a></span>(<span class='id identifier rubyid_response'>response</span>))
    <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="byte_sequence-instance_method">
  <h3 class='signature priv'>
    #<strong>byte_sequence</strong>(value)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Unwrap surrounding colons (byte sequence) The wrapping characters must be matched or we return nil. Also handles quotes because right now rubygems.org sends them.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L108-L112'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='108' data-end='112'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/bundler/compact_index_client/updater.rb', line 108</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_byte_sequence'>byte_sequence</span>(<span class='id identifier rubyid_value'>value</span>)
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_delete_prefix!'>delete_prefix!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_delete_suffix!'>delete_suffix!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_delete_prefix!'>delete_prefix!</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_delete_suffix!'>delete_suffix!</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="etag_for_request-instance_method">
  <h3 class='signature priv'>
    #<strong>etag_for_request</strong>(etag_path)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L66-L68'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='66' data-end='68'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/bundler/compact_index_client/updater.rb', line 66</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_etag_for_request'>etag_for_request</span>(<span class='id identifier rubyid_etag_path'>etag_path</span>)
  <span class='id identifier rubyid_etag_path'>etag_path</span>.<span class='id identifier rubyid_read'>read</span>.<span class='id identifier rubyid_tap'>tap</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_chomp!'>chomp!</span>) <span class='kw'>if</span> <span class='id identifier rubyid_etag_path'>etag_path</span>.<span class='id identifier rubyid_file?'>file?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="etag_from_response-instance_method">
  <h3 class='signature priv'>
    #<strong>etag_from_response</strong>(response)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L80-L85'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='80' data-end='85'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/bundler/compact_index_client/updater.rb', line 80</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_etag_from_response'>etag_from_response</span>(<span class='id identifier rubyid_response'>response</span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_response'>response</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ETag</span><span class='tstring_end'>&quot;</span></span>]
  <span class='id identifier rubyid_etag'>etag</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ETag</span><span class='tstring_end'>&quot;</span></span>].<span class='id identifier rubyid_delete_prefix'>delete_prefix</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>W/</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_etag'>etag</span>.<span class='id identifier rubyid_delete_prefix!'>delete_prefix!</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_etag'>etag</span>.<span class='id identifier rubyid_delete_suffix!'>delete_suffix!</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>)
  <span class='id identifier rubyid_etag'>etag</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="generate_etag-instance_method">
  <h3 class='signature priv'>
    #<strong>generate_etag</strong>(etag_path, file)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>When first releasing this opaque etag feature, we want to generate the old MD5 etag based on the content of the file. After that it will always use the saved opaque etag. This transparently saves existing users with good caches from updating a bunch of files. Remove this behavior after 2.5.0 has been out for a while.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L74-L78'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='74' data-end='78'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/bundler/compact_index_client/updater.rb', line 74</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_etag'>generate_etag</span>(<span class='id identifier rubyid_etag_path'>etag_path</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span>)
  <span class='id identifier rubyid_etag'>etag</span> <span class='op'>=</span> <span class='id identifier rubyid_file'>file</span>.<span class='id identifier rubyid_md5'>md5</span>.<span class='id identifier rubyid_hexdigest'>hexdigest</span>
  <span class='const'><a href="CacheFile.html" title="Bundler::CompactIndexClient::CacheFile (class)">CacheFile</a></span>.<span class='id identifier rubyid_write'><a href="CacheFile.html#write-class_method" title="Bundler::CompactIndexClient::CacheFile.write (method)">write</a></span>(<span class='id identifier rubyid_etag_path'>etag_path</span><span class='comma'>,</span> <span class='id identifier rubyid_etag'>etag</span>)
  <span class='id identifier rubyid_etag'>etag</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="parse_digests-instance_method">
  <h3 class='signature priv'>
    #<strong>parse_digests</strong>(response)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Unwraps and returns a Hash of digest algorithms and base64 values according to RFC 8941 Structured Field Values for HTTP. <a href="https://www.rfc-editor.org/rfc/rfc8941#name-parsing-a-byte-sequence">www.rfc-editor.org/rfc/rfc8941#name-parsing-a-byte-sequence</a> Ignores unsupported algorithms.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L91-L103'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='91' data-end='103'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/bundler/compact_index_client/updater.rb', line 91</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_parse_digests'>parse_digests</span>(<span class='id identifier rubyid_response'>response</span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_header'>header</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Repr-Digest</span><span class='tstring_end'>&quot;</span></span>] <span class='op'>||</span> <span class='id identifier rubyid_response'>response</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Digest</span><span class='tstring_end'>&quot;</span></span>]
  <span class='id identifier rubyid_digests'>digests</span> <span class='op'>=</span> {}
  <span class='id identifier rubyid_header'>header</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>,</span><span class='tstring_end'>&quot;</span></span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_param'>param</span><span class='op'>|</span>
    <span class='id identifier rubyid_algorithm'>algorithm</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_param'>param</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>=</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>2</span>)
    <span class='id identifier rubyid_algorithm'>algorithm</span>.<span class='id identifier rubyid_strip!'>strip!</span>
    <span class='id identifier rubyid_algorithm'>algorithm</span>.<span class='id identifier rubyid_downcase!'>downcase!</span>
    <span class='kw'>next</span> <span class='kw'>unless</span> <span class='const'><a href="../CompactIndexClient.html#SUPPORTED_DIGESTS-constant" title="Bundler::CompactIndexClient::SUPPORTED_DIGESTS (constant)">SUPPORTED_DIGESTS</a></span>.<span class='id identifier rubyid_key?'>key?</span>(<span class='id identifier rubyid_algorithm'>algorithm</span>)
    <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_byte_sequence'><a href="#byte_sequence-instance_method" title="Bundler::CompactIndexClient::Updater#byte_sequence (method)">byte_sequence</a></span>(<span class='id identifier rubyid_value'>value</span>)
    <span class='id identifier rubyid_digests'>digests</span>[<span class='id identifier rubyid_algorithm'>algorithm</span>] <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_digests'>digests</span>.<span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='id identifier rubyid_digests'>digests</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="replace-instance_method">
  <h3 class='signature priv'>
    #<strong>replace</strong>(remote_path, local_path, etag_path)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>request without range header to get the full file or a 304 Not Modified</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L51-L57'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='51' data-end='57'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/bundler/compact_index_client/updater.rb', line 51</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_replace'>replace</span>(<span class='id identifier rubyid_remote_path'>remote_path</span><span class='comma'>,</span> <span class='id identifier rubyid_local_path'>local_path</span><span class='comma'>,</span> <span class='id identifier rubyid_etag_path'>etag_path</span>)
  <span class='id identifier rubyid_etag'>etag</span> <span class='op'>=</span> <span class='id identifier rubyid_etag_path'>etag_path</span>.<span class='id identifier rubyid_read'>read</span>.<span class='id identifier rubyid_tap'>tap</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_chomp!'>chomp!</span>) <span class='kw'>if</span> <span class='id identifier rubyid_etag_path'>etag_path</span>.<span class='id identifier rubyid_file?'>file?</span>
  <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='ivar'>@fetcher</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_remote_path'>remote_path</span><span class='comma'>,</span> <span class='id identifier rubyid_request_headers'><a href="#request_headers-instance_method" title="Bundler::CompactIndexClient::Updater#request_headers (method)">request_headers</a></span>(<span class='id identifier rubyid_etag'>etag</span>))
  <span class='kw'>return</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../../Gem.html" title="Gem (module)">Gem</a></span><span class='op'>::</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTPNotModified</span>)
  <span class='const'><a href="CacheFile.html" title="Bundler::CompactIndexClient::CacheFile (class)">CacheFile</a></span>.<span class='id identifier rubyid_write'><a href="CacheFile.html#write-class_method" title="Bundler::CompactIndexClient::CacheFile.write (method)">write</a></span>(<span class='id identifier rubyid_local_path'>local_path</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span>.<span class='id identifier rubyid_body'>body</span><span class='comma'>,</span> <span class='id identifier rubyid_parse_digests'><a href="#parse_digests-instance_method" title="Bundler::CompactIndexClient::Updater#parse_digests (method)">parse_digests</a></span>(<span class='id identifier rubyid_response'>response</span>))
  <span class='const'><a href="CacheFile.html" title="Bundler::CompactIndexClient::CacheFile (class)">CacheFile</a></span>.<span class='id identifier rubyid_write'><a href="CacheFile.html#write-class_method" title="Bundler::CompactIndexClient::CacheFile.write (method)">write</a></span>(<span class='id identifier rubyid_etag_path'>etag_path</span><span class='comma'>,</span> <span class='id identifier rubyid_etag_from_response'><a href="#etag_from_response-instance_method" title="Bundler::CompactIndexClient::Updater#etag_from_response (method)">etag_from_response</a></span>(<span class='id identifier rubyid_response'>response</span>))
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="request_headers-instance_method">
  <h3 class='signature priv'>
    #<strong>request_headers</strong>(etag, range_start = nil)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L59-L64'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='59' data-end='64'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/bundler/compact_index_client/updater.rb', line 59</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_request_headers'>request_headers</span>(<span class='id identifier rubyid_etag'>etag</span><span class='comma'>,</span> <span class='id identifier rubyid_range_start'>range_start</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_headers'>headers</span> <span class='op'>=</span> {}
  <span class='id identifier rubyid_headers'>headers</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Range</span><span class='tstring_end'>&quot;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bytes=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_range_start'>range_start</span><span class='embexpr_end'>}</span><span class='tstring_content'>-</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_range_start'>range_start</span>
  <span class='id identifier rubyid_headers'>headers</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>If-None-Match</span><span class='tstring_end'>&quot;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>%(</span><span class='tstring_content'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_etag'>etag</span><span class='embexpr_end'>}</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>)</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_etag'>etag</span>
  <span class='id identifier rubyid_headers'>headers</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update-instance_method">
  <h3 class='signature '>
    #<strong>update</strong>(remote_path, local_path, etag_path)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_9/lib/bundler/compact_index_client/updater.rb#L16-L22'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='16' data-end='22'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/bundler/compact_index_client/updater.rb', line 16</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update'>update</span>(<span class='id identifier rubyid_remote_path'>remote_path</span><span class='comma'>,</span> <span class='id identifier rubyid_local_path'>local_path</span><span class='comma'>,</span> <span class='id identifier rubyid_etag_path'>etag_path</span>)
  <span class='id identifier rubyid_append'><a href="#append-instance_method" title="Bundler::CompactIndexClient::Updater#append (method)">append</a></span>(<span class='id identifier rubyid_remote_path'>remote_path</span><span class='comma'>,</span> <span class='id identifier rubyid_local_path'>local_path</span><span class='comma'>,</span> <span class='id identifier rubyid_etag_path'>etag_path</span>) <span class='op'>||</span> <span class='id identifier rubyid_replace'><a href="#replace-instance_method" title="Bundler::CompactIndexClient::Updater#replace (method)">replace</a></span>(<span class='id identifier rubyid_remote_path'>remote_path</span><span class='comma'>,</span> <span class='id identifier rubyid_local_path'>local_path</span><span class='comma'>,</span> <span class='id identifier rubyid_etag_path'>etag_path</span>)
<span class='kw'>rescue</span> <span class='const'><a href="CacheFile.html" title="Bundler::CompactIndexClient::CacheFile (class)">CacheFile</a></span><span class='op'>::</span><span class='const'><a href="CacheFile/DigestMismatchError.html" title="Bundler::CompactIndexClient::CacheFile::DigestMismatchError (class)">DigestMismatchError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="Updater/MismatchedChecksumError.html" title="Bundler::CompactIndexClient::Updater::MismatchedChecksumError (class)">MismatchedChecksumError</a></span>.<span class='id identifier rubyid_new'><a href="Updater/MismatchedChecksumError.html#new-class_method" title="Bundler::CompactIndexClient::Updater::MismatchedChecksumError.new (method)">new</a></span>(<span class='id identifier rubyid_remote_path'>remote_path</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span>)
<span class='kw'>rescue</span> <span class='const'>Zlib</span><span class='op'>::</span><span class='const'>GzipFile</span><span class='op'>::</span><span class='const'><a href="Error.html" title="Bundler::CompactIndexClient::Error (class)">Error</a></span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../../Bundler.html" title="Bundler (module)">Bundler</a></span><span class='op'>::</span><span class='const'><a href="../HTTPError.html" title="Bundler::HTTPError (class)">HTTPError</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>