<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: SyntaxSuggest::CleanDocument &mdash; syntax_suggest  Ruby-3.3.10 p183</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "SyntaxSuggest::CleanDocument",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Ruby-3.3.10</a> &raquo; 
      <a href='../'>syntax_suggest</a> &raquo; 
      <a href='../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../SyntaxSuggest.html" title="SyntaxSuggest (module)">SyntaxSuggest</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>CleanDocument&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: SyntaxSuggest::CleanDocument</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L86'>lib/syntax_suggest/clean_document.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    <p>Parses and sanitizes source into a lexically aware document</p>

<p>Internally the document is represented by an array with each
index containing a <a href="CodeLine.html" title="SyntaxSuggest::CodeLine (class)"><code>CodeLine</code></a> correlating to a line from the source code.</p>

<p>There are three main phases in the algorithm:</p>

<ol>
<li>Sanitize/format input source</li>
<li>Search for invalid blocks</li>
<li>Format invalid blocks into something meaninful</li>
</ol>

<p>This class handles the first part.</p>

<p>The reason this class exists is to format input source
for better/easier/cleaner exploration.</p>

<p>The CodeSearch class operates at the line level so
we must be careful to not introduce lines that look
valid by themselves, but when removed will trigger syntax errors
or strange behavior.</p>

<h3>Join Trailing slashes</h3>

<p>Code with a trailing slash is logically treated as a single line:</p>

<pre class="code ruby"><code class="ruby"><span class='int'>1</span> <span class='id identifier rubyid_it'>it</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>code can be split</span><span class='tstring_end'>&quot;</span></span> \
<span class='int'>2</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>across multiple lines</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span></code></pre>

<p>In this case removing line 2 would add a syntax error. We get around
this by internally joining the two lines into a single &quot;line&quot; object</p>

<h3>Logically Consecutive lines</h3>

<p>Code that can be broken over multiple
lines such as method calls are on different lines:</p>

<pre class="code ruby"><code class="ruby"><span class='int'>1</span> <span class='const'>User</span>.
<span class='int'>2</span>   <span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>schneems</span><span class='tstring_end'>&quot;</span></span>).
<span class='int'>3</span>   <span class='id identifier rubyid_first'>first</span></code></pre>

<p>Removing line 2 can introduce a syntax error. To fix this, all lines
are joined into one.</p>

<h3>Heredocs</h3>

<p>A heredoc is an way of defining a multi-line string. They can cause many
problems. If left as a single line, the parser would try to parse the contents
as ruby code rather than as a string. Even without this problem, we still
hit an issue with indentation:</p>

<p>1 foo = &lt;&lt;~HEREDOC
   2  &quot;Be yourself; everyone else is already taken.&quot;&quot;
   3    ― Oscar Wilde
   4      puts &quot;I look like ruby code&quot; # but i&#39;m still a heredoc
   5 HEREDOC</p>

<p>If we didn&#39;t join these lines then our algorithm would think that line 4
is separate from the rest, has a higher indentation, then look at it first
and remove it.</p>

<p>If the code evaluates line 5 by itself it will think line 5 is a constant,
remove it, and introduce a syntax errror.</p>

<p>All of these problems are fixed by joining the whole heredoc into a single
line.</p>

<h3>Comments and whitespace</h3>

<p>Comments can throw off the way the lexer tells us that the line
logically belongs with the next line. This is valid ruby but
results in a different lex output than before:</p>

<pre class="code ruby"><code class="ruby"><span class='int'>1</span> <span class='const'>User</span>.
<span class='int'>2</span>   <span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>schneems</span><span class='tstring_end'>&quot;</span></span>).
<span class='int'>3</span>   <span class='comment'># Comment here
</span><span class='int'>4</span>   <span class='id identifier rubyid_first'>first</span></code></pre>

<p>To handle this we can replace comment lines with empty lines
and then re-lex the source. This removal and re-lexing preserves
line index and document size, but generates an easier to work with
document.</p>

  </div>
</div>
</div>
<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(source:)  &#x21d2; CleanDocument </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#call-instance_method" title="#call (instance method)">#<strong>call</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Call all of the document “cleaners” and return self.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#clean_sweep-instance_method" title="#clean_sweep (instance method)">#<strong>clean_sweep</strong>(source:)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Remove comments.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#join_consecutive!-instance_method" title="#join_consecutive! (instance method)">#<strong>join_consecutive!</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Smushes logically “consecutive” lines.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#join_groups-instance_method" title="#join_groups (instance method)">#<strong>join_groups</strong>(groups)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Helper method for joining “groups” of lines.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#join_heredoc!-instance_method" title="#join_heredoc! (instance method)">#<strong>join_heredoc!</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Smushes all heredoc lines into one line.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#join_trailing_slash!-instance_method" title="#join_trailing_slash! (instance method)">#<strong>join_trailing_slash!</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Join lines with a trailing slash.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#lines-instance_method" title="#lines (instance method)">#<strong>lines</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Return an array of CodeLines in the document.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#take_while_including-instance_method" title="#take_while_including (instance method)">#<strong>take_while_including</strong>(range = 0)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Helper method for grabbing elements from document.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#to_s-instance_method" title="#to_s (instance method)">#<strong>to_s</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Renders the document back to a string.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(source:)  &#x21d2; <code>CleanDocument</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L87-L90'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='87' data-end='90'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/clean_document.rb', line 87</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='label'>source:</span>)
  <span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span> <span class='op'>=</span> <span class='id identifier rubyid_clean_sweep'><a href="#clean_sweep-instance_method" title="SyntaxSuggest::CleanDocument#clean_sweep (method)">clean_sweep</a></span>(<span class='label'>source:</span> <span class='id identifier rubyid_source'>source</span>)
  <span class='ivar'>@document</span> <span class='op'>=</span> <span class='const'><a href="CodeLine.html" title="SyntaxSuggest::CodeLine (class)">CodeLine</a></span>.<span class='id identifier rubyid_from_source'><a href="CodeLine.html#from_source-class_method" title="SyntaxSuggest::CodeLine.from_source (method)">from_source</a></span>(<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>.<span class='id identifier rubyid_join'>join</span><span class='comma'>,</span> <span class='label'>lines:</span> <span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="call-instance_method">
  <h3 class='signature  first'>
    #<strong>call</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Call all of the document “cleaners” and return self</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L94-L100'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='94' data-end='100'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/clean_document.rb', line 94</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_call'>call</span>
  <span class='id identifier rubyid_join_trailing_slash!'><a href="#join_trailing_slash!-instance_method" title="SyntaxSuggest::CleanDocument#join_trailing_slash! (method)">join_trailing_slash!</a></span>
  <span class='id identifier rubyid_join_consecutive!'><a href="#join_consecutive!-instance_method" title="SyntaxSuggest::CleanDocument#join_consecutive! (method)">join_consecutive!</a></span>
  <span class='id identifier rubyid_join_heredoc!'><a href="#join_heredoc!-instance_method" title="SyntaxSuggest::CleanDocument#join_heredoc! (method)">join_heredoc!</a></span>

  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="clean_sweep-instance_method">
  <h3 class='signature '>
    #<strong>clean_sweep</strong>(source:)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Remove comments</p>

<p>replace with empty newlines</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_source'>source</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;~&#39;EOM&#39;</span>
<span class='ignored_sp'>  </span><span class='tstring_content'># Comment 1
</span><span class='ignored_sp'>  </span><span class='tstring_content'>puts &quot;hello&quot;
</span><span class='ignored_sp'>  </span><span class='tstring_content'># Comment 2
</span><span class='ignored_sp'>  </span><span class='tstring_content'>puts &quot;world&quot;
</span><span class='heredoc_end'>EOM
</span>
<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span> <span class='op'>=</span> <span class='const'>CleanDocument</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="SyntaxSuggest::CleanDocument.new (method)">new</a></span>(<span class='label'>source:</span> <span class='id identifier rubyid_source'>source</span>).<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>
<span class='id identifier rubyid_expect'>expect</span>(<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>[<span class='int'>0</span>].<span class='id identifier rubyid_to_s'><a href="#to_s-instance_method" title="SyntaxSuggest::CleanDocument#to_s (method)">to_s</a></span>).<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_eq'>eq</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_expect'>expect</span>(<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>[<span class='int'>1</span>].<span class='id identifier rubyid_to_s'><a href="#to_s-instance_method" title="SyntaxSuggest::CleanDocument#to_s (method)">to_s</a></span>).<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_eq'>eq</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>puts </span><span class='tstring_end'>&quot;</span></span><span class='id identifier rubyid_hello'>hello</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>)
expect(lines[2].to_s).to eq(</span><span class='tstring_end'>&quot;</span></span><span class='CHAR'>\</span><span class='id identifier rubyid_n'>n</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>)
expect(lines[3].to_s).to eq(</span><span class='tstring_end'>&quot;</span></span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>Important: This must be done before lexing.</p>

<p>After this change is made, we lex the document because removing comments can change how the doc is parsed.</p>

<p>For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_values'>values</span> <span class='op'>=</span> <span class='const'><a href="LexAll.html" title="SyntaxSuggest::LexAll (class)">LexAll</a></span>.<span class='id identifier rubyid_new'><a href="LexAll.html#new-class_method" title="SyntaxSuggest::LexAll.new (method)">new</a></span>(<span class='label'>source:</span> <span class='heredoc_beg'>&lt;&lt;~EOM</span>))
<span class='ignored_sp'>  </span><span class='tstring_content'>User.
</span><span class='ignored_sp'>  </span><span class='tstring_content'>  # comment
</span><span class='ignored_sp'>  </span><span class='tstring_content'>  where(name: &#39;schneems&#39;)
</span><span class='heredoc_end'>EOM
</span><span class='id identifier rubyid_expect'>expect</span>(
  <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_count'>count</span> {<span class='op'>|</span><span class='id identifier rubyid_v'>v</span><span class='op'>|</span> <span class='id identifier rubyid_v'>v</span>.<span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_on_ignored_nl'>on_ignored_nl</span>}
).<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_eq'>eq</span>(<span class='int'>1</span>)</code></pre>

<p>After the comment is removed:</p>

<pre class="code ruby"><code class="ruby"> <span class='id identifier rubyid_values'>values</span> <span class='op'>=</span> <span class='const'><a href="LexAll.html" title="SyntaxSuggest::LexAll (class)">LexAll</a></span>.<span class='id identifier rubyid_new'><a href="LexAll.html#new-class_method" title="SyntaxSuggest::LexAll.new (method)">new</a></span>(<span class='label'>source:</span> <span class='heredoc_beg'>&lt;&lt;~EOM</span>))
<span class='ignored_sp'>   </span><span class='tstring_content'>User.
</span><span class='tstring_content'>
</span><span class='ignored_sp'>   </span><span class='tstring_content'>  where(name: &#39;schneems&#39;)
</span><span class='heredoc_end'> EOM
</span> <span class='id identifier rubyid_expect'>expect</span>(
  <span class='id identifier rubyid_values'>values</span>.<span class='id identifier rubyid_count'>count</span> {<span class='op'>|</span><span class='id identifier rubyid_v'>v</span><span class='op'>|</span> <span class='id identifier rubyid_v'>v</span>.<span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_on_ignored_nl'>on_ignored_nl</span>}
).<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_eq'>eq</span>(<span class='int'>2</span>)</code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L157-L167'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='157' data-end='167'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/clean_document.rb', line 157</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_clean_sweep'>clean_sweep</span>(<span class='label'>source:</span>)
  <span class='comment'># Match comments, but not HEREDOC strings with #{variable} interpolation
</span>  <span class='comment'># https://rubular.com/r/HPwtW9OYxKUHXQ
</span>  <span class='id identifier rubyid_source'>source</span>.<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>.<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_match?'>match?</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^\s*#([^{].*|)$</span><span class='regexp_end'>/</span></span>)
      <span class='gvar'>$/</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_line'>line</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="join_consecutive!-instance_method">
  <h3 class='signature '>
    #<strong>join_consecutive!</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Smushes logically “consecutive” lines</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_source'>source</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;~&#39;EOM&#39;</span>
<span class='ignored_sp'>  </span><span class='tstring_content'>User.
</span><span class='ignored_sp'>  </span><span class='tstring_content'>  where(name: &#39;schneems&#39;).
</span><span class='ignored_sp'>  </span><span class='tstring_content'>  first
</span><span class='heredoc_end'>EOM
</span>
<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span> <span class='op'>=</span> <span class='const'>CleanDocument</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="SyntaxSuggest::CleanDocument.new (method)">new</a></span>(<span class='label'>source:</span> <span class='id identifier rubyid_source'>source</span>).<span class='id identifier rubyid_join_consecutive!'>join_consecutive!</span>.<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>
<span class='id identifier rubyid_expect'>expect</span>(<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>[<span class='int'>0</span>].<span class='id identifier rubyid_to_s'><a href="#to_s-instance_method" title="SyntaxSuggest::CleanDocument#to_s (method)">to_s</a></span>).<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_eq'>eq</span>(<span class='id identifier rubyid_source'>source</span>)
<span class='id identifier rubyid_expect'>expect</span>(<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>[<span class='int'>1</span>].<span class='id identifier rubyid_to_s'><a href="#to_s-instance_method" title="SyntaxSuggest::CleanDocument#to_s (method)">to_s</a></span>).<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_eq'>eq</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>The one known case this doesn’t handle is:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Ripper</span>.<span class='id identifier rubyid_lex'>lex</span> <span class='heredoc_beg'>&lt;&lt;~EOM</span>
<span class='ignored_sp'>  </span><span class='tstring_content'>a &amp;&amp;
</span><span class='ignored_sp'>  </span><span class='tstring_content'> b ||
</span><span class='ignored_sp'>  </span><span class='tstring_content'> c
</span><span class='heredoc_end'>EOM</span></code></pre>

<p>For some reason this introduces <code>on_ignore_newline</code> but with BEG type</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L225-L234'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='225' data-end='234'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/clean_document.rb', line 225</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_join_consecutive!'>join_consecutive!</span>
  <span class='id identifier rubyid_consecutive_groups'>consecutive_groups</span> <span class='op'>=</span> <span class='ivar'>@document</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_ignore_newline_not_beg?'>ignore_newline_not_beg?</span>).<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_code_line'>code_line</span><span class='op'>|</span>
    <span class='id identifier rubyid_take_while_including'><a href="#take_while_including-instance_method" title="SyntaxSuggest::CleanDocument#take_while_including (method)">take_while_including</a></span>(<span class='id identifier rubyid_code_line'>code_line</span>.<span class='id identifier rubyid_index'>index</span><span class='op'>..</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span>
      <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_ignore_newline_not_beg?'>ignore_newline_not_beg?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_join_groups'><a href="#join_groups-instance_method" title="SyntaxSuggest::CleanDocument#join_groups (method)">join_groups</a></span>(<span class='id identifier rubyid_consecutive_groups'>consecutive_groups</span>)
  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="join_groups-instance_method">
  <h3 class='signature '>
    #<strong>join_groups</strong>(groups)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Helper method for joining “groups” of lines</p>

<p>Input is expected to be type Array&lt;Array&lt;CodeLine&gt;&gt;</p>

<p>The outer array holds the various “groups” while the inner array holds code lines.</p>

<p>All code lines are “joined” into the first line in their group.</p>

<p>To preserve document size, empty lines are placed in the place of the lines that were “joined”</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L266-L289'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='266' data-end='289'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/clean_document.rb', line 266</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_join_groups'>join_groups</span>(<span class='id identifier rubyid_groups'>groups</span>)
  <span class='id identifier rubyid_groups'>groups</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span><span class='op'>|</span>
    <span class='id identifier rubyid_line'>line</span> <span class='op'>=</span> <span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>.<span class='id identifier rubyid_first'>first</span>

    <span class='comment'># Handle the case of multiple groups in a row
</span>    <span class='comment'># if one is already replaced, move on
</span>    <span class='kw'>next</span> <span class='kw'>if</span> <span class='ivar'>@document</span>[<span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_index'>index</span>].<span class='id identifier rubyid_empty?'>empty?</span>

    <span class='comment'># Join group into the first line
</span>    <span class='ivar'>@document</span>[<span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_index'>index</span>] <span class='op'>=</span> <span class='const'><a href="CodeLine.html" title="SyntaxSuggest::CodeLine (class)">CodeLine</a></span>.<span class='id identifier rubyid_new'><a href="CodeLine.html#new-class_method" title="SyntaxSuggest::CodeLine.new (method)">new</a></span>(
      <span class='label'>lex:</span> <span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>.<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_lex'>lex</span>).<span class='id identifier rubyid_flatten'>flatten</span><span class='comma'>,</span>
      <span class='label'>line:</span> <span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>.<span class='id identifier rubyid_join'>join</span><span class='comma'>,</span>
      <span class='label'>index:</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_index'>index</span>
    )

    <span class='comment'># Hide the rest of the lines
</span>    <span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>[<span class='int'>1</span><span class='op'>..</span>].<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span>
      <span class='comment'># The above lines already have newlines in them, if add more
</span>      <span class='comment'># then there will be double newline, use an empty line instead
</span>      <span class='ivar'>@document</span>[<span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_index'>index</span>] <span class='op'>=</span> <span class='const'><a href="CodeLine.html" title="SyntaxSuggest::CodeLine (class)">CodeLine</a></span>.<span class='id identifier rubyid_new'><a href="CodeLine.html#new-class_method" title="SyntaxSuggest::CodeLine.new (method)">new</a></span>(<span class='label'>line:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>index:</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='label'>lex:</span> [])
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="join_heredoc!-instance_method">
  <h3 class='signature '>
    #<strong>join_heredoc!</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Smushes all heredoc lines into one line</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_source'>source</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;~&#39;EOM&#39;</span>
<span class='ignored_sp'>  </span><span class='tstring_content'>foo = &lt;&lt;~HEREDOC
</span><span class='ignored_sp'>  </span><span class='tstring_content'>   lol
</span><span class='ignored_sp'>  </span><span class='tstring_content'>   hehehe
</span><span class='ignored_sp'>  </span><span class='tstring_content'>HEREDOC
</span><span class='heredoc_end'>EOM
</span>
<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span> <span class='op'>=</span> <span class='const'>CleanDocument</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="SyntaxSuggest::CleanDocument.new (method)">new</a></span>(<span class='label'>source:</span> <span class='id identifier rubyid_source'>source</span>).<span class='id identifier rubyid_join_heredoc!'>join_heredoc!</span>.<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>
<span class='id identifier rubyid_expect'>expect</span>(<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>[<span class='int'>0</span>].<span class='id identifier rubyid_to_s'><a href="#to_s-instance_method" title="SyntaxSuggest::CleanDocument#to_s (method)">to_s</a></span>).<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_eq'>eq</span>(<span class='id identifier rubyid_source'>source</span>)
<span class='id identifier rubyid_expect'>expect</span>(<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>[<span class='int'>1</span>].<span class='id identifier rubyid_to_s'><a href="#to_s-instance_method" title="SyntaxSuggest::CleanDocument#to_s (method)">to_s</a></span>).<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_eq'>eq</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L181-L201'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='181' data-end='201'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/clean_document.rb', line 181</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_join_heredoc!'>join_heredoc!</span>
  <span class='id identifier rubyid_start_index_stack'>start_index_stack</span> <span class='op'>=</span> []
  <span class='id identifier rubyid_heredoc_beg_end_index'>heredoc_beg_end_index</span> <span class='op'>=</span> []
  <span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span>
    <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_lex'>lex</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_lex_value'>lex_value</span><span class='op'>|</span>
      <span class='kw'>case</span> <span class='id identifier rubyid_lex_value'>lex_value</span>.<span class='id identifier rubyid_type'>type</span>
      <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_on_heredoc_beg'>on_heredoc_beg</span>
        <span class='id identifier rubyid_start_index_stack'>start_index_stack</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_index'>index</span>
      <span class='kw'>when</span> <span class='symbeg'>:</span><span class='id identifier rubyid_on_heredoc_end'>on_heredoc_end</span>
        <span class='id identifier rubyid_start_index'>start_index</span> <span class='op'>=</span> <span class='id identifier rubyid_start_index_stack'>start_index_stack</span>.<span class='id identifier rubyid_pop'>pop</span>
        <span class='id identifier rubyid_end_index'>end_index</span> <span class='op'>=</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_index'>index</span>
        <span class='id identifier rubyid_heredoc_beg_end_index'>heredoc_beg_end_index</span> <span class='op'>&lt;&lt;</span> [<span class='id identifier rubyid_start_index'>start_index</span><span class='comma'>,</span> <span class='id identifier rubyid_end_index'>end_index</span>]
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_heredoc_groups'>heredoc_groups</span> <span class='op'>=</span> <span class='id identifier rubyid_heredoc_beg_end_index'>heredoc_beg_end_index</span>.<span class='id identifier rubyid_map'>map</span> { <span class='op'>|</span><span class='id identifier rubyid_start_index'>start_index</span><span class='comma'>,</span> <span class='id identifier rubyid_end_index'>end_index</span><span class='op'>|</span> <span class='ivar'>@document</span>[<span class='id identifier rubyid_start_index'>start_index</span><span class='op'>..</span><span class='id identifier rubyid_end_index'>end_index</span>] }

  <span class='id identifier rubyid_join_groups'><a href="#join_groups-instance_method" title="SyntaxSuggest::CleanDocument#join_groups (method)">join_groups</a></span>(<span class='id identifier rubyid_heredoc_groups'>heredoc_groups</span>)
  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="join_trailing_slash!-instance_method">
  <h3 class='signature '>
    #<strong>join_trailing_slash!</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Join lines with a trailing slash</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_source'>source</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;~&#39;EOM&#39;</span>
<span class='ignored_sp'>  </span><span class='tstring_content'>it &quot;code can be split&quot; \
</span><span class='ignored_sp'>  </span><span class='tstring_content'>   &quot;across multiple lines&quot; do
</span><span class='heredoc_end'>EOM
</span>
<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span> <span class='op'>=</span> <span class='const'>CleanDocument</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="SyntaxSuggest::CleanDocument.new (method)">new</a></span>(<span class='label'>source:</span> <span class='id identifier rubyid_source'>source</span>).<span class='id identifier rubyid_join_consecutive!'><a href="#join_consecutive!-instance_method" title="SyntaxSuggest::CleanDocument#join_consecutive! (method)">join_consecutive!</a></span>.<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>
<span class='id identifier rubyid_expect'>expect</span>(<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>[<span class='int'>0</span>].<span class='id identifier rubyid_to_s'><a href="#to_s-instance_method" title="SyntaxSuggest::CleanDocument#to_s (method)">to_s</a></span>).<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_eq'>eq</span>(<span class='id identifier rubyid_source'>source</span>)
<span class='id identifier rubyid_expect'>expect</span>(<span class='id identifier rubyid_lines'><a href="#lines-instance_method" title="SyntaxSuggest::CleanDocument#lines (method)">lines</a></span>[<span class='int'>1</span>].<span class='id identifier rubyid_to_s'><a href="#to_s-instance_method" title="SyntaxSuggest::CleanDocument#to_s (method)">to_s</a></span>).<span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_eq'>eq</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L246-L252'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='246' data-end='252'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/clean_document.rb', line 246</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_join_trailing_slash!'>join_trailing_slash!</span>
  <span class='id identifier rubyid_trailing_groups'>trailing_groups</span> <span class='op'>=</span> <span class='ivar'>@document</span>.<span class='id identifier rubyid_select'>select</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_trailing_slash?'>trailing_slash?</span>).<span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_code_line'>code_line</span><span class='op'>|</span>
    <span class='id identifier rubyid_take_while_including'><a href="#take_while_including-instance_method" title="SyntaxSuggest::CleanDocument#take_while_including (method)">take_while_including</a></span>(<span class='id identifier rubyid_code_line'>code_line</span>.<span class='id identifier rubyid_index'>index</span><span class='op'>..</span>) { <span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='id identifier rubyid_x'>x</span>.<span class='id identifier rubyid_trailing_slash?'>trailing_slash?</span> }
  <span class='kw'>end</span>
  <span class='id identifier rubyid_join_groups'><a href="#join_groups-instance_method" title="SyntaxSuggest::CleanDocument#join_groups (method)">join_groups</a></span>(<span class='id identifier rubyid_trailing_groups'>trailing_groups</span>)
  <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="lines-instance_method">
  <h3 class='signature '>
    #<strong>lines</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return an array of CodeLines in the document</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L104-L106'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='104' data-end='106'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/clean_document.rb', line 104</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_lines'>lines</span>
  <span class='ivar'>@document</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="take_while_including-instance_method">
  <h3 class='signature '>
    #<strong>take_while_including</strong>(range = 0)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Helper method for grabbing elements from document</p>

<p>Like <code>take_while</code> except when it stops iterating, it also returns the line that caused it to stop</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L296-L304'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='296' data-end='304'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/clean_document.rb', line 296</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_take_while_including'>take_while_including</span>(<span class='id identifier rubyid_range'>range</span> <span class='op'>=</span> <span class='int'>0</span><span class='op'>..</span>)
  <span class='id identifier rubyid_take_next_and_stop'>take_next_and_stop</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@document</span>[<span class='id identifier rubyid_range'>range</span>].<span class='id identifier rubyid_take_while'>take_while</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_take_next_and_stop'>take_next_and_stop</span>

    <span class='id identifier rubyid_take_next_and_stop'>take_next_and_stop</span> <span class='op'>=</span> <span class='op'>!</span>(<span class='kw'>yield</span> <span class='id identifier rubyid_line'>line</span>)
    <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="to_s-instance_method">
  <h3 class='signature '>
    #<strong>to_s</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Renders the document back to a string</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_3_10/lib/syntax_suggest/clean_document.rb#L109-L111'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='109' data-end='111'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/clean_document.rb', line 109</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_to_s'>to_s</span>
  <span class='ivar'>@document</span>.<span class='id identifier rubyid_join'>join</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>