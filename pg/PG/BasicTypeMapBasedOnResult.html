<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: PG::BasicTypeMapBasedOnResult &mdash; PG master</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "PG::BasicTypeMapBasedOnResult",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>PG master</a> &raquo; 
      <a href='../_index.html#alpha_B'>Index (B)</a> &raquo; 
        <a href="../PG.html" title="PG (module)">PG</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>BasicTypeMapBasedOnResult&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: PG::BasicTypeMapBasedOnResult</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          <a href="TypeMapByOid.html" title="PG::TypeMapByOid (class)"><code>TypeMapByOid</code></a>,
          <a href="TypeMap.html" title="PG::TypeMap (class)"><code>TypeMap</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="BasicTypeRegistry/Checker.html" title="PG::BasicTypeRegistry::Checker (module)"><code>BasicTypeRegistry::Checker</code></a>,
          <a href="TypeMapByOid.html" title="PG::TypeMapByOid (class)"><code>TypeMapByOid</code></a>,
          <a href="TypeMap/DefaultTypeMappable.html" title="PG::TypeMap::DefaultTypeMappable (module)"><code>TypeMap::DefaultTypeMappable</code></a>,
          <a href="TypeMap.html" title="PG::TypeMap (class)"><code>TypeMap</code></a>
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2 o'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="TypeMapByOid.html" title="PG::TypeMapByOid (class)">PG::TypeMapByOid</a></span>
        <ul class='fullTree'>
          <li><a href="../Object.html" title="Object (class)"><code>::Object</code></a></li>
          <li class='next'><a href="TypeMap.html" title="PG::TypeMap (class)">PG::TypeMap</a></li>
          <li class='next'><a href="TypeMapByOid.html" title="PG::TypeMapByOid (class)">PG::TypeMapByOid</a></li>
          <li class='next'>PG::BasicTypeMapBasedOnResult</li>
        </ul>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/basic_type_map_based_on_result.rb#L56'>lib/pg/basic_type_map_based_on_result.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Simple set of rules for type casting common PostgreSQL types from Ruby to PostgreSQL.</p>

<p>OIDs of supported type casts are not hard-coded in the sources, but are retrieved from the PostgreSQL’s <code>pg_type</code> table in <a href="#new-class_method" title="PG::BasicTypeMapBasedOnResult.new (method)">.new</a> .</p>

<p>This class works equal to <a href="BasicTypeMapForResults.html" title="PG::BasicTypeMapForResults (class)"><code>BasicTypeMapForResults</code></a>, but does not define decoders for the given result OIDs, but encoders. So it can be used to type cast field values based on the type OID retrieved by a separate SQL query.</p>

<p><a href="TypeMapByOid.html#build_column_map-instance_method" title="PG::TypeMapByOid#build_column_map (method)">TypeMapByOid#build_column_map</a>(result) can be used to generate a result independent <a href="TypeMapByColumn.html" title="PG::TypeMapByColumn (class)"><code>TypeMapByColumn</code></a> type map, which can subsequently be used to cast query bind parameters or <code>#put_copy_data</code> fields.</p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_exec'>exec</span>( <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CREATE TEMP TABLE copytable (t TEXT, i INT, ai INT[])</span><span class='tstring_end'>&quot;</span></span> )

<span class='comment'># Retrieve table OIDs per empty result set.
</span><span class='id identifier rubyid_res'>res</span> <span class='op'>=</span> <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_exec'>exec</span>( <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT * FROM copytable LIMIT 0</span><span class='tstring_end'>&quot;</span></span> )
<span class='comment'># Build a type map for common ruby to database type encoders.
</span><span class='id identifier rubyid_btm'>btm</span> <span class='op'>=</span> <span class='const'><a href="../PG.html" title="PG (module)">PG</a></span><span class='op'>::</span><span class='const'>BasicTypeMapBasedOnResult</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="PG::BasicTypeMapBasedOnResult.new (method)">new</a></span>(<span class='id identifier rubyid_conn'>conn</span>)
<span class='comment'># Build a PG::TypeMapByColumn with encoders suitable for copytable.
</span><span class='id identifier rubyid_tm'>tm</span> <span class='op'>=</span> <span class='id identifier rubyid_btm'>btm</span>.<span class='id identifier rubyid_build_column_map'>build_column_map</span>( <span class='id identifier rubyid_res'>res</span> )
<span class='id identifier rubyid_row_encoder'>row_encoder</span> <span class='op'>=</span> <span class='const'><a href="../PG.html" title="PG (module)">PG</a></span><span class='op'>::</span><span class='const'><a href="TextEncoder.html" title="PG::TextEncoder (module)">TextEncoder</a></span><span class='op'>::</span><span class='const'><a href="TextEncoder/CopyRow.html" title="PG::TextEncoder::CopyRow (class)">CopyRow</a></span>.<span class='id identifier rubyid_new'><a href="Coder.html#new-class_method" title="PG::Coder.new (method)">new</a></span> <span class='label'>type_map:</span> <span class='id identifier rubyid_tm'>tm</span>

<span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_copy_data'>copy_data</span>( <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>COPY copytable FROM STDIN</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_row_encoder'>row_encoder</span> ) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_res'>res</span><span class='op'>|</span>
  <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_put_copy_data'>put_copy_data</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>a</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>123</span><span class='comma'>,</span> [<span class='int'>5</span><span class='comma'>,</span><span class='int'>4</span><span class='comma'>,</span><span class='int'>3</span>]]
<span class='kw'>end</span></code></pre>

<p>This inserts a single row into copytable with type casts from ruby to database types using text format.</p>

<p>Very similar with binary format:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_exec'>exec</span>( <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CREATE TEMP TABLE copytable (t TEXT, i INT, blob bytea, created_at timestamp)</span><span class='tstring_end'>&quot;</span></span> )
<span class='comment'># Retrieve table OIDs per empty result set in binary format.
</span><span class='id identifier rubyid_res'>res</span> <span class='op'>=</span> <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_exec_params'>exec_params</span>( <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT * FROM copytable LIMIT 0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> []<span class='comma'>,</span> <span class='int'>1</span> )
<span class='comment'># Build a type map for common ruby to database type encoders.
</span><span class='id identifier rubyid_btm'>btm</span> <span class='op'>=</span> <span class='const'><a href="../PG.html" title="PG (module)">PG</a></span><span class='op'>::</span><span class='const'>BasicTypeMapBasedOnResult</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="PG::BasicTypeMapBasedOnResult.new (method)">new</a></span>(<span class='id identifier rubyid_conn'>conn</span>)
<span class='comment'># Build a PG::TypeMapByColumn with encoders suitable for copytable.
</span><span class='id identifier rubyid_tm'>tm</span> <span class='op'>=</span> <span class='id identifier rubyid_btm'>btm</span>.<span class='id identifier rubyid_build_column_map'>build_column_map</span>( <span class='id identifier rubyid_res'>res</span> )
<span class='id identifier rubyid_row_encoder'>row_encoder</span> <span class='op'>=</span> <span class='const'><a href="../PG.html" title="PG (module)">PG</a></span><span class='op'>::</span><span class='const'><a href="BinaryEncoder.html" title="PG::BinaryEncoder (module)">BinaryEncoder</a></span><span class='op'>::</span><span class='const'><a href="BinaryEncoder/CopyRow.html" title="PG::BinaryEncoder::CopyRow (class)">CopyRow</a></span>.<span class='id identifier rubyid_new'><a href="Coder.html#new-class_method" title="PG::Coder.new (method)">new</a></span> <span class='label'>type_map:</span> <span class='id identifier rubyid_tm'>tm</span>

<span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_copy_data'>copy_data</span>( <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>COPY copytable FROM STDIN WITH (FORMAT binary)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_row_encoder'>row_encoder</span> ) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_res'>res</span><span class='op'>|</span>
  <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_put_copy_data'>put_copy_data</span> [<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>a</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>123</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xff\x00</span><span class='tstring_end'>&quot;</span></span>.<span class='id identifier rubyid_b'>b</span><span class='comma'>,</span> <span class='const'>Time</span>.<span class='id identifier rubyid_now'>now</span>]
<span class='kw'>end</span></code></pre>

<p>This inserts a single row into copytable with type casts from ruby to database types using binary copy and value format. Binary COPY is faster than text format but less portable and less readable and pg offers fewer en-/decoders of database types.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
  <h3 class='inherited'><a href="BasicTypeRegistry/Checker.html" title="PG::BasicTypeRegistry::Checker (module)"><code>BasicTypeRegistry::Checker</code></a> - Included</h3>
  <p  class='inherited'>
    <a class='priv ' href="BasicTypeRegistry/Checker.html#ValidDirections-constant" title="PG::BasicTypeRegistry::Checker::ValidDirections (constant)">ValidDirections</a>, 
    <a class='priv ' href="BasicTypeRegistry/Checker.html#ValidFormats-constant" title="PG::BasicTypeRegistry::Checker::ValidFormats (constant)">ValidFormats</a>
  </p>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(connection_or_coder_maps, registry: nil)  &#x21d2; BasicTypeMapBasedOnResult </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_Attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>

<h3 class='inherited'><a href="TypeMapByOid.html" title="PG::TypeMapByOid (class)"><code>TypeMapByOid</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m rw' href="TypeMapByOid.html#max_rows_for_online_lookup-instance_method" title="PG::TypeMapByOid#max_rows_for_online_lookup (method)">#max_rows_for_online_lookup</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m rw' href="TypeMapByOid.html#max_rows_for_online_lookup=-instance_method" title="PG::TypeMapByOid#max_rows_for_online_lookup= (method)">#max_rows_for_online_lookup=</a></td>
      <td><div class='inline'><p>Threshold for doing Hash lookups versus creation of a dedicated <a href="TypeMapByColumn.html" title="PG::TypeMapByColumn (class)"><code>TypeMapByColumn</code></a>.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="TypeMap/DefaultTypeMappable.html" title="PG::TypeMap::DefaultTypeMappable (module)"><code>TypeMap::DefaultTypeMappable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m rw' href="TypeMap/DefaultTypeMappable.html#default_type_map-instance_method" title="PG::TypeMap::DefaultTypeMappable#default_type_map (method)">#default_type_map</a></td>
      <td><div class='inline'><p>Returns the default <a href="TypeMap.html" title="PG::TypeMap (class)"><code>TypeMap</code></a> that is currently set for values that could not be casted by this type map.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m rw' href="TypeMap/DefaultTypeMappable.html#default_type_map=-instance_method" title="PG::TypeMap::DefaultTypeMappable#default_type_map= (method)">#default_type_map=</a></td>
      <td><div class='inline'><p>Set the default <a href="TypeMap.html" title="PG::TypeMap (class)"><code>TypeMap</code></a> that is used for values that could not be casted by this type map.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_Method_summary'>Instance Method Summary</h2>
<div class='div_sum'>

<h3 class='inherited'><a href="TypeMapByOid.html" title="PG::TypeMapByOid (class)"><code>TypeMapByOid</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="TypeMapByOid.html#add_coder-instance_method" title="PG::TypeMapByOid#add_coder (method)">#add_coder</a></td>
      <td><div class='inline'><p>Assigns a new <a href="Coder.html" title="PG::Coder (class)"><code>Coder</code></a> object to the type map.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="TypeMapByOid.html#build_column_map-instance_method" title="PG::TypeMapByOid#build_column_map (method)">#build_column_map</a></td>
      <td><div class='inline'><p>This builds a <a href="TypeMapByColumn.html" title="PG::TypeMapByColumn (class)"><code>TypeMapByColumn</code></a> that fits to the given <a href="Result.html" title="PG::Result (class)"><code>Result</code></a> object based on it’s type OIDs and binary/text format.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="TypeMapByOid.html#coders-instance_method" title="PG::TypeMapByOid#coders (method)">#coders</a></td>
      <td><div class='inline'><p>Array of all assigned <a href="Coder.html" title="PG::Coder (class)"><code>Coder</code></a> objects.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="TypeMapByOid.html#rm_coder-instance_method" title="PG::TypeMapByOid#rm_coder (method)">#rm_coder</a></td>
      <td><div class='inline'><p>Removes a <a href="Coder.html" title="PG::Coder (class)"><code>Coder</code></a> object from the type map based on the given oid and format codes.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="TypeMap/DefaultTypeMappable.html" title="PG::TypeMap::DefaultTypeMappable (module)"><code>TypeMap::DefaultTypeMappable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="TypeMap/DefaultTypeMappable.html#with_default_type_map-instance_method" title="PG::TypeMap::DefaultTypeMappable#with_default_type_map (method)">#with_default_type_map</a></td>
      <td><div class='inline'><p>Set the default <a href="TypeMap.html" title="PG::TypeMap (class)"><code>TypeMap</code></a> that is used for values that could not be casted by this type map.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(connection_or_coder_maps, registry: nil)  &#x21d2; <code>BasicTypeMapBasedOnResult</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/basic_type_map_based_on_result.rb#L59-L66'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='59' data-end='66'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/pg/basic_type_map_based_on_result.rb', line 59</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_connection_or_coder_maps'>connection_or_coder_maps</span><span class='comma'>,</span> <span class='label'>registry:</span> <span class='kw'>nil</span>)
	<span class='ivar'>@coder_maps</span> <span class='op'>=</span> <span class='id identifier rubyid_build_coder_maps'>build_coder_maps</span>(<span class='id identifier rubyid_connection_or_coder_maps'>connection_or_coder_maps</span><span class='comma'>,</span> <span class='label'>registry:</span> <span class='id identifier rubyid_registry'>registry</span>)

	<span class='comment'># Populate TypeMapByOid hash with encoders
</span>	<span class='ivar'>@coder_maps</span>.<span class='id identifier rubyid_each_format'>each_format</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_encoder'>encoder</span>).<span class='id identifier rubyid_flat_map'>flat_map</span>{<span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span> <span class='id identifier rubyid_f'>f</span>.<span class='id identifier rubyid_coders'>coders</span> }.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_coder'>coder</span><span class='op'>|</span>
		<span class='id identifier rubyid_add_coder'>add_coder</span>(<span class='id identifier rubyid_coder'>coder</span>)
	<span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>