<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: PG::CancelConnection &mdash; PG master</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "PG::CancelConnection",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>PG master</a> &raquo; 
      <a href='../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../PG.html" title="PG (module)">PG</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>CancelConnection&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: PG::CancelConnection</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="Connection/Pollable.html" title="PG::Connection::Pollable (module)"><code>Connection::Pollable</code></a>,
          Enumerable
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="../Object.html" title="Object (class)">Object</a></span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2 o'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L3'>ext/pg_cancel_connection.c</a><span class='defines'>,<br /><a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L346'>ext/pg_cancel_connection.c</a>,<br/> <a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/cancel_connection.rb#L7'>lib/pg/cancel_connection.rb</a></span>
      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>The class to represent a connection to cancel a query.</p>

<p>On PostgreSQL-17+ client libaray this class is used to implement <a href="Connection.html#cancel-instance_method" title="PG::Connection#cancel (method)">Connection#cancel</a> . It works on older PostgreSQL server versions too.</p>

<p>Available since PostgreSQL-17</p>

  </div>
</div>
</div>
<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(conn)  &#x21d2; CancelConnection </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#conninfo_hash-instance_method" title="#conninfo_hash (instance method)">#<strong>conninfo_hash</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#host-instance_method" title="#host (instance method)">#<strong>host</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#hostaddr-instance_method" title="#hostaddr (instance method)">#<strong>hostaddr</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature ro priv'>
      <a href="#port-instance_method" title="#port (instance method)">#<strong>port</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <span class='note title private'>private</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#async_cancel-instance_method" title="#async_cancel (instance method)">#<strong>async_cancel</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Alias for <a href="#cancel-instance_method" title="PG::CancelConnection#cancel (method)">#cancel</a>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#c_initialize-instance_method" title="#c_initialize (instance method)">#<strong>c_initialize</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#cancel-instance_method" title="#cancel (instance method)">#<strong>cancel</strong>  </a>
      (also: #async_cancel)
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Requests that the server abandons processing of the current command in a blocking manner.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#error_message-instance_method" title="#error_message (instance method)">#<strong>error_message</strong>  &#x21d2; String </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the error message most recently generated by an operation on the cancel connection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#finish-instance_method" title="#finish (instance method)">#<strong>finish</strong>  &#x21d2; nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Closes the cancel connection (if it did not finish sending the cancel request yet).</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#initialize-instance_method" title="#new (instance method)">#<strong>new</strong>(conn)  &#x21d2; Object </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Prepares a connection over which a cancel request can be sent.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#poll-instance_method" title="#poll (instance method)">#<strong>poll</strong>  &#x21d2; Integer </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>This is to poll libpq so that it can proceed with the cancel connection sequence.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#reset-instance_method" title="#reset (instance method)">#<strong>reset</strong>  &#x21d2; nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Resets the <code>CancelConnection</code> so it can be reused for a new cancel connection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#socket_io-instance_method" title="#socket_io (instance method)">#<strong>socket_io</strong>  &#x21d2; IO </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Fetch an IO object created from the CancelConnection’s underlying socket.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#start-instance_method" title="#start (instance method)">#<strong>start</strong>  &#x21d2; nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Requests that the server abandons processing of the current command in a non-blocking manner.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#status-instance_method" title="#status (instance method)">#<strong>status</strong>  &#x21d2; Integer </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns the status of the cancel connection.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#sync_cancel-instance_method" title="#sync_cancel (instance method)">#<strong>sync_cancel</strong>  &#x21d2; nil </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Requests that the server abandons processing of the current command in a blocking manner.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited'><a href="Connection/Pollable.html" title="PG::Connection::Pollable (module)"><code>Connection::Pollable</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Connection/Pollable.html#polling_loop-instance_method" title="PG::Connection::Pollable#polling_loop (method)">#polling_loop</a></td>
      <td><div class='inline'><p>Track the progress of the connection, waiting for the socket to become readable/writable before polling it.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m priv' href="Connection/Pollable.html#remove_current_host-instance_method" title="PG::Connection::Pollable#remove_current_host (method)">#remove_current_host</a></td>
      <td><div class='inline'><p>Remove the host to which the connection is currently established from the option hash.</p></div></td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(conn)  &#x21d2; <code>CancelConnection</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/cancel_connection.rb#L12-L27'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='12' data-end='27'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/pg/cancel_connection.rb', line 12</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'><a href="#initialize-instance_method" title="PG::CancelConnection#initialize (method)">initialize</a></span>(<span class='id identifier rubyid_conn'>conn</span>)
	<span class='id identifier rubyid_c_initialize'><a href="#c_initialize-instance_method" title="PG::CancelConnection#c_initialize (method)">c_initialize</a></span>(<span class='id identifier rubyid_conn'>conn</span>)

	<span class='comment'># A cancel connection is always to one destination server only.
</span>	<span class='comment'># Prepare conninfo_hash with just enough information to allow a shared polling_loop.
</span>	<span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_host'><a href="#host-instance_method" title="PG::CancelConnection#host (method)">host</a></span>
	<span class='ivar'>@hostaddr</span> <span class='op'>=</span> <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_hostaddr'><a href="#hostaddr-instance_method" title="PG::CancelConnection#hostaddr (method)">hostaddr</a></span>
	<span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_port'><a href="#port-instance_method" title="PG::CancelConnection#port (method)">port</a></span>

	<span class='ivar'>@conninfo_hash</span> <span class='op'>=</span> {
		<span class='label'>host:</span> <span class='ivar'>@host</span><span class='comma'>,</span>
		<span class='label'>hostaddr:</span> <span class='ivar'>@hostaddr</span><span class='comma'>,</span>
		<span class='label'>port:</span> <span class='ivar'>@port</span>.<span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
		<span class='label'>connect_timeout:</span> <span class='id identifier rubyid_conn'>conn</span>.<span class='id identifier rubyid_conninfo_hash'><a href="#conninfo_hash-instance_method" title="PG::CancelConnection#conninfo_hash (method)">conninfo_hash</a></span>[<span class='symbeg'>:</span><span class='id identifier rubyid_connect_timeout'>connect_timeout</span>]<span class='comma'>,</span>
	}
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

  <section class='method_details' id="initialize-instance_method">
  <h3 class='signature '>
    #<strong>new</strong>(conn)  &#x21d2; <a href="../Object.html" title="Object (class)">Object</a>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Prepares a connection over which a cancel request can be sent.</p>

<p>Creates a <code>CancelConnection</code> from a <a href="Connection.html" title="PG::Connection (class)"><code>Connection</code></a> object, but it won’t instantly start sending a cancel request over this connection. A cancel request can be sent over this connection in a blocking manner using <a href="#cancel-instance_method" title="PG::CancelConnection#cancel (method)">#cancel</a> and in a non-blocking manner using <a href="#start-instance_method" title="PG::CancelConnection#start (method)">#start</a>. <a href="#status-instance_method" title="PG::CancelConnection#status (method)">#status</a> can be used to check if the <code>CancelConnection</code> object was connected successfully. This <code>CancelConnection</code> object can be used to cancel the query that’s running on the original connection in a thread-safe way.</p>

<p>Many connection parameters of the original client will be reused when setting up the connection for the cancel request. Importantly, if the original connection requires encryption of the connection and/or verification of the target host (using sslmode or gssencmode), then the connection for the cancel request is made with these same requirements. Any connection options that are only used during authentication or after authentication of the client are ignored though, because cancellation requests do not require authentication and the connection is closed right after the cancellation request is submitted.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L139-L150'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='139' data-end='150'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'ext/pg_cancel_connection.c', line 139</span></pre>
<pre class='code cpp'>

VALUE
pg_cancon_initialize(VALUE self, VALUE rb_conn)
{
	t_pg_cancon *this = pg_cancon_get_this(self);
	PGconn *conn = pg_get_pgconn(rb_conn);

	this-&gt;pg_cancon = PQcancelCreate(conn);
	if (this-&gt;pg_cancon == NULL)
		pg_raise_conn_error( rb_eConnectionBad, self, &quot;PQcancelCreate failed&quot;);

	return self;
}
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="conninfo_hash-instance_method">
  <h3 class='signature ro priv first'>
    #<strong>conninfo_hash</strong>   <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/cancel_connection.rb#L51-L51'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='51' data-end='51'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/pg/cancel_connection.rb', line 51</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_conninfo_hash'>conninfo_hash</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="host-instance_method">
  <h3 class='signature ro priv'>
    #<strong>host</strong>   <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/cancel_connection.rb#L48-L48'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='48' data-end='48'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/pg/cancel_connection.rb', line 48</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_host'>host</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="hostaddr-instance_method">
  <h3 class='signature ro priv'>
    #<strong>hostaddr</strong>   <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/cancel_connection.rb#L49-L49'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='49' data-end='49'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/pg/cancel_connection.rb', line 49</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_hostaddr'>hostaddr</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="port-instance_method">
  <h3 class='signature ro priv'>
    #<strong>port</strong>   <span class="extras">(<span class='readonly'>readonly</span>, <span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/cancel_connection.rb#L50-L50'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='50' data-end='50'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/pg/cancel_connection.rb', line 50</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_port'>port</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="async_cancel-instance_method">
  <h3 class='signature  first'>
    #<strong>async_cancel</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Alias for <a href="#cancel-instance_method" title="PG::CancelConnection#cancel (method)">#cancel</a>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/cancel_connection.rb#L44-L44'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='44' data-end='44'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/pg/cancel_connection.rb', line 44</span></pre>
<pre class='code ruby'>

<span class='kw'>alias</span> <span class='id identifier rubyid_async_cancel'>async_cancel</span> <span class='id identifier rubyid_cancel'><a href="#cancel-instance_method" title="PG::CancelConnection#cancel (method)">cancel</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="c_initialize-instance_method">
  <h3 class='signature '>
    #<strong>c_initialize</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/cancel_connection.rb#L10-L10'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='10' data-end='10'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/pg/cancel_connection.rb', line 10</span></pre>
<pre class='code ruby'>

<span class='kw'>alias</span> <span class='id identifier rubyid_c_initialize'>c_initialize</span> <span class='id identifier rubyid_initialize'><a href="#initialize-instance_method" title="PG::CancelConnection#initialize (method)">initialize</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cancel-instance_method">
  <h3 class='signature '>
    #<strong>cancel</strong>      <span class='aliases'>Also known as: <span class='names'>#async_cancel</span></span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Requests that the server abandons processing of the current command in a blocking manner.</p>

<p>If the cancel request wasn’t successfully dispatched an error message is raised.</p>

<p>Successful dispatch of the cancellation is no guarantee that the request will have any effect, however. If the cancellation is effective, the command being canceled will terminate early and raises an error. If the cancellation fails (say, because the server was already done processing the command), then there will be no visible result at all.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/lib/pg/cancel_connection.rb#L40-L43'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='40' data-end='43'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/pg/cancel_connection.rb', line 40</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cancel'>cancel</span>
	<span class='id identifier rubyid_start'><a href="#start-instance_method" title="PG::CancelConnection#start (method)">start</a></span>
	<span class='id identifier rubyid_polling_loop'>polling_loop</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_poll'><a href="#poll-instance_method" title="PG::CancelConnection#poll (method)">poll</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="error_message-instance_method">
  <h3 class='signature '>
    #<strong>error_message</strong>  &#x21d2; <code>String</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the error message most recently generated by an operation on the cancel connection.</p>

<p>Nearly all <code>CancelConnection</code> functions will set a message if they fail. Note that by libpq convention, a nonempty error_message result can consist of multiple lines, and will include a trailing newline.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L204-L213'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='204' data-end='213'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'ext/pg_cancel_connection.c', line 204</span></pre>
<pre class='code cpp'>

static VALUE
pg_cancon_error_message(VALUE self)
{
	PGcancelConn *conn = pg_cancon_get_conn(self);
	char *p_err;

	p_err = PQcancelErrorMessage(conn);

	return p_err ? rb_str_new_cstr(p_err) : Qnil;
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="finish-instance_method">
  <h3 class='signature '>
    #<strong>finish</strong>  &#x21d2; <code>nil</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Closes the cancel connection (if it did not finish sending the cancel request yet). Also frees memory used by the <code>CancelConnection</code> object.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L326-L337'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='326' data-end='337'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'ext/pg_cancel_connection.c', line 326</span></pre>
<pre class='code cpp'>

static VALUE
pg_cancon_finish(VALUE self)
{
	t_pg_cancon *this = pg_cancon_get_this( self );

	pg_cancon_close_socket_io( self );
	if( this-&gt;pg_cancon )
		PQcancelFinish(this-&gt;pg_cancon);
	this-&gt;pg_cancon = NULL;

	return Qnil;
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="poll-instance_method">
  <h3 class='signature '>
    #<strong>poll</strong>  &#x21d2; <code>Integer</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>This is to poll libpq so that it can proceed with the cancel connection sequence.</p>

<p>The behavior is the same like <a href="Connection.html#connect_poll-instance_method" title="PG::Connection#connect_poll (method)">Connection#connect_poll</a> .</p>

<p>See also corresponding <a href="https://www.postgresql.org/docs/current/libpq-cancel.html#LIBPQ-PQCANCELSTART" target="_parent" title="libpq function">libpq function</a></p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L226-L236'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='226' data-end='236'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'ext/pg_cancel_connection.c', line 226</span></pre>
<pre class='code cpp'>

static VALUE
pg_cancon_poll(VALUE self)
{
	PostgresPollingStatusType status;
	PGcancelConn *conn = pg_cancon_get_conn(self);

	pg_cancon_close_socket_io( self );
	status = gvl_PQcancelPoll(conn);

	return INT2FIX((int)status);
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="reset-instance_method">
  <h3 class='signature '>
    #<strong>reset</strong>  &#x21d2; <code>nil</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Resets the <code>CancelConnection</code> so it can be reused for a new cancel connection.</p>

<p>If the <code>CancelConnection</code> is currently used to send a cancel request, then this connection is closed. It will then prepare the <code>CancelConnection</code> object such that it can be used to send a new cancel request.</p>

<p>This can be used to create one <code>CancelConnection</code> for a <a href="Connection.html" title="PG::Connection (class)"><code>Connection</code></a> and reuse it multiple times throughout the lifetime of the original <a href="Connection.html" title="PG::Connection (class)"><code>Connection</code></a>.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L308-L317'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='308' data-end='317'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'ext/pg_cancel_connection.c', line 308</span></pre>
<pre class='code cpp'>

static VALUE
pg_cancon_reset(VALUE self)
{
	PGcancelConn *conn = pg_cancon_get_conn(self);

	pg_cancon_close_socket_io( self );
	PQcancelReset(conn);

	return Qnil;
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="socket_io-instance_method">
  <h3 class='signature '>
    #<strong>socket_io</strong>  &#x21d2; <code>IO</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Fetch an IO object created from the CancelConnection’s underlying socket. This object can be used per <code>socket_io.wait_readable</code>, <code>socket_io.wait_writable</code> or for <code>IO.select</code> to wait for events while running asynchronous API calls. <code>IO#wait_*able</code> is <code>Fiber.scheduler</code> compatible in contrast to <code>IO.select</code>.</p>

<p>The IO object can change while the connection is established. So be sure not to cache the IO object, but repeat calling <code>conn.socket_io</code> instead.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L281-L295'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='281' data-end='295'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'ext/pg_cancel_connection.c', line 281</span></pre>
<pre class='code cpp'>

static VALUE
pg_cancon_socket_io(VALUE self)
{
	t_pg_cancon *this = pg_cancon_get_this( self );

	if ( !RTEST(this-&gt;socket_io) ) {
		int sd;
		if( (sd = PQcancelSocket(this-&gt;pg_cancon)) &lt; 0){
			pg_raise_conn_error( rb_eConnectionBad, self, &quot;PQcancelSocket() can&#39;t get socket descriptor&quot;);
		}
		return pg_wrap_socket_io( sd, self, &amp;this-&gt;socket_io, &amp;this-&gt;ruby_sd);
	}

	return this-&gt;socket_io;
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="start-instance_method">
  <h3 class='signature '>
    #<strong>start</strong>  &#x21d2; <code>nil</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Requests that the server abandons processing of the current command in a non-blocking manner.</p>

<p>The behavior is the same like <a href="Connection.html#connect_start-class_method" title="PG::Connection.connect_start (method)">Connection.connect_start</a> .</p>

<p>Use <a href="#poll-instance_method" title="PG::CancelConnection#poll (method)">#poll</a> to poll the status of the connection.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L184-L193'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='184' data-end='193'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'ext/pg_cancel_connection.c', line 184</span></pre>
<pre class='code cpp'>

static VALUE
pg_cancon_start(VALUE self)
{
	PGcancelConn *conn = pg_cancon_get_conn(self);

	pg_cancon_close_socket_io( self );
	if(gvl_PQcancelStart(conn) == 0)
		pg_raise_conn_error( rb_eConnectionBad, self, &quot;PQcancelStart %s&quot;, PQcancelErrorMessage(conn));
	return Qnil;
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="status-instance_method">
  <h3 class='signature '>
    #<strong>status</strong>  &#x21d2; <code>Integer</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns the status of the cancel connection.</p>

<p>The status can be one of a number of values. However, only three of these are seen outside of an asynchronous cancel procedure: <code>CONNECTION_ALLOCATED</code>, <code>CONNECTION_OK</code> and <code>CONNECTION_BAD</code>. The initial state of a <code>CancelConnection</code> that’s successfully created is <code>CONNECTION_ALLOCATED</code>. A cancel request that was successfully dispatched has the status <code>CONNECTION_OK</code>. A failed cancel attempt is signaled by status <code>CONNECTION_BAD</code>. An OK status will remain so until <a href="#finish-instance_method" title="PG::CancelConnection#finish (method)">#finish</a> or <a href="#reset-instance_method" title="PG::CancelConnection#reset (method)">#reset</a> is called.</p>

<p>See <a href="#poll-instance_method" title="PG::CancelConnection#poll (method)">#poll</a> with regards to other status codes that might be returned.</p>

<p>Successful dispatch of the cancellation is no guarantee that the request will have any effect, however. If the cancellation is effective, the command being canceled will terminate early and return an error result. If the cancellation fails (say, because the server was already done processing the command), then there will be no visible result at all.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L259-L268'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='259' data-end='268'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'ext/pg_cancel_connection.c', line 259</span></pre>
<pre class='code cpp'>

static VALUE
pg_cancon_status(VALUE self)
{
	ConnStatusType status;
	PGcancelConn *conn = pg_cancon_get_conn(self);

	status = PQcancelStatus(conn);

	return INT2NUM(status);
}
</pre>
  </div>
</div>
</section>

<section class='method_details' id="sync_cancel-instance_method">
  <h3 class='signature '>
    #<strong>sync_cancel</strong>  &#x21d2; <code>nil</code>   </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Requests that the server abandons processing of the current command in a blocking manner.</p>

<p>This method directly calls <code>PQcancelBlocking</code> of libpq, so that it doesn’t respond to ruby interrupts and doesn’t trigger the <code>Thread.scheduler</code> . It is threrfore recommended to call <a href="#cancel-instance_method" title="PG::CancelConnection#cancel (method)">#cancel</a> instead.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ged/ruby-pg/blob/master/ext/pg_cancel_connection.c#L162-L171'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='162' data-end='171'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'ext/pg_cancel_connection.c', line 162</span></pre>
<pre class='code cpp'>

static VALUE
pg_cancon_sync_cancel(VALUE self)
{
	PGcancelConn *conn = pg_cancon_get_conn(self);

	pg_cancon_close_socket_io( self );
	if(gvl_PQcancelBlocking(conn) == 0)
		pg_raise_conn_error( rb_eConnectionBad, self, &quot;PQcancelBlocking %s&quot;, PQcancelErrorMessage(conn));
	return Qnil;
}
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>