<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: TestPuma::ServerSpawn &mdash; Puma-test</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "TestPuma::ServerSpawn",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Puma-test</a> &raquo; 
      <a href='../_index.html#alpha_S'>Index (S)</a> &raquo; 
        <a href="../TestPuma.html" title="TestPuma (module)">TestPuma</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ServerSpawn&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: TestPuma::ServerSpawn</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Super Chains via Extension / Inclusion / Inheritance</td></tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Class Chain:</div>
        <div class='box_22'>
          self,
          <a href="ServerBase.html" title="TestPuma::ServerBase (class)"><code>ServerBase</code></a>,
          Minitest::Test
        </div>
      </td>
    </tr>
    <tr>
      <td colspan='2'>
        <div class='box_2'>Instance Chain:</div>
        <div class='box_22'>
          self,
          <a href="ServerBase.html" title="TestPuma::ServerBase (class)"><code>ServerBase</code></a>,
          <a href="PumaSocket.html" title="TestPuma::PumaSocket (module)"><code>PumaSocket</code></a>,
          <a href="../TestPuma.html" title="TestPuma (module)"><code>::TestPuma</code></a>,
          Minitest::Test
        </div>
      </td>
    </tr>
    <tr>
      <td id='t2_inherits' class='box_2 o'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="ServerBase.html" title="TestPuma::ServerBase (class)">TestPuma::ServerBase</a></span>
        <ul class='fullTree'>
          <li><a href="../Object.html" title="Object (class)"><code>::Object</code></a></li>
          <li class='next'>Minitest::Test</li>
          <li class='next'><a href="ServerBase.html" title="TestPuma::ServerBase (class)">TestPuma::ServerBase</a></li>
          <li class='next'>TestPuma::ServerSpawn</li>
        </ul>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L14'>test/helpers/test_puma/server_spawn.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Creates a server by spawning a sub-process and running <code>bin/puma</code>.  These should be used for testing of startup, restarts, and shutdown.  They are also isolated from the test environment.  Becuase they spawn a sub-process, they are much slower than in-process servers created with <a href="ServerInProcess.html" title="TestPuma::ServerInProcess (class)"><code>ServerInProcess</code></a>.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='BASE-constant' class='summary_signature'>BASE =</span>
    <br/>
    <a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L22-L22'># File 'test/helpers/test_puma/server_spawn.rb', line 22</a>    <pre class='code ruby'><span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_WINDOWS-constant" title="Puma::IS_WINDOWS (constant)">IS_WINDOWS</a></span> <span class='op'>?</span> <span class='const'>Gem</span>.<span class='id identifier rubyid_ruby'>ruby</span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span></pre>
  </li>
  <li>
    <span id='DFLT_RUBYOPT-constant' class='summary_signature'>DFLT_RUBYOPT =</span>
    <br/>
    <a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L24-L24'># File 'test/helpers/test_puma/server_spawn.rb', line 24</a>    <pre class='code ruby'><span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RUBYOPT</span><span class='tstring_end'>&#39;</span></span>]</pre>
  </li>
  <li>
    <span id='LOG_ERROR_QTY-constant' class='summary_signature'>LOG_ERROR_QTY =</span>
    <br/>
    <a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L20-L20'># File 'test/helpers/test_puma/server_spawn.rb', line 20</a>    <pre class='code ruby'><span class='int'>5</span></pre>
  </li>
  <li>
    <span id='LOG_ERROR_SLEEP-constant' class='summary_signature'>LOG_ERROR_SLEEP =</span>
    <br/>
    <a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L19-L19'># File 'test/helpers/test_puma/server_spawn.rb', line 19</a>    <pre class='code ruby'><span class='float'>0.2</span></pre>
  </li>
  <li>
    <span id='LOG_TIMEOUT-constant' class='summary_signature'>LOG_TIMEOUT =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>used in wait_for_server_to_* methods</p>

  </div>
</div>
    <a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L17-L17'># File 'test/helpers/test_puma/server_spawn.rb', line 17</a>    <pre class='code ruby'><span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_JRUBY-constant" title="Puma::IS_JRUBY (constant)">IS_JRUBY</a></span> <span class='op'>?</span> <span class='int'>20</span> <span class='op'>:</span> <span class='int'>10</span></pre>
  </li>
  <li>
    <span id='LOG_WAIT_READ-constant' class='summary_signature'>LOG_WAIT_READ =</span>
    <br/>
    <a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L18-L18'># File 'test/helpers/test_puma/server_spawn.rb', line 18</a>    <pre class='code ruby'><span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_JRUBY-constant" title="Puma::IS_JRUBY (constant)">IS_JRUBY</a></span> <span class='op'>?</span> <span class='int'>5</span> <span class='op'>:</span> <span class='int'>2</span></pre>
  </li>
</ul>
  <h3 class='inherited'><a href="../TestPuma.html" title="TestPuma (module)"><code>::TestPuma</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="../TestPuma.html#AFTER_RUN_OK-constant" title="TestPuma::AFTER_RUN_OK (constant)">AFTER_RUN_OK</a>, 
    <a href="../TestPuma.html#ALT_HOST-constant" title="TestPuma::ALT_HOST (constant)">ALT_HOST</a>, 
    <a href="../TestPuma.html#DARWIN-constant" title="TestPuma::DARWIN (constant)">DARWIN</a>, 
    <a href="../TestPuma.html#DEBUGGING_INFO-constant" title="TestPuma::DEBUGGING_INFO (constant)">DEBUGGING_INFO</a>, 
    <a href="../TestPuma.html#DEBUGGING_PIDS-constant" title="TestPuma::DEBUGGING_PIDS (constant)">DEBUGGING_PIDS</a>, 
    <a href="../TestPuma.html#HOST-constant" title="TestPuma::HOST (constant)">HOST</a>, 
    <a href="../TestPuma.html#HOST4-constant" title="TestPuma::HOST4 (constant)">HOST4</a>, 
    <a href="../TestPuma.html#HOST6-constant" title="TestPuma::HOST6 (constant)">HOST6</a>, 
    <a href="../TestPuma.html#IS_GITHUB_ACTIONS-constant" title="TestPuma::IS_GITHUB_ACTIONS (constant)">IS_GITHUB_ACTIONS</a>, 
    <a href="../TestPuma.html#LINE_SPLIT-constant" title="TestPuma::LINE_SPLIT (constant)">LINE_SPLIT</a>, 
    <a href="../TestPuma.html#LOCALHOST-constant" title="TestPuma::LOCALHOST (constant)">LOCALHOST</a>, 
    <a href="../TestPuma.html#PUMA_CI_TMPDIR-constant" title="TestPuma::PUMA_CI_TMPDIR (constant)">PUMA_CI_TMPDIR</a>, 
    <a class='priv ' href="../TestPuma.html#RANDOM-constant" title="TestPuma::RANDOM (constant)">RANDOM</a>, 
    <a href="../TestPuma.html#RESP_SPLIT-constant" title="TestPuma::RESP_SPLIT (constant)">RESP_SPLIT</a>, 
    <a href="../TestPuma.html#RE_HOST_TO_IP-constant" title="TestPuma::RE_HOST_TO_IP (constant)">RE_HOST_TO_IP</a>, 
    <a href="../TestPuma.html#TOKEN-constant" title="TestPuma::TOKEN (constant)">TOKEN</a>, 
    <a class='priv ' href="../TestPuma.html#UNUSABLE_CHARS-constant" title="TestPuma::UNUSABLE_CHARS (constant)">UNUSABLE_CHARS</a>
  </p>
  <h3 class='inherited'><a href="PumaSocket.html" title="TestPuma::PumaSocket (module)"><code>PumaSocket</code></a> - Included</h3>
  <p  class='inherited'>
    <a href="PumaSocket.html#EMPTY_200-constant" title="TestPuma::PumaSocket::EMPTY_200 (constant)">EMPTY_200</a>, 
    <a href="PumaSocket.html#GET_10-constant" title="TestPuma::PumaSocket::GET_10 (constant)">GET_10</a>, 
    <a href="PumaSocket.html#GET_11-constant" title="TestPuma::PumaSocket::GET_11 (constant)">GET_11</a>, 
    <a href="PumaSocket.html#GET_11_CLOSE-constant" title="TestPuma::PumaSocket::GET_11_CLOSE (constant)">GET_11_CLOSE</a>, 
    <a href="PumaSocket.html#HELLO_11-constant" title="TestPuma::PumaSocket::HELLO_11 (constant)">HELLO_11</a>, 
    <a href="PumaSocket.html#NO_ENTITY_BODY-constant" title="TestPuma::PumaSocket::NO_ENTITY_BODY (constant)">NO_ENTITY_BODY</a>, 
    <a href="PumaSocket.html#OPENSSL_3-constant" title="TestPuma::PumaSocket::OPENSSL_3 (constant)">OPENSSL_3</a>, 
    <a href="PumaSocket.html#PROTOCOL_USE_MIN_MAX-constant" title="TestPuma::PumaSocket::PROTOCOL_USE_MIN_MAX (constant)">PROTOCOL_USE_MIN_MAX</a>, 
    <a href="PumaSocket.html#READ_BODY-constant" title="TestPuma::PumaSocket::READ_BODY (constant)">READ_BODY</a>, 
    <a href="PumaSocket.html#READ_RESPONSE-constant" title="TestPuma::PumaSocket::READ_RESPONSE (constant)">READ_RESPONSE</a>, 
    <a href="PumaSocket.html#REQ_WRITE-constant" title="TestPuma::PumaSocket::REQ_WRITE (constant)">REQ_WRITE</a>, 
    <a href="PumaSocket.html#RESP_READ_LEN-constant" title="TestPuma::PumaSocket::RESP_READ_LEN (constant)">RESP_READ_LEN</a>, 
    <a href="PumaSocket.html#RESP_READ_TIMEOUT-constant" title="TestPuma::PumaSocket::RESP_READ_TIMEOUT (constant)">RESP_READ_TIMEOUT</a>, 
    <a href="PumaSocket.html#SEND_REQUEST-constant" title="TestPuma::PumaSocket::SEND_REQUEST (constant)">SEND_REQUEST</a>, 
    <a href="PumaSocket.html#SET_TCP_NODELAY-constant" title="TestPuma::PumaSocket::SET_TCP_NODELAY (constant)">SET_TCP_NODELAY</a>, 
    <a href="PumaSocket.html#UTF8-constant" title="TestPuma::PumaSocket::UTF8 (constant)">UTF8</a>
  </p>
  <h3 class='inherited'><a href="ServerBase.html" title="TestPuma::ServerBase (class)"><code>ServerBase</code></a> - Inherited</h3>
  <p  class='inherited'>
    <a href="ServerBase.html#CERT_PATH-constant" title="TestPuma::ServerBase::CERT_PATH (constant)">CERT_PATH</a>, 
    <a href="ServerBase.html#CLIENT_CERTS_PATH-constant" title="TestPuma::ServerBase::CLIENT_CERTS_PATH (constant)">CLIENT_CERTS_PATH</a>, 
    <a href="ServerBase.html#DFLT_SSL_QUERY-constant" title="TestPuma::ServerBase::DFLT_SSL_QUERY (constant)">DFLT_SSL_QUERY</a>, 
    <a href="ServerBase.html#HAS_TLS_1_3-constant" title="TestPuma::ServerBase::HAS_TLS_1_3 (constant)">HAS_TLS_1_3</a>, 
    <a href="ServerBase.html#HELLO_RU-constant" title="TestPuma::ServerBase::HELLO_RU (constant)">HELLO_RU</a>, 
    <a href="ServerBase.html#MINI_FORCE_PEER-constant" title="TestPuma::ServerBase::MINI_FORCE_PEER (constant)">MINI_FORCE_PEER</a>, 
    <a href="ServerBase.html#MINI_VERIFY_NONE-constant" title="TestPuma::ServerBase::MINI_VERIFY_NONE (constant)">MINI_VERIFY_NONE</a>, 
    <a href="ServerBase.html#MINI_VERIFY_PEER-constant" title="TestPuma::ServerBase::MINI_VERIFY_PEER (constant)">MINI_VERIFY_PEER</a>
  </p>
</div>

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#after_teardown-instance_method" title="#after_teardown (instance method)">#<strong>after_teardown</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#before_setup-instance_method" title="#before_setup (instance method)">#<strong>before_setup</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#cli_pumactl-instance_method" title="#cli_pumactl (instance method)">#<strong>cli_pumactl</strong>(argv, no_bind: nil)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#cli_pumactl_spawn-instance_method" title="#cli_pumactl_spawn (instance method)">#<strong>cli_pumactl_spawn</strong>(argv, no_bind: nil)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#get_stats-instance_method" title="#get_stats (instance method)">#<strong>get_stats</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#get_worker_pids-instance_method" title="#get_worker_pids (instance method)">#<strong>get_worker_pids</strong>(phase = 0, size = workers, log: false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>gets worker pids from @server output.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#hot_restart_does_not_drop_connections-instance_method" title="#hot_restart_does_not_drop_connections (instance method)">#<strong>hot_restart_does_not_drop_connections</strong>(num_threads: 1, total_requests: 500)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#restart_server-instance_method" title="#restart_server (instance method)">#<strong>restart_server</strong>(socket, log: false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>reuses an existing connection to make sure that works.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#restart_server_and_listen-instance_method" title="#restart_server_and_listen (instance method)">#<strong>restart_server_and_listen</strong>(argv, log: false)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#server_gets-instance_method" title="#server_gets (instance method)">#<strong>server_gets</strong>(match_obj, time_timeout, log: false)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#server_spawn-instance_method" title="#server_spawn (instance method)">#<strong>server_spawn</strong>(argv = nil, config: nil, no_bind: nil, log: nil, no_wait: false, puma_debug: nil, env: {})  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#silent_and_checked_system_command-instance_method" title="#silent_and_checked_system_command (instance method)">#<strong>silent_and_checked_system_command</strong>(*args)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#spawn_cmd-instance_method" title="#spawn_cmd (instance method)">#<strong>spawn_cmd</strong>(env = {}, cmd)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#stop_server-instance_method" title="#stop_server (instance method)">#<strong>stop_server</strong>(pid = @pid, signal: :TERM, nohang: false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>rescue statements are just in case method is called with a server that is already stopped/killed, especially since <code>Process.wait2</code> is blocking.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#thread_run_refused-instance_method" title="#thread_run_refused (instance method)">#<strong>thread_run_refused</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>used to define correct ‘refused’ errors.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#wait_for_server_to_include-instance_method" title="#wait_for_server_to_include (instance method)">#<strong>wait_for_server_to_include</strong>(str, timeout: LOG_TIMEOUT, log: false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns true if and when server log includes str.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#wait_for_server_to_match-instance_method" title="#wait_for_server_to_match (instance method)">#<strong>wait_for_server_to_match</strong>(re, idx = nil, timeout: LOG_TIMEOUT, log: false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Returns line if and when server log matches re, unless idx is specified, then returns regex match.</p></div>
    </div>
  </li>
</ul>

<h3 class='inherited'><a href="ServerBase.html" title="TestPuma::ServerBase (class)"><code>ServerBase</code></a> - Inherited</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="ServerBase.html#after_teardown-instance_method" title="TestPuma::ServerBase#after_teardown (method)">#after_teardown</a>,
        <a class='i_m ' href="ServerBase.html#before_setup-instance_method" title="TestPuma::ServerBase#before_setup (method)">#before_setup</a>,
        <a class='i_m ' href="ServerBase.html#bind_host-instance_method" title="TestPuma::ServerBase#bind_host (method)">#bind_host</a>,
        <a class='i_m ' href="ServerBase.html#bind_path-instance_method" title="TestPuma::ServerBase#bind_path (method)">#bind_path</a>,
        <a class='i_m ' href="ServerBase.html#bind_port-instance_method" title="TestPuma::ServerBase#bind_port (method)">#bind_port</a>,
        <a class='i_m ' href="ServerBase.html#bind_ssl-instance_method" title="TestPuma::ServerBase#bind_ssl (method)">#bind_ssl</a>,
        <a class='i_m ' href="ServerBase.html#bind_uri_str-instance_method" title="TestPuma::ServerBase#bind_uri_str (method)">#bind_uri_str</a>,
        <a class='i_m ' href="ServerBase.html#config_path-instance_method" title="TestPuma::ServerBase#config_path (method)">#config_path</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="ServerBase.html#control_config_str-instance_method" title="TestPuma::ServerBase#control_config_str (method)">#control_config_str</a></td>
      <td><div class='inline'><p>returns the line used in a <a href="../Puma.html" title="Puma (module)"><code>::Puma</code></a> configuration file to create a control server.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="ServerBase.html#control_host-instance_method" title="TestPuma::ServerBase#control_host (method)">#control_host</a>,
        <a class='i_m ' href="ServerBase.html#control_path-instance_method" title="TestPuma::ServerBase#control_path (method)">#control_path</a>,
        <a class='i_m ' href="ServerBase.html#control_port-instance_method" title="TestPuma::ServerBase#control_port (method)">#control_port</a>,
        <a class='i_m ' href="ServerBase.html#control_ssl-instance_method" title="TestPuma::ServerBase#control_ssl (method)">#control_ssl</a>,
        <a class='i_m ' href="ServerBase.html#control_uri_str-instance_method" title="TestPuma::ServerBase#control_uri_str (method)">#control_uri_str</a>,
        <a class='i_m ' href="ServerBase.html#set_bind_ssl-instance_method" title="TestPuma::ServerBase#set_bind_ssl (method)">#set_bind_ssl</a>,
        <a class='i_m ' href="ServerBase.html#set_bind_type-instance_method" title="TestPuma::ServerBase#set_bind_type (method)">#set_bind_type</a>,
        <a class='i_m ' href="ServerBase.html#set_control_ssl-instance_method" title="TestPuma::ServerBase#set_control_ssl (method)">#set_control_ssl</a>,
        <a class='i_m ' href="ServerBase.html#set_control_type-instance_method" title="TestPuma::ServerBase#set_control_type (method)">#set_control_type</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="ServerBase.html#set_pumactl_args-instance_method" title="TestPuma::ServerBase#set_pumactl_args (method)">#set_pumactl_args</a></td>
      <td><div class='inline'><p>Returns arguments used in a command line string to create or use a <a href="../Puma.html" title="Puma (module)"><code>::Puma</code></a> control server.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="ServerBase.html#set_workers-instance_method" title="TestPuma::ServerBase#set_workers (method)">#set_workers</a>,
        <a class='i_m ' href="ServerBase.html#state_path-instance_method" title="TestPuma::ServerBase#state_path (method)">#state_path</a>,
        <a class='i_m ' href="ServerBase.html#workers-instance_method" title="TestPuma::ServerBase#workers (method)">#workers</a>
      </td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="PumaSocket.html" title="TestPuma::PumaSocket (module)"><code>PumaSocket</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#after_teardown-instance_method" title="TestPuma::PumaSocket#after_teardown (method)">#after_teardown</a></td>
      <td><div class='inline'><p>Closes all io’s in <code>@ios_to_close</code>, also deletes them if they are files.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="PumaSocket.html#before_setup-instance_method" title="TestPuma::PumaSocket#before_setup (method)">#before_setup</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#new_ctx-instance_method" title="TestPuma::PumaSocket#new_ctx (method)">#new_ctx</a></td>
      <td><div class='inline'><p>Helper for creating an <code>OpenSSL::SSL::SSLContext</code>.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#new_socket-instance_method" title="TestPuma::PumaSocket#new_socket (method)">#new_socket</a></td>
      <td><div class='inline'><p>Creates a new client socket.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#read_response_array-instance_method" title="TestPuma::PumaSocket#read_response_array (method)">#read_response_array</a></td>
      <td><div class='inline'><p>Reads an array of sockets that have already had requests sent.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#send_http-instance_method" title="TestPuma::PumaSocket#send_http (method)">#send_http</a></td>
      <td><div class='inline'><p>Sends a request and returns the socket.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#send_http_array-instance_method" title="TestPuma::PumaSocket#send_http_array (method)">#send_http_array</a></td>
      <td><div class='inline'><p>Creates an array of sockets, sending a request on each.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#send_http_control-instance_method" title="TestPuma::PumaSocket#send_http_control (method)">#send_http_control</a></td>
      <td><div class='inline'><p>Sends a request to the <a href="../Puma.html" title="Puma (module)"><code>::Puma</code></a> control server.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#send_http_control_read_resp_body-instance_method" title="TestPuma::PumaSocket#send_http_control_read_resp_body (method)">#send_http_control_read_resp_body</a></td>
      <td><div class='inline'><p>Sends a request to the <a href="../Puma.html" title="Puma (module)"><code>::Puma</code></a> control server.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#send_http_read_all-instance_method" title="TestPuma::PumaSocket#send_http_read_all (method)">#send_http_read_all</a></td>
      <td><div class='inline'><p>Sends a request and returns whatever can be read.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#send_http_read_resp_body-instance_method" title="TestPuma::PumaSocket#send_http_read_resp_body (method)">#send_http_read_resp_body</a></td>
      <td><div class='inline'><p>Sends a request and returns the HTTP response body.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#send_http_read_resp_headers-instance_method" title="TestPuma::PumaSocket#send_http_read_resp_headers (method)">#send_http_read_resp_headers</a></td>
      <td><div class='inline'><p>Sends a request and returns the response header lines as an array of strings.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#send_http_read_response-instance_method" title="TestPuma::PumaSocket#send_http_read_response (method)">#send_http_read_response</a></td>
      <td><div class='inline'><p>Sends a request and returns the HTTP response.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="PumaSocket.html#skt_closed_by_server-instance_method" title="TestPuma::PumaSocket#skt_closed_by_server (method)">#skt_closed_by_server</a></td>
      <td><div class='inline'><p>Determines whether the socket has been closed by the server.</p></div></td>
    </tr>
  </tbody>
</table></div>

<h3 class='inherited'><a href="../TestPuma.html" title="TestPuma (module)"><code>::TestPuma</code></a> - Included</h3>
<div class='inherited'><table class='inherited'>
  <tbody>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="../TestPuma.html#after_teardown-instance_method" title="TestPuma#after_teardown (method)">#after_teardown</a>,
        <a class='i_m ' href="../TestPuma.html#before_setup-instance_method" title="TestPuma#before_setup (method)">#before_setup</a>,
        <a class='i_m ' href="../TestPuma.html#curl_and_get_response-instance_method" title="TestPuma#curl_and_get_response (method)">#curl_and_get_response</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../TestPuma.html#new_port-instance_method" title="TestPuma#new_port (method)">#new_port</a></td>
      <td><div class='inline'><p>Alias for <a href="../TestPuma.html#unique_port-instance_method" title="TestPuma#unique_port (method)">#unique_port</a>.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="../TestPuma.html#spawn_ext_cmd-instance_method" title="TestPuma#spawn_ext_cmd (method)">#spawn_ext_cmd</a>,
      </td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../TestPuma.html#unique_path-instance_method" title="TestPuma#unique_path (method)">#unique_path</a></td>
      <td><div class='inline'><p>Generates a unique file path.</p></div></td>
    </tr>
    <tr class='i_ds'>
      <td><a class='i_m ' href="../TestPuma.html#unique_port-instance_method" title="TestPuma#unique_port (method)">#unique_port</a></td>
      <td><div class='inline'><p>Returns an available port by using <code>TCPServer.open(host, 0)</code>.</p></div></td>
    </tr>
    <tr>
      <td colspan='2'>
        <a class='i_m ' href="../TestPuma.html#with_env-instance_method" title="TestPuma#with_env (method)">#with_env</a>,
        <a class='i_m priv' href="../TestPuma.html#kill_and_wait-instance_method" title="TestPuma#kill_and_wait (method)">#kill_and_wait</a>
      </td>
    </tr>
  </tbody>
</table></div>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="after_teardown-instance_method">
  <h3 class='signature  first'>
    #<strong>after_teardown</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L35-L61'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='35' data-end='61'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 35</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_after_teardown'>after_teardown</span>
  <span class='kw'>if</span> <span class='ivar'>@server</span>
    <span class='kw'>if</span> <span class='ivar'>@control_port</span> <span class='op'>&amp;&amp;</span> <span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_WINDOWS-constant" title="Puma::IS_WINDOWS (constant)">IS_WINDOWS</a></span>
      <span class='kw'>begin</span>
        <span class='id identifier rubyid_cli_pumactl'><a href="#cli_pumactl-instance_method" title="TestPuma::ServerSpawn#cli_pumactl (method)">cli_pumactl</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>stop</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>rescue</span> <span class='const'>SystemExit</span>
        <span class='const'><a href="../TestPuma.html" title="TestPuma (module)">TestPuma</a></span><span class='op'>::</span><span class='const'><a href="../TestPuma.html#DEBUGGING_INFO-constant" title="TestPuma::DEBUGGING_INFO (constant)">DEBUGGING_INFO</a></span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ControlCLI system exit </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>elsif</span> <span class='ivar'>@pid</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_WINDOWS-constant" title="Puma::IS_WINDOWS (constant)">IS_WINDOWS</a></span>
      <span class='id identifier rubyid_stop_server'><a href="#stop_server-instance_method" title="TestPuma::ServerSpawn#stop_server (method)">stop_server</a></span> <span class='label'>nohang:</span> <span class='op'>::</span><span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_MRI-constant" title="Puma::IS_MRI (constant)">IS_MRI</a></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='ivar'>@spawn_pid</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@spawn_pid</span> <span class='op'>!=</span> <span class='ivar'>@pid</span>
    <span class='id identifier rubyid_stop_server'><a href="#stop_server-instance_method" title="TestPuma::ServerSpawn#stop_server (method)">stop_server</a></span> <span class='ivar'>@spawn_pid</span><span class='comma'>,</span> <span class='label'>signal:</span> <span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_WINDOWS-constant" title="Puma::IS_WINDOWS (constant)">IS_WINDOWS</a></span> <span class='op'>?</span> <span class='symbeg'>:</span><span class='const'>KILL</span> <span class='op'>:</span> <span class='symbeg'>:</span><span class='const'>TERM</span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='ivar'>@cli_pumactl_spawn_pids</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='ivar'>@cli_pumactl_spawn_pids</span>.<span class='id identifier rubyid_each'>each</span> { <span class='op'>|</span><span class='id identifier rubyid_pid'>pid</span><span class='op'>|</span> <span class='id identifier rubyid_kill_and_wait'><a href="../TestPuma.html#kill_and_wait-class_method" title="TestPuma.kill_and_wait (method)">kill_and_wait</a></span> <span class='id identifier rubyid_pid'>pid</span> }
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='ivar'>@bind_path</span>
    <span class='id identifier rubyid_refute'>refute</span> <span class='const'>File</span>.<span class='id identifier rubyid_exist?'>exist?</span>(<span class='ivar'>@bind_path</span>)<span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Bind path must be removed after stop</span><span class='tstring_end'>&quot;</span></span>
    <span class='const'>File</span>.<span class='id identifier rubyid_unlink'>unlink</span>(<span class='ivar'>@bind_path</span>) <span class='kw'>rescue</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
  <span class='kw'>super</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="before_setup-instance_method">
  <h3 class='signature '>
    #<strong>before_setup</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L26-L33'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='26' data-end='33'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 26</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_before_setup'>before_setup</span>
  <span class='kw'>super</span>
  <span class='ivar'>@server_err</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@server_log</span> <span class='op'>=</span> <span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='ivar'>@pid</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@spawn_pid</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@cli_pumactl_spawn_pids</span> <span class='op'>=</span> []
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cli_pumactl-instance_method">
  <h3 class='signature '>
    #<strong>cli_pumactl</strong>(argv, no_bind: nil)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L225-L240'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='225' data-end='240'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 225</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cli_pumactl'>cli_pumactl</span>(<span class='id identifier rubyid_argv'>argv</span><span class='comma'>,</span> <span class='label'>no_bind:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_arg'>arg</span> <span class='op'>=</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_no_bind'>no_bind</span>
      <span class='id identifier rubyid_argv'>argv</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'> +</span><span class='regexp_end'>/</span></span>)
    <span class='kw'>elsif</span> <span class='ivar'>@state_path</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_argv'>argv</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='ivar'>@state_path</span>)
      <span class='words'><span class='words_beg'>%W[</span><span class='tstring_content'>-S</span><span class='words_sep'> </span><span class='embexpr_beg'>#{</span><span class='ivar'>@state_path</span><span class='embexpr_end'>}</span><span class='words_sep'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_argv'>argv</span><span class='embexpr_end'>}</span><span class='tstring_end'>]</span></span>
    <span class='kw'>else</span>
      <span class='words'><span class='words_beg'>%W[</span><span class='tstring_content'>-C</span><span class='words_sep'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_control_uri_str'>control_uri_str</span><span class='embexpr_end'>}</span><span class='words_sep'> </span><span class='tstring_content'>-T</span><span class='words_sep'> </span><span class='embexpr_beg'>#{</span><span class='const'><a href="../TestPuma.html#TOKEN-constant" title="TestPuma::TOKEN (constant)">TOKEN</a></span><span class='embexpr_end'>}</span><span class='words_sep'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_argv'>argv</span><span class='embexpr_end'>}</span><span class='tstring_end'>]</span></span>
    <span class='kw'>end</span>

  <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_w'>w</span> <span class='op'>=</span> <span class='const'><a href="../IO.html" title="IO (class)">IO</a></span>.<span class='id identifier rubyid_pipe'>pipe</span>
  <span class='ivar'>@ios_to_close</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_r'>r</span>
  <span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma/ControlCLI.html" title="Puma::ControlCLI (class)">ControlCLI</a></span>.<span class='id identifier rubyid_new'><a href="../Puma/ControlCLI.html#new-class_method" title="Puma::ControlCLI.new (method)">new</a></span>(<span class='id identifier rubyid_arg'>arg</span><span class='comma'>,</span> <span class='id identifier rubyid_w'>w</span><span class='comma'>,</span> <span class='id identifier rubyid_w'>w</span>).<span class='id identifier rubyid_run'><a href="../Puma/ControlCLI.html#run-instance_method" title="Puma::ControlCLI#run (method)">run</a></span>
  <span class='id identifier rubyid_w'>w</span>.<span class='id identifier rubyid_close'>close</span>
  <span class='id identifier rubyid_r'>r</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="cli_pumactl_spawn-instance_method">
  <h3 class='signature '>
    #<strong>cli_pumactl_spawn</strong>(argv, no_bind: nil)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L242-L261'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='242' data-end='261'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 242</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_cli_pumactl_spawn'>cli_pumactl_spawn</span>(<span class='id identifier rubyid_argv'>argv</span><span class='comma'>,</span> <span class='label'>no_bind:</span> <span class='kw'>nil</span>)
  <span class='id identifier rubyid_arg'>arg</span> <span class='op'>=</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_no_bind'>no_bind</span>
      <span class='id identifier rubyid_argv'>argv</span>
    <span class='kw'>elsif</span> <span class='ivar'>@state_path</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_argv'>argv</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='ivar'>@state_path</span>)
      <span class='words'><span class='words_beg'>%W[</span><span class='tstring_content'>-S</span><span class='words_sep'> </span><span class='embexpr_beg'>#{</span><span class='ivar'>@state_path</span><span class='embexpr_end'>}</span><span class='words_sep'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_argv'>argv</span><span class='embexpr_end'>}</span><span class='tstring_end'>]</span></span>
    <span class='kw'>else</span>
      <span class='words'><span class='words_beg'>%W[</span><span class='tstring_content'>-C</span><span class='words_sep'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_control_uri_str'>control_uri_str</span><span class='embexpr_end'>}</span><span class='words_sep'> </span><span class='tstring_content'>-T</span><span class='words_sep'> </span><span class='embexpr_beg'>#{</span><span class='const'><a href="../TestPuma.html#TOKEN-constant" title="TestPuma::TOKEN (constant)">TOKEN</a></span><span class='embexpr_end'>}</span><span class='words_sep'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_argv'>argv</span><span class='embexpr_end'>}</span><span class='tstring_end'>]</span></span>
    <span class='kw'>end</span>

  <span class='id identifier rubyid_pumactl_path'>pumactl_path</span> <span class='op'>=</span> <span class='const'>File</span>.<span class='id identifier rubyid_expand_path'>expand_path</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>../../../bin/pumactl</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid___dir__'>__dir__</span>

  <span class='id identifier rubyid_cmd'>cmd</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#BASE-constant" title="TestPuma::ServerSpawn::BASE (constant)">BASE</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pumactl_path'>pumactl_path</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_arg'>arg</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid_pid'>pid</span> <span class='op'>=</span> <span class='id identifier rubyid_spawn_cmd'><a href="#spawn_cmd-instance_method" title="TestPuma::ServerSpawn#spawn_cmd (method)">spawn_cmd</a></span> <span class='id identifier rubyid_cmd'>cmd</span>
  <span class='ivar'>@cli_pumactl_spawn_pids</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_pid'>pid</span>
  <span class='const'><a href="../TestPuma.html" title="TestPuma (module)">TestPuma</a></span><span class='op'>::</span><span class='const'><a href="../TestPuma.html#DEBUGGING_PIDS-constant" title="TestPuma::DEBUGGING_PIDS (constant)">DEBUGGING_PIDS</a></span>[<span class='id identifier rubyid_pid'>pid</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pumactl </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@ios_to_close</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_io'>io</span>
  <span class='id identifier rubyid_io'>io</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="get_stats-instance_method">
  <h3 class='signature '>
    #<strong>get_stats</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L263-L266'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='263' data-end='266'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 263</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_get_stats'>get_stats</span>
  <span class='id identifier rubyid_read_pipe'>read_pipe</span> <span class='op'>=</span> <span class='id identifier rubyid_cli_pumactl'><a href="#cli_pumactl-instance_method" title="TestPuma::ServerSpawn#cli_pumactl (method)">cli_pumactl</a></span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>stats</span><span class='tstring_end'>&quot;</span></span>
  <span class='const'>JSON</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_read_pipe'>read_pipe</span>.<span class='id identifier rubyid_readlines'>readlines</span>.<span class='id identifier rubyid_last'>last</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="get_worker_pids-instance_method">
  <h3 class='signature '>
    #<strong>get_worker_pids</strong>(phase = 0, size = workers, log: false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>gets worker pids from @server output</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L209-L218'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='209' data-end='218'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 209</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_get_worker_pids'>get_worker_pids</span>(<span class='id identifier rubyid_phase'>phase</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='id identifier rubyid_workers'>workers</span><span class='comma'>,</span> <span class='label'>log:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_pids'>pids</span> <span class='op'>=</span> []
  <span class='id identifier rubyid_re'>re</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>PID: (\d+)\) booted in [.0-9]+s, phase: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_phase'>phase</span><span class='embexpr_end'>}</span><span class='regexp_end'>/</span></span>
  <span class='kw'>while</span> <span class='id identifier rubyid_pids'>pids</span>.<span class='id identifier rubyid_size'>size</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_size'>size</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_pid'>pid</span> <span class='op'>=</span> <span class='id identifier rubyid_wait_for_server_to_match'><a href="#wait_for_server_to_match-instance_method" title="TestPuma::ServerSpawn#wait_for_server_to_match (method)">wait_for_server_to_match</a></span>(<span class='id identifier rubyid_re'>re</span><span class='comma'>,</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>log:</span> <span class='id identifier rubyid_log'>log</span>)
      <span class='id identifier rubyid_pids'>pids</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_pid'>pid</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_pids'>pids</span>.<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_to_i'>to_i</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="hot_restart_does_not_drop_connections-instance_method">
  <h3 class='signature '>
    #<strong>hot_restart_does_not_drop_connections</strong>(num_threads: 1, total_requests: 500)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L283-L436'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='283' data-end='436'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 283</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_hot_restart_does_not_drop_connections'>hot_restart_does_not_drop_connections</span>(<span class='label'>num_threads:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>total_requests:</span> <span class='int'>500</span>)
  <span class='id identifier rubyid_skipped'>skipped</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_skip_if'>skip_if</span> <span class='symbeg'>:</span><span class='id identifier rubyid_jruby'>jruby</span><span class='comma'>,</span> <span class='label'>suffix:</span> <span class='heredoc_beg'>&lt;&lt;~MSG</span>
<span class='ignored_sp'>    </span><span class='tstring_content'>- file descriptors are not preserved on exec on JRuby; connection reset errors are expected during restarts
</span><span class='heredoc_end'>  MSG
</span>  <span class='id identifier rubyid_skip_if'>skip_if</span> <span class='symbeg'>:</span><span class='id identifier rubyid_truffleruby'>truffleruby</span><span class='comma'>,</span> <span class='label'>suffix:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> - Undiagnosed failures on TruffleRuby</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_skipped'>skipped</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='id identifier rubyid_args'>args</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-w</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_workers'>workers</span><span class='embexpr_end'>}</span><span class='tstring_content'> -t 5:5 -q test/rackup/hello_with_delay.ru</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_set_control_type'>set_control_type</span> <span class='symbeg'>:</span><span class='id identifier rubyid_tcp'>tcp</span> <span class='kw'>if</span> <span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_WINDOWS-constant" title="Puma::IS_WINDOWS (constant)">IS_WINDOWS</a></span>
  <span class='id identifier rubyid_server_spawn'><a href="#server_spawn-instance_method" title="TestPuma::ServerSpawn#server_spawn (method)">server_spawn</a></span> <span class='id identifier rubyid_args'>args</span>

  <span class='id identifier rubyid_skipped'>skipped</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_replies'>replies</span> <span class='op'>=</span> <span class='const'>Hash</span>.<span class='id identifier rubyid_new'>new</span> <span class='int'>0</span>
  <span class='id identifier rubyid_refused'>refused</span> <span class='op'>=</span> <span class='id identifier rubyid_thread_run_refused'><a href="#thread_run_refused-instance_method" title="TestPuma::ServerSpawn#thread_run_refused (method)">thread_run_refused</a></span>
  <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>A</span><span class='tstring_end'>&#39;</span></span> <span class='op'>*</span> <span class='int'>16_256</span>  <span class='comment'># 2^14 - 128
</span>  <span class='id identifier rubyid_request'>request</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>POST / HTTP/1.1\r\nContent-Length: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message'>message</span>.<span class='id identifier rubyid_bytesize'>bytesize</span><span class='embexpr_end'>}</span><span class='tstring_content'>\r\n\r\n</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_mutex'>mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_restart_count'>restart_count</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_client_threads'>client_threads</span> <span class='op'>=</span> []

  <span class='id identifier rubyid_num_requests'>num_requests</span> <span class='op'>=</span> (<span class='id identifier rubyid_total_requests'>total_requests</span><span class='op'>/</span><span class='id identifier rubyid_num_threads'>num_threads</span>).<span class='id identifier rubyid_to_i'>to_i</span>

  <span class='id identifier rubyid_request_loop'>request_loop</span> <span class='op'>=</span> <span class='tlambda'>-&gt;</span>() <span class='kw'>do</span>
    <span class='id identifier rubyid_num_requests'>num_requests</span>.<span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_req_num'>req_num</span><span class='op'>|</span>
      <span class='kw'>begin</span>
        <span class='kw'>begin</span>
          <span class='id identifier rubyid_socket'>socket</span> <span class='op'>=</span> <span class='id identifier rubyid_send_http'>send_http</span> <span class='id identifier rubyid_request'>request</span>
        <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
          <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_error'>write_error</span>] <span class='op'>+=</span> <span class='int'>1</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_socket'>socket</span>.<span class='id identifier rubyid_read_body'>read_body</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_body'>body</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello World</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_mutex'>mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> {
            <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_success'>success</span>] <span class='op'>+=</span> <span class='int'>1</span>
            <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_restart'>restart</span>] <span class='op'>+=</span> <span class='int'>1</span> <span class='kw'>if</span> <span class='id identifier rubyid_restart_count'>restart_count</span> <span class='op'>&gt;</span> <span class='int'>0</span>
          }
        <span class='kw'>else</span>
          <span class='id identifier rubyid_mutex'>mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> { <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_unexpected_response'>unexpected_response</span>] <span class='op'>+=</span> <span class='int'>1</span> }
        <span class='kw'>end</span>
      <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ECONNRESET</span><span class='comma'>,</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>EBADF</span><span class='comma'>,</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOTCONN</span><span class='comma'>,</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOTSOCK</span>
        <span class='comment'># connection was accepted but then closed
</span>        <span class='comment'># client would see an empty response
</span>        <span class='comment'># Errno::EBADF Windows may not be able to make a connection
</span>        <span class='id identifier rubyid_mutex'>mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> { <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_reset'>reset</span>] <span class='op'>+=</span> <span class='int'>1</span> }
      <span class='kw'>rescue</span> <span class='op'>*</span><span class='id identifier rubyid_refused'>refused</span><span class='comma'>,</span> <span class='const'><a href="../IOError.html" title="IOError (class)">IOError</a></span>
        <span class='comment'># IOError intermittently thrown by Ubuntu, add to allow retry
</span>        <span class='id identifier rubyid_mutex'>mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> { <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_refused'>refused</span>] <span class='op'>+=</span> <span class='int'>1</span> }
      <span class='kw'>rescue</span> <span class='op'>::</span><span class='const'>Timeout</span><span class='op'>::</span><span class='const'>Error</span>
        <span class='id identifier rubyid_mutex'>mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> { <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_read_timeout'>read_timeout</span>] <span class='op'>+=</span> <span class='int'>1</span> }
      <span class='kw'>ensure</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_socket'>socket</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../IO.html" title="IO (class)">IO</a></span>) <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_socket'>socket</span>.<span class='id identifier rubyid_closed?'>closed?</span>
          <span class='kw'>begin</span>
            <span class='id identifier rubyid_socket'>socket</span>.<span class='id identifier rubyid_close'>close</span>
          <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>EBADF</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_run'>run</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_restart_thread'>restart_thread</span> <span class='op'>=</span> <span class='const'>Thread</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_sleep'>sleep</span> <span class='float'>0.05</span>  <span class='comment'># let some connections in before 1st restart
</span>    <span class='kw'>while</span> <span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
      <span class='kw'>begin</span>
        <span class='kw'>if</span> <span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_WINDOWS-constant" title="Puma::IS_WINDOWS (constant)">IS_WINDOWS</a></span>
          <span class='id identifier rubyid_cli_pumactl'><a href="#cli_pumactl-instance_method" title="TestPuma::ServerSpawn#cli_pumactl (method)">cli_pumactl</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>restart</span><span class='tstring_end'>&#39;</span></span>
        <span class='kw'>else</span>
          <span class='const'>Process</span>.<span class='id identifier rubyid_kill'>kill</span> <span class='symbeg'>:</span><span class='const'>USR2</span><span class='comma'>,</span> <span class='ivar'>@pid</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_wait_for_server_to_include'><a href="#wait_for_server_to_include-instance_method" title="TestPuma::ServerSpawn#wait_for_server_to_include (method)">wait_for_server_to_include</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Ctrl-C</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_restart_count'>restart_count</span> <span class='op'>+=</span> <span class='int'>1</span>
        <span class='id identifier rubyid_sleep'>sleep</span>(<span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_WINDOWS-constant" title="Puma::IS_WINDOWS (constant)">IS_WINDOWS</a></span> <span class='op'>?</span> <span class='float'>1.0</span> <span class='op'>:</span> <span class='float'>0.2</span>)
      <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>EBADF</span><span class='comma'>,</span> <span class='const'>Timeout</span><span class='op'>::</span><span class='const'>Error</span>
        <span class='kw'>break</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_num_threads'>num_threads</span> <span class='op'>&gt;</span> <span class='int'>1</span>
    <span class='id identifier rubyid_num_threads'>num_threads</span>.<span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_thread'>thread</span><span class='op'>|</span>
      <span class='id identifier rubyid_client_threads'>client_threads</span> <span class='op'>&lt;&lt;</span> <span class='const'>Thread</span>.<span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
        <span class='kw'>begin</span>
          <span class='id identifier rubyid_request_loop'>request_loop</span>.<span class='id identifier rubyid_call'>call</span>
        <span class='kw'>rescue</span> <span class='const'><a href="../StandardError.html" title="StandardError (class)">StandardError</a></span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_client_threads'>client_threads</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_th'>th</span><span class='op'>|</span>
      <span class='kw'>begin</span>
        <span class='id identifier rubyid_th'>th</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span>
      <span class='kw'>rescue</span> <span class='const'><a href="../StandardError.html" title="StandardError (class)">StandardError</a></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_request_loop'>request_loop</span>.<span class='id identifier rubyid_call'>call</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_run'>run</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_restart_thread'>restart_thread</span>.<span class='id identifier rubyid_join'>join</span>
  <span class='kw'>if</span> <span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_WINDOWS-constant" title="Puma::IS_WINDOWS (constant)">IS_WINDOWS</a></span>
    <span class='id identifier rubyid_cli_pumactl'><a href="#cli_pumactl-instance_method" title="TestPuma::ServerSpawn#cli_pumactl (method)">cli_pumactl</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>stop</span><span class='tstring_end'>&#39;</span></span>
    <span class='const'>Process</span>.<span class='id identifier rubyid_wait'>wait</span> <span class='ivar'>@spawn_pid</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_stop_server'><a href="#stop_server-instance_method" title="TestPuma::ServerSpawn#stop_server (method)">stop_server</a></span>
  <span class='kw'>end</span>
  <span class='ivar'>@server</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> (<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>   %4d write error\n</span><span class='tstring_end'>&quot;</span></span>           <span class='op'>%</span> <span class='id identifier rubyid_replies'>replies</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_write_error'>write_error</span><span class='comma'>,</span><span class='int'>0</span>)).<span class='id identifier rubyid_dup'>dup</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>   %4d unexpected_response\n</span><span class='tstring_end'>&quot;</span></span>   <span class='op'>%</span> <span class='id identifier rubyid_replies'>replies</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_unexpected_response'>unexpected_response</span><span class='comma'>,</span><span class='int'>0</span>)
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>   %4d refused\n</span><span class='tstring_end'>&quot;</span></span>               <span class='op'>%</span> <span class='id identifier rubyid_replies'>replies</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_refused'>refused</span><span class='comma'>,</span><span class='int'>0</span>)
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>   %4d read timeout\n</span><span class='tstring_end'>&quot;</span></span>          <span class='op'>%</span> <span class='id identifier rubyid_replies'>replies</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_read_timeout'>read_timeout</span><span class='comma'>,</span><span class='int'>0</span>)
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>   %4d reset\n</span><span class='tstring_end'>&quot;</span></span>                 <span class='op'>%</span> <span class='id identifier rubyid_replies'>replies</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_reset'>reset</span><span class='comma'>,</span><span class='int'>0</span>)
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>   %4d success\n</span><span class='tstring_end'>&quot;</span></span>               <span class='op'>%</span> <span class='id identifier rubyid_replies'>replies</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_success'>success</span><span class='comma'>,</span><span class='int'>0</span>)
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>   %4d success after restart\n</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_replies'>replies</span>.<span class='id identifier rubyid_fetch'>fetch</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_restart'>restart</span><span class='comma'>,</span><span class='int'>0</span>)
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>   %4d restart count\n</span><span class='tstring_end'>&quot;</span></span>         <span class='op'>%</span> <span class='id identifier rubyid_restart_count'>restart_count</span>

  <span class='id identifier rubyid_refused'>refused</span> <span class='op'>=</span> <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_refused'>refused</span>]
  <span class='id identifier rubyid_reset'>reset</span>   <span class='op'>=</span> <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_reset'>reset</span>]

  <span class='comment'># assert_operator - 1st parameter is logged as expected
</span>
  <span class='kw'>if</span> <span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="../Puma.html#IS_WINDOWS-constant" title="Puma::IS_WINDOWS (constant)">IS_WINDOWS</a></span>
    <span class='comment'># 5 is default thread count in Puma?
</span>    <span class='id identifier rubyid_max_reset'>max_reset</span> <span class='op'>=</span> <span class='id identifier rubyid_num_threads'>num_threads</span> <span class='op'>*</span> <span class='id identifier rubyid_restart_count'>restart_count</span>
    <span class='id identifier rubyid_assert_operator'>assert_operator</span> <span class='id identifier rubyid_max_reset'>max_reset</span><span class='comma'>,</span>     <span class='symbeg'>:</span><span class='op'>&gt;=</span><span class='comma'>,</span> <span class='id identifier rubyid_reset'>reset</span>  <span class='comma'>,</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_content'>Expected no more than </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_reset'>max_reset</span><span class='embexpr_end'>}</span><span class='tstring_content'> reset connections</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_assert_operator'>assert_operator</span>        <span class='int'>50</span><span class='comma'>,</span>     <span class='symbeg'>:</span><span class='op'>&gt;=</span><span class='comma'>,</span> <span class='id identifier rubyid_refused'>refused</span><span class='comma'>,</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_content'>Expected no more than 40 refused connections</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_max_refused'>max_refused</span> <span class='op'>=</span> [<span class='float'>0.001</span> <span class='op'>*</span> <span class='id identifier rubyid_num_threads'>num_threads</span> <span class='op'>*</span> <span class='id identifier rubyid_num_requests'>num_requests</span><span class='comma'>,</span> <span class='int'>1</span>].<span class='id identifier rubyid_max'>max</span>.<span class='id identifier rubyid_round'>round</span>.<span class='id identifier rubyid_to_i'>to_i</span>
    <span class='id identifier rubyid_assert_operator'>assert_operator</span> <span class='id identifier rubyid_restart_count'>restart_count</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='op'>&gt;=</span><span class='comma'>,</span> <span class='id identifier rubyid_reset'>reset</span>  <span class='comma'>,</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_content'>Expected no more that </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_restart_count'>restart_count</span><span class='embexpr_end'>}</span><span class='tstring_content'> reset connections</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_assert_operator'>assert_operator</span> <span class='id identifier rubyid_max_refused'>max_refused</span>  <span class='comma'>,</span> <span class='symbeg'>:</span><span class='op'>&gt;=</span><span class='comma'>,</span> <span class='id identifier rubyid_refused'>refused</span><span class='comma'>,</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_content'>Expected no more than </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_refused'>max_refused</span><span class='embexpr_end'>}</span><span class='tstring_content'> refused connections</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_assert_equal'>assert_equal</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_unexpected_response'>unexpected_response</span>]<span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_content'>Unexpected response</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_assert_equal'>assert_equal</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_read_timeout'>read_timeout</span>]       <span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_content'>Expected no read timeouts</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_expected'>expected</span> <span class='op'>=</span> <span class='float'>0.7</span> <span class='op'>*</span> (<span class='id identifier rubyid_num_threads'>num_threads</span> <span class='op'>*</span> <span class='id identifier rubyid_num_requests'>num_requests</span> <span class='op'>-</span> <span class='id identifier rubyid_reset'>reset</span> <span class='op'>-</span> <span class='id identifier rubyid_refused'>refused</span>)

  <span class='id identifier rubyid_assert_operator'>assert_operator</span> <span class='id identifier rubyid_expected'>expected</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='op'>&lt;=</span><span class='comma'>,</span> <span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_restart'>restart</span>]<span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_content'>Expected more than </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_expected'>expected</span><span class='embexpr_end'>}</span><span class='tstring_content'> connections after restart</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>ensure</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_skipped'>skipped</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_passed?'>passed?</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_restart_count'>restart_count</span><span class='embexpr_end'>}</span><span class='tstring_content'> restarts, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_reset'>reset</span><span class='embexpr_end'>}</span><span class='tstring_content'> resets, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_refused'>refused</span><span class='embexpr_end'>}</span><span class='tstring_content'> refused,</span><span class='tstring_end'>&quot;</span></span> \
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_write_error'>write_error</span>]<span class='embexpr_end'>}</span><span class='tstring_content'> write error, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_restart'>restart</span>]<span class='embexpr_end'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_replies'>replies</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_success'>success</span>]<span class='embexpr_end'>}</span><span class='tstring_content'> success restart/total</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'><a href="../TestPuma.html" title="TestPuma (module)">TestPuma</a></span><span class='op'>::</span><span class='const'><a href="../TestPuma.html#DEBUGGING_INFO-constant" title="TestPuma::DEBUGGING_INFO (constant)">DEBUGGING_INFO</a></span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_client_threads'>client_threads</span>.<span class='id identifier rubyid_each'>each</span> { <span class='op'>|</span><span class='id identifier rubyid_thr'>thr</span><span class='op'>|</span> <span class='id identifier rubyid_thr'>thr</span>.<span class='id identifier rubyid_kill'>kill</span> <span class='kw'>if</span> <span class='id identifier rubyid_thr'>thr</span>.<span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Thread</span> }
      <span class='const'><a href="../TestPuma.html" title="TestPuma (module)">TestPuma</a></span><span class='op'>::</span><span class='const'><a href="../TestPuma.html#DEBUGGING_INFO-constant" title="TestPuma::DEBUGGING_INFO (constant)">DEBUGGING_INFO</a></span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="restart_server-instance_method">
  <h3 class='signature '>
    #<strong>restart_server</strong>(socket, log: false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>reuses an existing connection to make sure that works</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L151-L155'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='151' data-end='155'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 151</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_restart_server'>restart_server</span>(<span class='id identifier rubyid_socket'>socket</span><span class='comma'>,</span> <span class='label'>log:</span> <span class='kw'>false</span>)
  <span class='const'>Process</span>.<span class='id identifier rubyid_kill'>kill</span> <span class='symbeg'>:</span><span class='const'>USR2</span><span class='comma'>,</span> <span class='ivar'>@pid</span>
  <span class='id identifier rubyid_socket'>socket</span> <span class='op'>&lt;&lt;</span> <span class='const'><a href="PumaSocket.html#GET_11-constant" title="TestPuma::PumaSocket::GET_11 (constant)">GET_11</a></span>
  <span class='id identifier rubyid_wait_for_server_to_include'><a href="#wait_for_server_to_include-instance_method" title="TestPuma::ServerSpawn#wait_for_server_to_include (method)">wait_for_server_to_include</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Ctrl-C</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>log:</span> <span class='id identifier rubyid_log'>log</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="restart_server_and_listen-instance_method">
  <h3 class='signature '>
    #<strong>restart_server_and_listen</strong>(argv, log: false)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L136-L148'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='136' data-end='148'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 136</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_restart_server_and_listen'>restart_server_and_listen</span>(<span class='id identifier rubyid_argv'>argv</span><span class='comma'>,</span> <span class='label'>log:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_server_spawn'><a href="#server_spawn-instance_method" title="TestPuma::ServerSpawn#server_spawn (method)">server_spawn</a></span> <span class='id identifier rubyid_argv'>argv</span>
  <span class='id identifier rubyid_socket'>socket</span> <span class='op'>=</span> <span class='id identifier rubyid_send_http'>send_http</span>
  <span class='id identifier rubyid_initial_reply'>initial_reply</span> <span class='op'>=</span> <span class='id identifier rubyid_socket'>socket</span>.<span class='id identifier rubyid_read_body'>read_body</span>
  <span class='id identifier rubyid_restart_server'><a href="#restart_server-instance_method" title="TestPuma::ServerSpawn#restart_server (method)">restart_server</a></span> <span class='id identifier rubyid_socket'>socket</span><span class='comma'>,</span> <span class='label'>log:</span> <span class='id identifier rubyid_log'>log</span>
  <span class='comment'># Ruby 2.6 and later all read the below socket,
</span>  <span class='comment'># Ruby 2.5 intermittently throws Errno::ECONNRESET or EOFError
</span>  <span class='id identifier rubyid_socket'>socket</span>.<span class='id identifier rubyid_read_body'>read_body</span> <span class='kw'>unless</span> <span class='const'>RUBY_VERSION</span> <span class='op'>&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>2.6</span><span class='tstring_end'>&#39;</span></span>

  <span class='comment'># above socket may be answered by original server
</span>  <span class='comment'># below socket answered by restarted server
</span>  [<span class='id identifier rubyid_initial_reply'>initial_reply</span><span class='comma'>,</span> <span class='id identifier rubyid_send_http_read_resp_body'>send_http_read_resp_body</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="server_gets-instance_method">
  <h3 class='signature '>
    #<strong>server_gets</strong>(match_obj, time_timeout, log: false)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L178-L206'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='178' data-end='206'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 178</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_server_gets'>server_gets</span>(<span class='id identifier rubyid_match_obj'>match_obj</span><span class='comma'>,</span> <span class='id identifier rubyid_time_timeout'>time_timeout</span><span class='comma'>,</span> <span class='label'>log:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_error_retries'>error_retries</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_line'>line</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_sleep'>sleep</span> <span class='float'>0.05</span> <span class='kw'>unless</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_is_a?'>is_a?</span>(<span class='const'><a href="../IO.html" title="IO (class)">IO</a></span>) <span class='kw'>or</span> <span class='const'>Process</span>.<span class='id identifier rubyid_clock_gettime'>clock_gettime</span>(<span class='const'>Process</span><span class='op'>::</span><span class='const'>CLOCK_MONOTONIC</span>) <span class='op'>&gt;</span> <span class='id identifier rubyid_time_timeout'>time_timeout</span>

  <span class='kw'>unless</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><a href="../IO.html" title="IO (class)">IO</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>RuntimeError</span><span class='comma'>,</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@server is not an IO</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='const'>Process</span>.<span class='id identifier rubyid_clock_gettime'>clock_gettime</span>(<span class='const'>Process</span><span class='op'>::</span><span class='const'>CLOCK_MONOTONIC</span>) <span class='op'>&gt;</span> <span class='id identifier rubyid_time_timeout'>time_timeout</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Timeout</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Timeout waiting for server to log </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_match_obj'>match_obj</span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='kw'>if</span> <span class='ivar'>@server</span>.<span class='id identifier rubyid_wait_readable'>wait_readable</span>(<span class='const'><a href="#LOG_WAIT_READ-constant" title="TestPuma::ServerSpawn::LOG_WAIT_READ (constant)">LOG_WAIT_READ</a></span>) <span class='kw'>and</span> <span class='id identifier rubyid_line'>line</span> <span class='op'>=</span> <span class='ivar'>@server</span><span class='op'>&amp;.</span><span class='id identifier rubyid_gets'>gets</span>
      <span class='ivar'>@server_log</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_line'>line</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_line'>line</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_log'>log</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'><a href="../StandardError.html" title="StandardError (class)">StandardError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_error_retries'>error_retries</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='id identifier rubyid_raise'>raise</span>(<span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Waiting for server to log </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_match_obj'>match_obj</span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>) <span class='kw'>if</span> <span class='id identifier rubyid_error_retries'>error_retries</span> <span class='op'>==</span> <span class='const'><a href="#LOG_ERROR_QTY-constant" title="TestPuma::ServerSpawn::LOG_ERROR_QTY (constant)">LOG_ERROR_QTY</a></span>
    <span class='id identifier rubyid_sleep'>sleep</span> <span class='const'><a href="#LOG_ERROR_SLEEP-constant" title="TestPuma::ServerSpawn::LOG_ERROR_SLEEP (constant)">LOG_ERROR_SLEEP</a></span>
    <span class='kw'>retry</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='const'>Process</span>.<span class='id identifier rubyid_clock_gettime'>clock_gettime</span>(<span class='const'>Process</span><span class='op'>::</span><span class='const'>CLOCK_MONOTONIC</span>) <span class='op'>&gt;</span> <span class='id identifier rubyid_time_timeout'>time_timeout</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Timeout</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Timeout waiting for server to log </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_match_obj'>match_obj</span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_line'>line</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="server_spawn-instance_method">
  <h3 class='signature '>
    #<strong>server_spawn</strong>(argv = nil, config: nil, no_bind: nil, log: nil, no_wait: false, puma_debug: nil, env: {})  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L63-L109'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='109'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_server_spawn'>server_spawn</span>(<span class='id identifier rubyid_argv'>argv</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='comment'># rubocop:disable Metrics/ParameterLists
</span>    <span class='label'>config:</span> <span class='kw'>nil</span><span class='comma'>,</span>       <span class='comment'># string to use for config file
</span>    <span class='label'>no_bind:</span> <span class='kw'>nil</span><span class='comma'>,</span>      <span class='comment'># if true, binds are defined config file
</span>    <span class='label'>log:</span> <span class='kw'>nil</span><span class='comma'>,</span>          <span class='comment'># output server log to console (for debugging)
</span>    <span class='label'>no_wait:</span> <span class='kw'>false</span><span class='comma'>,</span>    <span class='comment'># don&#39;t wait for server to boot
</span>    <span class='label'>puma_debug:</span> <span class='kw'>nil</span><span class='comma'>,</span>   <span class='comment'># set env[&#39;PUMA_DEBUG&#39;] = &#39;true&#39;
</span>    <span class='label'>env:</span> {})           <span class='comment'># pass env setting to spawned Puma process
</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_config'>config</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_no_bind'>no_bind</span>
      <span class='id identifier rubyid_config_contents'>config_contents</span> <span class='op'>=</span> <span class='ivar'>@bind_type</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_ssl'>ssl</span> <span class='op'>?</span> <span class='id identifier rubyid_config'>config</span> <span class='op'>:</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bind &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bind_uri_str'>bind_uri_str</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;\n</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_config'>config</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>if</span> <span class='ivar'>@control_type</span>
        <span class='id identifier rubyid_config_contents'>config_contents</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_control_config_str'>control_config_str</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_config_contents'>config_contents</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_config_args'>config_args</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-C </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_config_path'>config_path</span> <span class='id identifier rubyid_config_contents'>config_contents</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_config_args'>config_args</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-C </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_config_path'>config_path</span> <span class='id identifier rubyid_config'>config</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_config_args'>config_args</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_puma_path'>puma_path</span> <span class='op'>=</span> <span class='const'>File</span>.<span class='id identifier rubyid_expand_path'>expand_path</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>../../../bin/puma</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid___dir__'>__dir__</span>

  <span class='id identifier rubyid_cmd'>cmd</span> <span class='op'>=</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_no_bind'>no_bind</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#BASE-constant" title="TestPuma::ServerSpawn::BASE (constant)">BASE</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_puma_path'>puma_path</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_config_args'>config_args</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_argv'>argv</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>elsif</span> <span class='ivar'>@control_type</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#BASE-constant" title="TestPuma::ServerSpawn::BASE (constant)">BASE</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_puma_path'>puma_path</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_config_args'>config_args</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_set_pumactl_args'>set_pumactl_args</span><span class='embexpr_end'>}</span><span class='tstring_content'> -b &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bind_uri_str'>bind_uri_str</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_argv'>argv</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><a href="#BASE-constant" title="TestPuma::ServerSpawn::BASE (constant)">BASE</a></span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_puma_path'>puma_path</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_config_args'>config_args</span><span class='embexpr_end'>}</span><span class='tstring_content'> -b &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bind_uri_str'>bind_uri_str</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_argv'>argv</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

  <span class='id identifier rubyid_env'>env</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PUMA_DEBUG</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>true</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_puma_debug'>puma_debug</span>
  <span class='id identifier rubyid_env'>env</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RUBYOPT</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='const'><a href="#DFLT_RUBYOPT-constant" title="TestPuma::ServerSpawn::DFLT_RUBYOPT (constant)">DFLT_RUBYOPT</a></span> <span class='kw'>unless</span> <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RUBYOPT</span><span class='tstring_end'>&#39;</span></span>]

  <span class='const'>STDOUT</span>.<span class='id identifier rubyid_syswrite'>syswrite</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n——— </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cmd'>cmd</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_log'>log</span>

  <span class='ivar'>@server</span><span class='comma'>,</span> <span class='ivar'>@server_err</span><span class='comma'>,</span> <span class='ivar'>@spawn_pid</span> <span class='op'>=</span> <span class='id identifier rubyid_spawn_cmd'><a href="#spawn_cmd-instance_method" title="TestPuma::ServerSpawn#spawn_cmd (method)">spawn_cmd</a></span> <span class='id identifier rubyid_env'>env</span><span class='comma'>,</span> <span class='id identifier rubyid_cmd'>cmd</span>.<span class='id identifier rubyid_strip'>strip</span>

  <span class='id identifier rubyid_wait_for_server_to_include'><a href="#wait_for_server_to_include-instance_method" title="TestPuma::ServerSpawn#wait_for_server_to_include (method)">wait_for_server_to_include</a></span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Ctrl-C</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>log:</span> <span class='id identifier rubyid_log'>log</span>) <span class='kw'>unless</span> <span class='id identifier rubyid_no_wait'>no_wait</span>
  <span class='ivar'>@pid</span> <span class='op'>=</span> <span class='ivar'>@server_log</span>[<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(?:Master|      ) PID: (\d+)$</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='int'>1</span>]<span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>||</span> <span class='ivar'>@spawn_pid</span>
  <span class='const'><a href="../TestPuma.html" title="TestPuma (module)">TestPuma</a></span><span class='op'>::</span><span class='const'><a href="../TestPuma.html#DEBUGGING_PIDS-constant" title="TestPuma::DEBUGGING_PIDS (constant)">DEBUGGING_PIDS</a></span>[<span class='ivar'>@pid</span>] <span class='op'>=</span> <span class='id identifier rubyid_full_name'>full_name</span>
  <span class='const'><a href="../TestPuma.html" title="TestPuma (module)">TestPuma</a></span><span class='op'>::</span><span class='const'><a href="../TestPuma.html#DEBUGGING_PIDS-constant" title="TestPuma::DEBUGGING_PIDS (constant)">DEBUGGING_PIDS</a></span>[<span class='ivar'>@spawn_pid</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>spawn </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@spawn_pid</span> <span class='op'>!=</span> <span class='ivar'>@pid</span>
  <span class='ivar'>@server</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="silent_and_checked_system_command-instance_method">
  <h3 class='signature '>
    #<strong>silent_and_checked_system_command</strong>(*args)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L132-L134'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='132' data-end='134'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 132</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_silent_and_checked_system_command'>silent_and_checked_system_command</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='id identifier rubyid_assert'>assert</span>(<span class='id identifier rubyid_system'>system</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='label'>out:</span> <span class='const'>File</span><span class='op'>::</span><span class='const'>NULL</span><span class='comma'>,</span> <span class='label'>err:</span> <span class='const'>File</span><span class='op'>::</span><span class='const'>NULL</span>))
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="spawn_cmd-instance_method">
  <h3 class='signature '>
    #<strong>spawn_cmd</strong>(env = {}, cmd)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L268-L281'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='268' data-end='281'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 268</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_spawn_cmd'>spawn_cmd</span>(<span class='id identifier rubyid_env'>env</span> <span class='op'>=</span> {}<span class='comma'>,</span> <span class='id identifier rubyid_cmd'>cmd</span>)
  <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> {}

  <span class='id identifier rubyid_out_r'>out_r</span><span class='comma'>,</span> <span class='id identifier rubyid_out_w'>out_w</span> <span class='op'>=</span> <span class='const'><a href="../IO.html" title="IO (class)">IO</a></span>.<span class='id identifier rubyid_pipe'>pipe</span>
  <span class='id identifier rubyid_opts'>opts</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_out'>out</span>] <span class='op'>=</span> <span class='id identifier rubyid_out_w'>out_w</span>

  <span class='id identifier rubyid_err_r'>err_r</span><span class='comma'>,</span> <span class='id identifier rubyid_err_w'>err_w</span> <span class='op'>=</span> <span class='const'><a href="../IO.html" title="IO (class)">IO</a></span>.<span class='id identifier rubyid_pipe'>pipe</span>
  <span class='id identifier rubyid_opts'>opts</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_err'>err</span>] <span class='op'>=</span> <span class='id identifier rubyid_err_w'>err_w</span>

  <span class='id identifier rubyid_pid'>pid</span> <span class='op'>=</span> <span class='id identifier rubyid_spawn'>spawn</span>(<span class='id identifier rubyid_env'>env</span><span class='comma'>,</span> <span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span>)
  [<span class='id identifier rubyid_out_w'>out_w</span><span class='comma'>,</span> <span class='id identifier rubyid_err_w'>err_w</span>].<span class='id identifier rubyid_each'>each</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_close'>close</span>)
  <span class='ivar'>@ios_to_close</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_out_r'>out_r</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_err_r'>err_r</span>
  [<span class='id identifier rubyid_out_r'>out_r</span><span class='comma'>,</span> <span class='id identifier rubyid_err_r'>err_r</span><span class='comma'>,</span> <span class='id identifier rubyid_pid'>pid</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="stop_server-instance_method">
  <h3 class='signature '>
    #<strong>stop_server</strong>(pid = @pid, signal: :TERM, nohang: false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>rescue statements are just in case method is called with a server that is already stopped/killed, especially since <code>Process.wait2</code> is blocking</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L114-L130'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='114' data-end='130'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 114</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_stop_server'>stop_server</span>(<span class='id identifier rubyid_pid'>pid</span> <span class='op'>=</span> <span class='ivar'>@pid</span><span class='comma'>,</span> <span class='label'>signal:</span> <span class='symbeg'>:</span><span class='const'>TERM</span><span class='comma'>,</span> <span class='label'>nohang:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_ary'>ary</span> <span class='op'>=</span> <span class='id identifier rubyid_kill_and_wait'><a href="../TestPuma.html#kill_and_wait-class_method" title="TestPuma.kill_and_wait (method)">kill_and_wait</a></span> <span class='id identifier rubyid_pid'>pid</span><span class='comma'>,</span> <span class='label'>nohang:</span> <span class='id identifier rubyid_nohang'>nohang</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_pid'>pid</span> <span class='op'>==</span> <span class='ivar'>@pid</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@spawn_pid</span> <span class='op'>!=</span> <span class='ivar'>@pid</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_ary'>ary</span>.<span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_ary'>ary</span> <span class='op'>=</span> <span class='id identifier rubyid_nohang'>nohang</span> <span class='op'>?</span> <span class='const'>Process</span>.<span class='id identifier rubyid_wait2'>wait2</span>(<span class='ivar'>@spawn_pid</span><span class='comma'>,</span> <span class='const'>Process</span><span class='op'>::</span><span class='const'>WNOHANG</span>) <span class='op'>:</span>
        <span class='const'>Process</span>.<span class='id identifier rubyid_wait2'>wait2</span>(<span class='ivar'>@spawn_pid</span>)
    <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ECHILD</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_pid'>pid</span> <span class='op'>==</span> <span class='ivar'>@pid</span>
    <span class='ivar'>@server</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@spawn_pid</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='ivar'>@spawn_pid</span> <span class='op'>==</span> <span class='ivar'>@pid</span>
    <span class='ivar'>@pid</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_ary'>ary</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="thread_run_refused-instance_method">
  <h3 class='signature '>
    #<strong>thread_run_refused</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>used to define correct ‘refused’ errors</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L221-L223'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='221' data-end='223'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 221</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_thread_run_refused'>thread_run_refused</span>
  <span class='const'><a href="../TestPuma.html#DARWIN-constant" title="TestPuma::DARWIN (constant)">DARWIN</a></span> <span class='op'>?</span> [<span class='const'>EOFError</span><span class='comma'>,</span> <span class='const'><a href="../IOError.html" title="IOError (class)">IOError</a></span><span class='comma'>,</span> <span class='const'>SystemCallError</span>] <span class='op'>:</span> [<span class='const'><a href="../IOError.html" title="IOError (class)">IOError</a></span><span class='comma'>,</span> <span class='const'>SystemCallError</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="wait_for_server_to_include-instance_method">
  <h3 class='signature '>
    #<strong>wait_for_server_to_include</strong>(str, timeout: LOG_TIMEOUT, log: false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns true if and when server log includes str.  Will timeout otherwise.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L158-L165'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='158' data-end='165'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 158</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_for_server_to_include'>wait_for_server_to_include</span>(<span class='id identifier rubyid_str'>str</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='const'><a href="#LOG_TIMEOUT-constant" title="TestPuma::ServerSpawn::LOG_TIMEOUT (constant)">LOG_TIMEOUT</a></span><span class='comma'>,</span> <span class='label'>log:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_time_timeout'>time_timeout</span> <span class='op'>=</span> <span class='const'>Process</span>.<span class='id identifier rubyid_clock_gettime'>clock_gettime</span>(<span class='const'>Process</span><span class='op'>::</span><span class='const'>CLOCK_MONOTONIC</span>) <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span>
  <span class='id identifier rubyid_line'>line</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n——— </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_content'> waiting for &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_str'>str</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_log'>log</span>
  <span class='id identifier rubyid_line'>line</span> <span class='op'>=</span> <span class='id identifier rubyid_server_gets'><a href="#server_gets-instance_method" title="TestPuma::ServerSpawn#server_gets (method)">server_gets</a></span>(<span class='id identifier rubyid_str'>str</span><span class='comma'>,</span> <span class='id identifier rubyid_time_timeout'>time_timeout</span><span class='comma'>,</span> <span class='label'>log:</span> <span class='id identifier rubyid_log'>log</span>) <span class='kw'>until</span> <span class='id identifier rubyid_line'>line</span><span class='op'>&amp;.</span><span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_str'>str</span>)
  <span class='kw'>true</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="wait_for_server_to_match-instance_method">
  <h3 class='signature '>
    #<strong>wait_for_server_to_match</strong>(re, idx = nil, timeout: LOG_TIMEOUT, log: false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Returns line if and when server log matches re, unless idx is specified, then returns regex match.  Will timeout otherwise.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/test/helpers/test_puma/server_spawn.rb#L169-L176'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='169' data-end='176'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'test/helpers/test_puma/server_spawn.rb', line 169</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_for_server_to_match'>wait_for_server_to_match</span>(<span class='id identifier rubyid_re'>re</span><span class='comma'>,</span> <span class='id identifier rubyid_idx'>idx</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='const'><a href="#LOG_TIMEOUT-constant" title="TestPuma::ServerSpawn::LOG_TIMEOUT (constant)">LOG_TIMEOUT</a></span><span class='comma'>,</span> <span class='label'>log:</span> <span class='kw'>false</span>)
  <span class='id identifier rubyid_time_timeout'>time_timeout</span> <span class='op'>=</span> <span class='const'>Process</span>.<span class='id identifier rubyid_clock_gettime'>clock_gettime</span>(<span class='const'>Process</span><span class='op'>::</span><span class='const'>CLOCK_MONOTONIC</span>) <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span>
  <span class='id identifier rubyid_line'>line</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n——— </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_content'> waiting for &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_re'>re</span>.<span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_log'>log</span>
  <span class='id identifier rubyid_line'>line</span> <span class='op'>=</span> <span class='id identifier rubyid_server_gets'><a href="#server_gets-instance_method" title="TestPuma::ServerSpawn#server_gets (method)">server_gets</a></span>(<span class='id identifier rubyid_re'>re</span><span class='comma'>,</span> <span class='id identifier rubyid_time_timeout'>time_timeout</span><span class='comma'>,</span> <span class='label'>log:</span> <span class='id identifier rubyid_log'>log</span>) <span class='kw'>until</span> <span class='id identifier rubyid_line'>line</span><span class='op'>&amp;.</span><span class='id identifier rubyid_match?'>match?</span>(<span class='id identifier rubyid_re'>re</span>)
  <span class='id identifier rubyid_idx'>idx</span> <span class='op'>?</span> <span class='id identifier rubyid_line'>line</span>[<span class='id identifier rubyid_re'>re</span><span class='comma'>,</span> <span class='id identifier rubyid_idx'>idx</span>] <span class='op'>:</span> <span class='id identifier rubyid_line'>line</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>