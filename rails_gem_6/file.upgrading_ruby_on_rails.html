<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Upgrading Ruby On Rails &mdash; Rails 6.1.7.10</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "upgrading_ruby_on_rails",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 6.1.7.10</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Upgrading Ruby On Rails&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1>Upgrading Ruby on <a href="Rails.html" title="Rails (module)"><code>Rails</code></a></h1>

<p>This guide provides steps to be followed when you upgrade your applications to a newer version of Ruby on <a href="Rails.html" title="Rails (module)"><code>Rails</code></a>. These steps are also available in individual release guides.</p>

<hr>

<h2>General Advice</h2>

<p>Before attempting to upgrade an existing application, you should be sure you have a good reason to upgrade. You need to balance several factors: the need for new features, the increasing difficulty of finding support for old code, and your available time and skills, to name a few.</p>

<h3>Test Coverage</h3>

<p>The best way to be sure that your application still works after upgrading is to have good test coverage before you start the process. If you don&#39;t have automated tests that exercise the bulk of your application, you&#39;ll need to spend time manually exercising all the parts that have changed. In the case of a <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> upgrade, that will mean every single piece of functionality in the application. Do yourself a favor and make sure your test coverage is good <em>before</em> you start an upgrade.</p>

<h3>The Upgrade Process</h3>

<p>When changing <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> versions, it&#39;s best to move slowly, one minor version at a time, in order to make good use of the deprecation warnings. <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> version numbers are in the form Major.Minor.Patch. Major and Minor versions are allowed to make changes to the public API, so this may cause errors in your application. Patch versions only include bug fixes, and don&#39;t change any public API.</p>

<p>The process should go as follows:</p>

<ol>
<li>Write tests and make sure they pass.</li>
<li>Move to the latest patch version after your current version.</li>
<li>Fix tests and deprecated features.</li>
<li>Move to the latest patch version of the next minor version.</li>
</ol>

<p>Repeat this process until you reach your target <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> version. Each time you move versions, you will need to change the <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> version number in the <code>Gemfile</code> (and possibly other gem versions) and run <code>bundle update</code>. Then run the Update task mentioned below to update configuration files, then run your tests.</p>

<p>You can find a list of all released <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> versions <a href="https://rubygems.org/gems/rails/versions">here</a>.</p>

<h3>Ruby Versions</h3>

<p><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> generally stays close to the latest released Ruby version when it&#39;s released:</p>

<ul>
<li><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 6 requires Ruby 2.5.0 or newer.</li>
<li><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 5 requires Ruby 2.2.2 or newer.</li>
<li><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 4 prefers Ruby 2.0 and requires 1.9.3 or newer.</li>
<li><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 3.2.x is the last branch to support Ruby 1.8.7.</li>
<li><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 3 and above require Ruby 1.8.7 or higher. Support for all of the previous Ruby versions has been dropped officially. You should upgrade as early as possible.</li>
</ul>

<p>TIP: Ruby 1.8.7 p248 and p249 have marshalling bugs that crash <a href="Rails.html" title="Rails (module)"><code>Rails</code></a>. Ruby Enterprise Edition has these fixed since the release of 1.8.7-2010.02. On the 1.9 front, Ruby 1.9.1 is not usable because it outright segfaults, so if you want to use 1.9.x, jump straight to 1.9.3 for smooth sailing.</p>

<h3>The Update Task</h3>

<p><a href="Rails.html" title="Rails (module)"><code>Rails</code></a> provides the <code>app:update</code> command (<code>rake rails:update</code> on 4.2 and earlier). After updating the <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> version
in the <code>Gemfile</code>, run this command.
This will help you with the creation of new files and changes of old files in an
interactive session.</p>

<pre class="code bash"><code class="bash">$ bin/rails app:update
   identical  config/boot.rb
       exist  config
    conflict  config/routes.rb
Overwrite /myapp/config/routes.rb? (enter &quot;h&quot; for help) [Ynaqdh]
       force  config/routes.rb
    conflict  config/application.rb
Overwrite /myapp/config/application.rb? (enter &quot;h&quot; for help) [Ynaqdh]
       force  config/application.rb
    conflict  config/environment.rb
...
</code></pre>

<p>Don&#39;t forget to review the difference, to see if there were any unexpected changes.</p>

<h3>Configure Framework Defaults</h3>

<p>The new Rails version might have different configuration defaults than the previous version. However, after following the steps described above, your application would still run with configuration defaults from the <em>previous</em> Rails version. That&#39;s because the value for <code>config.load_defaults</code> in <code>config/application.rb</code> has not been changed yet.</p>

<p>To allow you to upgrade to new defaults one by one, the update task has created a file <code>config/initializers/new_framework_defaults.rb</code>. Once your application is ready to run with new defaults, you can remove this file and flip the <code>config.load_defaults</code> value.</p>

<h2>Upgrading from Rails 6.0 to Rails 6.1</h2>

<p>For more information on changes made to Rails 6.1 please see the <a href="6_1_release_notes.html">release notes</a>.</p>

<h3><code>Rails.application.config_for</code> return value no longer supports access with String keys.</h3>

<p>Given a configuration file like this:</p>

<pre class="code yaml"><code class="yaml"># config/example.yml
development:
  options:
    key: value
</code></pre>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config_for'>config_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_example'>example</span>).<span class='id identifier rubyid_options'>options</span></code></pre>

<p>This used to return a hash on which you could access values with String keys. That was deprecated in 6.0, and now doesn&#39;t work anymore.</p>

<p>You can call <code>with_indifferent_access</code> on the return value of <code>config_for</code> if you still want to access values with String keys, e.g.:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config_for'>config_for</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_example'>example</span>).<span class='id identifier rubyid_with_indifferent_access'>with_indifferent_access</span>.<span class='id identifier rubyid_dig'>dig</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>options</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>key</span><span class='tstring_end'>&#39;</span></span>)</code></pre>

<h3>Response&#39;s Content-Type when using <code>respond_to#any</code></h3>

<p>The Content-Type header returned in the response can differ from what Rails 6.0 returned,
more specifically if your application uses <code>respond_to { |format| format.any }</code>.
The Content-Type will now be based on the given block rather than the request&#39;s format.</p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_my_action'>my_action</span>
  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
    <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_any'>any</span> { <span class='id identifier rubyid_render'>render</span>(<span class='label'>json:</span> { <span class='label'>foo:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&#39;</span></span> }) }
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my_action.csv</span><span class='tstring_end'>&#39;</span></span>)</code></pre>

<p>Previous behaviour was returning a <code>text/csv</code> response&#39;s Content-Type which is inaccurate since a JSON response is being rendered.
Current behaviour correctly returns a <code>application/json</code> response&#39;s Content-Type.</p>

<p>If your application relies on the previous incorrect behaviour, you are encouraged to specify
which formats your action accepts, i.e.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_any'>any</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_xml'>xml</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_json'>json</span>) { <span class='id identifier rubyid_render'>render</span> <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_to_sym'>to_sym</span> <span class='op'>=&gt;</span> <span class='ivar'>@people</span> }</code></pre>

<h3>ActiveSupport::Callbacks#halted_callback_hook now receive a second argument</h3>

<p>Active Support allows you to override the <code>halted_callback_hook</code> whenever a callback
halts the chain. This method now receive a second argument which is the name of the callback being halted.
If you have classes that override this method, make sure it accepts two arguments. Note that this is a breaking
change without a prior deprecation cycle (for performance reasons).</p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_before_save'>before_save</span> { <span class='id identifier rubyid_throw'>throw</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_abort'>abort</span>) }
  <span class='id identifier rubyid_before_create'>before_create</span> { <span class='id identifier rubyid_throw'>throw</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_abort'>abort</span>) }

  <span class='kw'>def</span> <span class='id identifier rubyid_halted_callback_hook'>halted_callback_hook</span>(<span class='id identifier rubyid_filter'>filter</span><span class='comma'>,</span> <span class='id identifier rubyid_callback_name'>callback_name</span>) <span class='comment'># =&gt; This method now accepts 2 arguments instead of 1
</span>    <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_info'>info</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Book couldn&#39;t be </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_callback_name'>callback_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>d</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>The <code>helper</code> class method in controllers uses <a href="String.html#constantize-instance_method" title="String#constantize (method)">String#constantize</a></h3>

<p>Conceptually, before Rails 6.1</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_helper'>helper</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>foo/bar</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>resulted in</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require_dependency'>require_dependency</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>foo/bar_helper</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_module_name'>module_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>foo/bar_helper</span><span class='tstring_end'>&quot;</span></span>.<span class='id identifier rubyid_camelize'>camelize</span>
<span class='id identifier rubyid_module_name'>module_name</span>.<span class='id identifier rubyid_constantize'>constantize</span></code></pre>

<p>Now it does this instead:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_prefix'>prefix</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>foo/bar</span><span class='tstring_end'>&quot;</span></span>.<span class='id identifier rubyid_camelize'>camelize</span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_prefix'>prefix</span><span class='embexpr_end'>}</span><span class='tstring_content'>Helper</span><span class='tstring_end'>&quot;</span></span>.<span class='id identifier rubyid_constantize'>constantize</span></code></pre>

<p>This change is backwards compatible for the majority of applications, in which case you do not need to do anything.</p>

<p>Technically, however, controllers could configure <code>helpers_path</code> to point to a directory in <code>$LOAD_PATH</code> that was not in the autoload paths. That use case is no longer supported out of the box. If the helper module is not autoloadable, the application is responsible for loading it before calling <code>helper</code>.</p>

<h3>Redirection to HTTPS from HTTP will now use the 308 HTTP status code</h3>

<p>The default HTTP status code used in <a href="ActionDispatch/SSL.html" title="ActionDispatch::SSL (class)"><code>::ActionDispatch::SSL</code></a> when redirecting non-GET/HEAD requests from HTTP to HTTPS has been changed to <code>308</code> as defined in <a href="https://tools.ietf.org/html/rfc7538">https://tools.ietf.org/html/rfc7538</a>.</p>

<h3>Active Storage now requires Image Processing</h3>

<p>When processing variants in Active Storage, it&#39;s now required to have the <a href="https://github.com/janko/image_processing">image_processing gem</a> bundled instead of directly using <code>mini_magick</code>. Image Processing is configured by default to use <code>mini_magick</code> behind the scenes, so the easiest way to upgrade is by replacing the <code>mini_magick</code> gem for the <code>image_processing</code> gem and making sure to remove the explicit usage of <code>combine_options</code> since it&#39;s no longer needed.</p>

<p>For readability, you may wish to change raw <code>resize</code> calls to <code>image_processing</code> macros. For example, instead of:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_video'>video</span>.<span class='id identifier rubyid_preview'>preview</span>(<span class='label'>resize:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>100x100</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_video'>video</span>.<span class='id identifier rubyid_preview'>preview</span>(<span class='label'>resize:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>100x100&gt;</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_video'>video</span>.<span class='id identifier rubyid_preview'>preview</span>(<span class='label'>resize:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>100x100^</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>you can respectively do:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_video'>video</span>.<span class='id identifier rubyid_preview'>preview</span>(<span class='label'>resize_to_fit:</span> [<span class='int'>100</span><span class='comma'>,</span> <span class='int'>100</span>])
<span class='id identifier rubyid_video'>video</span>.<span class='id identifier rubyid_preview'>preview</span>(<span class='label'>resize_to_limit:</span> [<span class='int'>100</span><span class='comma'>,</span> <span class='int'>100</span>])
<span class='id identifier rubyid_video'>video</span>.<span class='id identifier rubyid_preview'>preview</span>(<span class='label'>resize_to_fill:</span> [<span class='int'>100</span><span class='comma'>,</span> <span class='int'>100</span>])</code></pre>

<h2>Upgrading from Rails 5.2 to Rails 6.0</h2>

<p>For more information on changes made to Rails 6.0 please see the <a href="6_0_release_notes.html">release notes</a>.</p>

<h3>Using Webpacker</h3>

<p><a href="https://github.com/rails/webpacker">Webpacker</a>
is the default JavaScript compiler for Rails 6. But if you are upgrading the app, it is not activated by default.
If you want to use Webpacker, then include it in your Gemfile and install it:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>webpacker</span><span class='tstring_end'>&quot;</span></span></code></pre>

<pre class="code bash"><code class="bash">$ bin/rails webpacker:install
</code></pre>

<h3>Force SSL</h3>

<p>The <code>force_ssl</code> method on controllers has been deprecated and will be removed in
Rails 6.1. You are encouraged to enable <code>config.force_ssl</code> to enforce HTTPS
connections throughout your application. If you need to exempt certain endpoints
from redirection, you can use <code>config.ssl_options</code> to configure that behavior.</p>

<h3>Purpose and expiry metadata is now embedded inside signed and encrypted cookies for increased security</h3>

<p>To improve security, Rails embeds the purpose and expiry metadata inside encrypted or signed cookies value.</p>

<p>Rails can then thwart attacks that attempt to copy the signed/encrypted value
of a cookie and use it as the value of another cookie.</p>

<p>This new embed metadata make those cookies incompatible with versions of Rails older than 6.0.</p>

<p>If you require your cookies to be read by Rails 5.2 and older, or you are still validating your 6.0 deploy and want
to be able to rollback set
<code>Rails.application.config.action_dispatch.use_cookies_with_metadata</code> to <code>false</code>.</p>

<h3>All npm packages have been moved to the <code>@rails</code> scope</h3>

<p>If you were previously loading any of the <code>actioncable</code>, <code>activestorage</code>,
or <code>rails-ujs</code> packages through npm/yarn, you must update the names of these
dependencies before you can upgrade them to <code>6.0.0</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_actioncable'>actioncable</span>   <span class='id identifier rubyid_→'>→</span> <span class='ivar'>@rails</span><span class='op'>/</span><span class='id identifier rubyid_actioncable'>actioncable</span>
<span class='id identifier rubyid_activestorage'>activestorage</span> <span class='id identifier rubyid_→'>→</span> <span class='ivar'>@rails</span><span class='op'>/</span><span class='id identifier rubyid_activestorage'>activestorage</span>
<span class='id identifier rubyid_rails'>rails</span><span class='op'>-</span><span class='id identifier rubyid_ujs'>ujs</span>     <span class='id identifier rubyid_→'>→</span> <span class='ivar'>@rails</span><span class='op'>/</span><span class='id identifier rubyid_ujs'>ujs</span></code></pre>

<h3>Action Cable JavaScript API Changes</h3>

<p>The Action Cable JavaScript package has been converted from CoffeeScript
to ES2015, and we now publish the source code in the npm distribution.</p>

<p>This release includes some breaking changes to optional parts of the
Action Cable JavaScript API:</p>

<ul>
<li><p>Configuration of the WebSocket adapter and logger adapter have been moved
from properties of <a href="ActionCable.html" title="ActionCable (module)"><code>ActionCable</code></a> to properties of <code>ActionCable.adapters</code>.
If you are configuring these adapters you will need to make
these changes:</p>

<pre class="code diff"><code class="diff">-    ActionCable.WebSocket = MyWebSocket
+    ActionCable.adapters.WebSocket = MyWebSocket
</code></pre>

<pre class="code diff"><code class="diff">-    ActionCable.logger = myLogger
+    ActionCable.adapters.logger = myLogger
</code></pre></li>
<li><p>The <code>ActionCable.startDebugging()</code> and <code>ActionCable.stopDebugging()</code>
methods have been removed and replaced with the property
<code>ActionCable.logger.enabled</code>. If you are using these methods you
will need to make these changes:</p>

<pre class="code diff"><code class="diff">-    ActionCable.startDebugging()
+    ActionCable.logger.enabled = true
</code></pre>

<pre class="code diff"><code class="diff">-    ActionCable.stopDebugging()
+    ActionCable.logger.enabled = false
</code></pre></li>
</ul>

<h3><a href="ActionDispatch/Response.html#content_type-instance_method" title="ActionDispatch::Response#content_type (method)">ActionDispatch::Response#content_type</a> now returns the Content-Type header without modification</h3>

<p>Previously, the return value of <a href="ActionDispatch/Response.html#content_type-instance_method" title="ActionDispatch::Response#content_type (method)">ActionDispatch::Response#content_type</a> did NOT contain the charset part.
This behavior has changed to include the previously omitted charset part as well.</p>

<p>If you want just the MIME type, please use <a href="ActionDispatch/Response.html#media_type-instance_method" title="ActionDispatch::Response#media_type (method)">ActionDispatch::Response#media_type</a> instead.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_resp'>resp</span> <span class='op'>=</span> <span class='const'><a href="ActionDispatch.html" title="ActionDispatch (module)">ActionDispatch</a></span><span class='op'>::</span><span class='const'><a href="ActionDispatch/Response.html" title="ActionDispatch::Response (class)">Response</a></span>.<span class='id identifier rubyid_new'><a href="ActionDispatch/Response.html#new-class_method" title="ActionDispatch::Response.new (method)">new</a></span>(<span class='int'>200</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/csv; header=present; charset=utf-16</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_content_type'>content_type</span> <span class='comment'>#=&gt; &quot;text/csv; header=present&quot;</span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_resp'>resp</span> <span class='op'>=</span> <span class='const'><a href="ActionDispatch.html" title="ActionDispatch (module)">ActionDispatch</a></span><span class='op'>::</span><span class='const'><a href="ActionDispatch/Response.html" title="ActionDispatch::Response (class)">Response</a></span>.<span class='id identifier rubyid_new'><a href="ActionDispatch/Response.html#new-class_method" title="ActionDispatch::Response.new (method)">new</a></span>(<span class='int'>200</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/csv; header=present; charset=utf-16</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_content_type'>content_type</span> <span class='comment'>#=&gt; &quot;text/csv; header=present; charset=utf-16&quot;
</span><span class='id identifier rubyid_resp'>resp</span>.<span class='id identifier rubyid_media_type'>media_type</span>   <span class='comment'>#=&gt; &quot;text/csv&quot;</span></code></pre>

<h3>Autoloading</h3>

<p>The default configuration for Rails 6</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/application.rb
</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_load_defaults'>load_defaults</span> <span class='float'>6.0</span></code></pre>

<p>enables <code>zeitwerk</code> autoloading mode on CRuby. In that mode, autoloading, reloading, and eager loading are managed by <a href="https://github.com/fxn/zeitwerk">Zeitwerk</a>.</p>

<h4>Public API</h4>

<p>In general, applications do not need to use the API of Zeitwerk directly. Rails sets things up according to the existing contract: <code>config.autoload_paths</code>, <code>config.cache_classes</code>, etc.</p>

<p>While applications should stick to that interface, the actual Zeitwerk loader object can be accessed as</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_autoloaders'><a href="Rails.html#autoloaders-class_method" title="Rails.autoloaders (method)">autoloaders</a></span>.<span class='id identifier rubyid_main'>main</span></code></pre>

<p>That may be handy if you need to preload STIs or configure a custom inflector, for example.</p>

<h4>Project Structure</h4>

<p>If the application being upgraded autoloads correctly, the project structure should be already mostly compatible.</p>

<p>However, <code>classic</code> mode infers file names from missing constant names (<code>underscore</code>), whereas <code>zeitwerk</code> mode infers constant names from file names (<code>camelize</code>). These helpers are not always inverse of each other, in particular if acronyms are involved. For instance, <code>&quot;FOO&quot;.underscore</code> is <code>&quot;foo&quot;</code>, but <code>&quot;foo&quot;.camelize</code> is <code>&quot;Foo&quot;</code>, not <code>&quot;FOO&quot;</code>.</p>

<p>Compatibility can be checked with the <code>zeitwerk:check</code> task:</p>

<pre class="code bash"><code class="bash">$ bin/rails zeitwerk:check
Hold on, I am eager loading the application.
All is good!
</code></pre>

<h4>require_dependency</h4>

<p>All known use cases of <code>require_dependency</code> have been eliminated, you should grep the project and delete them.</p>

<p>If your application has STIs, please check their section in the guide <a href="autoloading_and_reloading_constants.html#single-table-inheritance">Autoloading and Reloading Constants (Zeitwerk Mode)</a>.</p>

<h4>Qualified names in class and module definitions</h4>

<p>You can now robustly use constant paths in class and module definitions:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Autoloading in this class&#39; body matches Ruby semantics now.
</span><span class='kw'>class</span> <span class='const'>Admin</span><span class='op'>::</span><span class='const'>UsersController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='comment'># ...
</span><span class='kw'>end</span></code></pre>

<p>A gotcha to be aware of is that, depending on the order of execution, the classic autoloader could sometimes be able to autoload <code>Foo::Wadus</code> in</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Foo</span><span class='op'>::</span><span class='const'>Bar</span>
  <span class='const'>Wadus</span>
<span class='kw'>end</span></code></pre>

<p>That does not match Ruby semantics because <code>Foo</code> is not in the nesting, and won&#39;t work at all in <code>zeitwerk</code> mode. If you find such corner case you can use the qualified name <code>Foo::Wadus</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Foo</span><span class='op'>::</span><span class='const'>Bar</span>
  <span class='const'>Foo</span><span class='op'>::</span><span class='const'>Wadus</span>
<span class='kw'>end</span></code></pre>

<p>or add <code>Foo</code> to the nesting:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>Foo</span>
  <span class='kw'>class</span> <span class='const'>Bar</span>
    <span class='const'>Wadus</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h4>Concerns</h4>

<p>You can autoload and eager load from a standard structure like</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_app'>app</span><span class='op'>/</span><span class='id identifier rubyid_models'>models</span>
<span class='id identifier rubyid_app'>app</span><span class='op'>/</span><span class='id identifier rubyid_models'>models</span><span class='op'>/</span><span class='id identifier rubyid_concerns'>concerns</span></code></pre>

<p>In that case, <code>app/models/concerns</code> is assumed to be a root directory (because it belongs to the autoload paths), and it is ignored as namespace. So, <code>app/models/concerns/foo.rb</code> should define <code>Foo</code>, not <code>Concerns::Foo</code>.</p>

<p>The <code>Concerns::</code> namespace worked with the classic autoloader as a side-effect of the implementation, but it was not really an intended behavior. An application using <code>Concerns::</code> needs to rename those classes and modules to be able to run in <code>zeitwerk</code> mode.</p>

<h4>Having <code>app</code> in the autoload paths</h4>

<p>Some projects want something like <code>app/api/base.rb</code> to define <code>API::Base</code>, and add <code>app</code> to the autoload paths to accomplish that in <code>classic</code> mode. Since Rails adds all subdirectories of <code>app</code> to the autoload paths automatically, we have another situation in which there are nested root directories, so that setup no longer works. Similar principle we explained above with <code>concerns</code>.</p>

<p>If you want to keep that structure, you&#39;ll need to delete the subdirectory from the autoload paths in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/Dependencies.html" title="ActiveSupport::Dependencies (module)">Dependencies</a></span>.<span class='id identifier rubyid_autoload_paths'><a href="ActiveSupport/Dependencies.html#autoload_paths-class_method" title="ActiveSupport::Dependencies.autoload_paths (method)">autoload_paths</a></span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_root'><a href="Rails.html#root-class_method" title="Rails.root (method)">root</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>/app/api</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<h4>Autoloaded Constants and Explicit Namespaces</h4>

<p>If a namespace is defined in a file, as <code>Hotel</code> is here:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_app'>app</span><span class='op'>/</span><span class='id identifier rubyid_models'>models</span><span class='op'>/</span><span class='id identifier rubyid_hotel'>hotel</span>.<span class='id identifier rubyid_rb'>rb</span>         <span class='comment'># Defines Hotel.
</span><span class='id identifier rubyid_app'>app</span><span class='op'>/</span><span class='id identifier rubyid_models'>models</span><span class='op'>/</span><span class='id identifier rubyid_hotel'>hotel</span><span class='op'>/</span><span class='id identifier rubyid_pricing'>pricing</span>.<span class='id identifier rubyid_rb'>rb</span> <span class='comment'># Defines Hotel::Pricing.</span></code></pre>

<p>the <code>Hotel</code> constant has to be set using the <code>class</code> or <code>module</code> keywords. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Hotel</span>
<span class='kw'>end</span></code></pre>

<p>is good.</p>

<p>Alternatives like</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Hotel</span> <span class='op'>=</span> <span class='const'><a href="Class.html" title="Class (class)">Class</a></span>.<span class='id identifier rubyid_new'>new</span></code></pre>

<p>or</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Hotel</span> <span class='op'>=</span> <span class='const'><a href="Struct.html" title="Struct (class)">Struct</a></span>.<span class='id identifier rubyid_new'>new</span></code></pre>

<p>won&#39;t work, child objects like <code>Hotel::Pricing</code> won&#39;t be found.</p>

<p>This restriction only applies to explicit namespaces. Classes and modules not defining a namespace can be defined using those idioms.</p>

<h4>One file, one constant (at the same top-level)</h4>

<p>In <code>classic</code> mode you could technically define several constants at the same top-level and have them all reloaded. For example, given</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/foo.rb
</span>
<span class='kw'>class</span> <span class='const'>Foo</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Bar</span>
<span class='kw'>end</span></code></pre>

<p>while <code>Bar</code> could not be autoloaded, autoloading <code>Foo</code> would mark <code>Bar</code> as autoloaded too. This is not the case in <code>zeitwerk</code> mode, you need to move <code>Bar</code> to its own file <code>bar.rb</code>. One file, one constant.</p>

<p>This affects only to constants at the same top-level as in the example above. Inner classes and modules are fine. For example, consider</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/foo.rb
</span>
<span class='kw'>class</span> <span class='const'>Foo</span>
  <span class='kw'>class</span> <span class='const'>InnerClass</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>If the application reloads <code>Foo</code>, it will reload <code>Foo::InnerClass</code> too.</p>

<h4>Spring and the <code>test</code> Environment</h4>

<p>Spring reloads the application code if something changes. In the <code>test</code> environment you need to enable reloading for that to work:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/environments/test.rb
</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_cache_classes'>cache_classes</span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>

<p>Otherwise you&#39;ll get this error:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_reloading'>reloading</span> <span class='id identifier rubyid_is'>is</span> <span class='id identifier rubyid_disabled'>disabled</span> <span class='id identifier rubyid_because'>because</span> <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_cache_classes'>cache_classes</span> <span class='id identifier rubyid_is'>is</span> <span class='kw'>true</span></code></pre>

<h4>Bootsnap</h4>

<p>Bootsnap should be at least version 1.4.2.</p>

<p>In addition to that, Bootsnap needs to disable the iseq cache due to a bug in the interpreter if running Ruby 2.5. Please make sure to depend on at least Bootsnap 1.4.4 in that case.</p>

<h4><code>config.add_autoload_paths_to_load_path</code></h4>

<p>The new configuration point</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_add_autoload_paths_to_load_path'>add_autoload_paths_to_load_path</span></code></pre>

<p>is <code>true</code> by default for backwards compatibility, but allows you to opt-out from adding the autoload paths to <code>$LOAD_PATH</code>.</p>

<p>This makes sense in most applications, since you never should require a file in <code>app/models</code>, for example, and Zeitwerk only uses absolute file names internally.</p>

<p>By opting-out you optimize <code>$LOAD_PATH</code> lookups (less directories to check), and save Bootsnap work and memory consumption, since it does not need to build an index for these directories.</p>

<h4>Thread-safety</h4>

<p>In classic mode, constant autoloading is not thread-safe, though Rails has locks in place for example to make web requests thread-safe when autoloading is enabled, as it is common in the development environment.</p>

<p>Constant autoloading is thread-safe in <code>zeitwerk</code> mode. For example, you can now autoload in multi-threaded scripts executed by the <code>runner</code> command.</p>

<h4>Globs in config.autoload_paths</h4>

<p>Beware of configurations like</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_autoload_paths'>autoload_paths</span> <span class='op'>+=</span> <span class='const'>Dir</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_root'>root</span><span class='embexpr_end'>}</span><span class='tstring_content'>/lib/**/</span><span class='tstring_end'>&quot;</span></span>]</code></pre>

<p>Every element of <code>config.autoload_paths</code> should represent the top-level namespace (<a href="Object.html" title="Object (class)"><code>Object</code></a>) and they cannot be nested in consequence (with the exception of <code>concerns</code> directories explained above).</p>

<p>To fix this, just remove the wildcards:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_autoload_paths'>autoload_paths</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_root'>root</span><span class='embexpr_end'>}</span><span class='tstring_content'>/lib</span><span class='tstring_end'>&quot;</span></span></code></pre>

<h4>Eager loading and autoloading are consistent</h4>

<p>In <code>classic</code> mode, if <code>app/models/foo.rb</code> defines <code>Bar</code>, you won&#39;t be able to autoload that file, but eager loading will work because it loads files recursively blindly. This can be a source of errors if you test things first eager loading, execution may fail later autoloading.</p>

<p>In <code>zeitwerk</code> mode both loading modes are consistent, they fail and err in the same files.</p>

<h4>How to Use the Classic Autoloader in Rails 6</h4>

<p>Applications can load Rails 6 defaults and still use the classic autoloader by setting <code>config.autoloader</code> this way:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/application.rb
</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_load_defaults'>load_defaults</span> <span class='float'>6.0</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_autoloader'>autoloader</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_classic'>classic</span></code></pre>

<p>When using the Classic Autoloader in Rails 6 application it is recommended to set concurrency level to 1 in development environment, for the web servers and background processors, due to the thread-safety concerns.</p>

<h3>Active Storage assignment behavior change</h3>

<p>With the configuration defaults for Rails 5.2, assigning to a collection of attachments declared with <code>has_many_attached</code> appends new files:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many_attached'>has_many_attached</span> <span class='symbeg'>:</span><span class='id identifier rubyid_highlights'>highlights</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_attach'>attach</span>(<span class='label'>filename:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>funky.jpg</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='op'>...</span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_count'>count</span> <span class='comment'># =&gt; 1
</span>
<span class='id identifier rubyid_blob'>blob</span> <span class='op'>=</span> <span class='const'><a href="ActiveStorage.html" title="ActiveStorage (module)">ActiveStorage</a></span><span class='op'>::</span><span class='const'>Blob</span>.<span class='id identifier rubyid_create_after_upload!'>create_after_upload!</span>(<span class='label'>filename:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>town.jpg</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='op'>...</span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_update!'>update!</span>(<span class='label'>highlights:</span> [ <span class='id identifier rubyid_blob'>blob</span> ])

<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_count'>count</span> <span class='comment'># =&gt; 2
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_filename'>filename</span> <span class='comment'># =&gt; &quot;funky.jpg&quot;
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_second'>second</span>.<span class='id identifier rubyid_filename'>filename</span> <span class='comment'># =&gt; &quot;town.jpg&quot;</span></code></pre>

<p>With the configuration defaults for Rails 6.0, assigning to a collection of attachments replaces existing files instead of appending to them. This matches Active Record behavior when assigning to a collection association:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_attach'>attach</span>(<span class='label'>filename:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>funky.jpg</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='op'>...</span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_count'>count</span> <span class='comment'># =&gt; 1
</span>
<span class='id identifier rubyid_blob'>blob</span> <span class='op'>=</span> <span class='const'><a href="ActiveStorage.html" title="ActiveStorage (module)">ActiveStorage</a></span><span class='op'>::</span><span class='const'>Blob</span>.<span class='id identifier rubyid_create_after_upload!'>create_after_upload!</span>(<span class='label'>filename:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>town.jpg</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='op'>...</span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_update!'>update!</span>(<span class='label'>highlights:</span> [ <span class='id identifier rubyid_blob'>blob</span> ])

<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_count'>count</span> <span class='comment'># =&gt; 1
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_filename'>filename</span> <span class='comment'># =&gt; &quot;town.jpg&quot;</span></code></pre>

<p><code>#attach</code> can be used to add new attachments without removing the existing ones:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_blob'>blob</span> <span class='op'>=</span> <span class='const'><a href="ActiveStorage.html" title="ActiveStorage (module)">ActiveStorage</a></span><span class='op'>::</span><span class='const'>Blob</span>.<span class='id identifier rubyid_create_after_upload!'>create_after_upload!</span>(<span class='label'>filename:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>town.jpg</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='op'>...</span>)
<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_attach'>attach</span>(<span class='id identifier rubyid_blob'>blob</span>)

<span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_count'>count</span> <span class='comment'># =&gt; 2
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_filename'>filename</span> <span class='comment'># =&gt; &quot;funky.jpg&quot;
</span><span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_highlights'>highlights</span>.<span class='id identifier rubyid_second'>second</span>.<span class='id identifier rubyid_filename'>filename</span> <span class='comment'># =&gt; &quot;town.jpg&quot;</span></code></pre>

<p>Existing applications can opt in to this new behavior by setting <code>config.active_storage.replace_on_assign_to_many</code> to <code>true</code>. The old behavior will be deprecated in Rails 6.1 and removed in a subsequent release.</p>

<h2>Upgrading from Rails 5.1 to Rails 5.2</h2>

<p>For more information on changes made to Rails 5.2 please see the <a href="5_2_release_notes.html">release notes</a>.</p>

<h3>Bootsnap</h3>

<p>Rails 5.2 adds bootsnap gem in the <a href="https://github.com/rails/rails/pull/29313">newly generated app&#39;s Gemfile</a>.
The <code>app:update</code> command sets it up in <code>boot.rb</code>. If you want to use it, then add it in the Gemfile,
otherwise change the <code>boot.rb</code> to not use bootsnap.</p>

<h3>Expiry in signed or encrypted cookie is now embedded in the cookies values</h3>

<p>To improve security, Rails now embeds the expiry information also in encrypted or signed cookies value.</p>

<p>This new embed information make those cookies incompatible with versions of Rails older than 5.2.</p>

<p>If you require your cookies to be read by 5.1 and older, or you are still validating your 5.2 deploy and want
to allow you to rollback set
<code>Rails.application.config.action_dispatch.use_authenticated_cookie_encryption</code> to <code>false</code>.</p>

<h2>Upgrading from Rails 5.0 to Rails 5.1</h2>

<p>For more information on changes made to Rails 5.1 please see the <a href="5_1_release_notes.html">release notes</a>.</p>

<h3>Top-level <a href="#HashWithIndifferentAccess-constant" title="HashWithIndifferentAccess (constant)">HashWithIndifferentAccess</a> is soft-deprecated</h3>

<p>If your application uses the top-level <a href="#HashWithIndifferentAccess-constant" title="HashWithIndifferentAccess (constant)">HashWithIndifferentAccess</a> class, you
should slowly move your code to instead use <a href="ActiveSupport/HashWithIndifferentAccess.html" title="ActiveSupport::HashWithIndifferentAccess (class)"><code>::ActiveSupport::HashWithIndifferentAccess</code></a>.</p>

<p>It is only soft-deprecated, which means that your code will not break at the
moment and no deprecation warning will be displayed, but this constant will be
removed in the future.</p>

<p>Also, if you have pretty old YAML documents containing dumps of such objects,
you may need to load and dump them again to make sure that they reference
the right constant, and that loading them won&#39;t break in the future.</p>

<h3><code>application.secrets</code> now loaded with all keys as symbols</h3>

<p>If your application stores nested configuration in <code>config/secrets.yml</code>, all keys
are now loaded as symbols, so access using strings should be changed.</p>

<p>From:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_secrets'>secrets</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_smtp_settings'>smtp_settings</span>][<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>address</span><span class='tstring_end'>&quot;</span></span>]</code></pre>

<p>To:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_secrets'>secrets</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_smtp_settings'>smtp_settings</span>][<span class='symbeg'>:</span><span class='id identifier rubyid_address'>address</span>]</code></pre>

<h3>Removed deprecated support to <code>:text</code> and <code>:nothing</code> in <code>render</code></h3>

<p>If your views are using <code>render :text</code>, they will no longer work. The new method
of rendering text with MIME type of <code>text/plain</code> is to use <code>render :plain</code>.</p>

<p>Similarly, <code>render :nothing</code> is also removed and you should use the <code>head</code> method
to send responses that contain only headers. For example, <code>head :ok</code> sends a
200 response with no body to render.</p>

<h2>Upgrading from Rails 4.2 to Rails 5.0</h2>

<p>For more information on changes made to Rails 5.0 please see the <a href="5_0_release_notes.html">release notes</a>.</p>

<h3>Ruby 2.2.2+ required</h3>

<p>From Ruby on Rails 5.0 onwards, Ruby 2.2.2+ is the only supported Ruby version.
Make sure you are on Ruby 2.2.2 version or greater, before you proceed.</p>

<h3>Active Record Models Now Inherit from ApplicationRecord by Default</h3>

<p>In Rails 4.2, an Active Record model inherits from <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a>. In Rails 5.0,
all models inherit from <code>ApplicationRecord</code>.</p>

<p><code>ApplicationRecord</code> is a new superclass for all app models, analogous to app
controllers subclassing <code>ApplicationController</code> instead of
<a href="ActionController/Base.html" title="ActionController::Base (class)"><code>::ActionController::Base</code></a>. This gives apps a single spot to configure app-wide
model behavior.</p>

<p>When upgrading from Rails 4.2 to Rails 5.0, you need to create an
<code>application_record.rb</code> file in <code>app/models/</code> and add the following content:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationRecord</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_abstract_class'>abstract_class</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>Then make sure that all your models inherit from it.</p>

<h3>Halting Callback Chains via <code>throw(:abort)</code></h3>

<p>In Rails 4.2, when a &#39;before&#39; callback returns <code>false</code> in Active Record
and Active Model, then the entire callback chain is halted. In other words,
successive &#39;before&#39; callbacks are not executed, and neither is the action wrapped
in callbacks.</p>

<p>In Rails 5.0, returning <code>false</code> in an Active Record or Active Model callback
will not have this side effect of halting the callback chain. Instead, callback
chains must be explicitly halted by calling <code>throw(:abort)</code>.</p>

<p>When you upgrade from Rails 4.2 to Rails 5.0, returning <code>false</code> in those kind of
callbacks will still halt the callback chain, but you will receive a deprecation
warning about this upcoming change.</p>

<p>When you are ready, you can opt into the new behavior and remove the deprecation
warning by adding the following configuration to your <code>config/application.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span>.<span class='id identifier rubyid_halt_callback_chains_on_return_false'>halt_callback_chains_on_return_false</span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>

<p>Note that this option will not affect Active Support callbacks since they never
halted the chain when any value was returned.</p>

<p>See <a href="https://github.com/rails/rails/pull/17227">#17227</a> for more details.</p>

<h3>ActiveJob Now Inherits from ApplicationJob by Default</h3>

<p>In Rails 4.2, an Active Job inherits from <a href="ActiveJob/Base.html" title="ActiveJob::Base (class)"><code>::ActiveJob::Base</code></a>. In Rails 5.0, this
behavior has changed to now inherit from <code>ApplicationJob</code>.</p>

<p>When upgrading from Rails 4.2 to Rails 5.0, you need to create an
<code>application_job.rb</code> file in <code>app/jobs/</code> and add the following content:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationJob</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveJob.html" title="ActiveJob (module)">ActiveJob</a></span><span class='op'>::</span><span class='const'><a href="ActiveJob/Base.html" title="ActiveJob::Base (class)">Base</a></span>
<span class='kw'>end</span></code></pre>

<p>Then make sure that all your job classes inherit from it.</p>

<p>See <a href="https://github.com/rails/rails/pull/19034">#19034</a> for more details.</p>

<h3>Rails Controller Testing</h3>

<h4>Extraction of some helper methods to <code>rails-controller-testing</code></h4>

<p><code>assigns</code> and <code>assert_template</code> have been extracted to the <code>rails-controller-testing</code> gem. To
continue using these methods in your controller tests, add <code>gem &#39;rails-controller-testing&#39;</code> to
your <code>Gemfile</code>.</p>

<p>If you are using RSpec for testing, please see the extra configuration required in the gem&#39;s
documentation.</p>

<h4>New behavior when uploading files</h4>

<p>If you are using <a href="ActionDispatch/Http/UploadedFile.html" title="ActionDispatch::Http::UploadedFile (class)"><code>::ActionDispatch::Http::UploadedFile</code></a> in your tests to
upload files, you will need to change to use the similar <code>Rack::Test::UploadedFile</code>
class instead.</p>

<p>See <a href="https://github.com/rails/rails/issues/26404">#26404</a> for more details.</p>

<h3>Autoloading is Disabled After Booting in the Production Environment</h3>

<p>Autoloading is now disabled after booting in the production environment by
default.</p>

<p>Eager loading the application is part of the boot process, so top-level
constants are fine and are still autoloaded, no need to require their files.</p>

<p>Constants in deeper places only executed at runtime, like regular method bodies,
are also fine because the file defining them will have been eager loaded while booting.</p>

<p>For the vast majority of applications this change needs no action. But in the
very rare event that your application needs autoloading while running in
production, set <code>Rails.application.config.enable_dependency_loading</code> to true.</p>

<h3>XML Serialization</h3>

<p><code>ActiveModel::Serializers::Xml</code> has been extracted from Rails to the <code>activemodel-serializers-xml</code>
gem. To continue using XML serialization in your application, add <code>gem &#39;activemodel-serializers-xml&#39;</code>
to your <code>Gemfile</code>.</p>

<h3>Removed Support for Legacy <code>mysql</code> Database Adapter</h3>

<p>Rails 5 removes support for the legacy <code>mysql</code> database adapter. Most users should be able to
use <code>mysql2</code> instead. It will be converted to a separate gem when we find someone to maintain
it.</p>

<h3>Removed Support for Debugger</h3>

<p><code>debugger</code> is not supported by Ruby 2.2 which is required by Rails 5. Use <code>byebug</code> instead.</p>

<h3>Use <code>bin/rails</code> for running tasks and tests</h3>

<p>Rails 5 adds the ability to run tasks and tests through <code>bin/rails</code> instead of rake. Generally
these changes are in parallel with rake, but some were ported over altogether.</p>

<p>To use the new test runner simply type <code>bin/rails test</code>.</p>

<p><code>rake dev:cache</code> is now <code>bin/rails dev:cache</code>.</p>

<p>Run <code>bin/rails</code> inside your application&#39;s root directory to see the list of commands available.</p>

<h3><a href="ActionController/Parameters.html" title="ActionController::Parameters (class)"><code>::ActionController::Parameters</code></a> No Longer Inherits from <a href="#HashWithIndifferentAccess-constant" title="HashWithIndifferentAccess (constant)">HashWithIndifferentAccess</a></h3>

<p>Calling <code>params</code> in your application will now return an object instead of a hash. If your
parameters are already permitted, then you will not need to make any changes. If you are using <code>map</code>
and other methods that depend on being able to read the hash regardless of <code>permitted?</code> you will
need to upgrade your application to first permit and then convert to a hash.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_params'>params</span>.<span class='id identifier rubyid_permit'>permit</span>([<span class='symbeg'>:</span><span class='id identifier rubyid_proceed_to'>proceed_to</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_return_to'>return_to</span>]).<span class='id identifier rubyid_to_h'>to_h</span></code></pre>

<h3><code>protect_from_forgery</code> Now Defaults to <code>prepend: false</code></h3>

<p><code>protect_from_forgery</code> defaults to <code>prepend: false</code> which means that it will be inserted into
the callback chain at the point in which you call it in your application. If you want
<code>protect_from_forgery</code> to always run first, then you should change your application to use
<code>protect_from_forgery prepend: true</code>.</p>

<h3>Default Template Handler is Now RAW</h3>

<p>Files without a template handler in their extension will be rendered using the raw handler.
Previously Rails would render files using the ERB template handler.</p>

<p>If you do not want your file to be handled via the raw handler, you should add an extension
to your file that can be parsed by the appropriate template handler.</p>

<h3>Added Wildcard Matching for Template Dependencies</h3>

<p>You can now use wildcard matching for your template dependencies. For example, if you were
defining your templates as such:</p>

<pre class="code xml"><code class="xml">&lt;% # Template Dependency: recordings/threads/events/subscribers_changed %&gt;
&lt;% # Template Dependency: recordings/threads/events/completed %&gt;
&lt;% # Template Dependency: recordings/threads/events/uncompleted %&gt;
</code></pre>

<p>You can now just call the dependency once with a wildcard.</p>

<pre class="code xml"><code class="xml">&lt;% # Template Dependency: recordings/threads/events/* %&gt;
</code></pre>

<h3><code>ActionView::Helpers::RecordTagHelper</code> moved to external gem (record_tag_helper)</h3>

<p><code>content_tag_for</code> and <code>div_for</code> have been removed in favor of just using <code>content_tag</code>. To continue using the older methods, add the <code>record_tag_helper</code> gem to your <code>Gemfile</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>record_tag_helper</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>~&gt; 1.0</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>See <a href="https://github.com/rails/rails/pull/18411">#18411</a> for more details.</p>

<h3>Removed Support for <code>protected_attributes</code> Gem</h3>

<p>The <code>protected_attributes</code> gem is no longer supported in Rails 5.</p>

<h3>Removed support for <code>activerecord-deprecated_finders</code> gem</h3>

<p>The <code>activerecord-deprecated_finders</code> gem is no longer supported in Rails 5.</p>

<h3><a href="ActiveSupport/TestCase.html" title="ActiveSupport::TestCase (class)"><code>::ActiveSupport::TestCase</code></a> Default Test Order is Now Random</h3>

<p>When tests are run in your application, the default order is now <code>:random</code>
instead of <code>:sorted</code>. Use the following config option to set it back to <code>:sorted</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/environments/test.rb
</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_configure'>configure</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_support'>active_support</span>.<span class='id identifier rubyid_test_order'>test_order</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_sorted'>sorted</span>
<span class='kw'>end</span></code></pre>

<h3><a href="ActionController/Live.html" title="ActionController::Live (module)"><code>::ActionController::Live</code></a> became a <code>Concern</code></h3>

<p>If you include <a href="ActionController/Live.html" title="ActionController::Live (module)"><code>::ActionController::Live</code></a> in another module that is included in your controller, then you
should also extend the module with <a href="ActiveSupport/Concern.html" title="ActiveSupport::Concern (module)"><code>::ActiveSupport::Concern</code></a>. Alternatively, you can use the <code>self.included</code> hook
to include <a href="ActionController/Live.html" title="ActionController::Live (module)"><code>::ActionController::Live</code></a> directly to the controller once the <code>StreamingSupport</code> is included.</p>

<p>This means that if your application used to have its own streaming module, the following code
would break in production:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># This is a work-around for streamed controllers performing authentication with Warden/Devise.
</span><span class='comment'># See https://github.com/plataformatec/devise/issues/2332
</span><span class='comment'># Authenticating in the router is another solution as suggested in that issue
</span><span class='kw'>class</span> <span class='const'>StreamingSupport</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><a href="ActionController.html" title="ActionController (module)">ActionController</a></span><span class='op'>::</span><span class='const'><a href="ActionController/Live.html" title="ActionController::Live (module)">Live</a></span> <span class='comment'># this won&#39;t work in production for Rails 5
</span>  <span class='comment'># extend ActiveSupport::Concern # unless you uncomment this line.
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_process'>process</span>(<span class='id identifier rubyid_name'>name</span>)
    <span class='kw'>super</span>(<span class='id identifier rubyid_name'>name</span>)
  <span class='kw'>rescue</span> <span class='const'>ArgumentError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>uncaught throw :warden</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_throw'>throw</span> <span class='symbeg'>:</span><span class='id identifier rubyid_warden'>warden</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>New Framework Defaults</h3>

<h4>Active Record <code>belongs_to</code> Required by Default Option</h4>

<p><code>belongs_to</code> will now trigger a validation error by default if the association is not present.</p>

<p>This can be turned off per-association with <code>optional: true</code>.</p>

<p>This default will be automatically configured in new applications. If an existing application
wants to add this feature it will need to be turned on in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_belongs_to_required_by_default'>belongs_to_required_by_default</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>The configuration is by default global for all your models, but you can
override it on a per model basis. This should help you migrate all your models to have their
associations required by default.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='comment'># model is not yet ready to have its association required by default
</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_belongs_to_required_by_default'>belongs_to_required_by_default</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>)
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Car</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='comment'># model is ready to have its association required by default
</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_belongs_to_required_by_default'>belongs_to_required_by_default</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_pilot'>pilot</span>)
<span class='kw'>end</span></code></pre>

<h4>Per-form CSRF Tokens</h4>

<p>Rails 5 now supports per-form CSRF tokens to mitigate against code-injection attacks with forms
created by JavaScript. With this option turned on, forms in your application will each have their
own CSRF token that is specific to the action and method for that form.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_controller'>action_controller</span>.<span class='id identifier rubyid_per_form_csrf_tokens'>per_form_csrf_tokens</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<h4>Forgery Protection with Origin Check</h4>

<p>You can now configure your application to check if the HTTP <code>Origin</code> header should be checked
against the site&#39;s origin as an additional CSRF defense. Set the following in your config to
true:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_controller'>action_controller</span>.<span class='id identifier rubyid_forgery_protection_origin_check'>forgery_protection_origin_check</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<h4>Allow Configuration of Action Mailer Queue Name</h4>

<p>The default mailer queue name is <code>mailers</code>. This configuration option allows you to globally change
the queue name. Set the following in your config:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_deliver_later_queue_name'>deliver_later_queue_name</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_new_queue_name'>new_queue_name</span></code></pre>

<h4>Support Fragment Caching in Action Mailer Views</h4>

<p>Set <code>config.action_mailer.perform_caching</code> in your config to determine whether your Action Mailer views
should support caching.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_mailer'>action_mailer</span>.<span class='id identifier rubyid_perform_caching'>perform_caching</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<h4>Configure the Output of <code>db:structure:dump</code></h4>

<p>If you&#39;re using <code>schema_search_path</code> or other PostgreSQL extensions, you can control how the schema is
dumped. Set to <code>:all</code> to generate all dumps, or to <code>:schema_search_path</code> to generate from schema search path.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_dump_schemas'>dump_schemas</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_all'>all</span></code></pre>

<h4>Configure SSL Options to Enable HSTS with Subdomains</h4>

<p>Set the following in your config to enable HSTS when using subdomains:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_ssl_options'>ssl_options</span> <span class='op'>=</span> { <span class='label'>hsts:</span> { <span class='label'>subdomains:</span> <span class='kw'>true</span> } }</code></pre>

<h4>Preserve Timezone of the Receiver</h4>

<p>When using Ruby 2.4, you can preserve the timezone of the receiver when calling <code>to_time</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span>.<span class='id identifier rubyid_to_time_preserves_timezone'><a href="ActiveSupport.html#to_time_preserves_timezone-class_method" title="ActiveSupport.to_time_preserves_timezone (method)">to_time_preserves_timezone</a></span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>

<h3>Changes with JSON/JSONB serialization</h3>

<p>In Rails 5.0, how JSON/JSONB attributes are serialized and deserialized changed. Now, if
you set a column equal to a <a href="String.html" title="String (class)"><code>String</code></a>, Active Record will no longer turn that string
into a <a href="Hash.html" title="Hash (class)"><code>Hash</code></a>, and will instead only return the string. This is not limited to code
interacting with models, but also affects <code>:default</code> column settings in <code>db/schema.rb</code>.
It is recommended that you do not set columns equal to a <a href="String.html" title="String (class)"><code>String</code></a>, but pass a <a href="Hash.html" title="Hash (class)"><code>Hash</code></a>
instead, which will be converted to and from a JSON string automatically.</p>

<h2>Upgrading from Rails 4.1 to Rails 4.2</h2>

<h3>Web Console</h3>

<p>First, add <code>gem &#39;web-console&#39;, &#39;~&gt; 2.0&#39;</code> to the <code>:development</code> group in your <code>Gemfile</code> and run <code>bundle install</code> (it won&#39;t have been included when you upgraded Rails). Once it&#39;s been installed, you can simply drop a reference to the console helper (i.e., <code>&lt;%= console %&gt;</code>) into any view you want to enable it for. A console will also be provided on any error page you view in your development environment.</p>

<h3>Responders</h3>

<p><code>respond_with</code> and the class-level <code>respond_to</code> methods have been extracted to the <code>responders</code> gem. To use them, simply add <code>gem &#39;responders&#39;, &#39;~&gt; 2.0&#39;</code> to your <code>Gemfile</code>. Calls to <code>respond_with</code> and <code>respond_to</code> (again, at the class level) will no longer work without having included the <code>responders</code> gem in your dependencies:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/controllers/users_controller.rb
</span>
<span class='kw'>class</span> <span class='const'>UsersController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_html'>html</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_json'>json</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
    <span class='ivar'>@user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])
    <span class='id identifier rubyid_respond_with'>respond_with</span> <span class='ivar'>@user</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>Instance-level <code>respond_to</code> is unaffected and does not require the additional gem:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/controllers/users_controller.rb
</span>
<span class='kw'>class</span> <span class='const'>UsersController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
    <span class='ivar'>@user</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_find'>find</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>])
    <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_html'>html</span>
      <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_json'>json</span> { <span class='id identifier rubyid_render'>render</span> <span class='label'>json:</span> <span class='ivar'>@user</span> }
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>See <a href="https://github.com/rails/rails/pull/16526">#16526</a> for more details.</p>

<h3>Error handling in transaction callbacks</h3>

<p>Currently, Active Record suppresses errors raised
within <code>after_rollback</code> or <code>after_commit</code> callbacks and only prints them to
the logs. In the next version, these errors will no longer be suppressed.
Instead, the errors will propagate normally just like in other Active
Record callbacks.</p>

<p>When you define an <code>after_rollback</code> or <code>after_commit</code> callback, you
will receive a deprecation warning about this upcoming change. When
you are ready, you can opt into the new behavior and remove the
deprecation warning by adding following configuration to your
<code>config/application.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_raise_in_transactional_callbacks'>raise_in_transactional_callbacks</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<p>See <a href="https://github.com/rails/rails/pull/14488">#14488</a> and
<a href="https://github.com/rails/rails/pull/16537">#16537</a> for more details.</p>

<h3>Ordering of test cases</h3>

<p>In Rails 5.0, test cases will be executed in random order by default. In
anticipation of this change, Rails 4.2 introduced a new configuration option
<code>active_support.test_order</code> for explicitly specifying the test ordering. This
allows you to either lock down the current behavior by setting the option to
<code>:sorted</code>, or opt into the future behavior by setting the option to <code>:random</code>.</p>

<p>If you do not specify a value for this option, a deprecation warning will be
emitted. To avoid this, add the following line to your test environment:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/environments/test.rb
</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_configure'>configure</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_support'>active_support</span>.<span class='id identifier rubyid_test_order'>test_order</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_sorted'>sorted</span> <span class='comment'># or `:random` if you prefer
</span><span class='kw'>end</span></code></pre>

<h3>Serialized attributes</h3>

<p>When using a custom coder (e.g. <code>serialize :metadata, JSON</code>),
assigning <code>nil</code> to a serialized attribute will save it to the database
as <code>NULL</code> instead of passing the <code>nil</code> value through the coder (e.g. <code>&quot;null&quot;</code>
when using the <code>JSON</code> coder).</p>

<h3>Production log level</h3>

<p>In Rails 5, the default log level for the production environment will be changed
to <code>:debug</code> (from <code>:info</code>). To preserve the current default, add the following
line to your <code>production.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Set to `:info` to match the current default, or set to `:debug` to opt-into
</span><span class='comment'># the future default.
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_log_level'>log_level</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_info'>info</span></code></pre>

<h3><code>after_bundle</code> in Rails templates</h3>

<p>If you have a Rails template that adds all the files in version control, it
fails to add the generated binstubs because it gets executed before Bundler:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># template.rb
</span><span class='id identifier rubyid_generate'>generate</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_scaffold'>scaffold</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>person name:string</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_route'>route</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>root to: &#39;people#index&#39;</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_rake'>rake</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>db:migrate</span><span class='tstring_end'>&quot;</span></span>)

<span class='id identifier rubyid_git'>git</span> <span class='symbeg'>:</span><span class='id identifier rubyid_init'>init</span>
<span class='id identifier rubyid_git'>git</span> <span class='label'>add:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_git'>git</span> <span class='label'>commit:</span> <span class='tstring'><span class='tstring_beg'>%Q{</span><span class='tstring_content'> -m &#39;Initial commit&#39; </span><span class='tstring_end'>}</span></span></code></pre>

<p>You can now wrap the <code>git</code> calls in an <code>after_bundle</code> block. It will be run
after the binstubs have been generated.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># template.rb
</span><span class='id identifier rubyid_generate'>generate</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_scaffold'>scaffold</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>person name:string</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_route'>route</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>root to: &#39;people#index&#39;</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_rake'>rake</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>db:migrate</span><span class='tstring_end'>&quot;</span></span>)

<span class='id identifier rubyid_after_bundle'>after_bundle</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_git'>git</span> <span class='symbeg'>:</span><span class='id identifier rubyid_init'>init</span>
  <span class='id identifier rubyid_git'>git</span> <span class='label'>add:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_git'>git</span> <span class='label'>commit:</span> <span class='tstring'><span class='tstring_beg'>%Q{</span><span class='tstring_content'> -m &#39;Initial commit&#39; </span><span class='tstring_end'>}</span></span>
<span class='kw'>end</span></code></pre>

<h3>Rails HTML Sanitizer</h3>

<p>There&#39;s a new choice for sanitizing HTML fragments in your applications. The
venerable html-scanner approach is now officially being deprecated in favor of
<a href="https://github.com/rails/rails-html-sanitizer"><code>Rails HTML Sanitizer</code></a>.</p>

<p>This means the methods <code>sanitize</code>, <code>sanitize_css</code>, <code>strip_tags</code> and
<code>strip_links</code> are backed by a new implementation.</p>

<p>This new sanitizer uses <a href="https://github.com/flavorjones/loofah">Loofah</a> internally. Loofah in turn uses Nokogiri, which
wraps XML parsers written in both C and Java, so sanitization should be faster
no matter which Ruby version you run.</p>

<p>The new version updates <code>sanitize</code>, so it can take a <code>Loofah::Scrubber</code> for
powerful scrubbing.
<a href="https://github.com/flavorjones/loofah#loofahscrubber">See some examples of scrubbers here</a>.</p>

<p>Two new scrubbers have also been added: <code>PermitScrubber</code> and <code>TargetScrubber</code>.
Read the <a href="https://github.com/rails/rails-html-sanitizer">gem&#39;s readme</a> for more information.</p>

<p>The documentation for <code>PermitScrubber</code> and <code>TargetScrubber</code> explains how you
can gain complete control over when and how elements should be stripped.</p>

<p>If your application needs to use the old sanitizer implementation, include <code>rails-deprecated_sanitizer</code> in your <code>Gemfile</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rails-deprecated_sanitizer</span><span class='tstring_end'>&#39;</span></span></code></pre>

<h3>Rails DOM Testing</h3>

<p>The <a href="https://api.rubyonrails.org/v4.1/classes/ActionDispatch/Assertions/TagAssertions.html"><code>TagAssertions</code> module</a> (containing methods such as <code>assert_tag</code>), <a href="https://github.com/rails/rails/blob/6061472b8c310158a2a2e8e9a6b81a1aef6b60fe/actionpack/lib/action_dispatch/testing/assertions/dom.rb">has been deprecated</a> in favor of the <code>assert_select</code> methods from the <code>SelectorAssertions</code> module, which has been extracted into the <a href="https://github.com/rails/rails-dom-testing">rails-dom-testing gem</a>.</p>

<h3>Masked Authenticity Tokens</h3>

<p>In order to mitigate SSL attacks, <code>form_authenticity_token</code> is now masked so that it varies with each request.  Thus, tokens are validated by unmasking and then decrypting.  As a result, any strategies for verifying requests from non-rails forms that relied on a static session CSRF token have to take this into account.</p>

<h3>Action Mailer</h3>

<p>Previously, calling a mailer method on a mailer class will result in the
corresponding instance method being executed directly. With the introduction of
Active Job and <code>#deliver_later</code>, this is no longer true. In Rails 4.2, the
invocation of the instance methods are deferred until either <code>deliver_now</code> or
<code>deliver_later</code> is called. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Notifier</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionMailer.html" title="ActionMailer (module)">ActionMailer</a></span><span class='op'>::</span><span class='const'><a href="ActionMailer/Base.html" title="ActionMailer::Base (class)">Base</a></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_notify'>notify</span>(<span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='op'>...</span>)
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Called</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_mail'>mail</span>(<span class='label'>to:</span> <span class='id identifier rubyid_user'>user</span>.<span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='op'>...</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_mail'>mail</span> <span class='op'>=</span> <span class='const'>Notifier</span>.<span class='id identifier rubyid_notify'>notify</span>(<span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='op'>...</span>) <span class='comment'># Notifier#notify is not yet called at this point
</span><span class='id identifier rubyid_mail'>mail</span> <span class='op'>=</span> <span class='id identifier rubyid_mail'>mail</span>.<span class='id identifier rubyid_deliver_now'>deliver_now</span>           <span class='comment'># Prints &quot;Called&quot;</span></code></pre>

<p>This should not result in any noticeable differences for most applications.
However, if you need some non-mailer methods to be executed synchronously, and
you were previously relying on the synchronous proxying behavior, you should
define them as class methods on the mailer class directly:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Notifier</span> <span class='op'>&lt;</span> <span class='const'><a href="ActionMailer.html" title="ActionMailer (module)">ActionMailer</a></span><span class='op'>::</span><span class='const'><a href="ActionMailer/Base.html" title="ActionMailer::Base (class)">Base</a></span>
  <span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_broadcast_notifications'>broadcast_notifications</span>(<span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='op'>...</span>)
    <span class='id identifier rubyid_users'>users</span>.<span class='id identifier rubyid_each'>each</span> { <span class='op'>|</span><span class='id identifier rubyid_user'>user</span><span class='op'>|</span> <span class='const'>Notifier</span>.<span class='id identifier rubyid_notify'>notify</span>(<span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='op'>...</span>) }
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<h3>Foreign Key Support</h3>

<p>The migration DSL has been expanded to support foreign key definitions. If
you&#39;ve been using the Foreigner gem, you might want to consider removing it.
Note that the foreign key support of Rails is a subset of Foreigner. This means
that not every Foreigner definition can be fully replaced by its Rails
migration DSL counterpart.</p>

<p>The migration procedure is as follows:</p>

<ol>
<li>remove <code>gem &quot;foreigner&quot;</code> from the <code>Gemfile</code>.</li>
<li>run <code>bundle install</code>.</li>
<li>run <code>bin/rake db:schema:dump</code>.</li>
<li>make sure that <code>db/schema.rb</code> contains every foreign key definition with
the necessary options.</li>
</ol>

<h2>Upgrading from Rails 4.0 to Rails 4.1</h2>

<h3>CSRF protection from remote <code>&lt;script&gt;</code> tags</h3>

<p>Or, &quot;whaaat my tests are failing!!!?&quot; or &quot;my <code>&lt;script&gt;</code> widget is busted!!&quot;</p>

<p>Cross-site request forgery (CSRF) protection now covers GET requests with
JavaScript responses, too. This prevents a third-party site from remotely
referencing your JavaScript with a <code>&lt;script&gt;</code> tag to extract sensitive data.</p>

<p>This means that your functional and integration tests that use</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='symbeg'>:</span><span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='label'>format:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_js'>js</span></code></pre>

<p>will now trigger CSRF protection. Switch to</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_xhr'>xhr</span> <span class='symbeg'>:</span><span class='id identifier rubyid_get'>get</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='label'>format:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_js'>js</span></code></pre>

<p>to explicitly test an <code>XmlHttpRequest</code>.</p>

<p>NOTE: Your own <code>&lt;script&gt;</code> tags are treated as cross-origin and blocked by
default, too. If you really mean to load JavaScript from <code>&lt;script&gt;</code> tags,
you must now explicitly skip CSRF protection on those actions.</p>

<h3>Spring</h3>

<p>If you want to use Spring as your application preloader you need to:</p>

<ol>
<li>Add <code>gem &#39;spring&#39;, group: :development</code> to your <code>Gemfile</code>.</li>
<li>Install spring using <code>bundle install</code>.</li>
<li>Generate the Spring binstub with <code>bundle exec spring binstub</code>.</li>
</ol>

<p>NOTE: User defined rake tasks will run in the <code>development</code> environment by
default. If you want them to run in other environments consult the
<a href="https://github.com/rails/spring#rake">Spring README</a>.</p>

<h3><code>config/secrets.yml</code></h3>

<p>If you want to use the new <code>secrets.yml</code> convention to store your application&#39;s
secrets, you need to:</p>

<ol>
<li><p>Create a <code>secrets.yml</code> file in your <code>config</code> folder with the following content:</p>

<pre class="code yaml"><code class="yaml">development:
  secret_key_base:

test:
  secret_key_base:

production:
  secret_key_base: &lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;
</code></pre></li>
<li><p>Use your existing <code>secret_key_base</code> from the <code>secret_token.rb</code> initializer to
set the <code>SECRET_KEY_BASE</code> environment variable for whichever users running the
Rails application in production. Alternatively, you can simply copy the existing
<code>secret_key_base</code> from the <code>secret_token.rb</code> initializer to <code>secrets.yml</code>
under the <code>production</code> section, replacing <code>&lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</code>.</p></li>
<li><p>Remove the <code>secret_token.rb</code> initializer.</p></li>
<li><p>Use <code>rake secret</code> to generate new keys for the <code>development</code> and <code>test</code> sections.</p></li>
<li><p>Restart your server.</p></li>
</ol>

<h3>Changes to test helper</h3>

<p>If your test helper contains a call to
<a href="ActiveRecord/Migration.html#check_pending!-class_method" title="ActiveRecord::Migration.check_pending! (method)">ActiveRecord::Migration.check_pending!</a> this can be removed. The check
is now done automatically when you <code>require &quot;rails/test_help&quot;</code>, although
leaving this line in your helper is not harmful in any way.</p>

<h3>Cookies serializer</h3>

<p>Applications created before Rails 4.1 uses <code>Marshal</code> to serialize cookie values into
the signed and encrypted cookie jars. If you want to use the new <code>JSON</code>-based format
in your application, you can add an initializer file with the following content:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_dispatch'>action_dispatch</span>.<span class='id identifier rubyid_cookies_serializer'>cookies_serializer</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_hybrid'>hybrid</span></code></pre>

<p>This would transparently migrate your existing <code>Marshal</code>-serialized cookies into the
new <code>JSON</code>-based format.</p>

<p>When using the <code>:json</code> or <code>:hybrid</code> serializer, you should beware that not all
Ruby objects can be serialized as JSON. For example, <a href="Date.html" title="Date (class)"><code>Date</code></a> and <a href="Time.html" title="Time (class)"><code>Time</code></a> objects
will be serialized as strings, and <a href="Hash.html" title="Hash (class)"><code>Hash</code></a>es will have their keys stringified.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CookiesController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_set_cookie'>set_cookie</span>
    <span class='id identifier rubyid_cookies'>cookies</span>.<span class='id identifier rubyid_encrypted'>encrypted</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_expiration_date'>expiration_date</span>] <span class='op'>=</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span>.<span class='id identifier rubyid_tomorrow'><a href="Date.html#tomorrow-class_method" title="Date.tomorrow (method)">tomorrow</a></span> <span class='comment'># =&gt; Thu, 20 Mar 2014
</span>    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>read_cookie</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_read_cookie'>read_cookie</span>
    <span class='id identifier rubyid_cookies'>cookies</span>.<span class='id identifier rubyid_encrypted'>encrypted</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_expiration_date'>expiration_date</span>] <span class='comment'># =&gt; &quot;2014-03-20&quot;
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>It&#39;s advisable that you only store simple data (strings and numbers) in cookies.
If you have to store complex objects, you would need to handle the conversion
manually when reading the values on subsequent requests.</p>

<p>If you use the cookie session store, this would apply to the <code>session</code> and
<code>flash</code> hash as well.</p>

<h3>Flash structure changes</h3>

<p>Flash message keys are
<a href="https://github.com/rails/rails/commit/a668beffd64106a1e1fedb71cc25eaaa11baf0c1">normalized to strings</a>. They
can still be accessed using either symbols or strings. Looping through the flash
will always yield string keys:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flash'>flash</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>string</span><span class='tstring_end'>&quot;</span></span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a string</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_flash'>flash</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_symbol'>symbol</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a symbol</span><span class='tstring_end'>&quot;</span></span>

<span class='comment'># Rails &lt; 4.1
</span><span class='id identifier rubyid_flash'>flash</span>.<span class='id identifier rubyid_keys'>keys</span> <span class='comment'># =&gt; [&quot;string&quot;, :symbol]
</span>
<span class='comment'># Rails &gt;= 4.1
</span><span class='id identifier rubyid_flash'>flash</span>.<span class='id identifier rubyid_keys'>keys</span> <span class='comment'># =&gt; [&quot;string&quot;, &quot;symbol&quot;]</span></code></pre>

<p>Make sure you are comparing Flash message keys against strings.</p>

<h3>Changes in JSON handling</h3>

<p>There are a few major changes related to JSON handling in Rails 4.1.</p>

<h4>MultiJSON removal</h4>

<p>MultiJSON has reached its <a href="https://github.com/rails/rails/pull/10576">end-of-life</a>
and has been removed from Rails.</p>

<p>If your application currently depends on MultiJSON directly, you have a few options:</p>

<ol>
<li><p>Add &#39;multi_json&#39; to your <code>Gemfile</code>. Note that this might cease to work in the future</p></li>
<li><p>Migrate away from MultiJSON by using <code>obj.to_json</code>, and <code>JSON.parse(str)</code> instead.</p></li>
</ol>

<p>WARNING: Do not simply replace <code>MultiJson.dump</code> and <code>MultiJson.load</code> with
<code>JSON.dump</code> and <code>JSON.load</code>. These JSON gem APIs are meant for serializing and
deserializing arbitrary Ruby objects and are generally <a href="https://ruby-doc.org/stdlib-2.2.2/libdoc/json/rdoc/JSON.html#method-i-load">unsafe</a>.</p>

<h4>JSON gem compatibility</h4>

<p>Historically, Rails had some compatibility issues with the JSON gem. Using
<code>JSON.generate</code> and <code>JSON.dump</code> inside a Rails application could produce
unexpected errors.</p>

<p>Rails 4.1 fixed these issues by isolating its own encoder from the JSON gem. The
JSON gem APIs will function as normal, but they will not have access to any
Rails-specific features. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>FooBar</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_as_json'>as_json</span>(<span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='kw'>nil</span>)
    { <span class='label'>foo:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&#39;</span></span> }
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code irb"><code class="irb">irb&gt; FooBar.new.to_json
=&gt; &quot;{\&quot;foo\&quot;:\&quot;bar\&quot;}&quot;
irb&gt; JSON.generate(FooBar.new, quirks_mode: true)
=&gt; &quot;\&quot;#&lt;FooBar:0x007fa80a481610&gt;\&quot;&quot;
</code></pre>

<h4>New JSON encoder</h4>

<p>The JSON encoder in Rails 4.1 has been rewritten to take advantage of the JSON
gem. For most applications, this should be a transparent change. However, as
part of the rewrite, the following features have been removed from the encoder:</p>

<ol>
<li>Circular data structure detection</li>
<li>Support for the <code>encode_json</code> hook</li>
<li>Option to encode <a href="BigDecimal.html" title="BigDecimal (class)"><code>BigDecimal</code></a> objects as numbers instead of strings</li>
</ol>

<p>If your application depends on one of these features, you can get them back by
adding the <a href="https://github.com/rails/activesupport-json_encoder"><code>activesupport-json_encoder</code></a>
gem to your <code>Gemfile</code>.</p>

<h4>JSON representation of Time objects</h4>

<p><code>#as_json</code> for objects with time component (<a href="Time.html" title="Time (class)"><code>Time</code></a>, <a href="DateTime.html" title="DateTime (class)"><code>DateTime</code></a>, <a href="ActiveSupport/TimeWithZone.html" title="ActiveSupport::TimeWithZone (class)"><code>::ActiveSupport::TimeWithZone</code></a>)
now returns millisecond precision by default. If you need to keep old behavior with no millisecond
precision, set the following in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/JSON.html" title="ActiveSupport::JSON (module)">JSON</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/JSON/Encoding.html" title="ActiveSupport::JSON::Encoding (module)">Encoding</a></span>.<span class='id identifier rubyid_time_precision'><a href="ActiveSupport/JSON/Encoding.html#time_precision-class_method" title="ActiveSupport::JSON::Encoding.time_precision (method)">time_precision</a></span> <span class='op'>=</span> <span class='int'>0</span></code></pre>

<h3>Usage of <code>return</code> within inline callback blocks</h3>

<p>Previously, Rails allowed inline callback blocks to use <code>return</code> this way:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ReadOnlyModel</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_save'>before_save</span> { <span class='kw'>return</span> <span class='kw'>false</span> } <span class='comment'># BAD
</span><span class='kw'>end</span></code></pre>

<p>This behavior was never intentionally supported. Due to a change in the internals
of <a href="ActiveSupport/Callbacks.html" title="ActiveSupport::Callbacks (module)"><code>::ActiveSupport::Callbacks</code></a>, this is no longer allowed in Rails 4.1. Using a
<code>return</code> statement in an inline callback block causes a <code>LocalJumpError</code> to
be raised when the callback is executed.</p>

<p>Inline callback blocks using <code>return</code> can be refactored to evaluate to the
returned value:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ReadOnlyModel</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_save'>before_save</span> { <span class='kw'>false</span> } <span class='comment'># GOOD
</span><span class='kw'>end</span></code></pre>

<p>Alternatively, if <code>return</code> is preferred it is recommended to explicitly define
a method:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ReadOnlyModel</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_before_save'>before_save</span> <span class='symbeg'>:</span><span class='id identifier rubyid_before_save_callback'>before_save_callback</span> <span class='comment'># GOOD
</span>
  <span class='id identifier rubyid_private'>private</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_before_save_callback'>before_save_callback</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>This change applies to most places in Rails where callbacks are used, including
Active Record and Active Model callbacks, as well as filters in Action
Controller (e.g. <code>before_action</code>).</p>

<p>See <a href="https://github.com/rails/rails/pull/13271">this pull request</a> for more
details.</p>

<h3>Methods defined in Active Record fixtures</h3>

<p>Rails 4.1 evaluates each fixture&#39;s ERB in a separate context, so helper methods
defined in a fixture will not be available in other fixtures.</p>

<p>Helper methods that are used in multiple fixtures should be defined on modules
included in the newly introduced <a href="ActiveRecord/FixtureSet.html#context_class-class_method" title="ActiveRecord::FixtureSet.context_class (method)">ActiveRecord::FixtureSet.context_class</a>, in
<code>test_helper.rb</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>FixtureFileHelpers</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_file_sha'>file_sha</span>(<span class='id identifier rubyid_path'>path</span>)
    <span class='const'><a href="Digest.html" title="Digest (module)">Digest</a></span><span class='op'>::</span><span class='const'>SHA2</span>.<span class='id identifier rubyid_hexdigest'>hexdigest</span>(<span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_read'>read</span>(<span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_root'><a href="Rails.html#root-class_method" title="Rails.root (method)">root</a></span>.<span class='id identifier rubyid_join'>join</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test/fixtures</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_path'>path</span>)))
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/FixtureSet.html" title="ActiveRecord::FixtureSet (class)">FixtureSet</a></span>.<span class='id identifier rubyid_context_class'><a href="ActiveRecord/FixtureSet.html#context_class-class_method" title="ActiveRecord::FixtureSet.context_class (method)">context_class</a></span>.<span class='id identifier rubyid_include'>include</span> <span class='const'>FixtureFileHelpers</span></code></pre>

<h3>I18n enforcing available locales</h3>

<p>Rails 4.1 now defaults the I18n option <code>enforce_available_locales</code> to <code>true</code>. This
means that it will make sure that all locales passed to it must be declared in
the <code>available_locales</code> list.</p>

<p>To disable it (and allow I18n to accept <em>any</em> locale option) add the following
configuration to your application:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_i18n'>i18n</span>.<span class='id identifier rubyid_enforce_available_locales'>enforce_available_locales</span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>

<p>Note that this option was added as a security measure, to ensure user input
cannot be used as locale information unless it is previously known. Therefore,
it&#39;s recommended not to disable this option unless you have a strong reason for
doing so.</p>

<h3>Mutator methods called on Relation</h3>

<p><code>Relation</code> no longer has mutator methods like <code>#map!</code> and <code>#delete_if</code>. Convert
to an <a href="Array.html" title="Array (class)"><code>Array</code></a> by calling <code>#to_a</code> before using these methods.</p>

<p>It intends to prevent odd bugs and confusion in code that call mutator
methods directly on the <code>Relation</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Instead of this
</span><span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Hank Moody</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_compact!'>compact!</span>

<span class='comment'># Now you have to do this
</span><span class='id identifier rubyid_authors'>authors</span> <span class='op'>=</span> <span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Hank Moody</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_to_a'>to_a</span>
<span class='id identifier rubyid_authors'>authors</span>.<span class='id identifier rubyid_compact!'>compact!</span></code></pre>

<h3>Changes on Default Scopes</h3>

<p>Default scopes are no longer overridden by chained conditions.</p>

<p>In previous versions when you defined a <code>default_scope</code> in a model
it was overridden by chained conditions in the same field. Now it
is merged like any other scope.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_default_scope'>default_scope</span> { <span class='id identifier rubyid_where'>where</span> <span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pending</span><span class='tstring_end'>&#39;</span></span> }
  <span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_active'>active</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>active</span><span class='tstring_end'>&#39;</span></span> }
  <span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_inactive'>inactive</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>inactive</span><span class='tstring_end'>&#39;</span></span> }
<span class='kw'>end</span>

<span class='const'>User</span>.<span class='id identifier rubyid_all'>all</span>
<span class='comment'># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;pending&#39;
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_active'>active</span>
<span class='comment'># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;active&#39;
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>inactive</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;inactive&#39;</span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_default_scope'>default_scope</span> { <span class='id identifier rubyid_where'>where</span> <span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pending</span><span class='tstring_end'>&#39;</span></span> }
  <span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_active'>active</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>active</span><span class='tstring_end'>&#39;</span></span> }
  <span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_inactive'>inactive</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>inactive</span><span class='tstring_end'>&#39;</span></span> }
<span class='kw'>end</span>

<span class='const'>User</span>.<span class='id identifier rubyid_all'>all</span>
<span class='comment'># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;pending&#39;
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_active'>active</span>
<span class='comment'># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;pending&#39; AND &quot;users&quot;.&quot;state&quot; = &#39;active&#39;
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>inactive</span><span class='tstring_end'>&#39;</span></span>)
<span class='comment'># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;pending&#39; AND &quot;users&quot;.&quot;state&quot; = &#39;inactive&#39;</span></code></pre>

<p>To get the previous behavior it is needed to explicitly remove the
<code>default_scope</code> condition using <code>unscoped</code>, <code>unscope</code>, <code>rewhere</code> or
<code>except</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_default_scope'>default_scope</span> { <span class='id identifier rubyid_where'>where</span> <span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pending</span><span class='tstring_end'>&#39;</span></span> }
  <span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_active'>active</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_unscope'>unscope</span>(<span class='label'>where:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_state'>state</span>).<span class='id identifier rubyid_where'>where</span>(<span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>active</span><span class='tstring_end'>&#39;</span></span>) }
  <span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_inactive'>inactive</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_rewhere'>rewhere</span> <span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>inactive</span><span class='tstring_end'>&#39;</span></span> }
<span class='kw'>end</span>

<span class='const'>User</span>.<span class='id identifier rubyid_all'>all</span>
<span class='comment'># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;pending&#39;
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_active'>active</span>
<span class='comment'># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;active&#39;
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_inactive'>inactive</span>
<span class='comment'># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;inactive&#39;</span></code></pre>

<h3>Rendering content from string</h3>

<p>Rails 4.1 introduces <code>:plain</code>, <code>:html</code>, and <code>:body</code> options to <code>render</code>. Those
options are now the preferred way to render string-based content, as it allows
you to specify which content type you want the response sent as.</p>

<ul>
<li><code>render :plain</code> will set the content type to <code>text/plain</code></li>
<li><code>render :html</code> will set the content type to <code>text/html</code></li>
<li><code>render :body</code> will <em>not</em> set the content type header.</li>
</ul>

<p>From the security standpoint, if you don&#39;t expect to have any markup in your
response body, you should be using <code>render :plain</code> as most browsers will escape
unsafe content in the response for you.</p>

<p>We will be deprecating the use of <code>render :text</code> in a future version. So please
start using the more precise <code>:plain</code>, <code>:html</code>, and <code>:body</code> options instead.
Using <code>render :text</code> may pose a security risk, as the content is sent as
<code>text/html</code>.</p>

<h3>PostgreSQL json and hstore datatypes</h3>

<p>Rails 4.1 will map <code>json</code> and <code>hstore</code> columns to a string-keyed Ruby <a href="Hash.html" title="Hash (class)"><code>Hash</code></a>.
In earlier versions, a <a href="#HashWithIndifferentAccess-constant" title="HashWithIndifferentAccess (constant)">HashWithIndifferentAccess</a> was used. This means that
symbol access is no longer supported. This is also the case for
<code>store_accessors</code> based on top of <code>json</code> or <code>hstore</code> columns. Make sure to use
string keys consistently.</p>

<h3>Explicit block use for <a href="ActiveSupport/Callbacks.html" title="ActiveSupport::Callbacks (module)"><code>::ActiveSupport::Callbacks</code></a></h3>

<p>Rails 4.1 now expects an explicit block to be passed when calling
<code>ActiveSupport::Callbacks.set_callback</code>. This change stems from
<a href="ActiveSupport/Callbacks.html" title="ActiveSupport::Callbacks (module)"><code>::ActiveSupport::Callbacks</code></a> being largely rewritten for the 4.1 release.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Previously in Rails 4.0
</span><span class='id identifier rubyid_set_callback'>set_callback</span> <span class='symbeg'>:</span><span class='id identifier rubyid_save'>save</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_around'>around</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_stuff'>stuff</span><span class='semicolon'>;</span> <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_block'>block</span>.<span class='id identifier rubyid_call'>call</span><span class='semicolon'>;</span> <span class='id identifier rubyid_stuff'>stuff</span> }

<span class='comment'># Now in Rails 4.1
</span><span class='id identifier rubyid_set_callback'>set_callback</span> <span class='symbeg'>:</span><span class='id identifier rubyid_save'>save</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_around'>around</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_block'>block</span>) <span class='tlambeg'>{</span> <span class='id identifier rubyid_stuff'>stuff</span><span class='semicolon'>;</span> <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_block'>block</span>.<span class='id identifier rubyid_call'>call</span><span class='semicolon'>;</span> <span class='id identifier rubyid_stuff'>stuff</span> }</code></pre>

<h2>Upgrading from Rails 3.2 to Rails 4.0</h2>

<p>If your application is currently on any version of Rails older than 3.2.x, you should upgrade to Rails 3.2 before attempting one to Rails 4.0.</p>

<p>The following changes are meant for upgrading your application to Rails 4.0.</p>

<h3>HTTP PATCH</h3>

<p>Rails 4 now uses <code>PATCH</code> as the primary HTTP verb for updates when a RESTful
resource is declared in <code>config/routes.rb</code>. The <code>update</code> action is still used,
and <code>PUT</code> requests will continue to be routed to the <code>update</code> action as well.
So, if you&#39;re using only the standard RESTful routes, no changes need to be made:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_resources'>resources</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span></code></pre>

<pre class="code xml"><code class="xml">&lt;%= form_for @user do |f| %&gt;
</code></pre>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UsersController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_update'>update</span>
    <span class='comment'># No change needed; PATCH will be preferred, and PUT will still work.
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>However, you will need to make a change if you are using <code>form_for</code> to update
a resource in conjunction with a custom route using the <code>PUT</code> HTTP method:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_resources'>resources</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_put'>put</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update_name'>update_name</span><span class='comma'>,</span> <span class='label'>on:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span>
<span class='kw'>end</span></code></pre>

<pre class="code xml"><code class="xml">&lt;%= form_for [ :update_name, @user ] do |f| %&gt;
</code></pre>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UsersController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_update_name'>update_name</span>
    <span class='comment'># Change needed; form_for will try to use a non-existent PATCH route.
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>If the action is not being used in a public API and you are free to change the
HTTP method, you can update your route to use <code>patch</code> instead of <code>put</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_resources'>resources</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_patch'>patch</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update_name'>update_name</span><span class='comma'>,</span> <span class='label'>on:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span>
<span class='kw'>end</span></code></pre>

<p><code>PUT</code> requests to <code>/users/:id</code> in Rails 4 get routed to <code>update</code> as they are
today. So, if you have an API that gets real PUT requests it is going to work.
The router also routes <code>PATCH</code> requests to <code>/users/:id</code> to the <code>update</code> action.</p>

<p>If the action is being used in a public API and you can&#39;t change to HTTP method
being used, you can update your form to use the <code>PUT</code> method instead:</p>

<pre class="code xml"><code class="xml">&lt;%= form_for [ :update_name, @user ], method: :put do |f| %&gt;
</code></pre>

<p>For more on PATCH and why this change was made, see <a href="https://weblog.rubyonrails.org/2012/2/26/edge-rails-patch-is-the-new-primary-http-method-for-updates/">this post</a>
on the Rails blog.</p>

<h4>A note about media types</h4>

<p>The errata for the <code>PATCH</code> verb <a href="http://www.rfc-editor.org/errata_search.php?rfc=5789">specifies that a &#39;diff&#39; media type should be
used with <code>PATCH</code></a>. One
such format is <a href="https://tools.ietf.org/html/rfc6902">JSON Patch</a>. While Rails
does not support JSON Patch natively, it&#39;s easy enough to add support:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># in your controller:
</span><span class='kw'>def</span> <span class='id identifier rubyid_update'>update</span>
  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
    <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_json'>json</span> <span class='kw'>do</span>
      <span class='comment'># perform a partial update
</span>      <span class='ivar'>@article</span>.<span class='id identifier rubyid_update'>update</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_article'>article</span>]
    <span class='kw'>end</span>

    <span class='id identifier rubyid_format'>format</span>.<span class='id identifier rubyid_json_patch'>json_patch</span> <span class='kw'>do</span>
      <span class='comment'># perform sophisticated change
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/initializers/json_patch.rb
</span><span class='const'><a href="Mime.html" title="Mime (module)">Mime</a></span><span class='op'>::</span><span class='const'><a href="Mime/Type.html" title="Mime::Type (class)">Type</a></span>.<span class='id identifier rubyid_register'><a href="Mime/Type.html#register-class_method" title="Mime::Type.register (method)">register</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/json-patch+json</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_json_patch'>json_patch</span></code></pre>

<p>As JSON Patch was only recently made into an RFC, there aren&#39;t a lot of great
Ruby libraries yet. Aaron Patterson&#39;s
<a href="https://github.com/tenderlove/hana">hana</a> is one such gem, but doesn&#39;t have
full support for the last few changes in the specification.</p>

<h3>Gemfile</h3>

<p>Rails 4.0 removed the <code>assets</code> group from <code>Gemfile</code>. You&#39;d need to remove that
line from your <code>Gemfile</code> when upgrading. You should also update your application
file (in <code>config/application.rb</code>):</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Require the gems listed in Gemfile, including any gems
</span><span class='comment'># you&#39;ve limited to :test, :development, or :production.
</span><span class='const'>Bundler</span>.<span class='id identifier rubyid_require'>require</span>(<span class='op'>*</span><span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_groups'><a href="Rails.html#groups-class_method" title="Rails.groups (method)">groups</a></span>)</code></pre>

<h3>vendor/plugins</h3>

<p>Rails 4.0 no longer supports loading plugins from <code>vendor/plugins</code>. You must replace any plugins by extracting them to gems and adding them to your <code>Gemfile</code>. If you choose not to make them gems, you can move them into, say, <code>lib/my_plugin/*</code> and add an appropriate initializer in <code>config/initializers/my_plugin.rb</code>.</p>

<h3>Active Record</h3>

<ul>
<li><p>Rails 4.0 has removed the identity map from Active Record, due to <a href="https://github.com/rails/rails/commit/302c912bf6bcd0fa200d964ec2dc4a44abe328a6">some inconsistencies with associations</a>. If you have manually enabled it in your application, you will have to remove the following config that has no effect anymore: <code>config.active_record.identity_map</code>.</p></li>
<li><p>The <code>delete</code> method in collection associations can now receive <a href="Integer.html" title="Integer (class)"><code>Integer</code></a> or <a href="String.html" title="String (class)"><code>String</code></a> arguments as record ids, besides records, pretty much like the <code>destroy</code> method does. Previously it raised <a href="ActiveRecord/AssociationTypeMismatch.html" title="ActiveRecord::AssociationTypeMismatch (class)"><code>::ActiveRecord::AssociationTypeMismatch</code></a> for such arguments. From Rails 4.0 on <code>delete</code> automatically tries to find the records matching the given ids before deleting them.</p></li>
<li><p>In Rails 4.0 when a column or a table is renamed the related indexes are also renamed. If you have migrations which rename the indexes, they are no longer needed.</p></li>
<li><p>Rails 4.0 has changed <code>serialized_attributes</code> and <code>attr_readonly</code> to class methods only. You shouldn&#39;t use instance methods since it&#39;s now deprecated. You should change them to use class methods, e.g. <code>self.serialized_attributes</code> to <code>self.class.serialized_attributes</code>.</p></li>
<li><p>When using the default coder, assigning <code>nil</code> to a serialized attribute will save it
to the database as <code>NULL</code> instead of passing the <code>nil</code> value through YAML (<code>&quot;--- \n...\n&quot;</code>).</p></li>
<li><p>Rails 4.0 has removed <code>attr_accessible</code> and <code>attr_protected</code> feature in favor of Strong Parameters. You can use the <a href="https://github.com/rails/protected_attributes">Protected Attributes gem</a> for a smooth upgrade path.</p></li>
<li><p>If you are not using Protected Attributes, you can remove any options related to
this gem such as <code>whitelist_attributes</code> or <code>mass_assignment_sanitizer</code> options.</p></li>
<li><p>Rails 4.0 requires that scopes use a callable object such as a Proc or lambda:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_active'>active</span><span class='comma'>,</span> <span class='id identifier rubyid_where'>where</span>(<span class='label'>active:</span> <span class='kw'>true</span>)

<span class='comment'># becomes
</span><span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_active'>active</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>active:</span> <span class='kw'>true</span> }</code></pre></li>
<li><p>Rails 4.0 has deprecated <code>ActiveRecord::Fixtures</code> in favor of <a href="ActiveRecord/FixtureSet.html" title="ActiveRecord::FixtureSet (class)"><code>::ActiveRecord::FixtureSet</code></a>.</p></li>
<li><p>Rails 4.0 has deprecated <code>ActiveRecord::TestCase</code> in favor of <a href="ActiveSupport/TestCase.html" title="ActiveSupport::TestCase (class)"><code>::ActiveSupport::TestCase</code></a>.</p></li>
<li><p>Rails 4.0 has deprecated the old-style hash based finder API. This means that
methods which previously accepted &quot;finder options&quot; no longer do.  For example, <code>Book.find(:all, conditions: { name: &#39;1984&#39; })</code> has been deprecated in favor of <code>Book.where(name: &#39;1984&#39;)</code></p></li>
<li><p>All dynamic methods except for <code>find_by_...</code> and <code>find_by_...!</code> are deprecated.
Here&#39;s how you can handle the changes:</p>

<ul>
<li><code>find_all_by_...</code>           becomes <code>where(...)</code>.</li>
<li><code>find_last_by_...</code>          becomes <code>where(...).last</code>.</li>
<li><code>scoped_by_...</code>             becomes <code>where(...)</code>.</li>
<li><code>find_or_initialize_by_...</code> becomes <code>find_or_initialize_by(...)</code>.</li>
<li><code>find_or_create_by_...</code>     becomes <code>find_or_create_by(...)</code>.</li>
</ul></li>
<li><p>Note that <code>where(...)</code> returns a relation, not an array like the old finders. If you require an <a href="Array.html" title="Array (class)"><code>Array</code></a>, use <code>where(...).to_a</code>.</p></li>
<li><p>These equivalent methods may not execute the same SQL as the previous implementation.</p></li>
<li><p>To re-enable the old finders, you can use the <a href="https://github.com/rails/activerecord-deprecated_finders">activerecord-deprecated_finders gem</a>.</p></li>
<li><p>Rails 4.0 has changed to default join table for <code>has_and_belongs_to_many</code> relations to strip the common prefix off the second table name. Any existing <code>has_and_belongs_to_many</code> relationship between models with a common prefix must be specified with the <code>join_table</code> option. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>CatalogCategory</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_catalog_products'>catalog_products</span><span class='comma'>,</span> <span class='label'>join_table:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>catalog_categories_catalog_products</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='const'>CatalogProduct</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_catalog_categories'>catalog_categories</span><span class='comma'>,</span> <span class='label'>join_table:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>catalog_categories_catalog_products</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></code></pre></li>
<li><p>Note that the prefix takes scopes into account as well, so relations between <code>Catalog::Category</code> and <code>Catalog::Product</code> or <code>Catalog::Category</code> and <code>CatalogProduct</code> need to be updated similarly.</p></li>
</ul>

<h3>Active Resource</h3>

<p>Rails 4.0 extracted Active Resource to its own gem. If you still need the feature you can add the <a href="https://github.com/rails/activeresource">Active Resource gem</a> in your <code>Gemfile</code>.</p>

<h3>Active Model</h3>

<ul>
<li><p>Rails 4.0 has changed how errors attach with the <a href="ActiveModel/Validations/ConfirmationValidator.html" title="ActiveModel::Validations::ConfirmationValidator (class)"><code>::ActiveModel::Validations::ConfirmationValidator</code></a>. Now when confirmation validations fail, the error will be attached to <code>:#{attribute}_confirmation</code> instead of <code>attribute</code>.</p></li>
<li><p>Rails 4.0 has changed <code>ActiveModel::Serializers::JSON.include_root_in_json</code> default value to <code>false</code>. Now, Active Model Serializers and Active Record objects have the same default behavior. This means that you can comment or remove the following option in the <code>config/initializers/wrap_parameters.rb</code> file:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Disable root element in JSON by default.
</span><span class='comment'># ActiveSupport.on_load(:active_record) do
</span><span class='comment'>#   self.include_root_in_json = false
</span><span class='comment'># end</span></code></pre></li>
</ul>

<h3>Action Pack</h3>

<ul>
<li><p>Rails 4.0 introduces <a href="ActiveSupport/KeyGenerator.html" title="ActiveSupport::KeyGenerator (class)"><code>::ActiveSupport::KeyGenerator</code></a> and uses this as a base from which to generate and verify signed cookies (among other things). Existing signed cookies generated with Rails 3.x will be transparently upgraded if you leave your existing <code>secret_token</code> in place and add the new <code>secret_key_base</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/initializers/secret_token.rb
</span><span class='const'>Myapp</span><span class='op'>::</span><span class='const'>Application</span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_secret_token'>secret_token</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>existing secret token</span><span class='tstring_end'>&#39;</span></span>
<span class='const'>Myapp</span><span class='op'>::</span><span class='const'>Application</span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_secret_key_base'>secret_key_base</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>new secret key base</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>Please note that you should wait to set <code>secret_key_base</code> until you have 100% of your userbase on Rails 4.x and are reasonably sure you will not need to rollback to Rails 3.x. This is because cookies signed based on the new <code>secret_key_base</code> in Rails 4.x are not backwards compatible with Rails 3.x. You are free to leave your existing <code>secret_token</code> in place, not set the new <code>secret_key_base</code>, and ignore the deprecation warnings until you are reasonably sure that your upgrade is otherwise complete.</p>

<p>If you are relying on the ability for external applications or JavaScript to be able to read your Rails app&#39;s signed session cookies (or signed cookies in general) you should not set <code>secret_key_base</code> until you have decoupled these concerns.</p></li>
<li><p>Rails 4.0 encrypts the contents of cookie-based sessions if <code>secret_key_base</code> has been set. Rails 3.x signed, but did not encrypt, the contents of cookie-based session. Signed cookies are &quot;secure&quot; in that they are verified to have been generated by your app and are tamper-proof. However, the contents can be viewed by end users, and encrypting the contents eliminates this caveat/concern without a significant performance penalty.</p>

<p>Please read <a href="https://github.com/rails/rails/pull/9978">Pull Request #9978</a> for details on the move to encrypted session cookies.</p></li>
<li><p>Rails 4.0 removed the <code>ActionController::Base.asset_path</code> option. Use the assets pipeline feature.</p></li>
<li><p>Rails 4.0 has deprecated <code>ActionController::Base.page_cache_extension</code> option. Use <code>ActionController::Base.default_static_extension</code> instead.</p></li>
<li><p>Rails 4.0 has removed Action and Page caching from Action Pack. You will need to add the <code>actionpack-action_caching</code> gem in order to use <code>caches_action</code> and the <code>actionpack-page_caching</code> to use <code>caches_page</code> in your controllers.</p></li>
<li><p>Rails 4.0 has removed the XML parameters parser. You will need to add the <code>actionpack-xml_parser</code> gem if you require this feature.</p></li>
<li><p>Rails 4.0 changes the default <code>layout</code> lookup set using symbols or procs that return nil. To get the &quot;no layout&quot; behavior, return false instead of nil.</p></li>
<li><p>Rails 4.0 changes the default memcached client from <code>memcache-client</code> to <code>dalli</code>. To upgrade, simply add <code>gem &#39;dalli&#39;</code> to your <code>Gemfile</code>.</p></li>
<li><p>Rails 4.0 deprecates the <code>dom_id</code> and <code>dom_class</code> methods in controllers (they are fine in views). You will need to include the <a href="ActionView/RecordIdentifier.html" title="ActionView::RecordIdentifier (module)"><code>::ActionView::RecordIdentifier</code></a> module in controllers requiring this feature.</p></li>
<li><p>Rails 4.0 deprecates the <code>:confirm</code> option for the <code>link_to</code> helper. You should
instead rely on a data attribute (e.g. <code>data: { confirm: &#39;Are you sure?&#39; }</code>).
This deprecation also concerns the helpers based on this one (such as <code>link_to_if</code>
or <code>link_to_unless</code>).</p></li>
<li><p>Rails 4.0 changed how <code>assert_generates</code>, <code>assert_recognizes</code>, and <code>assert_routing</code> work. Now all these assertions raise <code>Assertion</code> instead of <a href="ActionController/RoutingError.html" title="ActionController::RoutingError (class)"><code>::ActionController::RoutingError</code></a>.</p></li>
<li><p>Rails 4.0 raises an <code>ArgumentError</code> if clashing named routes are defined. This can be triggered by explicitly defined named routes or by the <code>resources</code> method. Here are two examples that clash with routes named <code>example_path</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>one</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test#example</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_example'>example</span>
<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>two</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test#example</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_example'>example</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_resources'>resources</span> <span class='symbeg'>:</span><span class='id identifier rubyid_examples'>examples</span>
<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>clashing/:id</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test#example</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_example'>example</span></code></pre>

<p>In the first case, you can simply avoid using the same name for multiple
routes. In the second, you can use the <code>only</code> or <code>except</code> options provided by
the <code>resources</code> method to restrict the routes created as detailed in the
<a href="routing.html#restricting-the-routes-created">Routing Guide</a>.</p></li>
<li><p>Rails 4.0 also changed the way unicode character routes are drawn. Now you can draw unicode character routes directly. If you already draw such routes, you must change them, for example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='const'><a href="Rack.html" title="Rack (module)">Rack</a></span><span class='op'>::</span><span class='const'>Utils</span>.<span class='id identifier rubyid_escape'>escape</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>こんにちは</span><span class='tstring_end'>&#39;</span></span>)<span class='comma'>,</span> <span class='label'>controller:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>welcome</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>index</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>becomes</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>こんにちは</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>controller:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>welcome</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>index</span><span class='tstring_end'>&#39;</span></span></code></pre></li>
<li><p>Rails 4.0 requires that routes using <code>match</code> must specify the request method. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Rails 3.x
</span><span class='id identifier rubyid_match'>match</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>root#index</span><span class='tstring_end'>&#39;</span></span>

<span class='comment'># becomes
</span><span class='id identifier rubyid_match'>match</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>root#index</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>via:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_get'>get</span>

<span class='comment'># or
</span><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>root#index</span><span class='tstring_end'>&#39;</span></span></code></pre></li>
<li><p>Rails 4.0 has removed <code>ActionDispatch::BestStandardsSupport</code> middleware, <code>&lt;!DOCTYPE html&gt;</code> already triggers standards mode per <a href="https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx</a> and ChromeFrame header has been moved to <code>config.action_dispatch.default_headers</code>.</p>

<p>Remember you must also remove any references to the middleware from your application code, for example:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Raise exception
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_middleware'>middleware</span>.<span class='id identifier rubyid_insert_before'>insert_before</span>(<span class='const'><a href="Rack.html" title="Rack (module)">Rack</a></span><span class='op'>::</span><span class='const'>Lock</span><span class='comma'>,</span> <span class='const'><a href="ActionDispatch.html" title="ActionDispatch (module)">ActionDispatch</a></span><span class='op'>::</span><span class='const'>BestStandardsSupport</span>)</code></pre>

<p>Also check your environment settings for <code>config.action_dispatch.best_standards_support</code> and remove it if present.</p></li>
<li><p>Rails 4.0 allows configuration of HTTP headers by setting <code>config.action_dispatch.default_headers</code>. The defaults are as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_action_dispatch'>action_dispatch</span>.<span class='id identifier rubyid_default_headers'>default_headers</span> <span class='op'>=</span> {
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>X-Frame-Options</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SAMEORIGIN</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>X-XSS-Protection</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1; mode=block</span><span class='tstring_end'>&#39;</span></span>
}</code></pre>

<p>Please note that if your application is dependent on loading certain pages in a <code>&lt;frame&gt;</code> or <code>&lt;iframe&gt;</code>, then you may need to explicitly set <code>X-Frame-Options</code> to <code>ALLOW-FROM ...</code> or <code>ALLOWALL</code>.</p></li>
<li><p>In Rails 4.0, precompiling assets no longer automatically copies non-JS/CSS assets from <code>vendor/assets</code> and <code>lib/assets</code>. Rails application and engine developers should put these assets in <code>app/assets</code> or configure <code>config.assets.precompile</code>.</p></li>
<li><p>In Rails 4.0, <a href="ActionController/UnknownFormat.html" title="ActionController::UnknownFormat (class)"><code>::ActionController::UnknownFormat</code></a> is raised when the action doesn&#39;t handle the request format. By default, the exception is handled by responding with 406 Not Acceptable, but you can override that now. In Rails 3, 406 Not Acceptable was always returned. No overrides.</p></li>
<li><p>In Rails 4.0, a generic <code>ActionDispatch::ParamsParser::ParseError</code> exception is raised when <code>ParamsParser</code> fails to parse request params. You will want to rescue this exception instead of the low-level <code>MultiJson::DecodeError</code>, for example.</p></li>
<li><p>In Rails 4.0, <code>SCRIPT_NAME</code> is properly nested when engines are mounted on an app that&#39;s served from a URL prefix. You no longer have to set <code>default_url_options[:script_name]</code> to work around overwritten URL prefixes.</p></li>
<li><p>Rails 4.0 deprecated <code>ActionController::Integration</code> in favor of <a href="ActionDispatch/Integration.html" title="ActionDispatch::Integration (module)"><code>::ActionDispatch::Integration</code></a>.</p></li>
<li><p>Rails 4.0 deprecated <code>ActionController::IntegrationTest</code> in favor of <a href="ActionDispatch/IntegrationTest.html" title="ActionDispatch::IntegrationTest (class)"><code>::ActionDispatch::IntegrationTest</code></a>.</p></li>
<li><p>Rails 4.0 deprecated <code>ActionController::PerformanceTest</code> in favor of <code>ActionDispatch::PerformanceTest</code>.</p></li>
<li><p>Rails 4.0 deprecated <code>ActionController::AbstractRequest</code> in favor of <a href="ActionDispatch/Request.html" title="ActionDispatch::Request (class)"><code>::ActionDispatch::Request</code></a>.</p></li>
<li><p>Rails 4.0 deprecated <code>ActionController::Request</code> in favor of <a href="ActionDispatch/Request.html" title="ActionDispatch::Request (class)"><code>::ActionDispatch::Request</code></a>.</p></li>
<li><p>Rails 4.0 deprecated <code>ActionController::AbstractResponse</code> in favor of <a href="ActionDispatch/Response.html" title="ActionDispatch::Response (class)"><code>::ActionDispatch::Response</code></a>.</p></li>
<li><p>Rails 4.0 deprecated <code>ActionController::Response</code> in favor of <a href="ActionDispatch/Response.html" title="ActionDispatch::Response (class)"><code>::ActionDispatch::Response</code></a>.</p></li>
<li><p>Rails 4.0 deprecated <code>ActionController::Routing</code> in favor of <a href="ActionDispatch/Routing.html" title="ActionDispatch::Routing (module)"><code>::ActionDispatch::Routing</code></a>.</p></li>
</ul>

<h3>Active Support</h3>

<p>Rails 4.0 removes the <code>j</code> alias for ERB::Util#json_escape since <code>j</code> is already used for <a href="ActionView/Helpers/JavaScriptHelper.html#escape_javascript-instance_method" title="ActionView::Helpers::JavaScriptHelper#escape_javascript (method)">ActionView::Helpers::JavaScriptHelper#escape_javascript</a>.</p>

<h4>Cache</h4>

<p>The caching method changed between Rails 3.x and 4.0. You should <a href="https://guides.rubyonrails.org/caching_with_rails.html#activesupport-cache-store">change the cache namespace</a> and roll out with a cold cache.</p>

<h3>Helpers Loading Order</h3>

<p>The order in which helpers from more than one directory are loaded has changed in Rails 4.0. Previously, they were gathered and then sorted alphabetically. After upgrading to Rails 4.0, helpers will preserve the order of loaded directories and will be sorted alphabetically only within each directory. Unless you explicitly use the <code>helpers_path</code> parameter, this change will only impact the way of loading helpers from engines. If you rely on the ordering, you should check if correct methods are available after upgrade. If you would like to change the order in which engines are loaded, you can use <code>config.railties_order=</code> method.</p>

<h3>Active Record Observer and Action Controller Sweeper</h3>

<p><code>ActiveRecord::Observer</code> and <code>ActionController::Caching::Sweeper</code> have been extracted to the <code>rails-observers</code> gem. You will need to add the <code>rails-observers</code> gem if you require these features.</p>

<h3>sprockets-rails</h3>

<ul>
<li><code>assets:precompile:primary</code> and <code>assets:precompile:all</code> have been removed. Use <code>assets:precompile</code> instead.</li>
<li><p>The <code>config.assets.compress</code> option should be changed to <code>config.assets.js_compressor</code> like so for instance:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_assets'>assets</span>.<span class='id identifier rubyid_js_compressor'>js_compressor</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_uglifier'>uglifier</span></code></pre></li>
</ul>

<h3>sass-rails</h3>

<ul>
<li><code>asset-url</code> with two arguments is deprecated. For example: <code>asset-url(&quot;rails.png&quot;, image)</code> becomes <code>asset-url(&quot;rails.png&quot;)</code>.</li>
</ul>

<h2>Upgrading from Rails 3.1 to Rails 3.2</h2>

<p>If your application is currently on any version of Rails older than 3.1.x, you
should upgrade to Rails 3.1 before attempting an update to Rails 3.2.</p>

<p>The following changes are meant for upgrading your application to the latest
3.2.x version of Rails.</p>

<h3>Gemfile</h3>

<p>Make the following changes to your <code>Gemfile</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rails</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>3.2.21</span><span class='tstring_end'>&#39;</span></span>

<span class='id identifier rubyid_group'>group</span> <span class='symbeg'>:</span><span class='id identifier rubyid_assets'>assets</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sass-rails</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>   <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>~&gt; 3.2.6</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>coffee-rails</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>~&gt; 3.2.2</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>uglifier</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>     <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&gt;= 1.0.3</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></code></pre>

<h3>config/environments/development.rb</h3>

<p>There are a couple of new configuration settings that you should add to your development environment:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Raise exception on mass assignment protection for Active Record models
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_mass_assignment_sanitizer'>mass_assignment_sanitizer</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_strict'>strict</span>

<span class='comment'># Log the query plan for queries taking more than this (works
</span><span class='comment'># with SQLite, MySQL, and PostgreSQL)
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_auto_explain_threshold_in_seconds'>auto_explain_threshold_in_seconds</span> <span class='op'>=</span> <span class='float'>0.5</span></code></pre>

<h3>config/environments/test.rb</h3>

<p>The <code>mass_assignment_sanitizer</code> configuration setting should also be added to <code>config/environments/test.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Raise exception on mass assignment protection for Active Record models
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_mass_assignment_sanitizer'>mass_assignment_sanitizer</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='id identifier rubyid_strict'>strict</span></code></pre>

<h3>vendor/plugins</h3>

<p>Rails 3.2 deprecates <code>vendor/plugins</code> and Rails 4.0 will remove them completely. While it&#39;s not strictly necessary as part of a Rails 3.2 upgrade, you can start replacing any plugins by extracting them to gems and adding them to your <code>Gemfile</code>. If you choose not to make them gems, you can move them into, say, <code>lib/my_plugin/*</code> and add an appropriate initializer in <code>config/initializers/my_plugin.rb</code>.</p>

<h3>Active Record</h3>

<p>Option <code>:dependent =&gt; :restrict</code> has been removed from <code>belongs_to</code>. If you want to prevent deleting the object if there are any associated objects, you can set <code>:dependent =&gt; :destroy</code> and return <code>false</code> after checking for existence of association from any of the associated object&#39;s destroy callbacks.</p>

<h2>Upgrading from Rails 3.0 to Rails 3.1</h2>

<p>If your application is currently on any version of Rails older than 3.0.x, you should upgrade to Rails 3.0 before attempting an update to Rails 3.1.</p>

<p>The following changes are meant for upgrading your application to Rails 3.1.12, the last 3.1.x version of Rails.</p>

<h3>Gemfile</h3>

<p>Make the following changes to your <code>Gemfile</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rails</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>3.1.12</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mysql2</span><span class='tstring_end'>&#39;</span></span>

<span class='comment'># Needed for the new asset pipeline
</span><span class='id identifier rubyid_group'>group</span> <span class='symbeg'>:</span><span class='id identifier rubyid_assets'>assets</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sass-rails</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>   <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>~&gt; 3.1.7</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>coffee-rails</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>~&gt; 3.1.1</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>uglifier</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>     <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&gt;= 1.0.3</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='comment'># jQuery is the default JavaScript library in Rails 3.1
</span><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>jquery-rails</span><span class='tstring_end'>&#39;</span></span></code></pre>

<h3>config/application.rb</h3>

<p>The asset pipeline requires the following additions:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_assets'>assets</span>.<span class='id identifier rubyid_enabled'>enabled</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_assets'>assets</span>.<span class='id identifier rubyid_version'>version</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1.0</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>If your application is using an &quot;/assets&quot; route for a resource you may want to change the prefix used for assets to avoid conflicts:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Defaults to &#39;/assets&#39;
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_assets'>assets</span>.<span class='id identifier rubyid_prefix'>prefix</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/asset-files</span><span class='tstring_end'>&#39;</span></span></code></pre>

<h3>config/environments/development.rb</h3>

<p>Remove the RJS setting <code>config.action_view.debug_rjs = true</code>.</p>

<p>Add these settings if you enable the asset pipeline:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Do not compress assets
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_assets'>assets</span>.<span class='id identifier rubyid_compress'>compress</span> <span class='op'>=</span> <span class='kw'>false</span>

<span class='comment'># Expands the lines which load the assets
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_assets'>assets</span>.<span class='id identifier rubyid_debug'>debug</span> <span class='op'>=</span> <span class='kw'>true</span></code></pre>

<h3>config/environments/production.rb</h3>

<p>Again, most of the changes below are for the asset pipeline. You can read more about these in the <a href="asset_pipeline.html">Asset Pipeline</a> guide.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Compress JavaScripts and CSS
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_assets'>assets</span>.<span class='id identifier rubyid_compress'>compress</span> <span class='op'>=</span> <span class='kw'>true</span>

<span class='comment'># Don&#39;t fallback to assets pipeline if a precompiled asset is missed
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_assets'>assets</span>.<span class='id identifier rubyid_compile'>compile</span> <span class='op'>=</span> <span class='kw'>false</span>

<span class='comment'># Generate digests for assets URLs
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_assets'>assets</span>.<span class='id identifier rubyid_digest'>digest</span> <span class='op'>=</span> <span class='kw'>true</span>

<span class='comment'># Defaults to Rails.root.join(&quot;public/assets&quot;)
</span><span class='comment'># config.assets.manifest = YOUR_PATH
</span>
<span class='comment'># Precompile additional assets (application.js, application.css, and all non-JS/CSS are already added)
</span><span class='comment'># config.assets.precompile += %w( admin.js admin.css )
</span>
<span class='comment'># Force all access to the app over SSL, use Strict-Transport-Security, and use secure cookies.
</span><span class='comment'># config.force_ssl = true</span></code></pre>

<h3>config/environments/test.rb</h3>

<p>You can help test performance with these additions to your test environment:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Configure static asset server for tests with Cache-Control for performance
</span><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_public_file_server'>public_file_server</span>.<span class='id identifier rubyid_enabled'>enabled</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_public_file_server'>public_file_server</span>.<span class='id identifier rubyid_headers'>headers</span> <span class='op'>=</span> {
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Cache-Control</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>public, max-age=3600</span><span class='tstring_end'>&#39;</span></span>
}</code></pre>

<h3>config/initializers/wrap_parameters.rb</h3>

<p>Add this file with the following contents, if you wish to wrap parameters into a nested hash. This is on by default in new applications.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Be sure to restart your server when you modify this file.
</span><span class='comment'># This file contains settings for ActionController::ParamsWrapper which
</span><span class='comment'># is enabled by default.
</span>
<span class='comment'># Enable parameter wrapping for JSON. You can disable this by setting :format to an empty array.
</span><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span>.<span class='id identifier rubyid_on_load'><a href="ActiveSupport/LazyLoadHooks.html#on_load-instance_method" title="ActiveSupport::LazyLoadHooks#on_load (method)">on_load</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_action_controller'>action_controller</span>) <span class='kw'>do</span>
  <span class='id identifier rubyid_wrap_parameters'>wrap_parameters</span> <span class='label'>format:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_json'>json</span>]
<span class='kw'>end</span>

<span class='comment'># Disable root element in JSON by default.
</span><span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span>.<span class='id identifier rubyid_on_load'><a href="ActiveSupport/LazyLoadHooks.html#on_load-instance_method" title="ActiveSupport::LazyLoadHooks#on_load (method)">on_load</a></span>(<span class='symbeg'>:</span><span class='id identifier rubyid_active_record'>active_record</span>) <span class='kw'>do</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_include_root_in_json'>include_root_in_json</span> <span class='op'>=</span> <span class='kw'>false</span>
<span class='kw'>end</span></code></pre>

<h3>config/initializers/session_store.rb</h3>

<p>You need to change your session key to something new, or remove all sessions:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># in config/initializers/session_store.rb
</span><span class='const'>AppName</span><span class='op'>::</span><span class='const'>Application</span>.<span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_session_store'>session_store</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cookie_store'>cookie_store</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SOMETHINGNEW</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>or</p>

<pre class="code bash"><code class="bash">$ bin/rake db:sessions:clear
</code></pre>

<h3>Remove :cache and :concat options in asset helpers references in views</h3>

<ul>
<li>With the Asset Pipeline the :cache and :concat options aren&#39;t used anymore, delete these options from your views.</li>
</ul>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>