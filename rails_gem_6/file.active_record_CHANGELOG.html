<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Active Record CHANGELOG &mdash; Rails 6.1.7.10</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "active_record_CHANGELOG",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 6.1.7.10</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Active Record CHANGELOG&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h2>Rails 6.1.7.10 (October 23, 2024)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.7.9 (October 15, 2024)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.7.8 (June 04, 2024)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.7.7 (February 21, 2024)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.7.6 (August 22, 2023)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.7.5 (August 22, 2023)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.7.4 (June 26, 2023)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.7.3 (March 13, 2023)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.7.2 (January 24, 2023)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.7.1 (January 17, 2023)</h2>

<ul>
<li><p>Make sanitize_as_sql_comment more strict</p>

<p>Though this method was likely never meant to take user input, it was
attempting sanitization. That sanitization could be bypassed with
carefully crafted input.</p>

<p>This commit makes the sanitization more robust by replacing any
occurrances of &quot;/<em>&quot; or &quot;</em>/&quot; with &quot;/ <em>&quot; or &quot;</em> /&quot;. It also performs a
first pass to remove one surrounding comment to avoid compatibility
issues for users relying on the existing removal.</p>

<p>This also clarifies in the documentation of annotate that it should not
be provided user input.</p>

<p>[CVE-2023-22794]</p></li>
<li><p>Added integer width check to PostgreSQL::Quoting</p>

<p>Given a value outside the range for a 64bit signed integer type
PostgreSQL will treat the column type as numeric. Comparing
integer values against numeric values can result in a slow
sequential scan.</p>

<p>This behavior is configurable via
ActiveRecord::Base.raise_int_wider_than_64bit which defaults to true.</p>

<p>[CVE-2022-44566]</p></li>
</ul>

<h2>Rails 6.1.7 (September 09, 2022)</h2>

<ul>
<li><p><a href="Symbol.html" title="Symbol (class)"><code>Symbol</code></a> is allowed by default for YAML columns</p>

<p><em>Étienne Barrié</em></p></li>
<li><p>Fix <a href="ActiveRecord/Store.html" title="ActiveRecord::Store (module)"><code>::ActiveRecord::Store</code></a> to serialize as a regular <a href="Hash.html" title="Hash (class)"><code>Hash</code></a></p>

<p>Previously it would serialize as an <a href="ActiveSupport/HashWithIndifferentAccess.html" title="ActiveSupport::HashWithIndifferentAccess (class)"><code>::ActiveSupport::HashWithIndifferentAccess</code></a>
which is wasteful and cause problem with YAML safe_load.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Fix PG.connect keyword arguments deprecation warning on ruby 2.7</p>

<p>Fixes #44307.</p>

<p><em>Nikita Vasilevsky</em></p></li>
</ul>

<h2>Rails 6.1.6.1 (July 12, 2022)</h2>

<ul>
<li><p>Change ActiveRecord::Coders::YAMLColumn default to safe_load</p>

<p>This adds two new configuration options The configuration options are as
follows:</p>

<ul>
<li><code>config.active_storage.use_yaml_unsafe_load</code></li>
</ul>

<p>When set to true, this configuration option tells Rails to use the old
&quot;unsafe&quot; YAML loading strategy, maintaining the existing behavior but leaving
the possible escalation vulnerability in place.  Setting this option to true
is <em>not</em> recommended, but can aid in upgrading.</p>

<ul>
<li><code>config.active_record.yaml_column_permitted_classes</code></li>
</ul>

<p>The &quot;safe YAML&quot; loading method does not allow all classes to be deserialized
by default.  This option allows you to specify classes deemed &quot;safe&quot; in your
application.  For example, if your application uses Symbol and Time in
serialized data, you can add Symbol and Time to the allowed list as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span>.<span class='id identifier rubyid_active_record'>active_record</span>.<span class='id identifier rubyid_yaml_column_permitted_classes'>yaml_column_permitted_classes</span> <span class='op'>=</span> [<span class='const'><a href="Symbol.html" title="Symbol (class)">Symbol</a></span><span class='comma'>,</span> <span class='const'><a href="Date.html" title="Date (class)">Date</a></span><span class='comma'>,</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>]</code></pre>

<p>[CVE-2022-32224]</p></li>
</ul>

<h2>Rails 6.1.6 (May 09, 2022)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.5.1 (April 26, 2022)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.5 (March 09, 2022)</h2>

<ul>
<li><p>Fix ActiveRecord::ConnectionAdapters::SchemaCache#deep_deduplicate for Ruby 2.6.</p>

<p>Ruby 2.6 and 2.7 have slightly different implementations of the <code>String#-@</code> method.
In Ruby 2.6, the receiver of the <code>String#-@</code> method is modified under certain circumstances.
This was later identified as a bug (<a href="https://bugs.ruby-lang.org/issues/15926">https://bugs.ruby-lang.org/issues/15926</a>) and only
fixed in Ruby 2.7.</p>

<p>Before the changes in this commit, the
ActiveRecord::ConnectionAdapters::SchemaCache#deep_deduplicate method, which internally
calls the <code>String#-@</code> method, could also modify an input string argument in Ruby 2.6 --
changing a tainted, unfrozen string into a tainted, frozen string.</p>

<p>Fixes #43056</p>

<p><em>Eric O&#39;Hanlon</em></p></li>
<li><p>Fix migration compatibility to create SQLite references/belongs_to column as integer when
migration version is 6.0.</p>

<p><code>reference</code>/<code>belongs_to</code> in migrations with version 6.0 were creating columns as
bigint instead of integer for the SQLite Adapter.</p>

<p><em>Marcelo Lauxen</em></p></li>
<li><p>Fix dbconsole for 3-tier config.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Better handle SQL queries with invalid encoding.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_create'>create</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>broken \xC8 UTF-8</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>Would cause all adapters to fail in a non controlled way in the code
responsible to detect write queries.</p>

<p>The query is now properly passed to the database connection, which might or might
not be able to handle it, but will either succeed or failed in a more correct way.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Ignore persisted in-memory records when merging target lists.</p>

<p><em>Kevin Sjöberg</em></p></li>
<li><p>Fix regression bug that caused ignoring additional conditions for preloading
<code>has_many</code> through relations.</p>

<p>Fixes #43132</p>

<p><em>Alexander Pauly</em></p></li>
<li><p>Fix <a href="ActiveRecord/InternalMetadata.html" title="ActiveRecord::InternalMetadata (class)"><code>::ActiveRecord::InternalMetadata</code></a> to not be broken by
<code>config.active_record.record_timestamps = false</code></p>

<p>Since the model always create the timestamp columns, it has to set them, otherwise it breaks
various DB management tasks.</p>

<p>Fixes #42983</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Fix duplicate active record objects on <code>inverse_of</code>.</p>

<p><em>Justin Carvalho</em></p></li>
<li><p>Fix duplicate objects stored in has many association after save.</p>

<p>Fixes #42549.</p>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Fix performance regression in <code>CollectionAssocation#build</code>.</p>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Fix retrieving default value for text column for MariaDB.</p>

<p><em>fatkodima</em></p></li>
</ul>

<h2>Rails 6.1.4.7 (March 08, 2022)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.4.6 (February 11, 2022)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.4.5 (February 11, 2022)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.4.4 (December 15, 2021)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.4.3 (December 14, 2021)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.4.2 (December 14, 2021)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.4.1 (August 19, 2021)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.4 (June 24, 2021)</h2>

<ul>
<li><p>Do not try to rollback transactions that failed due to a <a href="ActiveRecord/TransactionRollbackError.html" title="ActiveRecord::TransactionRollbackError (class)"><code>::ActiveRecord::TransactionRollbackError</code></a>.</p>

<p><em>Jamie McCarthy</em></p></li>
<li><p>Raise an error if <code>pool_config</code> is <code>nil</code> in <code>set_pool_config</code>.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Fix compatibility with <code>psych &gt;= 4</code>.</p>

<p>Starting in Psych 4.0.0 <code>YAML.load</code> behaves like <code>YAML.safe_load</code>. To preserve compatibility
Active Record&#39;s schema cache loader and <code>YAMLColumn</code> now uses <code>YAML.unsafe_load</code> if available.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Support using replicas when using <code>rails dbconsole</code>.</p>

<p><em>Christopher Thornton</em></p></li>
<li><p>Restore connection pools after transactional tests.</p>

<p><em>Eugene Kenny</em></p></li>
<li><p>Change <code>upsert_all</code> to fails cleanly for MySQL when <code>:unique_by</code> is used.</p>

<p><em>Bastian Bartmann</em></p></li>
<li><p>Fix user-defined <code>self.default_scope</code> to respect table alias.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Clear <code>@cache_keys</code> cache after <code>update_all</code>, <code>delete_all</code>, <code>destroy_all</code>.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Changed Arel predications <code>contains</code> and <code>overlaps</code> to use
<code>quoted_node</code> so that PostgreSQL arrays are quoted properly.</p>

<p><em>Bradley Priest</em></p></li>
<li><p>Fix <code>merge</code> when the <code>where</code> clauses have string contents.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Fix rollback of parent destruction with nested <code>dependent: :destroy</code>.</p>

<p><em>Jacopo Beschi</em></p></li>
<li><p>Fix binds logging for <code>&quot;WHERE ... IN ...&quot;</code> statements.</p>

<p><em>Ricardo Díaz</em></p></li>
<li><p>Handle <code>false</code> in relation strict loading checks.</p>

<p>Previously when a model had strict loading set to true and then had a
relation set <code>strict_loading</code> to false the false wasn&#39;t considered when
deciding whether to raise/warn about strict loading.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Dog</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_strict_loading_by_default'>strict_loading_by_default</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_treats'>treats</span><span class='comma'>,</span> <span class='label'>strict_loading:</span> <span class='kw'>false</span>
<span class='kw'>end</span></code></pre>

<p>In the example, <code>dog.treats</code> would still raise even though
<code>strict_loading</code> was set to false. This is a bug affecting more than
Active Storage which is why I made this PR superseding #41461. We need
to fix this for all applications since the behavior is a little
surprising. I took the test from #41461 and the code suggestion from #41453
with some additions.</p>

<p><em>Eileen M. Uchitelle</em>, <em>Radamés Roriz</em></p></li>
<li><p>Fix numericality validator without precision.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Fix aggregate attribute on Enum types.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Fix <code>CREATE INDEX</code> statement generation for PostgreSQL.</p>

<p><em>eltongo</em></p></li>
<li><p>Fix where clause on enum attribute when providing array of strings.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Fix <code>unprepared_statement</code> to work it when nesting.</p>

<p><em>Ryuta Kamizono</em></p></li>
</ul>

<h2>Rails 6.1.3.2 (May 05, 2021)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.3.1 (March 26, 2021)</h2>

<ul>
<li>  No changes.</li>
</ul>

<h2>Rails 6.1.3 (February 17, 2021)</h2>

<ul>
<li><p>Fix the MySQL adapter to always set the right collation and charset
to the connection session.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Fix MySQL adapter handling of time objects when prepared statements
are enabled.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Fix scoping in enum fields using conditions that would generate
an <code>IN</code> clause.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Skip optimised #exist? query when #include? is called on a relation
with a having clause</p>

<p>Relations that have aliased select values AND a having clause that
references an aliased select value would generate an error when</p>

<h1>include? was called, due to an optimisation that would generate</h1>

<p>call #exists? on the relation instead, which effectively alters
the select values of the query (and thus removes the aliased select
values), but leaves the having clause intact. Because the having
clause is then referencing an aliased column that is no longer
present in the simplified query, an ActiveRecord::InvalidStatement
error was raised.</p>

<p>An sample query affected by this problem:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Author</span>.<span class='id identifier rubyid_select'>select</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>COUNT(*) as total_posts</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>authors.*</span><span class='tstring_end'>&#39;</span></span>)
      .<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>)
      .<span class='id identifier rubyid_group'>group</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_id'>id</span>)
      .<span class='id identifier rubyid_having'>having</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>total_posts &gt; 2</span><span class='tstring_end'>&#39;</span></span>)
      .<span class='id identifier rubyid_include?'>include?</span>(<span class='const'>Author</span>.<span class='id identifier rubyid_first'>first</span>)</code></pre>

<p>This change adds an addition check to the condition that skips the
simplified #exists? query, which simply checks for the presence of
a having clause.</p>

<p>Fixes #41417</p>

<p><em>Michael Smart</em></p></li>
<li><p>Increment postgres prepared statement counter before making a prepared statement, so if the statement is aborted
without Rails knowledge (e.g., if app gets kill -9d during long-running query or due to Rack::Timeout), app won&#39;t end
up in perpetual crash state for being inconsistent with Postgres.</p>

<p><em>wbharding</em>, <em>Martin Tepper</em></p></li>
</ul>

<h2>Rails 6.1.2.1 (February 10, 2021)</h2>

<ul>
<li><p>Fix possible DoS vector in PostgreSQL money type</p>

<p>Carefully crafted input can cause a DoS via the regular expressions used
for validating the money format in the PostgreSQL adapter.  This patch
fixes the regexp.</p>

<p>Thanks to @dee-see from Hackerone for this patch!</p>

<p>[CVE-2021-22880]</p>

<p><em>Aaron Patterson</em></p></li>
</ul>

<h2>Rails 6.1.2 (February 09, 2021)</h2>

<ul>
<li><p>Fix timestamp type for sqlite3.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Make destroy async transactional.</p>

<p>An active record rollback could occur while enqueuing a job. In this
case the job would enqueue even though the database deletion
rolledback putting things in a funky state.</p>

<p>Now the jobs are only enqueued until after the db transaction has been committed.</p>

<p><em>Cory Gwin</em></p></li>
<li><p>Fix malformed packet error in MySQL statement for connection configuration.</p>

<p><em>robinroestenburg</em></p></li>
<li><p>Connection specification now passes the &quot;url&quot; key as a configuration for the
adapter if the &quot;url&quot; protocol is &quot;jdbc&quot;, &quot;http&quot;, or &quot;https&quot;. Previously only
urls with the &quot;jdbc&quot; prefix were passed to the Active Record Adapter, others
are assumed to be adapter specification urls.</p>

<p>Fixes #41137.</p>

<p><em>Jonathan Bracy</em></p></li>
<li><p>Fix granular connection swapping when there are multiple abstract classes.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Fix <code>find_by</code> with custom primary key for belongs_to association.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Add support for <code>rails console --sandbox</code> for multiple database applications.</p>

<p><em>alpaca-tc</em></p></li>
<li><p>Fix <code>where</code> on polymorphic association with empty array.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Fix preventing writes for <code>ApplicationRecord</code>.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
</ul>

<h2>Rails 6.1.1 (January 07, 2021)</h2>

<ul>
<li><p>Fix fixtures loading when strict loading is enabled for the association.</p>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Fix <code>where</code> with custom primary key for belongs_to association.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Fix <code>where</code> with aliased associations.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Fix <code>composed_of</code> with symbol mapping.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Don&#39;t skip money&#39;s type cast for pluck and calculations.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Fix <code>where</code> on polymorphic association with non Active Record object.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Make sure <code>db:prepare</code> works even the schema file doesn&#39;t exist.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Fix complicated <code>has_many :through</code> with nested where condition.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Handle STI models for <code>has_many dependent: :destroy_async</code>.</p>

<p><em>Muhammad Usman</em></p></li>
<li><p>Restore possibility of passing <code>false</code> to <code>:polymorphic</code> option of <code>belongs_to</code>.</p>

<p>Previously, passing <code>false</code> would trigger the option validation logic
to throw an error saying :polymorphic would not be a valid option.</p>

<p><em>glaszig</em></p></li>
<li><p>Allow adding nonnamed expression indexes to be revertible.</p>

<p>Fixes #40732.</p>

<p>Previously, the following code would raise an error, when executed while rolling back,
and the index name should be specified explicitly. Now, the index name is inferred
automatically.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_index'>add_index</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_items'>items</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>to_tsvector(&#39;english&#39;, description)</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p><em>fatkodima</em></p></li>
</ul>

<h2>Rails 6.1.0 (December 09, 2020)</h2>

<ul>
<li><p>Only warn about negative enums if a positive form that would cause conflicts exists.</p>

<p>Fixes #39065.</p>

<p><em>Alex Ghiculescu</em></p></li>
<li><p>Change <code>attribute_for_inspect</code> to take <code>filter_attributes</code> in consideration.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Fix odd behavior of inverse_of with multiple belongs_to to same class.</p>

<p>Fixes #35204.</p>

<p><em>Tomoyuki Kai</em></p></li>
<li><p>Build predicate conditions with objects that delegate <code>#id</code> and primary key:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>AdminAuthor</span>
  <span class='id identifier rubyid_delegate_missing_to'>delegate_missing_to</span> <span class='symbeg'>:</span><span class='ivar'>@author</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_author'>author</span>)
    <span class='ivar'>@author</span> <span class='op'>=</span> <span class='id identifier rubyid_author'>author</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>Post</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>author:</span> <span class='const'>AdminAuthor</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_author'>author</span>))</code></pre>

<p><em>Sean Doyle</em></p></li>
<li><p>Add <code>connected_to_many</code> API.</p>

<p>This API allows applications to connect to multiple databases at once without switching all of them or implementing a deeply nested stack.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>AnimalsRecord</span>.<span class='id identifier rubyid_connected_to'>connected_to</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span>) <span class='kw'>do</span>
  <span class='const'>MealsRecord</span>.<span class='id identifier rubyid_connected_to'>connected_to</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span>) <span class='kw'>do</span>
    <span class='const'>Dog</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># read from animals replica
</span>    <span class='const'>Dinner</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># read from meals replica
</span>    <span class='const'>Person</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># read from primary writer
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to_many'><a href="ActiveRecord/ConnectionHandling.html#connected_to_many-instance_method" title="ActiveRecord::ConnectionHandling#connected_to_many (method)">connected_to_many</a></span>([<span class='const'>AnimalsRecord</span><span class='comma'>,</span> <span class='const'>MealsRecord</span>]<span class='comma'>,</span> <span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span>) <span class='kw'>do</span>
  <span class='const'>Dog</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># read from animals replica
</span>  <span class='const'>Dinner</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># read from meals replica
</span>  <span class='const'>Person</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># read from primary writer
</span><span class='kw'>end</span></code></pre>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Add option to raise or log for <a href="ActiveRecord/StrictLoadingViolationError.html" title="ActiveRecord::StrictLoadingViolationError (class)"><code>::ActiveRecord::StrictLoadingViolationError</code></a>.</p>

<p>Some applications may not want to raise an error in production if using <code>strict_loading</code>. This would allow an application to set strict loading to log for the production environment while still raising in development and test environments.</p>

<p>Set <code>config.active_record.action_on_strict_loading_violation</code> to <code>:log</code> errors instead of raising.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Allow the inverse of a <code>has_one</code> association that was previously autosaved to be loaded.</p>

<p>Fixes #34255.</p>

<p><em>Steven Weber</em></p></li>
<li><p>Optimise the length of index names for polymorphic references by using the reference name rather than the type and id column names.</p>

<p>Because the default behaviour when adding an index with multiple columns is to use all column names in the index name, this could frequently lead to overly long index names for polymorphic references which would fail the migration if it exceeded the database limit.</p>

<p>This change reduces the chance of that happening by using the reference name, e.g. <code>index_my_table_on_my_reference</code>.</p>

<p>Fixes #38655.</p>

<p><em>Luke Redpath</em></p></li>
<li><p>MySQL: Uniqueness validator now respects default database collation,
no longer enforce case sensitive comparison by default.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Remove deprecated methods from <a href="ActiveRecord/ConnectionAdapters/DatabaseLimits.html" title="ActiveRecord::ConnectionAdapters::DatabaseLimits (module)"><code>::ActiveRecord::ConnectionAdapters::DatabaseLimits</code></a>.</p>

<p><code>column_name_length</code>
<code>table_name_length</code>
<code>columns_per_table</code>
<code>indexes_per_table</code>
<code>columns_per_multicolumn_index</code>
<code>sql_query_length</code>
<code>joins_per_query</code></p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <code>ActiveRecord::ConnectionAdapters::AbstractAdapter#supports_multi_insert?</code>.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <code>ActiveRecord::ConnectionAdapters::AbstractAdapter#supports_foreign_keys_in_create?</code>.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <code>ActiveRecord::ConnectionAdapters::PostgreSQLAdapter#supports_ranges?</code>.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <code>ActiveRecord::Base#update_attributes</code> and <code>ActiveRecord::Base#update_attributes!</code>.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <code>migrations_path</code> argument in <code>ActiveRecord::ConnectionAdapter::SchemaStatements#assume_migrated_upto_version</code>.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <code>config.active_record.sqlite3.represent_boolean_as_integer</code>.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p><code>relation.create</code> does no longer leak scope to class level querying methods
in initialization block and callbacks.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_create'>create</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_john'>john</span><span class='op'>|</span>
  <span class='const'>User</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>David</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># =&gt; nil
</span><span class='kw'>end</span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_create'>create</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_john'>john</span><span class='op'>|</span>
  <span class='const'>User</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>David</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># =&gt; #&lt;User name: &quot;David&quot;, ...&gt;
</span><span class='kw'>end</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Named scope chain does no longer leak scope to class level querying methods.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_scope'>scope</span> <span class='symbeg'>:</span><span class='id identifier rubyid_david'>david</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>David</span><span class='tstring_end'>&quot;</span></span>) }
<span class='kw'>end</span></code></pre>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_david'>david</span>
<span class='comment'># SELECT * FROM users WHERE name = &#39;John&#39; AND name = &#39;David&#39;</span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_david'>david</span>
<span class='comment'># SELECT * FROM users WHERE name = &#39;David&#39;</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Remove deprecated methods from <a href="ActiveRecord/DatabaseConfigurations.html" title="ActiveRecord::DatabaseConfigurations (class)"><code>::ActiveRecord::DatabaseConfigurations</code></a>.</p>

<p><code>fetch</code>
<code>each</code>
<code>first</code>
<code>values</code>
<code>[]=</code></p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p><code>where.not</code> now generates NAND predicates instead of NOR.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>.<span class='id identifier rubyid_not'>not</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Jon</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>role:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># SELECT * FROM users WHERE name != &#39;Jon&#39; AND role != &#39;admin&#39;</span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>User</span>.<span class='id identifier rubyid_where'>where</span>.<span class='id identifier rubyid_not'>not</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Jon</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>role:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span>)
<span class='comment'># SELECT * FROM users WHERE NOT (name == &#39;Jon&#39; AND role == &#39;admin&#39;)</span></code></pre>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated <code>ActiveRecord::Result#to_hash</code> method.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Deprecate <a href="ActiveRecord/Base.html#allow_unsafe_raw_sql-class_method" title="ActiveRecord::Base.allow_unsafe_raw_sql (method)">ActiveRecord::Base.allow_unsafe_raw_sql</a>.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Remove deprecated support for using unsafe raw SQL in <a href="ActiveRecord/Relation.html" title="ActiveRecord::Relation (class)"><code>::ActiveRecord::Relation</code></a> methods.</p>

<p><em>Rafael Mendonça França</em></p></li>
<li><p>Allow users to silence the &quot;Rails couldn&#39;t infer whether you are using multiple databases...&quot;
message using <code>config.active_record.suppress_multiple_database_warning</code>.</p>

<p><em>Omri Gabay</em></p></li>
<li><p>Connections can be granularly switched for abstract classes when <code>connected_to</code> is called.</p>

<p>This change allows <code>connected_to</code> to switch a <code>role</code> and/or <code>shard</code> for a single abstract class instead of all classes globally. Applications that want to use the new feature need to set <code>config.active_record.legacy_connection_handling</code> to <code>false</code> in their application configuration.</p>

<p>Example usage:</p>

<p>Given an application we have a <code>User</code> model that inherits from <code>ApplicationRecord</code> and a <code>Dog</code> model that inherits from <code>AnimalsRecord</code>. <code>AnimalsRecord</code> and <code>ApplicationRecord</code> have writing and reading connections as well as shard <code>default</code>, <code>one</code>, and <code>two</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to'><a href="ActiveRecord/ConnectionHandling.html#connected_to-instance_method" title="ActiveRecord::ConnectionHandling#connected_to (method)">connected_to</a></span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reading'>reading</span>) <span class='kw'>do</span>
  <span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># reads from default replica
</span>  <span class='const'>Dog</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># reads from default replica
</span>
  <span class='const'>AnimalsRecord</span>.<span class='id identifier rubyid_connected_to'>connected_to</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_writing'>writing</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_one'>one</span>) <span class='kw'>do</span>
    <span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># reads from default replica
</span>    <span class='const'>Dog</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># reads from shard one primary
</span>  <span class='kw'>end</span>

  <span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># reads from default replica
</span>  <span class='const'>Dog</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># reads from default replica
</span>
  <span class='const'>ApplicationRecord</span>.<span class='id identifier rubyid_connected_to'>connected_to</span>(<span class='label'>role:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_writing'>writing</span><span class='comma'>,</span> <span class='label'>shard:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_two'>two</span>) <span class='kw'>do</span>
    <span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># reads from shard two primary
</span>    <span class='const'>Dog</span>.<span class='id identifier rubyid_first'>first</span> <span class='comment'># reads from default replica
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Allow double-dash comment syntax when querying read-only databases</p>

<p><em>James Adam</em></p></li>
<li><p>Add <code>values_at</code> method.</p>

<p>Returns an array containing the values associated with the given methods.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_topic'>topic</span> <span class='op'>=</span> <span class='const'>Topic</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_topic'>topic</span>.<span class='id identifier rubyid_values_at'>values_at</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_author_name'>author_name</span>)
<span class='comment'># =&gt; [&quot;Budget&quot;, &quot;Jason&quot;]</span></code></pre>

<p>Similar to <code>Hash#values_at</code> but on an Active Record instance.</p>

<p><em>Guillaume Briday</em></p></li>
<li><p>Fix <code>read_attribute_before_type_cast</code> to consider attribute aliases.</p>

<p><em>Marcelo Lauxen</em></p></li>
<li><p>Support passing record to uniqueness validator <code>:conditions</code> callable:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Article</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_validates_uniqueness_of'>validates_uniqueness_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='label'>conditions:</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_article'>article</span>) <span class='tlambeg'>{</span>
    <span class='id identifier rubyid_published_at'>published_at</span> <span class='op'>=</span> <span class='id identifier rubyid_article'>article</span>.<span class='id identifier rubyid_published_at'>published_at</span>
    <span class='id identifier rubyid_where'>where</span>(<span class='label'>published_at:</span> <span class='id identifier rubyid_published_at'>published_at</span>.<span class='id identifier rubyid_beginning_of_year'>beginning_of_year</span><span class='op'>..</span><span class='id identifier rubyid_published_at'>published_at</span>.<span class='id identifier rubyid_end_of_year'>end_of_year</span>)
  }
<span class='kw'>end</span></code></pre>

<p><em>Eliot Sykes</em></p></li>
<li><p><code>BatchEnumerator#update_all</code> and <code>BatchEnumerator#delete_all</code> now return the
total number of rows affected, just like their non-batched counterparts.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_in_batches'>in_batches</span>.<span class='id identifier rubyid_update_all'>update_all</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>first_name = &#39;Eugene&#39;</span><span class='tstring_end'>&quot;</span></span>) <span class='comment'># =&gt; 42
</span><span class='const'>Person</span>.<span class='id identifier rubyid_in_batches'>in_batches</span>.<span class='id identifier rubyid_delete_all'>delete_all</span> <span class='comment'># =&gt; 42</span></code></pre>

<p>Fixes #40287.</p>

<p><em>Eugene Kenny</em></p></li>
<li><p>Add support for PostgreSQL <code>interval</code> data type with conversion to
<a href="ActiveSupport/Duration.html" title="ActiveSupport::Duration (class)"><code>::ActiveSupport::Duration</code></a> when loading records from database and
serialization to ISO 8601 formatted duration string on save.
Add support to define a column in migrations and get it in a schema dump.
Optional column precision is supported.</p>

<p>To use this in 6.1, you need to place the next string to your model file:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_attribute'>attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_duration'>duration</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_interval'>interval</span></code></pre>

<p>To keep old behavior until 7.0 is released:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_attribute'>attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_duration'>duration</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_string'>string</span></code></pre>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_events'>events</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_string'>string</span>   <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_interval'>interval</span> <span class='symbeg'>:</span><span class='id identifier rubyid_duration'>duration</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Event</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_attribute'>attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_duration'>duration</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_interval'>interval</span>
<span class='kw'>end</span>

<span class='const'>Event</span>.<span class='id identifier rubyid_create!'>create!</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Rock Fest</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>duration:</span> <span class='int'>2</span>.<span class='id identifier rubyid_days'>days</span>)
<span class='const'>Event</span>.<span class='id identifier rubyid_last'>last</span>.<span class='id identifier rubyid_duration'>duration</span> <span class='comment'># =&gt; 2 days
</span><span class='const'>Event</span>.<span class='id identifier rubyid_last'>last</span>.<span class='id identifier rubyid_duration'>duration</span>.<span class='id identifier rubyid_iso8601'>iso8601</span> <span class='comment'># =&gt; &quot;P2D&quot;
</span><span class='const'>Event</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>duration:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>P1DT12H3S</span><span class='tstring_end'>&#39;</span></span>).<span class='id identifier rubyid_duration'>duration</span> <span class='comment'># =&gt; 1 day, 12 hours, and 3 seconds
</span><span class='const'>Event</span>.<span class='id identifier rubyid_new'>new</span>(<span class='label'>duration:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1 day</span><span class='tstring_end'>&#39;</span></span>) <span class='comment'># Unknown value will be ignored and NULL will be written to database</span></code></pre>

<p><em>Andrey Novikov</em></p></li>
<li><p>Allow associations supporting the <code>dependent:</code> key to take <code>dependent: :destroy_async</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
    <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_supplier'>supplier</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_destroy_async'>destroy_async</span>
<span class='kw'>end</span></code></pre>

<p><code>:destroy_async</code> will enqueue a job to destroy associated records in the background.</p>

<p><em>DHH</em>, <em>George Claghorn</em>, <em>Cory Gwin</em>, <em>Rafael Mendonça França</em>, <em>Adrianna Chang</em></p></li>
<li><p>Add <code>SKIP_TEST_DATABASE</code> environment variable to disable modifying the test database when <code>rails db:create</code> and <code>rails db:drop</code> are called.</p>

<p><em>Jason Schweier</em></p></li>
<li><p><code>connects_to</code> can only be called on <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> or abstract classes.</p>

<p>Ensure that <code>connects_to</code> can only be called from <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> or abstract classes. This protects the application from opening duplicate or too many connections.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>All connection adapters <code>execute</code> now raises <a href="ActiveRecord/ConnectionNotEstablished.html" title="ActiveRecord::ConnectionNotEstablished (class)"><code>::ActiveRecord::ConnectionNotEstablished</code></a> rather than
<a href="ActiveRecord/StatementInvalid.html" title="ActiveRecord::StatementInvalid (class)"><code>::ActiveRecord::StatementInvalid</code></a> when they encounter a connection error.</p>

<p><em>Jean Boussier</em></p></li>
<li><p><code>Mysql2Adapter#quote_string</code> now raises <a href="ActiveRecord/ConnectionNotEstablished.html" title="ActiveRecord::ConnectionNotEstablished (class)"><code>::ActiveRecord::ConnectionNotEstablished</code></a> rather than
<a href="ActiveRecord/StatementInvalid.html" title="ActiveRecord::StatementInvalid (class)"><code>::ActiveRecord::StatementInvalid</code></a> when it can&#39;t connect to the MySQL server.</p>

<p><em>Jean Boussier</em></p></li>
<li><p>Add support for check constraints that are <code>NOT VALID</code> via <code>validate: false</code> (PostgreSQL-only).</p>

<p><em>Alex Robbin</em></p></li>
<li><p>Ensure the default configuration is considered primary or first for an environment</p>

<p>If a multiple database application provides a configuration named primary, that will be treated as default. In applications that do not have a primary entry, the default database configuration will be the first configuration for an environment.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Allow <code>where</code> references association names as joined table name aliases.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Comment</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_enum'>enum</span> <span class='label'>label:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_default'>default</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_child'>child</span>]
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_children'>children</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Comment</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_parent_id'>parent_id</span>
<span class='kw'>end</span>

<span class='comment'># ... FROM comments LEFT OUTER JOIN comments children ON ... WHERE children.label = 1
</span><span class='const'>Comment</span>.<span class='id identifier rubyid_includes'>includes</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_children'>children</span>).<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>children.label</span><span class='label_end'>&quot;:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>child</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Support storing demodulized class name for polymorphic type.</p>

<p>Before Rails 6.1, storing demodulized class name is supported only for STI type
by <code>store_full_sti_class</code> class attribute.</p>

<p>Now <code>store_full_class_name</code> class attribute can handle both STI and polymorphic types.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Deprecate <code>rails db:structure:{load, dump}</code> tasks and extend
<code>rails db:schema:{load, dump}</code> tasks to work with either <code>:ruby</code> or <code>:sql</code> format,
depending on <code>config.active_record.schema_format</code> configuration value.</p>

<p><em>fatkodima</em></p></li>
<li><p>Respect the <code>select</code> values for eager loading.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_post'>post</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_select'>select</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>UPPER(title) AS title</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_title'>title</span> <span class='comment'># =&gt; &quot;WELCOME TO THE WEBLOG&quot;
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_body'>body</span>  <span class='comment'># =&gt; ActiveModel::MissingAttributeError
</span>
<span class='comment'># Rails 6.0 (ignore the `select` values)
</span><span class='id identifier rubyid_post'>post</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_select'>select</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>UPPER(title) AS title</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_eager_load'>eager_load</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>).<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_title'>title</span> <span class='comment'># =&gt; &quot;Welcome to the weblog&quot;
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_body'>body</span>  <span class='comment'># =&gt; &quot;Such a lovely day&quot;
</span>
<span class='comment'># Rails 6.1 (respect the `select` values)
</span><span class='id identifier rubyid_post'>post</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_select'>select</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>UPPER(title) AS title</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_eager_load'>eager_load</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>).<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_title'>title</span> <span class='comment'># =&gt; &quot;WELCOME TO THE WEBLOG&quot;
</span><span class='id identifier rubyid_post'>post</span>.<span class='id identifier rubyid_body'>body</span>  <span class='comment'># =&gt; ActiveModel::MissingAttributeError</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Allow attribute&#39;s default to be configured but keeping its own type.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_attribute'>attribute</span> <span class='symbeg'>:</span><span class='id identifier rubyid_written_at'>written_at</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='const'><a href="Time.html" title="Time (class)">Time</a></span>.<span class='id identifier rubyid_now'>now</span>.<span class='id identifier rubyid_utc'>utc</span> }
<span class='kw'>end</span>

<span class='comment'># Rails 6.0
</span><span class='const'>Post</span>.<span class='id identifier rubyid_type_for_attribute'>type_for_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_written_at'>written_at</span>) <span class='comment'># =&gt; #&lt;Type::Value ... precision: nil, ...&gt;
</span>
<span class='comment'># Rails 6.1
</span><span class='const'>Post</span>.<span class='id identifier rubyid_type_for_attribute'>type_for_attribute</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_written_at'>written_at</span>) <span class='comment'># =&gt; #&lt;Type::DateTime ... precision: 6, ...&gt;</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Allow default to be configured for Enum.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_enum'>enum</span> <span class='label'>status:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_proposed'>proposed</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_written'>written</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_published'>published</span>]<span class='comma'>,</span> <span class='label'>_default:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_published'>published</span>
<span class='kw'>end</span>

<span class='const'>Book</span>.<span class='id identifier rubyid_new'>new</span>.<span class='id identifier rubyid_status'>status</span> <span class='comment'># =&gt; &quot;published&quot;</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Deprecate YAML loading from legacy format older than <a href="Rails.html" title="Rails (module)"><code>Rails</code></a> 5.0.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Added the setting <a href="ActiveRecord/Base.html#immutable_strings_by_default-class_method" title="ActiveRecord::Base.immutable_strings_by_default (method)">ActiveRecord::Base.immutable_strings_by_default</a>, which
allows you to specify that all string columns should be frozen unless
otherwise specified. This will reduce memory pressure for applications which
do not generally mutate string properties of Active Record objects.</p>

<p><em>Sean Griffin</em>, <em>Ryuta Kamizono</em></p></li>
<li><p>Deprecate <code>map!</code> and <code>collect!</code> on <a href="ActiveRecord/Result.html" title="ActiveRecord::Result (class)"><code>::ActiveRecord::Result</code></a>.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Support <code>relation.and</code> for intersection as Set theory.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_david_and_mary'>david_and_mary</span> <span class='op'>=</span> <span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> [<span class='id identifier rubyid_david'>david</span><span class='comma'>,</span> <span class='id identifier rubyid_mary'>mary</span>])
<span class='id identifier rubyid_mary_and_bob'>mary_and_bob</span>   <span class='op'>=</span> <span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> [<span class='id identifier rubyid_mary'>mary</span><span class='comma'>,</span> <span class='id identifier rubyid_bob'>bob</span>])

<span class='id identifier rubyid_david_and_mary'>david_and_mary</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_mary_and_bob'>mary_and_bob</span>) <span class='comment'># =&gt; [mary, bob]
</span>
<span class='id identifier rubyid_david_and_mary'>david_and_mary</span>.<span class='id identifier rubyid_and'>and</span>(<span class='id identifier rubyid_mary_and_bob'>mary_and_bob</span>) <span class='comment'># =&gt; [mary]
</span><span class='id identifier rubyid_david_and_mary'>david_and_mary</span>.<span class='id identifier rubyid_or'>or</span>(<span class='id identifier rubyid_mary_and_bob'>mary_and_bob</span>)  <span class='comment'># =&gt; [david, mary, bob]</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Merging conditions on the same column no longer maintain both conditions,
and will be consistently replaced by the latter condition in Rails 7.0.
To migrate to Rails 7.0&#39;s behavior, use <code>relation.merge(other, rewhere: true)</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Rails 6.1 (IN clause is replaced by merger side equality condition)
</span><span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> [<span class='id identifier rubyid_david'>david</span>.<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_mary'>mary</span>.<span class='id identifier rubyid_id'>id</span>]).<span class='id identifier rubyid_merge'>merge</span>(<span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_bob'>bob</span>)) <span class='comment'># =&gt; [bob]
</span>
<span class='comment'># Rails 6.1 (both conflict conditions exists, deprecated)
</span><span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_david'>david</span>.<span class='id identifier rubyid_id'>id</span><span class='op'>..</span><span class='id identifier rubyid_mary'>mary</span>.<span class='id identifier rubyid_id'>id</span>).<span class='id identifier rubyid_merge'>merge</span>(<span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_bob'>bob</span>)) <span class='comment'># =&gt; []
</span>
<span class='comment'># Rails 6.1 with rewhere to migrate to Rails 7.0&#39;s behavior
</span><span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_david'>david</span>.<span class='id identifier rubyid_id'>id</span><span class='op'>..</span><span class='id identifier rubyid_mary'>mary</span>.<span class='id identifier rubyid_id'>id</span>).<span class='id identifier rubyid_merge'>merge</span>(<span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_bob'>bob</span>)<span class='comma'>,</span> <span class='label'>rewhere:</span> <span class='kw'>true</span>) <span class='comment'># =&gt; [bob]
</span>
<span class='comment'># Rails 7.0 (same behavior with IN clause, mergee side condition is consistently replaced)
</span><span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> [<span class='id identifier rubyid_david'>david</span>.<span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_mary'>mary</span>.<span class='id identifier rubyid_id'>id</span>]).<span class='id identifier rubyid_merge'>merge</span>(<span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_bob'>bob</span>)) <span class='comment'># =&gt; [bob]
</span><span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_david'>david</span>.<span class='id identifier rubyid_id'>id</span><span class='op'>..</span><span class='id identifier rubyid_mary'>mary</span>.<span class='id identifier rubyid_id'>id</span>).<span class='id identifier rubyid_merge'>merge</span>(<span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_bob'>bob</span>)) <span class='comment'># =&gt; [bob]</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Do not mark Postgresql MAC address and UUID attributes as changed when the assigned value only varies by case.</p>

<p><em>Peter Fry</em></p></li>
<li><p>Resolve issue with insert_all unique_by option when used with expression index.</p>

<p>When the <code>:unique_by</code> option of <code>ActiveRecord::Persistence.insert_all</code> and
<code>ActiveRecord::Persistence.upsert_all</code> was used with the name of an expression index, an error
was raised. Adding a guard around the formatting behavior for the <code>:unique_by</code> corrects this.</p>

<p>Usage:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbeg'>:</span><span class='id identifier rubyid_books'>books</span><span class='comma'>,</span> <span class='label'>id:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_integer'>integer</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>true</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_column'>column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_string'>string</span>
  <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_index'>index</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lower(name)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>unique:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='const'>Book</span>.<span class='id identifier rubyid_insert_all'>insert_all</span> [{ <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MyTest</span><span class='tstring_end'>&quot;</span></span> }]<span class='comma'>,</span> <span class='label'>unique_by:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_index_books_on_lower_name'>index_books_on_lower_name</span></code></pre>

<p>Fixes #39516.</p>

<p><em>Austen Madden</em></p></li>
<li><p>Add basic support for CHECK constraints to database migrations.</p>

<p>Usage:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_check_constraint'>add_check_constraint</span> <span class='symbeg'>:</span><span class='id identifier rubyid_products'>products</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>price &gt; 0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>price_check</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_remove_check_constraint'>remove_check_constraint</span> <span class='symbeg'>:</span><span class='id identifier rubyid_products'>products</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>price_check</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p><em>fatkodima</em></p></li>
<li><p>Add <a href="ActiveRecord/Base.html#strict_loading_by_default-class_method" title="ActiveRecord::Base.strict_loading_by_default (method)">ActiveRecord::Base.strict_loading_by_default</a> and <a href="ActiveRecord/Base.html#strict_loading_by_default=-class_method" title="ActiveRecord::Base.strict_loading_by_default= (method)">ActiveRecord::Base.strict_loading_by_default=</a>
to enable/disable strict_loading mode by default for a model. The configuration&#39;s value is
inheritable by subclasses, but they can override that value and it will not impact parent class.</p>

<p>Usage:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Developer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_strict_loading_by_default'>strict_loading_by_default</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_projects'>projects</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_dev'>dev</span> <span class='op'>=</span> <span class='const'>Developer</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_dev'>dev</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_first'>first</span>
<span class='comment'># =&gt; ActiveRecord::StrictLoadingViolationError Exception: Developer is marked as strict_loading and Project cannot be lazily loaded.</span></code></pre>

<p><em>bogdanvlviv</em></p></li>
<li><p>Deprecate passing an Active Record object to <code>quote</code>/<code>type_cast</code> directly.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Default engine <code>ENGINE=InnoDB</code> is no longer dumped to make schema more agnostic.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_create_table'>create_table</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>accounts</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>options:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>force:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cascade'>cascade</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
<span class='kw'>end</span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_create_table'>create_table</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>accounts</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>charset:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>utf8mb4</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>collation:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>utf8mb4_0900_ai_ci</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>force:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_cascade'>cascade</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
<span class='kw'>end</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Added delegated type as an alternative to single-table inheritance for representing class hierarchies.
See ActiveRecord::DelegatedType for the full description.</p>

<p><em>DHH</em></p></li>
<li><p>Deprecate aggregations with group by duplicated fields.</p>

<p>To migrate to Rails 7.0&#39;s behavior, use <code>uniq!(:group)</code> to deduplicate group fields.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_accounts'>accounts</span> <span class='op'>=</span> <span class='const'>Account</span>.<span class='id identifier rubyid_group'>group</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_firm_id'>firm_id</span>)

<span class='comment'># duplicated group fields, deprecated.
</span><span class='id identifier rubyid_accounts'>accounts</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_accounts'>accounts</span>.<span class='id identifier rubyid_where'>where</span>.<span class='id identifier rubyid_not'>not</span>(<span class='label'>credit_limit:</span> <span class='kw'>nil</span>)).<span class='id identifier rubyid_sum'>sum</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_credit_limit'>credit_limit</span>)
<span class='comment'># =&gt; {
</span><span class='comment'>#   [1, 1] =&gt; 50,
</span><span class='comment'>#   [2, 2] =&gt; 60
</span><span class='comment'># }
</span>
<span class='comment'># use `uniq!(:group)` to deduplicate group fields.
</span><span class='id identifier rubyid_accounts'>accounts</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_accounts'>accounts</span>.<span class='id identifier rubyid_where'>where</span>.<span class='id identifier rubyid_not'>not</span>(<span class='label'>credit_limit:</span> <span class='kw'>nil</span>)).<span class='id identifier rubyid_uniq!'>uniq!</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_group'>group</span>).<span class='id identifier rubyid_sum'>sum</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_credit_limit'>credit_limit</span>)
<span class='comment'># =&gt; {
</span><span class='comment'>#   1 =&gt; 50,
</span><span class='comment'>#   2 =&gt; 60
</span><span class='comment'># }</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Deprecate duplicated query annotations.</p>

<p>To migrate to Rails 7.0&#39;s behavior, use <code>uniq!(:annotate)</code> to deduplicate query annotations.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_accounts'>accounts</span> <span class='op'>=</span> <span class='const'>Account</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> [<span class='int'>1</span><span class='comma'>,</span> <span class='int'>2</span>]).<span class='id identifier rubyid_annotate'>annotate</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>david and mary</span><span class='tstring_end'>&quot;</span></span>)

<span class='comment'># duplicated annotations, deprecated.
</span><span class='id identifier rubyid_accounts'>accounts</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_accounts'>accounts</span>.<span class='id identifier rubyid_rewhere'>rewhere</span>(<span class='label'>id:</span> <span class='int'>3</span>))
<span class='comment'># SELECT accounts.* FROM accounts WHERE accounts.id = 3 /* david and mary */ /* david and mary */
</span>
<span class='comment'># use `uniq!(:annotate)` to deduplicate annotations.
</span><span class='id identifier rubyid_accounts'>accounts</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_accounts'>accounts</span>.<span class='id identifier rubyid_rewhere'>rewhere</span>(<span class='label'>id:</span> <span class='int'>3</span>)).<span class='id identifier rubyid_uniq!'>uniq!</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_annotate'>annotate</span>)
<span class='comment'># SELECT accounts.* FROM accounts WHERE accounts.id = 3 /* david and mary */</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Resolve conflict between counter cache and optimistic locking.</p>

<p>Bump an Active Record instance&#39;s lock version after updating its counter
cache. This avoids raising an unnecessary <a href="ActiveRecord/StaleObjectError.html" title="ActiveRecord::StaleObjectError (class)"><code>::ActiveRecord::StaleObjectError</code></a>
upon subsequent transactions by maintaining parity with the corresponding
database record&#39;s <code>lock_version</code> column.</p>

<p>Fixes #16449.</p>

<p><em>Aaron Lipman</em></p></li>
<li><p>Support merging option <code>:rewhere</code> to allow mergee side condition to be replaced exactly.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_david_and_mary'>david_and_mary</span> <span class='op'>=</span> <span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_david'>david</span>.<span class='id identifier rubyid_id'>id</span><span class='op'>..</span><span class='id identifier rubyid_mary'>mary</span>.<span class='id identifier rubyid_id'>id</span>)

<span class='comment'># both conflict conditions exists
</span><span class='id identifier rubyid_david_and_mary'>david_and_mary</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_bob'>bob</span>)) <span class='comment'># =&gt; []
</span>
<span class='comment'># mergee side condition is replaced by rewhere
</span><span class='id identifier rubyid_david_and_mary'>david_and_mary</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='const'>Author</span>.<span class='id identifier rubyid_rewhere'>rewhere</span>(<span class='label'>id:</span> <span class='id identifier rubyid_bob'>bob</span>)) <span class='comment'># =&gt; [bob]
</span>
<span class='comment'># mergee side condition is replaced by rewhere option
</span><span class='id identifier rubyid_david_and_mary'>david_and_mary</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='const'>Author</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>id:</span> <span class='id identifier rubyid_bob'>bob</span>)<span class='comma'>,</span> <span class='label'>rewhere:</span> <span class='kw'>true</span>) <span class='comment'># =&gt; [bob]</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Add support for finding records based on signed ids, which are tamper-proof, verified ids that can be
set to expire and scoped with a purpose. This is particularly useful for things like password reset
or email verification, where you want the bearer of the signed id to be able to interact with the
underlying record, but usually only within a certain time period.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_signed_id'>signed_id</span> <span class='op'>=</span> <span class='const'>User</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_signed_id'>signed_id</span> <span class='label'>expires_in:</span> <span class='int'>15</span>.<span class='id identifier rubyid_minutes'>minutes</span><span class='comma'>,</span> <span class='label'>purpose:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_password_reset'>password_reset</span>

<span class='const'>User</span>.<span class='id identifier rubyid_find_signed'>find_signed</span> <span class='id identifier rubyid_signed_id'>signed_id</span> <span class='comment'># =&gt; nil, since the purpose does not match
</span>
<span class='id identifier rubyid_travel'>travel</span> <span class='int'>16</span>.<span class='id identifier rubyid_minutes'>minutes</span>
<span class='const'>User</span>.<span class='id identifier rubyid_find_signed'>find_signed</span> <span class='id identifier rubyid_signed_id'>signed_id</span><span class='comma'>,</span> <span class='label'>purpose:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_password_reset'>password_reset</span> <span class='comment'># =&gt; nil, since the signed id has expired
</span>
<span class='id identifier rubyid_travel_back'>travel_back</span>
<span class='const'>User</span>.<span class='id identifier rubyid_find_signed'>find_signed</span> <span class='id identifier rubyid_signed_id'>signed_id</span><span class='comma'>,</span> <span class='label'>purpose:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_password_reset'>password_reset</span> <span class='comment'># =&gt; User.first
</span>
<span class='const'>User</span>.<span class='id identifier rubyid_find_signed!'>find_signed!</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bad data</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># =&gt; ActiveSupport::MessageVerifier::InvalidSignature</span></code></pre>

<p><em>DHH</em></p></li>
<li><p>Support <code>ALGORITHM = INSTANT</code> DDL option for index operations on MySQL.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Fix index creation to preserve index comment in bulk change table on MySQL.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Allow <code>unscope</code> to be aware of table name qualified values.</p>

<p>It is possible to unscope only the column in the specified table.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_posts'>posts</span> <span class='op'>=</span> <span class='const'>Post</span>.<span class='id identifier rubyid_joins'>joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_comments'>comments</span>).<span class='id identifier rubyid_group'>group</span>(<span class='symbeg'>:&quot;</span><span class='tstring_content'>posts.hidden</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_posts'>posts</span> <span class='op'>=</span> <span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>posts.hidden</span><span class='label_end'>&quot;:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>comments.hidden</span><span class='label_end'>&quot;:</span> <span class='kw'>false</span>)

<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_count'>count</span>
<span class='comment'># =&gt; { false =&gt; 10 }
</span>
<span class='comment'># unscope both hidden columns
</span><span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_unscope'>unscope</span>(<span class='label'>where:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_hidden'>hidden</span>).<span class='id identifier rubyid_count'>count</span>
<span class='comment'># =&gt; { false =&gt; 11, true =&gt; 1 }
</span>
<span class='comment'># unscope only comments.hidden column
</span><span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_unscope'>unscope</span>(<span class='label'>where:</span> <span class='symbeg'>:&quot;</span><span class='tstring_content'>comments.hidden</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_count'>count</span>
<span class='comment'># =&gt; { false =&gt; 11 }</span></code></pre>

<p><em>Ryuta Kamizono</em>, <em>Slava Korolev</em></p></li>
<li><p>Fix <code>rewhere</code> to truly overwrite collided where clause by new where clause.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_steve'>steve</span> <span class='op'>=</span> <span class='const'>Person</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Steve</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_david'>david</span> <span class='op'>=</span> <span class='const'>Author</span>.<span class='id identifier rubyid_find_by'>find_by</span>(<span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>David</span><span class='tstring_end'>&quot;</span></span>)

<span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='const'>Essay</span>.<span class='id identifier rubyid_where'>where</span>(<span class='label'>writer:</span> <span class='id identifier rubyid_steve'>steve</span>)

<span class='comment'># Before
</span><span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_rewhere'>rewhere</span>(<span class='label'>writer:</span> <span class='id identifier rubyid_david'>david</span>).<span class='id identifier rubyid_to_a'>to_a</span> <span class='comment'># =&gt; []
</span>
<span class='comment'># After
</span><span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_rewhere'>rewhere</span>(<span class='label'>writer:</span> <span class='id identifier rubyid_david'>david</span>).<span class='id identifier rubyid_to_a'>to_a</span> <span class='comment'># =&gt; [david]</span></code></pre>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Inspect time attributes with subsec and time zone offset.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_p'>p</span> <span class='const'>Knot</span>.<span class='id identifier rubyid_create'>create</span>
<span class='comment'>#=&gt; #&lt;Knot id: 1, created_at: &quot;2016-05-05 01:29:47.116928000 +0000&quot;&gt;</span></code></pre>

<p><em>akinomaeni</em>, <em>Jonathan Hefner</em></p></li>
<li><p>Deprecate passing a column to <code>type_cast</code>.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Deprecate <code>in_clause_length</code> and <code>allowed_index_name_length</code> in <code>DatabaseLimits</code>.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Support bulk insert/upsert on relation to preserve scope values.</p>

<p><em>Josef Šimánek</em>, <em>Ryuta Kamizono</em></p></li>
<li><p>Preserve column comment value on changing column name on MySQL.</p>

<p><em>Islam Taha</em></p></li>
<li><p>Add support for <code>if_exists</code> option for removing an index.</p>

<p>The <code>remove_index</code> method can take an <code>if_exists</code> option. If this is set to true an error won&#39;t be raised if the index doesn&#39;t exist.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Remove ibm_db, informix, mssql, oracle, and oracle12 <a href="Arel.html" title="Arel (module)"><code>Arel</code></a> visitors which are not used in the code base.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Prevent <code>build_association</code> from <code>touching</code> a parent record if the record isn&#39;t persisted for <code>has_one</code> associations.</p>

<p>Fixes #38219.</p>

<p><em>Josh Brody</em></p></li>
<li><p>Add support for <code>if_not_exists</code> option for adding index.</p>

<p>The <code>add_index</code> method respects <code>if_not_exists</code> option. If it is set to true
index won&#39;t be added.</p>

<p>Usage:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_index'>add_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_users'>users</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_account_id'>account_id</span><span class='comma'>,</span> <span class='label'>if_not_exists:</span> <span class='kw'>true</span></code></pre>

<p>The <code>if_not_exists</code> option passed to <code>create_table</code> also gets propagated to indexes
created within that migration so that if table and its indexes exist then there is no
attempt to create them again.</p>

<p><em>Prathamesh Sonpatki</em></p></li>
<li><p>Add <code>ActiveRecord::Base#previously_new_record?</code> to show if a record was new before the last save.</p>

<p><em>Tom Ward</em></p></li>
<li><p>Support descending order for <code>find_each</code>, <code>find_in_batches</code>, and <code>in_batches</code>.</p>

<p>Batch processing methods allow you to work with the records in batches, greatly reducing memory consumption, but records are always batched from oldest id to newest.</p>

<p>This change allows reversing the order, batching from newest to oldest. This is useful when you need to process newer batches of records first.</p>

<p>Pass <code>order: :desc</code> to yield batches in descending order. The default remains <code>order: :asc</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_find_each'>find_each</span>(<span class='label'>order:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_desc'>desc</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span>
<span class='kw'>end</span></code></pre>

<p><em>Alexey Vasiliev</em></p></li>
<li><p>Fix <code>insert_all</code> with enum values.</p>

<p>Fixes #38716.</p>

<p><em>Joel Blum</em></p></li>
<li><p>Add support for <code>db:rollback:name</code> for multiple database applications.</p>

<p>Multiple database applications will now raise if <code>db:rollback</code> is call and recommend using the <code>db:rollback:[NAME]</code> to rollback migrations.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p><code>Relation#pick</code> now uses already loaded results instead of making another query.</p>

<p><em>Eugene Kenny</em></p></li>
<li><p>Deprecate using <code>return</code>, <code>break</code> or <code>throw</code> to exit a transaction block after writes.</p>

<p><em>Dylan Thacker-Smith</em></p></li>
<li><p>Dump the schema or structure of a database when calling <code>db:migrate:name</code>.</p>

<p>In previous versions of Rails, <code>rails db:migrate</code> would dump the schema of the database. In Rails 6, that holds true (<code>rails db:migrate</code> dumps all databases&#39; schemas), but <code>rails db:migrate:name</code> does not share that behavior.</p>

<p>Going forward, calls to <code>rails db:migrate:name</code> will dump the schema (or structure) of the database being migrated.</p>

<p><em>Kyle Thompson</em></p></li>
<li><p>Reset the <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> connection after <code>rails db:migrate:name</code>.</p>

<p>When <code>rails db:migrate</code> has finished, it ensures the <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> connection is reset to its original configuration. Going forward, <code>rails db:migrate:name</code> will have the same behavior.</p>

<p><em>Kyle Thompson</em></p></li>
<li><p>Disallow calling <code>connected_to</code> on subclasses of <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a>.</p>

<p>Behavior has not changed here but the previous API could be misleading to people who thought it would switch connections for only that class. <code>connected_to</code> switches the context from which we are getting connections, not the connections themselves.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Add support for horizontal sharding to <code>connects_to</code> and <code>connected_to</code>.</p>

<p>Applications can now connect to multiple shards and switch between their shards in an application. Note that the shard swapping is still a manual process as this change does not include an API for automatic shard swapping.</p>

<p>Usage:</p>

<p>Given the following configuration:</p>

<pre class="code yaml"><code class="yaml"># config/database.yml
production:
  primary:
    database: my_database
  primary_shard_one:
    database: my_database_shard_one
</code></pre>

<p>Connect to multiple shards:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>ApplicationRecord</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='kw'>self</span>.<span class='id identifier rubyid_abstract_class'>abstract_class</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='id identifier rubyid_connects_to'>connects_to</span> <span class='label'>shards:</span> {
    <span class='label'>default:</span> { <span class='label'>writing:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary'>primary</span> }<span class='comma'>,</span>
    <span class='label'>shard_one:</span> { <span class='label'>writing:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_primary_shard_one'>primary_shard_one</span> }
  }</code></pre>

<p>Swap between shards in your controller / model code:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_connected_to'><a href="ActiveRecord/ConnectionHandling.html#connected_to-instance_method" title="ActiveRecord::ConnectionHandling#connected_to (method)">connected_to</a></span>(<span class='label'>shard:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_shard_one'>shard_one</span>) <span class='kw'>do</span>
  <span class='comment'># Read from shard one
</span><span class='kw'>end</span></code></pre>

<p>The horizontal sharding API also supports read replicas. See guides for more details.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Deprecate <code>spec_name</code> in favor of <code>name</code> on database configurations.</p>

<p>The accessors for <code>spec_name</code> on <code>configs_for</code> and <code>DatabaseConfig</code> are deprecated. Please use <code>name</code> instead.</p>

<p>Deprecated behavior:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_db_config'>db_config</span> <span class='op'>=</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_configurations'><a href="ActiveRecord/Base.html#configurations-class_method" title="ActiveRecord::Base.configurations (method)">configurations</a></span>.<span class='id identifier rubyid_configs_for'>configs_for</span>(<span class='label'>env_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>development</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>spec_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>primary</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_db_config'>db_config</span>.<span class='id identifier rubyid_spec_name'>spec_name</span></code></pre>

<p>New behavior:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_db_config'>db_config</span> <span class='op'>=</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_configurations'><a href="ActiveRecord/Base.html#configurations-class_method" title="ActiveRecord::Base.configurations (method)">configurations</a></span>.<span class='id identifier rubyid_configs_for'>configs_for</span>(<span class='label'>env_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>development</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>primary</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_db_config'>db_config</span>.<span class='id identifier rubyid_name'>name</span></code></pre>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Add additional database-specific rake tasks for multi-database users.</p>

<p>Previously, <code>rails db:create</code>, <code>rails db:drop</code>, and <code>rails db:migrate</code> were the only rails tasks that could operate on a single
database. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='id identifier rubyid_create'>create</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>create:</span><span class='id identifier rubyid_primary'>primary</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>create:</span><span class='id identifier rubyid_animals'>animals</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='id identifier rubyid_drop'>drop</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>drop:</span><span class='id identifier rubyid_primary'>primary</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>drop:</span><span class='id identifier rubyid_animals'>animals</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='id identifier rubyid_migrate'>migrate</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>migrate:</span><span class='id identifier rubyid_primary'>primary</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>migrate:</span><span class='id identifier rubyid_animals'>animals</span></code></pre>

<p>With these changes, <code>rails db:schema:dump</code>, <code>rails db:schema:load</code>, <code>rails db:structure:dump</code>, <code>rails db:structure:load</code> and
<code>rails db:test:prepare</code> can additionally operate on a single database. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>schema:</span><span class='id identifier rubyid_dump'>dump</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>schema:</span><span class='id identifier rubyid_dump'>dump</span><span class='symbeg'>:</span><span class='id identifier rubyid_primary'>primary</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>schema:</span><span class='id identifier rubyid_dump'>dump</span><span class='symbeg'>:</span><span class='id identifier rubyid_animals'>animals</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>schema:</span><span class='id identifier rubyid_load'><a href="ActiveSupport/MarshalWithAutoloading.html#load-instance_method" title="ActiveSupport::MarshalWithAutoloading#load (method)">load</a></span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>schema:</span><span class='id identifier rubyid_load'><a href="ActiveSupport/MarshalWithAutoloading.html#load-instance_method" title="ActiveSupport::MarshalWithAutoloading#load (method)">load</a></span><span class='symbeg'>:</span><span class='id identifier rubyid_primary'>primary</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>schema:</span><span class='id identifier rubyid_load'><a href="ActiveSupport/MarshalWithAutoloading.html#load-instance_method" title="ActiveSupport::MarshalWithAutoloading#load (method)">load</a></span><span class='symbeg'>:</span><span class='id identifier rubyid_animals'>animals</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>structure:</span><span class='id identifier rubyid_dump'>dump</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>structure:</span><span class='id identifier rubyid_dump'>dump</span><span class='symbeg'>:</span><span class='id identifier rubyid_primary'>primary</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>structure:</span><span class='id identifier rubyid_dump'>dump</span><span class='symbeg'>:</span><span class='id identifier rubyid_animals'>animals</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>structure:</span><span class='id identifier rubyid_load'><a href="ActiveSupport/MarshalWithAutoloading.html#load-instance_method" title="ActiveSupport::MarshalWithAutoloading#load (method)">load</a></span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>structure:</span><span class='id identifier rubyid_load'><a href="ActiveSupport/MarshalWithAutoloading.html#load-instance_method" title="ActiveSupport::MarshalWithAutoloading#load (method)">load</a></span><span class='symbeg'>:</span><span class='id identifier rubyid_primary'>primary</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>structure:</span><span class='id identifier rubyid_load'><a href="ActiveSupport/MarshalWithAutoloading.html#load-instance_method" title="ActiveSupport::MarshalWithAutoloading#load (method)">load</a></span><span class='symbeg'>:</span><span class='id identifier rubyid_animals'>animals</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>test:</span><span class='id identifier rubyid_prepare'>prepare</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>test:</span><span class='id identifier rubyid_prepare'>prepare</span><span class='symbeg'>:</span><span class='id identifier rubyid_primary'>primary</span>
<span class='id identifier rubyid_rails'>rails</span> <span class='label'>db:</span><span class='label'>test:</span><span class='id identifier rubyid_prepare'>prepare</span><span class='symbeg'>:</span><span class='id identifier rubyid_animals'>animals</span></code></pre>

<p><em>Kyle Thompson</em></p></li>
<li><p>Add support for <code>strict_loading</code> mode on association declarations.</p>

<p>Raise an error if attempting to load a record from an association that has been marked as <code>strict_loading</code> unless it was explicitly eager loaded.</p>

<p>Usage:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Developer</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_projects'>projects</span><span class='comma'>,</span> <span class='label'>strict_loading:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_dev'>dev</span> <span class='op'>=</span> <span class='const'>Developer</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_dev'>dev</span>.<span class='id identifier rubyid_projects'>projects</span>.<span class='id identifier rubyid_first'>first</span>
<span class='comment'># =&gt; ActiveRecord::StrictLoadingViolationError: The projects association is marked as strict_loading and cannot be lazily loaded.</span></code></pre>

<p><em>Kevin Deisz</em></p></li>
<li><p>Add support for <code>strict_loading</code> mode to prevent lazy loading of records.</p>

<p>Raise an error if a parent record is marked as <code>strict_loading</code> and attempts to lazily load its associations. This is useful for finding places you may want to preload an association and avoid additional queries.</p>

<p>Usage:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_dev'>dev</span> <span class='op'>=</span> <span class='const'>Developer</span>.<span class='id identifier rubyid_strict_loading'>strict_loading</span>.<span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_dev'>dev</span>.<span class='id identifier rubyid_audit_logs'>audit_logs</span>.<span class='id identifier rubyid_to_a'>to_a</span>
<span class='comment'># =&gt; ActiveRecord::StrictLoadingViolationError: Developer is marked as strict_loading and AuditLog cannot be lazily loaded.</span></code></pre>

<p><em>Eileen M. Uchitelle</em>, <em>Aaron Patterson</em></p></li>
<li><p>Add support for PostgreSQL 11+ partitioned indexes when using <code>upsert_all</code>.</p>

<p><em>Sebastián Palma</em></p></li>
<li><p>Adds support for <code>if_not_exists</code> to <code>add_column</code> and <code>if_exists</code> to <code>remove_column</code>.</p>

<p>Applications can set their migrations to ignore exceptions raised when adding a column that already exists or when removing a column that does not exist.</p>

<p>Example Usage:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>AddColumnTitle</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Migration.html" title="ActiveRecord::Migration (class)">Migration</a></span>[<span class='float'>6.1</span>]
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_add_column'>add_column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_string'>string</span><span class='comma'>,</span> <span class='label'>if_not_exists:</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>RemoveColumnTitle</span> <span class='op'>&lt;</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Migration.html" title="ActiveRecord::Migration (class)">Migration</a></span>[<span class='float'>6.1</span>]
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_remove_column'>remove_column</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='label'>if_exists:</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Regexp-escape table name for MS SQL Server.</p>

<p>Add <code>Regexp.escape</code> to one method in ActiveRecord, so that table names with regular expression characters in them work as expected. Since MS SQL Server uses &quot;[&quot; and &quot;]&quot; to quote table and column names, and those characters are regular expression characters, methods like <code>pluck</code> and <code>select</code> fail in certain cases when used with the MS SQL Server adapter.</p>

<p><em>Larry Reid</em></p></li>
<li><p>Store advisory locks on their own named connection.</p>

<p>Previously advisory locks were taken out against a connection when a migration started. This works fine in single database applications but doesn&#39;t work well when migrations need to open new connections which results in the lock getting dropped.</p>

<p>In order to fix this we are storing the advisory lock on a new connection with the connection specification name <code>AdvisoryLockBase</code>. The caveat is that we need to maintain at least 2 connections to a database while migrations are running in order to do this.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Allow schema cache path to be defined in the database configuration file.</p>

<p>For example:</p>

<pre class="code yaml"><code class="yaml">development:
  adapter: postgresql
  database: blog_development
  pool: 5
  schema_cache_path: tmp/schema/main.yml
</code></pre>

<p><em>Katrina Owen</em></p></li>
<li><p>Deprecate <code>#remove_connection</code> in favor of <code>#remove_connection_pool</code> when called on the handler.</p>

<p><code>#remove_connection</code> is deprecated in order to support returning a <code>DatabaseConfig</code> object instead of a <a href="Hash.html" title="Hash (class)"><code>Hash</code></a>. Use <code>#remove_connection_pool</code>, <code>#remove_connection</code> will be removed in Rails 7.0.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Deprecate <code>#default_hash</code> and it&#39;s alias <code>#[]</code> on database configurations.</p>

<p>Applications should use <code>configs_for</code>. <code>#default_hash</code> and <code>#[]</code> will be removed in Rails 7.0.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Add scale support to <a href="ActiveRecord/Validations/NumericalityValidator.html" title="ActiveRecord::Validations::NumericalityValidator (class)"><code>::ActiveRecord::Validations::NumericalityValidator</code></a>.</p>

<p><em>Gannon McGibbon</em></p></li>
<li><p>Find orphans by looking for missing relations through chaining <code>where.missing</code>:</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_left_joins'>left_joins</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>).<span class='id identifier rubyid_where'>where</span>(<span class='label'>authors:</span> { <span class='label'>id:</span> <span class='kw'>nil</span> })</code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span>.<span class='id identifier rubyid_where'>where</span>.<span class='id identifier rubyid_missing'>missing</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>)</code></pre>

<p><em>Tom Rossi</em></p></li>
<li><p>Ensure <code>:reading</code> connections always raise if a write is attempted.</p>

<p>Now Rails will raise an <a href="ActiveRecord/ReadOnlyError.html" title="ActiveRecord::ReadOnlyError (class)"><code>::ActiveRecord::ReadOnlyError</code></a> if any connection on the reading handler attempts to make a write. If your reading role needs to write you should name the role something other than <code>:reading</code>.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Deprecate <code>&quot;primary&quot;</code> as the <code>connection_specification_name</code> for <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a>.</p>

<p><code>&quot;primary&quot;</code> has been deprecated as the <code>connection_specification_name</code> for <a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)"><code>::ActiveRecord::Base</code></a> in favor of using <code>&quot;ActiveRecord::Base&quot;</code>. This change affects calls to <code>ActiveRecord::Base.connection_handler.retrieve_connection</code> and <code>ActiveRecord::Base.connection_handler.remove_connection</code>. If you&#39;re calling these methods with <code>&quot;primary&quot;</code>, please switch to <code>&quot;ActiveRecord::Base&quot;</code>.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Add <a href="ActiveRecord/Validations/NumericalityValidator.html" title="ActiveRecord::Validations::NumericalityValidator (class)"><code>::ActiveRecord::Validations::NumericalityValidator</code></a> with
support for casting floats using a database columns&#39; precision value.</p>

<p><em>Gannon McGibbon</em></p></li>
<li><p>Enforce fresh ETag header after a collection&#39;s contents change by adding
ActiveRecord::Relation#cache_key_with_version. This method will be used by
ActionController::ConditionalGet to ensure that when collection cache versioning
is enabled, requests using ConditionalGet don&#39;t return the same ETag header
after a collection is modified.</p>

<p>Fixes #38078.</p>

<p><em>Aaron Lipman</em></p></li>
<li><p>Skip test database when running <code>db:create</code> or <code>db:drop</code> in development
with <code>DATABASE_URL</code> set.</p>

<p><em>Brian Buchalter</em></p></li>
<li><p>Don&#39;t allow mutations on the database configurations hash.</p>

<p>Freeze the configurations hash to disallow directly changing it. If applications need to change the hash, for example to create databases for parallelization, they should use the <code>DatabaseConfig</code> object directly.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@db_config</span> <span class='op'>=</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_configurations'><a href="ActiveRecord/Base.html#configurations-class_method" title="ActiveRecord::Base.configurations (method)">configurations</a></span>.<span class='id identifier rubyid_configs_for'>configs_for</span>(<span class='label'>env_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>spec_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>primary</span><span class='tstring_end'>&quot;</span></span>)
<span class='ivar'>@db_config</span>.<span class='id identifier rubyid_configuration_hash'>configuration_hash</span>.<span class='id identifier rubyid_merge!'>merge!</span>(<span class='label'>idle_timeout:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.02</span><span class='tstring_end'>&quot;</span></span>)</code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@db_config</span> <span class='op'>=</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/Base.html" title="ActiveRecord::Base (class)">Base</a></span>.<span class='id identifier rubyid_configurations'><a href="ActiveRecord/Base.html#configurations-class_method" title="ActiveRecord::Base.configurations (method)">configurations</a></span>.<span class='id identifier rubyid_configs_for'>configs_for</span>(<span class='label'>env_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>spec_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>primary</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_config'>config</span> <span class='op'>=</span> <span class='ivar'>@db_config</span>.<span class='id identifier rubyid_configuration_hash'>configuration_hash</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='label'>idle_timeout:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.02</span><span class='tstring_end'>&quot;</span></span>)
<span class='id identifier rubyid_db_config'>db_config</span> <span class='op'>=</span> <span class='const'><a href="ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/DatabaseConfigurations.html" title="ActiveRecord::DatabaseConfigurations (class)">DatabaseConfigurations</a></span><span class='op'>::</span><span class='const'><a href="ActiveRecord/DatabaseConfigurations/HashConfig.html" title="ActiveRecord::DatabaseConfigurations::HashConfig (class)">HashConfig</a></span>.<span class='id identifier rubyid_new'><a href="ActiveRecord/DatabaseConfigurations/HashConfig.html#new-class_method" title="ActiveRecord::DatabaseConfigurations::HashConfig.new (method)">new</a></span>(<span class='ivar'>@db_config</span>.<span class='id identifier rubyid_env_name'>env_name</span><span class='comma'>,</span> <span class='ivar'>@db_config</span>.<span class='id identifier rubyid_spec_name'>spec_name</span><span class='comma'>,</span> <span class='id identifier rubyid_config'>config</span>)</code></pre>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Remove <code>:connection_id</code> from the <code>sql.active_record</code> notification.</p>

<p><em>Aaron Patterson</em>, <em>Rafael Mendonça França</em></p></li>
<li><p>The <code>:name</code> key will no longer be returned as part of <code>DatabaseConfig#configuration_hash</code>. Please use <code>DatabaseConfig#owner_name</code> instead.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>ActiveRecord&#39;s <code>belongs_to_required_by_default</code> flag can now be set per model.</p>

<p>You can now opt-out/opt-in specific models from having their associations required
by default.</p>

<p>This change is meant to ease the process of migrating all your models to have
their association required.</p>

<p><em>Edouard Chin</em></p></li>
<li><p>The <code>connection_config</code> method has been deprecated, please use <code>connection_db_config</code> instead which will return a <code>DatabaseConfigurations::DatabaseConfig</code> instead of a <a href="Hash.html" title="Hash (class)"><code>Hash</code></a>.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Retain explicit selections on the base model after applying <code>includes</code> and <code>joins</code>.</p>

<p>Resolves #34889.</p>

<p><em>Patrick Rebsch</em></p></li>
<li><p>The <code>database</code> kwarg is deprecated without replacement because it can&#39;t be used for sharding and creates an issue if it&#39;s used during a request. Applications that need to create new connections should use <code>connects_to</code> instead.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Allow attributes to be fetched from <a href="Arel.html" title="Arel (module)"><code>Arel</code></a> node groupings.</p>

<p><em>Jeff Emminger</em>, <em>Gannon McGibbon</em></p></li>
<li><p>A database URL can now contain a querystring value that contains an equal sign. This is needed to support passing PostgreSQL <code>options</code>.</p>

<p><em>Joshua Flanagan</em></p></li>
<li><p>Calling methods like <code>establish_connection</code> with a <a href="Hash.html" title="Hash (class)"><code>Hash</code></a> which is invalid (eg: no <code>adapter</code>) will now raise an error the same way as connections defined in <code>config/database.yml</code>.</p>

<p><em>John Crepezzi</em></p></li>
<li><p>Specifying <code>implicit_order_column</code> now subsorts the records by primary key if available to ensure deterministic results.</p>

<p><em>Paweł Urbanek</em></p></li>
<li><p><code>where(attr =&gt; [])</code> now loads an empty result without making a query.</p>

<p><em>John Hawthorn</em></p></li>
<li><p>Fixed the performance regression for <code>primary_keys</code> introduced MySQL 8.0.</p>

<p><em>Hiroyuki Ishii</em></p></li>
<li><p>Add support for <code>belongs_to</code> to <code>has_many</code> inversing.</p>

<p><em>Gannon McGibbon</em></p></li>
<li><p>Allow length configuration for <code>has_secure_token</code> method. The minimum length
is set at 24 characters.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_secure_token'>has_secure_token</span> <span class='symbeg'>:</span><span class='id identifier rubyid_auth_token'>auth_token</span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_has_secure_token'>has_secure_token</span> <span class='symbeg'>:</span><span class='id identifier rubyid_default_token'>default_token</span>             <span class='comment'># 24 characters
</span><span class='id identifier rubyid_has_secure_token'>has_secure_token</span> <span class='symbeg'>:</span><span class='id identifier rubyid_auth_token'>auth_token</span><span class='comma'>,</span> <span class='label'>length:</span> <span class='int'>36</span>    <span class='comment'># 36 characters
</span><span class='id identifier rubyid_has_secure_token'>has_secure_token</span> <span class='symbeg'>:</span><span class='id identifier rubyid_invalid_token'>invalid_token</span><span class='comma'>,</span> <span class='label'>length:</span> <span class='int'>12</span> <span class='comment'># =&gt; ActiveRecord::SecureToken::MinimumLengthError</span></code></pre>

<p><em>Bernardo de Araujo</em></p></li>
<li><p>Deprecate <code>DatabaseConfigurations#to_h</code>. These connection hashes are still available via <code>ActiveRecord::Base.configurations.configs_for</code>.</p>

<p><em>Eileen Uchitelle</em>, <em>John Crepezzi</em></p></li>
<li><p>Add <code>DatabaseConfig#configuration_hash</code> to return database configuration hashes with symbol keys, and use all symbol-key configuration hashes internally. Deprecate <code>DatabaseConfig#config</code> which returns a String-keyed <a href="Hash.html" title="Hash (class)"><code>Hash</code></a> with the same values.</p>

<p><em>John Crepezzi</em>, <em>Eileen Uchitelle</em></p></li>
<li><p>Allow column names to be passed to <code>remove_index</code> positionally along with other options.</p>

<p>Passing other options can be necessary to make <code>remove_index</code> correctly reversible.</p>

<p>Before:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_index'>add_index</span>    <span class='symbeg'>:</span><span class='id identifier rubyid_reports'>reports</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_report_id'>report_id</span>               <span class='comment'># =&gt; works
</span><span class='id identifier rubyid_add_index'>add_index</span>    <span class='symbeg'>:</span><span class='id identifier rubyid_reports'>reports</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_report_id'>report_id</span><span class='comma'>,</span> <span class='label'>unique:</span> <span class='kw'>true</span> <span class='comment'># =&gt; works
</span><span class='id identifier rubyid_remove_index'>remove_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reports'>reports</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_report_id'>report_id</span>               <span class='comment'># =&gt; works
</span><span class='id identifier rubyid_remove_index'>remove_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reports'>reports</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_report_id'>report_id</span><span class='comma'>,</span> <span class='label'>unique:</span> <span class='kw'>true</span> <span class='comment'># =&gt; ArgumentError</span></code></pre>

<p>After:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_remove_index'>remove_index</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reports'>reports</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_report_id'>report_id</span><span class='comma'>,</span> <span class='label'>unique:</span> <span class='kw'>true</span> <span class='comment'># =&gt; works</span></code></pre>

<p><em>Eugene Kenny</em></p></li>
<li><p>Allow bulk <code>ALTER</code> statements to drop and recreate indexes with the same name.</p>

<p><em>Eugene Kenny</em></p></li>
<li><p><code>insert</code>, <code>insert_all</code>, <code>upsert</code>, and <code>upsert_all</code> now clear the query cache.</p>

<p><em>Eugene Kenny</em></p></li>
<li><p>Call <code>while_preventing_writes</code> directly from <code>connected_to</code>.</p>

<p>In some cases application authors want to use the database switching middleware and make explicit calls with <code>connected_to</code>. It&#39;s possible for an app to turn off writes and not turn them back on by the time we call <code>connected_to(role: :writing)</code>.</p>

<p>This change allows apps to fix this by assuming if a role is writing we want to allow writes, except in the case it&#39;s explicitly turned off.</p>

<p><em>Eileen M. Uchitelle</em></p></li>
<li><p>Improve detection of <a href="ActiveRecord/StatementTimeout.html" title="ActiveRecord::StatementTimeout (class)"><code>::ActiveRecord::StatementTimeout</code></a> with mysql2 adapter in the edge case when the query is terminated during filesort.</p>

<p><em>Kir Shatrov</em></p></li>
<li><p>Stop trying to read yaml file fixtures when loading Active Record fixtures.</p>

<p><em>Gannon McGibbon</em></p></li>
<li><p>Deprecate <code>.reorder(nil)</code> with <code>.first</code> / <code>.first!</code> taking non-deterministic result.</p>

<p>To continue taking non-deterministic result, use <code>.take</code> / <code>.take!</code> instead.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Preserve user supplied joins order as much as possible.</p>

<p>Fixes #36761, #34328, #24281, #12953.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Allow <code>matches_regex</code> and <code>does_not_match_regexp</code> on the MySQL Arel visitor.</p>

<p><em>James Pearson</em></p></li>
<li><p>Allow specifying fixtures to be ignored by setting <code>ignore</code> in YAML file&#39;s &#39;_fixture&#39; section.</p>

<p><em>Tongfei Gao</em></p></li>
<li><p>Make the DATABASE_URL env variable only affect the primary connection. Add new env variables for multiple databases.</p>

<p><em>John Crepezzi</em>, <em>Eileen Uchitelle</em></p></li>
<li><p>Add a warning for enum elements with &#39;not_&#39; prefix.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Foo</span>
  <span class='id identifier rubyid_enum'>enum</span> <span class='label'>status:</span> [<span class='symbeg'>:</span><span class='id identifier rubyid_sent'>sent</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_not_sent'>not_sent</span>]
<span class='kw'>end</span></code></pre>

<p><em>Edu Depetris</em></p></li>
<li><p>Make currency symbols optional for money column type in PostgreSQL.</p>

<p><em>Joel Schneider</em></p></li>
<li><p>Add support for beginless ranges, introduced in Ruby 2.7.</p>

<p><em>Josh Goodall</em></p></li>
<li><p>Add <code>database_exists?</code> method to connection adapters to check if a database exists.</p>

<p><em>Guilherme Mansur</em></p></li>
<li><p>Loading the schema for a model that has no <code>table_name</code> raises a <code>TableNotSpecified</code> error.</p>

<p><em>Guilherme Mansur</em>, <em>Eugene Kenny</em></p></li>
<li><p>PostgreSQL: Fix GROUP BY with ORDER BY virtual count attribute.</p>

<p>Fixes #36022.</p>

<p><em>Ryuta Kamizono</em></p></li>
<li><p>Make ActiveRecord <code>ConnectionPool.connections</code> method thread-safe.</p>

<p>Fixes #36465.</p>

<p><em>Jeff Doering</em></p></li>
<li><p>Add support for multiple databases to <code>rails db:abort_if_pending_migrations</code>.</p>

<p><em>Mark Lee</em></p></li>
<li><p>Fix sqlite3 collation parsing when using decimal columns.</p>

<p><em>Martin R. Schuster</em></p></li>
<li><p>Fix invalid schema when primary key column has a comment.</p>

<p>Fixes #29966.</p>

<p><em>Guilherme Goettems Schneider</em></p></li>
<li><p>Fix table comment also being applied to the primary key column.</p>

<p><em>Guilherme Goettems Schneider</em></p></li>
<li><p>Allow generated <code>create_table</code> migrations to include or skip timestamps.</p>

<p><em>Michael Duchemin</em></p></li>
</ul>

<p>Please check [6-0-stable]) for previous changes.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>