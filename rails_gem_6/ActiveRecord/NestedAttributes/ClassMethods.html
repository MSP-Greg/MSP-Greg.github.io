<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ActiveRecord::NestedAttributes::ClassMethods &mdash; Rails 6.1.7.7</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::NestedAttributes::ClassMethods",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Rails 6.1.7.7</a> &raquo; 
      <a href='../../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
        <a class='nodoc' href="../NestedAttributes.html" title="ActiveRecord::NestedAttributes (module)">NestedAttributes</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ClassMethods&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: ActiveRecord::NestedAttributes::ClassMethods</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/v6.1.7.7/activerecord/lib/active_record/nested_attributes.rb#L282'>activerecord/lib/active_record/nested_attributes.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Nested attributes allow you to save attributes on associated records through the parent. By default nested attribute updating is turned off and you can enable it using the accepts_nested_attributes_for class method. When you enable nested attributes an attribute writer is defined on the model.</p>

<p>The attribute writer is named after the association, which means that in the following example, two new methods are added to your model:</p>

<p><code>author_attributes=(attributes)</code> and <code>pages_attributes=(attributes)</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pages'>pages</span>

  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_author'>author</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_pages'>pages</span>
<span class='kw'>end</span></code></pre>

<p>Note that the <code>:autosave</code> option is automatically enabled on every association that accepts_nested_attributes_for is used for.</p>

<h3 id="label-One-to-one">One-to-one</h3>

<p>Consider a Member model that has one Avatar:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Member</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span>
<span class='kw'>end</span></code></pre>

<p>Enabling nested attributes on a one-to-one association allows you to create the member and avatar in one go:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> { <span class='label'>member:</span> { <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Jack</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>avatar_attributes:</span> { <span class='label'>icon:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>smiling</span><span class='tstring_end'>&#39;</span></span> } } }
<span class='id identifier rubyid_member'>member</span> <span class='op'>=</span> <span class='const'>Member</span>.<span class='id identifier rubyid_create'>create</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span>])
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_avatar'>avatar</span>.<span class='id identifier rubyid_id'>id</span> <span class='comment'># =&gt; 2
</span><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_avatar'>avatar</span>.<span class='id identifier rubyid_icon'>icon</span> <span class='comment'># =&gt; &#39;smiling&#39;</span></code></pre>

<p>It also allows you to update the avatar through the member:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> { <span class='label'>member:</span> { <span class='label'>avatar_attributes:</span> { <span class='label'>id:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>2</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>icon:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sad</span><span class='tstring_end'>&#39;</span></span> } } }
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_update'>update</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span>]
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_avatar'>avatar</span>.<span class='id identifier rubyid_icon'>icon</span> <span class='comment'># =&gt; &#39;sad&#39;</span></code></pre>

<p>If you want to update the current avatar without providing the id, you must add <code>:update_only</code> option.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Member</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span><span class='comma'>,</span> <span class='label'>update_only:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> { <span class='label'>member:</span> { <span class='label'>avatar_attributes:</span> { <span class='label'>icon:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sad</span><span class='tstring_end'>&#39;</span></span> } } }
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_update'>update</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span>]
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_avatar'>avatar</span>.<span class='id identifier rubyid_id'>id</span> <span class='comment'># =&gt; 2
</span><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_avatar'>avatar</span>.<span class='id identifier rubyid_icon'>icon</span> <span class='comment'># =&gt; &#39;sad&#39;</span></code></pre>

<p>By default you will only be able to set and update attributes on the associated model. If you want to destroy the associated model through the attributes hash, you have to enable it first using the <code>:allow_destroy</code> option.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Member</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span><span class='comma'>,</span> <span class='label'>allow_destroy:</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>

<p>Now, when you add the <a href="../NestedAttributes.html#_destroy-instance_method" title="ActiveRecord::NestedAttributes#_destroy (method)">#_destroy</a> key to the attributes hash, with a value that evaluates to <code>true</code>, you will destroy the associated model:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_avatar_attributes'>avatar_attributes</span> <span class='op'>=</span> { <span class='label'>id:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>2</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>_destroy:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1</span><span class='tstring_end'>&#39;</span></span> }
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_avatar'>avatar</span>.<span class='id identifier rubyid_marked_for_destruction?'>marked_for_destruction?</span> <span class='comment'># =&gt; true
</span><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_save'>save</span>
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_reload'>reload</span>.<span class='id identifier rubyid_avatar'>avatar</span> <span class='comment'># =&gt; nil</span></code></pre>

<p>Note that the model will <em>not</em> be destroyed until the parent is saved.</p>

<p>Also note that the model will not be destroyed unless you also specify its id in the updated hash.</p>

<h3 id="label-One-to-many">One-to-many</h3>

<p>Consider a member that has a number of posts:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Member</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
<span class='kw'>end</span></code></pre>

<p>You can now set or update attributes on the associated posts through an attribute hash for a member: include the key <code>:posts_attributes</code> with an array of hashes of post attributes as a value.</p>

<p>For each hash that does <em>not</em> have an <code>id</code> key a new record will be instantiated, unless the hash also contains a <a href="../NestedAttributes.html#_destroy-instance_method" title="ActiveRecord::NestedAttributes#_destroy (method)">#_destroy</a> key that evaluates to <code>true</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> { <span class='label'>member:</span> {
  <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>joe</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>posts_attributes:</span> [
    { <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Kari, the awesome Ruby documentation browser!</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span>
    { <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The egalitarian assumption of the modern citizen</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span>
    { <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>_destroy:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1</span><span class='tstring_end'>&#39;</span></span> } <span class='comment'># this will be ignored
</span>  ]
}}

<span class='id identifier rubyid_member'>member</span> <span class='op'>=</span> <span class='const'>Member</span>.<span class='id identifier rubyid_create'>create</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span>])
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_length'>length</span> <span class='comment'># =&gt; 2
</span><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_title'>title</span> <span class='comment'># =&gt; &#39;Kari, the awesome Ruby documentation browser!&#39;
</span><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_second'>second</span>.<span class='id identifier rubyid_title'>title</span> <span class='comment'># =&gt; &#39;The egalitarian assumption of the modern citizen&#39;</span></code></pre>

<p>You may also set a <code>:reject_if</code> proc to silently ignore any new record hashes if they fail to pass your criteria. For example, the previous example could be rewritten as:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Member</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>reject_if:</span> <span class='id identifier rubyid_proc'>proc</span> { <span class='op'>|</span><span class='id identifier rubyid_attributes'>attributes</span><span class='op'>|</span> <span class='id identifier rubyid_attributes'>attributes</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>title</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_blank?'>blank?</span> }
<span class='kw'>end</span>

<span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> { <span class='label'>member:</span> {
  <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>joe</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>posts_attributes:</span> [
    { <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Kari, the awesome Ruby documentation browser!</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span>
    { <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The egalitarian assumption of the modern citizen</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span>
    { <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span> } <span class='comment'># this will be ignored because of the :reject_if proc
</span>  ]
}}

<span class='id identifier rubyid_member'>member</span> <span class='op'>=</span> <span class='const'>Member</span>.<span class='id identifier rubyid_create'>create</span>(<span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span>])
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_length'>length</span> <span class='comment'># =&gt; 2
</span><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_title'>title</span> <span class='comment'># =&gt; &#39;Kari, the awesome Ruby documentation browser!&#39;
</span><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_second'>second</span>.<span class='id identifier rubyid_title'>title</span> <span class='comment'># =&gt; &#39;The egalitarian assumption of the modern citizen&#39;</span></code></pre>

<p>Alternatively, <code>:reject_if</code> also accepts a symbol for using methods:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Member</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>reject_if:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_new_record?'>new_record?</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Member</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>reject_if:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reject_posts'>reject_posts</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_reject_posts'>reject_posts</span>(<span class='id identifier rubyid_attributes'>attributes</span>)
    <span class='id identifier rubyid_attributes'>attributes</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>title</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_blank?'>blank?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>If the hash contains an <code>id</code> key that matches an already associated record, the matching record will be modified:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_attributes'>attributes</span> <span class='op'>=</span> {
  <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Joe</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>posts_attributes:</span> [
    { <span class='label'>id:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>[UPDATED] An, as of yet, undisclosed awesome Ruby documentation browser!</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span>
    { <span class='label'>id:</span> <span class='int'>2</span><span class='comma'>,</span> <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>[UPDATED] other post</span><span class='tstring_end'>&#39;</span></span> }
  ]
}

<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_first'>first</span>.<span class='id identifier rubyid_title'>title</span> <span class='comment'># =&gt; &#39;[UPDATED] An, as of yet, undisclosed awesome Ruby documentation browser!&#39;
</span><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_second'>second</span>.<span class='id identifier rubyid_title'>title</span> <span class='comment'># =&gt; &#39;[UPDATED] other post&#39;</span></code></pre>

<p>However, the above applies if the parent model is being updated as well. For example, If you wanted to create a <code>member</code> named <em>joe</em> and wanted to update the <code>posts</code> at the same time, that would give an <a href="../RecordNotFound.html" title="ActiveRecord::RecordNotFound (class)"><code>::ActiveRecord::RecordNotFound</code></a> error.</p>

<p>By default the associated records are protected from being destroyed. If you want to destroy any of the associated records through the attributes hash, you have to enable it first using the <code>:allow_destroy</code> option. This will allow you to also use the <a href="../NestedAttributes.html#_destroy-instance_method" title="ActiveRecord::NestedAttributes#_destroy (method)">#_destroy</a> key to destroy existing records:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Member</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>allow_destroy:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> { <span class='label'>member:</span> {
  <span class='label'>posts_attributes:</span> [{ <span class='label'>id:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>2</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>_destroy:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1</span><span class='tstring_end'>&#39;</span></span> }]
}}

<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_attributes'>attributes</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span>]
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_detect'>detect</span> { <span class='op'>|</span><span class='id identifier rubyid_p'>p</span><span class='op'>|</span> <span class='id identifier rubyid_p'>p</span>.<span class='id identifier rubyid_id'>id</span> <span class='op'>==</span> <span class='int'>2</span> }.<span class='id identifier rubyid_marked_for_destruction?'>marked_for_destruction?</span> <span class='comment'># =&gt; true
</span><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_length'>length</span> <span class='comment'># =&gt; 2
</span><span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_save'>save</span>
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_reload'>reload</span>.<span class='id identifier rubyid_posts'>posts</span>.<span class='id identifier rubyid_length'>length</span> <span class='comment'># =&gt; 1</span></code></pre>

<p>Nested attributes for an associated collection can also be passed in the form of a hash of hashes instead of an array of hashes:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Member</span>.<span class='id identifier rubyid_create'>create</span>(
  <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>joe</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>posts_attributes:</span> {
    <span class='label'>first:</span>  { <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Foo</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span>
    <span class='label'>second:</span> { <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Bar</span><span class='tstring_end'>&#39;</span></span> }
  }
)</code></pre>

<p>has the same effect as</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Member</span>.<span class='id identifier rubyid_create'>create</span>(
  <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>joe</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='label'>posts_attributes:</span> [
    { <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Foo</span><span class='tstring_end'>&#39;</span></span> }<span class='comma'>,</span>
    { <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Bar</span><span class='tstring_end'>&#39;</span></span> }
  ]
)</code></pre>

<p>The keys of the hash which is the value for <code>:posts_attributes</code> are ignored in this case. However, it is not allowed to use <code>&#39;id&#39;</code> or <code>:id</code> for one of such keys, otherwise the hash will be wrapped in an array and interpreted as an attribute hash for a single post.</p>

<p>Passing attributes for an associated collection in the form of a hash of hashes can be used with hashes generated from HTTP/HTML parameters, where there may be no natural way to submit an array of hashes.</p>

<h3 id="label-Saving">Saving</h3>

<p>All changes to models, including the destruction of those marked for destruction, are saved and destroyed automatically and atomically when the parent model is saved. This happens inside the transaction initiated by the parent’s save method. See <a href="../AutosaveAssociation.html" title="ActiveRecord::AutosaveAssociation (module)"><code>::ActiveRecord::AutosaveAssociation</code></a>.</p>

<h3 id="label-Validating+the+presence+of+a+parent+model">Validating the presence of a parent model</h3>

<p>If you want to validate that a child record is associated with a parent record, you can use the <code>validates_presence_of</code> method and the <code>:inverse_of</code> key as this example illustrates:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Member</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span>
  <span class='id identifier rubyid_validates_presence_of'>validates_presence_of</span> <span class='symbeg'>:</span><span class='id identifier rubyid_member'>member</span>
<span class='kw'>end</span></code></pre>

<p>Note that if you do not specify the <code>:inverse_of</code> option, then Active Record will try to automatically guess the inverse association based on heuristics.</p>

<p>For one-to-one nested associations, if you build the new (in-memory) child object yourself before assignment, then this module will not overwrite it, e.g.:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Member</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span>
  <span class='id identifier rubyid_accepts_nested_attributes_for'><a href="#accepts_nested_attributes_for-instance_method" title="ActiveRecord::NestedAttributes::ClassMethods#accepts_nested_attributes_for (method)">accepts_nested_attributes_for</a></span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_avatar'>avatar</span>
    <span class='kw'>super</span> <span class='op'>||</span> <span class='id identifier rubyid_build_avatar'>build_avatar</span>(<span class='label'>width:</span> <span class='int'>200</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_member'>member</span> <span class='op'>=</span> <span class='const'>Member</span>.<span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_avatar_attributes'>avatar_attributes</span> <span class='op'>=</span> {<span class='label'>icon:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sad</span><span class='tstring_end'>&#39;</span></span>}
<span class='id identifier rubyid_member'>member</span>.<span class='id identifier rubyid_avatar'>avatar</span>.<span class='id identifier rubyid_width'>width</span> <span class='comment'># =&gt; 200</span></code></pre>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='REJECT_ALL_BLANK_PROC-constant' class='summary_signature'>REJECT_ALL_BLANK_PROC =</span>
    <br/>
    <a class='repo' href='https://github.com/rails/rails/blob/v6.1.7.7/activerecord/lib/active_record/nested_attributes.rb#L283-L283'># File 'activerecord/lib/active_record/nested_attributes.rb', line 283</a>    <pre class='code ruby'><span class='id identifier rubyid_proc'>proc</span> { <span class='op'>|</span><span class='id identifier rubyid_attributes'>attributes</span><span class='op'>|</span> <span class='id identifier rubyid_attributes'>attributes</span>.<span class='id identifier rubyid_all?'>all?</span> { <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_destroy</span><span class='tstring_end'>&quot;</span></span> <span class='op'>||</span> <span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_blank?'>blank?</span> } }</pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#accepts_nested_attributes_for-instance_method" title="#accepts_nested_attributes_for (instance method)">#<strong>accepts_nested_attributes_for</strong>(*attr_names)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Defines an attributes writer for the specified association(s).</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="accepts_nested_attributes_for-instance_method">
  <h3 class='signature  first'>
    #<strong>accepts_nested_attributes_for</strong>(*attr_names)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Defines an attributes writer for the specified association(s).</p>

<p>Supported options:</p>
<dl class="rdoc-list label-list"><dt>:allow_destroy
<dd>
<p>If true, destroys any members from the attributes hash with a <a href="../NestedAttributes.html#_destroy-instance_method" title="ActiveRecord::NestedAttributes#_destroy (method)">ActiveRecord::NestedAttributes#_destroy</a> key and a value that evaluates to <code>true</code> (e.g. 1, ‘1’, true, or ‘true’). This option is off by default.</p>
</dd><dt>:reject_if
<dd>
<p>Allows you to specify a Proc or a Symbol pointing to a method that checks whether a record should be built for a certain attribute hash. The hash is passed to the supplied Proc or the method and it should return either <code>true</code> or <code>false</code>. When no <code>:reject_if</code> is specified, a record will be built for all attribute hashes that do not have a <a href="../NestedAttributes.html#_destroy-instance_method" title="ActiveRecord::NestedAttributes#_destroy (method)">ActiveRecord::NestedAttributes#_destroy</a> value that evaluates to true. Passing <code>:all_blank</code> instead of a Proc will create a proc that will reject a record where all the attributes are blank excluding any value for <code>_destroy</code>.</p>
</dd><dt>:limit
<dd>
<p>Allows you to specify the maximum number of associated records that can be processed with the nested attributes. Limit also can be specified as a Proc or a Symbol pointing to a method that should return a number. If the size of the nested attributes array exceeds the specified limit, NestedAttributes::TooManyRecords exception is raised. If omitted, any number of associations can be processed. Note that the <code>:limit</code> option is only applicable to one-to-many associations.</p>
</dd><dt>:update_only
<dd>
<p>For a one-to-one association, this option allows you to specify how nested attributes are going to be used when an associated record already exists. In general, an existing record may either be updated with the new set of attribute values or be replaced by a wholly new record containing those values. By default the <code>:update_only</code> option is <code>false</code> and the nested attributes are used to update the existing record only if they include the record’s <code>:id</code> value. Otherwise a new record will be instantiated and used to replace the existing one. However if the <code>:update_only</code> option is <code>true</code>, the nested attributes are used to update the record’s attributes always, regardless of whether the <code>:id</code> is present. The option is ignored for collection associations.</p>
</dd></dl>

<p>Examples:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># creates avatar_attributes=
</span><span class='id identifier rubyid_accepts_nested_attributes_for'>accepts_nested_attributes_for</span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span><span class='comma'>,</span> <span class='label'>reject_if:</span> <span class='id identifier rubyid_proc'>proc</span> { <span class='op'>|</span><span class='id identifier rubyid_attributes'>attributes</span><span class='op'>|</span> <span class='id identifier rubyid_attributes'>attributes</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span>].<span class='id identifier rubyid_blank?'>blank?</span> }
<span class='comment'># creates avatar_attributes=
</span><span class='id identifier rubyid_accepts_nested_attributes_for'>accepts_nested_attributes_for</span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span><span class='comma'>,</span> <span class='label'>reject_if:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_all_blank'>all_blank</span>
<span class='comment'># creates avatar_attributes= and posts_attributes=
</span><span class='id identifier rubyid_accepts_nested_attributes_for'>accepts_nested_attributes_for</span> <span class='symbeg'>:</span><span class='id identifier rubyid_avatar'>avatar</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_posts'>posts</span><span class='comma'>,</span> <span class='label'>allow_destroy:</span> <span class='kw'>true</span></code></pre>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v6.1.7.7/activerecord/lib/active_record/nested_attributes.rb#L332-L353'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='332' data-end='353'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/nested_attributes.rb', line 332</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_accepts_nested_attributes_for'>accepts_nested_attributes_for</span>(<span class='op'>*</span><span class='id identifier rubyid_attr_names'>attr_names</span>)
  <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> { <span class='label'>allow_destroy:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>update_only:</span> <span class='kw'>false</span> }
  <span class='id identifier rubyid_options'>options</span>.<span class='id identifier rubyid_update'>update</span>(<span class='id identifier rubyid_attr_names'>attr_names</span>.<span class='id identifier rubyid_extract_options!'>extract_options!</span>)
  <span class='id identifier rubyid_options'>options</span>.<span class='id identifier rubyid_assert_valid_keys'>assert_valid_keys</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_allow_destroy'>allow_destroy</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reject_if'>reject_if</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_limit'>limit</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_update_only'>update_only</span>)
  <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_reject_if'>reject_if</span>] <span class='op'>=</span> <span class='const'><a href="#REJECT_ALL_BLANK_PROC-constant" title="ActiveRecord::NestedAttributes::ClassMethods::REJECT_ALL_BLANK_PROC (constant)">REJECT_ALL_BLANK_PROC</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_reject_if'>reject_if</span>] <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_all_blank'>all_blank</span>

  <span class='id identifier rubyid_attr_names'>attr_names</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_association_name'>association_name</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_reflection'>reflection</span> <span class='op'>=</span> <span class='id identifier rubyid__reflect_on_association'>_reflect_on_association</span>(<span class='id identifier rubyid_association_name'>association_name</span>)
      <span class='id identifier rubyid_reflection'>reflection</span>.<span class='id identifier rubyid_autosave'>autosave</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_define_autosave_validation_callbacks'>define_autosave_validation_callbacks</span>(<span class='id identifier rubyid_reflection'>reflection</span>)

      <span class='id identifier rubyid_nested_attributes_options'>nested_attributes_options</span> <span class='op'>=</span> <span class='kw'>self</span>.<span class='id identifier rubyid_nested_attributes_options'>nested_attributes_options</span>.<span class='id identifier rubyid_dup'>dup</span>
      <span class='id identifier rubyid_nested_attributes_options'>nested_attributes_options</span>[<span class='id identifier rubyid_association_name'>association_name</span>.<span class='id identifier rubyid_to_sym'>to_sym</span>] <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>
      <span class='kw'>self</span>.<span class='id identifier rubyid_nested_attributes_options'>nested_attributes_options</span> <span class='op'>=</span> <span class='id identifier rubyid_nested_attributes_options'>nested_attributes_options</span>

      <span class='id identifier rubyid_type'>type</span> <span class='op'>=</span> (<span class='id identifier rubyid_reflection'>reflection</span>.<span class='id identifier rubyid_collection?'>collection?</span> <span class='op'>?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_collection'>collection</span> <span class='op'>:</span> <span class='symbeg'>:</span><span class='id identifier rubyid_one_to_one'>one_to_one</span>)
      <span class='id identifier rubyid_generate_association_writer'>generate_association_writer</span>(<span class='id identifier rubyid_association_name'>association_name</span><span class='comma'>,</span> <span class='id identifier rubyid_type'>type</span>)
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No association found for name `</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_association_name'>association_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;. Has it been defined yet?</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>