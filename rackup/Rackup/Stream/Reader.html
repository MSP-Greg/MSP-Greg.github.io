<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: Rackup::Stream::Reader &mdash; Rackup main</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Rackup::Stream::Reader",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Rackup main</a> &raquo; 
      <a href='../../_index.html#alpha_R'>Index (R)</a> &raquo; 
        <a href="../../Rackup.html" title="Rackup (module)">Rackup</a> &raquo; 
        <a href="../Stream.html" title="Rackup::Stream (class)">Stream</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Reader&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: Rackup::Stream::Reader</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Included In:</div>
      <div class='box_11'>
        <a href="../Handler/WEBrick/Input.html" title="Rackup::Handler::WEBrick::Input (class)"><code>Handler::WEBrick::Input</code></a>,
          <a href="../Stream.html" title="Rackup::Stream (class)"><code>Stream</code></a>
      </div>
    </td></tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rack/rackup/blob/main/lib/rackup/stream.rb#L24'>lib/rackup/stream.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>This provides a read-only interface for data, which is surprisingly tricky to implement correctly.</p>

  </div>
</div>
</div>
<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#each-instance_method" title="#each (instance method)">#<strong>each</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#gets-instance_method" title="#gets (instance method)">#<strong>gets</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#read-instance_method" title="#read (instance method)">#<strong>read</strong>(length = nil, buffer = nil)  &#x21d2; Object </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>read behaves like <code>IO#read</code>.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#read_nonblock-instance_method" title="#read_nonblock (instance method)">#<strong>read_nonblock</strong>(length, buffer = nil)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#read_partial-instance_method" title="#read_partial (instance method)">#<strong>read_partial</strong>(length = nil)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Read at most <code>length</code> bytes from the stream.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="each-instance_method">
  <h3 class='signature  first'>
    #<strong>each</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rackup/blob/main/lib/rackup/stream.rb#L99-L103'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='99' data-end='103'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rackup/stream.rb', line 99</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_each'>each</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_read_partial'><a href="#read_partial-instance_method" title="Rackup::Stream::Reader#read_partial (method)">read_partial</a></span>
    <span class='kw'>yield</span> <span class='id identifier rubyid_chunk'>chunk</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="gets-instance_method">
  <h3 class='signature '>
    #<strong>gets</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rackup/blob/main/lib/rackup/stream.rb#L95-L97'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='95' data-end='97'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rackup/stream.rb', line 95</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_gets'>gets</span>
  <span class='id identifier rubyid_read_partial'><a href="#read_partial-instance_method" title="Rackup::Stream::Reader#read_partial (method)">read_partial</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read-instance_method">
  <h3 class='signature '>
    #<strong>read</strong>(length = nil, buffer = nil)  &#x21d2; <code>Object</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>read behaves like <code>IO#read</code>. Its signature is read([length, [buffer]]). If given, length must be a non-negative Integer (&gt;= 0) or nil, and buffer must be a String and may not be nil. If length is given and not nil, then this method reads at most length bytes from the input stream. If length is not given or nil, then this method reads all data until EOF. When EOF is reached, this method returns nil if length is given and not nil, or “” if length is not given or is nil. If buffer is given, then the read data will be placed into buffer instead of a newly created String object.</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Parameters:</p>
<ul class='param'>
  <li>
    <span class='name'>length</span>
    <span class='type'>(<code>Integer</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>the amount of data to read</p>
</div>
  </li>
  <li>
    <span class='name'>buffer</span>
    <span class='type'>(<code>String</code>)</span>
    <em class='default'>(defaults to: <tt>nil</tt>)</em>
&mdash;    <div class='inline'>
<p>the buffer which will receive the data</p>
</div>
  </li>
</ul>
<p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'></span>
    <div class='inline'>
<p>a buffer containing the data</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rackup/blob/main/lib/rackup/stream.rb#L32-L71'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='32' data-end='71'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rackup/stream.rb', line 32</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read'>read</span>(<span class='id identifier rubyid_length'>length</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>0</span>

  <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>||=</span> <span class='const'>String</span>.<span class='id identifier rubyid_new'><a href="../Stream.html#new-class_method" title="Rackup::Stream.new (method)">new</a></span>.<span class='id identifier rubyid_force_encoding'>force_encoding</span>(<span class='const'>Encoding</span><span class='op'>::</span><span class='const'>BINARY</span>)

  <span class='comment'># Take any previously buffered data and replace it into the given buffer.
</span>  <span class='kw'>if</span> <span class='ivar'>@buffer</span>
    <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_replace'>replace</span>(<span class='ivar'>@buffer</span>)
    <span class='ivar'>@buffer</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_clear'>clear</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_length'>length</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_length'>length</span> <span class='kw'>and</span> <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_read_next'><a href="../Stream.html#read_next-instance_method" title="Rackup::Stream#read_next (method)">read_next</a></span>
      <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_chunk'>chunk</span>
    <span class='kw'>end</span>

    <span class='comment'># This ensures the subsequent `slice!` works correctly.
</span>    <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_force_encoding'>force_encoding</span>(<span class='const'>Encoding</span><span class='op'>::</span><span class='const'>BINARY</span>)

    <span class='comment'># This will be at least one copy:
</span>    <span class='ivar'>@buffer</span> <span class='op'>=</span> <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_byteslice'>byteslice</span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_bytesize'>bytesize</span>)

    <span class='comment'># This should be zero-copy:
</span>    <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_slice!'>slice!</span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_bytesize'>bytesize</span>)

    <span class='kw'>if</span> <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_empty?'><a href="../Stream.html#empty%3F-instance_method" title="Rackup::Stream#empty? (method)">empty?</a></span>
      <span class='kw'>return</span> <span class='kw'>nil</span>
    <span class='kw'>else</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_buffer'>buffer</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_read_next'><a href="../Stream.html#read_next-instance_method" title="Rackup::Stream#read_next (method)">read_next</a></span>
      <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_chunk'>chunk</span>
    <span class='kw'>end</span>

    <span class='kw'>return</span> <span class='id identifier rubyid_buffer'>buffer</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_nonblock-instance_method">
  <h3 class='signature '>
    #<strong>read_nonblock</strong>(length, buffer = nil)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rackup/blob/main/lib/rackup/stream.rb#L105-L129'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='105' data-end='129'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rackup/stream.rb', line 105</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_nonblock'>read_nonblock</span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='ivar'>@buffer</span> <span class='op'>||=</span> <span class='id identifier rubyid_read_next'><a href="../Stream.html#read_next-instance_method" title="Rackup::Stream#read_next (method)">read_next</a></span>
  <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='kw'>unless</span> <span class='ivar'>@buffer</span>
    <span class='id identifier rubyid_buffer'>buffer</span><span class='op'>&amp;.</span><span class='id identifier rubyid_clear'>clear</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='ivar'>@buffer</span>.<span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_length'>length</span>
    <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='ivar'>@buffer</span>.<span class='id identifier rubyid_byteslice'>byteslice</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_length'>length</span>)
    <span class='ivar'>@buffer</span> <span class='op'>=</span> <span class='ivar'>@buffer</span>.<span class='id identifier rubyid_byteslice'>byteslice</span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='ivar'>@buffer</span>.<span class='id identifier rubyid_bytesize'>bytesize</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='ivar'>@buffer</span>
    <span class='ivar'>@buffer</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_buffer'>buffer</span>
    <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_replace'>replace</span>(<span class='id identifier rubyid_chunk'>chunk</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='id identifier rubyid_chunk'>chunk</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_buffer'>buffer</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_partial-instance_method">
  <h3 class='signature '>
    #<strong>read_partial</strong>(length = nil)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Read at most <code>length</code> bytes from the stream. Will avoid reading from the underlying stream if possible.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rackup/blob/main/lib/rackup/stream.rb#L74-L93'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='74' data-end='93'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rackup/stream.rb', line 74</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_partial'>read_partial</span>(<span class='id identifier rubyid_length'>length</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='kw'>if</span> <span class='ivar'>@buffer</span>
    <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='ivar'>@buffer</span>
    <span class='ivar'>@buffer</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='id identifier rubyid_read_next'><a href="../Stream.html#read_next-instance_method" title="Rackup::Stream#read_next (method)">read_next</a></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_buffer'>buffer</span> <span class='kw'>and</span> <span class='id identifier rubyid_length'>length</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_length'>length</span>
      <span class='comment'># This ensures the subsequent `slice!` works correctly.
</span>      <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_force_encoding'>force_encoding</span>(<span class='const'>Encoding</span><span class='op'>::</span><span class='const'>BINARY</span>)

      <span class='ivar'>@buffer</span> <span class='op'>=</span> <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_byteslice'>byteslice</span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_bytesize'>bytesize</span>)
      <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_slice!'>slice!</span>(<span class='id identifier rubyid_length'>length</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer'>buffer</span>.<span class='id identifier rubyid_bytesize'>bytesize</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_buffer'>buffer</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>