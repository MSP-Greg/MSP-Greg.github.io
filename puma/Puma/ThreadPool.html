<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Puma::ThreadPool &mdash; Puma main</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Puma::ThreadPool",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Puma main</a> &raquo; 
      <a href='../_index.html#alpha_T'>Index (T)</a> &raquo; 
        <a href="../Puma.html" title="Puma (module)">Puma</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ThreadPool&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Puma::ThreadPool</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a href="ThreadPool/Automaton.html" title="Puma::ThreadPool::Automaton (class)"><code>Automaton</code></a>      </div>
    </td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Exceptions:</div>
      <div class='box_11'>
          <a href="ThreadPool/ForceShutdown.html" title="Puma::ThreadPool::ForceShutdown (class)"><code>ForceShutdown</code></a>      </div>
    </td></tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="../Object.html" title="Object (class)">Object</a></span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L23'>lib/puma/thread_pool.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Internal Docs for A simple thread pool management object.</p>

<p>Each Puma “worker” has a thread pool to process requests.</p>

<p>First a connection to a client is made in <a href="Server.html" title="Puma::Server (class)"><code>Server</code></a>. It is wrapped in a <a href="Client.html" title="Puma::Client (class)"><code>Client</code></a> instance and then passed to the <a href="Reactor.html" title="Puma::Reactor (class)"><code>Reactor</code></a> to ensure the whole request is buffered into memory. Once the request is ready, it is passed into a thread pool via the <a href="#<<-instance_method" title="Puma::ThreadPool#&lt;&lt; (method)">#&lt;&lt;</a> operator where it is stored in a <code>@todo</code> array.</p>

<p>Each thread in the pool has an internal loop where it pulls a request from the <code>@todo</code> array and processes it.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='SHUTDOWN_GRACE_TIME-constant' class='summary_signature'>SHUTDOWN_GRACE_TIME =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>How long, after raising the <a href="ThreadPool/ForceShutdown.html" title="Puma::ThreadPool::ForceShutdown (class)"><code>ThreadPool::ForceShutdown</code></a> of a thread during forced shutdown mode, to wait for the thread to try and finish up its work before leaving the thread to die on the vine.</p>

  </div>
</div>
    <a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L30-L30'># File 'lib/puma/thread_pool.rb', line 30</a>    <pre class='code ruby'><span class='int'>5</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(name, options = {}, server: nil, &amp;block)  &#x21d2; ThreadPool </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Maintain a minimum of <code>min</code> and maximum of <code>max</code> threads in the pool.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#busy_threads-instance_method" title="#busy_threads (instance method)">#<strong>busy_threads</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#out_of_band_running-instance_method" title="#out_of_band_running (instance method)">#<strong>out_of_band_running</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
    <div class='summary_desc'>
      <div class='inline'><p>seconds.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#pool_capacity-instance_method" title="#pool_capacity (instance method)">#<strong>pool_capacity</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#spawned-instance_method" title="#spawned (instance method)">#<strong>spawned</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#trim_requested-instance_method" title="#trim_requested (instance method)">#<strong>trim_requested</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#waiting-instance_method" title="#waiting (instance method)">#<strong>waiting</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#<<-instance_method" title="#&lt;&lt; (instance method)">#<strong>&lt;&lt;</strong>(work)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Add <code>work</code> to the todo list for a Thread to pickup and process.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#auto_reap!-instance_method" title="#auto_reap! (instance method)">#<strong>auto_reap!</strong>(timeout = @reaping_time)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#auto_trim!-instance_method" title="#auto_trim! (instance method)">#<strong>auto_trim!</strong>(timeout = @auto_trim_time)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#backlog-instance_method" title="#backlog (instance method)">#<strong>backlog</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>How many objects have yet to be processed by the pool?</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#backlog_max-instance_method" title="#backlog_max (instance method)">#<strong>backlog_max</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>The maximum size of the backlog.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#reap-instance_method" title="#reap (instance method)">#<strong>reap</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>If there are dead threads in the pool make them go away while decreasing spawned counter so that new healthy threads could be created again.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#reset_max-instance_method" title="#reset_max (instance method)">#<strong>reset_max</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#shutdown-instance_method" title="#shutdown (instance method)">#<strong>shutdown</strong>(timeout = -1))  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Tell all threads in the pool to exit and wait for them to finish.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#stats-instance_method" title="#stats (instance method)">#<strong>stats</strong>  &#x21d2; Hash </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>generate stats hash so as not to perform multiple locks.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#trim-instance_method" title="#trim (instance method)">#<strong>trim</strong>(force = false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>If there are any free threads in the pool, tell one to go ahead and exit.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#wait_while_out_of_band_running-instance_method" title="#wait_while_out_of_band_running (instance method)">#<strong>wait_while_out_of_band_running</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#with_force_shutdown-instance_method" title="#with_force_shutdown (instance method)">#<strong>with_force_shutdown</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Allows <a href="ThreadPool/ForceShutdown.html" title="Puma::ThreadPool::ForceShutdown (class)"><code>ForceShutdown</code></a> to be raised within the provided block if the thread is forced to shutdown during execution.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#with_mutex-instance_method" title="#with_mutex (instance method)">#<strong>with_mutex</strong>(&amp;block)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#trigger_before_thread_exit_hooks-instance_method" title="#trigger_before_thread_exit_hooks (instance method)">#<strong>trigger_before_thread_exit_hooks</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#trigger_before_thread_start_hooks-instance_method" title="#trigger_before_thread_start_hooks (instance method)">#<strong>trigger_before_thread_start_hooks</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#trigger_out_of_band_hook-instance_method" title="#trigger_out_of_band_hook (instance method)">#<strong>trigger_out_of_band_hook</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#spawn_thread-instance_method" title="#spawn_thread (instance method)">#<strong>spawn_thread</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Must be called with @mutex held!</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(name, options = {}, server: nil, &amp;block)  &#x21d2; <code>ThreadPool</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Maintain a minimum of <code>min</code> and maximum of <code>max</code> threads in the pool.</p>

<p>The block passed is the work that will be performed in each thread.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L40-L87'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='40' data-end='87'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 40</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> {}<span class='comma'>,</span> <span class='label'>server:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='ivar'>@server</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span>

  <span class='ivar'>@not_empty</span> <span class='op'>=</span> <span class='const'>ConditionVariable</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@not_full</span> <span class='op'>=</span> <span class='const'>ConditionVariable</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@todo</span> <span class='op'>=</span> <span class='const'>Queue</span>.<span class='id identifier rubyid_new'>new</span>

  <span class='ivar'>@backlog_max</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@spawned</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@waiting</span> <span class='op'>=</span> <span class='int'>0</span>

  <span class='ivar'>@name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>
  <span class='ivar'>@min</span> <span class='op'>=</span> <span class='const'>Integer</span>(<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_min_threads'>min_threads</span>])
  <span class='ivar'>@max</span> <span class='op'>=</span> <span class='const'>Integer</span>(<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_max_threads'>max_threads</span>])
  <span class='comment'># Not an &#39;exposed&#39; option, options[:pool_shutdown_grace_time] is used in CI
</span>  <span class='comment'># to shorten @shutdown_grace_time from SHUTDOWN_GRACE_TIME. Parallel CI
</span>  <span class='comment'># makes stubbing constants difficult.
</span>  <span class='ivar'>@shutdown_grace_time</span> <span class='op'>=</span> <span class='const'>Float</span>(<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_pool_shutdown_grace_time'>pool_shutdown_grace_time</span>] <span class='op'>||</span> <span class='const'><a href="#SHUTDOWN_GRACE_TIME-constant" title="Puma::ThreadPool::SHUTDOWN_GRACE_TIME (constant)">SHUTDOWN_GRACE_TIME</a></span>)
  <span class='ivar'>@block</span> <span class='op'>=</span> <span class='id identifier rubyid_block'>block</span>
  <span class='ivar'>@out_of_band</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_out_of_band'>out_of_band</span>]
  <span class='ivar'>@out_of_band_running</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@out_of_band_condvar</span> <span class='op'>=</span> <span class='const'>ConditionVariable</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@before_thread_start</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_before_thread_start'>before_thread_start</span>]
  <span class='ivar'>@before_thread_exit</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_before_thread_exit'>before_thread_exit</span>]
  <span class='ivar'>@reaping_time</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_reaping_time'>reaping_time</span>]
  <span class='ivar'>@auto_trim_time</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_auto_trim_time'>auto_trim_time</span>]

  <span class='ivar'>@shutdown</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='ivar'>@trim_requested</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@out_of_band_pending</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='ivar'>@workers</span> <span class='op'>=</span> []

  <span class='ivar'>@auto_trim</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@reaper</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='ivar'>@mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@min</span>.<span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_spawn_thread'><a href="#spawn_thread-instance_method" title="Puma::ThreadPool#spawn_thread (method)">spawn_thread</a></span>
      <span class='ivar'>@not_full</span>.<span class='id identifier rubyid_wait'>wait</span>(<span class='ivar'>@mutex</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='ivar'>@force_shutdown</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@shutdown_mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span>.<span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="busy_threads-instance_method">
  <h3 class='signature ro first'>
    #<strong>busy_threads</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Version:</p>
<ul class='version'>
  <li>
    <div class='inline'>
<p>5.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L129-L131'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='129' data-end='131'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 129</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_busy_threads'>busy_threads</span>
  <span class='id identifier rubyid_with_mutex'><a href="#with_mutex-instance_method" title="Puma::ThreadPool#with_mutex (method)">with_mutex</a></span> { <span class='ivar'>@spawned</span> <span class='op'>-</span> <span class='ivar'>@waiting</span> <span class='op'>+</span> <span class='ivar'>@todo</span>.<span class='id identifier rubyid_size'>size</span> }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="out_of_band_running-instance_method">
  <h3 class='signature ro'>
    #<strong>out_of_band_running</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>seconds</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L32-L32'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='32' data-end='32'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 32</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_out_of_band_running'>out_of_band_running</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pool_capacity-instance_method">
  <h3 class='signature ro'>
    #<strong>pool_capacity</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L123-L125'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='123' data-end='125'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 123</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_pool_capacity'>pool_capacity</span>
  <span class='id identifier rubyid_waiting'><a href="#waiting-instance_method" title="Puma::ThreadPool#waiting (method)">waiting</a></span> <span class='op'>+</span> (<span class='ivar'>@max</span> <span class='op'>-</span> <span class='id identifier rubyid_spawned'><a href="#spawned-instance_method" title="Puma::ThreadPool#spawned (method)">spawned</a></span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="spawned-instance_method">
  <h3 class='signature ro'>
    #<strong>spawned</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L89-L89'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='89' data-end='89'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 89</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_spawned'>spawned</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_trim_requested'><a href="#trim_requested-instance_method" title="Puma::ThreadPool#trim_requested (method)">trim_requested</a></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_waiting'><a href="#waiting-instance_method" title="Puma::ThreadPool#waiting (method)">waiting</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="trim_requested-instance_method">
  <h3 class='signature ro'>
    #<strong>trim_requested</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L89-L89'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='89' data-end='89'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 89</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_spawned'><a href="#spawned-instance_method" title="Puma::ThreadPool#spawned (method)">spawned</a></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_trim_requested'>trim_requested</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_waiting'><a href="#waiting-instance_method" title="Puma::ThreadPool#waiting (method)">waiting</a></span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="waiting-instance_method">
  <h3 class='signature ro'>
    #<strong>waiting</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L89-L89'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='89' data-end='89'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 89</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_spawned'><a href="#spawned-instance_method" title="Puma::ThreadPool#spawned (method)">spawned</a></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_trim_requested'><a href="#trim_requested-instance_method" title="Puma::ThreadPool#trim_requested (method)">trim_requested</a></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_waiting'>waiting</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="<<-instance_method">
  <h3 class='signature  first'>
    #<strong>&lt;&lt;</strong>(work)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Add <code>work</code> to the todo list for a Thread to pickup and process.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L261-L277'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='261' data-end='277'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 261</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='op'>&lt;&lt;</span>(<span class='id identifier rubyid_work'>work</span>)
  <span class='id identifier rubyid_with_mutex'><a href="#with_mutex-instance_method" title="Puma::ThreadPool#with_mutex (method)">with_mutex</a></span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='ivar'>@shutdown</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unable to add work while shutting down</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='ivar'>@todo</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_work'>work</span>
    <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='ivar'>@todo</span>.<span class='id identifier rubyid_size'>size</span>
    <span class='ivar'>@backlog_max</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span> <span class='kw'>if</span> <span class='id identifier rubyid_t'>t</span> <span class='op'>&gt;</span> <span class='ivar'>@backlog_max</span>

    <span class='kw'>if</span> <span class='ivar'>@waiting</span> <span class='op'>&lt;</span> <span class='ivar'>@todo</span>.<span class='id identifier rubyid_size'>size</span> <span class='kw'>and</span> <span class='ivar'>@spawned</span> <span class='op'>&lt;</span> <span class='ivar'>@max</span>
      <span class='id identifier rubyid_spawn_thread'><a href="#spawn_thread-instance_method" title="Puma::ThreadPool#spawn_thread (method)">spawn_thread</a></span>
    <span class='kw'>end</span>

    <span class='ivar'>@not_empty</span>.<span class='id identifier rubyid_signal'>signal</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="auto_reap!-instance_method">
  <h3 class='signature '>
    #<strong>auto_reap!</strong>(timeout = @reaping_time)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L342-L345'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='342' data-end='345'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 342</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_auto_reap!'>auto_reap!</span>(<span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='ivar'>@reaping_time</span>)
  <span class='ivar'>@reaper</span> <span class='op'>=</span> <span class='const'><a href="ThreadPool/Automaton.html" title="Puma::ThreadPool::Automaton (class)">Automaton</a></span>.<span class='id identifier rubyid_new'><a href="ThreadPool/Automaton.html#new-class_method" title="Puma::ThreadPool::Automaton.new (method)">new</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@name</span><span class='embexpr_end'>}</span><span class='tstring_content'> tp reap</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reap'><a href="#reap-instance_method" title="Puma::ThreadPool#reap (method)">reap</a></span>)
  <span class='ivar'>@reaper</span>.<span class='id identifier rubyid_start!'>start!</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="auto_trim!-instance_method">
  <h3 class='signature '>
    #<strong>auto_trim!</strong>(timeout = @auto_trim_time)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L337-L340'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='337' data-end='340'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 337</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_auto_trim!'>auto_trim!</span>(<span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='ivar'>@auto_trim_time</span>)
  <span class='ivar'>@auto_trim</span> <span class='op'>=</span> <span class='const'><a href="ThreadPool/Automaton.html" title="Puma::ThreadPool::Automaton (class)">Automaton</a></span>.<span class='id identifier rubyid_new'><a href="ThreadPool/Automaton.html#new-class_method" title="Puma::ThreadPool::Automaton.new (method)">new</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@name</span><span class='embexpr_end'>}</span><span class='tstring_content'> tp trim</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_trim'><a href="#trim-instance_method" title="Puma::ThreadPool#trim (method)">trim</a></span>)
  <span class='ivar'>@auto_trim</span>.<span class='id identifier rubyid_start!'>start!</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="backlog-instance_method">
  <h3 class='signature '>
    #<strong>backlog</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>How many objects have yet to be processed by the pool?</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L112-L114'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='112' data-end='114'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 112</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_backlog'>backlog</span>
  <span class='id identifier rubyid_with_mutex'><a href="#with_mutex-instance_method" title="Puma::ThreadPool#with_mutex (method)">with_mutex</a></span> { <span class='ivar'>@todo</span>.<span class='id identifier rubyid_size'>size</span> }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="backlog_max-instance_method">
  <h3 class='signature '>
    #<strong>backlog_max</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>The maximum size of the backlog</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L118-L120'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='118' data-end='120'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 118</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_backlog_max'>backlog_max</span>
  <span class='id identifier rubyid_with_mutex'><a href="#with_mutex-instance_method" title="Puma::ThreadPool#with_mutex (method)">with_mutex</a></span> { <span class='ivar'>@backlog_max</span> }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="reap-instance_method">
  <h3 class='signature '>
    #<strong>reap</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>If there are dead threads in the pool make them go away while decreasing spawned counter so that new healthy threads could be created again.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L295-L308'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='295' data-end='308'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 295</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_reap'>reap</span>
  <span class='id identifier rubyid_with_mutex'><a href="#with_mutex-instance_method" title="Puma::ThreadPool#with_mutex (method)">with_mutex</a></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_dead_workers'>dead_workers</span> <span class='op'>=</span> <span class='ivar'>@workers</span>.<span class='id identifier rubyid_reject'>reject</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_alive?'>alive?</span>)

    <span class='id identifier rubyid_dead_workers'>dead_workers</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_worker'>worker</span><span class='op'>|</span>
      <span class='id identifier rubyid_worker'>worker</span>.<span class='id identifier rubyid_kill'>kill</span>
      <span class='ivar'>@spawned</span> <span class='op'>-=</span> <span class='int'>1</span>
    <span class='kw'>end</span>

    <span class='ivar'>@workers</span>.<span class='id identifier rubyid_delete_if'>delete_if</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_w'>w</span><span class='op'>|</span>
      <span class='id identifier rubyid_dead_workers'>dead_workers</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_w'>w</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="reset_max-instance_method">
  <h3 class='signature '>
    #<strong>reset_max</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L106-L108'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='106' data-end='108'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 106</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_reset_max'>reset_max</span>
  <span class='id identifier rubyid_with_mutex'><a href="#with_mutex-instance_method" title="Puma::ThreadPool#with_mutex (method)">with_mutex</a></span> { <span class='ivar'>@backlog_max</span> <span class='op'>=</span> <span class='int'>0</span> }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="shutdown-instance_method">
  <h3 class='signature '>
    #<strong>shutdown</strong>(timeout = -1))  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Tell all threads in the pool to exit and wait for them to finish. Wait <code>timeout</code> seconds then raise <a href="ThreadPool/ForceShutdown.html" title="Puma::ThreadPool::ForceShutdown (class)"><code>ThreadPool::ForceShutdown</code></a> in remaining threads. Next, wait an extra <code>@shutdown_grace_time</code> seconds then force-kill remaining threads. Finally, wait 1 second for remaining threads to exit.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L365-L409'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='365' data-end='409'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 365</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_shutdown'>shutdown</span>(<span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='op'>-</span><span class='int'>1</span>)
  <span class='id identifier rubyid_threads'>threads</span> <span class='op'>=</span> <span class='id identifier rubyid_with_mutex'><a href="#with_mutex-instance_method" title="Puma::ThreadPool#with_mutex (method)">with_mutex</a></span> <span class='kw'>do</span>
    <span class='ivar'>@shutdown</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='ivar'>@trim_requested</span> <span class='op'>=</span> <span class='ivar'>@spawned</span>
    <span class='ivar'>@not_empty</span>.<span class='id identifier rubyid_broadcast'>broadcast</span>
    <span class='ivar'>@not_full</span>.<span class='id identifier rubyid_broadcast'>broadcast</span>

    <span class='ivar'>@auto_trim</span><span class='op'>&amp;.</span><span class='id identifier rubyid_stop'>stop</span>
    <span class='ivar'>@reaper</span><span class='op'>&amp;.</span><span class='id identifier rubyid_stop'>stop</span>
    <span class='comment'># dup workers so that we join them all safely
</span>    <span class='ivar'>@workers</span>.<span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>==</span> <span class='op'>-</span><span class='int'>1</span>
    <span class='comment'># Wait for threads to finish without force shutdown.
</span>    <span class='id identifier rubyid_threads'>threads</span>.<span class='id identifier rubyid_each'>each</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_join'>join</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_join'>join</span> <span class='op'>=</span> <span class='tlambda'>-&gt;</span>(<span class='id identifier rubyid_inner_timeout'>inner_timeout</span>) <span class='kw'>do</span>
      <span class='id identifier rubyid_start'>start</span> <span class='op'>=</span> <span class='const'>Process</span>.<span class='id identifier rubyid_clock_gettime'>clock_gettime</span>(<span class='const'>Process</span><span class='op'>::</span><span class='const'>CLOCK_MONOTONIC</span>)
      <span class='id identifier rubyid_threads'>threads</span>.<span class='id identifier rubyid_reject!'>reject!</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
        <span class='id identifier rubyid_elapsed'>elapsed</span> <span class='op'>=</span> <span class='const'>Process</span>.<span class='id identifier rubyid_clock_gettime'>clock_gettime</span>(<span class='const'>Process</span><span class='op'>::</span><span class='const'>CLOCK_MONOTONIC</span>) <span class='op'>-</span> <span class='id identifier rubyid_start'>start</span>
        <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_join'>join</span> <span class='id identifier rubyid_inner_timeout'>inner_timeout</span> <span class='op'>-</span> <span class='id identifier rubyid_elapsed'>elapsed</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Wait timeout seconds for threads to finish.
</span>    <span class='id identifier rubyid_join'>join</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_timeout'>timeout</span>)

    <span class='comment'># If threads are still running, raise ForceShutdown and wait to finish.
</span>    <span class='ivar'>@shutdown_mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
      <span class='ivar'>@force_shutdown</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_threads'>threads</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
        <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="ThreadPool/ForceShutdown.html" title="Puma::ThreadPool::ForceShutdown (class)">ForceShutdown</a></span> <span class='kw'>if</span> <span class='id identifier rubyid_t'>t</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_with_force_shutdown'><a href="#with_force_shutdown-instance_method" title="Puma::ThreadPool#with_force_shutdown (method)">with_force_shutdown</a></span>]
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_join'>join</span>.<span class='id identifier rubyid_call'>call</span>(<span class='ivar'>@shutdown_grace_time</span>)

    <span class='comment'># If threads are _still_ running, forcefully kill them and wait to finish.
</span>    <span class='id identifier rubyid_threads'>threads</span>.<span class='id identifier rubyid_each'>each</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_kill'>kill</span>)
    <span class='id identifier rubyid_join'>join</span>.<span class='id identifier rubyid_call'>call</span>(<span class='int'>1</span>)
  <span class='kw'>end</span>

  <span class='ivar'>@spawned</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@workers</span> <span class='op'>=</span> []
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="spawn_thread-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>spawn_thread</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Must be called with @mutex held!</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L137-L192'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='137' data-end='192'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 137</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_spawn_thread'>spawn_thread</span>
  <span class='ivar'>@spawned</span> <span class='op'>+=</span> <span class='int'>1</span>

  <span class='id identifier rubyid_trigger_before_thread_start_hooks'><a href="#trigger_before_thread_start_hooks-instance_method" title="Puma::ThreadPool#trigger_before_thread_start_hooks (method)">trigger_before_thread_start_hooks</a></span>
  <span class='id identifier rubyid_th'>th</span> <span class='op'>=</span> <span class='const'>Thread</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Puma::ThreadPool.new (method)">new</a></span>(<span class='ivar'>@spawned</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_spawned'><a href="#spawned-instance_method" title="Puma::ThreadPool#spawned (method)">spawned</a></span><span class='op'>|</span>
    <span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span>.<span class='id identifier rubyid_set_thread_name'><a href="../Puma.html#set_thread_name-class_method" title="Puma.set_thread_name (method)">set_thread_name</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%s tp %03i</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> [<span class='ivar'>@name</span><span class='comma'>,</span> <span class='id identifier rubyid_spawned'><a href="#spawned-instance_method" title="Puma::ThreadPool#spawned (method)">spawned</a></span>]
    <span class='comment'># Advertise server into the thread
</span>    <span class='const'>Thread</span>.<span class='id identifier rubyid_current'>current</span>.<span class='id identifier rubyid_puma_server'><a href="../Puma.html#puma_server-instance_method" title="Puma#puma_server (method)">puma_server</a></span> <span class='op'>=</span> <span class='ivar'>@server</span>

    <span class='id identifier rubyid_todo'>todo</span>  <span class='op'>=</span> <span class='ivar'>@todo</span>
    <span class='id identifier rubyid_block'>block</span> <span class='op'>=</span> <span class='ivar'>@block</span>
    <span class='id identifier rubyid_mutex'>mutex</span> <span class='op'>=</span> <span class='ivar'>@mutex</span>
    <span class='id identifier rubyid_not_empty'>not_empty</span> <span class='op'>=</span> <span class='ivar'>@not_empty</span>
    <span class='id identifier rubyid_not_full'>not_full</span> <span class='op'>=</span> <span class='ivar'>@not_full</span>

    <span class='kw'>while</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_work'>work</span> <span class='op'>=</span> <span class='kw'>nil</span>

      <span class='id identifier rubyid_mutex'>mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
        <span class='kw'>while</span> <span class='id identifier rubyid_todo'>todo</span>.<span class='id identifier rubyid_empty?'>empty?</span>
          <span class='kw'>if</span> <span class='ivar'>@trim_requested</span> <span class='op'>&gt;</span> <span class='int'>0</span>
            <span class='ivar'>@trim_requested</span> <span class='op'>-=</span> <span class='int'>1</span>
            <span class='ivar'>@spawned</span> <span class='op'>-=</span> <span class='int'>1</span>
            <span class='ivar'>@workers</span>.<span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_th'>th</span>
            <span class='id identifier rubyid_not_full'>not_full</span>.<span class='id identifier rubyid_signal'>signal</span>
            <span class='id identifier rubyid_trigger_before_thread_exit_hooks'><a href="#trigger_before_thread_exit_hooks-instance_method" title="Puma::ThreadPool#trigger_before_thread_exit_hooks (method)">trigger_before_thread_exit_hooks</a></span>
            <span class='const'>Thread</span>.<span class='id identifier rubyid_exit'>exit</span>
          <span class='kw'>end</span>

          <span class='ivar'>@waiting</span> <span class='op'>+=</span> <span class='int'>1</span>
          <span class='kw'>if</span> <span class='ivar'>@out_of_band_pending</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_trigger_out_of_band_hook'><a href="#trigger_out_of_band_hook-instance_method" title="Puma::ThreadPool#trigger_out_of_band_hook (method)">trigger_out_of_band_hook</a></span>
            <span class='ivar'>@out_of_band_pending</span> <span class='op'>=</span> <span class='kw'>false</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_not_full'>not_full</span>.<span class='id identifier rubyid_signal'>signal</span>
          <span class='kw'>begin</span>
            <span class='id identifier rubyid_not_empty'>not_empty</span>.<span class='id identifier rubyid_wait'>wait</span> <span class='id identifier rubyid_mutex'>mutex</span>
          <span class='kw'>ensure</span>
            <span class='ivar'>@waiting</span> <span class='op'>-=</span> <span class='int'>1</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_work'>work</span> <span class='op'>=</span> <span class='id identifier rubyid_todo'>todo</span>.<span class='id identifier rubyid_shift'>shift</span>
      <span class='kw'>end</span>

      <span class='kw'>begin</span>
        <span class='ivar'>@out_of_band_pending</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_block'>block</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_work'>work</span>)
      <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='const'>STDERR</span>.<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Error reached top of thread-pool: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='ivar'>@workers</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_th'>th</span>

  <span class='id identifier rubyid_th'>th</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="stats-instance_method">
  <h3 class='signature '>
    #<strong>stats</strong>  &#x21d2; <code>Hash</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>generate stats hash so as not to perform multiple locks</p>

  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Returns:</p>
<ul class='return'>
  <li>
    <span class='type'>(<code>Hash</code>)</span>
&mdash;    <div class='inline'>
<p>hash containing stat info from <code>ThreadPool</code></p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L93-L104'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='93' data-end='104'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 93</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_stats'>stats</span>
  <span class='id identifier rubyid_with_mutex'><a href="#with_mutex-instance_method" title="Puma::ThreadPool#with_mutex (method)">with_mutex</a></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_temp'>temp</span> <span class='op'>=</span> <span class='ivar'>@backlog_max</span>
    <span class='ivar'>@backlog_max</span> <span class='op'>=</span> <span class='int'>0</span>
    { <span class='label'>backlog:</span> <span class='ivar'>@todo</span>.<span class='id identifier rubyid_size'>size</span><span class='comma'>,</span>
      <span class='label'>running:</span> <span class='ivar'>@spawned</span><span class='comma'>,</span>
      <span class='label'>pool_capacity:</span> <span class='ivar'>@waiting</span> <span class='op'>+</span> (<span class='ivar'>@max</span> <span class='op'>-</span> <span class='ivar'>@spawned</span>)<span class='comma'>,</span>
      <span class='label'>busy_threads:</span> <span class='ivar'>@spawned</span> <span class='op'>-</span> <span class='ivar'>@waiting</span> <span class='op'>+</span> <span class='ivar'>@todo</span>.<span class='id identifier rubyid_size'>size</span><span class='comma'>,</span>
      <span class='label'>backlog_max:</span> <span class='id identifier rubyid_temp'>temp</span>
    }
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="trigger_before_thread_exit_hooks-instance_method">
  <h3 class='signature priv'>
    #<strong>trigger_before_thread_exit_hooks</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L211-L222'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='211' data-end='222'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 211</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_trigger_before_thread_exit_hooks'>trigger_before_thread_exit_hooks</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='ivar'>@before_thread_exit</span><span class='op'>&amp;.</span><span class='id identifier rubyid_any?'>any?</span>

  <span class='ivar'>@before_thread_exit</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_b'>b</span><span class='op'>|</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_b'>b</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_block'>block</span>].<span class='id identifier rubyid_call'>call</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>STDERR</span>.<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>WARNING before_thread_exit hook failed with exception (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="trigger_before_thread_start_hooks-instance_method">
  <h3 class='signature priv'>
    #<strong>trigger_before_thread_start_hooks</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L196-L207'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='196' data-end='207'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 196</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_trigger_before_thread_start_hooks'>trigger_before_thread_start_hooks</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='ivar'>@before_thread_start</span><span class='op'>&amp;.</span><span class='id identifier rubyid_any?'>any?</span>

  <span class='ivar'>@before_thread_start</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_b'>b</span><span class='op'>|</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_b'>b</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_block'>block</span>].<span class='id identifier rubyid_call'>call</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>STDERR</span>.<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>WARNING before_thread_start hook failed with exception (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="trigger_out_of_band_hook-instance_method">
  <h3 class='signature priv'>
    #<strong>trigger_out_of_band_hook</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Version:</p>
<ul class='version'>
  <li>
    <div class='inline'>
<p>5.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L227-L241'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='227' data-end='241'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 227</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_trigger_out_of_band_hook'>trigger_out_of_band_hook</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='ivar'>@out_of_band</span><span class='op'>&amp;.</span><span class='id identifier rubyid_any?'>any?</span>

  <span class='comment'># we execute on idle hook when all threads are free
</span>  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='ivar'>@spawned</span> <span class='op'>==</span> <span class='ivar'>@waiting</span>
  <span class='ivar'>@out_of_band_running</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='ivar'>@out_of_band</span>.<span class='id identifier rubyid_each'>each</span> { <span class='op'>|</span><span class='id identifier rubyid_b'>b</span><span class='op'>|</span> <span class='id identifier rubyid_b'>b</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_block'>block</span>].<span class='id identifier rubyid_call'>call</span> }
  <span class='kw'>true</span>
<span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='const'>STDERR</span>.<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Exception calling out_of_band_hook: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>true</span>
<span class='kw'>ensure</span>
  <span class='ivar'>@out_of_band_running</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@out_of_band_condvar</span>.<span class='id identifier rubyid_broadcast'>broadcast</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="trim-instance_method">
  <h3 class='signature '>
    #<strong>trim</strong>(force = false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>If there are any free threads in the pool, tell one to go ahead and exit. If <code>force</code> is true, then a trim request is requested even if all threads are being utilized.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L283-L291'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='283' data-end='291'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 283</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_trim'>trim</span>(<span class='id identifier rubyid_force'>force</span><span class='op'>=</span><span class='kw'>false</span>)
  <span class='id identifier rubyid_with_mutex'><a href="#with_mutex-instance_method" title="Puma::ThreadPool#with_mutex (method)">with_mutex</a></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_free'>free</span> <span class='op'>=</span> <span class='ivar'>@waiting</span> <span class='op'>-</span> <span class='ivar'>@todo</span>.<span class='id identifier rubyid_size'>size</span>
    <span class='kw'>if</span> (<span class='id identifier rubyid_force'>force</span> <span class='kw'>or</span> <span class='id identifier rubyid_free'>free</span> <span class='op'>&gt;</span> <span class='int'>0</span>) <span class='kw'>and</span> <span class='ivar'>@spawned</span> <span class='op'>-</span> <span class='ivar'>@trim_requested</span> <span class='op'>&gt;</span> <span class='ivar'>@min</span>
      <span class='ivar'>@trim_requested</span> <span class='op'>+=</span> <span class='int'>1</span>
      <span class='ivar'>@not_empty</span>.<span class='id identifier rubyid_signal'>signal</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="wait_while_out_of_band_running-instance_method">
  <h3 class='signature '>
    #<strong>wait_while_out_of_band_running</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L245-L251'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='245' data-end='251'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 245</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_while_out_of_band_running'>wait_while_out_of_band_running</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='ivar'>@out_of_band_running</span>

  <span class='id identifier rubyid_with_mutex'><a href="#with_mutex-instance_method" title="Puma::ThreadPool#with_mutex (method)">with_mutex</a></span> <span class='kw'>do</span>
    <span class='ivar'>@out_of_band_condvar</span>.<span class='id identifier rubyid_wait'>wait</span>(<span class='ivar'>@mutex</span>) <span class='kw'>while</span> <span class='ivar'>@out_of_band_running</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="with_force_shutdown-instance_method">
  <h3 class='signature '>
    #<strong>with_force_shutdown</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Allows <a href="ThreadPool/ForceShutdown.html" title="Puma::ThreadPool::ForceShutdown (class)"><code>ThreadPool::ForceShutdown</code></a> to be raised within the provided block if the thread is forced to shutdown during execution.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L349-L358'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='349' data-end='358'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 349</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_with_force_shutdown'>with_force_shutdown</span>
  <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='const'>Thread</span>.<span class='id identifier rubyid_current'>current</span>
  <span class='ivar'>@shutdown_mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="ThreadPool/ForceShutdown.html" title="Puma::ThreadPool::ForceShutdown (class)">ForceShutdown</a></span> <span class='kw'>if</span> <span class='ivar'>@force_shutdown</span>
    <span class='id identifier rubyid_t'>t</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_with_force_shutdown'>with_force_shutdown</span>] <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
  <span class='kw'>yield</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_t'>t</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_with_force_shutdown'>with_force_shutdown</span>] <span class='op'>=</span> <span class='kw'>false</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="with_mutex-instance_method">
  <h3 class='signature '>
    #<strong>with_mutex</strong>(&amp;block)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  <p class='tag_title'>Version:</p>
<ul class='version'>
  <li>
    <div class='inline'>
<p>5.0.0</p>
</div>
  </li>
</ul>

</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/main/lib/puma/thread_pool.rb#L254-L258'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='254' data-end='258'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 254</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_with_mutex'>with_mutex</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='ivar'>@mutex</span>.<span class='id identifier rubyid_owned?'>owned?</span> <span class='op'>?</span>
    <span class='kw'>yield</span> <span class='op'>:</span>
    <span class='ivar'>@mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span>(<span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>