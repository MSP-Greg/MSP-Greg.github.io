<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: CONTRIBUTING &mdash; Nokogiri main</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "CONTRIBUTING",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Nokogiri main</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: CONTRIBUTING&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>Contributing to <a href="Nokogiri.html" title="Nokogiri (module)"><code>Nokogiri</code></a></h1>

<p>This doc is intended to be a short introduction on how to modify and maintain <a href="Nokogiri.html" title="Nokogiri (module)"><code>Nokogiri</code></a>.</p>

<p>If you&#39;re looking for guidance on filing a bug report or getting support, please visit the <a href="http://www.nokogiri.org/tutorials/getting_help.html">&quot;Getting Help&quot; tutorial</a> at the <a href="http://nokogiri.org">nokogiri.org</a> site.</p>

<h2>Contents</h2>

<!-- regenerate TOC with `rake format:toc` -->

<!-- toc -->

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#code-of-conduct">Code of Conduct</a></li>
<li><a href="#some-guiding-principles-of-the-project">Some guiding principles of the project</a></li>
<li><a href="#where-to-start-getting-involved">Where to start getting involved</a></li>
<li><a href="#submitting-pull-requests">Submitting Pull Requests</a></li>
<li><a href="#branch-management-and-release-management">Branch Management and Release Management</a></li>
<li><a href="#how-to-set-up-your-local-development-environment">How to set up your local development environment</a></li>
<li><a href="#how-to-run-the-tests">How to run the tests</a></li>
<li><a href="#style-guide">Style Guide</a></li>
<li><a href="#how-continuous-integration-ci-is-configured">How Continuous Integration (&quot;CI&quot;) is configured</a></li>
<li><a href="#how-oss-fuzz-is-configured">How OSS-Fuzz is configured</a></li>
<li><a href="#packaging-releases">Packaging releases</a></li>
<li><a href="#other-utilities">Other utilities</a></li>
<li><a href="#bumping-java-dependencies">Bumping Java dependencies</a></li>
<li><a href="#rake-tasks">Rake tasks</a></li>
<li><a href="#making-a-release">Making a release</a></li>
</ul>

<!-- tocstop -->

<h2>Introduction</h2>

<p>Hello there! I&#39;m super excited that you&#39;re interested in contributing to <a href="Nokogiri.html" title="Nokogiri (module)"><code>Nokogiri</code></a>. Welcome!</p>

<p>This document is intended only to provide a brief introduction on how to contribute to <a href="Nokogiri.html" title="Nokogiri (module)"><code>Nokogiri</code></a>. It&#39;s not a complete specification of everything you need to know, so if you want to know more, I encourage you to reach out to the maintainers via email, twitter, or a new Github issue. We&#39;d love to get to know you a bit better!</p>

<h2>Code of Conduct</h2>

<p>Our full Code of Conduct is in <a href="file.CODE_OF_CONDUCT.html"><code>CODE_OF_CONDUCT.md</code></a>.</p>

<p>For best results, be kind. Remember that <a href="Nokogiri.html" title="Nokogiri (module)"><code>Nokogiri</code></a> maintainers are volunteers, and treat them with respect. Do not act entitled to service. Do not be rude. Do not use judgmental or foul language.</p>

<h2>Some guiding principles of the project</h2>

<p>The top guiding principles, as noted in the README are:</p>

<ul>
<li>be secure-by-default by treating all documents as <strong>untrusted</strong> by default</li>
<li>be a <strong>thin-as-reasonable layer</strong> on top of the underlying parsers, and don&#39;t attempt to fix behavioral differences between the parsers</li>
</ul>

<p><a href="Nokogiri.html" title="Nokogiri (module)"><code>Nokogiri</code></a> supports both CRuby and JRuby, and has native code specific to each (though much Ruby code is shared between them). Some related secondary principles are:</p>

<ul>
<li>Whenever possible, implement the same functionality for both CRuby and JRuby.</li>
<li>Whenever possible, implement shared behavior as shared Ruby code (i.e., write as little native code as reasonable).</li>
<li>Whenever possible, avoid writing tests that are platform-specific (but if you do, use <code>skip</code> to provide an explanation).</li>
</ul>

<p>Notably, despite all parsers being standards-compliant, there are behavioral inconsistencies between the parsers used in the CRuby and JRuby implementations, and <a href="Nokogiri.html" title="Nokogiri (module)"><code>Nokogiri</code></a> does not and should not attempt to remove these inconsistencies. Instead, we surface these differences in the test suite when they are important/semantic; or we intentionally write tests to depend only on the important/semantic bits (omitting whitespace from regex matchers on results, for example).</p>

<p><a href="Nokogiri.html" title="Nokogiri (module)"><code>Nokogiri</code></a> is widely used in the Ruby ecosystem, and so extra care should be taken to avoid introducing breaking changes. Please read our <a href="https://nokogiri.org/index.html#semantic-versioning-policy">Semantic Versioning Policy</a> to understand what we consider to be a breaking change.</p>

<h2>Where to start getting involved</h2>

<p>Please take a look at our <a href="https://github.com/sparklemotion/nokogiri/issues?q=is%3Aissue+is%3Aopen+label%3A%22help+wanted%22">Issues marked &quot;Help Wanted&quot;</a>.</p>

<p>Also, <a href="#documentation">pull requests for documentation improvements are always welcome</a>!</p>

<h2>Submitting Pull Requests</h2>

<p>Pull requests should be made with <code>main</code> as the merge base. See the next section for details.</p>

<p><strong>Pull requests that introduce behavior change must always contain a test</strong> demonstrating the behavior being introduced, fixed, or changed. These tests should ideally communicate to the maintainers the problem being solved. We will ask you for clarification if we don&#39;t understand the problem you&#39;re trying to solve.</p>

<p>If the pull request contains a feature or a bugfix, please make sure to create a CHANGELOG entry in the &quot;unreleased&quot; section.</p>

<p>Please do not submit pull requests that make purely cosmetic changes to the code (style, naming, etc.). While we recognize that the code can always be improved, we prefer that you focus on more impactful contributions.</p>

<p>Feel free to push a &quot;work in progress&quot; to take advantage of the feedback loops from CI. But then please indicate that it&#39;s still in progress by marking it as a <a href="https://docs.github.com/en/github/collaborating-with-issues-and-pull-requests/about-pull-requests#draft-pull-requests">Draft Pull Request</a>.</p>

<h2>Branch Management and Release Management</h2>

<p><a href="Nokogiri.html" title="Nokogiri (module)"><code>Nokogiri</code></a> follows SemVer, and some nuances of that policy are spelled out in <a href="https://nokogiri.org/index.html#semantic-versioning-policy">Semantic Versioning Policy</a>.</p>

<p>Development should be happening on <code>main</code>, which sets <a href="Nokogiri.html#VERSION-constant" title="Nokogiri::VERSION (constant)">Nokogiri::VERSION</a> to a development version of the next minor release (e.g., <code>&quot;1.14.0.dev&quot;</code>). All pull requests should have <code>main</code> as the merge base.</p>

<p>Patch releases should be made by cherry-picking commits from <code>main</code> onto the release branch (e.g., <code>v1.13.x</code>) in a pull request labeled <code>backport</code>.</p>

<h2>How to set up your local development environment</h2>

<h3>Basic</h3>

<pre class="code sh"><code class="sh">git clone --recurse-submodules https://github.com/sparklemotion/nokogiri
cd nokogiri
bundle install
</code></pre>

<h3>Advanced</h3>

<p>Please install the latest or previous version of CRuby (e.g., 3.2 or 3.1 as of 2023-01), and a recent version of JRuby. We recommend using <code>rbenv</code>, which is used in test scripts when necessary to test gems against multiple rubies.</p>

<p>Please install a system version of libxml2/libxslt (see <a href="https://nokogiri.org/tutorials/installing_nokogiri.html#installing-using-standard-system-libraries">Installing Nokogiri</a> for details) so that you can test against both the packaged libraries and your system libraries.</p>

<p>We recommend that you install <code>valgrind</code> if you can, but it&#39;s only necessary for debugging problems so feel free to wait until you need it. (I&#39;m not sure valgrind is easily available on MacOS.)</p>

<p>If you plan to package precompiled native gems, make sure <code>docker</code> is installed and is working properly.</p>

<h2>How to run the tests</h2>

<p>Note that <code>rake test</code> does not compile the native extension, and this is intentional (so we can run the test suite against an installed gem). If you&#39;re modifying the extension code, please make sure you re-compile each time you run the tests to ensure you&#39;re testing your changes.</p>

<h3>The short version</h3>

<pre class="code sh"><code class="sh">bundle exec rake compile test
</code></pre>

<p>To run a focused test, use Minitest&#39;s <code>TESTOPTS</code>:</p>

<pre class="code sh"><code class="sh">bundle exec rake compile test TESTOPTS=&quot;-n/test_last_element_child/&quot;
</code></pre>

<p>To run the test suite in parallel, set the <code>NCPU</code> environment variable; and to compile in parallel, set the <code>MAKEFLAGS</code> environment variable (you may want to set these in something like your .bashrc):</p>

<pre class="code sh"><code class="sh">export NCPU=8
export MAKEFLAGS=-j8
bundle exec rake compile test
</code></pre>

<h3>CRuby advanced usage</h3>

<p>Test using your system&#39;s libraries:</p>

<pre class="code sh"><code class="sh">bundle exec rake clean  #  blow away pre-existing libraries using packaged libs
bundle exec rake compile test -- --enable-system-libraries
</code></pre>

<p>Run performance tests:</p>

<pre class="code sh"><code class="sh">bundle exec rake compile test:bench
</code></pre>

<p>Run tests using valgrind:</p>

<pre class="code sh"><code class="sh">bundle exec rake compile test:valgrind
</code></pre>

<p>Run tests in the debugger:</p>

<pre class="code sh"><code class="sh">bundle exec rake compile test:gdb
# or
bundle exec rake compile test:lldb
</code></pre>

<p>Run tests and look for memory leaks with valgrind and ruby_memcheck:</p>

<pre class="code sh"><code class="sh">bundle exec rake compile test:memcheck
</code></pre>

<p>Run test/test_memory_usage.rb and look for memory leaks using RSS size and linear interpolation:</p>

<pre class="code sh"><code class="sh">bundle exec rake compile test:memory_suite
</code></pre>

<p>Note that by you can run the test suite with a variety of GC behaviors. For example, running a major after each test completes has, on occasion, been useful for localizing some classes of memory bugs, but does slow the suite down. Some variations of the test suite behavior are available (see <code>test/helper.rb</code> for more info):</p>

<pre class="code sh"><code class="sh"># ordinary GC behavior
NOKOGIRI_TEST_GC_LEVEL=normal bundle exec rake compile test

# minor GC after each test
NOKOGIRI_TEST_GC_LEVEL=minor bundle exec rake compile test

# major GC after each test
NOKOGIRI_TEST_GC_LEVEL=major bundle exec rake compile test

# major GC after each test and GC compaction after every 20 tests
NOKOGIRI_TEST_GC_LEVEL=compact bundle exec rake compile test

# verify references after compaction after every 20 tests
# (see https://alanwu.space/post/check-compaction/)
NOKOGIRI_TEST_GC_LEVEL=verify bundle exec rake compile test

# run with GC &quot;stress mode&quot; on
NOKOGIRI_TEST_GC_LEVEL=stress bundle exec rake compile test
</code></pre>

<h3>libxml2 advanced usage</h3>

<p>If you want to build Nokogiri against a modified version of libxml2 or libxslt, clone them both into sibling directories (<code>../libxml2</code> and <code>../libxslt</code>) then run <code>scripts/compile-against-libxml2-source</code>.</p>

<p>That script also takes an optional command to run with the proper environment variables set to use the local libxml2 library, which can be useful when trying to <code>git bisect</code> against libxml2 or libxslt. So, for example:</p>

<pre class="code sh"><code class="sh">scripts/compile-against-libxml2-source bundle exec rake test
</code></pre>

<p>An alternative, if you&#39;re not bisecting or hacking on libxml2 or libxslt, is:</p>

<pre class="code sh"><code class="sh">bundle exec rake compile -- \
  --with-xslt-source-dir=$(pwd)/../libxslt \
  --with-xml2-source-dir=$(pwd)/../libxml2
</code></pre>

<h3>gumbo HTML5 parser</h3>

<p>To run the test suite for the gumbo parser:</p>

<pre class="code sh"><code class="sh">bundle exec rake gumbo
</code></pre>

<p>Please note that additional html5lib tests for Nokogiri&#39;s HTML5 parser exist in a submodule. If you haven&#39;t checked that submodule out, here&#39;s how to do so:</p>

<pre class="code sh"><code class="sh">git submodule update --init  #  test/html5lib-tests
bundle exec rake compile test
</code></pre>

<h3>Fuzzing your gumbo HTML5 parser changes</h3>

<p>When making changes or adding new features to <code>gumbo-parser</code>, it&#39;s recommended to run <a href="https://llvm.org/docs/LibFuzzer.html">libfuzzer</a> against <code>gumbo-parser</code> using various <a href="https://github.com/google/sanitizers/wiki">sanitizers</a>.</p>

<p>Build the fuzzers by navigating to the <code>gumbo-parser</code> directory and running <code>make fuzzers</code>. Once built, navigate to the <code>gumbo-parser/fuzzer/build</code> directory and execute one of the following binaries in this directory:</p>

<ul>
<li>parse_fuzzer (standard fuzzer with no sanitizer)</li>
<li>parse_fuzzer-asan (fuzzer built using <a href="https://clang.llvm.org/docs/AddressSanitizer.html">ASAN</a>)</li>
<li>parse_fuzzer-msan (fuzzer built using <a href="https://clang.llvm.org/docs/MemorySanitizer.html">MSAN</a>)</li>
<li>parse_fuzzer-ubsan (fuzzer built using <a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html">UBSAN</a>)</li>
</ul>

<p>To fuzz more efficiently, use the dictionary (gumbo.dict) and corpus (gumbo_corpus) found in <code>gumbo-parser/fuzzer</code> using the following arguments (assuming parse_fuzzer is in use):</p>

<pre class="code ruby"><code class="ruby">.<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>parse_fuzzer -dict=..</span><span class='regexp_end'>/gumbo</span></span>.<span class='id identifier rubyid_dict'>dict</span> <span class='op'>..</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>gumbo_corpus</span></code></pre>

<p>If the binary executed successfully you should now be seeing the following output filling up your terminal (see <a href="https://llvm.org/docs/LibFuzzer.html#output">https://llvm.org/docs/LibFuzzer.html#output</a> for more information):</p>

<pre class="code ruby"><code class="ruby"><span class='const'>INFO</span><span class='op'>:</span> <span class='const'>Seed</span><span class='op'>:</span> <span class='int'>4156947595</span>
<span class='const'>INFO</span><span class='op'>:</span> <span class='const'>Loaded</span> <span class='int'>1</span> <span class='id identifier rubyid_modules'>modules</span>   (<span class='int'>7149</span> <span class='id identifier rubyid_inline'>inline</span> <span class='int'>8</span><span class='op'>-</span><span class='id identifier rubyid_bit'>bit</span> <span class='id identifier rubyid_counters'>counters</span>)<span class='op'>:</span> <span class='int'>7149</span> <span class='int'>0x58a462</span><span class='comma'>,</span> <span class='int'>0x58c04f</span><span class='comma'>,</span> 
<span class='const'>INFO</span><span class='op'>:</span> <span class='const'>Loaded</span> <span class='int'>1</span> <span class='const'>PC</span> <span class='id identifier rubyid_tables'>tables</span> (<span class='int'>7149</span> <span class='const'>PCs</span>)<span class='op'>:</span> <span class='int'>7149</span> <span class='int'>0x53beb0</span><span class='comma'>,</span><span class='int'>0x557d80</span><span class='comma'>,</span> 
<span class='const'>INFO</span><span class='op'>:</span> <span class='op'>-</span><span class='id identifier rubyid_max_len'>max_len</span> <span class='id identifier rubyid_is'>is</span> <span class='kw'>not</span> <span class='id identifier rubyid_provided'>provided</span><span class='semicolon'>;</span> <span class='id identifier rubyid_libFuzzer'>libFuzzer</span> <span class='id identifier rubyid_will'>will</span> <span class='kw'>not</span> <span class='id identifier rubyid_generate'>generate</span> <span class='id identifier rubyid_inputs'>inputs</span> <span class='id identifier rubyid_larger'>larger</span> <span class='id identifier rubyid_than'>than</span> <span class='int'>4096</span> <span class='id identifier rubyid_bytes'>bytes</span>
<span class='const'>INFO</span><span class='op'>:</span> <span class='const'>A</span> <span class='id identifier rubyid_corpus'>corpus</span> <span class='id identifier rubyid_is'>is</span> <span class='kw'>not</span> <span class='id identifier rubyid_provided'>provided</span><span class='comma'>,</span> <span class='id identifier rubyid_starting'>starting</span> <span class='id identifier rubyid_from'>from</span> <span class='id identifier rubyid_an'>an</span> <span class='id identifier rubyid_empty'>empty</span> <span class='id identifier rubyid_corpus'>corpus</span>
<span class='comment'>#2  INITED cov: 2 ft: 2 corp: 1/1b exec/s: 0 rss: 24Mb
</span>    <span class='const'>NEW_FUNC</span>[<span class='int'>1</span><span class='op'>/</span><span class='int'>44</span>]<span class='op'>:</span> <span class='int'>0x429840</span> <span class='kw'>in</span> <span class='id identifier rubyid_gumbo_parse_with_options'>gumbo_parse_with_options</span> (<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>home</span><span class='regexp_end'>/user</span></span><span class='op'>/</span><span class='id identifier rubyid_nokogiri'>nokogiri</span><span class='op'>/</span><span class='id identifier rubyid_gumbo'>gumbo</span><span class='op'>-</span><span class='id identifier rubyid_parser'>parser</span><span class='op'>/</span><span class='id identifier rubyid_fuzzer'>fuzzer</span><span class='op'>/</span><span class='id identifier rubyid_build'>build</span><span class='op'>/</span><span class='id identifier rubyid_parse_fuzzer'>parse_fuzzer</span><span class='op'>+</span><span class='int'>0x429840</span>)
    <span class='const'>NEW_FUNC</span>[<span class='int'>2</span><span class='op'>/</span><span class='int'>44</span>]<span class='op'>:</span> <span class='int'>0x42c0d0</span> <span class='kw'>in</span> <span class='id identifier rubyid_destroy_node'>destroy_node</span> (<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>home</span><span class='regexp_end'>/user</span></span><span class='op'>/</span><span class='id identifier rubyid_nokogiri'>nokogiri</span><span class='op'>/</span><span class='id identifier rubyid_gumbo'>gumbo</span><span class='op'>-</span><span class='id identifier rubyid_parser'>parser</span><span class='op'>/</span><span class='id identifier rubyid_fuzzer'>fuzzer</span><span class='op'>/</span><span class='id identifier rubyid_build'>build</span><span class='op'>/</span><span class='id identifier rubyid_parse_fuzzer'>parse_fuzzer</span><span class='op'>+</span><span class='int'>0x42c0d0</span>)
<span class='comment'>#721    NEW    cov: 180 ft: 181 corp: 2/12b lim: 11 exec/s: 0 rss: 27Mb L: 11/11 MS: 4 ChangeByte-ChangeByte-ChangeBit-InsertRepeatedBytes-
</span><span class='comment'>#722    NEW    cov: 186 ft: 196 corp: 3/23b lim: 11 exec/s: 0 rss: 27Mb L: 11/11 MS: 1 ChangeBit-
</span><span class='comment'>#723    NEW    cov: 186 ft: 228 corp: 4/34b lim: 11 exec/s: 0 rss: 27Mb L: 11/11 MS: 1 ChangeBinInt-
</span><span class='comment'>#724    NEW    cov: 188 ft: 241 corp: 5/45b lim: 11 exec/s: 0 rss: 27Mb L: 11/11 MS: 1 ChangeBit-
</span><span class='comment'>#725    NEW    cov: 188 ft: 254 corp: 6/56b lim: 11 exec/s: 0 rss: 27Mb L: 11/11 MS: 1 ChangeByte-
</span><span class='comment'>#726    NEW    cov: 188 ft: 270 corp: 7/67b lim: 11 exec/s: 0 rss: 27Mb L: 11/11 MS: 1 CopyPart-
</span><span class='comment'>#732    NEW    cov: 188 ft: 279 corp: 8/78b lim: 11 exec/s: 0 rss: 27Mb L: 11/11 MS: 1 ChangeBit-
</span>    <span class='const'>NEW_FUNC</span>[<span class='int'>1</span><span class='op'>/</span><span class='int'>1</span>]<span class='op'>:</span> <span class='int'>0x441de0</span> <span class='kw'>in</span> <span class='id identifier rubyid_gumbo_token_destroy'>gumbo_token_destroy</span> (<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>home</span><span class='regexp_end'>/user</span></span><span class='op'>/</span><span class='id identifier rubyid_nokogiri'>nokogiri</span><span class='op'>/</span><span class='id identifier rubyid_gumbo'>gumbo</span><span class='op'>-</span><span class='id identifier rubyid_parser'>parser</span><span class='op'>/</span><span class='id identifier rubyid_fuzzer'>fuzzer</span><span class='op'>/</span><span class='id identifier rubyid_build'>build</span><span class='op'>/</span><span class='id identifier rubyid_parse_fuzzer'>parse_fuzzer</span><span class='op'>+</span><span class='int'>0x441de0</span>)</code></pre>

<p>However, if the fuzzer finds a &quot;crash&quot; (indicating that a bug has been found) it will stop fuzzing and the following output would be expected:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>INFO</span><span class='op'>:</span> <span class='const'>Seed</span><span class='op'>:</span> <span class='int'>1523017872</span>
<span class='const'>INFO</span><span class='op'>:</span> <span class='const'>Loaded</span> <span class='int'>1</span> <span class='id identifier rubyid_modules'>modules</span> (<span class='int'>16</span> <span class='id identifier rubyid_guards'>guards</span>)<span class='op'>:</span> <span class='int'>0x744e60</span><span class='comma'>,</span> <span class='int'>0x744ea0</span><span class='comma'>,</span>
<span class='const'>INFO</span><span class='op'>:</span> <span class='op'>-</span><span class='id identifier rubyid_max_len'>max_len</span> <span class='id identifier rubyid_is'>is</span> <span class='kw'>not</span> <span class='id identifier rubyid_provided'>provided</span><span class='comma'>,</span> <span class='id identifier rubyid_using'>using</span> <span class='int'>64</span>
<span class='const'>INFO</span><span class='op'>:</span> <span class='const'>A</span> <span class='id identifier rubyid_corpus'>corpus</span> <span class='id identifier rubyid_is'>is</span> <span class='kw'>not</span> <span class='id identifier rubyid_provided'>provided</span><span class='comma'>,</span> <span class='id identifier rubyid_starting'>starting</span> <span class='id identifier rubyid_from'>from</span> <span class='id identifier rubyid_an'>an</span> <span class='id identifier rubyid_empty'>empty</span> <span class='id identifier rubyid_corpus'>corpus</span>
<span class='comment'>#0    READ units: 1
</span><span class='comment'>#1    INITED cov: 3 ft: 2 corp: 1/1b exec/s: 0 rss: 24Mb
</span><span class='comment'>#3811 NEW    cov: 4 ft: 3 corp: 2/2b exec/s: 0 rss: 25Mb L: 1 MS: 5 ChangeBit-ChangeByte-ChangeBit-ShuffleBytes-ChangeByte-
</span><span class='comment'>#3827 NEW    cov: 5 ft: 4 corp: 3/4b exec/s: 0 rss: 25Mb L: 2 MS: 1 CopyPart-
</span><span class='comment'>#3963 NEW    cov: 6 ft: 5 corp: 4/6b exec/s: 0 rss: 25Mb L: 2 MS: 2 ShuffleBytes-ChangeBit-
</span><span class='comment'>#4167 NEW    cov: 7 ft: 6 corp: 5/9b exec/s: 0 rss: 25Mb L: 3 MS: 1 InsertByte-
</span><span class='op'>==</span><span class='int'>31511</span><span class='op'>==</span> <span class='const'>ERROR</span><span class='op'>:</span> <span class='id identifier rubyid_libFuzzer'>libFuzzer</span><span class='op'>:</span> <span class='id identifier rubyid_deadly'>deadly</span> <span class='id identifier rubyid_signal'>signal</span>
<span class='comment'>#...
</span><span class='id identifier rubyid_artifact_prefix'>artifact_prefix</span><span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>./</span><span class='tstring_end'>&#39;</span></span><span class='semicolon'>;</span> <span class='const'>Test</span> <span class='id identifier rubyid_unit'>unit</span> <span class='id identifier rubyid_written'>written</span> <span class='id identifier rubyid_to'>to</span> .<span class='op'>/</span><span class='id identifier rubyid_crash'>crash</span><span class='op'>-</span><span class='id identifier rubyid_b13e8756b13a00cf168300179061fb4b91fefbed'>b13e8756b13a00cf168300179061fb4b91fefbed</span></code></pre>

<p>The above indicates that a crash has been identified and it can be reproduced by feeding the <code>crash-b13e8756b13a00cf168300179061fb4b91fefbed</code> file back into the binary used for fuzzing (e.g. parse-fuzzer) using the following command:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_parse_fuzzer'>parse_fuzzer</span> <span class='id identifier rubyid_crash'>crash</span><span class='op'>-</span><span class='id identifier rubyid_b13e8756b13a00cf168300179061fb4b91fefbed'>b13e8756b13a00cf168300179061fb4b91fefbed</span></code></pre>

<p>If you&#39;d like to learn more about libfuzzer please give <a href="https://github.com/google/fuzzing/blob/master/tutorial/libFuzzerTutorial.md">https://github.com/google/fuzzing/blob/master/tutorial/libFuzzerTutorial.md</a> a try.</p>

<h2>Style Guide</h2>

<h3>Documentation</h3>

<p>We use <code>rdoc</code> to build Nokogiri&#39;s documentation. Run <code>rake rdoc</code> to build into the <code>./html</code> directory, and see the rdoc tasks in <a href="rakelib/rdoc.rake">rakelib/rdoc.rake</a>.</p>

<p>Previously we made some effort to move towards <code>yard</code> but that work was stopped (and the decision record can be found at <a href="https://github.com/sparklemotion/nokogiri/issues/1996">RFC: convert to use <code>yard</code> for documentation</a>).</p>

<p>Docstrings should be in <code>RDoc::Markup</code> format, though simple docstrings may be in Markdown (using <code>:markup: markdown</code>).</p>

<p>If you submit pull requests that improve documentation, <strong>I will happily merge them</strong> and credit you in the CHANGELOG.</p>

<p>Some guidelines (see <a href="lib/nokogiri/xml/node.rb">lib/nokogiri/xml/node.rb</a> and <a href="ext/nokogiri/xml/node.c">ext/nokogiri/xml/node.c</a> for examples):</p>

<ul>
<li>Use <code>:call-seq:</code> to ...

<ul>
<li>note the return type of the method whenever possible, e.g. <code>:call-seq: upcase(name) → String</code></li>
<li>name all the aliases of a method</li>
<li>indicate block/yield usage of a method</li>
</ul></li>
<li>Briefly explain the purpose of the method, what it returns, and what side effects it has</li>
<li>Use a <code>[Parameters]</code> definition to note the expected types of all the parameters as a bulleted list</li>
<li>Use a <code>[Returns]</code> definition to note the return type</li>
<li>Use a <code>[Yields]</code> definition to note the block parameters</li>
<li>Use a <code>⚠</code> character to warn the user about tricky usage</li>
<li>Use a <code>💡</code> character to call attention to important notes</li>
<li><code>See also:</code> should be used to call out related methods</li>
<li><code>Since</code> should be used to indicate the version in which the code was introduced</li>
<li>Prefer to <strong>show</strong> nuanced behavior in code examples, rather than try to explain it in prose.</li>
</ul>

<h3>Code</h3>

<p>I don&#39;t feel very strongly about code style, but this project follows <a href="https://shopify.github.io/ruby-style-guide/">Shopify&#39;s Ruby Style Guide</a>, and for C and Java code the project uses the <code>astyle</code> configuration laid out in <code>./rakelib/format.rake</code>.</p>

<p>You can auto-format the C, Java, and Ruby code with <code>rake format</code>.</p>

<p>There are some pending Rubocop rules in <code>.rubocop_todo.yml</code>. If you&#39;d like to fix them up, I will happily merge your pull request.</p>

<p>No, I don&#39;t want to debate any of the style choices.</p>

<h2>How Continuous Integration (&quot;CI&quot;) is configured</h2>

<p>The bulk of CI is running in Github Actions since May 2021: <a href="https://github.com/sparklemotion/nokogiri/actions">https://github.com/sparklemotion/nokogiri/actions</a></p>

<p>However, we also run tests against 32-bit windows (which aren&#39;t supported by GA as of this writing) in Appveyor: <a href="https://ci.appveyor.com/project/flavorjones/nokogiri">https://ci.appveyor.com/project/flavorjones/nokogiri</a></p>

<p>A known hole in CI coverage is the lack native gem tests for arm64-darwin.</p>

<h3>Coverage</h3>

<p>The <code>ci.yml</code> pipeline includes jobs to:</p>

<ul>
<li>basic security sanity check and formatting check, using Rubocop</li>
<li>fast feedback for obvious failures: run against system libraries on vanilla ubuntu</li>
<li>run the Gumbo parser tests on ubuntu, macos, and windows</li>
<li>run on all supported versions of CRuby:

<ul>
<li>once with packaged libraries</li>
<li>once with system libraries</li>
<li>once on valgrind (to look for memory bugs)</li>
</ul></li>
<li>run the test suite looking for new memory leaks (using ruby_memcheck)</li>
<li>run on JRuby</li>
<li>run on TruffleRuby</li>
<li>run on a Musl (Alpine) system:

<ul>
<li>against system libraries</li>
<li>with valgrind using packaged libraries</li>
</ul></li>
<li>run with libxml-ruby loaded (because this can interact with libxml2 in conflicting ways)

<ul>
<li>against system libraries</li>
<li>with valgrind using packaged libraries</li>
</ul></li>
<li>build a &quot;ruby&quot; platform gem

<ul>
<li>install and test on linux, macos, and windows</li>
</ul></li>
<li>build native gems

<ul>
<li>install and test against all supported versions of CRuby</li>
<li>install and test on a variety of linux, macos, and windows systems</li>
</ul></li>
<li>build a jruby gem, install and test it</li>
</ul>

<p>The <code>upstream.yml</code> pipeline includes jobs to:</p>

<ul>
<li>run against libxml2 and libxslt head (linux), including a valgrind check</li>
<li>run against CRuby head (linux, windows, macos) including a valgrind check</li>
<li>run against JRuby head</li>
<li>run html5lib-tests from that project&#39;s <code>origin/master</code></li>
</ul>

<p>The <code>downstream.yml</code> pipeline includes jobs to run notable downstream dependents against Nokogiri <code>main</code>.</p>

<p>The <code>generate-ci-images.yml</code> pipeline builds some containers used by the other pipelines once a week. This is primarily an optimization to make sure system packages (like <code>libxml2-dev</code> and <code>valgrind</code>) are already installed. See <code>oci-images/nokogiri-test/</code> for details on what&#39;s in these containers.</p>

<h3>Valgrind and <code>ruby_memcheck</code></h3>

<p>We rely heavily on Valgrind and <a href="https://github.com/Shopify/ruby_memcheck"><code>ruby_memcheck</code></a> to catch memory bugs by running in combination with every version of CRuby.</p>

<p>We use suppressions primarily to quiet known small memory leaks or quirks of certain Ruby versions. See the files in the <code>/suppressions</code> directory and <code>/rakelib/test.rake</code> for more information.</p>

<h3>Benchmark / Performance tests</h3>

<p>A separate suite, <code>test:bench</code>, can be run to ensure a few performance expectations. As of 2022-02 this suite is small, but we can grow it over time. These tests are run in CI on CRuby and JRuby.</p>

<p>These tests should use <code>Nokogiri::TestBenchmark</code> as the base class, and be in a file matching the glob <code>test/**/bench_*.rb</code>.</p>

<h3>Helpful hints when writing new CI jobs</h3>

<ul>
<li>Always checkout the source code <strong>including submodules</strong> (for the html5lib tests)</li>
<li>When testing packaged libraries (not system libraries), cache either <code>ports/</code> (for compiled libraries) or <code>ports/archives/</code> (for just tarballs)

<ul>
<li>note that <code>libgumbo</code> is built outside of <code>ports/</code> to allow us to do this caching safely</li>
</ul></li>
</ul>

<h2>How OSS-Fuzz is configured</h2>

<p><a href="https://oss-fuzz.com/">OSS-Fuzz</a> is a service that runs fuzzing against open-source libraries.</p>

<p>OSS-Fuzz was configured to fuzz Nokogiri&#39;s libgumbo in <a href="https://github.com/google/oss-fuzz/pull/11004">https://github.com/google/oss-fuzz/pull/11004</a>. Updating the configuration should be done in that project.</p>

<p>Notifications go to <code>nokogiri-oss-fuzz@googlegroups.com</code>.</p>

<p>Some historical context can be found in <a href="https://github.com/sparklemotion/nokogiri/discussions/2992">discussion #2992</a> and <a href="https://github.com/sparklemotion/nokogiri/pull/3007">pull request #3007</a> by @fuzzy-boiii23a.</p>

<h2>Packaging releases</h2>

<p>As a prerequisite please make sure you have <code>docker</code> correctly installed, to build native (precompiled) gems.</p>

<p>Run <code>scripts/build-gems</code> which will package gems for all supported platforms, and run some basic sanity tests on those packages using <code>scripts/test-gem-set</code>, <code>scripts/test-gem-file-contents</code>, and <code>scripts/test-gem-installation</code>.</p>

<p>See <a href="#making-a-release">Making a release</a> below for the checklist.</p>

<h2>Other utilities</h2>

<p><code>scripts/test-exported-symbols</code> checks the compiled <code>nokogiri.so</code> library for surprising exported symbols. This script likely only works on Linux, sorry.</p>

<p><code>scripts/files-modified-by-open-prs</code> is a hack to see what files are being proposed to change in the set of open pull requests. This might be useful if you&#39;re thinking about radically changing a file, to be aware of what merge conflicts might result. This could probably be a rake task.</p>

<p>There&#39;s a <code>Vagrantfile</code> in the project root which I&#39;ve used once or twice to try to reproduce problems non-Linux systems (like OpenBSD). It&#39;s not well-maintained so YMMV.</p>

<h2>Bumping Java dependencies</h2>

<p>Java dependencies, in the form of <code>.jar</code> files, are all vendored as part of the <code>java</code> platform gem.</p>

<p>We use <a href="https://github.com/mkristian/jar-dependencies"><code>jar-dependencies</code></a> as a development dependency to manage the project&#39;s Java dependencies. Note, however, that we use our own fork of NekoDTD that lives at <a href="https://github.com/sparklemotion/nekodtd">https://github.com/sparklemotion/nekodtd</a></p>

<p>To modify or add a dependency, a few things needs to be in sync:</p>

<ul>
<li><code>nokogiri.gemspec</code>: <code>spec.requirements</code> need to specify the maven group Id, artifact ID, and version</li>
<li><code>nokogiri.gemspec</code>: <code>spec.files</code> need to include the jar files</li>
<li>git: the jar files under <code>lib/nokogiri/jruby/</code> need to be committed to git</li>
<li><code>lib/nokogiri/jruby/nokogiri_jars.rb</code>: needs to include all the jars</li>
</ul>

<p>A quick summary of what this looks like for you, the developer:</p>

<ol>
<li>edit the <code>requirements</code> in the gemspec</li>
<li>run <code>bundle exec rake vendor_jars</code> which updates everything under <code>lib/nokogiri/jruby</code></li>
<li>run <code>bundle exec rake check_manifest</code> and if necessary update the gemspec <code>files</code></li>
<li>make sure to check everything under <code>lib/nokogiri/jruby</code> into git, including the jar files</li>
</ol>

<h2>Rake tasks</h2>

<p>The <code>Rakefile</code> used to be a big fat mess. It&#39;s now decomposed into a small set of files in <code>/rakelib</code>. If you&#39;ve got a new rake task you&#39;d like to introduce, please consider whether it belongs in one of the existing concerns, or needs a new file. Please don&#39;t add it to <code>Rakefile</code> without compelling reasons.</p>

<h2>Making a release</h2>

<p>A quick checklist:</p>

<ul>
<li>[ ] make sure CI is green!</li>
<li>[ ] update <code>CHANGELOG.md</code> and <code>lib/nokogiri/version/constant.rb</code></li>
<li>[ ] create a git tag</li>
<li>[ ] run <code>scripts/build-gems</code> and make sure it completes and all the tests pass</li>
<li>[ ] <code>for g in gems/*.gem ; do gem push $g ; done</code></li>
<li>[ ] create a release at <a href="https://github.com/sparklemotion/nokogiri/releases">https://github.com/sparklemotion/nokogiri/releases</a> and provide sha2 checksums</li>
<li>if security-related,

<ul>
<li>[ ] publish a GHSA</li>
<li>[ ] email <a href="mailto:ruby-security-ann@googlegroups.com">ruby-security-ann@googlegroups.com</a> and <a href="mailto:ruby-talk@ruby-lang.org">ruby-talk@ruby-lang.org</a></li>
<li>[ ] submit a PR to <a href="https://github.com/rubysec/ruby-advisory-db">https://github.com/rubysec/ruby-advisory-db</a></li>
</ul></li>
<li>[ ] update nokogiri.org</li>
<li>[ ] bump <code>lib/nokogiri/version/constant.rb</code> to a prerelease version like <code>v1.14.0.dev</code></li>
</ul>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>