<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Rack::ConditionalGet &mdash; Rack main</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Rack::ConditionalGet",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Rack main</a> &raquo; 
      <a href='../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../Rack.html" title="Rack (module)">Rack</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ConditionalGet&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Rack::ConditionalGet</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/conditional_get.rb#L21'>lib/rack/conditional_get.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Middleware that enables conditional <a href="../Rack.html#GET-constant" title="Rack::GET (constant)">GET</a> using if-none-match and if-modified-since. The application should set either or both of the last-modified or etag response headers according to RFC 2616. When either of the conditions is met, the response body is set to be zero length and the response status is set to 304 Not Modified.</p>

<p>Applications that defer response body generation until the body’s each message is received will avoid response body generation completely when a conditional <a href="../Rack.html#GET-constant" title="Rack::GET (constant)">GET</a> matches.</p>

<p>Adapted from Michael Klishin’s Merb implementation: <a href="https://github.com/wycats/merb/blob/master/merb-core/lib/merb-core/rack/middleware/conditional_get.rb">github.com/wycats/merb/blob/master/merb-core/lib/merb-core/rack/middleware/conditional_get.rb</a></p>

  </div>
</div>
</div>
<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(app)  &#x21d2; ConditionalGet </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#call-instance_method" title="#call (instance method)">#<strong>call</strong>(env)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Return empty 304 response if the response has not been modified since the last request.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#etag_matches%3F-instance_method" title="#etag_matches? (instance method)">#<strong>etag_matches?</strong>(none_match, headers)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Whether the etag response header matches the if-none-match request header.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#fresh%3F-instance_method" title="#fresh? (instance method)">#<strong>fresh?</strong>(env, headers)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Return whether the response has not been modified since the last request.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#modified_since%3F-instance_method" title="#modified_since? (instance method)">#<strong>modified_since?</strong>(modified_since, headers)  &#x21d2; Boolean </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Whether the last-modified response header matches the if-modified-since request header.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#to_rfc2822-instance_method" title="#to_rfc2822 (instance method)">#<strong>to_rfc2822</strong>(since)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Return a Time object for the given string (which should be in RFC2822 format), or nil if the string cannot be parsed.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(app)  &#x21d2; <code>ConditionalGet</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/conditional_get.rb#L22-L24'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='22' data-end='24'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/conditional_get.rb', line 22</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_app'>app</span>)
  <span class='ivar'>@app</span> <span class='op'>=</span> <span class='id identifier rubyid_app'>app</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="call-instance_method">
  <h3 class='signature  first'>
    #<strong>call</strong>(env)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return empty 304 response if the response has not been modified since the last request.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/conditional_get.rb#L28-L46'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='28' data-end='46'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/conditional_get.rb', line 28</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_env'>env</span>)
  <span class='kw'>case</span> <span class='id identifier rubyid_env'>env</span>[<span class='const'><a href="../Rack.html#REQUEST_METHOD-constant" title="Rack::REQUEST_METHOD (constant)">REQUEST_METHOD</a></span>]
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GET</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HEAD</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='ivar'>@app</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_env'>env</span>)

    <span class='kw'>if</span> <span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='int'>200</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_fresh?'><a href="#fresh%3F-instance_method" title="Rack::ConditionalGet#fresh? (method)">fresh?</a></span>(<span class='id identifier rubyid_env'>env</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span>)
      <span class='id identifier rubyid_response'>response</span>[<span class='int'>0</span>] <span class='op'>=</span> <span class='int'>304</span>
      <span class='id identifier rubyid_headers'>headers</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='const'><a href="../Rack.html#CONTENT_TYPE-constant" title="Rack::CONTENT_TYPE (constant)">CONTENT_TYPE</a></span>)
      <span class='id identifier rubyid_headers'>headers</span>.<span class='id identifier rubyid_delete'>delete</span>(<span class='const'><a href="../Rack.html#CONTENT_LENGTH-constant" title="Rack::CONTENT_LENGTH (constant)">CONTENT_LENGTH</a></span>)

      <span class='comment'># We are done with the body:
</span>      <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_close'>close</span> <span class='kw'>if</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_close'>close</span>)
      <span class='id identifier rubyid_response'>response</span>[<span class='int'>2</span>] <span class='op'>=</span> []
    <span class='kw'>end</span>
    <span class='id identifier rubyid_response'>response</span>
  <span class='kw'>else</span>
    <span class='ivar'>@app</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_env'>env</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="etag_matches?-instance_method">
  <h3 class='signature priv'>
    #<strong>etag_matches?</strong>(none_match, headers)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Whether the etag response header matches the if-none-match request header. If so, the request has not been modified.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/conditional_get.rb#L63-L65'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='65'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/conditional_get.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_etag_matches?'>etag_matches?</span>(<span class='id identifier rubyid_none_match'>none_match</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span>)
  <span class='id identifier rubyid_headers'>headers</span>[<span class='const'><a href="../Rack.html#ETAG-constant" title="Rack::ETAG (constant)">ETAG</a></span>] <span class='op'>==</span> <span class='id identifier rubyid_none_match'>none_match</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="fresh?-instance_method">
  <h3 class='signature priv'>
    #<strong>fresh?</strong>(env, headers)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return whether the response has not been modified since the last request.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/conditional_get.rb#L52-L59'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='52' data-end='59'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/conditional_get.rb', line 52</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_fresh?'>fresh?</span>(<span class='id identifier rubyid_env'>env</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span>)
  <span class='comment'># if-none-match has priority over if-modified-since per RFC 7232
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_none_match'>none_match</span> <span class='op'>=</span> <span class='id identifier rubyid_env'>env</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>HTTP_IF_NONE_MATCH</span><span class='tstring_end'>&#39;</span></span>]
    <span class='id identifier rubyid_etag_matches?'><a href="#etag_matches%3F-instance_method" title="Rack::ConditionalGet#etag_matches? (method)">etag_matches?</a></span>(<span class='id identifier rubyid_none_match'>none_match</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span>)
  <span class='kw'>elsif</span> (<span class='id identifier rubyid_modified_since'>modified_since</span> <span class='op'>=</span> <span class='id identifier rubyid_env'>env</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>HTTP_IF_MODIFIED_SINCE</span><span class='tstring_end'>&#39;</span></span>]) <span class='op'>&amp;&amp;</span> (<span class='id identifier rubyid_modified_since'>modified_since</span> <span class='op'>=</span> <span class='id identifier rubyid_to_rfc2822'><a href="#to_rfc2822-instance_method" title="Rack::ConditionalGet#to_rfc2822 (method)">to_rfc2822</a></span>(<span class='id identifier rubyid_modified_since'>modified_since</span>))
    <span class='id identifier rubyid_modified_since?'><a href="#modified_since%3F-instance_method" title="Rack::ConditionalGet#modified_since? (method)">modified_since?</a></span>(<span class='id identifier rubyid_modified_since'>modified_since</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="modified_since?-instance_method">
  <h3 class='signature priv'>
    #<strong>modified_since?</strong>(modified_since, headers)  &#x21d2; <code>Boolean</code>  <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Whether the last-modified response header matches the if-modified-since request header.  If so, the request has not been modified.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/conditional_get.rb#L69-L72'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='69' data-end='72'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/conditional_get.rb', line 69</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_modified_since?'>modified_since?</span>(<span class='id identifier rubyid_modified_since'>modified_since</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span>)
  <span class='id identifier rubyid_last_modified'>last_modified</span> <span class='op'>=</span> <span class='id identifier rubyid_to_rfc2822'><a href="#to_rfc2822-instance_method" title="Rack::ConditionalGet#to_rfc2822 (method)">to_rfc2822</a></span>(<span class='id identifier rubyid_headers'>headers</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>last-modified</span><span class='tstring_end'>&#39;</span></span>]) <span class='kw'>and</span>
    <span class='id identifier rubyid_modified_since'>modified_since</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_last_modified'>last_modified</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="to_rfc2822-instance_method">
  <h3 class='signature priv'>
    #<strong>to_rfc2822</strong>(since)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return a Time object for the given string (which should be in RFC2822 format), or nil if the string cannot be parsed.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/conditional_get.rb#L76-L85'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='76' data-end='85'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/conditional_get.rb', line 76</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_to_rfc2822'>to_rfc2822</span>(<span class='id identifier rubyid_since'>since</span>)
  <span class='comment'># shortest possible valid date is the obsolete: 1 Nov 97 09:55 A
</span>  <span class='comment'># anything shorter is invalid, this avoids exceptions for common cases
</span>  <span class='comment'># most common being the empty string
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_since'>since</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_since'>since</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;=</span> <span class='int'>16</span>
    <span class='comment'># NOTE: there is no trivial way to write this in a non exception way
</span>    <span class='comment'>#   _rfc2822 returns a hash but is not that usable
</span>    <span class='const'>Time</span>.<span class='id identifier rubyid_rfc2822'>rfc2822</span>(<span class='id identifier rubyid_since'>since</span>) <span class='kw'>rescue</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>