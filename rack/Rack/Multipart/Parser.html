<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Rack::Multipart::Parser &mdash; Rack main</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Rack::Multipart::Parser",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Rack main</a> &raquo; 
      <a href='../../_index.html#alpha_P'>Index (P)</a> &raquo; 
        <a href="../../Rack.html" title="Rack (module)">Rack</a> &raquo; 
        <a href="../Multipart.html" title="Rack::Multipart (module)">Multipart</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Parser&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Rack::Multipart::Parser</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a class='nodoc' href="Parser/BoundedIO.html" title="Rack::Multipart::Parser::BoundedIO (class)"><code>BoundedIO</code></a>,
        <a href="Parser/Collector.html" title="Rack::Multipart::Parser::Collector (class)"><code>Collector</code></a>,
        <a href="Parser/MultipartInfo.html" title="Rack::Multipart::Parser::MultipartInfo (class)"><code>MultipartInfo</code></a>      </div>
    </td></tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L53'>lib/rack/multipart/parser.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p><code>Parser</code> handles parsing of multipart/form-data requests.</p>

<p>File Parameter Contents</p>

<p>When processing file uploads, the parser returns a hash containing information about uploaded files. For <code>file</code> parameters, the hash includes:</p>
<ul><li>
<p><code>:filename</code> - The original filename, already URL decoded by the parser</p>
</li><li>
<p><code>:type</code> - The content type of the uploaded file</p>
</li><li>
<p><code>:name</code> - The parameter name from the form</p>
</li><li>
<p><code>:tempfile</code> - A Tempfile object containing the uploaded data</p>
</li><li>
<p><code>:head</code> - The raw header content for this part</p>
</li></ul>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='BOUNDARY_START_LIMIT-constant' class='summary_signature priv'>BOUNDARY_START_LIMIT =</span>
    <span class='note title private'>private</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L62-L62'># File 'lib/rack/multipart/parser.rb', line 62</a>    <pre class='code ruby'><span class='int'>16</span> <span class='op'>*</span> <span class='int'>1024</span></pre>
  </li>
  <li>
    <span id='BUFFERED_UPLOAD_BYTESIZE_LIMIT-constant' class='summary_signature priv'>BUFFERED_UPLOAD_BYTESIZE_LIMIT =</span>
    <span class='note title private'>private</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L80-L80'># File 'lib/rack/multipart/parser.rb', line 80</a>    <pre class='code ruby'><span class='id identifier rubyid_env_int'>env_int</span>.<span class='id identifier rubyid_call'>call</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RACK_MULTIPART_BUFFERED_UPLOAD_BYTESIZE_LIMIT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>16</span> <span class='op'>*</span> <span class='int'>1024</span> <span class='op'>*</span> <span class='int'>1024</span>)</pre>
  </li>
  <li>
    <span id='BUFSIZE-constant' class='summary_signature'>BUFSIZE =</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L54-L54'># File 'lib/rack/multipart/parser.rb', line 54</a>    <pre class='code ruby'><span class='int'>1_048_576</span></pre>
  </li>
  <li>
    <span id='CHARSET-constant' class='summary_signature'>CHARSET =</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L518-L518'># File 'lib/rack/multipart/parser.rb', line 518</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>charset</span><span class='tstring_end'>&quot;</span></span></pre>
  </li>
  <li>
    <span id='CONTENT_DISPOSITION_MAX_BYTES-constant' class='summary_signature'>CONTENT_DISPOSITION_MAX_BYTES =</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L347-L347'># File 'lib/rack/multipart/parser.rb', line 347</a>    <pre class='code ruby'><span class='int'>1536</span></pre>
  </li>
  <li>
    <span id='CONTENT_DISPOSITION_MAX_PARAMS-constant' class='summary_signature'>CONTENT_DISPOSITION_MAX_PARAMS =</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L346-L346'># File 'lib/rack/multipart/parser.rb', line 346</a>    <pre class='code ruby'><span class='int'>16</span></pre>
  </li>
  <li>
    <span id='EMPTY-constant' class='summary_signature'>EMPTY =</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L113-L113'># File 'lib/rack/multipart/parser.rb', line 113</a>    <pre class='code ruby'><span class='const'><a href="Parser/MultipartInfo.html" title="Rack::Multipart::Parser::MultipartInfo (class)">MultipartInfo</a></span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Rack::Multipart::Parser.new (method)">new</a></span>(<span class='kw'>nil</span><span class='comma'>,</span> [])</pre>
  </li>
  <li>
    <span id='MIME_HEADER_BYTESIZE_LIMIT-constant' class='summary_signature priv'>MIME_HEADER_BYTESIZE_LIMIT =</span>
    <span class='note title private'>private</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L65-L65'># File 'lib/rack/multipart/parser.rb', line 65</a>    <pre class='code ruby'><span class='int'>64</span> <span class='op'>*</span> <span class='int'>1024</span></pre>
  </li>
  <li>
    <span id='REENCODE_DUMMY_ENCODINGS-constant' class='summary_signature'>REENCODE_DUMMY_ENCODINGS =</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L560-L567'># File 'lib/rack/multipart/parser.rb', line 560</a>    <pre class='code ruby'>{
  <span class='comment'># ISO-2022-JP is a legacy but still widely used encoding in Japan
</span>  <span class='comment'># Here we convert ISO-2022-JP to UTF-8 so that it can be handled.
</span>  <span class='const'>Encoding</span><span class='op'>::</span><span class='const'>ISO_2022_JP</span> <span class='op'>=&gt;</span> <span class='kw'>true</span>

  <span class='comment'># Other dummy encodings are rarely used and have not been supported yet.
</span>  <span class='comment'># Adding support for them will require careful considerations.
</span>}</pre>
  </li>
  <li>
    <span id='TEMPFILE_FACTORY-constant' class='summary_signature'>TEMPFILE_FACTORY =</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L56-L60'># File 'lib/rack/multipart/parser.rb', line 56</a>    <pre class='code ruby'><span class='id identifier rubyid_lambda'>lambda</span> { <span class='op'>|</span><span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='op'>|</span>
  <span class='id identifier rubyid_extension'>extension</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>File</span>.<span class='id identifier rubyid_extname'>extname</span>(<span class='id identifier rubyid_filename'>filename</span>.<span class='id identifier rubyid_gsub'>gsub</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%00</span><span class='tstring_end'>&#39;</span></span>))[<span class='int'>0</span><span class='comma'>,</span> <span class='int'>129</span>]

  <span class='const'>Tempfile</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Rack::Multipart::Parser.new (method)">new</a></span>([<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RackMultipart</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_extension'>extension</span>])
}</pre>
  </li>
  <li>
    <span id='TEXT_PLAIN-constant' class='summary_signature'>TEXT_PLAIN =</span>
    <br/>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L55-L55'># File 'lib/rack/multipart/parser.rb', line 55</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/plain</span><span class='tstring_end'>&quot;</span></span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(boundary, tempfile, bufsize, query_parser)  &#x21d2; Parser </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#parse-class_method" title=".parse (class method)">.<strong>parse</strong>(io, content_length, content_type, tmpfile, bufsize, qp)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#parse_boundary-class_method" title=".parse_boundary (class method)">.<strong>parse_boundary</strong>(content_type)  </a>
    </span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature ro'>
      <a href="#state-instance_method" title="#state (instance method)">#<strong>state</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#parse-instance_method" title="#parse (instance method)">#<strong>parse</strong>(io)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#result-instance_method" title="#result (instance method)">#<strong>result</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#consume_boundary-instance_method" title="#consume_boundary (instance method)">#<strong>consume_boundary</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Scan until the we find the start or end of the boundary.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#find_encoding-instance_method" title="#find_encoding (instance method)">#<strong>find_encoding</strong>(enc)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Return the related Encoding object.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#handle_consume_token-instance_method" title="#handle_consume_token (instance method)">#<strong>handle_consume_token</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#handle_dummy_encoding-instance_method" title="#handle_dummy_encoding (instance method)">#<strong>handle_dummy_encoding</strong>(name, body)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#handle_empty_content!-instance_method" title="#handle_empty_content! (instance method)">#<strong>handle_empty_content!</strong>(content)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#handle_fast_forward-instance_method" title="#handle_fast_forward (instance method)">#<strong>handle_fast_forward</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>This handles the initial parser state.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#handle_mime_body-instance_method" title="#handle_mime_body (instance method)">#<strong>handle_mime_body</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#handle_mime_head-instance_method" title="#handle_mime_head (instance method)">#<strong>handle_mime_head</strong>  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#normalize_filename-instance_method" title="#normalize_filename (instance method)">#<strong>normalize_filename</strong>(filename)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#read_data-instance_method" title="#read_data (instance method)">#<strong>read_data</strong>(io, outbuf)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#tag_multipart_encoding-instance_method" title="#tag_multipart_encoding (instance method)">#<strong>tag_multipart_encoding</strong>(filename, content_type, name, body)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#update_retained_size-instance_method" title="#update_retained_size (instance method)">#<strong>update_retained_size</strong>(size)  </a>
    </span>
    <span class='note title private'>private</span>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(boundary, tempfile, bufsize, query_parser)  &#x21d2; <code>Parser</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L241-L258'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='241' data-end='258'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 241</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_boundary'>boundary</span><span class='comma'>,</span> <span class='id identifier rubyid_tempfile'>tempfile</span><span class='comma'>,</span> <span class='id identifier rubyid_bufsize'>bufsize</span><span class='comma'>,</span> <span class='id identifier rubyid_query_parser'>query_parser</span>)
  <span class='ivar'>@query_parser</span>   <span class='op'>=</span> <span class='id identifier rubyid_query_parser'>query_parser</span>
  <span class='ivar'>@params</span>         <span class='op'>=</span> <span class='id identifier rubyid_query_parser'>query_parser</span>.<span class='id identifier rubyid_make_params'>make_params</span>
  <span class='ivar'>@bufsize</span>        <span class='op'>=</span> <span class='id identifier rubyid_bufsize'>bufsize</span>

  <span class='ivar'>@state</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='const'>FAST_FORWARD</span>
  <span class='ivar'>@mime_index</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@body_retained</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@retained_size</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@collector</span> <span class='op'>=</span> <span class='const'><a href="Parser/Collector.html" title="Rack::Multipart::Parser::Collector (class)">Collector</a></span>.<span class='id identifier rubyid_new'><a href="Parser/Collector.html#new-class_method" title="Rack::Multipart::Parser::Collector.new (method)">new</a></span> <span class='id identifier rubyid_tempfile'>tempfile</span>

  <span class='ivar'>@sbuf</span> <span class='op'>=</span> <span class='const'>StringScanner</span>.<span class='id identifier rubyid_new'>new</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>.<span class='id identifier rubyid_dup'>dup</span>)
  <span class='ivar'>@body_regex</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(?:</span><span class='embexpr_beg'>#{</span><span class='const'><a href="../Multipart.html#EOL-constant" title="Rack::Multipart::EOL (constant)">EOL</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>|\A)--</span><span class='embexpr_beg'>#{</span><span class='const'>Regexp</span>.<span class='id identifier rubyid_quote'>quote</span>(<span class='id identifier rubyid_boundary'>boundary</span>)<span class='embexpr_end'>}</span><span class='tstring_content'>(?:</span><span class='embexpr_beg'>#{</span><span class='const'><a href="../Multipart.html#EOL-constant" title="Rack::Multipart::EOL (constant)">EOL</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>|--)</span><span class='regexp_end'>/m</span></span>
  <span class='ivar'>@body_regex_at_end</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='embexpr_beg'>#{</span><span class='ivar'>@body_regex</span><span class='embexpr_end'>}</span><span class='tstring_content'>\z</span><span class='regexp_end'>/m</span></span>
  <span class='ivar'>@end_boundary_size</span> <span class='op'>=</span> <span class='id identifier rubyid_boundary'>boundary</span>.<span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>+</span> <span class='int'>4</span> <span class='comment'># (-- at start, -- at finish)
</span>  <span class='ivar'>@rx_max_size</span> <span class='op'>=</span> <span class='id identifier rubyid_boundary'>boundary</span>.<span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>+</span> <span class='int'>6</span> <span class='comment'># (\r\n-- at start, either \r\n or -- at finish)
</span>  <span class='ivar'>@head_regex</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(.*?</span><span class='embexpr_beg'>#{</span><span class='const'><a href="../Multipart.html#EOL-constant" title="Rack::Multipart::EOL (constant)">EOL</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='embexpr_beg'>#{</span><span class='const'><a href="../Multipart.html#EOL-constant" title="Rack::Multipart::EOL (constant)">EOL</a></span><span class='embexpr_end'>}</span><span class='regexp_end'>/m</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Class Method Details</h2>
<section class='method_details first' id="parse-class_method">
  <h3 class='signature  first'>
    .<strong>parse</strong>(io, content_length, content_type, tmpfile, bufsize, qp)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L122-L140'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='122' data-end='140'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 122</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='id identifier rubyid_content_length'>content_length</span><span class='comma'>,</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='comma'>,</span> <span class='id identifier rubyid_tmpfile'>tmpfile</span><span class='comma'>,</span> <span class='id identifier rubyid_bufsize'>bufsize</span><span class='comma'>,</span> <span class='id identifier rubyid_qp'>qp</span>)
  <span class='kw'>return</span> <span class='const'><a href="#EMPTY-constant" title="Rack::Multipart::Parser::EMPTY (constant)">EMPTY</a></span> <span class='kw'>if</span> <span class='int'>0</span> <span class='op'>==</span> <span class='id identifier rubyid_content_length'>content_length</span>

  <span class='id identifier rubyid_boundary'>boundary</span> <span class='op'>=</span> <span class='id identifier rubyid_parse_boundary'><a href="#parse_boundary-class_method" title="Rack::Multipart::Parser.parse_boundary (method)">parse_boundary</a></span> <span class='id identifier rubyid_content_type'>content_type</span>
  <span class='kw'>return</span> <span class='const'><a href="#EMPTY-constant" title="Rack::Multipart::Parser::EMPTY (constant)">EMPTY</a></span> <span class='kw'>unless</span> <span class='id identifier rubyid_boundary'>boundary</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_boundary'>boundary</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>70</span>
    <span class='comment'># RFC 1521 Section 7.2.1 imposes a 70 character maximum for the boundary.
</span>    <span class='comment'># Most clients use no more than 55 characters.
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="BoundaryTooLongError.html" title="Rack::Multipart::BoundaryTooLongError (class)">BoundaryTooLongError</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>multipart boundary size too large (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_boundary'>boundary</span>.<span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> characters)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_io'>io</span> <span class='op'>=</span> <span class='const'><a href="Parser/BoundedIO.html" title="Rack::Multipart::Parser::BoundedIO (class)">BoundedIO</a></span>.<span class='id identifier rubyid_new'><a href="Parser/BoundedIO.html#new-class_method" title="Rack::Multipart::Parser::BoundedIO.new (method)">new</a></span>(<span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='id identifier rubyid_content_length'>content_length</span>) <span class='kw'>if</span> <span class='id identifier rubyid_content_length'>content_length</span>

  <span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='id identifier rubyid_new'><a href="#new-class_method" title="Rack::Multipart::Parser.new (method)">new</a></span>(<span class='id identifier rubyid_boundary'>boundary</span><span class='comma'>,</span> <span class='id identifier rubyid_tmpfile'>tmpfile</span><span class='comma'>,</span> <span class='id identifier rubyid_bufsize'>bufsize</span><span class='comma'>,</span> <span class='id identifier rubyid_qp'>qp</span>)
  <span class='id identifier rubyid_parser'>parser</span>.<span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_io'>io</span>)

  <span class='id identifier rubyid_parser'>parser</span>.<span class='id identifier rubyid_result'><a href="#result-instance_method" title="Rack::Multipart::Parser#result (method)">result</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="parse_boundary-class_method">
  <h3 class='signature '>
    .<strong>parse_boundary</strong>(content_type)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L115-L120'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='115' data-end='120'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 115</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_parse_boundary'>parse_boundary</span>(<span class='id identifier rubyid_content_type'>content_type</span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_content_type'>content_type</span>
  <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>.<span class='id identifier rubyid_match'>match</span>(<span class='const'><a href="../Multipart.html#MULTIPART-constant" title="Rack::Multipart::MULTIPART (constant)">MULTIPART</a></span>)
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_data'>data</span>
  <span class='id identifier rubyid_data'>data</span>[<span class='int'>1</span>]
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="state-instance_method">
  <h3 class='signature ro first'>
    #<strong>state</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L239-L239'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='239' data-end='239'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 239</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_state'>state</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="consume_boundary-instance_method">
  <h3 class='signature priv first'>
    #<strong>consume_boundary</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Scan until the we find the start or end of the boundary. If we find it, return the appropriate symbol for the start or end of the boundary.  If we don’t find the start or end of the boundary, clear the buffer and return nil.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L499-L506'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='499' data-end='506'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 499</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_consume_boundary'>consume_boundary</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_read_buffer'>read_buffer</span> <span class='op'>=</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_scan_until'>scan_until</span>(<span class='ivar'>@body_regex</span>)
    <span class='id identifier rubyid_read_buffer'>read_buffer</span>.<span class='id identifier rubyid_end_with?'>end_with?</span>(<span class='const'><a href="../Multipart.html#EOL-constant" title="Rack::Multipart::EOL (constant)">EOL</a></span>) <span class='op'>?</span> <span class='symbeg'>:</span><span class='const'>BOUNDARY</span> <span class='op'>:</span> <span class='symbeg'>:</span><span class='const'>END_BOUNDARY</span>
  <span class='kw'>else</span>
    <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_terminate'>terminate</span>
    <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="find_encoding-instance_method">
  <h3 class='signature priv'>
    #<strong>find_encoding</strong>(enc)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Return the related Encoding object. However, because enc is submitted by the user, it may be invalid, so use a binary encoding in that case.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L554-L558'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='554' data-end='558'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 554</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_find_encoding'>find_encoding</span>(<span class='id identifier rubyid_enc'>enc</span>)
  <span class='const'>Encoding</span>.<span class='id identifier rubyid_find'>find</span> <span class='id identifier rubyid_enc'>enc</span>
<span class='kw'>rescue</span> <span class='const'>ArgumentError</span>
  <span class='const'>Encoding</span><span class='op'>::</span><span class='const'>BINARY</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handle_consume_token-instance_method">
  <h3 class='signature priv'>
    #<strong>handle_consume_token</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L336-L344'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='336' data-end='344'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 336</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_consume_token'>handle_consume_token</span>
  <span class='id identifier rubyid_tok'>tok</span> <span class='op'>=</span> <span class='id identifier rubyid_consume_boundary'><a href="#consume_boundary-instance_method" title="Rack::Multipart::Parser#consume_boundary (method)">consume_boundary</a></span>
  <span class='comment'># break if we&#39;re at the end of a buffer, but not if it is the end of a field
</span>  <span class='ivar'>@state</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_tok'>tok</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='const'>END_BOUNDARY</span> <span class='op'>||</span> (<span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_eos?'>eos?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_tok'>tok</span> <span class='op'>!=</span> <span class='symbeg'>:</span><span class='const'>BOUNDARY</span>)
    <span class='symbeg'>:</span><span class='const'>DONE</span>
  <span class='kw'>else</span>
    <span class='symbeg'>:</span><span class='const'>MIME_HEAD</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handle_dummy_encoding-instance_method">
  <h3 class='signature priv'>
    #<strong>handle_dummy_encoding</strong>(name, body)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L569-L577'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='569' data-end='577'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 569</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_dummy_encoding'>handle_dummy_encoding</span>(<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
  <span class='comment'># A string object with a &#39;dummy&#39; encoding does not have full functionality and can cause errors.
</span>  <span class='comment'># So here we covert it to UTF-8 so that it can be handled properly.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_encoding'>encoding</span>.<span class='id identifier rubyid_dummy?'>dummy?</span> <span class='op'>&amp;&amp;</span> <span class='const'><a href="#REENCODE_DUMMY_ENCODINGS-constant" title="Rack::Multipart::Parser::REENCODE_DUMMY_ENCODINGS (constant)">REENCODE_DUMMY_ENCODINGS</a></span>[<span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_encoding'>encoding</span>]
    <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_encode'>encode</span>(<span class='const'>Encoding</span><span class='op'>::</span><span class='const'>UTF_8</span>)
    <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_encode'>encode</span>(<span class='const'>Encoding</span><span class='op'>::</span><span class='const'>UTF_8</span>)
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handle_empty_content!-instance_method">
  <h3 class='signature priv'>
    #<strong>handle_empty_content!</strong>(content)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L579-L583'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='579' data-end='583'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 579</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_empty_content!'>handle_empty_content!</span>(<span class='id identifier rubyid_content'>content</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_content'>content</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_content'>content</span>.<span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="EmptyContentError.html" title="Rack::Multipart::EmptyContentError (class)">EmptyContentError</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handle_fast_forward-instance_method">
  <h3 class='signature priv'>
    #<strong>handle_fast_forward</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>This handles the initial parser state.  We read until we find the starting boundary, then we can transition to the next state. If we find the ending boundary, this is an invalid multipart upload, but keep scanning for opening boundary in that case. If no boundary found, we need to keep reading data and retry. It’s highly unlikely the initial read will not consume the boundary.  The client would have to deliberately craft a response with the opening boundary beyond the buffer size for that to happen.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L309-L334'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='309' data-end='334'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 309</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_fast_forward'>handle_fast_forward</span>
  <span class='kw'>while</span> <span class='kw'>true</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_consume_boundary'><a href="#consume_boundary-instance_method" title="Rack::Multipart::Parser#consume_boundary (method)">consume_boundary</a></span>
    <span class='kw'>when</span> <span class='symbeg'>:</span><span class='const'>BOUNDARY</span>
      <span class='comment'># found opening boundary, transition to next state
</span>      <span class='ivar'>@state</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='const'>MIME_HEAD</span>
      <span class='kw'>return</span>
    <span class='kw'>when</span> <span class='symbeg'>:</span><span class='const'>END_BOUNDARY</span>
      <span class='comment'># invalid multipart upload
</span>      <span class='kw'>if</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_pos'>pos</span> <span class='op'>==</span> <span class='ivar'>@end_boundary_size</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_rest'>rest</span> <span class='op'>==</span> <span class='const'><a href="../Multipart.html#EOL-constant" title="Rack::Multipart::EOL (constant)">EOL</a></span>
        <span class='comment'># stop parsing a buffer if a buffer is only an end boundary.
</span>        <span class='ivar'>@state</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='const'>DONE</span>
        <span class='kw'>return</span>
      <span class='kw'>end</span>

      <span class='comment'># retry for opening boundary
</span>    <span class='kw'>else</span>
      <span class='comment'># We raise if we don&#39;t find the multipart boundary, to avoid unbounded memory
</span>      <span class='comment'># buffering. Note that the actual limit is the higher of 16KB and the buffer size (1MB by default)
</span>      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Multipart.html#Error-constant" title="Rack::Multipart::Error (constant)">Error</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>multipart boundary not found within limit</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_string'>string</span>.<span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>&gt;</span> <span class='const'><a href="#BOUNDARY_START_LIMIT-constant" title="Rack::Multipart::Parser::BOUNDARY_START_LIMIT (constant)">BOUNDARY_START_LIMIT</a></span>

      <span class='comment'># no boundary found, keep reading data
</span>      <span class='kw'>return</span> <span class='symbeg'>:</span><span class='id identifier rubyid_want_read'>want_read</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handle_mime_body-instance_method">
  <h3 class='signature priv'>
    #<strong>handle_mime_body</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L466-L486'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='466' data-end='486'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 466</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_mime_body'>handle_mime_body</span>
  <span class='kw'>if</span> (<span class='id identifier rubyid_body_with_boundary'>body_with_boundary</span> <span class='op'>=</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_check_until'>check_until</span>(<span class='ivar'>@body_regex</span>)) <span class='comment'># check but do not advance the pointer yet
</span>    <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_body_with_boundary'>body_with_boundary</span>.<span class='id identifier rubyid_sub'>sub</span>(<span class='ivar'>@body_regex_at_end</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>) <span class='comment'># remove the boundary from the string
</span>    <span class='id identifier rubyid_update_retained_size'><a href="#update_retained_size-instance_method" title="Rack::Multipart::Parser#update_retained_size (method)">update_retained_size</a></span>(<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_bytesize'>bytesize</span>) <span class='kw'>if</span> <span class='ivar'>@body_retained</span>
    <span class='ivar'>@collector</span>.<span class='id identifier rubyid_on_mime_body'>on_mime_body</span> <span class='ivar'>@mime_index</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_pos'>pos</span> <span class='op'>+=</span> <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='int'>2</span> <span class='comment'># skip \r\n after the content
</span>    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='const'>CONSUME_TOKEN</span>
    <span class='ivar'>@mime_index</span> <span class='op'>+=</span> <span class='int'>1</span>
  <span class='kw'>else</span>
    <span class='comment'># Save what we have so far
</span>    <span class='kw'>if</span> <span class='ivar'>@rx_max_size</span> <span class='op'>&lt;</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_rest_size'>rest_size</span>
      <span class='id identifier rubyid_delta'>delta</span> <span class='op'>=</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_rest_size'>rest_size</span> <span class='op'>-</span> <span class='ivar'>@rx_max_size</span>
      <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_peek'>peek</span>(<span class='id identifier rubyid_delta'>delta</span>)
      <span class='id identifier rubyid_update_retained_size'><a href="#update_retained_size-instance_method" title="Rack::Multipart::Parser#update_retained_size (method)">update_retained_size</a></span>(<span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_bytesize'>bytesize</span>) <span class='kw'>if</span> <span class='ivar'>@body_retained</span>
      <span class='ivar'>@collector</span>.<span class='id identifier rubyid_on_mime_body'>on_mime_body</span> <span class='ivar'>@mime_index</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>
      <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_pos'>pos</span> <span class='op'>+=</span> <span class='id identifier rubyid_delta'>delta</span>
      <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_string'>string</span> <span class='op'>=</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_rest'>rest</span>
    <span class='kw'>end</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_want_read'>want_read</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="handle_mime_head-instance_method">
  <h3 class='signature priv'>
    #<strong>handle_mime_head</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L348-L464'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='348' data-end='464'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 348</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_mime_head'>handle_mime_head</span>
  <span class='kw'>if</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_scan_until'>scan_until</span>(<span class='ivar'>@head_regex</span>)
    <span class='id identifier rubyid_head'>head</span> <span class='op'>=</span> <span class='ivar'>@sbuf</span>[<span class='int'>1</span>]
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_head'>head</span>[<span class='const'><a href="../Multipart.html#MULTIPART_CONTENT_TYPE-constant" title="Rack::Multipart::MULTIPART_CONTENT_TYPE (constant)">MULTIPART_CONTENT_TYPE</a></span><span class='comma'>,</span> <span class='int'>1</span>]
    <span class='kw'>if</span> (<span class='id identifier rubyid_disposition'>disposition</span> <span class='op'>=</span> <span class='id identifier rubyid_head'>head</span>[<span class='const'><a href="../Multipart.html#MULTIPART_CONTENT_DISPOSITION-constant" title="Rack::Multipart::MULTIPART_CONTENT_DISPOSITION (constant)">MULTIPART_CONTENT_DISPOSITION</a></span><span class='comma'>,</span> <span class='int'>1</span>]) <span class='op'>&amp;&amp;</span>
        <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>&lt;=</span> <span class='const'><a href="#CONTENT_DISPOSITION_MAX_BYTES-constant" title="Rack::Multipart::Parser::CONTENT_DISPOSITION_MAX_BYTES (constant)">CONTENT_DISPOSITION_MAX_BYTES</a></span>

      <span class='comment'># ignore actual content-disposition value (should always be form-data)
</span>      <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_index'>index</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span>)
      <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_slice!'>slice!</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>+</span><span class='int'>1</span>)
      <span class='id identifier rubyid_param'>param</span> <span class='op'>=</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_num_params'>num_params</span> <span class='op'>=</span> <span class='int'>0</span>

      <span class='comment'># Parse parameter list
</span>      <span class='kw'>while</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_index'>index</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>=</span><span class='tstring_end'>&#39;</span></span>)
        <span class='comment'># Only parse up to max parameters, to avoid potential denial of service
</span>        <span class='id identifier rubyid_num_params'>num_params</span> <span class='op'>+=</span> <span class='int'>1</span>
        <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_num_params'>num_params</span> <span class='op'>&gt;</span> <span class='const'><a href="#CONTENT_DISPOSITION_MAX_PARAMS-constant" title="Rack::Multipart::Parser::CONTENT_DISPOSITION_MAX_PARAMS (constant)">CONTENT_DISPOSITION_MAX_PARAMS</a></span>

        <span class='comment'># Found end of parameter name, ensure forward progress in loop
</span>        <span class='id identifier rubyid_param'>param</span> <span class='op'>=</span> <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_slice!'>slice!</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>+</span><span class='int'>1</span>)

        <span class='comment'># Remove ending equals and preceding whitespace from parameter name
</span>        <span class='id identifier rubyid_param'>param</span>.<span class='id identifier rubyid_chomp!'>chomp!</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>=</span><span class='tstring_end'>&#39;</span></span>)
        <span class='id identifier rubyid_param'>param</span>.<span class='id identifier rubyid_lstrip!'>lstrip!</span>

        <span class='kw'>if</span> <span class='id identifier rubyid_disposition'>disposition</span>[<span class='int'>0</span>] <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>
          <span class='comment'># Parameter value is quoted, parse it, handling backslash escapes
</span>          <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_slice!'>slice!</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='int'>1</span>)
          <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='const'>String</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Rack::Multipart::Parser.new (method)">new</a></span>

          <span class='kw'>while</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_index'>index</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>([&quot;\\])</span><span class='regexp_end'>/</span></span>)
            <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='backref'>$1</span>

            <span class='comment'># Append all content until ending quote or escape
</span>            <span class='id identifier rubyid_value'>value</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_slice!'>slice!</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span>)

            <span class='comment'># Remove either backslash or ending quote,
</span>            <span class='comment'># ensures forward progress in loop
</span>            <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_slice!'>slice!</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='int'>1</span>)

            <span class='comment'># stop parsing parameter value if found ending quote
</span>            <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>

            <span class='id identifier rubyid_escaped_char'>escaped_char</span> <span class='op'>=</span> <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_slice!'>slice!</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='int'>1</span>)
            <span class='kw'>if</span> <span class='id identifier rubyid_param'>param</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>filename</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_escaped_char'>escaped_char</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>
              <span class='comment'># Possible IE uploaded filename, append both escape backslash and value
</span>              <span class='id identifier rubyid_value'>value</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_c'>c</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_escaped_char'>escaped_char</span>
            <span class='kw'>else</span>
              <span class='comment'># Other only append escaped value
</span>              <span class='id identifier rubyid_value'>value</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_escaped_char'>escaped_char</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
        <span class='kw'>else</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_index'>index</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span>)
            <span class='comment'># Parameter value unquoted (which may be invalid), value ends at semicolon
</span>            <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_slice!'>slice!</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span>)
          <span class='kw'>else</span>
            <span class='comment'># If no ending semicolon, assume remainder of line is value and stop
</span>            <span class='comment'># parsing
</span>            <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_strip!'>strip!</span>
            <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_disposition'>disposition</span>
            <span class='id identifier rubyid_disposition'>disposition</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>

        <span class='kw'>case</span> <span class='id identifier rubyid_param'>param</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span>
          <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>filename</span><span class='tstring_end'>&#39;</span></span>
          <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>filename*</span><span class='tstring_end'>&#39;</span></span>
          <span class='id identifier rubyid_filename_star'>filename_star</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
        <span class='comment'># else
</span>        <span class='comment'># ignore other parameters
</span>        <span class='kw'>end</span>

        <span class='comment'># skip trailing semicolon, to proceed to next parameter
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_index'>index</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span>)
          <span class='id identifier rubyid_disposition'>disposition</span>.<span class='id identifier rubyid_slice!'>slice!</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>+</span><span class='int'>1</span>)
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_head'>head</span>[<span class='const'><a href="../Multipart.html#MULTIPART_CONTENT_ID-constant" title="Rack::Multipart::MULTIPART_CONTENT_ID (constant)">MULTIPART_CONTENT_ID</a></span><span class='comma'>,</span> <span class='int'>1</span>]
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_filename_star'>filename_star</span>
      <span class='id identifier rubyid_encoding'>encoding</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='id identifier rubyid_filename_star'>filename_star</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>3</span>)
      <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='id identifier rubyid_normalize_filename'><a href="#normalize_filename-instance_method" title="Rack::Multipart::Parser#normalize_filename (method)">normalize_filename</a></span>(<span class='id identifier rubyid_filename'>filename</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>)
      <span class='id identifier rubyid_filename'>filename</span>.<span class='id identifier rubyid_force_encoding'>force_encoding</span>(<span class='id identifier rubyid_find_encoding'><a href="#find_encoding-instance_method" title="Rack::Multipart::Parser#find_encoding (method)">find_encoding</a></span>(<span class='id identifier rubyid_encoding'>encoding</span>))
    <span class='kw'>elsif</span> <span class='id identifier rubyid_filename'>filename</span>
      <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='id identifier rubyid_normalize_filename'><a href="#normalize_filename-instance_method" title="Rack::Multipart::Parser#normalize_filename (method)">normalize_filename</a></span>(<span class='id identifier rubyid_filename'>filename</span>)
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_filename'>filename</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>||</span> <span class='const'><a href="#TEXT_PLAIN-constant" title="Rack::Multipart::Parser::TEXT_PLAIN (constant)">TEXT_PLAIN</a></span><span class='embexpr_end'>}</span><span class='tstring_content'>[]</span><span class='tstring_end'>&quot;</span></span>.<span class='id identifier rubyid_dup'>dup</span>
    <span class='kw'>end</span>

    <span class='comment'># Mime part head data is retained for both TempfilePart and BufferPart
</span>    <span class='comment'># for the entireity of the parse, even though it isn&#39;t used for BufferPart.
</span>    <span class='id identifier rubyid_update_retained_size'><a href="#update_retained_size-instance_method" title="Rack::Multipart::Parser#update_retained_size (method)">update_retained_size</a></span>(<span class='id identifier rubyid_head'>head</span>.<span class='id identifier rubyid_bytesize'>bytesize</span>)

    <span class='comment'># If a filename is given, a TempfilePart will be used, so the body will
</span>    <span class='comment'># not be buffered in memory. However, if a filename is not given, a BufferPart
</span>    <span class='comment'># will be used, and the body will be buffered in memory.
</span>    <span class='ivar'>@body_retained</span> <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_filename'>filename</span>

    <span class='ivar'>@collector</span>.<span class='id identifier rubyid_on_mime_head'>on_mime_head</span> <span class='ivar'>@mime_index</span><span class='comma'>,</span> <span class='id identifier rubyid_head'>head</span><span class='comma'>,</span> <span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='symbeg'>:</span><span class='const'>MIME_BODY</span>
  <span class='kw'>else</span>
    <span class='comment'># We raise if the mime part header is too large, to avoid unbounded memory
</span>    <span class='comment'># buffering. Note that the actual limit is the higher of 64KB and the buffer size (1MB by default)
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Multipart.html#Error-constant" title="Rack::Multipart::Error (constant)">Error</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>multipart mime part header too large</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_string'>string</span>.<span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>&gt;</span> <span class='const'><a href="#MIME_HEADER_BYTESIZE_LIMIT-constant" title="Rack::Multipart::Parser::MIME_HEADER_BYTESIZE_LIMIT (constant)">MIME_HEADER_BYTESIZE_LIMIT</a></span>

    <span class='kw'>return</span> <span class='symbeg'>:</span><span class='id identifier rubyid_want_read'>want_read</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="normalize_filename-instance_method">
  <h3 class='signature priv'>
    #<strong>normalize_filename</strong>(filename)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L508-L516'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='508' data-end='516'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 508</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_normalize_filename'>normalize_filename</span>(<span class='id identifier rubyid_filename'>filename</span>)
  <span class='kw'>if</span> <span class='id identifier rubyid_filename'>filename</span>.<span class='id identifier rubyid_scan'>scan</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>%.?.?</span><span class='regexp_end'>/</span></span>).<span class='id identifier rubyid_all?'>all?</span> { <span class='op'>|</span><span class='id identifier rubyid_s'>s</span><span class='op'>|</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>%[0-9a-fA-F]{2}</span><span class='regexp_end'>/</span></span>.<span class='id identifier rubyid_match?'>match?</span>(<span class='id identifier rubyid_s'>s</span>) }
    <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='const'><a href="../Utils.html" title="Rack::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_unescape_path'><a href="../Utils.html#unescape_path-class_method" title="Rack::Utils.unescape_path (method)">unescape_path</a></span>(<span class='id identifier rubyid_filename'>filename</span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_filename'>filename</span>.<span class='id identifier rubyid_scrub!'>scrub!</span>

  <span class='id identifier rubyid_filename'>filename</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[\/\\]</span><span class='regexp_end'>/</span></span>).<span class='id identifier rubyid_last'>last</span> <span class='op'>||</span> <span class='const'>String</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Rack::Multipart::Parser.new (method)">new</a></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="parse-instance_method">
  <h3 class='signature '>
    #<strong>parse</strong>(io)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L260-L281'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='260' data-end='281'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 260</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_parse'>parse</span>(<span class='id identifier rubyid_io'>io</span>)
  <span class='id identifier rubyid_outbuf'>outbuf</span> <span class='op'>=</span> <span class='const'>String</span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Rack::Multipart::Parser.new (method)">new</a></span>
  <span class='id identifier rubyid_read_data'><a href="#read_data-instance_method" title="Rack::Multipart::Parser#read_data (method)">read_data</a></span>(<span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='id identifier rubyid_outbuf'>outbuf</span>)

  <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span>
      <span class='kw'>case</span> <span class='ivar'>@state</span>
      <span class='kw'>when</span> <span class='symbeg'>:</span><span class='const'>FAST_FORWARD</span>
        <span class='id identifier rubyid_handle_fast_forward'><a href="#handle_fast_forward-instance_method" title="Rack::Multipart::Parser#handle_fast_forward (method)">handle_fast_forward</a></span>
      <span class='kw'>when</span> <span class='symbeg'>:</span><span class='const'>CONSUME_TOKEN</span>
        <span class='id identifier rubyid_handle_consume_token'><a href="#handle_consume_token-instance_method" title="Rack::Multipart::Parser#handle_consume_token (method)">handle_consume_token</a></span>
      <span class='kw'>when</span> <span class='symbeg'>:</span><span class='const'>MIME_HEAD</span>
        <span class='id identifier rubyid_handle_mime_head'><a href="#handle_mime_head-instance_method" title="Rack::Multipart::Parser#handle_mime_head (method)">handle_mime_head</a></span>
      <span class='kw'>when</span> <span class='symbeg'>:</span><span class='const'>MIME_BODY</span>
        <span class='id identifier rubyid_handle_mime_body'><a href="#handle_mime_body-instance_method" title="Rack::Multipart::Parser#handle_mime_body (method)">handle_mime_body</a></span>
      <span class='kw'>else</span> <span class='comment'># when :DONE
</span>        <span class='kw'>return</span>
      <span class='kw'>end</span>

    <span class='id identifier rubyid_read_data'><a href="#read_data-instance_method" title="Rack::Multipart::Parser#read_data (method)">read_data</a></span>(<span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='id identifier rubyid_outbuf'>outbuf</span>) <span class='kw'>if</span> <span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid_want_read'>want_read</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="read_data-instance_method">
  <h3 class='signature priv'>
    #<strong>read_data</strong>(io, outbuf)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L296-L300'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='296' data-end='300'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 296</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_read_data'>read_data</span>(<span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='id identifier rubyid_outbuf'>outbuf</span>)
  <span class='id identifier rubyid_content'>content</span> <span class='op'>=</span> <span class='id identifier rubyid_io'>io</span>.<span class='id identifier rubyid_read'>read</span>(<span class='ivar'>@bufsize</span><span class='comma'>,</span> <span class='id identifier rubyid_outbuf'>outbuf</span>)
  <span class='id identifier rubyid_handle_empty_content!'><a href="#handle_empty_content!-instance_method" title="Rack::Multipart::Parser#handle_empty_content! (method)">handle_empty_content!</a></span>(<span class='id identifier rubyid_content'>content</span>)
  <span class='ivar'>@sbuf</span>.<span class='id identifier rubyid_concat'>concat</span>(<span class='id identifier rubyid_content'>content</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="result-instance_method">
  <h3 class='signature '>
    #<strong>result</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L283-L292'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='283' data-end='292'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 283</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_result'>result</span>
  <span class='ivar'>@collector</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_part'>part</span><span class='op'>|</span>
    <span class='id identifier rubyid_part'>part</span>.<span class='id identifier rubyid_get_data'>get_data</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_data'>data</span><span class='op'>|</span>
      <span class='id identifier rubyid_tag_multipart_encoding'><a href="#tag_multipart_encoding-instance_method" title="Rack::Multipart::Parser#tag_multipart_encoding (method)">tag_multipart_encoding</a></span>(<span class='id identifier rubyid_part'>part</span>.<span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_part'>part</span>.<span class='id identifier rubyid_content_type'>content_type</span><span class='comma'>,</span> <span class='id identifier rubyid_part'>part</span>.<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_data'>data</span>)
      <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_handle_dummy_encoding'><a href="#handle_dummy_encoding-instance_method" title="Rack::Multipart::Parser#handle_dummy_encoding (method)">handle_dummy_encoding</a></span>(<span class='id identifier rubyid_part'>part</span>.<span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_data'>data</span>)
      <span class='ivar'>@query_parser</span>.<span class='id identifier rubyid_normalize_params'>normalize_params</span>(<span class='ivar'>@params</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_data'>data</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='const'><a href="Parser/MultipartInfo.html" title="Rack::Multipart::Parser::MultipartInfo (class)">MultipartInfo</a></span>.<span class='id identifier rubyid_new'><a href="#new-class_method" title="Rack::Multipart::Parser.new (method)">new</a></span> <span class='ivar'>@params</span>.<span class='id identifier rubyid_to_params_hash'>to_params_hash</span><span class='comma'>,</span> <span class='ivar'>@collector</span>.<span class='id identifier rubyid_find_all'>find_all</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_file?'>file?</span>).<span class='id identifier rubyid_map'>map</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_body'>body</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="tag_multipart_encoding-instance_method">
  <h3 class='signature priv'>
    #<strong>tag_multipart_encoding</strong>(filename, content_type, name, body)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L521-L549'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='521' data-end='549'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 521</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_tag_multipart_encoding'>tag_multipart_encoding</span>(<span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span>)
  <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_to_s'>to_s</span>
  <span class='id identifier rubyid_encoding'>encoding</span> <span class='op'>=</span> <span class='const'>Encoding</span><span class='op'>::</span><span class='const'>UTF_8</span>

  <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_force_encoding'>force_encoding</span>(<span class='id identifier rubyid_encoding'>encoding</span>)

  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_filename'>filename</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='id identifier rubyid_list'>list</span>         <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span>)
    <span class='id identifier rubyid_type_subtype'>type_subtype</span> <span class='op'>=</span> <span class='id identifier rubyid_list'>list</span>.<span class='id identifier rubyid_first'>first</span>
    <span class='id identifier rubyid_type_subtype'>type_subtype</span>.<span class='id identifier rubyid_strip!'>strip!</span>
    <span class='kw'>if</span> <span class='const'><a href="#TEXT_PLAIN-constant" title="Rack::Multipart::Parser::TEXT_PLAIN (constant)">TEXT_PLAIN</a></span> <span class='op'>==</span> <span class='id identifier rubyid_type_subtype'>type_subtype</span>
      <span class='id identifier rubyid_rest'>rest</span> <span class='op'>=</span> <span class='id identifier rubyid_list'>list</span>.<span class='id identifier rubyid_drop'>drop</span> <span class='int'>1</span>
      <span class='id identifier rubyid_rest'>rest</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_param'>param</span><span class='op'>|</span>
        <span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span> <span class='op'>=</span> <span class='id identifier rubyid_param'>param</span>.<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>=</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span>)
        <span class='id identifier rubyid_k'>k</span>.<span class='id identifier rubyid_strip!'>strip!</span>
        <span class='id identifier rubyid_v'>v</span>.<span class='id identifier rubyid_strip!'>strip!</span>
        <span class='id identifier rubyid_v'>v</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span>[<span class='int'>1</span><span class='op'>..</span><span class='op'>-</span><span class='int'>2</span>] <span class='kw'>if</span> <span class='id identifier rubyid_v'>v</span>.<span class='id identifier rubyid_start_with?'>start_with?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>) <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_v'>v</span>.<span class='id identifier rubyid_end_with?'>end_with?</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>)
        <span class='kw'>if</span> <span class='id identifier rubyid_k'>k</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>charset</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_encoding'>encoding</span> <span class='op'>=</span> <span class='id identifier rubyid_find_encoding'><a href="#find_encoding-instance_method" title="Rack::Multipart::Parser#find_encoding (method)">find_encoding</a></span>(<span class='id identifier rubyid_v'>v</span>)
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_name'>name</span>.<span class='id identifier rubyid_force_encoding'>force_encoding</span>(<span class='id identifier rubyid_encoding'>encoding</span>)
  <span class='id identifier rubyid_body'>body</span>.<span class='id identifier rubyid_force_encoding'>force_encoding</span>(<span class='id identifier rubyid_encoding'>encoding</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="update_retained_size-instance_method">
  <h3 class='signature priv'>
    #<strong>update_retained_size</strong>(size)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/multipart/parser.rb#L488-L493'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='488' data-end='493'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/multipart/parser.rb', line 488</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_update_retained_size'>update_retained_size</span>(<span class='id identifier rubyid_size'>size</span>)
  <span class='ivar'>@retained_size</span> <span class='op'>+=</span> <span class='id identifier rubyid_size'>size</span>
  <span class='kw'>if</span> <span class='ivar'>@retained_size</span> <span class='op'>&gt;</span> <span class='const'><a href="#BUFFERED_UPLOAD_BYTESIZE_LIMIT-constant" title="Rack::Multipart::Parser::BUFFERED_UPLOAD_BYTESIZE_LIMIT (constant)">BUFFERED_UPLOAD_BYTESIZE_LIMIT</a></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="../Multipart.html#Error-constant" title="Rack::Multipart::Error (constant)">Error</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>multipart data over retained size limit</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>