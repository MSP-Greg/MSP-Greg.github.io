<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Rack::CommonLogger &mdash; Rack main</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Rack::CommonLogger",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Rack main</a> &raquo; 
      <a href='../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../Rack.html" title="Rack (module)">Rack</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>CommonLogger&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Rack::CommonLogger</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/common_logger.rb#L13'>lib/rack/common_logger.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p><code>CommonLogger</code> forwards every request to the given <code>app</code>, and logs a line in the <a href="http://httpd.apache.org/docs/1.3/logs.html#common" target="_parent" title="Apache common log format">Apache common log format</a> to the configured logger.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='FORMAT-constant' class='summary_signature'>FORMAT =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>Common Log Format: <a href="http://httpd.apache.org/docs/1.3/logs.html#common">httpd.apache.org/docs/1.3/logs.html#common</a></p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_lilith'>lilith</span>.<span class='id identifier rubyid_local'>local</span> <span class='op'>-</span> <span class='op'>-</span> [<span class='int'>07</span><span class='op'>/</span><span class='const'>Aug</span><span class='op'>/</span><span class='int'>2006</span> <span class='int'>23</span><span class='symbeg'>:</span><span class='int'>58</span><span class='symbeg'>:</span><span class='int'>02</span> <span class='op'>-</span><span class='int'>0400</span>] <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GET / HTTP/1.1</span><span class='tstring_end'>&quot;</span></span> <span class='int'>500</span> <span class='op'>-</span>

<span class='tstring'><span class='tstring_beg'>%{</span><span class='tstring_content'>%s - %s [%s] &quot;%s %s%s %s&quot; %d %s\n</span><span class='tstring_end'>}</span></span> <span class='op'>%</span></code></pre>

<p>The actual format is slightly different than the above due to the separation of <a href="../Rack.html#SCRIPT_NAME-constant" title="Rack::SCRIPT_NAME (constant)">SCRIPT_NAME</a> and <a href="../Rack.html#PATH_INFO-constant" title="Rack::PATH_INFO (constant)">PATH_INFO</a>, and because the elapsed time in seconds is included at the end.</p>

  </div>
</div>
    <a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/common_logger.rb#L23-L23'># File 'lib/rack/common_logger.rb', line 23</a>    <pre class='code ruby'><span class='tstring'><span class='tstring_beg'>%{</span><span class='tstring_content'>%s - %s [%s] &quot;%s %s%s%s %s&quot; %d %s %0.4f </span><span class='tstring_end'>}</span></span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(app, logger = nil)  &#x21d2; CommonLogger </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p><code>logger</code> can be any object that supports the <code>write</code> or <code><<</code> methods, which includes the standard library Logger.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#call-instance_method" title="#call (instance method)">#<strong>call</strong>(env)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Log all requests in common_log format after a response has been returned.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#extract_content_length-instance_method" title="#extract_content_length (instance method)">#<strong>extract_content_length</strong>(headers)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Attempt to determine the content length for the response to include it in the logged data.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#log-instance_method" title="#log (instance method)">#<strong>log</strong>(env, status, response_headers, began_at)  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Log the request to the configured logger.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(app, logger = nil)  &#x21d2; <code>CommonLogger</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p><code>logger</code> can be any object that supports the <code>write</code> or <code><<</code> methods, which includes the standard library Logger.  These methods are called with a single string argument, the log message. If <code>logger</code> is nil, <code>CommonLogger</code> will fall back <code>env[&#39;rack.errors&#39;]</code>.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/common_logger.rb#L29-L32'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='29' data-end='32'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/common_logger.rb', line 29</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='id identifier rubyid_logger'>logger</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='ivar'>@app</span> <span class='op'>=</span> <span class='id identifier rubyid_app'>app</span>
  <span class='ivar'>@logger</span> <span class='op'>=</span> <span class='id identifier rubyid_logger'>logger</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="call-instance_method">
  <h3 class='signature  first'>
    #<strong>call</strong>(env)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Log all requests in common_log format after a response has been returned.  Note that if the app raises an exception, the request will not be logged, so if exception handling middleware are used, they should be loaded after this middleware.  Additionally, because the logging happens after the request body has been fully sent, any exceptions raised during the sending of the response body will cause the request not to be logged.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/common_logger.rb#L41-L47'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='41' data-end='47'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/common_logger.rb', line 41</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_env'>env</span>)
  <span class='id identifier rubyid_began_at'>began_at</span> <span class='op'>=</span> <span class='const'><a href="Utils.html" title="Rack::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_clock_time'><a href="Utils.html#clock_time-class_method" title="Rack::Utils.clock_time (method)">clock_time</a></span>
  <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='ivar'>@app</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_env'>env</span>)

  <span class='id identifier rubyid_response'>response</span>[<span class='int'>2</span>] <span class='op'>=</span> <span class='const'><a href="BodyProxy.html" title="Rack::BodyProxy (class)">BodyProxy</a></span>.<span class='id identifier rubyid_new'><a href="BodyProxy.html#new-class_method" title="Rack::BodyProxy.new (method)">new</a></span>(<span class='id identifier rubyid_body'>body</span>) { <span class='id identifier rubyid_log'><a href="#log-instance_method" title="Rack::CommonLogger#log (method)">log</a></span>(<span class='id identifier rubyid_env'>env</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span><span class='comma'>,</span> <span class='id identifier rubyid_began_at'>began_at</span>) }
  <span class='id identifier rubyid_response'>response</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="extract_content_length-instance_method">
  <h3 class='signature priv'>
    #<strong>extract_content_length</strong>(headers)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Attempt to determine the content length for the response to include it in the logged data.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/common_logger.rb#L84-L87'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='84' data-end='87'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/common_logger.rb', line 84</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_extract_content_length'>extract_content_length</span>(<span class='id identifier rubyid_headers'>headers</span>)
  <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_headers'>headers</span>[<span class='const'><a href="../Rack.html#CONTENT_LENGTH-constant" title="Rack::CONTENT_LENGTH (constant)">CONTENT_LENGTH</a></span>]
  <span class='op'>!</span><span class='id identifier rubyid_value'>value</span> <span class='op'>||</span> <span class='id identifier rubyid_value'>value</span>.<span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>0</span><span class='tstring_end'>&#39;</span></span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-</span><span class='tstring_end'>&#39;</span></span> <span class='op'>:</span> <span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="log-instance_method">
  <h3 class='signature priv'>
    #<strong>log</strong>(env, status, response_headers, began_at)   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Log the request to the configured logger.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rack/rack/blob/main/lib/rack/common_logger.rb#L52-L80'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='52' data-end='80'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/rack/common_logger.rb', line 52</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_log'>log</span>(<span class='id identifier rubyid_env'>env</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_response_headers'>response_headers</span><span class='comma'>,</span> <span class='id identifier rubyid_began_at'>began_at</span>)
  <span class='id identifier rubyid_request'>request</span> <span class='op'>=</span> <span class='const'><a href="../Rack.html" title="Rack (module)">Rack</a></span><span class='op'>::</span><span class='const'><a href="Request.html" title="Rack::Request (class)">Request</a></span>.<span class='id identifier rubyid_new'><a href="Request.html#new-class_method" title="Rack::Request.new (method)">new</a></span>(<span class='id identifier rubyid_env'>env</span>)
  <span class='id identifier rubyid_length'>length</span> <span class='op'>=</span> <span class='id identifier rubyid_extract_content_length'><a href="#extract_content_length-instance_method" title="Rack::CommonLogger#extract_content_length (method)">extract_content_length</a></span>(<span class='id identifier rubyid_response_headers'>response_headers</span>)

  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='id identifier rubyid_sprintf'>sprintf</span>(<span class='const'><a href="#FORMAT-constant" title="Rack::CommonLogger::FORMAT (constant)">FORMAT</a></span><span class='comma'>,</span>
    <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_ip'>ip</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_get_header'>get_header</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>REMOTE_USER</span><span class='tstring_end'>&quot;</span></span>) <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='const'>Time</span>.<span class='id identifier rubyid_now'>now</span>.<span class='id identifier rubyid_strftime'>strftime</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%d/%b/%Y:%H:%M:%S %z</span><span class='tstring_end'>&quot;</span></span>)<span class='comma'>,</span>
    <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_request_method'>request_method</span><span class='comma'>,</span>
    <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_script_name'>script_name</span><span class='comma'>,</span>
    <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_path_info'>path_info</span><span class='comma'>,</span>
    <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_query_string'>query_string</span>.<span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>?</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_query_string'>query_string</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_get_header'>get_header</span>(<span class='const'><a href="../Rack.html#SERVER_PROTOCOL-constant" title="Rack::SERVER_PROTOCOL (constant)">SERVER_PROTOCOL</a></span>)<span class='comma'>,</span>
    <span class='id identifier rubyid_status'>status</span>.<span class='id identifier rubyid_to_s'>to_s</span>[<span class='int'>0</span><span class='op'>..</span><span class='int'>3</span>]<span class='comma'>,</span>
    <span class='id identifier rubyid_length'>length</span><span class='comma'>,</span>
    <span class='const'><a href="Utils.html" title="Rack::Utils (module)">Utils</a></span>.<span class='id identifier rubyid_clock_time'><a href="Utils.html#clock_time-class_method" title="Rack::Utils.clock_time (method)">clock_time</a></span> <span class='op'>-</span> <span class='id identifier rubyid_began_at'>began_at</span>)

  <span class='id identifier rubyid_msg'>msg</span>.<span class='id identifier rubyid_gsub!'>gsub!</span>(<span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[^[:print:]]</span><span class='regexp_end'>/</span></span>) { <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_sprintf'>sprintf</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\\x%x</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_c'>c</span>.<span class='id identifier rubyid_ord'>ord</span>) }
  <span class='id identifier rubyid_msg'>msg</span>[<span class='op'>-</span><span class='int'>1</span>] <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_logger'>logger</span> <span class='op'>=</span> <span class='ivar'>@logger</span> <span class='op'>||</span> <span class='id identifier rubyid_request'>request</span>.<span class='id identifier rubyid_get_header'>get_header</span>(<span class='const'><a href="../Rack.html#RACK_ERRORS-constant" title="Rack::RACK_ERRORS (constant)">RACK_ERRORS</a></span>)
  <span class='comment'># Standard library logger doesn&#39;t support write but it supports &lt;&lt; which actually
</span>  <span class='comment'># calls to write on the log device without formatting
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_logger'>logger</span>.<span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_write'>write</span>)
    <span class='id identifier rubyid_logger'>logger</span>.<span class='id identifier rubyid_write'>write</span>(<span class='id identifier rubyid_msg'>msg</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_logger'>logger</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_msg'>msg</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>