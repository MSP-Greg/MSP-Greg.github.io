<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: ActiveRecord::ConnectionAdapters::ConnectionPool &mdash; Rails-5.0.0</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/custom.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/common.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::ConnectionAdapters::ConnectionPool",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
  <svg id='y_wait' class='' viewBox='0 0 90 90'></svg>
  <div id='tbl_cont'>
    <div id='y_list' class='d h'>
      <button id='list_sizer' class='y_sizer' title='LIST Resizer'></button>
      <header id='list_header'>
        <div id='list_title'>&#160;</div>
        <div id='list_menu'><span>&#160;</span></div>
        <input  id='list_search_text' type='search' placeholder='Search' size='12' value='' autocomplete='off' class='search_input'/>
        <svg id='list_search_icon' viewBox='0 0 30 30'>
          <path class='s_main' d='M21.189,17.213C22.022,15.726,22.5,14.014,22.5,12.188C22.5,6.493,17.884,1.875,12.188,1.875S1.875,6.493,1.875,12.188C1.875,17.882,6.491,22.5,12.188,22.5c1.826,0,3.536-0.48,5.025-1.311l6.113,6.113C23.873,27.851,24.593,28.125,25.313,28.125s1.44-0.274,1.989-0.823c1.099-1.099,1.099-2.878,0-3.977L21.189,17.213z M12.188,19.329c-3.943,0-7.14-3.197-7.14-7.142c0.0-3.943,3.197-7.14,7.14-7.14c3.941,0,7.14,3.195,7.14,7.14C19.328,16.133,16.129,19.329,12.188,19.329z'/>
          <path class='s_clear' d='M 4.414, 1.586 A 1,1 0 1,0 1.586, 4.414 L 21.586,24.414 A 1,1 0 1,0 24.414,21.586 z' />
          <path class='s_clear' d='M 1.586,21.586 A 1,1 0 1,0 4.414,24.414 L 24.414, 4.414 A 1,1 0 1,0 21.586, 1.586 z' />
        </svg>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All'></button>
      </header>
      <nav id= 'list_nav' class='y_nav l_nav'>
        <ul id='list_items'></ul>
      </nav>
    </div>
    <div id='y_toc' class='f h'>
      <button id='toc_sizer' class='y_sizer' title='TOC Resizer'></button>
      <header id='toc_header'>
        <div>Table of Contents</div>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All' ></button>
      </header>
      <nav id= 'toc_nav' class='y_nav t_nav'>
      <ol id='toc_items'></ol>
      </nav>
    </div>
    <div id='y_main' tabindex='-1'>
      <header id='y_header'>
        <div id='y_menu'>
          <a href='../../../index.html'>Home</a> &raquo; 
          <a href='../../index.html'>Rails-5.0.0</a> &raquo; 
          <a href='../../_index.html'>Index (C)</a> &raquo; 
          <a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
          <a href="../ConnectionAdapters.html" title="ActiveRecord::ConnectionAdapters (module)">ConnectionAdapters</a> &raquo; 
          <span class='title'>ConnectionPool</span>
        </div>

        <div id='y_measure_em' class='y_measure'></div>
        <div id='y_measure_vh' class='y_measure'></div>
        <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
        <a id='list_href' href="../../class_list.html"></a>
        <div id='hdr_button'>
          <button id='src' class='c' title='Source Show / Hide'>S<svg class='c' viewBox='0 0 36 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
              <rect x='20' y='0'  width='4'  height='28' rx='1.0' ry='1.0'/>
            </svg><svg class='o' viewBox='0 0 34 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
            </svg></button>
          <button id='list_loc' class='d' title='LIST Location'>L<svg class='f' viewBox='0 0 36 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='toc_loc' class='f' title='TOC Location'>T<svg class='f' viewBox='0 0 34 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='list_vis' title='LIST Show / Hide'>LIST</button>
          <button id='toc_vis' title='TOC Show / Hide'>TOC</button>
        </div>
        <div id='y_debug'></div>
      </header>
<div id='content' class='class'>

<h1>Class: ActiveRecord::ConnectionAdapters::ConnectionPool</h1>

<table class='y_box'>
<colgroup>
  <col class='box_1' />
  <col class='box_2' />
</colgroup>
  <tr>
    <td class='box_1'>Inherits:</td>
    <td class='box_rel'>
      <span class='inheritName'><a href="../../Object.html" title="Object (class)">Object</a></span>
      <ul class='fullTree'>
        <li><a href="../../Object.html" title="Object (class)">Object</a></li>
        <li class='next'>ActiveRecord::ConnectionAdapters::ConnectionPool</li>
      </ul>
      <a href='#' class='inheritanceTree'>show all</a>
    </td>
  </tr>

  <tr>
    <td class='box_1'>Child Modules:</td>
    <td>
      <a href="ConnectionPool/BiasableQueue.html" title="ActiveRecord::ConnectionAdapters::ConnectionPool::BiasableQueue (module)">BiasableQueue</a>
    </td>
  </tr>
  <tr>
    <td class='box_1'>Child Classes:</td>
    <td>
      <a href="ConnectionPool/ConnectionLeasingQueue.html" title="ActiveRecord::ConnectionAdapters::ConnectionPool::ConnectionLeasingQueue (class)">ConnectionLeasingQueue</a>,
    <a href="ConnectionPool/Queue.html" title="ActiveRecord::ConnectionAdapters::ConnectionPool::Queue (class)">Queue</a>,
    <a href="ConnectionPool/Reaper.html" title="ActiveRecord::ConnectionAdapters::ConnectionPool::Reaper (class)">Reaper</a>
    </td>
  </tr>

  <tr>
    <td class='box_1'>Includes:</td>
    <td>MonitorMixin
    </td>
  </tr>



  <tr>
  <td class='box_1'>Defined in:</td>
  <td class='box_rel'><div class='box_min'>
activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb</div>  </td>
  </tr>
</table>
<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Connection pool base class for managing Active Record database connections.</p>

<h3 id="label-Introduction">Introduction</h3>

<p>A connection pool synchronizes thread access to a limited number of
database connections. The basic idea is that each thread checks out a
database connection from the pool, uses that connection, and checks the
connection back in. ConnectionPool is completely thread-safe, and will
ensure that a connection cannot be used by two threads at the same time, as
long as ConnectionPool&#39;s contract is correctly followed. It will also
handle cases in which there are more threads than connections: if all
connections have been checked out, and a thread tries to checkout a
connection anyway, then ConnectionPool will wait until some other thread
has checked in a connection.</p>

<h3 id="label-Obtaining+-28checking+out-29+a+connection">Obtaining (checking out) a connection</h3>

<p>Connections can be obtained and used from a connection pool in several
ways:</p>
<ol><li>
<p>Simply use <a
href="rdoc-ref:ConnectionAdapters::ConnectionHandler#clear_active_connections!">ActiveRecord::Base.connection}[rdoc-ref:ConnectionHandling.connection]
as with Active Record 2.1 and earlier (pre-connection-pooling). Eventually,
when youâ€™re done with the connection(s) and wish it to be returned to the
pool, you call <code>ActiveRecord::Base.clear_active_connections!</a>.</code>[#with_connection],
which obtains a connection, yields it as the sole argument to the block,
and returns it to the pool after the block completes.</p>
</li></ol>

<p>Connections in the pool are actually AbstractAdapter objects (or objects
compatible with AbstractAdapter&#39;s interface).</p>

<h3 id="label-Options">Options</h3>

<p>There are several connection-pooling-related options that you can add to
your database connection configuration:</p>
<ul><li>
<p><code>pool</code>: number indicating size of connection pool (default 5)</p>
</li><li>
<p><code>checkout_timeout</code>: number of seconds to block and wait for a
connection before giving up and raising a timeout error (default 5
seconds).</p>
</li><li>
<p><code>reaping_frequency</code>: frequency in seconds to periodically run
the Reaper, which attempts to find and recover connections from dead
threads, which can occur if a programmer forgets to close a connection at
the end of a thread or a thread dies unexpectedly. Regardless of this
setting, the Reaper will be invoked before every blocking wait. (Default
nil, which means don&#39;t schedule the Reaper).</p>
</li></ul>


  </div>
</div>
<div class="tags">
  
</div>


<h2>Instance Attribute Summary <small><a href='#' class='summary_toggle'>collapse</a></small></h2>

  <ul class="summary">
    <li>
      <span class="summary_signature">
        <a href="#automatic_reconnect-instance_method" title="#automatic_reconnect (instance method)">#<strong>automatic_reconnect</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#checkout_timeout-instance_method" title="#checkout_timeout (instance method)">#<strong>checkout_timeout</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#connections-instance_method" title="#connections (instance method)">#<strong>connections</strong>  </a>
      </span>
      <span class='note title readonly'>readonly</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#reaper-instance_method" title="#reaper (instance method)">#<strong>reaper</strong>  </a>
      </span>
      <span class='note title readonly'>readonly</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#schema_cache-instance_method" title="#schema_cache (instance method)">#<strong>schema_cache</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#size-instance_method" title="#size (instance method)">#<strong>size</strong>  </a>
      </span>
      <span class='note title readonly'>readonly</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#spec-instance_method" title="#spec (instance method)">#<strong>spec</strong>  </a>
      </span>
      <span class='note title readonly'>readonly</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
  </ul>


<h2>Class Method Summary
  <small><a href='#' class='summary_toggle'>collapse</a></small>
</h2>

  <ul class='summary'>
    <li>
      <span class="summary_signature">
        <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(spec)  &#x21d2; ConnectionPool </a>
      </span>
      <span class='note title constructor'>constructor</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Creates a new ConnectionPool object.</p>
</div>
      </span>
    </li>
  </ul>
<h2>Instance Method Summary
  <small><a href='#' class='summary_toggle'>collapse</a></small>
</h2>

  <ul class='summary'>
    <li>
      <span class="summary_signature">
        <a href="#active_connection%3F-instance_method" title="#active_connection? (instance method)">#<strong>active_connection?</strong>  &#x21d2; Boolean </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Is there an open connection that is being used for the current thread?</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#checkin-instance_method" title="#checkin (instance method)">#<strong>checkin</strong>(conn)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Check-in a database connection back into the pool, indicating that you no
longer need this connection.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#checkout-instance_method" title="#checkout (instance method)">#<strong>checkout</strong>(checkout_timeout = @checkout_timeout)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Check-out a database connection from the pool, indicating that you want to
use it.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#clear_reloadable_connections-instance_method" title="#clear_reloadable_connections (instance method)">#<strong>clear_reloadable_connections</strong>(raise_on_acquisition_timeout = true)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Clears the cache which maps classes and re-connects connections that
require reloading.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#clear_reloadable_connections%21-instance_method" title="#clear_reloadable_connections! (instance method)">#<strong>clear_reloadable_connections!</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Clears the cache which maps classes and re-connects connections that
require reloading.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#connected%3F-instance_method" title="#connected? (instance method)">#<strong>connected?</strong>  &#x21d2; Boolean </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Returns true if a connection has already been opened.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#connection-instance_method" title="#connection (instance method)">#<strong>connection</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Retrieve the connection associated with the current thread, or call
<a href="#checkout-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#checkout (method)">#checkout</a> to obtain one if necessary.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#disconnect-instance_method" title="#disconnect (instance method)">#<strong>disconnect</strong>(raise_on_acquisition_timeout = true)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Disconnects all connections in the pool, and clears the pool.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#disconnect%21-instance_method" title="#disconnect! (instance method)">#<strong>disconnect!</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Disconnects all connections in the pool, and clears the pool.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#reap-instance_method" title="#reap (instance method)">#<strong>reap</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Recover lost connections for the pool.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#release_connection-instance_method" title="#release_connection (instance method)">#<strong>release_connection</strong>(owner_thread = Thread.current)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Signal that the thread is finished with the current connection.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#remove-instance_method" title="#remove (instance method)">#<strong>remove</strong>(conn)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Remove a connection from the connection pool.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#with_connection-instance_method" title="#with_connection (instance method)">#<strong>with_connection</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>If a connection obtained through <a href="#connection-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#connection (method)">#connection</a> or <a href="#with_connection-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#with_connection (method)">#with_connection</a>
methods already exists yield it to the block.</p>
</div>
      </span>
    </li>
  </ul>



  <h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>
  <section class='method_details first' id="new-class_method">
  <h3 class='signature first'>
  .<strong>new</strong>(spec)  &#x21d2; <tt><a href="" title="ActiveRecord::ConnectionAdapters::ConnectionPool (class)">ConnectionPool</a></tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Creates a new ConnectionPool object. <code>spec</code> is a
ConnectionSpecification object which describes database connection
information (e.g. adapter, host name, username, password, etc), as well as
the maximum size for this ConnectionPool.</p>

<p>The default ConnectionPool maximum size is 5.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 320</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_spec'>spec</span><span class='rparen'>)</span>
  <span class='kw'>super</span><span class='lparen'>(</span><span class='rparen'>)</span>

  <span class='ivar'>@spec</span> <span class='op'>=</span> <span class='id identifier rubyid_spec'>spec</span>

  <span class='ivar'>@checkout_timeout</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_spec'>spec</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='symbol'>:checkout_timeout</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_spec'>spec</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='symbol'>:checkout_timeout</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='int'>5</span>
  <span class='ivar'>@reaper</span> <span class='op'>=</span> <span class='const'>Reaper</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='id identifier rubyid_spec'>spec</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='symbol'>:reaping_frequency</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_spec'>spec</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='symbol'>:reaping_frequency</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='ivar'>@reaper</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span>

  <span class='comment'># default max pool size to 5
</span>  <span class='ivar'>@size</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_spec'>spec</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='symbol'>:pool</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_spec'>spec</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='symbol'>:pool</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='int'>5</span>

  <span class='comment'># The cache of threads mapped to reserved connections, the sole purpose
</span>  <span class='comment'># of the cache is to speed-up connection method, it is not the authoritative
</span>  <span class='comment'># registry of which thread owns which connection, that is tracked by
</span>  <span class='comment'># connection.owner attr on each connection instance.
</span>  <span class='comment'># The invariant works like this: if there is mapping of &lt;tt&gt;thread =&gt; conn&lt;/tt&gt;,
</span>  <span class='comment'># then that thread does indeed own that conn, however an absence of a such
</span>  <span class='comment'># mapping does not mean that the thread doesn&#39;t own the said connection, in
</span>  <span class='comment'># that case conn.owner attr should be consulted.
</span>  <span class='comment'># Access and modification of @thread_cached_conns does not require
</span>  <span class='comment'># synchronization.
</span>  <span class='ivar'>@thread_cached_conns</span> <span class='op'>=</span> <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>Map</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='symbol'>:initial_capacity</span> <span class='op'>=&gt;</span> <span class='ivar'>@size</span><span class='rparen'>)</span>

  <span class='ivar'>@connections</span>         <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='ivar'>@automatic_reconnect</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='comment'># Connection pool allows for concurrent (outside the main synchronize section)
</span>  <span class='comment'># establishment of new connections. This variable tracks the number of threads
</span>  <span class='comment'># currently in the process of independently establishing connections to the DB.
</span>  <span class='ivar'>@now_connecting</span> <span class='op'>=</span> <span class='int'>0</span>

  <span class='comment'># A boolean toggle that allows/disallows new connections.
</span>  <span class='ivar'>@new_cons_enabled</span> <span class='op'>=</span> <span class='kw'>true</span>

  <span class='ivar'>@available</span> <span class='op'>=</span> <span class='const'>ConnectionLeasingQueue</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>self</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
<h2 class='y_details'>Instance Attribute Details</h2>
  <section class='method_details first' id="automatic_reconnect-instance_method">
  <h3 class='signature first'>
  #<strong>automatic_reconnect</strong>  
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


311</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 311</span>

<span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:automatic_reconnect</span><span class='comma'>,</span> <span class='symbol'>:checkout_timeout</span><span class='comma'>,</span> <span class='symbol'>:schema_cache</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="checkout_timeout-instance_method">
  <h3 class='signature'>
  #<strong>checkout_timeout</strong>  
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


311</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 311</span>

<span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:automatic_reconnect</span><span class='comma'>,</span> <span class='symbol'>:checkout_timeout</span><span class='comma'>,</span> <span class='symbol'>:schema_cache</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="connections-instance_method">
  <h3 class='signature'>
  #<strong>connections</strong>   <span class="extras">(<span class='only'>readonly</span>)</span>
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


312</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 312</span>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:spec</span><span class='comma'>,</span> <span class='symbol'>:connections</span><span class='comma'>,</span> <span class='symbol'>:size</span><span class='comma'>,</span> <span class='symbol'>:reaper</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="reaper-instance_method">
  <h3 class='signature'>
  #<strong>reaper</strong>   <span class="extras">(<span class='only'>readonly</span>)</span>
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


312</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 312</span>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:spec</span><span class='comma'>,</span> <span class='symbol'>:connections</span><span class='comma'>,</span> <span class='symbol'>:size</span><span class='comma'>,</span> <span class='symbol'>:reaper</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="schema_cache-instance_method">
  <h3 class='signature'>
  #<strong>schema_cache</strong>  
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


311</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 311</span>

<span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:automatic_reconnect</span><span class='comma'>,</span> <span class='symbol'>:checkout_timeout</span><span class='comma'>,</span> <span class='symbol'>:schema_cache</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="size-instance_method">
  <h3 class='signature'>
  #<strong>size</strong>   <span class="extras">(<span class='only'>readonly</span>)</span>
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


312</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 312</span>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:spec</span><span class='comma'>,</span> <span class='symbol'>:connections</span><span class='comma'>,</span> <span class='symbol'>:size</span><span class='comma'>,</span> <span class='symbol'>:reaper</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="spec-instance_method">
  <h3 class='signature'>
  #<strong>spec</strong>   <span class="extras">(<span class='only'>readonly</span>)</span>
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


312</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 312</span>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:spec</span><span class='comma'>,</span> <span class='symbol'>:connections</span><span class='comma'>,</span> <span class='symbol'>:size</span><span class='comma'>,</span> <span class='symbol'>:reaper</span>
</pre>
  </div>
</div>
</section>
<h2 class='y_details'>Instance Method Details</h2>
  <section class='method_details first' id="active_connection?-instance_method">
  <h3 class='signature first'>
  #<strong>active_connection?</strong>  &#x21d2; <tt>Boolean</tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Is there an open connection that is being used for the current thread?</p>

<p>This method only works for connections that have been obtained through
<a href="#connection-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#connection (method)">#connection</a> or <a href="#with_connection-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#with_connection (method)">#with_connection</a> methods, connections obtained through
<a href="#checkout-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#checkout (method)">#checkout</a> will not be detected by <a href="#active_connection%3F-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#active_connection? (method)">#active_connection?</a></p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


372
373
374</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 372</span>

<span class='kw'>def</span> <span class='id identifier rubyid_active_connection?'>active_connection?</span>
  <span class='ivar'>@thread_cached_conns</span><span class='lbracket'>[</span><span class='id identifier rubyid_connection_cache_key'>connection_cache_key</span><span class='lparen'>(</span><span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='rparen'>)</span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="checkin-instance_method">
  <h3 class='signature'>
  #<strong>checkin</strong>(conn)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Check-in a database connection back into the pool, indicating that you no
longer need this connection.</p>

<p><code>conn</code>: an AbstractAdapter object, which was obtained by earlier
by calling <a href="#checkout-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#checkout (method)">#checkout</a> on this pool.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


515
516
517
518
519
520
521
522
523
524
525</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 515</span>

<span class='kw'>def</span> <span class='id identifier rubyid_checkin'>checkin</span><span class='lparen'>(</span><span class='id identifier rubyid_conn'>conn</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_remove_connection_from_thread_cache'>remove_connection_from_thread_cache</span> <span class='id identifier rubyid_conn'>conn</span>

    <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid__run_checkin_callbacks'>_run_checkin_callbacks</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_expire'>expire</span>
    <span class='kw'>end</span>

    <span class='ivar'>@available</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span> <span class='id identifier rubyid_conn'>conn</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="checkout-instance_method">
  <h3 class='signature'>
  #<strong>checkout</strong>(checkout_timeout = @checkout_timeout)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Check-out a database connection from the pool, indicating that you want to
use it. You should call <a href="#checkin-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#checkin (method)">#checkin</a> when you no longer need this.</p>

<p>This is done by either returning and leasing existing connection, or by
creating a new connection and leasing it.</p>

<p>If all connections are leased and the pool is at capacity (meaning the
number of currently leased connections is greater than or equal to the size
limit set), an <a href="../ConnectionTimeoutError.html" title="ActiveRecord::ConnectionTimeoutError (class)">ActiveRecord::ConnectionTimeoutError</a> exception will be
raised.</p>

<p>Returns: an AbstractAdapter object.</p>

<p>Raises:</p>
<ul><li>
<p><a href="../ConnectionTimeoutError.html" title="ActiveRecord::ConnectionTimeoutError (class)">ActiveRecord::ConnectionTimeoutError</a> no connection can be obtained from
the pool.</p>
</li></ul>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


506
507
508</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 506</span>

<span class='kw'>def</span> <span class='id identifier rubyid_checkout'>checkout</span><span class='lparen'>(</span><span class='id identifier rubyid_checkout_timeout'>checkout_timeout</span> <span class='op'>=</span> <span class='ivar'>@checkout_timeout</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_checkout_and_verify'>checkout_and_verify</span><span class='lparen'>(</span><span class='id identifier rubyid_acquire_connection'>acquire_connection</span><span class='lparen'>(</span><span class='id identifier rubyid_checkout_timeout'>checkout_timeout</span><span class='rparen'>)</span><span class='rparen'>)</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="clear_reloadable_connections-instance_method">
  <h3 class='signature'>
  #<strong>clear_reloadable_connections</strong>(raise_on_acquisition_timeout = true)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Clears the cache which maps classes and re-connects connections that
require reloading.</p>

<p>Raises:</p>
<ul><li>
<p><a href="../ExclusiveConnectionTimeoutError.html" title="ActiveRecord::ExclusiveConnectionTimeoutError (class)">ExclusiveConnectionTimeoutError</a> if unable to gain ownership
of all connections in the pool within a timeout interval (default duration
is <code>spec.config[:checkout_timeout] * 2</code> seconds).</p>
</li></ul>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 447</span>

<span class='kw'>def</span> <span class='id identifier rubyid_clear_reloadable_connections'>clear_reloadable_connections</span><span class='lparen'>(</span><span class='id identifier rubyid_raise_on_acquisition_timeout'>raise_on_acquisition_timeout</span> <span class='op'>=</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_num_new_conns_required'>num_new_conns_required</span> <span class='op'>=</span> <span class='int'>0</span>

  <span class='id identifier rubyid_with_exclusively_acquired_all_connections'>with_exclusively_acquired_all_connections</span><span class='lparen'>(</span><span class='id identifier rubyid_raise_on_acquisition_timeout'>raise_on_acquisition_timeout</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
      <span class='ivar'>@connections</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_in_use?'>in_use?</span>
          <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_steal!'>steal!</span>
          <span class='id identifier rubyid_checkin'>checkin</span> <span class='id identifier rubyid_conn'>conn</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_disconnect!'>disconnect!</span> <span class='kw'>if</span> <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_requires_reloading?'>requires_reloading?</span>
      <span class='kw'>end</span>
      <span class='ivar'>@connections</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:requires_reloading?</span><span class='rparen'>)</span>

      <span class='ivar'>@available</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>

      <span class='kw'>if</span> <span class='ivar'>@connections</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>&lt;</span> <span class='ivar'>@size</span>
        <span class='comment'># because of the pruning done by this method, we might be running
</span>        <span class='comment'># low on connections, while threads stuck in queue are helpless
</span>        <span class='comment'># (not being able to establish new connections for themselves),
</span>        <span class='comment'># see also more detailed explanation in remove
</span>        <span class='id identifier rubyid_num_new_conns_required'>num_new_conns_required</span> <span class='op'>=</span> <span class='id identifier rubyid_num_waiting_in_queue'>num_waiting_in_queue</span> <span class='op'>-</span> <span class='ivar'>@connections</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>
      <span class='kw'>end</span>

      <span class='ivar'>@connections</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
        <span class='ivar'>@available</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span> <span class='id identifier rubyid_conn'>conn</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_bulk_make_new_connections'>bulk_make_new_connections</span><span class='lparen'>(</span><span class='id identifier rubyid_num_new_conns_required'>num_new_conns_required</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_num_new_conns_required'>num_new_conns_required</span> <span class='op'>&gt;</span> <span class='int'>0</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="clear_reloadable_connections!-instance_method">
  <h3 class='signature'>
  #<strong>clear_reloadable_connections!</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Clears the cache which maps classes and re-connects connections that
require reloading.</p>

<p>The pool first tries to gain ownership of all connections, if unable to do
so within a timeout interval (default duration is
<code>spec.config[:checkout_timeout] * 2</code> seconds), the pool
forcefully clears the cache and reloads connections without any regard for
other connection owning threads.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


488
489
490</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 488</span>

<span class='kw'>def</span> <span class='id identifier rubyid_clear_reloadable_connections!'>clear_reloadable_connections!</span>
  <span class='id identifier rubyid_clear_reloadable_connections'>clear_reloadable_connections</span><span class='lparen'>(</span><span class='kw'>false</span><span class='rparen'>)</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="connected?-instance_method">
  <h3 class='signature'>
  #<strong>connected?</strong>  &#x21d2; <tt>Boolean</tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Returns true if a connection has already been opened.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


404
405
406</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 404</span>

<span class='kw'>def</span> <span class='id identifier rubyid_connected?'>connected?</span>
  <span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span> <span class='ivar'>@connections</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="connection-instance_method">
  <h3 class='signature'>
  #<strong>connection</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Retrieve the connection associated with the current thread, or call
<a href="#checkout-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#checkout (method)">#checkout</a> to obtain one if necessary.</p>

<p><a href="#connection-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#connection (method)">#connection</a> can be called any number of times; the connection is held in
a cache keyed by a thread.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


363
364
365</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 363</span>

<span class='kw'>def</span> <span class='id identifier rubyid_connection'>connection</span>
  <span class='ivar'>@thread_cached_conns</span><span class='lbracket'>[</span><span class='id identifier rubyid_connection_cache_key'>connection_cache_key</span><span class='lparen'>(</span><span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='rparen'>)</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='id identifier rubyid_checkout'>checkout</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="disconnect-instance_method">
  <h3 class='signature'>
  #<strong>disconnect</strong>(raise_on_acquisition_timeout = true)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Disconnects all connections in the pool, and clears the pool.</p>

<p>Raises:</p>
<ul><li>
<p><a href="../ExclusiveConnectionTimeoutError.html" title="ActiveRecord::ExclusiveConnectionTimeoutError (class)">ExclusiveConnectionTimeoutError</a> if unable to gain ownership
of all connections in the pool within a timeout interval (default duration
is <code>spec.config[:checkout_timeout] * 2</code> seconds).</p>
</li></ul>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


414
415
416
417
418
419
420
421
422
423
424
425
426
427
428</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 414</span>

<span class='kw'>def</span> <span class='id identifier rubyid_disconnect'>disconnect</span><span class='lparen'>(</span><span class='id identifier rubyid_raise_on_acquisition_timeout'>raise_on_acquisition_timeout</span> <span class='op'>=</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_with_exclusively_acquired_all_connections'>with_exclusively_acquired_all_connections</span><span class='lparen'>(</span><span class='id identifier rubyid_raise_on_acquisition_timeout'>raise_on_acquisition_timeout</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
      <span class='ivar'>@connections</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_in_use?'>in_use?</span>
          <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_steal!'>steal!</span>
          <span class='id identifier rubyid_checkin'>checkin</span> <span class='id identifier rubyid_conn'>conn</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_disconnect!'>disconnect!</span>
      <span class='kw'>end</span>
      <span class='ivar'>@connections</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='ivar'>@available</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="disconnect!-instance_method">
  <h3 class='signature'>
  #<strong>disconnect!</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Disconnects all connections in the pool, and clears the pool.</p>

<p>The pool first tries to gain ownership of all connections, if unable to do
so within a timeout interval (default duration is
<code>spec.config[:checkout_timeout] * 2</code> seconds), the pool is
forcefully disconnected without any regard for other connection owning
threads.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


436
437
438</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 436</span>

<span class='kw'>def</span> <span class='id identifier rubyid_disconnect!'>disconnect!</span>
  <span class='id identifier rubyid_disconnect'>disconnect</span><span class='lparen'>(</span><span class='kw'>false</span><span class='rparen'>)</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="reap-instance_method">
  <h3 class='signature'>
  #<strong>reap</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Recover lost connections for the pool. A lost connection can occur if a
programmer forgets to checkin a connection at the end of a thread or a
thread dies unexpectedly.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 561</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reap'>reap</span>
  <span class='id identifier rubyid_stale_connections'>stale_connections</span> <span class='op'>=</span> <span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@connections</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
      <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_in_use?'>in_use?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_alive?'>alive?</span>
    <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
      <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_steal!'>steal!</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_stale_connections'>stale_connections</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_conn'>conn</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_active?'>active?</span>
      <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_reset!'>reset!</span>
      <span class='id identifier rubyid_checkin'>checkin</span> <span class='id identifier rubyid_conn'>conn</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_remove'>remove</span> <span class='id identifier rubyid_conn'>conn</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="release_connection-instance_method">
  <h3 class='signature'>
  #<strong>release_connection</strong>(owner_thread = Thread.current)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Signal that the thread is finished with the current connection.
<a href="#release_connection-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#release_connection (method)">#release_connection</a> releases the connection-thread association and
returns the connection to the pool.</p>

<p>This method only works for connections that have been obtained through
<a href="#connection-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#connection (method)">#connection</a> or <a href="#with_connection-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#with_connection (method)">#with_connection</a> methods, connections obtained through
<a href="#checkout-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#checkout (method)">#checkout</a> will not be automatically released.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


383
384
385
386
387</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 383</span>

<span class='kw'>def</span> <span class='id identifier rubyid_release_connection'>release_connection</span><span class='lparen'>(</span><span class='id identifier rubyid_owner_thread'>owner_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_conn'>conn</span> <span class='op'>=</span> <span class='ivar'>@thread_cached_conns</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_connection_cache_key'>connection_cache_key</span><span class='lparen'>(</span><span class='id identifier rubyid_owner_thread'>owner_thread</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_checkin'>checkin</span> <span class='id identifier rubyid_conn'>conn</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="remove-instance_method">
  <h3 class='signature'>
  #<strong>remove</strong>(conn)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Remove a connection from the connection pool. The connection will remain
open and active but will no longer be managed by this pool.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 529</span>

<span class='kw'>def</span> <span class='id identifier rubyid_remove'>remove</span><span class='lparen'>(</span><span class='id identifier rubyid_conn'>conn</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_needs_new_connection'>needs_new_connection</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_remove_connection_from_thread_cache'>remove_connection_from_thread_cache</span> <span class='id identifier rubyid_conn'>conn</span>

    <span class='ivar'>@connections</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_conn'>conn</span>
    <span class='ivar'>@available</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_conn'>conn</span>

    <span class='comment'># @available.any_waiting? =&gt; true means that prior to removing this
</span>    <span class='comment'># conn, the pool was at its max size (@connections.size == @size)
</span>    <span class='comment'># this would mean that any threads stuck waiting in the queue wouldn&#39;t
</span>    <span class='comment'># know they could checkout_new_connection, so let&#39;s do it for them.
</span>    <span class='comment'># Because condition-wait loop is encapsulated in the Queue class
</span>    <span class='comment'># (that in turn is oblivious to ConnectionPool implementation), threads
</span>    <span class='comment'># that are &quot;stuck&quot; there are helpless, they have no way of creating
</span>    <span class='comment'># new connections and are completely reliant on us feeding available
</span>    <span class='comment'># connections into the Queue.
</span>    <span class='id identifier rubyid_needs_new_connection'>needs_new_connection</span> <span class='op'>=</span> <span class='ivar'>@available</span><span class='period'>.</span><span class='id identifier rubyid_any_waiting?'>any_waiting?</span>
  <span class='kw'>end</span>

  <span class='comment'># This is intentionally done outside of the synchronized section as we
</span>  <span class='comment'># would like not to hold the main mutex while checking out new connections,
</span>  <span class='comment'># thus there is some chance that needs_new_connection information is now
</span>  <span class='comment'># stale, we can live with that (bulk_make_new_connections will make
</span>  <span class='comment'># sure not to exceed the pool&#39;s @size limit).
</span>  <span class='id identifier rubyid_bulk_make_new_connections'>bulk_make_new_connections</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_needs_new_connection'>needs_new_connection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="with_connection-instance_method">
  <h3 class='signature'>
  #<strong>with_connection</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>If a connection obtained through <a href="#connection-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#connection (method)">#connection</a> or <a href="#with_connection-instance_method" title="ActiveRecord::ConnectionAdapters::ConnectionPool#with_connection (method)">#with_connection</a>
methods already exists yield it to the block. If no such connection exists
checkout a connection, yield it to the block, and checkin the connection
when finished.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


393
394
395
396
397
398
399
400
401</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb', line 393</span>

<span class='kw'>def</span> <span class='id identifier rubyid_with_connection'>with_connection</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_conn'>conn</span> <span class='op'>=</span> <span class='ivar'>@thread_cached_conns</span><span class='lbracket'>[</span><span class='id identifier rubyid_connection_cache_key'>connection_cache_key</span><span class='lparen'>(</span><span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='rparen'>)</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_conn'>conn</span> <span class='op'>=</span> <span class='id identifier rubyid_connection'>connection</span>
    <span class='id identifier rubyid_fresh_connection'>fresh_connection</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
  <span class='kw'>yield</span> <span class='id identifier rubyid_conn'>conn</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_release_connection'>release_connection</span> <span class='kw'>if</span> <span class='id identifier rubyid_fresh_connection'>fresh_connection</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<div id='footer'>
  Generated by
  <a href='http://yardoc.org' title='Yay! A Ruby Documentation Tool' target="_parent">yard</a>
  0.9.0 with <a href='https://msp-greg.github.io/yard-t2/' title='yard-t2' target="_parent">yard-t2</a> 0.6.0 (ruby-2.3.2p135)
</div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</div> <!-- tbl_cont -->
</body>
</html>