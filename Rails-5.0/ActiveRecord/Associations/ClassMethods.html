<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ActiveRecord::Associations::ClassMethods &mdash; Rails-5.0.0</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/custom.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/common.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::Associations::ClassMethods",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
  <svg id='y_wait' class='' viewBox='0 0 90 90'></svg>
  <div id='tbl_cont'>
    <div id='y_list' class='d h'>
      <button id='list_sizer' class='y_sizer' title='LIST Resizer'></button>
      <header id='list_header'>
        <div id='list_title'>&#160;</div>
        <div id='list_menu'><span>&#160;</span></div>
        <input  id='list_search_text' type='search' placeholder='Search' size='12' value='' autocomplete='off' class='search_input'/>
        <svg id='list_search_icon' viewBox='0 0 30 30'>
          <path class='s_main' d='M21.189,17.213C22.022,15.726,22.5,14.014,22.5,12.188C22.5,6.493,17.884,1.875,12.188,1.875S1.875,6.493,1.875,12.188C1.875,17.882,6.491,22.5,12.188,22.5c1.826,0,3.536-0.48,5.025-1.311l6.113,6.113C23.873,27.851,24.593,28.125,25.313,28.125s1.44-0.274,1.989-0.823c1.099-1.099,1.099-2.878,0-3.977L21.189,17.213z M12.188,19.329c-3.943,0-7.14-3.197-7.14-7.142c0.0-3.943,3.197-7.14,7.14-7.14c3.941,0,7.14,3.195,7.14,7.14C19.328,16.133,16.129,19.329,12.188,19.329z'/>
          <path class='s_clear' d='M 4.414, 1.586 A 1,1 0 1,0 1.586, 4.414 L 21.586,24.414 A 1,1 0 1,0 24.414,21.586 z' />
          <path class='s_clear' d='M 1.586,21.586 A 1,1 0 1,0 4.414,24.414 L 24.414, 4.414 A 1,1 0 1,0 21.586, 1.586 z' />
        </svg>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All'></button>
      </header>
      <nav id= 'list_nav' class='y_nav l_nav'>
        <ul id='list_items'></ul>
      </nav>
    </div>
    <div id='y_toc' class='f h'>
      <button id='toc_sizer' class='y_sizer' title='TOC Resizer'></button>
      <header id='toc_header'>
        <div>Table of Contents</div>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All' ></button>
      </header>
      <nav id= 'toc_nav' class='y_nav t_nav'>
      <ol id='toc_items'></ol>
      </nav>
    </div>
    <div id='y_main' tabindex='-1'>
      <header id='y_header'>
        <div id='y_menu'>
          <a href='../../../index.html'>Home</a> &raquo; 
          <a href='../../index.html'>Rails-5.0.0</a> &raquo; 
          <a href='../../_index.html'>Index (C)</a> &raquo; 
          <a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
          <a href="../Associations.html" title="ActiveRecord::Associations (module)">Associations</a> &raquo; 
          <span class='title'>ClassMethods</span>
        </div>

        <div id='y_measure_em' class='y_measure'></div>
        <div id='y_measure_vh' class='y_measure'></div>
        <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
        <a id='list_href' href="../../class_list.html"></a>
        <div id='hdr_button'>
          <button id='src' class='c' title='Source Show / Hide'>S<svg class='c' viewBox='0 0 36 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
              <rect x='20' y='0'  width='4'  height='28' rx='1.0' ry='1.0'/>
            </svg><svg class='o' viewBox='0 0 34 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
            </svg></button>
          <button id='list_loc' class='d' title='LIST Location'>L<svg class='f' viewBox='0 0 36 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='toc_loc' class='f' title='TOC Location'>T<svg class='f' viewBox='0 0 34 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='list_vis' title='LIST Show / Hide'>LIST</button>
          <button id='toc_vis' title='TOC Show / Hide'>TOC</button>
        </div>
        <div id='y_debug'></div>
      </header>
<div id='content' class='module'>

<h1>Module: ActiveRecord::Associations::ClassMethods</h1>

<table class='y_box'>
<colgroup>
  <col class='box_1' />
  <col class='box_2' />
</colgroup>





  <tr>
  <td class='box_1'>Defined in:</td>
  <td class='box_rel'><div class='box_max'>
<a href='https://github.com/rails/rails/blob/master/activerecord/lib/active_record/associations.rb#L1153'>activerecord/lib/active_record/associations.rb</a></div>  </td>
  </tr>
</table>
<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Associations are a set of macro-like class methods for tying objects
together through foreign keys. They express relationships like “Project has
one Project Manager” or “Project belongs to a Portfolio”. Each macro adds a
number of methods to the class which are specialized according to the
collection or association symbol and the options hash. It works much the
same way as Ruby&#39;s own <code>attr*</code> methods.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Project</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span>              <span class='symbol'>:portfolio</span>
  <span class='id identifier rubyid_has_one'>has_one</span>                 <span class='symbol'>:project_manager</span>
  <span class='id identifier rubyid_has_many'>has_many</span>                <span class='symbol'>:milestones</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:categories</span>
<span class='kw'>end</span>
</code></pre>

<p>The project class now has the following methods (and more) to ease the
traversal and manipulation of its relationships:</p>
<ul><li>
<p><code>Project#portfolio, {Project#portfolio=(portfolio}),
{Project#portfolio}.nil?</code></p>
</li><li>
<p><code>Project#project_manager, {Project#project_manager=(project_manager}),
{Project#project_manager}.nil?,</code></p>
</li><li>
<p><code>Project#milestones.empty?, {Project#milestones}.size,
{Project#milestones}, {Project#milestones&lt;&lt;(milestone}),</code>
<code>Project#milestones.delete(milestone),
Project#milestones.destroy(milestone),
Project#milestones.find(milestone_id),</code>
<code>Project#milestones.build, Project#milestones.create</code></p>
</li><li>
<p><code>Project#categories.empty?, {Project#categories}.size,
{Project#categories}, {Project#categories&lt;&lt;(category1}),</code>
<code>Project#categories.delete(category1),
Project#categories.destroy(category1)</code></p>
</li></ul>

<h4 id="label-A+word+of+warning">A word of warning</h4>

<p>Don&#39;t create associations that have the same name as <code>instance</code>[ActiveRecord::Core] of <code>ActiveRecord::Base</code>. Since the
association adds a method with that name to its model, using an association
with the same name as one provided by <code>ActiveRecord::Base</code> will
override the method inherited through <code>ActiveRecord::Base</code> and
will break things. For instance, <code>attributes</code> and
<code>connection</code> would be bad choices for association names, because
those names already exist in the list of <code>ActiveRecord::Base</code>
instance methods.</p>

<h3 id="label-Auto-generated+methods">Auto-generated methods</h3>

<p>See also Instance Public methods below for more details.</p>

<h4 id="label-Singular+associations+-28one-to-one-29">Singular associations (one-to-one)</h4>

<pre class="code ruby"><code class="ruby">                                  |            |  belongs_to  |
generated methods                 | belongs_to | :polymorphic | has_one
------------------------------------------------------------+---------
other(force_reload=false)         |     X      |      X       |    X
other=(other)                     |     X      |      X       |    X
build_other(attributes={})        |     X      |              |    X
create_other(attributes={})       |     X      |              |    X
create_other!(attributes={})      |     X      |              |    X</code></pre>

<h4 id="label-Collection+associations+-28one-to-many+-2F+many-to-many-29">Collection associations (one-to-many / many-to-many)</h4>

<pre class="code ruby"><code class="ruby">                                  |       |          | has_many
generated methods                 | habtm | has_many | :through
---------------------------------------------------+----------
others(force_reload=false)        |   X   |    X     |    X
others=(other,other,...)          |   X   |    X     |    X
other_ids                         |   X   |    X     |    X
other_ids=(id,id,...)             |   X   |    X     |    X
others&lt;&lt;                          |   X   |    X     |    X
others.push                       |   X   |    X     |    X
others.concat                     |   X   |    X     |    X
others.build(attributes={})       |   X   |    X     |    X
others.create(attributes={})      |   X   |    X     |    X
others.create!(attributes={})     |   X   |    X     |    X
others.size                       |   X   |    X     |    X
others.length                     |   X   |    X     |    X
others.count                      |   X   |    X     |    X
others.sum(*args)                 |   X   |    X     |    X
others.empty?                     |   X   |    X     |    X
others.clear                      |   X   |    X     |    X
others.delete(other,other,...)    |   X   |    X     |    X
others.delete_all                 |   X   |    X     |    X
others.destroy(other,other,...)   |   X   |    X     |    X
others.destroy_all                |   X   |    X     |    X
others.find(*args)                |   X   |    X     |    X
others.exists?                    |   X   |    X     |    X
others.distinct                   |   X   |    X     |    X
others.reset                      |   X   |    X     |    X</code></pre>

<h4 id="label-Overriding+generated+methods">Overriding generated methods</h4>

<p>Association methods are generated in a module that is included into the
model class, which allows you to easily override with your own methods and
call the original generated method with <code>super</code>. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Car</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:owner</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:old_owner</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_owner='>owner=</span><span class='lparen'>(</span><span class='id identifier rubyid_new_owner'>new_owner</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_old_owner'>old_owner</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_owner'>owner</span>
    <span class='kw'>super</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If your model class is <code>Project</code>, then the module is named
<code>Project::GeneratedAssociationMethods</code>. The
<code>GeneratedAssociationMethods</code> module is included in the model
class immediately after the (anonymous) generated attributes methods
module, meaning an association will override the methods for an attribute
with the same name.</p>

<h3 id="label-Cardinality+and+associations">Cardinality and associations</h3>

<p>Active Record associations can be used to describe one-to-one, one-to-many
and many-to-many relationships between models. Each model uses an
association to describe its role in the relation. The <code>#belongs_to</code>
association is always used in the model that has the foreign key.</p>

<h4 id="label-One-to-one">One-to-one</h4>

<p>Use <code>#has_one</code> in the base, and <code>#belongs_to</code> in the associated model.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Employee</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:office</span>
<span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Office</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:employee</span>    <span class='comment'># foreign key - employee_id
</span><span class='kw'>end</span>
</code></pre>

<h4 id="label-One-to-many">One-to-many</h4>

<p>Use <code>#has_many</code> in the base, and <code>#belongs_to</code> in the associated model.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Manager</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:employees</span>
<span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Employee</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:manager</span>     <span class='comment'># foreign key - manager_id
</span><span class='kw'>end</span>
</code></pre>

<h4 id="label-Many-to-many">Many-to-many</h4>

<p>There are two ways to build a many-to-many relationship.</p>

<p>The first way uses a <code>#has_many</code> association with the <code>:through</code>
option and a join model, so there are two stages of associations.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Assignment</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:programmer</span>  <span class='comment'># foreign key - programmer_id
</span>  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:project</span>     <span class='comment'># foreign key - project_id
</span><span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Programmer</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:assignments</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:projects</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:assignments</span>
<span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Project</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:assignments</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:programmers</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:assignments</span>
<span class='kw'>end</span>
</code></pre>

<p>For the second way, use <code>#has_and_belongs_to_many</code> in both models. This
requires a join table that has no corresponding model or primary key.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Programmer</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:projects</span>       <span class='comment'># foreign keys in the join table
</span><span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Project</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:programmers</span>    <span class='comment'># foreign keys in the join table
</span><span class='kw'>end</span>
</code></pre>

<p>Choosing which way to build a many-to-many relationship is not always
simple. If you need to work with the relationship model as its own entity,
use <code>#has_many</code> <code>:through</code>. Use <code>#has_and_belongs_to_many</code> when
working with legacy schemas or when you never work directly with the
relationship itself.</p>

<h3 id="label-Is+it+a+-7B-23belongs_to-7D+or+-7B-23has_one-7D+association-3F">Is it a <code>#belongs_to</code> or <code>#has_one</code> association?</h3>

<p>Both express a 1-1 relationship. The difference is mostly where to place
the foreign key, which goes on the table for the class declaring the
<code>#belongs_to</code> relationship.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='comment'># I reference an account.
</span>  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:account</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='comment'># One user references me.
</span>  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:user</span>
<span class='kw'>end</span>
</code></pre>

<p>The tables for these classes could look something like:</p>

<pre class="code ruby"><code class="ruby">CREATE TABLE users (
  id int NOT NULL auto_increment,
  account_id int default NULL,
  name varchar default NULL,
  PRIMARY KEY  (id)
)

CREATE TABLE accounts (
  id int NOT NULL auto_increment,
  name varchar default NULL,
  PRIMARY KEY  (id)
)</code></pre>

<h3 id="label-Unsaved+objects+and+associations">Unsaved objects and associations</h3>

<p>You can manipulate objects and associations before they are saved to the
database, but there is some special behavior you should be aware of, mostly
involving the saving of associated objects.</p>

<p>You can set the <code>:autosave</code> option on a <code>#has_one</code>,
<code>#belongs_to</code>, <code>#has_many</code>, or <code>#has_and_belongs_to_many</code> association.
Setting it to <code>true</code> will <em>always</em> save the members,
whereas setting it to <code>false</code> will <em>never</em> save the
members. More details about <code>:autosave</code> option is available at
AutosaveAssociation.</p>

<h4 id="label-One-to-one+associations">One-to-one associations</h4>
<ul><li>
<p>Assigning an object to a <code>#has_one</code> association automatically saves that
object and the object being replaced (if there is one), in order to update
their foreign keys - except if the parent object is unsaved
(<code>new_record? == true</code>).</p>
</li><li>
<p>If either of these saves fail (due to one of the objects being invalid), an
ActiveRecord::RecordNotSaved exception is raised and the assignment is
cancelled.</p>
</li><li>
<p>If you wish to assign an object to a <code>#has_one</code> association without saving
it, use the <code>#build_association</code> method (documented below). The
object being replaced will still be saved to update its foreign key.</p>
</li><li>
<p>Assigning an object to a <code>#belongs_to</code> association does not save the
object, since the foreign key field belongs on the parent. It does not save
the parent either.</p>
</li></ul>

<h4 id="label-Collections">Collections</h4>
<ul><li>
<p>Adding an object to a collection (#has_many or <code>#has_and_belongs_to_many</code>)
automatically saves that object, except if the parent object (the owner of
the collection) is not yet stored in the database.</p>
</li><li>
<p>If saving any of the objects being added to a collection (via
<code>push</code> or similar) fails, then <code>push</code> returns
<code>false</code>.</p>
</li><li>
<p>If saving fails while replacing the collection (via
<code>association=</code>), an ActiveRecord::RecordNotSaved exception is
raised and the assignment is cancelled.</p>
</li><li>
<p>You can add an object to a collection without automatically saving it by
using the <code>collection.build</code> method (documented below).</p>
</li><li>
<p>All unsaved (<code>new_record? == true</code>) members of the collection
are automatically saved when the parent is saved.</p>
</li></ul>

<h3 id="label-Customizing+the+query">Customizing the query</h3>

<p>Associations are built from <code>Relation</code> objects, and you can use
the Relation syntax to customize them. For example, to add a condition:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Blog</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:published_posts</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>published:</span> <span class='kw'>true</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Post</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>Inside the <code>-&gt; { ... }</code> block you can use all of the usual
Relation methods.</p>

<h4 id="label-Accessing+the+owner+object">Accessing the owner object</h4>

<p>Sometimes it is useful to have access to the owner object when building the
query. The owner is passed as a parameter to the block. For example, the
following association would find all events that occur on the user&#39;s
birthday:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:birthday_events</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>starts_on:</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_birthday'>birthday</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Event</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>Note: Joining, eager loading and preloading of these associations is not
fully possible. These operations happen before instance creation and the
scope will be called with a <code>nil</code> argument. This can lead to
unexpected behavior and is deprecated.</p>

<h3 id="label-Association+callbacks">Association callbacks</h3>

<p>Similar to the normal callbacks that hook into the life cycle of an Active
Record object, you can also define callbacks that get triggered when you
add an object to or remove an object from an association collection.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Project</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:developers</span><span class='comma'>,</span> <span class='label'>after_add:</span> <span class='symbol'>:evaluate_velocity</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_evaluate_velocity'>evaluate_velocity</span><span class='lparen'>(</span><span class='id identifier rubyid_developer'>developer</span><span class='rparen'>)</span>
    <span class='comment'>#...
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>

<p>It&#39;s possible to stack callbacks by passing them as an array. Example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Project</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:developers</span><span class='comma'>,</span>
                          <span class='label'>after_add:</span> <span class='lbracket'>[</span><span class='symbol'>:evaluate_velocity</span><span class='comma'>,</span> <span class='const'>Proc</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_p'>p</span><span class='comma'>,</span> <span class='id identifier rubyid_d'>d</span><span class='op'>|</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_shipping_date'>shipping_date</span> <span class='op'>=</span> <span class='const'><a href="../../Time.html" title="Time (class)">Time</a></span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rbrace'>}</span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</code></pre>

<p>Possible callbacks are: <code>before_add</code>, <code>after_add</code>,
<code>before_remove</code> and <code>after_remove</code>.</p>

<p>If any of the <code>before_add</code> callbacks throw an exception, the
object will not be added to the collection.</p>

<p>Similarly, if any of the <code>before_remove</code> callbacks throw an
exception, the object will not be removed from the collection.</p>

<h3 id="label-Association+extensions">Association extensions</h3>

<p>The proxy objects that control the access to associations can be extended
through anonymous modules. This is especially beneficial for adding new
finders, creators, and other factory-type methods that are only used as
part of this association.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:people</span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_find_or_create_by_name'>find_or_create_by_name</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='id identifier rubyid_last_name'>last_name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span><span class='lparen'>(</span><span class='label'>first_name:</span> <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='label'>last_name:</span> <span class='id identifier rubyid_last_name'>last_name</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='const'>Account</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_people'>people</span><span class='period'>.</span><span class='id identifier rubyid_find_or_create_by_name'>find_or_create_by_name</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>David Heinemeier Hansson</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='comment'># =&gt; &quot;David&quot;
</span><span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_last_name'>last_name</span>  <span class='comment'># =&gt; &quot;Heinemeier Hansson&quot;
</span></code></pre>

<p>If you need to share the same extensions between many associations, you can
use a named extension module.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>FindOrCreateByNameExtension</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_find_or_create_by_name'>find_or_create_by_name</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='id identifier rubyid_last_name'>last_name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span><span class='lparen'>(</span><span class='label'>first_name:</span> <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='label'>last_name:</span> <span class='id identifier rubyid_last_name'>last_name</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:people</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_extending'>extending</span> <span class='const'>FindOrCreateByNameExtension</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Company</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:people</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_extending'>extending</span> <span class='const'>FindOrCreateByNameExtension</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<p>Some extensions can only be made to work with knowledge of the
association&#39;s internals. Extensions can access relevant state using the
following methods (where <code>items</code> is the name of the
association):</p>
<ul><li>
<p><code>record.association(:items).owner</code> - Returns the object the
association is part of.</p>
</li><li>
<p><code>record.association(:items).reflection</code> - Returns the reflection
object that describes the association.</p>
</li><li>
<p><code>record.association(:items).target</code> - Returns the associated
object for <code>#belongs_to</code> and <code>#has_one</code>, or the collection of associated
objects for #has_many and #has_and_belongs_to_many.</p>
</li></ul>

<p>However, inside the actual extension code, you will not have access to the
<code>record</code> as above. In this case, you can access
<code>proxy_association</code>. For example,
<code>record.association(:items)</code> and
<code>record.items.proxy_association</code> will return the same object,
allowing you to make calls like <code>proxy_association.owner</code> inside
association extensions.</p>

<h3 id="label-Association+Join+Models">Association Join Models</h3>

<p>Has Many associations can be configured with the <code>:through</code>
option to use an explicit join model to retrieve the data. This operates
similarly to a <code>#has_and_belongs_to_many</code> association. The advantage is
that you&#39;re able to add validations, callbacks, and extra attributes on
the join model. Consider the following schema:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:authorships</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:authorships</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Authorship</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:book</span>
<span class='kw'>end</span>

<span class='ivar'>@author</span> <span class='op'>=</span> <span class='const'>Author</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_authorships'>authorships</span><span class='period'>.</span><span class='id identifier rubyid_collect'>collect</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_book'>book</span> <span class='rbrace'>}</span> <span class='comment'># selects all books that the author&#39;s authorships belong to
</span><span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span>                              <span class='comment'># selects all books by using the Authorship join model
</span></code></pre>

<p>You can also go through a <code>#has_many</code> association on the join model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Firm</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span>   <span class='symbol'>:clients</span>
  <span class='id identifier rubyid_has_many'>has_many</span>   <span class='symbol'>:invoices</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:clients</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Client</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:firm</span>
  <span class='id identifier rubyid_has_many'>has_many</span>   <span class='symbol'>:invoices</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Invoice</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:client</span>
<span class='kw'>end</span>

<span class='ivar'>@firm</span> <span class='op'>=</span> <span class='const'>Firm</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='ivar'>@firm</span><span class='period'>.</span><span class='id identifier rubyid_clients'>clients</span><span class='period'>.</span><span class='id identifier rubyid_flat_map'>flat_map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_invoices'>invoices</span> <span class='rbrace'>}</span> <span class='comment'># select all invoices for all clients of the firm
</span><span class='ivar'>@firm</span><span class='period'>.</span><span class='id identifier rubyid_invoices'>invoices</span>                            <span class='comment'># selects all invoices by going through the Client join model
</span></code></pre>

<p>Similarly you can go through a <code>#has_one</code> association on the join model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Group</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span>   <span class='symbol'>:users</span>
  <span class='id identifier rubyid_has_many'>has_many</span>   <span class='symbol'>:avatars</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:users</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:group</span>
  <span class='id identifier rubyid_has_one'>has_one</span>    <span class='symbol'>:avatar</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Avatar</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:user</span>
<span class='kw'>end</span>

<span class='ivar'>@group</span> <span class='op'>=</span> <span class='const'>Group</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='ivar'>@group</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_collect'>collect</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_u'>u</span><span class='op'>|</span> <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_avatar'>avatar</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span> <span class='comment'># select all avatars for all users in the group
</span><span class='ivar'>@group</span><span class='period'>.</span><span class='id identifier rubyid_avatars'>avatars</span>                                <span class='comment'># selects all avatars by going through the User join model.
</span></code></pre>

<p>An important caveat with going through <code>#has_one</code> or <code>#has_many</code>
associations on the join model is that these associations are
<strong>read-only</strong>. For example, the following would not work
following the previous example:</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@group</span><span class='period'>.</span><span class='id identifier rubyid_avatars'>avatars</span> <span class='op'>&lt;&lt;</span> <span class='const'>Avatar</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>   <span class='comment'># this would work if User belonged_to Avatar rather than the other way around
</span><span class='ivar'>@group</span><span class='period'>.</span><span class='id identifier rubyid_avatars'>avatars</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='ivar'>@group</span><span class='period'>.</span><span class='id identifier rubyid_avatars'>avatars</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='rparen'>)</span>  <span class='comment'># so would this
</span></code></pre>

<h3 id="label-Setting+Inverses">Setting Inverses</h3>

<p>If you are using a <code>#belongs_to</code> on the join model, it is a good idea to
set the <code>:inverse_of</code> option on the <code>#belongs_to</code>, which will
mean that the following example works correctly (where <code>tags</code> is
a <code>#has_many</code> <code>:through</code> association):</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@post</span> <span class='op'>=</span> <span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='ivar'>@tag</span> <span class='op'>=</span> <span class='ivar'>@post</span><span class='period'>.</span><span class='id identifier rubyid_tags'>tags</span><span class='period'>.</span><span class='id identifier rubyid_build'>build</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby</span><span class='tstring_end'>&quot;</span></span>
<span class='ivar'>@tag</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
</code></pre>

<p>The last line ought to save the through record (a <code>Tagging</code>).
This will only work if the <code>:inverse_of</code> is set:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Tagging</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:post</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:tag</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:taggings</span>
<span class='kw'>end</span>
</code></pre>

<p>If you do not set the <code>:inverse_of</code> record, the association will
do its best to match itself up with the correct inverse. Automatic inverse
detection only works on <code>#has_many</code>, <code>#has_one</code>, and <code>#belongs_to</code>
associations.</p>

<p>Extra options on the associations, as defined in the
<code>AssociationReflection::INVALID_AUTOMATIC_INVERSE_OPTIONS</code>
constant, will also prevent the association&#39;s inverse from being found
automatically.</p>

<p>The automatic guessing of the inverse association uses a heuristic based on
the name of the class, so it may not work for all associations, especially
the ones with non-standard names.</p>

<p>You can turn off the automatic detection of inverse associations by setting
the <code>:inverse_of</code> option to <code>false</code> like so:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Tagging</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:tag</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='kw'>false</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="label-Nested+Associations">Nested Associations</h3>

<p>You can actually specify <strong>any</strong> association with the
<code>:through</code> option, including an association which has a
<code>:through</code> option itself. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:posts</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:comments</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:posts</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:commenters</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:comments</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:comments</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Comment</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:commenter</span>
<span class='kw'>end</span>

<span class='ivar'>@author</span> <span class='op'>=</span> <span class='const'>Author</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_commenters'>commenters</span> <span class='comment'># =&gt; People who commented on posts written by the author
</span></code></pre>

<p>An equivalent way of setting up this association this would be:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:posts</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:commenters</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:posts</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:comments</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:commenters</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:comments</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Comment</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:commenter</span>
<span class='kw'>end</span>
</code></pre>

<p>When using a nested association, you will not be able to modify the
association because there is not enough information to know what
modification to make. For example, if you tried to add a
<code>Commenter</code> in the example above, there would be no way to tell
how to set up the intermediate <code>Post</code> and <code>Comment</code>
objects.</p>

<h3 id="label-Polymorphic+Associations">Polymorphic Associations</h3>

<p>Polymorphic associations on models are not restricted on what types of
models they can be associated with. Rather, they specify an interface that
a <code>#has_many</code> association must adhere to.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Asset</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:attachable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:assets</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbol'>:attachable</span>         <span class='comment'># The :as option specifies the polymorphic interface to use.
</span><span class='kw'>end</span>

<span class='ivar'>@asset</span><span class='period'>.</span><span class='id identifier rubyid_attachable'>attachable</span> <span class='op'>=</span> <span class='ivar'>@post</span>
</code></pre>

<p>This works by using a type column in addition to a foreign key to specify
the associated record. In the Asset example, you&#39;d need an
<code>attachable_id</code> integer column and an
<code>attachable_type</code> string column.</p>

<p>Using polymorphic associations in combination with single table inheritance
(STI) is a little tricky. In order for the associations to work as
expected, ensure that you store the base model for the STI models in the
type column of the polymorphic association. To continue with the asset
example above, suppose there are guest posts and member posts that use the
posts table for STI. In this case, there must be a <code>type</code> column
in the posts table.</p>

<p>Note: The <code>attachable_type=</code> method is being called when
assigning an <code>attachable</code>. The <code>class_name</code> of the
<code>attachable</code> is passed as a String.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Asset</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:attachable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_attachable_type='>attachable_type=</span><span class='lparen'>(</span><span class='id identifier rubyid_class_name'>class_name</span><span class='rparen'>)</span>
     <span class='kw'>super</span><span class='lparen'>(</span><span class='id identifier rubyid_class_name'>class_name</span><span class='period'>.</span><span class='id identifier rubyid_constantize'>constantize</span><span class='period'>.</span><span class='id identifier rubyid_base_class'>base_class</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='comment'># because we store &quot;Post&quot; in attachable_type now dependent: :destroy will work
</span>  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:assets</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbol'>:attachable</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:destroy</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>GuestPost</span> <span class='op'>&lt;</span> <span class='const'>Post</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>MemberPost</span> <span class='op'>&lt;</span> <span class='const'>Post</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="label-Caching">Caching</h3>

<p>All of the methods are built on a simple caching principle that will keep
the result of the last query around unless specifically instructed not to.
The cache is even shared across methods to make it even cheaper to use the
macro-added methods without worrying too much about performance at the
first go.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_milestones'>milestones</span>             <span class='comment'># fetches milestones from the database
</span><span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_milestones'>milestones</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>        <span class='comment'># uses the milestone cache
</span><span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_milestones'>milestones</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>      <span class='comment'># uses the milestone cache
</span><span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_milestones'>milestones</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>  <span class='comment'># fetches milestones from the database
</span><span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_milestones'>milestones</span>             <span class='comment'># uses the milestone cache
</span></code></pre>

<h3 id="label-Eager+loading+of+associations">Eager loading of associations</h3>

<p>Eager loading is a way to find objects of a certain class and a number of
named associations. It is one of the easiest ways to prevent the dreaded
N+1 problem in which fetching 100 posts that each need to display their
author triggers 101 database queries. Through the use of eager loading, the
number of queries will be reduced from 101 to 2.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
  <span class='id identifier rubyid_has_many'>has_many</span>   <span class='symbol'>:comments</span>
<span class='kw'>end</span>
</code></pre>

<p>Consider the following loop using the class above:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_post'>post</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Post:            </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_post'>post</span><span class='period'>.</span><span class='id identifier rubyid_title'>title</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Written by:      </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_post'>post</span><span class='period'>.</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Last comment on: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_post'>post</span><span class='period'>.</span><span class='id identifier rubyid_comments'>comments</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_created_on'>created_on</span>
<span class='kw'>end</span>
</code></pre>

<p>To iterate over these one hundred posts, we&#39;ll generate 201 database
queries. Let&#39;s first just optimize it for retrieving the author:</p>

<pre class="code ruby"><code class="ruby">Post.includes(:author).each do |post|</code></pre>

<p>This references the name of the <code>#belongs_to</code> association that also used
the <code>:author</code> symbol. After loading the posts, <code>find</code>
will collect the <code>author_id</code> from each one and load all of the
referenced authors with one query. Doing so will cut down the number of
queries from 201 to 102.</p>

<p>We can improve upon the situation further by referencing both associations
in the finder with:</p>

<pre class="code ruby"><code class="ruby">Post.includes(:author, :comments).each do |post|</code></pre>

<p>This will load all comments with a single query. This reduces the total
number of queries to 3. In general, the number of queries will be 1 plus
the number of associations named (except if some of the associations are
polymorphic <code>#belongs_to</code> - see below).</p>

<p>To include a deep hierarchy of associations, use a hash:</p>

<pre class="code ruby"><code class="ruby">Post.includes(:author, { comments: { author: :gravatar } }).each do |post|</code></pre>

<p>The above code will load all the comments and all of their associated
authors and gravatars. You can mix and match any combination of symbols,
arrays, and hashes to retrieve the associations you want to load.</p>

<p>All of this power shouldn&#39;t fool you into thinking that you can pull
out huge amounts of data with no performance penalty just because
you&#39;ve reduced the number of queries. The database still needs to send
all the data to Active Record and it still needs to be processed. So
it&#39;s no catch-all for performance problems, but it&#39;s a great way to
cut down on the number of queries in a situation as the one described
above.</p>

<p>Since only one table is loaded at a time, conditions or orders cannot
reference tables other than the main one. If this is the case, Active
Record falls back to the previously used <code>LEFT OUTER JOIN</code> based
strategy. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_includes'>includes</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='symbol'>:author</span><span class='comma'>,</span> <span class='symbol'>:comments</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>comments.approved = ?</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>true</span><span class='rbracket'>]</span><span class='rparen'>)</span>
</code></pre>

<p>This will result in a single SQL query with joins along the lines of:
<code>LEFT OUTER JOIN comments ON comments.post_id = posts.id</code> and
<code>LEFT OUTER JOIN authors ON authors.id = posts.author_id</code>. Note
that using conditions like this can have unintended consequences. In the
above example, posts with no approved comments are not returned at all
because the conditions apply to the SQL statement as a whole and not just
to the association.</p>

<p>You must disambiguate column references for this fallback to happen, for
example <code>order: &quot;author.name DESC&quot;</code> will work but
<code>order: &quot;name DESC&quot;</code> will not.</p>

<p>If you want to load all posts (including posts with no approved comments),
then write your own <code>LEFT OUTER JOIN</code> query using
<code>ON</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LEFT OUTER JOIN comments ON comments.post_id = posts.id AND comments.approved = &#39;1&#39;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
</code></pre>

<p>In this case, it is usually more natural to include an association which
has conditions defined on it:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Post</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:approved_comments</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>approved:</span> <span class='kw'>true</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Comment</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_includes'>includes</span><span class='lparen'>(</span><span class='symbol'>:approved_comments</span><span class='rparen'>)</span>
</code></pre>

<p>This will load posts and eager load the <code>approved_comments</code>
association, which contains only those comments that have been approved.</p>

<p>If you eager load an association with a specified <code>:limit</code>
option, it will be ignored, returning all the associated objects:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Picture</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:most_recent_comments</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_order'>order</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>id DESC</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_limit'>limit</span><span class='lparen'>(</span><span class='int'>10</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Comment</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='const'>Picture</span><span class='period'>.</span><span class='id identifier rubyid_includes'>includes</span><span class='lparen'>(</span><span class='symbol'>:most_recent_comments</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_most_recent_comments'>most_recent_comments</span> <span class='comment'># =&gt; returns all associated comments.
</span></code></pre>

<p>Eager loading is supported with polymorphic associations.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Address</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:addressable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</code></pre>

<p>A call that tries to eager load the addressable model</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Address</span><span class='period'>.</span><span class='id identifier rubyid_includes'>includes</span><span class='lparen'>(</span><span class='symbol'>:addressable</span><span class='rparen'>)</span>
</code></pre>

<p>This will execute one query to load the addresses and load the addressables
with one query per addressable type. For example, if all the addressables
are either of class Person or Company, then a total of 3 queries will be
executed. The list of addressable types to load is determined on the back
of the addresses loaded. This is not supported if Active Record has to
fallback to the previous implementation of eager loading and will raise
<a href="../EagerLoadPolymorphicError.html" title="ActiveRecord::EagerLoadPolymorphicError (class)">EagerLoadPolymorphicError</a>. The reason is that the parent
model&#39;s type is a column value so its corresponding table name cannot
be put in the <code>FROM</code>/<code>JOIN</code> clauses of that query.</p>

<h3 id="label-Table+Aliasing">Table Aliasing</h3>

<p>Active Record uses table aliasing in the case that a table is referenced
multiple times in a join. If a table is referenced only once, the standard
table name is used. The second time, the table is aliased as
<code>#{reflection_name}_#{parent_table_name}</code>. Indexes are appended
for any more successive uses of the table name.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='symbol'>:comments</span><span class='rparen'>)</span>
<span class='comment'># =&gt; SELECT ... FROM posts INNER JOIN comments ON ...
</span><span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='symbol'>:special_comments</span><span class='rparen'>)</span> <span class='comment'># STI
</span><span class='comment'># =&gt; SELECT ... FROM posts INNER JOIN comments ON ... AND comments.type = &#39;SpecialComment&#39;
</span><span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='symbol'>:comments</span><span class='comma'>,</span> <span class='symbol'>:special_comments</span><span class='rparen'>)</span> <span class='comment'># special_comments is the reflection name, posts is the parent table name
</span><span class='comment'># =&gt; SELECT ... FROM posts INNER JOIN comments ON ... INNER JOIN comments special_comments_posts
</span></code></pre>

<p>Acts as tree example:</p>

<pre class="code ruby"><code class="ruby">TreeMixin.joins(:children)
# =&gt; SELECT ... FROM mixins INNER JOIN mixins childrens_mixins ...
TreeMixin.joins(children: :parent)
# =&gt; SELECT ... FROM mixins INNER JOIN mixins childrens_mixins ...
                            INNER JOIN parents_mixins ...
TreeMixin.joins(children: {parent: :children})
# =&gt; SELECT ... FROM mixins INNER JOIN mixins childrens_mixins ...
                            INNER JOIN parents_mixins ...
                            INNER JOIN mixins childrens_mixins_2</code></pre>

<p>Has and Belongs to Many join tables use the same idea, but add a
<code>_join</code> suffix:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='symbol'>:categories</span><span class='rparen'>)</span>
<span class='comment'># =&gt; SELECT ... FROM posts INNER JOIN categories_posts ... INNER JOIN categories ...
</span><span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='label'>categories:</span> <span class='symbol'>:posts</span><span class='rparen'>)</span>
<span class='comment'># =&gt; SELECT ... FROM posts INNER JOIN categories_posts ... INNER JOIN categories ...
</span>                           <span class='const'>INNER</span> <span class='const'>JOIN</span> <span class='id identifier rubyid_categories_posts'>categories_posts</span> <span class='id identifier rubyid_posts_categories_join'>posts_categories_join</span> <span class='const'>INNER</span> <span class='const'>JOIN</span> <span class='id identifier rubyid_posts'>posts</span> <span class='id identifier rubyid_posts_categories'>posts_categories</span>
<span class='const'>Post</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='label'>categories:</span> <span class='lbrace'>{</span><span class='label'>posts:</span> <span class='symbol'>:categories</span><span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='comment'># =&gt; SELECT ... FROM posts INNER JOIN categories_posts ... INNER JOIN categories ...
</span>                           <span class='const'>INNER</span> <span class='const'>JOIN</span> <span class='id identifier rubyid_categories_posts'>categories_posts</span> <span class='id identifier rubyid_posts_categories_join'>posts_categories_join</span> <span class='const'>INNER</span> <span class='const'>JOIN</span> <span class='id identifier rubyid_posts'>posts</span> <span class='id identifier rubyid_posts_categories'>posts_categories</span>
                           <span class='const'>INNER</span> <span class='const'>JOIN</span> <span class='id identifier rubyid_categories_posts'>categories_posts</span> <span class='id identifier rubyid_categories_posts_join'>categories_posts_join</span> <span class='const'>INNER</span> <span class='const'>JOIN</span> <span class='id identifier rubyid_categories'>categories</span> <span class='id identifier rubyid_categories_posts_2'>categories_posts_2</span>
</code></pre>

<p>If you wish to specify your own custom joins using
<a href="../QueryMethods.html#joins-instance_method" title="ActiveRecord::QueryMethods#joins (method)">QueryMethods#joins</a> method, those table names will take
precedence over the eager associations:</p>

<pre class="code ruby"><code class="ruby">Post.joins(:comments).joins(&quot;inner join comments ...&quot;)
# =&gt; SELECT ... FROM posts INNER JOIN comments_posts ON ... INNER JOIN comments ...
Post.joins(:comments, :special_comments).joins(&quot;inner join comments ...&quot;)
# =&gt; SELECT ... FROM posts INNER JOIN comments comments_posts ON ...
                           INNER JOIN comments special_comments_posts ...
                           INNER JOIN comments ...</code></pre>

<p>Table aliases are automatically truncated according to the maximum length
of table identifiers according to the specific database.</p>

<h3 id="label-Modules">Modules</h3>

<p>By default, associations will look for objects within the current module
scope. Consider:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>MyApplication</span>
  <span class='kw'>module</span> <span class='const'>Business</span>
    <span class='kw'>class</span> <span class='const'>Firm</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
      <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:clients</span>
    <span class='kw'>end</span>

    <span class='kw'>class</span> <span class='const'>Client</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span><span class='semicolon'>;</span> <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>When <code>Firm#clients</code> is called, it will in turn call
<code>MyApplication::Business::Client.find_all_by_firm_id(firm.id)</code>.
If you want to associate with a class in another module scope, this can be
done by specifying the complete class name.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>MyApplication</span>
  <span class='kw'>module</span> <span class='const'>Business</span>
    <span class='kw'>class</span> <span class='const'>Firm</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span><span class='semicolon'>;</span> <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>module</span> <span class='const'>Billing</span>
    <span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
      <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:firm</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MyApplication::Business::Firm</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="label-Bi-directional+associations">Bi-directional associations</h3>

<p>When you specify an association, there is usually an association on the
associated model that specifies the same relationship in reverse. For
example, with the following models:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Dungeon</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:traps</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:evil_wizard</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Trap</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:dungeon</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>EvilWizard</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:dungeon</span>
<span class='kw'>end</span>
</code></pre>

<p>The <code>traps</code> association on <code>Dungeon</code> and the
<code>dungeon</code> association on <code>Trap</code> are the inverse of
each other, and the inverse of the <code>dungeon</code> association on
<code>EvilWizard</code> is the <code>evil_wizard</code> association on
<code>Dungeon</code> (and vice-versa). By default, Active Record can guess
the inverse of the association based on the name of the class. The result
is the following:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_d'>d</span> <span class='op'>=</span> <span class='const'>Dungeon</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_traps'>traps</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_object_id'>object_id</span> <span class='op'>==</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_dungeon'>dungeon</span><span class='period'>.</span><span class='id identifier rubyid_object_id'>object_id</span> <span class='comment'># =&gt; true
</span></code></pre>

<p>The <code>Dungeon</code> instances <code>d</code> and
<code>t.dungeon</code> in the above example refer to the same in-memory
instance since the association matches the name of the class. The result
would be the same if we added <code>:inverse_of</code> to our model
definitions:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Dungeon</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:traps</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:dungeon</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:evil_wizard</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:dungeon</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Trap</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:dungeon</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:traps</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>EvilWizard</span> <span class='op'>&lt;</span> <span class='const'><a href="../../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a></span><span class='op'>::</span><span class='const'><a href="../Base.html" title="ActiveRecord::Base (class)">Base</a></span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:dungeon</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:evil_wizard</span>
<span class='kw'>end</span>
</code></pre>

<p>There are limitations to <code>:inverse_of</code> support:</p>
<ul><li>
<p>does not work with <code>:through</code> associations.</p>
</li><li>
<p>does not work with <code>:polymorphic</code> associations.</p>
</li><li>
<p>inverse associations for <code>#belongs_to</code> associations <code>#has_many</code> are
ignored.</p>
</li></ul>

<p>For more information, see the documentation for the
<code>:inverse_of</code> option.</p>

<h3 id="label-Deleting+from+associations">Deleting from associations</h3>

<h4 id="label-Dependent+associations">Dependent associations</h4>

<p><code>#has_many</code>, <code>#has_one</code>, and <code>#belongs_to</code> associations support the
<code>:dependent</code> option. This allows you to specify that associated
records should be deleted when the owner is deleted.</p>

<p>For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:posts</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:destroy</span>
<span class='kw'>end</span>
<span class='const'>Author</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span> <span class='comment'># =&gt; Will destroy all of the author&#39;s posts, too
</span></code></pre>

<p>The <code>:dependent</code> option can have different values which specify
how the deletion is done. For more information, see the documentation for
this option on the different specific association types. When no option is
given, the behavior is to do nothing with the associated records when
destroying a record.</p>

<p>Note that <code>:dependent</code> is implemented using Rails&#39; callback
system, which works by processing callbacks in order. Therefore, other
callbacks declared either before or after the <code>:dependent</code>
option can affect what it does.</p>

<p>Note that <code>:dependent</code> option is ignored for <code>#has_one</code>
<code>:through</code> associations.</p>

<h4 id="label-Delete+or+destroy-3F">Delete or destroy?</h4>

<p><code>#has_many</code> and <code>#has_and_belongs_to_many</code> associations have the methods
<code>destroy</code>, <code>delete</code>, <code>destroy_all</code> and
<code>delete_all</code>.</p>

<p>For <code>#has_and_belongs_to_many</code>, <code>delete</code> and
<code>destroy</code> are the same: they cause the records in the join table
to be removed.</p>

<p>For <code>#has_many</code>, <code>destroy</code> and <code>destroy_all</code> will
always call the <code>destroy</code> method of the record(s) being removed
so that callbacks are run. However <code>delete</code> and
<code>delete_all</code> will either do the deletion according to the
strategy specified by the <code>:dependent</code> option, or if no
<code>:dependent</code> option is given, then it will follow the default
strategy. The default strategy is to do nothing (leave the foreign keys
with the parent ids set), except for <code>#has_many</code> <code>:through</code>,
where the default strategy is <code>delete_all</code> (delete the join
records, without running their callbacks).</p>

<p>There is also a <code>clear</code> method which is the same as
<code>delete_all</code>, except that it returns the association rather than
the records which have been deleted.</p>

<h4 id="label-What+gets+deleted-3F">What gets deleted?</h4>

<p>There is a potential pitfall here: <code>#has_and_belongs_to_many</code> and
<code>#has_many</code> <code>:through</code> associations have records in join tables,
as well as the associated records. So when we call one of these deletion
methods, what exactly should be deleted?</p>

<p>The answer is that it is assumed that deletion on an association is about
removing the <em>link</em> between the owner and the associated object(s),
rather than necessarily the associated objects themselves. So with
<code>#has_and_belongs_to_many</code> and <code>#has_many</code> <code>:through</code>, the join
records will be deleted, but the associated records won&#39;t.</p>

<p>This makes sense if you think about it: if you were to call
<code>post.tags.delete(Tag.find_by(name: &#39;food&#39;))</code> you would
want the &#39;food&#39; tag to be unlinked from the post, rather than for
the tag itself to be removed from the database.</p>

<p>However, there are examples where this strategy doesn&#39;t make sense. For
example, suppose a person has many projects, and each project has many
tasks. If we deleted one of a person&#39;s tasks, we would probably not
want the project to be deleted. In this scenario, the delete method
won&#39;t actually work: it can only be used if the association on the join
model is a <code>#belongs_to</code>. In other situations you are expected to perform
operations directly on either the associated records or the
<code>:through</code> association.</p>

<p>With a regular <code>#has_many</code> there is no distinction between the “associated
records” and the “link”, so there is only one choice for what gets deleted.</p>

<p>With <code>#has_and_belongs_to_many</code> and <code>#has_many</code> <code>:through</code>, if
you want to delete the associated records themselves, you can always do
something along the lines of <code>person.tasks.each(&amp;:destroy)</code>.</p>

<h3 id="label-Type+safety+with+-7BActiveRecord-3A-3AAssociationTypeMismatch-7D">Type safety with <a href="../AssociationTypeMismatch.html" title="ActiveRecord::AssociationTypeMismatch (class)">ActiveRecord::AssociationTypeMismatch</a></h3>

<p>If you attempt to assign an object to an association that doesn&#39;t match
the inferred or specified <code>:class_name</code>, you&#39;ll get an
<a href="../AssociationTypeMismatch.html" title="ActiveRecord::AssociationTypeMismatch (class)">ActiveRecord::AssociationTypeMismatch</a>.</p>

<h3 id="label-Options">Options</h3>

<p>All of the association macros can be specialized through options. This
makes cases more complex than the simple and guessable ones possible.</p>


  </div>
</div>
<div class="tags">
  
</div>






<div id='footer'>
  Generated by
  <a href='http://yardoc.org' title='Yay! A Ruby Documentation Tool' target="_parent">yard</a>
  0.9.5 with <a href='https://msp-greg.github.io/yard-t2/' title='yard-t2' target="_parent">yard-t2</a> 0.6.0 (ruby-2.3.2p135)
</div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</div> <!-- tbl_cont -->
</body>
</html>