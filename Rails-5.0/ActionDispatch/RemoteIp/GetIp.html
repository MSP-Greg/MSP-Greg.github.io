<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: ActionDispatch::RemoteIp::GetIp &mdash; Rails-5.0.0</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/custom.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/common.css' />

<script type='text/javascript'>
  var pathId = "ActionDispatch::RemoteIp::GetIp",
    relpath = '../../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
  <svg id='y_wait' class='' viewBox='0 0 90 90'></svg>
  <div id='tbl_cont'>
    <div id='y_list' class='d h'>
      <button id='list_sizer' class='y_sizer' title='LIST Resizer'></button>
      <header id='list_header'>
        <div id='list_title'>&#160;</div>
        <div id='list_menu'><span>&#160;</span></div>
        <input  id='list_search_text' type='search' placeholder='Search' size='12' value='' autocomplete='off' class='search_input'/>
        <svg id='list_search_icon' viewBox='0 0 30 30'>
          <path class='s_main' d='M21.189,17.213C22.022,15.726,22.5,14.014,22.5,12.188C22.5,6.493,17.884,1.875,12.188,1.875S1.875,6.493,1.875,12.188C1.875,17.882,6.491,22.5,12.188,22.5c1.826,0,3.536-0.48,5.025-1.311l6.113,6.113C23.873,27.851,24.593,28.125,25.313,28.125s1.44-0.274,1.989-0.823c1.099-1.099,1.099-2.878,0-3.977L21.189,17.213z M12.188,19.329c-3.943,0-7.14-3.197-7.14-7.142c0.0-3.943,3.197-7.14,7.14-7.14c3.941,0,7.14,3.195,7.14,7.14C19.328,16.133,16.129,19.329,12.188,19.329z'/>
          <path class='s_clear' d='M 4.414, 1.586 A 1,1 0 1,0 1.586, 4.414 L 21.586,24.414 A 1,1 0 1,0 24.414,21.586 z' />
          <path class='s_clear' d='M 1.586,21.586 A 1,1 0 1,0 4.414,24.414 L 24.414, 4.414 A 1,1 0 1,0 21.586, 1.586 z' />
        </svg>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All'></button>
      </header>
      <nav id= 'list_nav' class='y_nav l_nav'>
        <ul id='list_items'></ul>
      </nav>
    </div>
    <div id='y_toc' class='f h'>
      <button id='toc_sizer' class='y_sizer' title='TOC Resizer'></button>
      <header id='toc_header'>
        <div>Table of Contents</div>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All' ></button>
      </header>
      <nav id= 'toc_nav' class='y_nav t_nav'>
      <ol id='toc_items'></ol>
      </nav>
    </div>
    <div id='y_main' tabindex='-1'>
      <header id='y_header'>
        <div id='y_menu'>
          <a href='../../../index.html'>Home</a> &raquo; 
          <a href='../../index.html'>Rails-5.0.0</a> &raquo; 
          <a href='../../_index.html'>Index (G)</a> &raquo; 
          <a href="../../ActionDispatch.html" title="ActionDispatch (module)">ActionDispatch</a> &raquo; 
          <a href="../RemoteIp.html" title="ActionDispatch::RemoteIp (class)">RemoteIp</a> &raquo; 
          <span class='title'>GetIp</span>
        </div>

        <div id='y_measure_em' class='y_measure'></div>
        <div id='y_measure_vh' class='y_measure'></div>
        <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
        <a id='list_href' href="../../class_list.html"></a>
        <div id='hdr_button'>
          <button id='src' class='c' title='Source Show / Hide'>S<svg class='c' viewBox='0 0 36 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
              <rect x='20' y='0'  width='4'  height='28' rx='1.0' ry='1.0'/>
            </svg><svg class='o' viewBox='0 0 34 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
            </svg></button>
          <button id='list_loc' class='d' title='LIST Location'>L<svg class='f' viewBox='0 0 36 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='toc_loc' class='f' title='TOC Location'>T<svg class='f' viewBox='0 0 34 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='list_vis' title='LIST Show / Hide'>LIST</button>
          <button id='toc_vis' title='TOC Show / Hide'>TOC</button>
        </div>
        <div id='y_debug'></div>
      </header>
<div id='content' class='class'>

<h1>Class: ActionDispatch::RemoteIp::GetIp</h1>

<table class='y_box'>
<colgroup>
  <col class='box_1' />
  <col class='box_2' />
</colgroup>
  <tr>
    <td class='box_1'>Inherits:</td>
    <td class='box_rel'>
      <span class='inheritName'><a href="../../Object.html" title="Object (class)">Object</a></span>
      <ul class='fullTree'>
        <li><a href="../../Object.html" title="Object (class)">Object</a></li>
        <li class='next'>ActionDispatch::RemoteIp::GetIp</li>
      </ul>
      <a href='#' class='inheritanceTree'>show all</a>
    </td>
  </tr>





  <tr>
  <td class='box_1'>Defined in:</td>
  <td class='box_rel'><div class='box_min'>
actionpack/lib/action_dispatch/middleware/remote_ip.rb</div>  </td>
  </tr>
</table>
<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>The GetIp class exists as a way to defer processing of the request data
into an actual IP address. If the <a href="../Request.html#remote_ip-instance_method" title="ActionDispatch::Request#remote_ip (method)">ActionDispatch::Request#remote_ip</a>
method is called, this class will calculate the value and then memoize it.</p>


  </div>
</div>
<div class="tags">
  
</div>




<h2>Class Method Summary
  <small><a href='#' class='summary_toggle'>collapse</a></small>
</h2>

  <ul class='summary'>
    <li>
      <span class="summary_signature">
        <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(req, check_ip, proxies)  &#x21d2; GetIp </a>
      </span>
      <span class='note title constructor'>constructor</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>a new instance of GetIp</p>
</div>
      </span>
    </li>
  </ul>
<h2>Instance Method Summary
  <small><a href='#' class='summary_toggle'>collapse</a></small>
</h2>

  <ul class='summary'>
    <li>
      <span class="summary_signature">
        <a href="#calculate_ip-instance_method" title="#calculate_ip (instance method)">#<strong>calculate_ip</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Sort through the various IP address headers, looking for the IP most likely
to be the address of the actual remote client making this request.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#to_s-instance_method" title="#to_s (instance method)">#<strong>to_s</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Memoizes the value returned by <a href="#calculate_ip-instance_method" title="ActionDispatch::RemoteIp::GetIp#calculate_ip (method)">#calculate_ip</a> and returns it for
<a href="../Request.html" title="ActionDispatch::Request (class)">ActionDispatch::Request</a> to use.</p>
</div>
      </span>
    </li>
  </ul>


<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>
  <section class='method_details first' id="new-class_method">
  <h3 class='signature first'>
  .<strong>new</strong>(req, check_ip, proxies)  &#x21d2; <tt><a href="" title="ActionDispatch::RemoteIp::GetIp (class)">GetIp</a></tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>a new instance of GetIp</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


86
87
88
89
90</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'actionpack/lib/action_dispatch/middleware/remote_ip.rb', line 86</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_req'>req</span><span class='comma'>,</span> <span class='id identifier rubyid_check_ip'>check_ip</span><span class='comma'>,</span> <span class='id identifier rubyid_proxies'>proxies</span><span class='rparen'>)</span>
  <span class='ivar'>@req</span>      <span class='op'>=</span> <span class='id identifier rubyid_req'>req</span>
  <span class='ivar'>@check_ip</span> <span class='op'>=</span> <span class='id identifier rubyid_check_ip'>check_ip</span>
  <span class='ivar'>@proxies</span>  <span class='op'>=</span> <span class='id identifier rubyid_proxies'>proxies</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
<h2 class='y_details'>Instance Method Details</h2>
  <section class='method_details first' id="calculate_ip-instance_method">
  <h3 class='signature first'>
  #<strong>calculate_ip</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Sort through the various IP address headers, looking for the IP most likely
to be the address of the actual remote client making this request.</p>

<p>REMOTE_ADDR will be correct if the request is made directly against the
Ruby process, on e.g. Heroku. When the request is proxied by another server
like HAProxy or NGINX, the IP address that made the original request will
be put in an X-Forwarded-For header. If there are multiple proxies, that
header may contain a list of IPs. Other proxy services set the Client-Ip
header instead, so we check that too.</p>

<p>As discussed in <code>this</code>[<a
href="http://blog.gingerlime.com/2012/rails-ip-spoofing-vulnerabilities-and-protection">blog.gingerlime.com/2012/rails-ip-spoofing-vulnerabilities-and-protection</a>/],
while the first IP in the list is likely to be the “originating” IP, it
could also have been set by the client maliciously.</p>

<p>In order to find the first address that is (probably) accurate, we take the
list of IPs, remove known and trusted proxies, and then take the last
address left, which was presumably set by one of those proxies.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'actionpack/lib/action_dispatch/middleware/remote_ip.rb', line 110</span>

<span class='kw'>def</span> <span class='id identifier rubyid_calculate_ip'>calculate_ip</span>
  <span class='comment'># Set by the Rack web server, this is a single value.
</span>  <span class='id identifier rubyid_remote_addr'>remote_addr</span> <span class='op'>=</span> <span class='id identifier rubyid_ips_from'>ips_from</span><span class='lparen'>(</span><span class='ivar'>@req</span><span class='period'>.</span><span class='id identifier rubyid_remote_addr'>remote_addr</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span>

  <span class='comment'># Could be a CSV list and/or repeated headers that were concatenated.
</span>  <span class='id identifier rubyid_client_ips'>client_ips</span>    <span class='op'>=</span> <span class='id identifier rubyid_ips_from'>ips_from</span><span class='lparen'>(</span><span class='ivar'>@req</span><span class='period'>.</span><span class='id identifier rubyid_client_ip'>client_ip</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_reverse'>reverse</span>
  <span class='id identifier rubyid_forwarded_ips'>forwarded_ips</span> <span class='op'>=</span> <span class='id identifier rubyid_ips_from'>ips_from</span><span class='lparen'>(</span><span class='ivar'>@req</span><span class='period'>.</span><span class='id identifier rubyid_x_forwarded_for'>x_forwarded_for</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_reverse'>reverse</span>

  <span class='comment'># Client-Ip and X-Forwarded-For should not, generally, both be set.
</span>  <span class='comment'># If they are both set, it means that either:
</span>  <span class='comment'>#
</span>  <span class='comment'># 1) This request passed through two proxies with incompatible IP header
</span>  <span class='comment'>#    conventions.
</span>  <span class='comment'># 2) The client passed one of Client-Ip or X-Forwarded-For
</span>  <span class='comment'>#    (whichever the proxy servers weren&#39;t using) themselves.
</span>  <span class='comment'>#
</span>  <span class='comment'># Either way, there is no way for us to determine which header is the
</span>  <span class='comment'># right one after the fact. Since we have no idea, if we are concerned
</span>  <span class='comment'># about IP spoofing we need to give up and explode. (If you&#39;re not
</span>  <span class='comment'># concerned about IP spoofing you can turn the ip_spoofing_check
</span>  <span class='comment'># option off.)
</span>  <span class='id identifier rubyid_should_check_ip'>should_check_ip</span> <span class='op'>=</span> <span class='ivar'>@check_ip</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_client_ips'>client_ips</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_forwarded_ips'>forwarded_ips</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_should_check_ip'>should_check_ip</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_forwarded_ips'>forwarded_ips</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_client_ips'>client_ips</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='rparen'>)</span>
    <span class='comment'># We don&#39;t know which came from the proxy, and which from the user
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>IpSpoofAttackError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>IP spoofing attack?! </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HTTP_CLIENT_IP=</span><span class='embexpr_beg'>#{</span><span class='ivar'>@req</span><span class='period'>.</span><span class='id identifier rubyid_client_ip'>client_ip</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HTTP_X_FORWARDED_FOR=</span><span class='embexpr_beg'>#{</span><span class='ivar'>@req</span><span class='period'>.</span><span class='id identifier rubyid_x_forwarded_for'>x_forwarded_for</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># We assume these things about the IP headers:
</span>  <span class='comment'>#
</span>  <span class='comment'>#   - X-Forwarded-For will be a list of IPs, one per proxy, or blank
</span>  <span class='comment'>#   - Client-Ip is propagated from the outermost proxy, or is blank
</span>  <span class='comment'>#   - REMOTE_ADDR will be the IP that made the request to Rack
</span>  <span class='id identifier rubyid_ips'>ips</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_forwarded_ips'>forwarded_ips</span><span class='comma'>,</span> <span class='id identifier rubyid_client_ips'>client_ips</span><span class='comma'>,</span> <span class='id identifier rubyid_remote_addr'>remote_addr</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>

  <span class='comment'># If every single IP option is in the trusted list, just return REMOTE_ADDR
</span>  <span class='id identifier rubyid_filter_proxies'>filter_proxies</span><span class='lparen'>(</span><span class='id identifier rubyid_ips'>ips</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='op'>||</span> <span class='id identifier rubyid_remote_addr'>remote_addr</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="to_s-instance_method">
  <h3 class='signature'>
  #<strong>to_s</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Memoizes the value returned by <a href="#calculate_ip-instance_method" title="ActionDispatch::RemoteIp::GetIp#calculate_ip (method)">#calculate_ip</a> and returns it for
<a href="../Request.html" title="ActionDispatch::Request (class)">ActionDispatch::Request</a> to use.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


152
153
154</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'actionpack/lib/action_dispatch/middleware/remote_ip.rb', line 152</span>

<span class='kw'>def</span> <span class='id identifier rubyid_to_s'>to_s</span>
  <span class='ivar'>@ip</span> <span class='op'>||=</span> <span class='id identifier rubyid_calculate_ip'>calculate_ip</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<div id='footer'>
  Generated by
  <a href='http://yardoc.org' title='Yay! A Ruby Documentation Tool' target="_parent">yard</a>
  0.9.0 with <a href='https://msp-greg.github.io/yard-t2/' title='yard-t2' target="_parent">yard-t2</a> 0.6.0 (ruby-2.3.2p135)
</div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</div> <!-- tbl_cont -->
</body>
</html>