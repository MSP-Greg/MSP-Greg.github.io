<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Association Basics &mdash; Rails-5.0.0</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />
<link rel='stylesheet'  type='text/css' href='../css/custom.css' />
<link rel='stylesheet'  type='text/css' href='../css/common.css' />

<script type='text/javascript'>
  var pathId = "association_basics",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
  <svg id='y_wait' class='' viewBox='0 0 90 90'></svg>
  <div id='tbl_cont'>
    <div id='y_list' class='d h'>
      <button id='list_sizer' class='y_sizer' title='LIST Resizer'></button>
      <header id='list_header'>
        <div id='list_title'>&#160;</div>
        <div id='list_menu'><span>&#160;</span></div>
        <input  id='list_search_text' type='search' placeholder='Search' size='12' value='' autocomplete='off' class='search_input'/>
        <svg id='list_search_icon' viewBox='0 0 30 30'>
          <path class='s_main' d='M21.189,17.213C22.022,15.726,22.5,14.014,22.5,12.188C22.5,6.493,17.884,1.875,12.188,1.875S1.875,6.493,1.875,12.188C1.875,17.882,6.491,22.5,12.188,22.5c1.826,0,3.536-0.48,5.025-1.311l6.113,6.113C23.873,27.851,24.593,28.125,25.313,28.125s1.44-0.274,1.989-0.823c1.099-1.099,1.099-2.878,0-3.977L21.189,17.213z M12.188,19.329c-3.943,0-7.14-3.197-7.14-7.142c0.0-3.943,3.197-7.14,7.14-7.14c3.941,0,7.14,3.195,7.14,7.14C19.328,16.133,16.129,19.329,12.188,19.329z'/>
          <path class='s_clear' d='M 4.414, 1.586 A 1,1 0 1,0 1.586, 4.414 L 21.586,24.414 A 1,1 0 1,0 24.414,21.586 z' />
          <path class='s_clear' d='M 1.586,21.586 A 1,1 0 1,0 4.414,24.414 L 24.414, 4.414 A 1,1 0 1,0 21.586, 1.586 z' />
        </svg>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All'></button>
      </header>
      <nav id= 'list_nav' class='y_nav l_nav'>
        <ul id='list_items'></ul>
      </nav>
    </div>
    <div id='y_toc' class='f h'>
      <button id='toc_sizer' class='y_sizer' title='TOC Resizer'></button>
      <header id='toc_header'>
        <div>Table of Contents</div>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All' ></button>
      </header>
      <nav id= 'toc_nav' class='y_nav t_nav'>
      <ol id='toc_items'></ol>
      </nav>
    </div>
    <div id='y_main' tabindex='-1'>
      <header id='y_header'>
        <div id='y_menu'>
          <a href='../index.html'>Home</a> &raquo; 
          <a href='index.html'>Rails-5.0.0</a> &raquo; 
          <a href='_index.html'>Index</a> &raquo; 
          <span class='title'>File: Association Basics</span>
                </div>

        <div id='y_measure_em' class='y_measure'></div>
        <div id='y_measure_vh' class='y_measure'></div>
        <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
        <a id='list_href' href="file_list.html"></a>
        <div id='hdr_button'>
          <button id='src' class='c' title='Source Show / Hide'>S<svg class='c' viewBox='0 0 36 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
              <rect x='20' y='0'  width='4'  height='28' rx='1.0' ry='1.0'/>
            </svg><svg class='o' viewBox='0 0 34 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
            </svg></button>
          <button id='list_loc' class='d' title='LIST Location'>L<svg class='f' viewBox='0 0 36 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='toc_loc' class='f' title='TOC Location'>T<svg class='f' viewBox='0 0 34 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='list_vis' title='LIST Show / Hide'>LIST</button>
          <button id='toc_vis' title='TOC Show / Hide'>TOC</button>
        </div>
        <div id='y_debug'></div>
      </header>
<div id='content' class='file'>
<p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="http://guides.rubyonrails.org">http://guides.rubyonrails.org</a>.</strong></p>

<h1>Active Record Associations</h1>

<p>This guide covers the association features of Active Record.</p>

<p>After reading this guide, you will know:</p>

<ul>
<li>How to declare associations between Active Record models.</li>
<li>How to understand the various types of Active Record associations.</li>
<li>How to use the methods added to your models by creating associations.</li>
</ul>

<hr>

<h2>Why Associations?</h2>

<p>In Rails, an <em>association</em> is a connection between two Active Record models. Why do we need associations between models? Because they make common operations simpler and easier in your code. For example, consider a simple Rails application that includes a model for authors and a model for books. Each author can have many books. Without associations, the model declarations would look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
<span class='kw'>end</span>
</code></pre>

<p>Now, suppose we wanted to add a new book for an existing author. We&#39;d need to do something like this:</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@book</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>published_at:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='comma'>,</span> <span class='label'>author_id:</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
</code></pre>

<p>Or consider deleting an author, and ensuring that all of its books get deleted as well:</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@books</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>author_id:</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
<span class='ivar'>@books</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_book'>book</span><span class='op'>|</span>
  <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
<span class='kw'>end</span>
<span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
</code></pre>

<p>With Active Record associations, we can streamline these - and other - operations by declaratively telling Rails that there is a connection between the two models. Here&#39;s the revised code for setting up authors and books:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:destroy</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
<span class='kw'>end</span>
</code></pre>

<p>With this change, creating a new book for a particular author is easier:</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@book</span> <span class='op'>=</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>published_at:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span>
</code></pre>

<p>Deleting an author and all of its books is <em>much</em> easier:</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
</code></pre>

<p>To learn more about the different types of associations, read the next section of this guide. That&#39;s followed by some tips and tricks for working with associations, and then by a complete reference to the methods and options for associations in Rails.</p>

<h2>The Types of Associations</h2>

<p>Rails supports six types of associations:</p>

<ul>
<li><code>belongs_to</code></li>
<li><code>has_one</code></li>
<li><code>has_many</code></li>
<li><code>has_many :through</code></li>
<li><code>has_one :through</code></li>
<li><code>has_and_belongs_to_many</code></li>
</ul>

<p>Associations are implemented using macro-style calls, so that you can declaratively add features to your models. For example, by declaring that one model <code>belongs_to</code> another, you instruct Rails to maintain <a href="https://en.wikipedia.org/wiki/Unique_key">Primary Key</a>-<a href="https://en.wikipedia.org/wiki/Foreign_key">Foreign Key</a> information between instances of the two models, and you also get a number of utility methods added to your model.</p>

<p>In the remainder of this guide, you&#39;ll learn how to declare and use the various forms of associations. But first, a quick introduction to the situations where each association type is appropriate.</p>

<h3>The <code>belongs_to</code> Association</h3>

<p>A <code>belongs_to</code> association sets up a one-to-one connection with another model, such that each instance of the declaring model &quot;belongs to&quot; one instance of the other model. For example, if your application includes authors and books, and each book can be assigned to exactly one author, you&#39;d declare the book model this way:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
<span class='kw'>end</span>
</code></pre>

<p><img src="images/belongs_to.png" alt="belongs_to Association Diagram"></p>

<p>NOTE: <code>belongs_to</code> associations <em>must</em> use the singular term. If you used the pluralized form in the above example for the <code>author</code> association in the <code>Book</code> model, you would be told that there was an &quot;uninitialized constant Book::Authors&quot;. This is because Rails automatically infers the class name from the association name. If the association name is wrongly pluralized, then the inferred class will be wrongly pluralized too.</p>

<p>The corresponding migration might look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateBooks</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:authors</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:name</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:books</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_datetime'>datetime</span> <span class='symbol'>:published_at</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3>The <code>has_one</code> Association</h3>

<p>A <code>has_one</code> association also sets up a one-to-one connection with another model, but with somewhat different semantics (and consequences). This association indicates that each instance of a model contains or possesses one instance of another model. For example, if each supplier in your application has only one account, you&#39;d declare the supplier model like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span>
<span class='kw'>end</span>
</code></pre>

<p><img src="images/has_one.png" alt="has_one Association Diagram"></p>

<p>The corresponding migration might look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateSuppliers</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:suppliers</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:name</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:accounts</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:account_number</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Depending on the use case, you might also need to create a unique index and/or
a foreign key constraint on the supplier column for the accounts table. In this
case, the column definition might look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:accounts</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>unique:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='kw'>true</span>
  <span class='comment'># ...
</span><span class='kw'>end</span>
</code></pre>

<h3>The <code>has_many</code> Association</h3>

<p>A <code>has_many</code> association indicates a one-to-many connection with another model. You&#39;ll often find this association on the &quot;other side&quot; of a <code>belongs_to</code> association. This association indicates that each instance of the model has zero or more instances of another model. For example, in an application containing authors and books, the author model could be declared like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<p>NOTE: The name of the other model is pluralized when declaring a <code>has_many</code> association.</p>

<p><img src="images/has_many.png" alt="has_many Association Diagram"></p>

<p>The corresponding migration might look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateAuthors</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:authors</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:name</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:books</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_datetime'>datetime</span> <span class='symbol'>:published_at</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3>The <code>has_many :through</code> Association</h3>

<p>A <code>has_many :through</code> association is often used to set up a many-to-many connection with another model. This association indicates that the declaring model can be matched with zero or more instances of another model by proceeding <em>through</em> a third model. For example, consider a medical practice where patients make appointments to see physicians. The relevant association declarations could look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Physician</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:appointments</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:patients</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:appointments</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Appointment</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:physician</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:patient</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Patient</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:appointments</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:physicians</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:appointments</span>
<span class='kw'>end</span>
</code></pre>

<p><img src="images/has_many_through.png" alt="has_many :through Association Diagram"></p>

<p>The corresponding migration might look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateAppointments</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:physicians</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:name</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:patients</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:name</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:appointments</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:physician</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:patient</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_datetime'>datetime</span> <span class='symbol'>:appointment_date</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>The collection of join models can be managed via the <a href="#has-many-association-reference"><code>has_many</code> association methods</a>.
For example, if you assign:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_physician'>physician</span><span class='period'>.</span><span class='id identifier rubyid_patients'>patients</span> <span class='op'>=</span> <span class='id identifier rubyid_patients'>patients</span>
</code></pre>

<p>Then new join models are automatically created for the newly associated objects.
If some that existed previously are now missing, then their join rows are automatically deleted.</p>

<p>WARNING: Automatic deletion of join models is direct, no destroy callbacks are triggered.</p>

<p>The <code>has_many :through</code> association is also useful for setting up &quot;shortcuts&quot; through nested <code>has_many</code> associations. For example, if a document has many sections, and a section has many paragraphs, you may sometimes want to get a simple collection of all paragraphs in the document. You could set that up this way:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Document</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:sections</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:paragraphs</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:sections</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Section</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:document</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:paragraphs</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Paragraph</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:section</span>
<span class='kw'>end</span>
</code></pre>

<p>With <code>through: :sections</code> specified, Rails will now understand:</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@document</span><span class='period'>.</span><span class='id identifier rubyid_paragraphs'>paragraphs</span>
</code></pre>

<h3>The <code>has_one :through</code> Association</h3>

<p>A <code>has_one :through</code> association sets up a one-to-one connection with another model. This association indicates
that the declaring model can be matched with one instance of another model by proceeding <em>through</em> a third model.
For example, if each supplier has one account, and each account is associated with one account history, then the
supplier model could look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account_history</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:account</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account_history</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>AccountHistory</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:account</span>
<span class='kw'>end</span>
</code></pre>

<p><img src="images/has_one_through.png" alt="has_one :through Association Diagram"></p>

<p>The corresponding migration might look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateAccountHistories</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:suppliers</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:name</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:accounts</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:account_number</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:account_histories</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:account</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_integer'>integer</span> <span class='symbol'>:credit_rating</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3>The <code>has_and_belongs_to_many</code> Association</h3>

<p>A <code>has_and_belongs_to_many</code> association creates a direct many-to-many connection with another model, with no intervening model. For example, if your application includes assemblies and parts, with each assembly having many parts and each part appearing in many assemblies, you could declare the models this way:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Assembly</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:parts</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Part</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:assemblies</span>
<span class='kw'>end</span>
</code></pre>

<p><img src="images/habtm.png" alt="has_and_belongs_to_many Association Diagram"></p>

<p>The corresponding migration might look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateAssembliesAndParts</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:assemblies</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:name</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:parts</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:part_number</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:assemblies_parts</span><span class='comma'>,</span> <span class='label'>id:</span> <span class='kw'>false</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:assembly</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:part</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3>Choosing Between <code>belongs_to</code> and <code>has_one</code></h3>

<p>If you want to set up a one-to-one relationship between two models, you&#39;ll need to add <code>belongs_to</code> to one, and <code>has_one</code> to the other. How do you know which is which?</p>

<p>The distinction is in where you place the foreign key (it goes on the table for the class declaring the <code>belongs_to</code> association), but you should give some thought to the actual meaning of the data as well. The <code>has_one</code> relationship says that one of something is yours - that is, that something points back to you. For example, it makes more sense to say that a supplier owns an account than that an account owns a supplier. This suggests that the correct relationships are like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span>
<span class='kw'>end</span>
</code></pre>

<p>The corresponding migration might look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateSuppliers</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:suppliers</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span>  <span class='symbol'>:name</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:accounts</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_integer'>integer</span> <span class='symbol'>:supplier_id</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span>  <span class='symbol'>:account_number</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_add_index'>add_index</span> <span class='symbol'>:accounts</span><span class='comma'>,</span> <span class='symbol'>:supplier_id</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>NOTE: Using <code>t.integer :supplier_id</code> makes the foreign key naming obvious and explicit. In current versions of Rails, you can abstract away this implementation detail by using <code>t.references :supplier</code> instead.</p>

<h3>Choosing Between <code>has_many :through</code> and <code>has_and_belongs_to_many</code></h3>

<p>Rails offers two different ways to declare a many-to-many relationship between models. The simpler way is to use <code>has_and_belongs_to_many</code>, which allows you to make the association directly:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Assembly</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:parts</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Part</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:assemblies</span>
<span class='kw'>end</span>
</code></pre>

<p>The second way to declare a many-to-many relationship is to use <code>has_many :through</code>. This makes the association indirectly, through a join model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Assembly</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:manifests</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:parts</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:manifests</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Manifest</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:assembly</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:part</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Part</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:manifests</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:assemblies</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:manifests</span>
<span class='kw'>end</span>
</code></pre>

<p>The simplest rule of thumb is that you should set up a <code>has_many :through</code> relationship if you need to work with the relationship model as an independent entity. If you don&#39;t need to do anything with the relationship model, it may be simpler to set up a <code>has_and_belongs_to_many</code> relationship (though you&#39;ll need to remember to create the joining table in the database).</p>

<p>You should use <code>has_many :through</code> if you need validations, callbacks or extra attributes on the join model.</p>

<h3>Polymorphic Associations</h3>

<p>A slightly more advanced twist on associations is the <em>polymorphic association</em>. With polymorphic associations, a model can belong to more than one other model, on a single association. For example, you might have a picture model that belongs to either an employee model or a product model. Here&#39;s how this could be declared:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Picture</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:imageable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Employee</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:pictures</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbol'>:imageable</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Product</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:pictures</span><span class='comma'>,</span> <span class='label'>as:</span> <span class='symbol'>:imageable</span>
<span class='kw'>end</span>
</code></pre>

<p>You can think of a polymorphic <code>belongs_to</code> declaration as setting up an interface that any other model can use. From an instance of the <code>Employee</code> model, you can retrieve a collection of pictures: <code>@employee.pictures</code>.</p>

<p>Similarly, you can retrieve <code>@product.pictures</code>.</p>

<p>If you have an instance of the <code>Picture</code> model, you can get to its parent via <code>@picture.imageable</code>. To make this work, you need to declare both a foreign key column and a type column in the model that declares the polymorphic interface:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreatePictures</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:pictures</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span>  <span class='symbol'>:name</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_integer'>integer</span> <span class='symbol'>:imageable_id</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span>  <span class='symbol'>:imageable_type</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_add_index'>add_index</span> <span class='symbol'>:pictures</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='symbol'>:imageable_type</span><span class='comma'>,</span> <span class='symbol'>:imageable_id</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>This migration can be simplified by using the <code>t.references</code> form:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreatePictures</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:pictures</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='symbol'>:name</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_references'>references</span> <span class='symbol'>:imageable</span><span class='comma'>,</span> <span class='label'>polymorphic:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p><img src="images/polymorphic.png" alt="Polymorphic Association Diagram"></p>

<h3>Self Joins</h3>

<p>In designing a data model, you will sometimes find a model that should have a relation to itself. For example, you may want to store all employees in a single database model, but be able to trace relationships such as between manager and subordinates. This situation can be modeled with self-joining associations:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Employee</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:subordinates</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Employee</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                          <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>manager_id</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:manager</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Employee</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>With this setup, you can retrieve <code>@employee.subordinates</code> and <code>@employee.manager</code>.</p>

<p>In your migrations/schema, you will add a references column to the model itself.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateEmployees</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:employees</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_references'>references</span> <span class='symbol'>:manager</span><span class='comma'>,</span> <span class='label'>index:</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_timestamps'>timestamps</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h2>Tips, Tricks, and Warnings</h2>

<p>Here are a few things you should know to make efficient use of Active Record associations in your Rails applications:</p>

<ul>
<li>Controlling caching</li>
<li>Avoiding name collisions</li>
<li>Updating the schema</li>
<li>Controlling association scope</li>
<li>Bi-directional associations</li>
</ul>

<h3>Controlling Caching</h3>

<p>All of the association methods are built around caching, which keeps the result of the most recent query available for further operations. The cache is even shared across methods. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span>                 <span class='comment'># retrieves books from the database
</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>            <span class='comment'># uses the cached copy of books
</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>          <span class='comment'># uses the cached copy of books
</span></code></pre>

<p>But what if you want to reload the cache, because data might have been changed by some other part of the application? Just call <code>reload</code> on the association:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span>                 <span class='comment'># retrieves books from the database
</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>            <span class='comment'># uses the cached copy of books
</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>    <span class='comment'># discards the cached copy of books
</span>                                <span class='comment'># and goes back to the database
</span></code></pre>

<h3>Avoiding Name Collisions</h3>

<p>You are not free to use just any name for your associations. Because creating an association adds a method with that name to the model, it is a bad idea to give an association a name that is already used for an instance method of <code>ActiveRecord::Base</code>. The association method would override the base method and break things. For instance, <code>attributes</code> or <code>connection</code> are bad names for associations.</p>

<h3>Updating the Schema</h3>

<p>Associations are extremely useful, but they are not magic. You are responsible for maintaining your database schema to match your associations. In practice, this means two things, depending on what sort of associations you are creating. For <code>belongs_to</code> associations you need to create foreign keys, and for <code>has_and_belongs_to_many</code> associations you need to create the appropriate join table.</p>

<h4>Creating Foreign Keys for <code>belongs_to</code> Associations</h4>

<p>When you declare a <code>belongs_to</code> association, you need to create foreign keys as appropriate. For example, consider this model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
<span class='kw'>end</span>
</code></pre>

<p>This declaration needs to be backed up by the proper foreign key declaration on the books table:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateBooks</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:books</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_datetime'>datetime</span> <span class='symbol'>:published_at</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span>   <span class='symbol'>:book_number</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_integer'>integer</span>  <span class='symbol'>:author_id</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_add_index'>add_index</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='symbol'>:author_id</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If you create an association some time after you build the underlying model, you need to remember to create an <code>add_column</code> migration to provide the necessary foreign key.</p>

<h4>Creating Join Tables for <code>has_and_belongs_to_many</code> Associations</h4>

<p>If you create a <code>has_and_belongs_to_many</code> association, you need to explicitly create the joining table. Unless the name of the join table is explicitly specified by using the <code>:join_table</code> option, Active Record creates the name by using the lexical book of the class names. So a join between author and book models will give the default join table name of &quot;authors_books&quot; because &quot;a&quot; outranks &quot;b&quot; in lexical ordering.</p>

<p>WARNING: The precedence between model names is calculated using the <code>&lt;=&gt;</code> operator for <code>String</code>. This means that if the strings are of different lengths, and the strings are equal when compared up to the shortest length, then the longer string is considered of higher lexical precedence than the shorter one. For example, one would expect the tables &quot;paper_boxes&quot; and &quot;papers&quot; to generate a join table name of &quot;papers_paper_boxes&quot; because of the length of the name &quot;paper_boxes&quot;, but it in fact generates a join table name of &quot;paper_boxes_papers&quot; (because the underscore &#39;_&#39; is lexicographically <em>less</em> than &#39;s&#39; in common encodings).</p>

<p>Whatever the name, you must manually generate the join table with an appropriate migration. For example, consider these associations:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Assembly</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:parts</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Part</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:assemblies</span>
<span class='kw'>end</span>
</code></pre>

<p>These need to be backed up by a migration to create the <code>assemblies_parts</code> table. This table should be created without a primary key:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateAssembliesPartsJoinTable</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_table'>create_table</span> <span class='symbol'>:assemblies_parts</span><span class='comma'>,</span> <span class='label'>id:</span> <span class='kw'>false</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_integer'>integer</span> <span class='symbol'>:assembly_id</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_integer'>integer</span> <span class='symbol'>:part_id</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_add_index'>add_index</span> <span class='symbol'>:assemblies_parts</span><span class='comma'>,</span> <span class='symbol'>:assembly_id</span>
    <span class='id identifier rubyid_add_index'>add_index</span> <span class='symbol'>:assemblies_parts</span><span class='comma'>,</span> <span class='symbol'>:part_id</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>We pass <code>id: false</code> to <code>create_table</code> because that table does not represent a model. That&#39;s required for the association to work properly. If you observe any strange behavior in a <code>has_and_belongs_to_many</code> association like mangled model IDs, or exceptions about conflicting IDs, chances are you forgot that bit.</p>

<p>You can also use the method <code>create_join_table</code></p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>CreateAssembliesPartsJoinTable</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span><span class='lbracket'>[</span><span class='float'>5.0</span><span class='rbracket'>]</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_change'>change</span>
    <span class='id identifier rubyid_create_join_table'>create_join_table</span> <span class='symbol'>:assemblies</span><span class='comma'>,</span> <span class='symbol'>:parts</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span> <span class='symbol'>:assembly_id</span>
      <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span> <span class='symbol'>:part_id</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3>Controlling Association Scope</h3>

<p>By default, associations look for objects only within the current module&#39;s scope. This can be important when you declare Active Record models within a module. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>MyApplication</span>
  <span class='kw'>module</span> <span class='const'>Business</span>
    <span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
       <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span>
    <span class='kw'>end</span>

    <span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
       <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>This will work fine, because both the <code>Supplier</code> and the <code>Account</code> class are defined within the same scope. But the following will <em>not</em> work, because <code>Supplier</code> and <code>Account</code> are defined in different scopes:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>MyApplication</span>
  <span class='kw'>module</span> <span class='const'>Business</span>
    <span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
       <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>module</span> <span class='const'>Billing</span>
    <span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
       <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>To associate a model with a model in a different namespace, you must specify the complete class name in your association declaration:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>MyApplication</span>
  <span class='kw'>module</span> <span class='const'>Business</span>
    <span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
       <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span><span class='comma'>,</span>
        <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MyApplication::Billing::Account</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>module</span> <span class='const'>Billing</span>
    <span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
       <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span><span class='comma'>,</span>
        <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MyApplication::Business::Supplier</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3>Bi-directional Associations</h3>

<p>It&#39;s normal for associations to work in two directions, requiring declaration on two different models:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
<span class='kw'>end</span>
</code></pre>

<p>By default, Active Record doesn&#39;t know about the connection between these associations. This can lead to two copies of an object getting out of sync:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='const'>Author</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_b'>b</span> <span class='op'>=</span> <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='op'>==</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='comment'># =&gt; true
</span><span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Manny</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='op'>==</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='comment'># =&gt; false
</span></code></pre>

<p>This happens because <code>a</code> and <code>b.author</code> are two different in-memory representations of the same data, and neither one is automatically refreshed from changes to the other. Active Record provides the <code>:inverse_of</code> option so that you can inform it of these relations:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:author</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<p>With these changes, Active Record will only load one copy of the author object, preventing inconsistencies and making your application more efficient:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='const'>Author</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_b'>b</span> <span class='op'>=</span> <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='op'>==</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='comment'># =&gt; true
</span><span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Manny</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='op'>==</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='comment'># =&gt; true
</span></code></pre>

<p>There are a few limitations to <code>inverse_of</code> support:</p>

<ul>
<li>They do not work with <code>:through</code> associations.</li>
<li>They do not work with <code>:polymorphic</code> associations.</li>
<li>They do not work with <code>:as</code> associations.</li>
<li>For <code>belongs_to</code> associations, <code>has_many</code> inverse associations are ignored.</li>
</ul>

<p>Every association will attempt to automatically find the inverse association
and set the <code>:inverse_of</code> option heuristically (based on the association name).
Most associations with standard names will be supported. However, associations
that contain the following options will not have their inverses set
automatically:</p>

<ul>
<li><code>:conditions</code></li>
<li><code>:through</code></li>
<li><code>:polymorphic</code></li>
<li><code>:foreign_key</code></li>
</ul>

<h2>Detailed Association Reference</h2>

<p>The following sections give the details of each type of association, including the methods that they add and the options that you can use when declaring an association.</p>

<h3><code>belongs_to</code> Association Reference</h3>

<p>The <code>belongs_to</code> association creates a one-to-one match with another model. In database terms, this association says that this class contains the foreign key. If the other class contains the foreign key, then you should use <code>has_one</code> instead.</p>

<h4>Methods Added by <code>belongs_to</code></h4>

<p>When you declare a <code>belongs_to</code> association, the declaring class automatically gains five methods related to the association:</p>

<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
</ul>

<p>In all of these methods, <code>association</code> is replaced with the symbol passed as the first argument to <code>belongs_to</code>. For example, given the declaration:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
<span class='kw'>end</span>
</code></pre>

<p>Each instance of the <code>Book</code> model will have these methods:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_author'>author</span>
<span class='id identifier rubyid_author'>author</span><span class='op'>=</span>
<span class='id identifier rubyid_build_author'>build_author</span>
<span class='id identifier rubyid_create_author'>create_author</span>
<span class='id identifier rubyid_create_author!'>create_author!</span>
</code></pre>

<p>NOTE: When initializing a new <code>has_one</code> or <code>belongs_to</code> association you must use the <code>build_</code> prefix to build the association, rather than the <code>association.build</code> method that would be used for <code>has_many</code> or <code>has_and_belongs_to_many</code> associations. To create one, use the <code>create_</code> prefix.</p>

<h5><code>association</code></h5>

<p>The <code>association</code> method returns the associated object, if any. If no associated object is found, it returns <code>nil</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@author</span> <span class='op'>=</span> <span class='ivar'>@book</span><span class='period'>.</span><span class='id identifier rubyid_author'>author</span>
</code></pre>

<p>If the associated object has already been retrieved from the database for this object, the cached version will be returned. To override this behavior (and force a database read), call <code>#reload</code> on the parent object.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@author</span> <span class='op'>=</span> <span class='ivar'>@book</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span><span class='period'>.</span><span class='id identifier rubyid_author'>author</span>
</code></pre>

<h5><code>association=(associate)</code></h5>

<p>The <code>association=</code> method assigns an associated object to this object. Behind the scenes, this means extracting the primary key from the associated object and setting this object&#39;s foreign key to the same value.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@book</span><span class='period'>.</span><span class='id identifier rubyid_author'>author</span> <span class='op'>=</span> <span class='ivar'>@author</span>
</code></pre>

<h5><code>build_association(attributes = {})</code></h5>

<p>The <code>build_association</code> method returns a new object of the associated type. This object will be instantiated from the passed attributes, and the link through this object&#39;s foreign key will be set, but the associated object will <em>not</em> yet be saved.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@author</span> <span class='op'>=</span> <span class='ivar'>@book</span><span class='period'>.</span><span class='id identifier rubyid_build_author'>build_author</span><span class='lparen'>(</span><span class='label'>author_number:</span> <span class='int'>123</span><span class='comma'>,</span>
                                  <span class='label'>author_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John Doe</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
</code></pre>

<h5><code>create_association(attributes = {})</code></h5>

<p>The <code>create_association</code> method returns a new object of the associated type. This object will be instantiated from the passed attributes, the link through this object&#39;s foreign key will be set, and, once it passes all of the validations specified on the associated model, the associated object <em>will</em> be saved.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@author</span> <span class='op'>=</span> <span class='ivar'>@book</span><span class='period'>.</span><span class='id identifier rubyid_create_author'>create_author</span><span class='lparen'>(</span><span class='label'>author_number:</span> <span class='int'>123</span><span class='comma'>,</span>
                                   <span class='label'>author_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John Doe</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
</code></pre>

<h5><code>create_association!(attributes = {})</code></h5>

<p>Does the same as <code>create_association</code> above, but raises <code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<h4>Options for <code>belongs_to</code></h4>

<p>While Rails uses intelligent defaults that will work well in most situations, there may be times when you want to customize the behavior of the <code>belongs_to</code> association reference. Such customizations can easily be accomplished by passing options and scope blocks when you create the association. For example, this association uses two such options:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:destroy</span><span class='comma'>,</span>
    <span class='label'>counter_cache:</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</code></pre>

<p>The <code>belongs_to</code> association supports these options:</p>

<ul>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:counter_cache</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:primary_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:polymorphic</code></li>
<li><code>:touch</code></li>
<li><code>:validate</code></li>
<li><code>:optional</code></li>
</ul>

<h5><code>:autosave</code></h5>

<p>If you set the <code>:autosave</code> option to <code>true</code>, Rails will save any loaded members and destroy members that are marked for destruction whenever you save the parent object.</p>

<h5><code>:class_name</code></h5>

<p>If the name of the other model cannot be derived from the association name, you can use the <code>:class_name</code> option to supply the model name. For example, if a book belongs to an author, but the actual name of the model containing authors is <code>Patron</code>, you&#39;d set things up this way:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Patron</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h5><code>:counter_cache</code></h5>

<p>The <code>:counter_cache</code> option can be used to make finding the number of belonging objects more efficient. Consider these models:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
<span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<p>With these declarations, asking for the value of <code>@author.books.size</code> requires making a call to the database to perform a <code>COUNT(*)</code> query. To avoid this call, you can add a counter cache to the <em>belonging</em> model:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>counter_cache:</span> <span class='kw'>true</span>
<span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<p>With this declaration, Rails will keep the cache value up to date, and then return that value in response to the <code>size</code> method.</p>

<p>Although the <code>:counter_cache</code> option is specified on the model that includes
the <code>belongs_to</code> declaration, the actual column must be added to the
<em>associated</em> (<code>has_many</code>) model. In the case above, you would need to add a
column named <code>books_count</code> to the <code>Author</code> model.</p>

<p>You can override the default column name by specifying a custom column name in
the <code>counter_cache</code> declaration instead of <code>true</code>. For example, to use
<code>count_of_books</code> instead of <code>books_count</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>counter_cache:</span> <span class='symbol'>:count_of_books</span>
<span class='kw'>end</span>
<span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<p>NOTE: You only need to specify the :counter_cache option on the <code>belongs_to</code>
side of the association.</p>

<p>Counter cache columns are added to the containing model&#39;s list of read-only attributes through <code>attr_readonly</code>.</p>

<h5><code>:dependent</code></h5>

<p>Controls what happens to associated objects when their owner is destroyed:</p>

<ul>
<li><code>:destroy</code> causes the associated objects to also be destroyed.</li>
<li><code>:delete_all</code> causes the associated objects to be deleted directly from the database (callbacks are not executed).</li>
<li><code>:nullify</code> causes the foreign keys to be set to <code>NULL</code> (callbacks are not executed).</li>
<li><code>:restrict_with_exception</code> causes an exception to be raised if there are associated records.</li>
<li><code>:restrict_with_error</code> causes an error to be added to the owner if there are associated objects.</li>
</ul>

<p>WARNING: You should not specify this option on a <code>belongs_to</code> association that is connected with a <code>has_many</code> association on the other class. Doing so can lead to orphaned records in your database.</p>

<h5><code>:foreign_key</code></h5>

<p>By convention, Rails assumes that the column used to hold the foreign key on this model is the name of the association with the suffix <code>_id</code> added. The <code>:foreign_key</code> option lets you set the name of the foreign key directly:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Patron</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                        <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>patron_id</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>TIP: In any case, Rails will not create foreign key columns for you. You need to explicitly define them as part of your migrations.</p>

<h5><code>:primary_key</code></h5>

<p>By convention, Rails assumes that the <code>id</code> column is used to hold the primary key
of its tables. The <code>:primary_key</code> option allows you to specify a different column.</p>

<p>For example, given we have a <code>users</code> table with <code>guid</code> as the primary key. If we want a separate <code>todos</code> table to hold the foreign key <code>user_id</code> in the <code>guid</code> column, then we can use <code>primary_key</code> to achieve this like so:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_primary_key'>primary_key</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>guid</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># primary key is guid and not id
</span><span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Todo</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:user</span><span class='comma'>,</span> <span class='label'>primary_key:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>guid</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>When we execute <code>@user.todos.create</code> then the <code>@todo</code> record will have its
<code>user_id</code> value as the <code>guid</code> value of <code>@user</code>.</p>

<h5><code>:inverse_of</code></h5>

<p>The <code>:inverse_of</code> option specifies the name of the <code>has_many</code> or <code>has_one</code> association that is the inverse of this association. Does not work in combination with the <code>:polymorphic</code> options.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:author</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>:polymorphic</code></h5>

<p>Passing <code>true</code> to the <code>:polymorphic</code> option indicates that this is a polymorphic association. Polymorphic associations were discussed in detail <a href="#polymorphic-associations">earlier in this guide</a>.</p>

<h5><code>:touch</code></h5>

<p>If you set the <code>:touch</code> option to <code>true</code>, then the <code>updated_at</code> or <code>updated_on</code> timestamp on the associated object will be set to the current time whenever this object is saved or destroyed:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<p>In this case, saving or destroying an book will update the timestamp on the associated author. You can also specify a particular timestamp attribute to update:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>touch:</span> <span class='symbol'>:books_updated_at</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>:validate</code></h5>

<p>If you set the <code>:validate</code> option to <code>true</code>, then associated objects will be validated whenever you save this object. By default, this is <code>false</code>: associated objects will not be validated when this object is saved.</p>

<h5><code>:optional</code></h5>

<p>If you set the <code>:optional</code> option to <code>true</code>, then the presence of the associated
object won&#39;t be validated. By default, this option is set to <code>false</code>.</p>

<h4>Scopes for <code>belongs_to</code></h4>

<p>There may be times when you wish to customize the query used by <code>belongs_to</code>. Such customizations can be achieved via a scope block. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>active:</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='comma'>,</span>
                        <span class='label'>dependent:</span> <span class='symbol'>:destroy</span>
<span class='kw'>end</span>
</code></pre>

<p>You can use any of the standard <a href="active_record_querying.html">querying methods</a> inside the scope block. The following ones are discussed below:</p>

<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>

<h5><code>where</code></h5>

<p>The <code>where</code> method lets you specify the conditions that the associated object must meet.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='id identifier rubyid_book'>book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>active:</span> <span class='kw'>true</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>includes</code></h5>

<p>You can use the <code>includes</code> method to specify second-order associations that should be eager-loaded when this association is used. For example, consider these models:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>LineItem</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:book</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:line_items</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<p>If you frequently retrieve authors directly from line items (<code>@line_item.book.author</code>), then you can make your code somewhat more efficient by including authors in the association from line items to books:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>LineItem</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:book</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_includes'>includes</span> <span class='symbol'>:author</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:line_items</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<p>NOTE: There&#39;s no need to use <code>includes</code> for immediate associations - that is, if you have <code>Book belongs_to :author</code>, then the author is eager-loaded automatically when it&#39;s needed.</p>

<h5><code>readonly</code></h5>

<p>If you use <code>readonly</code>, then the associated object will be read-only when retrieved via the association.</p>

<h5><code>select</code></h5>

<p>The <code>select</code> method lets you override the SQL <code>SELECT</code> clause that is used to retrieve data about the associated object. By default, Rails retrieves all columns.</p>

<p>TIP: If you use the <code>select</code> method on a <code>belongs_to</code> association, you should also set the <code>:foreign_key</code> option to guarantee the correct results.</p>

<h4>Do Any Associated Objects Exist?</h4>

<p>You can see if any associated objects exist by using the <code>association.nil?</code> method:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>if</span> <span class='ivar'>@book</span><span class='period'>.</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='ivar'>@msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No author found for this book</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h4>When are Objects Saved?</h4>

<p>Assigning an object to a <code>belongs_to</code> association does <em>not</em> automatically save the object. It does not save the associated object either.</p>

<h3><code>has_one</code> Association Reference</h3>

<p>The <code>has_one</code> association creates a one-to-one match with another model. In database terms, this association says that the other class contains the foreign key. If this class contains the foreign key, then you should use <code>belongs_to</code> instead.</p>

<h4>Methods Added by <code>has_one</code></h4>

<p>When you declare a <code>has_one</code> association, the declaring class automatically gains five methods related to the association:</p>

<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
</ul>

<p>In all of these methods, <code>association</code> is replaced with the symbol passed as the first argument to <code>has_one</code>. For example, given the declaration:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span>
<span class='kw'>end</span>
</code></pre>

<p>Each instance of the <code>Supplier</code> model will have these methods:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_account'>account</span>
<span class='id identifier rubyid_account'>account</span><span class='op'>=</span>
<span class='id identifier rubyid_build_account'>build_account</span>
<span class='id identifier rubyid_create_account'>create_account</span>
<span class='id identifier rubyid_create_account!'>create_account!</span>
</code></pre>

<p>NOTE: When initializing a new <code>has_one</code> or <code>belongs_to</code> association you must use the <code>build_</code> prefix to build the association, rather than the <code>association.build</code> method that would be used for <code>has_many</code> or <code>has_and_belongs_to_many</code> associations. To create one, use the <code>create_</code> prefix.</p>

<h5><code>association</code></h5>

<p>The <code>association</code> method returns the associated object, if any. If no associated object is found, it returns <code>nil</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@account</span> <span class='op'>=</span> <span class='ivar'>@supplier</span><span class='period'>.</span><span class='id identifier rubyid_account'>account</span>
</code></pre>

<p>If the associated object has already been retrieved from the database for this object, the cached version will be returned. To override this behavior (and force a database read), call <code>#reload</code> on the parent object.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@account</span> <span class='op'>=</span> <span class='ivar'>@supplier</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span><span class='period'>.</span><span class='id identifier rubyid_account'>account</span>
</code></pre>

<h5><code>association=(associate)</code></h5>

<p>The <code>association=</code> method assigns an associated object to this object. Behind the scenes, this means extracting the primary key from this object and setting the associated object&#39;s foreign key to the same value.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@supplier</span><span class='period'>.</span><span class='id identifier rubyid_account'>account</span> <span class='op'>=</span> <span class='ivar'>@account</span>
</code></pre>

<h5><code>build_association(attributes = {})</code></h5>

<p>The <code>build_association</code> method returns a new object of the associated type. This object will be instantiated from the passed attributes, and the link through its foreign key will be set, but the associated object will <em>not</em> yet be saved.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@account</span> <span class='op'>=</span> <span class='ivar'>@supplier</span><span class='period'>.</span><span class='id identifier rubyid_build_account'>build_account</span><span class='lparen'>(</span><span class='label'>terms:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Net 30</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
</code></pre>

<h5><code>create_association(attributes = {})</code></h5>

<p>The <code>create_association</code> method returns a new object of the associated type. This object will be instantiated from the passed attributes, the link through its foreign key will be set, and, once it passes all of the validations specified on the associated model, the associated object <em>will</em> be saved.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@account</span> <span class='op'>=</span> <span class='ivar'>@supplier</span><span class='period'>.</span><span class='id identifier rubyid_create_account'>create_account</span><span class='lparen'>(</span><span class='label'>terms:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Net 30</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
</code></pre>

<h5><code>create_association!(attributes = {})</code></h5>

<p>Does the same as <code>create_association</code> above, but raises <code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<h4>Options for <code>has_one</code></h4>

<p>While Rails uses intelligent defaults that will work well in most situations, there may be times when you want to customize the behavior of the <code>has_one</code> association reference. Such customizations can easily be accomplished by passing options when you create the association. For example, this association uses two such options:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Billing</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:nullify</span>
<span class='kw'>end</span>
</code></pre>

<p>The <code>has_one</code> association supports these options:</p>

<ul>
<li><code>:as</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:primary_key</code></li>
<li><code>:source</code></li>
<li><code>:source_type</code></li>
<li><code>:through</code></li>
<li><code>:validate</code></li>
</ul>

<h5><code>:as</code></h5>

<p>Setting the <code>:as</code> option indicates that this is a polymorphic association. Polymorphic associations were discussed in detail <a href="#polymorphic-associations">earlier in this guide</a>.</p>

<h5><code>:autosave</code></h5>

<p>If you set the <code>:autosave</code> option to <code>true</code>, Rails will save any loaded members and destroy members that are marked for destruction whenever you save the parent object.</p>

<h5><code>:class_name</code></h5>

<p>If the name of the other model cannot be derived from the association name, you can use the <code>:class_name</code> option to supply the model name. For example, if a supplier has an account, but the actual name of the model containing accounts is <code>Billing</code>, you&#39;d set things up this way:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Billing</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h5><code>:dependent</code></h5>

<p>Controls what happens to the associated object when its owner is destroyed:</p>

<ul>
<li><code>:destroy</code> causes the associated object to also be destroyed</li>
<li><code>:delete</code> causes the associated object to be deleted directly from the database (so callbacks will not execute)</li>
<li><code>:nullify</code> causes the foreign key to be set to <code>NULL</code>. Callbacks are not executed.</li>
<li><code>:restrict_with_exception</code> causes an exception to be raised if there is an associated record</li>
<li><code>:restrict_with_error</code> causes an error to be added to the owner if there is an associated object</li>
</ul>

<p>It&#39;s necessary not to set or leave <code>:nullify</code> option for those associations
that have <code>NOT NULL</code> database constraints. If you don&#39;t set <code>dependent</code> to
destroy such associations you won&#39;t be able to change the associated object
because the initial associated object&#39;s foreign key will be set to the
unallowed <code>NULL</code> value.</p>

<h5><code>:foreign_key</code></h5>

<p>By convention, Rails assumes that the column used to hold the foreign key on the other model is the name of this model with the suffix <code>_id</code> added. The <code>:foreign_key</code> option lets you set the name of the foreign key directly:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>supp_id</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>TIP: In any case, Rails will not create foreign key columns for you. You need to explicitly define them as part of your migrations.</p>

<h5><code>:inverse_of</code></h5>

<p>The <code>:inverse_of</code> option specifies the name of the <code>belongs_to</code> association that is the inverse of this association. Does not work in combination with the <code>:through</code> or <code>:as</code> options.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:supplier</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:account</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>:primary_key</code></h5>

<p>By convention, Rails assumes that the column used to hold the primary key of this model is <code>id</code>. You can override this and explicitly specify the primary key with the <code>:primary_key</code> option.</p>

<h5><code>:source</code></h5>

<p>The <code>:source</code> option specifies the source association name for a <code>has_one :through</code> association.</p>

<h5><code>:source_type</code></h5>

<p>The <code>:source_type</code> option specifies the source association type for a <code>has_one :through</code> association that proceeds through a polymorphic association.</p>

<h5><code>:through</code></h5>

<p>The <code>:through</code> option specifies a join model through which to perform the query. <code>has_one :through</code> associations were discussed in detail <a href="#the-has-one-through-association">earlier in this guide</a>.</p>

<h5><code>:validate</code></h5>

<p>If you set the <code>:validate</code> option to <code>true</code>, then associated objects will be validated whenever you save this object. By default, this is <code>false</code>: associated objects will not be validated when this object is saved.</p>

<h4>Scopes for <code>has_one</code></h4>

<p>There may be times when you wish to customize the query used by <code>has_one</code>. Such customizations can be achieved via a scope block. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>active:</span> <span class='kw'>true</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<p>You can use any of the standard <a href="active_record_querying.html">querying methods</a> inside the scope block. The following ones are discussed below:</p>

<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>

<h5><code>where</code></h5>

<p>The <code>where</code> method lets you specify the conditions that the associated object must meet.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>confirmed = 1</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>includes</code></h5>

<p>You can use the <code>includes</code> method to specify second-order associations that should be eager-loaded when this association is used. For example, consider these models:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:representative</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Representative</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:accounts</span>
<span class='kw'>end</span>
</code></pre>

<p>If you frequently retrieve representatives directly from suppliers (<code>@supplier.account.representative</code>), then you can make your code somewhat more efficient by including representatives in the association from suppliers to accounts:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:account</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_includes'>includes</span> <span class='symbol'>:representative</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Account</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:supplier</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:representative</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Representative</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:accounts</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>readonly</code></h5>

<p>If you use the <code>readonly</code> method, then the associated object will be read-only when retrieved via the association.</p>

<h5><code>select</code></h5>

<p>The <code>select</code> method lets you override the SQL <code>SELECT</code> clause that is used to retrieve data about the associated object. By default, Rails retrieves all columns.</p>

<h4>Do Any Associated Objects Exist?</h4>

<p>You can see if any associated objects exist by using the <code>association.nil?</code> method:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>if</span> <span class='ivar'>@supplier</span><span class='period'>.</span><span class='id identifier rubyid_account'>account</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='ivar'>@msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No account found for this supplier</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h4>When are Objects Saved?</h4>

<p>When you assign an object to a <code>has_one</code> association, that object is automatically saved (in order to update its foreign key). In addition, any object being replaced is also automatically saved, because its foreign key will change too.</p>

<p>If either of these saves fails due to validation errors, then the assignment statement returns <code>false</code> and the assignment itself is cancelled.</p>

<p>If the parent object (the one declaring the <code>has_one</code> association) is unsaved (that is, <code>new_record?</code> returns <code>true</code>) then the child objects are not saved. They will automatically when the parent object is saved.</p>

<p>If you want to assign an object to a <code>has_one</code> association without saving the object, use the <code>association.build</code> method.</p>

<h3><code>has_many</code> Association Reference</h3>

<p>The <code>has_many</code> association creates a one-to-many relationship with another model. In database terms, this association says that the other class will have a foreign key that refers to instances of this class.</p>

<h4>Methods Added by <code>has_many</code></h4>

<p>When you declare a <code>has_many</code> association, the declaring class automatically gains 16 methods related to the association:</p>

<ul>
<li><code>collection</code></li>
<li><code>collection&lt;&lt;(object, ...)</code></li>
<li><code>collection.delete(object, ...)</code></li>
<li><code>collection.destroy(object, ...)</code></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><code>collection.clear</code></li>
<li><code>collection.empty?</code></li>
<li><code>collection.size</code></li>
<li><code>collection.find(...)</code></li>
<li><code>collection.where(...)</code></li>
<li><code>collection.exists?(...)</code></li>
<li><code>collection.build(attributes = {}, ...)</code></li>
<li><code>collection.create(attributes = {})</code></li>
<li><code>collection.create!(attributes = {})</code></li>
</ul>

<p>In all of these methods, <code>collection</code> is replaced with the symbol passed as the first argument to <code>has_many</code>, and <code>collection_singular</code> is replaced with the singularized version of that symbol. For example, given the declaration:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<p>Each instance of the <code>Author</code> model will have these methods:</p>

<pre class="code ruby"><code class="ruby">books
books&lt;&lt;(object, ...)
books.delete(object, ...)
books.destroy(object, ...)
books=(objects)
book_ids
book_ids=(ids)
books.clear
books.empty?
books.size
books.find(...)
books.where(...)
books.exists?(...)
books.build(attributes = {}, ...)
books.create(attributes = {})
books.create!(attributes = {})
</code></pre>

<h5><code>collection</code></h5>

<p>The <code>collection</code> method returns an array of all of the associated objects. If there are no associated objects, it returns an empty array.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@books</span> <span class='op'>=</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span>
</code></pre>

<h5><code>collection&lt;&lt;(object, ...)</code></h5>

<p>The <code>collection&lt;&lt;</code> method adds one or more objects to the collection by setting their foreign keys to the primary key of the calling model.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span> <span class='op'>&lt;&lt;</span> <span class='ivar'>@book1</span>
</code></pre>

<h5><code>collection.delete(object, ...)</code></h5>

<p>The <code>collection.delete</code> method removes one or more objects from the collection by setting their foreign keys to <code>NULL</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='ivar'>@book1</span><span class='rparen'>)</span>
</code></pre>

<p>WARNING: Additionally, objects will be destroyed if they&#39;re associated with <code>dependent: :destroy</code>, and deleted if they&#39;re associated with <code>dependent: :delete_all</code>.</p>

<h5><code>collection.destroy(object, ...)</code></h5>

<p>The <code>collection.destroy</code> method removes one or more objects from the collection by running <code>destroy</code> on each object.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span><span class='lparen'>(</span><span class='ivar'>@book1</span><span class='rparen'>)</span>
</code></pre>

<p>WARNING: Objects will <em>always</em> be removed from the database, ignoring the <code>:dependent</code> option.</p>

<h5><code>collection=(objects)</code></h5>

<p>The <code>collection=</code> method makes the collection contain only the supplied objects, by adding and deleting as appropriate.</p>

<h5><code>collection_singular_ids</code></h5>

<p>The <code>collection_singular_ids</code> method returns an array of the ids of the objects in the collection.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@book_ids</span> <span class='op'>=</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_book_ids'>book_ids</span>
</code></pre>

<h5><code>collection_singular_ids=(ids)</code></h5>

<p>The <code>collection_singular_ids=</code> method makes the collection contain only the objects identified by the supplied primary key values, by adding and deleting as appropriate.</p>

<h5><code>collection.clear</code></h5>

<p>The <code>collection.clear</code> method removes all objects from the collection according to the strategy specified by the <code>dependent</code> option. If no option is given, it follows the default strategy. The default strategy for <code>has_many :through</code> associations is <code>delete_all</code>, and for <code>has_many</code> associations is to set the foreign keys to <code>NULL</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
</code></pre>

<p>WARNING: Objects will be deleted if they&#39;re associated with <code>dependent: :destroy</code>,
just like <code>dependent: :delete_all</code>.</p>

<h5><code>collection.empty?</code></h5>

<p>The <code>collection.empty?</code> method returns <code>true</code> if the collection does not contain any associated objects.</p>

<pre class="code erb"><code class="erb">&lt;% if @author.books.empty? %&gt;
  No Books Found
&lt;% end %&gt;
</code></pre>

<h5><code>collection.size</code></h5>

<p>The <code>collection.size</code> method returns the number of objects in the collection.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@book_count</span> <span class='op'>=</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>
</code></pre>

<h5><code>collection.find(...)</code></h5>

<p>The <code>collection.find</code> method finds objects within the collection. It uses the same syntax and options as <code>ActiveRecord::Base.find</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@available_books</span> <span class='op'>=</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span>
</code></pre>

<h5><code>collection.where(...)</code></h5>

<p>The <code>collection.where</code> method finds objects within the collection based on the conditions supplied but the objects are loaded lazily meaning that the database is queried only when the object(s) are accessed.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@available_books</span> <span class='op'>=</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>available:</span> <span class='kw'>true</span><span class='rparen'>)</span> <span class='comment'># No query yet
</span><span class='ivar'>@available_book</span> <span class='op'>=</span> <span class='ivar'>@available_books</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='comment'># Now the database will be queried
</span></code></pre>

<h5><code>collection.exists?(...)</code></h5>

<p>The <code>collection.exists?</code> method checks whether an object meeting the supplied
conditions exists in the collection. It uses the same syntax and options as
<a href="http://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>ActiveRecord::Base.exists?</code></a>.</p>

<h5><code>collection.build(attributes = {}, ...)</code></h5>

<p>The <code>collection.build</code> method returns a single or array of new objects of the associated type. The object(s) will be instantiated from the passed attributes, and the link through their foreign key will be created, but the associated objects will <em>not</em> yet be saved.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@book</span> <span class='op'>=</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_build'>build</span><span class='lparen'>(</span><span class='label'>published_at:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='comma'>,</span>
                                <span class='label'>book_number:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A12345</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='ivar'>@books</span> <span class='op'>=</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_build'>build</span><span class='lparen'>(</span><span class='lbracket'>[</span>
  <span class='lbrace'>{</span> <span class='label'>published_at:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='comma'>,</span> <span class='label'>book_number:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A12346</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span>
  <span class='lbrace'>{</span> <span class='label'>published_at:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='comma'>,</span> <span class='label'>book_number:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A12347</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='rbracket'>]</span><span class='rparen'>)</span>
</code></pre>

<h5><code>collection.create(attributes = {})</code></h5>

<p>The <code>collection.create</code> method returns a single or array of new objects of the associated type. The object(s) will be instantiated from the passed attributes, the link through its foreign key will be created, and, once it passes all of the validations specified on the associated model, the associated object <em>will</em> be saved.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@book</span> <span class='op'>=</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>published_at:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='comma'>,</span>
                                 <span class='label'>book_number:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A12345</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='ivar'>@books</span> <span class='op'>=</span> <span class='ivar'>@author</span><span class='period'>.</span><span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='lbracket'>[</span>
  <span class='lbrace'>{</span> <span class='label'>published_at:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='comma'>,</span> <span class='label'>book_number:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A12346</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span>
  <span class='lbrace'>{</span> <span class='label'>published_at:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='comma'>,</span> <span class='label'>book_number:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A12347</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='rbracket'>]</span><span class='rparen'>)</span>
</code></pre>

<h5><code>collection.create!(attributes = {})</code></h5>

<p>Does the same as <code>collection.create</code> above, but raises <code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<h4>Options for <code>has_many</code></h4>

<p>While Rails uses intelligent defaults that will work well in most situations, there may be times when you want to customize the behavior of the <code>has_many</code> association reference. Such customizations can easily be accomplished by passing options when you create the association. For example, this association uses two such options:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:delete_all</span><span class='comma'>,</span> <span class='label'>validate:</span> <span class='kw'>false</span>
<span class='kw'>end</span>
</code></pre>

<p>The <code>has_many</code> association supports these options:</p>

<ul>
<li><code>:as</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:counter_cache</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:primary_key</code></li>
<li><code>:source</code></li>
<li><code>:source_type</code></li>
<li><code>:through</code></li>
<li><code>:validate</code></li>
</ul>

<h5><code>:as</code></h5>

<p>Setting the <code>:as</code> option indicates that this is a polymorphic association, as discussed <a href="#polymorphic-associations">earlier in this guide</a>.</p>

<h5><code>:autosave</code></h5>

<p>If you set the <code>:autosave</code> option to <code>true</code>, Rails will save any loaded members and destroy members that are marked for destruction whenever you save the parent object.</p>

<h5><code>:class_name</code></h5>

<p>If the name of the other model cannot be derived from the association name, you can use the <code>:class_name</code> option to supply the model name. For example, if an author has many books, but the actual name of the model containing books is <code>Transaction</code>, you&#39;d set things up this way:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Transaction</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h5><code>:counter_cache</code></h5>

<p>This option can be used to configure a custom named <code>:counter_cache</code>. You only need this option when you customized the name of your <code>:counter_cache</code> on the <a href="#options-for-belongs-to">belongs_to association</a>.</p>

<h5><code>:dependent</code></h5>

<p>Controls what happens to the associated objects when their owner is destroyed:</p>

<ul>
<li><code>:destroy</code> causes all the associated objects to also be destroyed</li>
<li><code>:delete_all</code> causes all the associated objects to be deleted directly from the database (so callbacks will not execute)</li>
<li><code>:nullify</code> causes the foreign keys to be set to <code>NULL</code>. Callbacks are not executed.</li>
<li><code>:restrict_with_exception</code> causes an exception to be raised if there are any associated records</li>
<li><code>:restrict_with_error</code> causes an error to be added to the owner if there are any associated objects</li>
</ul>

<h5><code>:foreign_key</code></h5>

<p>By convention, Rails assumes that the column used to hold the foreign key on the other model is the name of this model with the suffix <code>_id</code> added. The <code>:foreign_key</code> option lets you set the name of the foreign key directly:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cust_id</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>TIP: In any case, Rails will not create foreign key columns for you. You need to explicitly define them as part of your migrations.</p>

<h5><code>:inverse_of</code></h5>

<p>The <code>:inverse_of</code> option specifies the name of the <code>belongs_to</code> association that is the inverse of this association. Does not work in combination with the <code>:through</code> or <code>:as</code> options.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:author</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span><span class='comma'>,</span> <span class='label'>inverse_of:</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>:primary_key</code></h5>

<p>By convention, Rails assumes that the column used to hold the primary key of the association is <code>id</code>. You can override this and explicitly specify the primary key with the <code>:primary_key</code> option.</p>

<p>Let&#39;s say the <code>users</code> table has <code>id</code> as the primary_key but it also
has a <code>guid</code> column. The requirement is that the <code>todos</code> table should
hold the <code>guid</code> column value as the foreign key and not <code>id</code>
value. This can be achieved like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:todos</span><span class='comma'>,</span> <span class='label'>primary_key:</span> <span class='symbol'>:guid</span>
<span class='kw'>end</span>
</code></pre>

<p>Now if we execute <code>@todo = @user.todos.create</code> then the <code>@todo</code>
record&#39;s <code>user_id</code> value will be the <code>guid</code> value of <code>@user</code>.</p>

<h5><code>:source</code></h5>

<p>The <code>:source</code> option specifies the source association name for a <code>has_many :through</code> association. You only need to use this option if the name of the source association cannot be automatically inferred from the association name.</p>

<h5><code>:source_type</code></h5>

<p>The <code>:source_type</code> option specifies the source association type for a <code>has_many :through</code> association that proceeds through a polymorphic association.</p>

<h5><code>:through</code></h5>

<p>The <code>:through</code> option specifies a join model through which to perform the query. <code>has_many :through</code> associations provide a way to implement many-to-many relationships, as discussed <a href="#the-has-many-through-association">earlier in this guide</a>.</p>

<h5><code>:validate</code></h5>

<p>If you set the <code>:validate</code> option to <code>false</code>, then associated objects will not be validated whenever you save this object. By default, this is <code>true</code>: associated objects will be validated when this object is saved.</p>

<h4>Scopes for <code>has_many</code></h4>

<p>There may be times when you wish to customize the query used by <code>has_many</code>. Such customizations can be achieved via a scope block. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>processed:</span> <span class='kw'>true</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<p>You can use any of the standard <a href="active_record_querying.html">querying methods</a> inside the scope block. The following ones are discussed below:</p>

<ul>
<li><code>where</code></li>
<li><code>extending</code></li>
<li><code>group</code></li>
<li><code>includes</code></li>
<li><code>limit</code></li>
<li><code>offset</code></li>
<li><code>order</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
<li><code>distinct</code></li>
</ul>

<h5><code>where</code></h5>

<p>The <code>where</code> method lets you specify the conditions that the associated object must meet.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:confirmed_books</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>confirmed = 1</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Book</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>You can also set conditions via a hash:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:confirmed_books</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>confirmed:</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='comma'>,</span>
                              <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Book</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>If you use a hash-style <code>where</code> option, then record creation via this association will be automatically scoped using the hash. In this case, using <code>@author.confirmed_books.create</code> or <code>@author.confirmed_books.build</code> will create books where the confirmed column has the value <code>true</code>.</p>

<h5><code>extending</code></h5>

<p>The <code>extending</code> method specifies a named module to extend the association proxy. Association extensions are discussed in detail <a href="#association-extensions">later in this guide</a>.</p>

<h5><code>group</code></h5>

<p>The <code>group</code> method supplies an attribute name to group the result set by, using a <code>GROUP BY</code> clause in the finder SQL.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:line_items</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_group'>group</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>books.id</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span>
                        <span class='label'>through:</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>includes</code></h5>

<p>You can use the <code>includes</code> method to specify second-order associations that should be eager-loaded when this association is used. For example, consider these models:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:line_items</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>LineItem</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:book</span>
<span class='kw'>end</span>
</code></pre>

<p>If you frequently retrieve line items directly from authors (<code>@author.books.line_items</code>), then you can make your code somewhat more efficient by including line items in the association from authors to books:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_includes'>includes</span> <span class='symbol'>:line_items</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Book</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:author</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:line_items</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>LineItem</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:book</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>limit</code></h5>

<p>The <code>limit</code> method lets you restrict the total number of objects that will be fetched through an association.</p>

<pre class="code ruby"><code class="ruby">class Author &lt; ApplicationRecord
  has_many :recent_books,
    #=&gt; { order(&#39;published_at desc&#39;).limit(100) },
    class_name: &quot;Book&quot;,
end
</code></pre>

<h5><code>offset</code></h5>

<p>The <code>offset</code> method lets you specify the starting offset for fetching objects via an association. For example, <code>-&gt; { offset(11) }</code> will skip the first 11 records.</p>

<h5><code>order</code></h5>

<p>The <code>order</code> method dictates the order in which associated objects will be received (in the syntax used by an SQL <code>ORDER BY</code> clause).</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_order'>order</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>date_confirmed DESC</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>readonly</code></h5>

<p>If you use the <code>readonly</code> method, then the associated objects will be read-only when retrieved via the association.</p>

<h5><code>select</code></h5>

<p>The <code>select</code> method lets you override the SQL <code>SELECT</code> clause that is used to retrieve data about the associated objects. By default, Rails retrieves all columns.</p>

<p>WARNING: If you specify your own <code>select</code>, be sure to include the primary key and foreign key columns of the associated model. If you do not, Rails will throw an error.</p>

<h5><code>distinct</code></h5>

<p>Use the <code>distinct</code> method to keep the collection free of duplicates. This is
mostly useful together with the <code>:through</code> option.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:readings</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:articles</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:readings</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='const'>Person</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>John</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_article'>article</span>   <span class='op'>=</span> <span class='const'>Article</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>a1</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_articles'>articles</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_article'>article</span>
<span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_articles'>articles</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_article'>article</span>
<span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_articles'>articles</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span> <span class='comment'># =&gt; [#&lt;Article id: 5, name: &quot;a1&quot;&gt;, #&lt;Article id: 5, name: &quot;a1&quot;&gt;]
</span><span class='const'>Reading</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>  <span class='comment'># =&gt; [#&lt;Reading id: 12, person_id: 5, article_id: 5&gt;, #&lt;Reading id: 13, person_id: 5, article_id: 5&gt;]
</span></code></pre>

<p>In the above case there are two readings and <code>person.articles</code> brings out both of
them even though these records are pointing to the same article.</p>

<p>Now let&#39;s set <code>distinct</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Person</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:readings</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:articles</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_distinct'>distinct</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>through:</span> <span class='symbol'>:readings</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='const'>Person</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Honda</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_article'>article</span>   <span class='op'>=</span> <span class='const'>Article</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>a1</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_articles'>articles</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_article'>article</span>
<span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_articles'>articles</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_article'>article</span>
<span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_articles'>articles</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span> <span class='comment'># =&gt; [#&lt;Article id: 7, name: &quot;a1&quot;&gt;]
</span><span class='const'>Reading</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>  <span class='comment'># =&gt; [#&lt;Reading id: 16, person_id: 7, article_id: 7&gt;, #&lt;Reading id: 17, person_id: 7, article_id: 7&gt;]
</span></code></pre>

<p>In the above case there are still two readings. However <code>person.articles</code> shows
only one article because the collection loads only unique records.</p>

<p>If you want to make sure that, upon insertion, all of the records in the
persisted association are distinct (so that you can be sure that when you
inspect the association that you will never find duplicate records), you should
add a unique index on the table itself. For example, if you have a table named
<code>readings</code> and you want to make sure the articles can only be added to a person once,
you could add the following in a migration:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_index'>add_index</span> <span class='symbol'>:readings</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='symbol'>:person_id</span><span class='comma'>,</span> <span class='symbol'>:article_id</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>unique:</span> <span class='kw'>true</span>
</code></pre>

<p>Once you have this unique index, attempting to add the article to a person twice
will raise an <code>ActiveRecord::RecordNotUnique</code> error:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_person'>person</span> <span class='op'>=</span> <span class='const'>Person</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Honda</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_article'>article</span> <span class='op'>=</span> <span class='const'>Article</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>a1</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_articles'>articles</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_article'>article</span>
<span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_articles'>articles</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_article'>article</span> <span class='comment'># =&gt; ActiveRecord::RecordNotUnique
</span></code></pre>

<p>Note that checking for uniqueness using something like <code>include?</code> is subject
to race conditions. Do not attempt to use <code>include?</code> to enforce distinctness
in an association. For instance, using the article example from above, the
following code would be racy because multiple users could be attempting this
at the same time:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_articles'>articles</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_article'>article</span> <span class='kw'>unless</span> <span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_articles'>articles</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_article'>article</span><span class='rparen'>)</span>
</code></pre>

<h4>When are Objects Saved?</h4>

<p>When you assign an object to a <code>has_many</code> association, that object is automatically saved (in order to update its foreign key). If you assign multiple objects in one statement, then they are all saved.</p>

<p>If any of these saves fails due to validation errors, then the assignment statement returns <code>false</code> and the assignment itself is cancelled.</p>

<p>If the parent object (the one declaring the <code>has_many</code> association) is unsaved (that is, <code>new_record?</code> returns <code>true</code>) then the child objects are not saved when they are added. All unsaved members of the association will automatically be saved when the parent is saved.</p>

<p>If you want to assign an object to a <code>has_many</code> association without saving the object, use the <code>collection.build</code> method.</p>

<h3><code>has_and_belongs_to_many</code> Association Reference</h3>

<p>The <code>has_and_belongs_to_many</code> association creates a many-to-many relationship with another model. In database terms, this associates two classes via an intermediate join table that includes foreign keys referring to each of the classes.</p>

<h4>Methods Added by <code>has_and_belongs_to_many</code></h4>

<p>When you declare a <code>has_and_belongs_to_many</code> association, the declaring class automatically gains 16 methods related to the association:</p>

<ul>
<li><code>collection</code></li>
<li><code>collection&lt;&lt;(object, ...)</code></li>
<li><code>collection.delete(object, ...)</code></li>
<li><code>collection.destroy(object, ...)</code></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><code>collection.clear</code></li>
<li><code>collection.empty?</code></li>
<li><code>collection.size</code></li>
<li><code>collection.find(...)</code></li>
<li><code>collection.where(...)</code></li>
<li><code>collection.exists?(...)</code></li>
<li><code>collection.build(attributes = {})</code></li>
<li><code>collection.create(attributes = {})</code></li>
<li><code>collection.create!(attributes = {})</code></li>
</ul>

<p>In all of these methods, <code>collection</code> is replaced with the symbol passed as the first argument to <code>has_and_belongs_to_many</code>, and <code>collection_singular</code> is replaced with the singularized version of that symbol. For example, given the declaration:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Part</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:assemblies</span>
<span class='kw'>end</span>
</code></pre>

<p>Each instance of the <code>Part</code> model will have these methods:</p>

<pre class="code ruby"><code class="ruby">assemblies
assemblies&lt;&lt;(object, ...)
assemblies.delete(object, ...)
assemblies.destroy(object, ...)
assemblies=(objects)
assembly_ids
assembly_ids=(ids)
assemblies.clear
assemblies.empty?
assemblies.size
assemblies.find(...)
assemblies.where(...)
assemblies.exists?(...)
assemblies.build(attributes = {}, ...)
assemblies.create(attributes = {})
assemblies.create!(attributes = {})
</code></pre>

<h5>Additional Column Methods</h5>

<p>If the join table for a <code>has_and_belongs_to_many</code> association has additional columns beyond the two foreign keys, these columns will be added as attributes to records retrieved via that association. Records returned with additional attributes will always be read-only, because Rails cannot save changes to those attributes.</p>

<p>WARNING: The use of extra attributes on the join table in a <code>has_and_belongs_to_many</code> association is deprecated. If you require this sort of complex behavior on the table that joins two models in a many-to-many relationship, you should use a <code>has_many :through</code> association instead of <code>has_and_belongs_to_many</code>.</p>

<h5><code>collection</code></h5>

<p>The <code>collection</code> method returns an array of all of the associated objects. If there are no associated objects, it returns an empty array.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@assemblies</span> <span class='op'>=</span> <span class='ivar'>@part</span><span class='period'>.</span><span class='id identifier rubyid_assemblies'>assemblies</span>
</code></pre>

<h5><code>collection&lt;&lt;(object, ...)</code></h5>

<p>The <code>collection&lt;&lt;</code> method adds one or more objects to the collection by creating records in the join table.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@part</span><span class='period'>.</span><span class='id identifier rubyid_assemblies'>assemblies</span> <span class='op'>&lt;&lt;</span> <span class='ivar'>@assembly1</span>
</code></pre>

<p>NOTE: This method is aliased as <code>collection.concat</code> and <code>collection.push</code>.</p>

<h5><code>collection.delete(object, ...)</code></h5>

<p>The <code>collection.delete</code> method removes one or more objects from the collection by deleting records in the join table. This does not destroy the objects.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@part</span><span class='period'>.</span><span class='id identifier rubyid_assemblies'>assemblies</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='ivar'>@assembly1</span><span class='rparen'>)</span>
</code></pre>

<p>WARNING: This does not trigger callbacks on the join records.</p>

<h5><code>collection.destroy(object, ...)</code></h5>

<p>The <code>collection.destroy</code> method removes one or more objects from the collection by running <code>destroy</code> on each record in the join table, including running callbacks. This does not destroy the objects.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@part</span><span class='period'>.</span><span class='id identifier rubyid_assemblies'>assemblies</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span><span class='lparen'>(</span><span class='ivar'>@assembly1</span><span class='rparen'>)</span>
</code></pre>

<h5><code>collection=(objects)</code></h5>

<p>The <code>collection=</code> method makes the collection contain only the supplied objects, by adding and deleting as appropriate.</p>

<h5><code>collection_singular_ids</code></h5>

<p>The <code>collection_singular_ids</code> method returns an array of the ids of the objects in the collection.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@assembly_ids</span> <span class='op'>=</span> <span class='ivar'>@part</span><span class='period'>.</span><span class='id identifier rubyid_assembly_ids'>assembly_ids</span>
</code></pre>

<h5><code>collection_singular_ids=(ids)</code></h5>

<p>The <code>collection_singular_ids=</code> method makes the collection contain only the objects identified by the supplied primary key values, by adding and deleting as appropriate.</p>

<h5><code>collection.clear</code></h5>

<p>The <code>collection.clear</code> method removes every object from the collection by deleting the rows from the joining table. This does not destroy the associated objects.</p>

<h5><code>collection.empty?</code></h5>

<p>The <code>collection.empty?</code> method returns <code>true</code> if the collection does not contain any associated objects.</p>

<pre class="code ruby"><code class="ruby">&lt;% if @part.assemblies.empty? %&gt;
  This part is not used in any assemblies
&lt;% end %&gt;
</code></pre>

<h5><code>collection.size</code></h5>

<p>The <code>collection.size</code> method returns the number of objects in the collection.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@assembly_count</span> <span class='op'>=</span> <span class='ivar'>@part</span><span class='period'>.</span><span class='id identifier rubyid_assemblies'>assemblies</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>
</code></pre>

<h5><code>collection.find(...)</code></h5>

<p>The <code>collection.find</code> method finds objects within the collection. It uses the same syntax and options as <code>ActiveRecord::Base.find</code>. It also adds the additional condition that the object must be in the collection.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@assembly</span> <span class='op'>=</span> <span class='ivar'>@part</span><span class='period'>.</span><span class='id identifier rubyid_assemblies'>assemblies</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span>
</code></pre>

<h5><code>collection.where(...)</code></h5>

<p>The <code>collection.where</code> method finds objects within the collection based on the conditions supplied but the objects are loaded lazily meaning that the database is queried only when the object(s) are accessed. It also adds the additional condition that the object must be in the collection.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@new_assemblies</span> <span class='op'>=</span> <span class='ivar'>@part</span><span class='period'>.</span><span class='id identifier rubyid_assemblies'>assemblies</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>created_at &gt; ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='period'>.</span><span class='id identifier rubyid_days'>days</span><span class='period'>.</span><span class='id identifier rubyid_ago'>ago</span><span class='rparen'>)</span>
</code></pre>

<h5><code>collection.exists?(...)</code></h5>

<p>The <code>collection.exists?</code> method checks whether an object meeting the supplied
conditions exists in the collection. It uses the same syntax and options as
<a href="http://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>ActiveRecord::Base.exists?</code></a>.</p>

<h5><code>collection.build(attributes = {})</code></h5>

<p>The <code>collection.build</code> method returns a new object of the associated type. This object will be instantiated from the passed attributes, and the link through the join table will be created, but the associated object will <em>not</em> yet be saved.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@assembly</span> <span class='op'>=</span> <span class='ivar'>@part</span><span class='period'>.</span><span class='id identifier rubyid_assemblies'>assemblies</span><span class='period'>.</span><span class='id identifier rubyid_build'>build</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='label'>assembly_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Transmission housing</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>
</code></pre>

<h5><code>collection.create(attributes = {})</code></h5>

<p>The <code>collection.create</code> method returns a new object of the associated type. This object will be instantiated from the passed attributes, the link through the join table will be created, and, once it passes all of the validations specified on the associated model, the associated object <em>will</em> be saved.</p>

<pre class="code ruby"><code class="ruby"><span class='ivar'>@assembly</span> <span class='op'>=</span> <span class='ivar'>@part</span><span class='period'>.</span><span class='id identifier rubyid_assemblies'>assemblies</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='label'>assembly_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Transmission housing</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>
</code></pre>

<h5><code>collection.create!(attributes = {})</code></h5>

<p>Does the same as <code>collection.create</code>, but raises <code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<h4>Options for <code>has_and_belongs_to_many</code></h4>

<p>While Rails uses intelligent defaults that will work well in most situations, there may be times when you want to customize the behavior of the <code>has_and_belongs_to_many</code> association reference. Such customizations can easily be accomplished by passing options when you create the association. For example, this association uses two such options:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Parts</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:assemblies</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_readonly'>readonly</span> <span class='rbrace'>}</span><span class='comma'>,</span>
                                       <span class='label'>autosave:</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</code></pre>

<p>The <code>has_and_belongs_to_many</code> association supports these options:</p>

<ul>
<li><code>:association_foreign_key</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:foreign_key</code></li>
<li><code>:join_table</code></li>
<li><code>:validate</code></li>
</ul>

<h5><code>:association_foreign_key</code></h5>

<p>By convention, Rails assumes that the column in the join table used to hold the foreign key pointing to the other model is the name of that model with the suffix <code>_id</code> added. The <code>:association_foreign_key</code> option lets you set the name of the foreign key directly:</p>

<p>TIP: The <code>:foreign_key</code> and <code>:association_foreign_key</code> options are useful when setting up a many-to-many self-join. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:friends</span><span class='comma'>,</span>
      <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>this_user_id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='label'>association_foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>other_user_id</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h5><code>:autosave</code></h5>

<p>If you set the <code>:autosave</code> option to <code>true</code>, Rails will save any loaded members and destroy members that are marked for destruction whenever you save the parent object.</p>

<h5><code>:class_name</code></h5>

<p>If the name of the other model cannot be derived from the association name, you can use the <code>:class_name</code> option to supply the model name. For example, if a part has many assemblies, but the actual name of the model containing assemblies is <code>Gadget</code>, you&#39;d set things up this way:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Parts</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:assemblies</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Gadget</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h5><code>:foreign_key</code></h5>

<p>By convention, Rails assumes that the column in the join table used to hold the foreign key pointing to this model is the name of this model with the suffix <code>_id</code> added. The <code>:foreign_key</code> option lets you set the name of the foreign key directly:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>User</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:friends</span><span class='comma'>,</span>
      <span class='label'>class_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='label'>foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>this_user_id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='label'>association_foreign_key:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>other_user_id</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h5><code>:join_table</code></h5>

<p>If the default name of the join table, based on lexical ordering, is not what you want, you can use the <code>:join_table</code> option to override the default.</p>

<h5><code>:validate</code></h5>

<p>If you set the <code>:validate</code> option to <code>false</code>, then associated objects will not be validated whenever you save this object. By default, this is <code>true</code>: associated objects will be validated when this object is saved.</p>

<h4>Scopes for <code>has_and_belongs_to_many</code></h4>

<p>There may be times when you wish to customize the query used by <code>has_and_belongs_to_many</code>. Such customizations can be achieved via a scope block. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Parts</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:assemblies</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_where'>where</span> <span class='label'>active:</span> <span class='kw'>true</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<p>You can use any of the standard <a href="active_record_querying.html">querying methods</a> inside the scope block. The following ones are discussed below:</p>

<ul>
<li><code>where</code></li>
<li><code>extending</code></li>
<li><code>group</code></li>
<li><code>includes</code></li>
<li><code>limit</code></li>
<li><code>offset</code></li>
<li><code>order</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
<li><code>distinct</code></li>
</ul>

<h5><code>where</code></h5>

<p>The <code>where</code> method lets you specify the conditions that the associated object must meet.</p>

<pre class="code ruby"><code class="ruby">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    #=&gt; { where &quot;factory = &#39;Seattle&#39;&quot; }
end
</code></pre>

<p>You can also set conditions via a hash:</p>

<pre class="code ruby"><code class="ruby">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    #=&gt; { where factory: &#39;Seattle&#39; }
end
</code></pre>

<p>If you use a hash-style <code>where</code>, then record creation via this association will be automatically scoped using the hash. In this case, using <code>@parts.assemblies.create</code> or <code>@parts.assemblies.build</code> will create orders where the <code>factory</code> column has the value &quot;Seattle&quot;.</p>

<h5><code>extending</code></h5>

<p>The <code>extending</code> method specifies a named module to extend the association proxy. Association extensions are discussed in detail <a href="#association-extensions">later in this guide</a>.</p>

<h5><code>group</code></h5>

<p>The <code>group</code> method supplies an attribute name to group the result set by, using a <code>GROUP BY</code> clause in the finder SQL.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Parts</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_and_belongs_to_many'>has_and_belongs_to_many</span> <span class='symbol'>:assemblies</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_group'>group</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>factory</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<h5><code>includes</code></h5>

<p>You can use the <code>includes</code> method to specify second-order associations that should be eager-loaded when this association is used.</p>

<h5><code>limit</code></h5>

<p>The <code>limit</code> method lets you restrict the total number of objects that will be fetched through an association.</p>

<pre class="code ruby"><code class="ruby">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    #=&gt; { order(&quot;created_at DESC&quot;).limit(50) }
end
</code></pre>

<h5><code>offset</code></h5>

<p>The <code>offset</code> method lets you specify the starting offset for fetching objects via an association. For example, if you set <code>offset(11)</code>, it will skip the first 11 records.</p>

<h5><code>order</code></h5>

<p>The <code>order</code> method dictates the order in which associated objects will be received (in the syntax used by an SQL <code>ORDER BY</code> clause).</p>

<pre class="code ruby"><code class="ruby">class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    #=&gt; { order &quot;assembly_name ASC&quot; }
end
</code></pre>

<h5><code>readonly</code></h5>

<p>If you use the <code>readonly</code> method, then the associated objects will be read-only when retrieved via the association.</p>

<h5><code>select</code></h5>

<p>The <code>select</code> method lets you override the SQL <code>SELECT</code> clause that is used to retrieve data about the associated objects. By default, Rails retrieves all columns.</p>

<h5><code>distinct</code></h5>

<p>Use the <code>distinct</code> method to remove duplicates from the collection.</p>

<h4>When are Objects Saved?</h4>

<p>When you assign an object to a <code>has_and_belongs_to_many</code> association, that object is automatically saved (in order to update the join table). If you assign multiple objects in one statement, then they are all saved.</p>

<p>If any of these saves fails due to validation errors, then the assignment statement returns <code>false</code> and the assignment itself is cancelled.</p>

<p>If the parent object (the one declaring the <code>has_and_belongs_to_many</code> association) is unsaved (that is, <code>new_record?</code> returns <code>true</code>) then the child objects are not saved when they are added. All unsaved members of the association will automatically be saved when the parent is saved.</p>

<p>If you want to assign an object to a <code>has_and_belongs_to_many</code> association without saving the object, use the <code>collection.build</code> method.</p>

<h3>Association Callbacks</h3>

<p>Normal callbacks hook into the life cycle of Active Record objects, allowing you to work with those objects at various points. For example, you can use a <code>:before_save</code> callback to cause something to happen just before an object is saved.</p>

<p>Association callbacks are similar to normal callbacks, but they are triggered by events in the life cycle of a collection. There are four available association callbacks:</p>

<ul>
<li><code>before_add</code></li>
<li><code>after_add</code></li>
<li><code>before_remove</code></li>
<li><code>after_remove</code></li>
</ul>

<p>You define association callbacks by adding options to the association declaration. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='label'>before_add:</span> <span class='symbol'>:check_credit_limit</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_check_credit_limit'>check_credit_limit</span><span class='lparen'>(</span><span class='id identifier rubyid_book'>book</span><span class='rparen'>)</span>
    <span class='comment'>#...
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Rails passes the object being added or removed to the callback.</p>

<p>You can stack callbacks on a single event by passing them as an array:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span>
    <span class='label'>before_add:</span> <span class='lbracket'>[</span><span class='symbol'>:check_credit_limit</span><span class='comma'>,</span> <span class='symbol'>:calculate_shipping_charges</span><span class='rbracket'>]</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_check_credit_limit'>check_credit_limit</span><span class='lparen'>(</span><span class='id identifier rubyid_book'>book</span><span class='rparen'>)</span>
    <span class='comment'>#...
</span>  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_calculate_shipping_charges'>calculate_shipping_charges</span><span class='lparen'>(</span><span class='id identifier rubyid_book'>book</span><span class='rparen'>)</span>
    <span class='comment'>#...
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If a <code>before_add</code> callback throws an exception, the object does not get added to the collection. Similarly, if a <code>before_remove</code> callback throws an exception, the object does not get removed from the collection.</p>

<h3>Association Extensions</h3>

<p>You&#39;re not limited to the functionality that Rails automatically builds into association proxy objects. You can also extend these objects through anonymous modules, adding new finders, creators, or other methods. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_find_by_book_prefix'>find_by_book_prefix</span><span class='lparen'>(</span><span class='id identifier rubyid_book_number'>book_number</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>category_id:</span> <span class='id identifier rubyid_book_number'>book_number</span><span class='lbracket'>[</span><span class='int'>0</span><span class='op'>..</span><span class='int'>2</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If you have an extension that should be shared by many associations, you can use a named extension module. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>FindRecentExtension</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_find_recent'>find_recent</span>
    <span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>created_at &gt; ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>5</span><span class='period'>.</span><span class='id identifier rubyid_days'>days</span><span class='period'>.</span><span class='id identifier rubyid_ago'>ago</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Author</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:books</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_extending'>extending</span> <span class='const'>FindRecentExtension</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>Supplier</span> <span class='op'>&lt;</span> <span class='const'>ApplicationRecord</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:deliveries</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_extending'>extending</span> <span class='const'>FindRecentExtension</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<p>Extensions can refer to the internals of the association proxy using these three attributes of the <code>proxy_association</code> accessor:</p>

<ul>
<li><code>proxy_association.owner</code> returns the object that the association is a part of.</li>
<li><code>proxy_association.reflection</code> returns the reflection object that describes the association.</li>
<li><code>proxy_association.target</code> returns the associated object for <code>belongs_to</code> or <code>has_one</code>, or the collection of associated objects for <code>has_many</code> or <code>has_and_belongs_to_many</code>.</li>
</ul>

<h2>Single Table Inheritance</h2>

<p>Sometimes, you may want to share fields and behavior between different models.
Let&#39;s say we have Car, Motorcycle and Bicycle models. We will want to share
the <code>color</code> and <code>price</code> fields and some methods for all of them, but having some
specific behavior for each, and separated controllers too.</p>

<p>Rails makes this quite easy. First, let&#39;s generate the base Vehicle model:</p>

<pre class="code bash"><code class="bash">$ rails generate model vehicle type:string color:string price:decimal{10.2}
</code></pre>

<p>Did you note we are adding a &quot;type&quot; field? Since all models will be saved in a
single database table, Rails will save in this column the name of the model that
is being saved. In our example, this can be &quot;Car&quot;, &quot;Motorcycle&quot; or &quot;Bicycle.&quot;
STI won&#39;t work without a &quot;type&quot; field in the table.</p>

<p>Next, we will generate the three models that inherit from Vehicle. For this,
we can use the <code>--parent=PARENT</code> option, which will generate a model that
inherits from the specified parent and without equivalent migration (since the
table already exists).</p>

<p>For example, to generate the Car model:</p>

<pre class="code bash"><code class="bash">$ rails generate model car --parent=Vehicle
</code></pre>

<p>The generated model will look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Car</span> <span class='op'>&lt;</span> <span class='const'>Vehicle</span>
<span class='kw'>end</span>
</code></pre>

<p>This means that all behavior added to Vehicle is available for Car too, as
associations, public methods, etc.</p>

<p>Creating a car will save it in the <code>vehicles</code> table with &quot;Car&quot; as the <code>type</code> field:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Car</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>color:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Red</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>price:</span> <span class='int'>10000</span><span class='rparen'>)</span>
</code></pre>

<p>will generate the following SQL:</p>

<pre class="code sql"><code class="sql">INSERT INTO &quot;vehicles&quot; (&quot;type&quot;, &quot;color&quot;, &quot;price&quot;) VALUES (&#39;Car&#39;, &#39;Red&#39;, 10000)
</code></pre>

<p>Querying car records will just search for vehicles that are cars:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Car</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span>
</code></pre>

<p>will run a query like:</p>

<pre class="code sql"><code class="sql">SELECT &quot;vehicles&quot;.* FROM &quot;vehicles&quot; WHERE &quot;vehicles&quot;.&quot;type&quot; IN (&#39;Car&#39;)
</code></pre>

<div id='footer'>
  Generated by
  <a href='http://yardoc.org' title='Yay! A Ruby Documentation Tool' target="_parent">yard</a>
  0.9.0 with <a href='https://msp-greg.github.io/yard-t2/' title='yard-t2' target="_parent">yard-t2</a> 0.6.0 (ruby-2.3.2p135)
</div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</div> <!-- tbl_cont -->
</body>
</html>