<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: SyntaxSuggest::BlockExpand &mdash; syntax_suggest  Ruby-3.4.6 p54</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "SyntaxSuggest::BlockExpand",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Ruby-3.4.6</a> &raquo; 
      <a href='../'>syntax_suggest</a> &raquo; 
      <a href='../_index.html#alpha_B'>Index (B)</a> &raquo; 
        <a href="../SyntaxSuggest.html" title="SyntaxSuggest (module)">SyntaxSuggest</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>BlockExpand&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: SyntaxSuggest::BlockExpand</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ruby/ruby/blob/v3_4_6/lib/syntax_suggest/block_expand.rb#L33'>lib/syntax_suggest/block_expand.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>This class is responsible for taking a code block that exists at a far indentaion and then iteratively increasing the block so that it captures everything within the same indentation block.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_dog'>dog</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bow</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>wow</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

<p>block = <a href="#new-class_method" title="SyntaxSuggest::BlockExpand.new (method)">.new</a>(code_lines: code_lines)</p>

<pre class="code ruby"><code class="ruby">.<span class='id identifier rubyid_call'><a href="#call-instance_method" title="SyntaxSuggest::BlockExpand#call (method)">call</a></span>(<span class='const'><a href="CodeBlock.html" title="SyntaxSuggest::CodeBlock (class)">CodeBlock</a></span>.<span class='id identifier rubyid_new'><a href="CodeBlock.html#new-class_method" title="SyntaxSuggest::CodeBlock.new (method)">new</a></span>(<span class='label'>lines:</span> <span class='id identifier rubyid_code_lines'>code_lines</span>[<span class='int'>1</span>]))</code></pre>

<p>puts block.to_s</p>

<h3 id="label-3D-3E+puts+-22bow-22">=&gt; puts “bow”</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>wow</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>Once a code block has captured everything at a given indentation level then it will expand to capture surrounding indentation.</p>

<p>block = <a href="#new-class_method" title="SyntaxSuggest::BlockExpand.new (method)">.new</a>(code_lines: code_lines)</p>

<pre class="code ruby"><code class="ruby">.<span class='id identifier rubyid_call'><a href="#call-instance_method" title="SyntaxSuggest::BlockExpand#call (method)">call</a></span>(<span class='id identifier rubyid_block'>block</span>)</code></pre>

<p>block.to_s</p>

<h3 id="label-3D-3E+def+dog">=&gt; def dog</h3>

<pre class="code ruby"><code class="ruby">  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bow</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>wow</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>

  </div>
</div>
</div>
<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(code_lines:)  &#x21d2; BlockExpand </a>
    </span>
    <span class='note title constructor'>constructor</span>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#call-instance_method" title="#call (instance method)">#<strong>call</strong>(block)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Main interface.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#expand_indent-instance_method" title="#expand_indent (instance method)">#<strong>expand_indent</strong>(block)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Expands code to the next lowest indentation.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#expand_neighbors-instance_method" title="#expand_neighbors (instance method)">#<strong>expand_neighbors</strong>(block)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>A neighbor is code that is at or above the current indent line.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#inspect-instance_method" title="#inspect (instance method)">#<strong>inspect</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Manageable rspec errors.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(code_lines:)  &#x21d2; <code>BlockExpand</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_4_6/lib/syntax_suggest/block_expand.rb#L34-L36'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='34' data-end='36'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/block_expand.rb', line 34</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='label'>code_lines:</span>)
  <span class='ivar'>@code_lines</span> <span class='op'>=</span> <span class='id identifier rubyid_code_lines'>code_lines</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="call-instance_method">
  <h3 class='signature  first'>
    #<strong>call</strong>(block)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Main interface. Expand current indentation, before expanding to a lower indentation</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_4_6/lib/syntax_suggest/block_expand.rb#L40-L46'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='40' data-end='46'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/block_expand.rb', line 40</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>if</span> (<span class='id identifier rubyid_next_block'>next_block</span> <span class='op'>=</span> <span class='id identifier rubyid_expand_neighbors'><a href="#expand_neighbors-instance_method" title="SyntaxSuggest::BlockExpand#expand_neighbors (method)">expand_neighbors</a></span>(<span class='id identifier rubyid_block'>block</span>))
    <span class='id identifier rubyid_next_block'>next_block</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_expand_indent'><a href="#expand_indent-instance_method" title="SyntaxSuggest::BlockExpand#expand_indent (method)">expand_indent</a></span>(<span class='id identifier rubyid_block'>block</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="expand_indent-instance_method">
  <h3 class='signature '>
    #<strong>expand_indent</strong>(block)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Expands code to the next lowest indentation</p>

<p>For example:</p>

<pre class="code ruby"><code class="ruby"><span class='int'>1</span> <span class='kw'>def</span> <span class='id identifier rubyid_dog'>dog</span>
<span class='int'>2</span>   <span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dog</span><span class='tstring_end'>&quot;</span></span>
<span class='int'>3</span> <span class='kw'>end</span></code></pre>

<p>If a block starts on line 2 then it has captured all it’s “neighbors” (code at the same indentation or higher). To continue expanding, this block must capture lines one and three which are at a different indentation level.</p>

<p>This method allows fully expanded blocks to decrease their indentation level (so they can expand to capture more code up and down). It does this conservatively as there’s no undo (currently).</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_4_6/lib/syntax_suggest/block_expand.rb#L63-L72'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='72'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/block_expand.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_expand_indent'>expand_indent</span>(<span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'><a href="AroundBlockScan.html" title="SyntaxSuggest::AroundBlockScan (class)">AroundBlockScan</a></span>.<span class='id identifier rubyid_new'><a href="AroundBlockScan.html#new-class_method" title="SyntaxSuggest::AroundBlockScan.new (method)">new</a></span>(<span class='label'>code_lines:</span> <span class='ivar'>@code_lines</span><span class='comma'>,</span> <span class='label'>block:</span> <span class='id identifier rubyid_block'>block</span>)
    .<span class='id identifier rubyid_force_add_hidden'>force_add_hidden</span>
    .<span class='id identifier rubyid_stop_after_kw'>stop_after_kw</span>
    .<span class='id identifier rubyid_scan_adjacent_indent'>scan_adjacent_indent</span>

  <span class='id identifier rubyid_now'>now</span>.<span class='id identifier rubyid_lookahead_balance_one_line'>lookahead_balance_one_line</span>

  <span class='id identifier rubyid_now'>now</span>.<span class='id identifier rubyid_code_block'>code_block</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="expand_neighbors-instance_method">
  <h3 class='signature '>
    #<strong>expand_neighbors</strong>(block)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>A neighbor is code that is at or above the current indent line.</p>

<p>First we build a block with all neighbors. If we can’t go further then we decrease the indentation threshold and expand via indentation i.e. <a href="#expand_indent-instance_method" title="SyntaxSuggest::BlockExpand#expand_indent (method)">#expand_indent</a></p>

<p>Handles two general cases.</p>

<h4 id="label-Case+-231-3A+Check+code+inside+of+methods-2Fclasses-2Fetc.">Case #1: Check code inside of methods/classes/etc.</h4>

<p>It’s important to note, that not everything in a given indentation level can be parsed as valid code even if it’s part of valid code. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='int'>1</span> <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> {
<span class='int'>2</span>   <span class='id identifier rubyid_name'>name</span><span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>richard</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
<span class='int'>3</span>   <span class='id identifier rubyid_dog'>dog</span><span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cinco</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
<span class='int'>4</span> }</code></pre>

<p>In this case lines 2 and 3 will be neighbors, but they’re invalid until <a href="#expand_indent-instance_method" title="SyntaxSuggest::BlockExpand#expand_indent (method)">#expand_indent</a> is called on them.</p>

<p>When we are adding code within a method or class (at the same indentation level), use the empty lines to denote the programmer intended logical chunks. Stop and check each one. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='int'>1</span> <span class='kw'>def</span> <span class='id identifier rubyid_dog'>dog</span>
<span class='int'>2</span>   <span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dog</span><span class='tstring_end'>&quot;</span></span>
<span class='int'>3</span>
<span class='int'>4</span>   <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> {
<span class='int'>5</span> <span class='kw'>end</span></code></pre>

<p>If we did not stop parsing at empty newlines then the block might mistakenly grab all the contents (lines 2, 3, and 4) and report them as being problems, instead of only line 4.</p>

<h4 id="label-Case+-232-3A+Expand-2Fgrab+other+logical+blocks">Case #2: Expand/grab other logical blocks</h4>

<p>Once the search algorithm has converted all lines into blocks at a given indentation it will then <a href="#expand_indent-instance_method" title="SyntaxSuggest::BlockExpand#expand_indent (method)">#expand_indent</a>. Once the blocks that generates are expanded as neighbors we then begin seeing neighbors being other logical blocks i.e. a block’s neighbors may be another method or class (something with keywords/ends).</p>

<p>For example:</p>

<pre class="code ruby"><code class="ruby"><span class='int'>1</span> <span class='kw'>def</span> <span class='id identifier rubyid_bark'>bark</span>
<span class='int'>2</span>
<span class='int'>3</span> <span class='kw'>end</span>
<span class='int'>4</span>
<span class='int'>5</span> <span class='kw'>def</span> <span class='id identifier rubyid_sit'>sit</span>
<span class='int'>6</span> <span class='kw'>end</span></code></pre>

<p>In this case if lines 4, 5, and 6 are in a block when it tries to expand neighbors it will expand up. If it stops after line 2 or 3 it may cause problems since there’s a valid kw/end pair, but the block will be checked without it.</p>

<p>We try to resolve this edge case with <code>lookahead_balance_one_line</code> below.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_4_6/lib/syntax_suggest/block_expand.rb#L130-L158'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='130' data-end='158'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/block_expand.rb', line 130</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_expand_neighbors'>expand_neighbors</span>(<span class='id identifier rubyid_block'>block</span>)
  <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'><a href="AroundBlockScan.html" title="SyntaxSuggest::AroundBlockScan (class)">AroundBlockScan</a></span>.<span class='id identifier rubyid_new'><a href="AroundBlockScan.html#new-class_method" title="SyntaxSuggest::AroundBlockScan.new (method)">new</a></span>(<span class='label'>code_lines:</span> <span class='ivar'>@code_lines</span><span class='comma'>,</span> <span class='label'>block:</span> <span class='id identifier rubyid_block'>block</span>)

  <span class='comment'># Initial scan
</span>  <span class='id identifier rubyid_now'>now</span>
    .<span class='id identifier rubyid_force_add_hidden'>force_add_hidden</span>
    .<span class='id identifier rubyid_stop_after_kw'>stop_after_kw</span>
    .<span class='id identifier rubyid_scan_neighbors_not_empty'>scan_neighbors_not_empty</span>

  <span class='comment'># Slurp up empties
</span>  <span class='id identifier rubyid_now'>now</span>
    .<span class='id identifier rubyid_scan_while'>scan_while</span> { <span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span> <span class='id identifier rubyid_line'>line</span>.<span class='id identifier rubyid_empty?'>empty?</span> }

  <span class='comment'># If next line is kw and it will balance us, take it
</span>  <span class='id identifier rubyid_expanded_lines'>expanded_lines</span> <span class='op'>=</span> <span class='id identifier rubyid_now'>now</span>
    .<span class='id identifier rubyid_lookahead_balance_one_line'>lookahead_balance_one_line</span>
    .<span class='id identifier rubyid_lines'>lines</span>

  <span class='comment'># Don&#39;t allocate a block if it won&#39;t be used
</span>  <span class='comment'>#
</span>  <span class='comment'># If nothing was taken, return nil to indicate that status
</span>  <span class='comment'># used in `def call` to determine if
</span>  <span class='comment'># we need to expand up/out (`expand_indent`)
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_block'>block</span>.<span class='id identifier rubyid_lines'>lines</span> <span class='op'>==</span> <span class='id identifier rubyid_expanded_lines'>expanded_lines</span>
    <span class='kw'>nil</span>
  <span class='kw'>else</span>
    <span class='const'><a href="CodeBlock.html" title="SyntaxSuggest::CodeBlock (class)">CodeBlock</a></span>.<span class='id identifier rubyid_new'><a href="CodeBlock.html#new-class_method" title="SyntaxSuggest::CodeBlock.new (method)">new</a></span>(<span class='label'>lines:</span> <span class='id identifier rubyid_expanded_lines'>expanded_lines</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="inspect-instance_method">
  <h3 class='signature '>
    #<strong>inspect</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Manageable rspec errors</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_4_6/lib/syntax_suggest/block_expand.rb#L161-L163'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='161' data-end='163'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/syntax_suggest/block_expand.rb', line 161</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_inspect'>inspect</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;SyntaxSuggest::CodeBlock:0x0000123843lol &gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>