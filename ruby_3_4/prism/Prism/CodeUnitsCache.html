<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Prism::CodeUnitsCache &mdash; prism  Ruby-3.4.6 p54</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Prism::CodeUnitsCache",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../../'>Ruby-3.4.6</a> &raquo; 
      <a href='../'>prism</a> &raquo; 
      <a href='../_index.html#alpha_C'>Index (C)</a> &raquo; 
        <a href="../Prism.html" title="Prism (module)">Prism</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>CodeUnitsCache&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Prism::CodeUnitsCache</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a class='nodoc' href="CodeUnitsCache/LengthCounter.html" title="Prism::CodeUnitsCache::LengthCounter (class)"><code>LengthCounter</code></a>,
        <a class='nodoc' href="CodeUnitsCache/UTF16Counter.html" title="Prism::CodeUnitsCache::UTF16Counter (class)"><code>UTF16Counter</code></a>      </div>
    </td></tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'>Object</span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/ruby/ruby/blob/v3_4_6/lib/prism/parse_result.rb#L190'>lib/prism/parse_result.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>A cache that can be used to quickly compute code unit offsets from byte offsets. It purposefully provides only a single <a href="#[]-instance_method" title="Prism::CodeUnitsCache#[] (method)">#[]</a> method to access the cache in order to minimize surface area.</p>

<p>Note that there are some known issues here that may or may not be addressed in the future:</p>
<ul><li>
<p>The first is that there are issues when the cache computes values that are not on character boundaries. This can result in subsequent computations being off by one or more code units.</p>
</li><li>
<p>The second is that this cache is currently unbounded. In theory we could introduce some kind of LRU cache to limit the number of entries, but this has not yet been implemented.</p>
</li></ul>

  </div>
</div>
</div>
<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(source, encoding)  &#x21d2; CodeUnitsCache </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Initialize a new cache with the given source and encoding.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#[]-instance_method" title="#[] (instance method)">#<strong>[]</strong>(byte_offset)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Retrieve the code units offset from the given byte offset.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(source, encoding)  &#x21d2; <code>CodeUnitsCache</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Initialize a new cache with the given source and encoding.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_4_6/lib/prism/parse_result.rb#L216-L227'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='216' data-end='227'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/prism/parse_result.rb', line 216</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_source'>source</span><span class='comma'>,</span> <span class='id identifier rubyid_encoding'>encoding</span>)
  <span class='ivar'>@source</span> <span class='op'>=</span> <span class='id identifier rubyid_source'>source</span>
  <span class='ivar'>@counter</span> <span class='op'>=</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_encoding'>encoding</span> <span class='op'>==</span> <span class='const'>Encoding</span><span class='op'>::</span><span class='const'>UTF_16LE</span> <span class='op'>||</span> <span class='id identifier rubyid_encoding'>encoding</span> <span class='op'>==</span> <span class='const'>Encoding</span><span class='op'>::</span><span class='const'>UTF_16BE</span>
      <span class='const'><a href="CodeUnitsCache/UTF16Counter.html" title="Prism::CodeUnitsCache::UTF16Counter (class)">UTF16Counter</a></span>.<span class='id identifier rubyid_new'><a href="CodeUnitsCache/UTF16Counter.html#new-class_method" title="Prism::CodeUnitsCache::UTF16Counter.new (method)">new</a></span>(<span class='id identifier rubyid_source'>source</span><span class='comma'>,</span> <span class='id identifier rubyid_encoding'>encoding</span>)
    <span class='kw'>else</span>
      <span class='const'><a href="CodeUnitsCache/LengthCounter.html" title="Prism::CodeUnitsCache::LengthCounter (class)">LengthCounter</a></span>.<span class='id identifier rubyid_new'><a href="CodeUnitsCache/LengthCounter.html#new-class_method" title="Prism::CodeUnitsCache::LengthCounter.new (method)">new</a></span>(<span class='id identifier rubyid_source'>source</span><span class='comma'>,</span> <span class='id identifier rubyid_encoding'>encoding</span>)
    <span class='kw'>end</span>

  <span class='ivar'>@cache</span> <span class='op'>=</span> {} <span class='comment'>#: Hash[Integer, Integer]
</span>  <span class='ivar'>@offsets</span> <span class='op'>=</span> [] <span class='comment'>#: Array[Integer]
</span><span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="[]-instance_method">
  <h3 class='signature  first'>
    #<strong>[]</strong>(byte_offset)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Retrieve the code units offset from the given byte offset.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/ruby/ruby/blob/v3_4_6/lib/prism/parse_result.rb#L230-L243'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='230' data-end='243'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/prism/parse_result.rb', line 230</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='op'>[]</span>(<span class='id identifier rubyid_byte_offset'>byte_offset</span>)
  <span class='ivar'>@cache</span>[<span class='id identifier rubyid_byte_offset'>byte_offset</span>] <span class='op'>||=</span>
    <span class='kw'>if</span> (<span class='id identifier rubyid_index'>index</span> <span class='op'>=</span> <span class='ivar'>@offsets</span>.<span class='id identifier rubyid_bsearch_index'>bsearch_index</span> { <span class='op'>|</span><span class='id identifier rubyid_offset'>offset</span><span class='op'>|</span> <span class='id identifier rubyid_offset'>offset</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_byte_offset'>byte_offset</span> }).<span class='id identifier rubyid_nil?'>nil?</span>
      <span class='ivar'>@offsets</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_byte_offset'>byte_offset</span>
      <span class='ivar'>@counter</span>.<span class='id identifier rubyid_count'>count</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_byte_offset'>byte_offset</span>)
    <span class='kw'>elsif</span> <span class='id identifier rubyid_index'>index</span> <span class='op'>==</span> <span class='int'>0</span>
      <span class='ivar'>@offsets</span>.<span class='id identifier rubyid_unshift'>unshift</span>(<span class='id identifier rubyid_byte_offset'>byte_offset</span>)
      <span class='ivar'>@counter</span>.<span class='id identifier rubyid_count'>count</span>(<span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_byte_offset'>byte_offset</span>)
    <span class='kw'>else</span>
      <span class='ivar'>@offsets</span>.<span class='id identifier rubyid_insert'>insert</span>(<span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='id identifier rubyid_byte_offset'>byte_offset</span>)
      <span class='id identifier rubyid_offset'>offset</span> <span class='op'>=</span> <span class='ivar'>@offsets</span>[<span class='id identifier rubyid_index'>index</span> <span class='op'>-</span> <span class='int'>1</span>]
      <span class='ivar'>@cache</span>[<span class='id identifier rubyid_offset'>offset</span>] <span class='op'>+</span> <span class='ivar'>@counter</span>.<span class='id identifier rubyid_count'>count</span>(<span class='id identifier rubyid_offset'>offset</span><span class='comma'>,</span> <span class='id identifier rubyid_byte_offset'>byte_offset</span> <span class='op'>-</span> <span class='id identifier rubyid_offset'>offset</span>)
    <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>