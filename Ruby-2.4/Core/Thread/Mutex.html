<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Thread::Mutex &mdash; Core Ruby-2.4.0 d2016-08-01</title>

<link rel='stylesheet'  type='text/css' href='../../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/y_color.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/custom.css' />
<link rel='stylesheet'  type='text/css' href='../../../css/common.css' />

<script type='text/javascript'>
  var pathId = "Thread::Mutex",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../../js/y_app.js'></script>

</head>
<body>
  <svg id='y_wait' class='' viewBox='0 0 90 90'></svg>
  <div id='tbl_cont'>
    <div id='y_list' class='d h'>
      <button id='list_sizer' class='y_sizer' title='LIST Resizer'></button>
      <header id='list_header'>
        <div id='list_title'>&#160;</div>
        <div id='list_menu'><span>&#160;</span></div>
        <input  id='list_search_text' type='search' placeholder='Search' size='12' value='' autocomplete='off' class='search_input'/>
        <svg id='list_search_icon' viewBox='0 0 30 30'>
          <path class='s_main' d='M21.189,17.213C22.022,15.726,22.5,14.014,22.5,12.188C22.5,6.493,17.884,1.875,12.188,1.875S1.875,6.493,1.875,12.188C1.875,17.882,6.491,22.5,12.188,22.5c1.826,0,3.536-0.48,5.025-1.311l6.113,6.113C23.873,27.851,24.593,28.125,25.313,28.125s1.44-0.274,1.989-0.823c1.099-1.099,1.099-2.878,0-3.977L21.189,17.213z M12.188,19.329c-3.943,0-7.14-3.197-7.14-7.142c0.0-3.943,3.197-7.14,7.14-7.14c3.941,0,7.14,3.195,7.14,7.14C19.328,16.133,16.129,19.329,12.188,19.329z'/>
          <path class='s_clear' d='M 4.414, 1.586 A 1,1 0 1,0 1.586, 4.414 L 21.586,24.414 A 1,1 0 1,0 24.414,21.586 z' />
          <path class='s_clear' d='M 1.586,21.586 A 1,1 0 1,0 4.414,24.414 L 24.414, 4.414 A 1,1 0 1,0 21.586, 1.586 z' />
        </svg>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All'></button>
      </header>
      <nav id= 'list_nav' class='y_nav l_nav'>
        <ul id='list_items'></ul>
      </nav>
    </div>
    <div id='y_toc' class='f h'>
      <button id='toc_sizer' class='y_sizer' title='TOC Resizer'></button>
      <header id='toc_header'>
        <div>Table of Contents</div>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All' ></button>
      </header>
      <nav id= 'toc_nav' class='y_nav t_nav'>
      <ol id='toc_items'></ol>
      </nav>
    </div>
    <div id='y_main' tabindex='-1'>
      <header id='y_header'>
        <div id='y_menu'>
          <a href='../../../index.html'>Home</a> &raquo; 
          <a href='../../index.html'>Ruby-2.4.0</a> &raquo; 
          <a href='../index.html'>Core</a> &raquo; 
          <a href='../_index.html'>Index (M)</a> &raquo; 
          <a href="../Thread.html" title="Thread (class)">Thread</a> &raquo; 
          <span class='title'>Mutex</span>
        </div>

        <div id='y_measure_em' class='y_measure'></div>
        <div id='y_measure_vh' class='y_measure'></div>
        <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
        <a id='list_href' href="../class_list.html"></a>
        <div id='hdr_button'>
          <button id='src' class='c' title='Source Show / Hide'>S<svg class='c' viewBox='0 0 36 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
              <rect x='20' y='0'  width='4'  height='28' rx='1.0' ry='1.0'/>
            </svg><svg class='o' viewBox='0 0 34 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
            </svg></button>
          <button id='list_loc' class='d' title='LIST Location'>L<svg class='f' viewBox='0 0 36 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='toc_loc' class='f' title='TOC Location'>T<svg class='f' viewBox='0 0 34 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='list_vis' title='LIST Show / Hide'>LIST</button>
          <button id='toc_vis' title='TOC Show / Hide'>TOC</button>
        </div>
        <div id='y_debug'></div>
      </header>
<div id='content' class='class'>

<h1>Class: Thread::Mutex</h1>

<table class='y_box'>
<colgroup>
  <col class='box_1' />
  <col class='box_2' />
</colgroup>
  <tr>
    <td class='box_1'>Inherits:</td>
    <td class='box_rel'>
      <span class='inheritName'><a href="../Object.html" title="Object (class)">Object</a></span>
      <ul class='fullTree'>
        <li><a href="../Object.html" title="Object (class)">Object</a></li>
        <li class='next'>Thread::Mutex</li>
      </ul>
      <a href='#' class='inheritanceTree'>show all</a>
    </td>
  </tr>





  <tr>
  <td class='box_1'>Defined in:</td>
  <td class='box_rel'><div class='box_max'>
<a href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L1240'>thread_sync.c</a></div>  </td>
  </tr>
</table>
<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Mutex implements a simple semaphore that can be used to coordinate access
to shared data from multiple concurrent threads.</p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>thread</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_semaphore'>semaphore</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'><a href="#new-class_method" title="Thread::Mutex.new (method)">new</a></span>

<span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='const'><a href="../Thread.html" title="Thread (class)">Thread</a></span><span class='period'>.</span><span class='id identifier rubyid_new'><a href="../Thread.html#new-class_method" title="Thread.new (method)">new</a></span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_semaphore'>semaphore</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span>
    <span class='comment'># access shared resource
</span>  <span class='rbrace'>}</span>
<span class='rbrace'>}</span>

<span class='id identifier rubyid_b'>b</span> <span class='op'>=</span> <span class='const'><a href="../Thread.html" title="Thread (class)">Thread</a></span><span class='period'>.</span><span class='id identifier rubyid_new'><a href="../Thread.html#new-class_method" title="Thread.new (method)">new</a></span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_semaphore'>semaphore</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span>
    <span class='comment'># access shared resource
</span>  <span class='rbrace'>}</span>
<span class='rbrace'>}</span>
</code></pre>


  </div>
</div>
<div class="tags">
  
</div>




<h2>Class Method Summary
  <small><a href='#' class='summary_toggle'>collapse</a></small>
</h2>

  <ul class='summary'>
    <li>
      <span class="summary_signature">
        <a href="#new-class_method" title="new (class method)">.<strong>new</strong>  &#x21d2; mutex </a>
      </span>
      <span class='note title constructor'>constructor</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Creates a new Mutex</p>
</div>
      </span>
    </li>
  </ul>
<h2>Instance Method Summary
  <small><a href='#' class='summary_toggle'>collapse</a></small>
</h2>

  <ul class='summary'>
    <li>
      <span class="summary_signature">
        <a href="#lock-instance_method" title="#lock (instance method)">#<strong>lock</strong>  &#x21d2; self </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Attempts to grab the lock and waits if it isn&#39;t available.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#locked%3F-instance_method" title="#locked? (instance method)">#<strong>locked?</strong>  &#x21d2; Boolean </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Returns <code>true</code> if this lock is currently held by some thread.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#owned%3F-instance_method" title="#owned? (instance method)">#<strong>owned?</strong>  &#x21d2; Boolean </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Returns <code>true</code> if this lock is currently held by current thread.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#sleep-instance_method" title="#sleep (instance method)">#<strong>sleep</strong>(timeout = nil)  &#x21d2; Numeric </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Releases the lock and sleeps <code>timeout</code> seconds if it is given
and non-nil or forever.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#synchronize-instance_method" title="#synchronize (instance method)">#<strong>synchronize</strong>  &#x21d2; result of the block </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Obtains a lock, runs the block, and releases the lock when the block
completes.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#try_lock-instance_method" title="#try_lock (instance method)">#<strong>try_lock</strong>  &#x21d2; Boolean </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Attempts to obtain the lock and returns immediately.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#unlock-instance_method" title="#unlock (instance method)">#<strong>unlock</strong>  &#x21d2; self </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Releases the lock.</p>
</div>
      </span>
    </li>
  </ul>


<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>
  <section class='method_details first' id="new-class_method">
  <h3 class='signature first'>
  .<strong>new</strong>  &#x21d2; <tt>mutex</tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Creates a new Mutex</p>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L111'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


111
112
113
114
115</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 111</span></pre>
<pre class='code cpp'>

static VALUE
mutex_initialize(VALUE self)
{
    return self;
}
</pre>
  </div>
</div>
</section>
<h2 class='y_details'>Instance Method Details</h2>
  <section class='method_details first' id="lock-instance_method">
  <h3 class='signature first'>
  #<strong>lock</strong>  &#x21d2; <tt>self</tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Attempts to grab the lock and waits if it isn&#39;t available. Raises
<a href="../ThreadError.html" title="ThreadError (class)">ThreadError</a> if <code>mutex</code> was locked by the current thread.</p>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L240'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 240</span></pre>
<pre class='code cpp'>

VALUE
rb_mutex_lock(VALUE self)
{
    rb_thread_t *th = GET_THREAD();
    rb_mutex_t *mutex;
    GetMutexPtr(self, mutex);

    /* When running trap handler */
    if (!mutex-&gt;allow_trap &amp;&amp; th-&gt;interrupt_mask &amp; TRAP_INTERRUPT_MASK) {
	rb_raise(rb_eThreadError, &quot;can&#39;t be called from trap context&quot;);
    }

    if (rb_mutex_trylock(self) == Qfalse) {
	if (mutex-&gt;th == th) {
	    rb_raise(rb_eThreadError, &quot;deadlock; recursive locking&quot;);
	}

	while (mutex-&gt;th != th) {
	    int interrupted;
	    enum rb_thread_status prev_status = th-&gt;status;
	    volatile int timeout_ms = 0;
	    struct rb_unblock_callback oldubf;

	    set_unblock_function(th, lock_interrupt, mutex, &amp;oldubf, FALSE);
	    th-&gt;status = THREAD_STOPPED_FOREVER;
	    th-&gt;locking_mutex = self;

	    native_mutex_lock(&amp;mutex-&gt;lock);
	    th-&gt;vm-&gt;sleeper++;
	    /*
	     * Carefully! while some contended threads are in lock_func(),
	     * vm-&gt;sleepr is unstable value. we have to avoid both deadlock
	     * and busy loop.
	     */
	    if ((vm_living_thread_num(th-&gt;vm) == th-&gt;vm-&gt;sleeper) &amp;&amp;
		!patrol_thread) {
		timeout_ms = 100;
		patrol_thread = th;
	    }

	    GVL_UNLOCK_BEGIN();
	    interrupted = lock_func(th, mutex, (int)timeout_ms);
	    native_mutex_unlock(&amp;mutex-&gt;lock);
	    GVL_UNLOCK_END();

	    if (patrol_thread == th)
		patrol_thread = NULL;

	    reset_unblock_function(th, &amp;oldubf);

	    th-&gt;locking_mutex = Qfalse;
	    if (mutex-&gt;th &amp;&amp; interrupted == 2) {
		rb_check_deadlock(th-&gt;vm);
	    }
	    if (th-&gt;status == THREAD_STOPPED_FOREVER) {
		th-&gt;status = prev_status;
	    }
	    th-&gt;vm-&gt;sleeper--;

	    if (mutex-&gt;th == th) mutex_locked(th, self);

	    if (interrupted) {
		RUBY_VM_CHECK_INTS_BLOCKING(th);
	    }
	}
    }
    return self;
}
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="locked?-instance_method">
  <h3 class='signature'>
  #<strong>locked?</strong>  &#x21d2; <tt>Boolean</tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Returns <code>true</code> if this lock is currently held by some thread.</p>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L129'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


129
130
131
132
133
134
135</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 129</span></pre>
<pre class='code cpp'>

VALUE
rb_mutex_locked_p(VALUE self)
{
    rb_mutex_t *mutex;
    GetMutexPtr(self, mutex);
    return mutex-&gt;th ? Qtrue : Qfalse;
}
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="owned?-instance_method">
  <h3 class='signature'>
  #<strong>owned?</strong>  &#x21d2; <tt>Boolean</tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Returns <code>true</code> if this lock is currently held by current thread.</p>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L315'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


315
316
317
318
319
320
321
322
323
324
325
326
327
328</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 315</span></pre>
<pre class='code cpp'>

VALUE
rb_mutex_owned_p(VALUE self)
{
    VALUE owned = Qfalse;
    rb_thread_t *th = GET_THREAD();
    rb_mutex_t *mutex;

    GetMutexPtr(self, mutex);

    if (mutex-&gt;th == th)
	owned = Qtrue;

    return owned;
}
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="sleep-instance_method">
  <h3 class='signature'>
  #<strong>sleep</strong>(timeout = nil)  &#x21d2; <tt><a href="../Numeric.html" title="Numeric (class)">Numeric</a></tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Releases the lock and sleeps <code>timeout</code> seconds if it is given
and non-nil or forever.  Raises <a href="../ThreadError.html" title="ThreadError (class)">ThreadError</a> if <code>mutex</code>
wasn&#39;t locked by the current thread.</p>

<p>When the thread is next woken up, it will attempt to reacquire the lock.</p>

<p>Note that this method can wakeup without explicit <a href="../Thread.html#wakeup-instance_method" title="Thread#wakeup (method)">Thread#wakeup</a> call. For
example, receiving signal and so on.</p>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L470'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


470
471
472
473
474
475
476
477</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 470</span></pre>
<pre class='code cpp'>

static VALUE
mutex_sleep(int argc, VALUE *argv, VALUE self)
{
    VALUE timeout;

    rb_scan_args(argc, argv, &quot;01&quot;, &amp;timeout);
    return rb_mutex_sleep(self, timeout);
}
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="synchronize-instance_method">
  <h3 class='signature'>
  #<strong>synchronize</strong>  &#x21d2; <tt>result of the block</tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Obtains a lock, runs the block, and releases the lock when the block
completes.  See the example under <code>Mutex</code>.</p>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L501'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


501
502
503
504
505
506
507
508
509</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 501</span></pre>
<pre class='code cpp'>

static VALUE
rb_mutex_synchronize_m(VALUE self, VALUE args)
{
    if (!rb_block_given_p()) {
	rb_raise(rb_eThreadError, &quot;must be called with a block&quot;);
    }

    return rb_mutex_synchronize(self, rb_yield, Qundef);
}
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="try_lock-instance_method">
  <h3 class='signature'>
  #<strong>try_lock</strong>  &#x21d2; <tt>Boolean</tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Attempts to obtain the lock and returns immediately. Returns
<code>true</code> if the lock was granted.</p>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L156'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 156</span></pre>
<pre class='code cpp'>

VALUE
rb_mutex_trylock(VALUE self)
{
    rb_mutex_t *mutex;
    VALUE locked = Qfalse;
    GetMutexPtr(self, mutex);

    native_mutex_lock(&amp;mutex-&gt;lock);
    if (mutex-&gt;th == 0) {
	rb_thread_t *th = GET_THREAD();
	mutex-&gt;th = th;
	locked = Qtrue;

	mutex_locked(th, self);
    }
    native_mutex_unlock(&amp;mutex-&gt;lock);

    return locked;
}
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="unlock-instance_method">
  <h3 class='signature'>
  #<strong>unlock</strong>  &#x21d2; <tt>self</tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Releases the lock. Raises <a href="../ThreadError.html" title="ThreadError (class)">ThreadError</a> if <code>mutex</code> wasn&#39;t
locked by the current thread.</p>


  </div>
</div>
<div class="tags">
  
</div>  <span class='link_repo'>[ <a href='https://github.com/ruby/ruby/blob/trunk/thread_sync.c#L370'>GitHub</a> ]</span>
<div class='source_code h'>
  <pre class='lines_num'>


370
371
372
373
374
375
376
377
378
379
380
381</pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'thread_sync.c', line 370</span></pre>
<pre class='code cpp'>

VALUE
rb_mutex_unlock(VALUE self)
{
    const char *err;
    rb_mutex_t *mutex;
    GetMutexPtr(self, mutex);

    err = rb_mutex_unlock_th(mutex, GET_THREAD());
    if (err) rb_raise(rb_eThreadError, &quot;%s&quot;, err);

    return self;
}
</pre>
  </div>
</div>
</section>

<div id='footer'>
  Generated by
  <a href='http://yardoc.org' title='Yay! A Ruby Documentation Tool' target="_parent">yard</a>
  0.9.5 with <a href='https://msp-greg.github.io/yard-t2/' title='yard-t2' target="_parent">yard-t2</a> 0.6.0 (ruby-2.3.2p135)
</div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</div> <!-- tbl_cont -->
</body>
</html>