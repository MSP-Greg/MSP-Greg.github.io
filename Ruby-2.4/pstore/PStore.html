<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: PStore &mdash; pstore Ruby-2.4.0 d2016-07-21</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />
<link rel='stylesheet'  type='text/css' href='../../css/custom.css' />
<link rel='stylesheet'  type='text/css' href='../../css/common.css' />

<script type='text/javascript'>
  var pathId = "PStore",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
  <svg id='y_wait' class='' viewBox='0 0 90 90'></svg>
  <div id='tbl_cont'>
    <div id='y_list' class='d h'>
      <button id='list_sizer' class='y_sizer' title='LIST Resizer'></button>
      <header id='list_header'>
        <div id='list_title'>&#160;</div>
        <div id='list_menu'><span>&#160;</span></div>
        <input  id='list_search_text' type='search' placeholder='Search' size='12' value='' autocomplete='off' class='search_input'/>
        <svg id='list_search_icon' viewBox='0 0 30 30'>
          <path class='s_main' d='M21.189,17.213C22.022,15.726,22.5,14.014,22.5,12.188C22.5,6.493,17.884,1.875,12.188,1.875S1.875,6.493,1.875,12.188C1.875,17.882,6.491,22.5,12.188,22.5c1.826,0,3.536-0.48,5.025-1.311l6.113,6.113C23.873,27.851,24.593,28.125,25.313,28.125s1.44-0.274,1.989-0.823c1.099-1.099,1.099-2.878,0-3.977L21.189,17.213z M12.188,19.329c-3.943,0-7.14-3.197-7.14-7.142c0.0-3.943,3.197-7.14,7.14-7.14c3.941,0,7.14,3.195,7.14,7.14C19.328,16.133,16.129,19.329,12.188,19.329z'/>
          <path class='s_clear' d='M 4.414, 1.586 A 1,1 0 1,0 1.586, 4.414 L 21.586,24.414 A 1,1 0 1,0 24.414,21.586 z' />
          <path class='s_clear' d='M 1.586,21.586 A 1,1 0 1,0 4.414,24.414 L 24.414, 4.414 A 1,1 0 1,0 21.586, 1.586 z' />
        </svg>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All'></button>
      </header>
      <nav id= 'list_nav' class='y_nav l_nav'>
        <ul id='list_items'></ul>
      </nav>
    </div>
    <div id='y_toc' class='f h'>
      <button id='toc_sizer' class='y_sizer' title='TOC Resizer'></button>
      <header id='toc_header'>
        <div>Table of Contents</div>
        <button class='y_minus' title='Collapse All'></button>
        <button class='y_plus' title='Expand All' ></button>
      </header>
      <nav id= 'toc_nav' class='y_nav t_nav'>
      <ol id='toc_items'></ol>
      </nav>
    </div>
    <div id='y_main' tabindex='-1'>
      <header id='y_header'>
        <div id='y_menu'>
          <a href='../../index.html'>Home</a> &raquo; 
          <a href='../index.html'>Ruby-2.4.0</a> &raquo; 
          <a href='index.html'>pstore</a> &raquo; 
          <a href='_index.html'>Index (P)</a> &raquo; 
          <span class='title'>PStore</span>
        </div>

        <div id='y_measure_em' class='y_measure'></div>
        <div id='y_measure_vh' class='y_measure'></div>
        <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
        <a id='list_href' href="class_list.html"></a>
        <div id='hdr_button'>
          <button id='src' class='c' title='Source Show / Hide'>S<svg class='c' viewBox='0 0 36 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
              <rect x='20' y='0'  width='4'  height='28' rx='1.0' ry='1.0'/>
            </svg><svg class='o' viewBox='0 0 34 28'>
              <rect x='8'  y='12' width='28' height='4'  rx='1.0' ry='1.0'/>
            </svg></button>
          <button id='list_loc' class='d' title='LIST Location'>L<svg class='f' viewBox='0 0 36 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='toc_loc' class='f' title='TOC Location'>T<svg class='f' viewBox='0 0 34 28'>
            <path d='M36 0 L36 28 8 14'/></svg><svg class='d' viewBox='0 0 36 28'><path d='M 8 0 L36 14 8 28'/></svg></button>
          <button id='list_vis' title='LIST Show / Hide'>LIST</button>
          <button id='toc_vis' title='TOC Show / Hide'>TOC</button>
        </div>
        <div id='y_debug'></div>
      </header>
<div id='content' class='class'>

<h1>Class: PStore</h1>

<table class='y_box'>
<colgroup>
  <col class='box_1' />
  <col class='box_2' />
</colgroup>
  <tr>
    <td class='box_1'>Inherits:</td>
    <td class='box_rel'>
      <span class='inheritName'>Object</span>
      <ul class='fullTree'>
        <li>Object</li>
        <li class='next'>PStore</li>
      </ul>
      <a href='#' class='inheritanceTree'>show all</a>
    </td>
  </tr>

  <tr>
    <td class='box_1'>Child Exceptions:</td>
    <td>
      <a href="PStore/Error.html" title="PStore::Error (class)">Error</a>
    </td>
  </tr>




  <tr>
  <td class='box_1'>Defined in:</td>
  <td class='box_rel'><div class='box_min'>
pstore.rb</div>  </td>
  </tr>
</table>
<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>PStore implements a file based persistence mechanism based on a Hash.  User
code can store hierarchies of Ruby objects (values) into the data store
file by name (keys).  An object hierarchy may be just a single object. 
User code may later read values back from the data store or even update
data, as needed.</p>

<p>The transactional behavior ensures that any changes succeed or fail
together. This can be used to ensure that the data store is not left in a
transitory state, where some values were updated but others were not.</p>

<p>Behind the scenes, Ruby objects are stored to the data store file with
Marshal.  That carries the usual limitations.  Proc objects cannot be
marshalled, for example.</p>

<h3 id="label-Usage+example-3A">Usage example:</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore</span><span class='tstring_end'>&quot;</span></span>

<span class='comment'># a mock wiki object...
</span><span class='kw'>class</span> <span class='const'>WikiPage</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span> <span class='id identifier rubyid_page_name'>page_name</span><span class='comma'>,</span> <span class='id identifier rubyid_author'>author</span><span class='comma'>,</span> <span class='id identifier rubyid_contents'>contents</span> <span class='rparen'>)</span>
    <span class='ivar'>@page_name</span> <span class='op'>=</span> <span class='id identifier rubyid_page_name'>page_name</span>
    <span class='ivar'>@revisions</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>

    <span class='id identifier rubyid_add_revision'>add_revision</span><span class='lparen'>(</span><span class='id identifier rubyid_author'>author</span><span class='comma'>,</span> <span class='id identifier rubyid_contents'>contents</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:page_name</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_revision'>add_revision</span><span class='lparen'>(</span> <span class='id identifier rubyid_author'>author</span><span class='comma'>,</span> <span class='id identifier rubyid_contents'>contents</span> <span class='rparen'>)</span>
    <span class='ivar'>@revisions</span> <span class='op'>&lt;&lt;</span> <span class='lbrace'>{</span> <span class='symbol'>:created</span>  <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='comma'>,</span>
                    <span class='symbol'>:author</span>   <span class='op'>=&gt;</span> <span class='id identifier rubyid_author'>author</span><span class='comma'>,</span>
                    <span class='symbol'>:contents</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_contents'>contents</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_wiki_page_references'>wiki_page_references</span>
    <span class='lbracket'>[</span><span class='ivar'>@page_name</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='ivar'>@revisions</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='lbracket'>[</span><span class='symbol'>:contents</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_scan'>scan</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\b(?:[A-Z][a-z]){2,}</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># ...
</span><span class='kw'>end</span>

<span class='comment'># create a new page...
</span><span class='id identifier rubyid_home_page'>home_page</span> <span class='op'>=</span> <span class='const'>WikiPage</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HomePage</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>James Edward Gray II</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A page about the JoysOfDocumentation...</span><span class='tstring_end'>&quot;</span></span> <span class='rparen'>)</span>

<span class='comment'># then we want to update page data and the index together, or not at all...
</span><span class='id identifier rubyid_wiki'>wiki</span> <span class='op'>=</span> <span class='const'>PStore</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>wiki_pages.pstore</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_wiki'>wiki</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>  <span class='comment'># begin transaction; do all of this or none of it
</span>  <span class='comment'># store page...
</span>  <span class='id identifier rubyid_wiki'>wiki</span><span class='lbracket'>[</span><span class='id identifier rubyid_home_page'>home_page</span><span class='period'>.</span><span class='id identifier rubyid_page_name'>page_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_home_page'>home_page</span>
  <span class='comment'># ensure that an index has been created...
</span>  <span class='id identifier rubyid_wiki'>wiki</span><span class='lbracket'>[</span><span class='symbol'>:wiki_index</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='comment'># update wiki index...
</span>  <span class='id identifier rubyid_wiki'>wiki</span><span class='lbracket'>[</span><span class='symbol'>:wiki_index</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_home_page'>home_page</span><span class='period'>.</span><span class='id identifier rubyid_wiki_page_references'>wiki_page_references</span><span class='rparen'>)</span>
<span class='kw'>end</span>                   <span class='comment'># commit changes to wiki data store file
</span>
<span class='comment'>### Some time later... ###
</span>
<span class='comment'># read wiki data...
</span><span class='id identifier rubyid_wiki'>wiki</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>do</span>  <span class='comment'># begin read-only transaction, no changes allowed
</span>  <span class='id identifier rubyid_wiki'>wiki</span><span class='period'>.</span><span class='id identifier rubyid_roots'>roots</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_data_root_name'>data_root_name</span><span class='op'>|</span>
    <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_data_root_name'>data_root_name</span>
    <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_wiki'>wiki</span><span class='lbracket'>[</span><span class='id identifier rubyid_data_root_name'>data_root_name</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="label-Transaction+modes">Transaction modes</h3>

<p>By default, file integrity is only ensured as long as the operating system
(and the underlying hardware) doesn&#39;t raise any unexpected I/O errors.
If an I/O error occurs while PStore is writing to its file, then the file
will become corrupted.</p>

<p>You can prevent this by setting <em>pstore.ultra_safe = true</em>. However,
this results in a minor performance loss, and only works on platforms that
support atomic file renames. Please consult the documentation for
<code>ultra_safe</code> for details.</p>

<p>Needless to say, if you&#39;re storing valuable data with PStore, then you
should backup the PStore files from time to time.</p>


  </div>
</div>
<div class="tags">
  
</div>
<h2 id='t2_cnst'>Constant Summary<small><a href="#" class="summary_toggle">collapse</a></small></h2>

  <dl class="constants summary full">
    <dt id='CHECKSUM_ALGO-constant'>
      CHECKSUM_ALGO =
    </dt>
    <dd>
      <div class="docstring">
  <div class="discussion">
    
<p>Constant for relieving Ruby&#39;s garbage collector.</p>


  </div>
</div>
<div class="tags">
  
</div>      <pre class='code'><span class='const'>Digest</span><span class='op'>::</span><span class='const'>MD5</span></pre>
    </dd>
    <dt id='EMPTY_MARSHAL_CHECKSUM-constant'>
      EMPTY_MARSHAL_CHECKSUM =
    </dt>
    <dd>
            <pre class='code'><span class='const'>CHECKSUM_ALGO</span><span class='period'>.</span><span class='id identifier rubyid_digest'>digest</span><span class='lparen'>(</span><span class='const'>EMPTY_MARSHAL_DATA</span><span class='rparen'>)</span></pre>
    </dd>
    <dt id='EMPTY_MARSHAL_DATA-constant'>
      EMPTY_MARSHAL_DATA =
    </dt>
    <dd>
            <pre class='code'><span class='const'>Marshal</span><span class='period'>.</span><span class='id identifier rubyid_dump'>dump</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span></pre>
    </dd>
    <dt id='EMPTY_STRING-constant'>
      EMPTY_STRING =
    </dt>
    <dd>
            <pre class='code'><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span></pre>
    </dd>
    <dt id='RD_ACCESS-constant'>
      RD_ACCESS =
    </dt>
    <dd>
            <pre class='code'><span class='lbrace'>{</span><span class='label'>mode:</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>RDONLY</span> <span class='op'>|</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>BINARY</span><span class='comma'>,</span> <span class='label'>encoding:</span> <span class='const'>Encoding</span><span class='op'>::</span><span class='const'>ASCII_8BIT</span><span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre>
    </dd>
    <dt id='RDWR_ACCESS-constant'>
      RDWR_ACCESS =
    </dt>
    <dd>
            <pre class='code'><span class='lbrace'>{</span><span class='label'>mode:</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>RDWR</span> <span class='op'>|</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>CREAT</span> <span class='op'>|</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>BINARY</span><span class='comma'>,</span> <span class='label'>encoding:</span> <span class='const'>Encoding</span><span class='op'>::</span><span class='const'>ASCII_8BIT</span><span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre>
    </dd>
    <dt id='WR_ACCESS-constant'>
      WR_ACCESS =
    </dt>
    <dd>
            <pre class='code'><span class='lbrace'>{</span><span class='label'>mode:</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>WRONLY</span> <span class='op'>|</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>CREAT</span> <span class='op'>|</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>TRUNC</span> <span class='op'>|</span> <span class='const'>IO</span><span class='op'>::</span><span class='const'>BINARY</span><span class='comma'>,</span> <span class='label'>encoding:</span> <span class='const'>Encoding</span><span class='op'>::</span><span class='const'>ASCII_8BIT</span><span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre>
    </dd>
  </dl>



<h2>Instance Attribute Summary <small><a href='#' class='summary_toggle'>collapse</a></small></h2>

  <ul class="summary">
    <li>
      <span class="summary_signature">
        <a href="#ultra_safe-instance_method" title="#ultra_safe (instance method)">#<strong>ultra_safe</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Whether PStore should do its best to prevent file corruptions, even when
under unlikely-to-occur error conditions such as out-of-space conditions
and other unusual OS filesystem errors.</p>
</div>
      </span>
    </li>
  </ul>


<h2>Class Method Summary
  <small><a href='#' class='summary_toggle'>collapse</a></small>
</h2>

  <ul class='summary'>
    <li>
      <span class="summary_signature">
        <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(file, thread_safe = false)  &#x21d2; PStore </a>
      </span>
      <span class='note title constructor'>constructor</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>To construct a PStore object, pass in the <em>file</em> path where you
would like the data to be stored.</p>
</div>
      </span>
    </li>
  </ul>
<h2>Instance Method Summary
  <small><a href='#' class='summary_toggle'>collapse</a></small>
</h2>

  <ul class='summary'>
    <li>
      <span class="summary_signature">
        <a href="#%5B%5D-instance_method" title="#[] (instance method)">#<strong>[]</strong>(name)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Retrieves a value from the PStore file data, by <em>name</em>.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#%5B%5D%3D-instance_method" title="#[]= (instance method)">#<strong>[]=</strong>(name, value)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Stores an individual Ruby object or a hierarchy of Ruby objects in the data
store file under the root <em>name</em>.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#abort-instance_method" title="#abort (instance method)">#<strong>abort</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Ends the current <a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>, discarding any changes to the data
store.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#commit-instance_method" title="#commit (instance method)">#<strong>commit</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Ends the current <a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>, committing any changes to the data
store immediately.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#delete-instance_method" title="#delete (instance method)">#<strong>delete</strong>(name)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Removes an object hierarchy from the data store, by <em>name</em>.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#dump-instance_method" title="#dump (instance method)">#<strong>dump</strong>(table)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>This method is just a wrapped around <code>Marshal.dump</code> to allow subclass
overriding used in <code>YAML::Store</code>.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#empty_marshal_checksum-instance_method" title="#empty_marshal_checksum (instance method)">#<strong>empty_marshal_checksum</strong>  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#empty_marshal_data-instance_method" title="#empty_marshal_data (instance method)">#<strong>empty_marshal_data</strong>  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#fetch-instance_method" title="#fetch (instance method)">#<strong>fetch</strong>(name, default = PStore::Error)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>This method is just like <a href="#%5B%5D-instance_method" title="PStore#[] (method)">#[]</a>, save that you may also provide a
<em>default</em> value for the object.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#in_transaction-instance_method" title="#in_transaction (instance method)">#<strong>in_transaction</strong>  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Raises <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if the calling code is not in a
<a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#in_transaction_wr-instance_method" title="#in_transaction_wr (instance method)">#<strong>in_transaction_wr</strong>  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Raises <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if the calling code is not in a <a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>
or if the code is in a read-only <a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#load-instance_method" title="#load (instance method)">#<strong>load</strong>(content)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>This method is just a wrapped around <code>Marshal.load</code>.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#load_data-instance_method" title="#load_data (instance method)">#<strong>load_data</strong>(file, read_only)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Load the given PStore file.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#on_windows%3F-instance_method" title="#on_windows? (instance method)">#<strong>on_windows?</strong>  &#x21d2; Boolean </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#open_and_lock_file-instance_method" title="#open_and_lock_file (instance method)">#<strong>open_and_lock_file</strong>(filename, read_only)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Open the specified filename (either in read-only mode or in read-write
mode) and lock it for reading or writing.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#path-instance_method" title="#path (instance method)">#<strong>path</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Returns the path to the data store file.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#root%3F-instance_method" title="#root? (instance method)">#<strong>root?</strong>(name)  &#x21d2; Boolean </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Returns true if the supplied <em>name</em> is currently in the data store.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#roots-instance_method" title="#roots (instance method)">#<strong>roots</strong>  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Returns the names of all object hierarchies currently in the store.</p>
</div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#save_data-instance_method" title="#save_data (instance method)">#<strong>save_data</strong>(original_checksum, original_file_size, file)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#save_data_with_atomic_file_rename_strategy-instance_method" title="#save_data_with_atomic_file_rename_strategy (instance method)">#<strong>save_data_with_atomic_file_rename_strategy</strong>(data, file)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#save_data_with_fast_strategy-instance_method" title="#save_data_with_fast_strategy (instance method)">#<strong>save_data_with_fast_strategy</strong>(data, file)  </a>
      </span>
      <span class='note title private'>private</span>
      <span class='summary_desc'>
        <div class='inline'></div>
      </span>
    </li>
    <li>
      <span class="summary_signature">
        <a href="#transaction-instance_method" title="#transaction (instance method)">#<strong>transaction</strong>(read_only = false)  </a>
      </span>
      <span class='summary_desc'>
        <div class='inline'>
<p>Opens a new transaction for the data store.</p>
</div>
      </span>
    </li>
  </ul>


<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>
  <section class='method_details first' id="new-class_method">
  <h3 class='signature first'>
  .<strong>new</strong>(file, thread_safe = false)  &#x21d2; <tt><a href="" title="PStore (class)">PStore</a></tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>To construct a PStore object, pass in the <em>file</em> path where you
would like the data to be stored.</p>

<p>PStore objects are always reentrant. But if <em>thread_safe</em> is set to
true, then it will become thread-safe at the cost of a minor performance
hit.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


119
120
121
122
123
124
125
126
127
128
129
130
131
132</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 119</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_thread_safe'>thread_safe</span> <span class='op'>=</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_dir'>dir</span> <span class='op'>=</span> <span class='const'>File</span><span class='op'>::</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='const'>File</span><span class='op'>::</span><span class='id identifier rubyid_directory?'>directory?</span> <span class='id identifier rubyid_dir'>dir</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='id identifier rubyid_format'>format</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>directory %s does not exist</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_dir'>dir</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='const'>File</span><span class='op'>::</span><span class='id identifier rubyid_exist?'>exist?</span> <span class='id identifier rubyid_file'>file</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='const'>File</span><span class='op'>::</span><span class='id identifier rubyid_readable?'>readable?</span> <span class='id identifier rubyid_file'>file</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='id identifier rubyid_format'>format</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>file %s not readable</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='ivar'>@filename</span> <span class='op'>=</span> <span class='id identifier rubyid_file'>file</span>
  <span class='ivar'>@abort</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@ultra_safe</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@thread_safe</span> <span class='op'>=</span> <span class='id identifier rubyid_thread_safe'>thread_safe</span>
  <span class='ivar'>@lock</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
<h2 class='y_details'>Instance Attribute Details</h2>
  <section class='method_details first' id="ultra_safe-instance_method">
  <h3 class='signature first'>
  #<strong>ultra_safe</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Whether PStore should do its best to prevent file corruptions, even when
under unlikely-to-occur error conditions such as out-of-space conditions
and other unusual OS filesystem errors. Setting this flag comes at the
price in the form of a performance loss.</p>

<p>This flag only has effect on platforms on which file renames are atomic
(e.g. all POSIX platforms: Linux, MacOS X, FreeBSD, etc). The default value
is false.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


110</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 110</span>

<span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:ultra_safe</span>
</pre>
  </div>
</div>
</section>
<h2 class='y_details'>Instance Method Details</h2>
  <section class='method_details first' id="[]-instance_method">
  <h3 class='signature first'>
  #<strong>[]</strong>(name)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Retrieves a value from the PStore file data, by <em>name</em>.  The
hierarchy of Ruby objects stored under that root <em>name</em> will be
returned.</p>

<p><strong>WARNING</strong>:  This method is only valid in a
<a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>.  It will raise <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if called at any other
time.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


155
156
157
158</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 155</span>

<span class='kw'>def</span> <span class='op'>[]</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_in_transaction'>in_transaction</span>
  <span class='ivar'>@table</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="[]=-instance_method">
  <h3 class='signature'>
  #<strong>[]=</strong>(name, value)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Stores an individual Ruby object or a hierarchy of Ruby objects in the data
store file under the root <em>name</em>.  Assigning to a <em>name</em>
already in the data store clobbers the old data.</p>

<h2 id="label-Example-3A">Example:</h2>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_store'>store</span> <span class='op'>=</span> <span class='const'>PStore</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data_file.pstore</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_store'>store</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>  <span class='comment'># begin transaction
</span>  <span class='comment'># load some data into the store...
</span>  <span class='id identifier rubyid_store'>store</span><span class='lbracket'>[</span><span class='symbol'>:single_object</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>My data...</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_store'>store</span><span class='lbracket'>[</span><span class='symbol'>:obj_hierarchy</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Kev Jackson</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rational.rb</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore.rb</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>James Gray</span><span class='tstring_end'>&quot;</span></span>  <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>erb.rb</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore.rb</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>                   <span class='comment'># commit changes to data store file
</span></code></pre>

<p><strong>WARNING</strong>:  This method is only valid in a
<a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a> and it cannot be read-only.  It will raise
<a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if called at any other time.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


200
201
202
203</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 200</span>

<span class='kw'>def</span> <span class='op'>[]=</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_in_transaction_wr'>in_transaction_wr</span>
  <span class='ivar'>@table</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="abort-instance_method">
  <h3 class='signature'>
  #<strong>abort</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Ends the current <a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>, discarding any changes to the data
store.</p>

<h2 id="label-Example-3A">Example:</h2>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_store'>store</span> <span class='op'>=</span> <span class='const'>PStore</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data_file.pstore</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_store'>store</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>  <span class='comment'># begin transaction
</span>  <span class='id identifier rubyid_store'>store</span><span class='lbracket'>[</span><span class='symbol'>:one</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>1</span>     <span class='comment'># this change is not applied, see below...
</span>  <span class='id identifier rubyid_store'>store</span><span class='lbracket'>[</span><span class='symbol'>:two</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>2</span>     <span class='comment'># this change is not applied, see below...
</span>
  <span class='id identifier rubyid_store'>store</span><span class='period'>.</span><span class='id identifier rubyid_abort'>abort</span>         <span class='comment'># end transaction here, discard all changes
</span>
  <span class='id identifier rubyid_store'>store</span><span class='lbracket'>[</span><span class='symbol'>:three</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>3</span>   <span class='comment'># this change is never reached
</span><span class='kw'>end</span>
</code></pre>

<p><strong>WARNING</strong>:  This method is only valid in a
<a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>.  It will raise <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if called at any other
time.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


288
289
290
291
292</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 288</span>

<span class='kw'>def</span> <span class='id identifier rubyid_abort'>abort</span>
  <span class='id identifier rubyid_in_transaction'>in_transaction</span>
  <span class='ivar'>@abort</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_throw'>throw</span> <span class='symbol'>:pstore_abort_transaction</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="commit-instance_method">
  <h3 class='signature'>
  #<strong>commit</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Ends the current <a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>, committing any changes to the data
store immediately.</p>

<h2 id="label-Example-3A">Example:</h2>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pstore</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_store'>store</span> <span class='op'>=</span> <span class='const'>PStore</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data_file.pstore</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_store'>store</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>  <span class='comment'># begin transaction
</span>  <span class='comment'># load some data into the store...
</span>  <span class='id identifier rubyid_store'>store</span><span class='lbracket'>[</span><span class='symbol'>:one</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>1</span>
  <span class='id identifier rubyid_store'>store</span><span class='lbracket'>[</span><span class='symbol'>:two</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>2</span>

  <span class='id identifier rubyid_store'>store</span><span class='period'>.</span><span class='id identifier rubyid_commit'>commit</span>        <span class='comment'># end transaction here, committing changes
</span>
  <span class='id identifier rubyid_store'>store</span><span class='lbracket'>[</span><span class='symbol'>:three</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>3</span>   <span class='comment'># this change is never reached
</span><span class='kw'>end</span>
</code></pre>

<p><strong>WARNING</strong>:  This method is only valid in a
<a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>.  It will raise <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if called at any other
time.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


262
263
264
265
266</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 262</span>

<span class='kw'>def</span> <span class='id identifier rubyid_commit'>commit</span>
  <span class='id identifier rubyid_in_transaction'>in_transaction</span>
  <span class='ivar'>@abort</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_throw'>throw</span> <span class='symbol'>:pstore_abort_transaction</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="delete-instance_method">
  <h3 class='signature'>
  #<strong>delete</strong>(name)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Removes an object hierarchy from the data store, by <em>name</em>.</p>

<p><strong>WARNING</strong>:  This method is only valid in a
<a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a> and it cannot be read-only.  It will raise
<a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if called at any other time.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


210
211
212
213</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 210</span>

<span class='kw'>def</span> <span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_in_transaction_wr'>in_transaction_wr</span>
  <span class='ivar'>@table</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_name'>name</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="dump-instance_method">
  <h3 class='signature'>
  #<strong>dump</strong>(table)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>This method is just a wrapped around <code>Marshal.dump</code> to allow subclass
overriding used in <code>YAML::Store</code>.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


470
471
472</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 470</span>

<span class='kw'>def</span> <span class='id identifier rubyid_dump'>dump</span><span class='lparen'>(</span><span class='id identifier rubyid_table'>table</span><span class='rparen'>)</span>  <span class='comment'># :nodoc:
</span>  <span class='const'>Marshal</span><span class='op'>::</span><span class='id identifier rubyid_dump'>dump</span><span class='lparen'>(</span><span class='id identifier rubyid_table'>table</span><span class='rparen'>)</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="empty_marshal_checksum-instance_method">
  <h3 class='signature'>
  #<strong>empty_marshal_checksum</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


483
484
485</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 483</span>

<span class='kw'>def</span> <span class='id identifier rubyid_empty_marshal_checksum'>empty_marshal_checksum</span>
  <span class='const'>EMPTY_MARSHAL_CHECKSUM</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="empty_marshal_data-instance_method">
  <h3 class='signature'>
  #<strong>empty_marshal_data</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


480
481
482</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 480</span>

<span class='kw'>def</span> <span class='id identifier rubyid_empty_marshal_data'>empty_marshal_data</span>
  <span class='const'>EMPTY_MARSHAL_DATA</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="fetch-instance_method">
  <h3 class='signature'>
  #<strong>fetch</strong>(name, default = PStore::Error)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>This method is just like <a href="#%5B%5D-instance_method" title="PStore#[] (method)">#[]</a>, save that you may also provide a
<em>default</em> value for the object.  In the event the specified
<em>name</em> is not found in the data store, your <em>default</em> will be
returned instead.  If you do not specify a default, <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> will be
raised if the object is not found.</p>

<p><strong>WARNING</strong>:  This method is only valid in a
<a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>.  It will raise <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if called at any other
time.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


169
170
171
172
173
174
175
176
177
178
179</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 169</span>

<span class='kw'>def</span> <span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_default'>default</span><span class='op'>=</span><span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_in_transaction'>in_transaction</span>
  <span class='kw'>unless</span> <span class='ivar'>@table</span><span class='period'>.</span><span class='id identifier rubyid_key?'>key?</span> <span class='id identifier rubyid_name'>name</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_default'>default</span> <span class='op'>==</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='id identifier rubyid_format'>format</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>undefined root name `%s&#39;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_default'>default</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='ivar'>@table</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="in_transaction-instance_method">
  <h3 class='signature'>
  #<strong>in_transaction</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Raises <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if the calling code is not in a
<a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>.</p>


  </div>
</div>
<div class="tags">
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<tt><a href="PStore/Error.html" title="PStore::Error (class)">PStore::Error</a></tt>)</span>
  </li>
</ul>

</div><div class='source_code h'>
  <pre class='lines_num'>


135
136
137</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 135</span>

<span class='kw'>def</span> <span class='id identifier rubyid_in_transaction'>in_transaction</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>not in transaction</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='ivar'>@lock</span><span class='period'>.</span><span class='id identifier rubyid_locked?'>locked?</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="in_transaction_wr-instance_method">
  <h3 class='signature'>
  #<strong>in_transaction_wr</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Raises <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if the calling code is not in a <a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>
or if the code is in a read-only <a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>.</p>


  </div>
</div>
<div class="tags">
  <p class='tag_title'>Raises:</p>
<ul class='raise'>
  <li>
    <span class='type'>(<tt><a href="PStore/Error.html" title="PStore::Error (class)">PStore::Error</a></tt>)</span>
  </li>
</ul>

</div><div class='source_code h'>
  <pre class='lines_num'>


142
143
144
145</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 142</span>

<span class='kw'>def</span> <span class='id identifier rubyid_in_transaction_wr'>in_transaction_wr</span>
  <span class='id identifier rubyid_in_transaction'>in_transaction</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>in read-only transaction</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@rdonly</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="load-instance_method">
  <h3 class='signature'>
  #<strong>load</strong>(content)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>This method is just a wrapped around <code>Marshal.load</code>. to allow subclass
overriding used in <code>YAML::Store</code>.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


476
477
478</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 476</span>

<span class='kw'>def</span> <span class='id identifier rubyid_load'>load</span><span class='lparen'>(</span><span class='id identifier rubyid_content'>content</span><span class='rparen'>)</span>  <span class='comment'># :nodoc:
</span>  <span class='const'>Marshal</span><span class='op'>::</span><span class='id identifier rubyid_load'>load</span><span class='lparen'>(</span><span class='id identifier rubyid_content'>content</span><span class='rparen'>)</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="load_data-instance_method">
  <h3 class='signature'>
  #<strong>load_data</strong>(file, read_only)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Load the given PStore file. If <code>read_only</code> is true, the
unmarshalled Hash will be returned. If <code>read_only</code> is false, a
3-tuple will be returned: the unmarshalled Hash, an MD5 checksum of the
data, and the size of the data.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 394</span>

<span class='kw'>def</span> <span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_read_only'>read_only</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_read_only'>read_only</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='id identifier rubyid_load'>load</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Error</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PStore file seems to be corrupted.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>EOFError</span>
      <span class='comment'># This seems to be a newly-created file.
</span>      <span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_table'>table</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='comment'># This seems to be a newly-created file.
</span>      <span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_checksum'>checksum</span> <span class='op'>=</span> <span class='id identifier rubyid_empty_marshal_checksum'>empty_marshal_checksum</span>
      <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='id identifier rubyid_empty_marshal_data'>empty_marshal_data</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='id identifier rubyid_load'>load</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_checksum'>checksum</span> <span class='op'>=</span> <span class='const'>CHECKSUM_ALGO</span><span class='period'>.</span><span class='id identifier rubyid_digest'>digest</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Error</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PStore file seems to be corrupted.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_replace'>replace</span><span class='lparen'>(</span><span class='const'>EMPTY_STRING</span><span class='rparen'>)</span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_table'>table</span><span class='comma'>,</span> <span class='id identifier rubyid_checksum'>checksum</span><span class='comma'>,</span> <span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="on_windows?-instance_method">
  <h3 class='signature'>
  #<strong>on_windows?</strong>  &#x21d2; <tt>Boolean</tt>  <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


422
423
424
425
426
427
428</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 422</span>

<span class='kw'>def</span> <span class='id identifier rubyid_on_windows?'>on_windows?</span>
  <span class='id identifier rubyid_is_windows'>is_windows</span> <span class='op'>=</span> <span class='const'>RUBY_PLATFORM</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>mswin|mingw|bccwin|wince</span><span class='regexp_end'>/</span></span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid___send__'>__send__</span><span class='lparen'>(</span><span class='symbol'>:define_method</span><span class='comma'>,</span> <span class='symbol'>:on_windows?</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_is_windows'>is_windows</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_is_windows'>is_windows</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="open_and_lock_file-instance_method">
  <h3 class='signature'>
  #<strong>open_and_lock_file</strong>(filename, read_only)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Open the specified filename (either in read-only mode or in read-write
mode) and lock it for reading or writing.</p>

<p>The opened File object will be returned. If <em>read_only</em> is true, and
the file does not exist, then nil will be returned.</p>

<p>All exceptions are propagated.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 369</span>

<span class='kw'>def</span> <span class='id identifier rubyid_open_and_lock_file'>open_and_lock_file</span><span class='lparen'>(</span><span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_read_only'>read_only</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_read_only'>read_only</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_file'>file</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='const'>RD_ACCESS</span><span class='rparen'>)</span>
      <span class='kw'>begin</span>
        <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_flock'>flock</span><span class='lparen'>(</span><span class='const'>File</span><span class='op'>::</span><span class='const'>LOCK_SH</span><span class='rparen'>)</span>
        <span class='kw'>return</span> <span class='id identifier rubyid_file'>file</span>
      <span class='kw'>rescue</span>
        <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
        <span class='id identifier rubyid_raise'>raise</span>
      <span class='kw'>end</span>
    <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOENT</span>
      <span class='kw'>return</span> <span class='kw'>nil</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_file'>file</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='const'>RDWR_ACCESS</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_flock'>flock</span><span class='lparen'>(</span><span class='const'>File</span><span class='op'>::</span><span class='const'>LOCK_EX</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="path-instance_method">
  <h3 class='signature'>
  #<strong>path</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Returns the path to the data store file.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


236
237
238</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 236</span>

<span class='kw'>def</span> <span class='id identifier rubyid_path'>path</span>
  <span class='ivar'>@filename</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="root?-instance_method">
  <h3 class='signature'>
  #<strong>root?</strong>(name)  &#x21d2; <tt>Boolean</tt> 
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Returns true if the supplied <em>name</em> is currently in the data store.</p>

<p><strong>WARNING</strong>:  This method is only valid in a
<a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>.  It will raise <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if called at any other
time.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


231
232
233
234</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 231</span>

<span class='kw'>def</span> <span class='id identifier rubyid_root?'>root?</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_in_transaction'>in_transaction</span>
  <span class='ivar'>@table</span><span class='period'>.</span><span class='id identifier rubyid_key?'>key?</span> <span class='id identifier rubyid_name'>name</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="roots-instance_method">
  <h3 class='signature'>
  #<strong>roots</strong>  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Returns the names of all object hierarchies currently in the store.</p>

<p><strong>WARNING</strong>:  This method is only valid in a
<a href="#transaction-instance_method" title="PStore#transaction (method)">#transaction</a>.  It will raise <a href="PStore/Error.html" title="PStore::Error (class)">Error</a> if called at any other
time.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


221
222
223
224</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 221</span>

<span class='kw'>def</span> <span class='id identifier rubyid_roots'>roots</span>
  <span class='id identifier rubyid_in_transaction'>in_transaction</span>
  <span class='ivar'>@table</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="save_data-instance_method">
  <h3 class='signature'>
  #<strong>save_data</strong>(original_checksum, original_file_size, file)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


430
431
432
433
434
435
436
437
438
439
440
441
442
443</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 430</span>

<span class='kw'>def</span> <span class='id identifier rubyid_save_data'>save_data</span><span class='lparen'>(</span><span class='id identifier rubyid_original_checksum'>original_checksum</span><span class='comma'>,</span> <span class='id identifier rubyid_original_file_size'>original_file_size</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_new_data'>new_data</span> <span class='op'>=</span> <span class='id identifier rubyid_dump'>dump</span><span class='lparen'>(</span><span class='ivar'>@table</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_new_data'>new_data</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>!=</span> <span class='id identifier rubyid_original_file_size'>original_file_size</span> <span class='op'>||</span> <span class='const'>CHECKSUM_ALGO</span><span class='period'>.</span><span class='id identifier rubyid_digest'>digest</span><span class='lparen'>(</span><span class='id identifier rubyid_new_data'>new_data</span><span class='rparen'>)</span> <span class='op'>!=</span> <span class='id identifier rubyid_original_checksum'>original_checksum</span>
    <span class='kw'>if</span> <span class='ivar'>@ultra_safe</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_on_windows?'>on_windows?</span>
      <span class='comment'># Windows doesn&#39;t support atomic file renames.
</span>      <span class='id identifier rubyid_save_data_with_atomic_file_rename_strategy'>save_data_with_atomic_file_rename_strategy</span><span class='lparen'>(</span><span class='id identifier rubyid_new_data'>new_data</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_save_data_with_fast_strategy'>save_data_with_fast_strategy</span><span class='lparen'>(</span><span class='id identifier rubyid_new_data'>new_data</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_new_data'>new_data</span><span class='period'>.</span><span class='id identifier rubyid_replace'>replace</span><span class='lparen'>(</span><span class='const'>EMPTY_STRING</span><span class='rparen'>)</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="save_data_with_atomic_file_rename_strategy-instance_method">
  <h3 class='signature'>
  #<strong>save_data_with_atomic_file_rename_strategy</strong>(data, file)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


445
446
447
448
449
450
451
452
453
454
455
456
457
458
459</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 445</span>

<span class='kw'>def</span> <span class='id identifier rubyid_save_data_with_atomic_file_rename_strategy'>save_data_with_atomic_file_rename_strategy</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_temp_filename'>temp_filename</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@filename</span><span class='embexpr_end'>}</span><span class='tstring_content'>.tmp.</span><span class='embexpr_beg'>#{</span><span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_pid'>pid</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rand'>rand</span> <span class='int'>1000000</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_temp_file'>temp_file</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_temp_filename'>temp_filename</span><span class='comma'>,</span> <span class='const'>WR_ACCESS</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_temp_file'>temp_file</span><span class='period'>.</span><span class='id identifier rubyid_flock'>flock</span><span class='lparen'>(</span><span class='const'>File</span><span class='op'>::</span><span class='const'>LOCK_EX</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_temp_file'>temp_file</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_temp_file'>temp_file</span><span class='period'>.</span><span class='id identifier rubyid_flush'>flush</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_rename'>rename</span><span class='lparen'>(</span><span class='id identifier rubyid_temp_filename'>temp_filename</span><span class='comma'>,</span> <span class='ivar'>@filename</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_unlink'>unlink</span><span class='lparen'>(</span><span class='id identifier rubyid_temp_file'>temp_file</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='kw'>nil</span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>ensure</span>
    <span class='id identifier rubyid_temp_file'>temp_file</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="save_data_with_fast_strategy-instance_method">
  <h3 class='signature'>
  #<strong>save_data_with_fast_strategy</strong>(data, file)   <span class="extras">(<span class='priv'>private</span>)</span>
</h3>
<div class='source_code h'>
  <pre class='lines_num'>


461
462
463
464
465</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 461</span>

<span class='kw'>def</span> <span class='id identifier rubyid_save_data_with_fast_strategy'>save_data_with_fast_strategy</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_rewind'>rewind</span>
  <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_truncate'>truncate</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span><span class='rparen'>)</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>
  <section class='method_details' id="transaction-instance_method">
  <h3 class='signature'>
  #<strong>transaction</strong>(read_only = false)  
</h3>
<div class="docstring">
  <div class="discussion">
    
<p>Opens a new transaction for the data store.  Code executed inside a block
passed to this method may read and write data to and from the data store
file.</p>

<p>At the end of the block, changes are committed to the data store
automatically.  You may exit the transaction early with a call to either
<a href="#commit-instance_method" title="PStore#commit (method)">#commit</a> or <a href="#abort-instance_method" title="PStore#abort (method)">#abort</a>.  See those methods for details about how
changes are handled.  Raising an uncaught Exception in the block is
equivalent to calling <a href="#abort-instance_method" title="PStore#abort (method)">#abort</a>.</p>

<p>If <em>read_only</em> is set to <code>true</code>, you will only be allowed
to read from the data store during the transaction and any attempts to
change the data will raise a <a href="PStore/Error.html" title="PStore::Error (class)">Error</a>.</p>

<p>Note that PStore does not support nested transactions.</p>


  </div>
</div>
<div class="tags">
  
</div><div class='source_code h'>
  <pre class='lines_num'>


311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351</pre>
  <div class='lines_code'>
<pre class='code ruby'
<span class='info file'># File 'pstore.rb', line 311</span>

<span class='kw'>def</span> <span class='id identifier rubyid_transaction'>transaction</span><span class='lparen'>(</span><span class='id identifier rubyid_read_only'>read_only</span> <span class='op'>=</span> <span class='kw'>false</span><span class='rparen'>)</span>  <span class='comment'># :yields:  pstore
</span>  <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@thread_safe</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>nested transaction</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='ivar'>@lock</span><span class='period'>.</span><span class='id identifier rubyid_try_lock'>try_lock</span>
  <span class='kw'>else</span>
    <span class='kw'>begin</span>
      <span class='ivar'>@lock</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span>
    <span class='kw'>rescue</span> <span class='const'>ThreadError</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>PStore</span><span class='op'>::</span><span class='const'>Error</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>nested transaction</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>begin</span>
    <span class='ivar'>@rdonly</span> <span class='op'>=</span> <span class='id identifier rubyid_read_only'>read_only</span>
    <span class='ivar'>@abort</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='id identifier rubyid_file'>file</span> <span class='op'>=</span> <span class='id identifier rubyid_open_and_lock_file'>open_and_lock_file</span><span class='lparen'>(</span><span class='ivar'>@filename</span><span class='comma'>,</span> <span class='id identifier rubyid_read_only'>read_only</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_file'>file</span>
      <span class='kw'>begin</span>
        <span class='ivar'>@table</span><span class='comma'>,</span> <span class='id identifier rubyid_checksum'>checksum</span><span class='comma'>,</span> <span class='id identifier rubyid_original_data_size'>original_data_size</span> <span class='op'>=</span> <span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='id identifier rubyid_read_only'>read_only</span><span class='rparen'>)</span>

        <span class='id identifier rubyid_catch'>catch</span><span class='lparen'>(</span><span class='symbol'>:pstore_abort_transaction</span><span class='rparen'>)</span> <span class='kw'>do</span>
          <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='kw'>yield</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
        <span class='kw'>end</span>

        <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@abort</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_read_only'>read_only</span>
          <span class='id identifier rubyid_save_data'>save_data</span><span class='lparen'>(</span><span class='id identifier rubyid_checksum'>checksum</span><span class='comma'>,</span> <span class='id identifier rubyid_original_data_size'>original_data_size</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>ensure</span>
        <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_closed?'>closed?</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='comment'># This can only occur if read_only == true.
</span>      <span class='ivar'>@table</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_catch'>catch</span><span class='lparen'>(</span><span class='symbol'>:pstore_abort_transaction</span><span class='rparen'>)</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='kw'>yield</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>ensure</span>
    <span class='ivar'>@lock</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<div id='footer'>
  Generated by
  <a href='http://yardoc.org' title='Yay! A Ruby Documentation Tool' target="_parent">yard</a>
  0.9.4 with <a href='https://msp-greg.github.io/yard-t2/' title='yard-t2' target="_parent">yard-t2</a> 0.6.0 (ruby-2.3.2p135)
</div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</div> <!-- tbl_cont -->
</body>
</html>