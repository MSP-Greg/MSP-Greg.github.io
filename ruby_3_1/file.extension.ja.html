<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Extension.ja &mdash; Ruby-3.1.5</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "extension.ja",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Ruby-3.1.5</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Extension.ja&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="file_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>

<p># extension.ja.rdoc -  -*- RDoc -*- created at: Mon Aug  7 16:45:54 JST 1995</p>

<h1 id="label-Ruby-E3-81-AE-E6-8B-A1-E5-BC-B5-E3-83-A9-E3-82-A4-E3-83-96-E3-83-A9-E3-83-AA-E3-81-AE-E4-BD-9C-E3-82-8A-E6-96-B9">Rubyの拡張ライブラリの作り方</h1>

<p>Rubyの拡張ライブラリの作り方を説明します．</p>

<h2 id="label-E5-9F-BA-E7-A4-8E-E7-9F-A5-E8-AD-98">基礎知識</h2>

<p>Cの変数には型があり，データには型がありません．ですから，たとえばポインタをintの変数に代入すると，その値は整数として取り扱われます．逆にRubyの変数には型がなく，データに型があります．この違いのため，CとRubyは相互に変換しなければ，お互いのデータをアクセスできません．</p>

<p>RubyのデータはVALUEというCの型で表現されます．VALUE型のデータはそのデータタイプを自分で知っています．このデータタイプというのはデータ(オブジェクト)の実際の構造を意味していて，Ruby のクラスとはまた違ったものです．</p>

<p>VALUEからCにとって意味のあるデータを取り出すためには</p>
<ol><li>
<p>VALUEのデータタイプを知る</p>
</li><li>
<p>VALUEをCのデータに変換する</p>
</li></ol>

<p>の両方が必要です．(1)を忘れると間違ったデータの変換が行われて，最悪プログラムがcore dumpします．</p>

<h3 id="label-E3-83-87-E3-83-BC-E3-82-BF-E3-82-BF-E3-82-A4-E3-83-97">データタイプ</h3>

<p>Rubyにはユーザが使う可能性のある以下のタイプがあります．</p>
<dl class="rdoc-list note-list"><dt>T_NIL      
<dd>
<p>nil</p>
</dd><dt>T_OBJECT   
<dd>
<p>通常のオブジェクト</p>
</dd><dt>T_CLASS    
<dd>
<p>クラス</p>
</dd><dt>T_MODULE   
<dd>
<p>モジュール</p>
</dd><dt>T_FLOAT    
<dd>
<p>浮動小数点数</p>
</dd><dt>T_STRING   
<dd>
<p>文字列</p>
</dd><dt>T_REGEXP   
<dd>
<p>正規表現</p>
</dd><dt>T_ARRAY    
<dd>
<p>配列</p>
</dd><dt>T_HASH     
<dd>
<p>連想配列</p>
</dd><dt>T_STRUCT   
<dd>
<p>(Rubyの)構造体</p>
</dd><dt>T_BIGNUM   
<dd>
<p>多倍長整数</p>
</dd><dt>T_FIXNUM   
<dd>
<p>Fixnum(31bitまたは63bit長整数)</p>
</dd><dt>T_COMPLEX  
<dd>
<p>複素数</p>
</dd><dt>T_RATIONAL 
<dd>
<p>有理数</p>
</dd><dt>T_FILE     
<dd>
<p>入出力</p>
</dd><dt>T_TRUE     
<dd>
<p>真</p>
</dd><dt>T_FALSE    
<dd>
<p>偽</p>
</dd><dt>T_DATA     
<dd>
<p>データ</p>
</dd><dt>T_SYMBOL   
<dd>
<p>シンボル</p>
</dd></dl>

<p>その他に内部で利用されている以下のタイプがあります．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>T_ICLASS</span>
<span class='const'>T_MATCH</span>
<span class='const'>T_UNDEF</span>
<span class='const'>T_NODE</span>
<span class='const'>T_ZOMBIE</span></code></pre>

<p>ほとんどのタイプはCの構造体で実装されています．</p>

<h3 id="label-VALUE-E3-81-AE-E3-83-87-E3-83-BC-E3-82-BF-E3-82-BF-E3-82-A4-E3-83-97-E3-82-92-E3-83-81-E3-82-A7-E3-83-83-E3-82-AF-E3-81-99-E3-82-8B">VALUEのデータタイプをチェックする</h3>

<p>ruby.hではTYPE()というマクロが定義されていて，VALUEのデータタイプを知ることが出来ます．TYPE()マクロは上で紹介したT_XXXX の形式の定数を返します．VALUEのデータタイプに応じて処理する場合には，TYPE()の値で分岐することになります．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_switch'>switch</span> (<span class='const'>TYPE</span>(<span class='id identifier rubyid_obj'>obj</span>)) {
  <span class='kw'>case</span> <span class='const'>T_FIXNUM</span><span class='op'>:</span>
    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* FIXNUMの処理 *</span><span class='regexp_end'>/</span></span>
    <span class='kw'>break</span><span class='semicolon'>;</span>
  <span class='kw'>case</span> <span class='const'>T_STRING</span><span class='op'>:</span>
    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* 文字列の処理 *</span><span class='regexp_end'>/</span></span>
    <span class='kw'>break</span><span class='semicolon'>;</span>
  <span class='kw'>case</span> <span class='const'>T_ARRAY</span><span class='op'>:</span>
    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* 配列の処理 *</span><span class='regexp_end'>/</span></span>
    <span class='kw'>break</span><span class='semicolon'>;</span>
  <span class='id identifier rubyid_default'>default</span><span class='op'>:</span>
    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* 例外を発生させる *</span><span class='regexp_end'>/</span></span>
    <span class='id identifier rubyid_rb_raise'>rb_raise</span>(<span class='id identifier rubyid_rb_eTypeError'>rb_eTypeError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>not valid value</span><span class='tstring_end'>&quot;</span></span>)<span class='semicolon'>;</span>
    <span class='kw'>break</span><span class='semicolon'>;</span>
}</code></pre>

<p>それとデータタイプをチェックして，正しくなければ例外を発生する関数が用意されています．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='const'>Check_Type</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_type'>type</span>)</code></pre>

<p>この関数はvalueがtypeで無ければ，例外を発生させます．引数として与えられたVALUEのデータタイプが正しいかどうかチェックするためには，この関数を使います．</p>

<p>FIXNUMとNILに関してはより高速な判別マクロが用意されています．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>FIXNUM_P</span>(<span class='id identifier rubyid_obj'>obj</span>)
<span class='const'>NIL_P</span>(<span class='id identifier rubyid_obj'>obj</span>)</code></pre>

<h3 id="label-VALUE-E3-82-92C-E3-81-AE-E3-83-87-E3-83-BC-E3-82-BF-E3-81-AB-E5-A4-89-E6-8F-9B-E3-81-99-E3-82-8B">VALUEをCのデータに変換する</h3>

<p>データタイプがT_NIL，T_FALSE，T_TRUEである時，データはそれぞれnil，false，trueです．このデータタイプのオブジェクトはひとつずつしか存在しません．</p>

<p>データタイプがT_FIXNUMの時，これは31bitまたは63bitのサイズを持つ整数です．longのサイズが32bitのプラットフォームであれば31bitに，longのサイズが64bitのプラットフォームであれば63bit になります. FIXNUM を C の整数に変換するためにはマクロ「FIX2INT()」または「FIX2LONG()」を使います．これらのマクロを使用する際には事前にデータタイプがFIXNUMであることを確認する必要がありますが，比較的高速に変換を行うことができます．また，「FIX2LONG()」は例外を発生しませんが，「FIX2INT()」は変換結果がintのサイズに収まらない場合には例外を発生します．それから，FIXNUMに限らずRubyのデータを整数に変換する「NUM2INT()」および「NUM2LONG()」というマクロがあります．これらのマクロはデータタイプのチェック無しで使えます(整数に変換できない場合には例外が発生する)．同様にチェック無しで使える変換マクロはdoubleを取り出す「NUM2DBL()」があります．</p>

<p>char* を取り出す場合， StringValue() と StringValuePtr() を使います．StringValue(var) は var が String であれば何もせず，そうでなければ var を var.to_str() の結果に置き換えるマクロ，StringValuePtr(var) は同様に var をString に置き換えてから var のバイト列表現に対する char* を返すマクロです．var の内容を直接置き換える処理が入るので，var は lvalue である必要があります．また，StringValuePtr() に類似した StringValueCStr() というマクロもあります．StringValueCStr(var) は var を String に置き換えてから var の文字列表現に対する char* を返します．返される文字列の末尾には NUL 文字が付加されます．なお，途中に NUL 文字が含まれる場合は ArgumentError が発生します．一方，StringValuePtr() では，末尾に NUL 文字がある保証はなく，途中に NUL 文字が含まれている可能性もあります．</p>

<p>それ以外のデータタイプは対応するCの構造体があります．対応する構造体のあるVALUEはそのままキャスト(型変換)すれば構造体のポインタに変換できます．</p>

<p>構造体は「struct RXxxxx」という名前でruby.hで定義されています．例えば文字列は「struct RString」です．実際に使う可能性があるのは文字列と配列くらいだと思います．</p>

<p>ruby.hでは構造体へキャストするマクロも「RXXXXX()」(全部大文字にしたもの)という名前で提供されています(例: RSTRING())．ただし、構造体への直接のアクセスはできるだけ避け，対応するrb_xxxx() といった関数を使うようにして下さい．例えば，配列の要素へアクセスする場合は，rb_ary_entry(ary, offset)，rb_ary_store(ary, offset, obj) を利用するようにして下さい．</p>

<p>構造体からデータを取り出すマクロが提供されています．文字列strの長さを得るためには「RSTRING_LEN(str)」とし，文字列strをchar*として得るためには「RSTRING_PTR(str)」とします．</p>

<p>Rubyの構造体を直接アクセスする時に気をつけなければならないことは，配列や文字列の構造体の中身は参照するだけで，直接変更しないことです．直接変更した場合，オブジェクトの内容の整合性がとれなくなって，思わぬバグの原因になります．</p>

<h3 id="label-C-E3-81-AE-E3-83-87-E3-83-BC-E3-82-BF-E3-82-92VALUE-E3-81-AB-E5-A4-89-E6-8F-9B-E3-81-99-E3-82-8B">CのデータをVALUEに変換する</h3>

<p>VALUEの実際の構造は</p>
<dl class="rdoc-list note-list"><dt>FIXNUMの場合 
<dd>
<p>1bit左シフトして，LSBを立てる．</p>
</dd><dt>その他のポインタの場合 
<dd>
<p>そのままVALUEにキャストする．</p>
</dd></dl>

<p>となっています．よって，LSBをチェックすればVALUEがFIXNUMかどうかわかるわけです(ポインタのLSBが立っていないことを仮定している)．</p>

<p>ですから，FIXNUM以外のRubyのオブジェクトの構造体は単にVALUE にキャストするだけでVALUEに変換出来ます．ただし，任意の構造体がVALUEにキャスト出来るわけではありません．キャストするのはRubyの知っている構造体(ruby.hで定義されているstruct RXxxx のもの)だけです．</p>

<p>FIXNUMに関しては変換マクロを経由する必要があります．Cの整数からVALUEに変換するマクロは以下のものがあります．必要に応じて使い分けてください．</p>
<dl class="rdoc-list note-list"><dt>INT2FIX() 
<dd>
<p>もとの整数が31bitまたは63bit以内に収まる自信がある時</p>
</dd><dt>INT2NUM() 
<dd>
<p>任意の整数からVALUEへ</p>
</dd></dl>

<p>INT2NUM()は整数がFIXNUMの範囲に収まらない場合，Bignumに変換してくれます(が，少し遅い)．</p>

<p>Cの真偽値をRubyの <code>true</code> または <code>false</code> に変換する</p>
<dl class="rdoc-list note-list"><dt>RBOOL() 
<dd>
<p><code>RBOOL(v)</code> は <em>v</em> が非0のとき <code>Qtrue</code> ，それ以外の <em>v</em> が0のとき <code>Qfalse</code> を返します．</p>

<p>注意: RBOOLは定義されているのはRuby 3.1以降なので，それより古いバージョンをサポートするプログラム中で使いたいときは，以下のような定義を追加しておく必要があるでしょう．</p>

<pre class="code ruby"><code class="ruby"><span class='comment'>#ifndef RBOOL
</span><span class='comment'>#define RBOOL(v) ((v) ? Qtrue : Qfalse)
</span><span class='comment'>#endif</span></code></pre>

<h3 id="label-Ruby-E3-81-AE-E3-83-87-E3-83-BC-E3-82-BF-E3-82-92-E6-93-8D-E4-BD-9C-E3-81-99-E3-82-8B">Rubyのデータを操作する</h3>

<p>先程も述べた通り，Rubyの構造体をアクセスする時に内容の更新を行うことは勧められません．で，Rubyのデータを操作する時にはRubyが用意している関数を用いてください．</p>

<p>ここではもっとも使われるであろう文字列と配列の生成/操作を行う関数をあげます(全部ではないです)．</p>

<h4 id="label-E6-96-87-E5-AD-97-E5-88-97-E3-81-AB-E5-AF-BE-E3-81-99-E3-82-8B-E9-96-A2-E6-95-B0">文字列に対する関数</h4>
<dl class="rdoc-list note-list"><dt>rb_str_new(const char *ptr, long len) 
<dd>
<p>新しいRubyの文字列を生成する．</p>
</dd><dt>rb_str_new2(const char *ptr) 
<dt>rb_str_new_cstr(const char *ptr) 
<dd>
<p>Cの文字列からRubyの文字列を生成する．この関数の機能はrb_str_new(ptr, strlen(ptr))と同等である．</p>
</dd><dt>rb_str_new_literal(const char *ptr) 
<dd>
<p>Cのリテラル文字列からRubyの文字列を生成する．</p>
</dd><dt>rb_str_append(VALUE str1, VALUE str2) 
<dd>
<p>Rubyの文字列str1にRubyの文字列str2を追加する．</p>
</dd><dt>rb_sprintf(const char *format, …) 
<dt>rb_vsprintf(const char *format, va_list ap) 
<dd>
<p>Cの文字列formatと続く引数をprintf(3)のフォーマットにしたがって整形し，Rubyの文字列を生成する．</p>

<p>注意: “%”PRIsVALUEがObject#to_s(‘+’フラグが指定されているときはObject#inspect)を使ったVALUEの出力に利用できる．これは“%i”と衝突するため，整数には“%d”を使用すること．</p>
</dd><dt>rb_str_cat(VALUE str, const char *ptr, long len) 
<dd>
<p>Rubyの文字列strにlenバイトの文字列ptrを追加する．</p>
</dd><dt>rb_str_cat2(VALUE str, const char* ptr) 
<dt>rb_str_cat_cstr(VALUE str, const char* ptr) 
<dd>
<p>Rubyの文字列strにCの文字列ptrを追加する．この関数の機能はrb_str_cat(str, ptr, strlen(ptr))と同等である．</p>
</dd><dt>rb_str_catf(VALUE str, const char* format, …) 
<dt>rb_str_vcatf(VALUE str, const char* format, va_list ap) 
<dd>
<p>Cの文字列formatと続く引数をprintf(3)のフォーマットにしたがって整形し，Rubyの文字列strに追加する．この関数の機能は，それぞれrb_str_append(str, rb_sprintf(format, …)) やrb_str_append(str, rb_vsprintf(format, ap)) と同等である．</p>
</dd><dt>rb_enc_str_new(const char *ptr, long len, rb_encoding *enc) 
<dt>rb_enc_str_new_cstr(const char *ptr, rb_encoding *enc) 
<dd>
<p>指定されたエンコーディングでRubyの文字列を生成する.</p>
</dd><dt>rb_enc_str_new_literal(const char *ptr, rb_encoding *enc) 
<dd>
<p>Cのリテラル文字列から指定されたエンコーディングでRubyの文字列を生成する．</p>
</dd><dt>rb_usascii_str_new(const char *ptr, long len) 
<dt>rb_usascii_str_new_cstr(const char *ptr) 
<dd>
<p>エンコーディングがUS-ASCIIのRubyの文字列を生成する.</p>
</dd><dt>rb_usascii_str_new_literal(const char *ptr) 
<dd>
<p>Cのリテラル文字列からエンコーディングがUS-ASCIIのRubyの文字列を生成する．</p>
</dd><dt>rb_utf8_str_new(const char *ptr, long len) 
<dt>rb_utf8_str_new_cstr(const char *ptr) 
<dd>
<p>エンコーディングがUTF-8のRubyの文字列を生成する.</p>
</dd><dt>rb_utf8_str_new_literal(const char *ptr) 
<dd>
<p>Cのリテラル文字列からエンコーディングがUTF-8のRubyの文字列を生成する．</p>
</dd><dt>rb_str_resize(VALUE str, long len) 
<dd>
<p>Rubyの文字列のサイズをlenバイトに変更する．strの長さは前以てセットされていなければならない．lenが元の長さよりも短い時は，lenバイトを越えた部分の内容は捨てられる．lenが元の長さよりも長い時は，元の長さを越えた部分の内容は保存されないでゴミになるだろう．この関数の呼び出しによってRSTRING_PTR(str)が変更されるかもしれないことに注意．</p>
</dd><dt>rb_str_set_len(VALUE str, long len) 
<dd>
<p>Rubyの文字列のサイズをlenバイトにセットする．strが変更可能でなければ例外が発生する．RSTRING_LEN(str)とは無関係に，lenバイトまでの内容は保存される．lenはstrの容量を越えていてはならない．</p>
</dd><dt>rb_str_modify(VALUE str) 
<dd>
<p>Rubyの文字列の変更する準備をする．strが変更可能でなければ例外が発生する．strのバッファが共有されている場合は，新しいバッファを割り当てて共有されていない状態にする．RSTRING_PTRを使って中身を変更したり，rb_str_set_lenを呼んだりする前には，必ずこの関数を呼ばなけれならない．</p>
</dd></dl>

<h4 id="label-E9-85-8D-E5-88-97-E3-81-AB-E5-AF-BE-E3-81-99-E3-82-8B-E9-96-A2-E6-95-B0">配列に対する関数</h4>
<dl class="rdoc-list note-list"><dt>rb_ary_new() 
<dd>
<p>要素が0の配列を生成する．</p>
</dd><dt>rb_ary_new2(long len) 
<dt>rb_ary_new_capa(long len) 
<dd>
<p>要素が0の配列を生成する．len要素分の領域をあらかじめ割り当てておく．</p>
</dd><dt>rb_ary_new3(long n, …) 
<dt>rb_ary_new_from_args(long n, …) 
<dd>
<p>引数で指定したn要素を含む配列を生成する．</p>
</dd><dt>rb_ary_new4(long n, VALUE *elts) 
<dt>rb_ary_new_from_values(long n, VALUE *elts) 
<dd>
<p>配列で与えたn要素の配列を生成する．</p>
</dd><dt>rb_ary_to_ary(VALUE obj) 
<dd>
<p>オブジェクトを配列に変換する. Object#to_aryと同等である.</p>
</dd></dl>

<p>他にも配列を操作する関数が多数ある. これらは引数aryに配列を渡さなければならない. さもないとコアを吐く.</p>
<dl class="rdoc-list note-list"><dt>rb_ary_aref(int argc, const VALUE *argv, VALUE ary) 
<dd>
<p>Array#[]と同等.</p>
</dd><dt>rb_ary_entry(VALUE ary, long offset) 
<dd>
<p><a href=“offset”>ary</a></p>
</dd><dt>rb_ary_store(VALUE ary, long offset, VALUE obj) 
<dd>
<p><a href=“offset”>ary</a> = obj</p>
</dd><dt>rb_ary_subseq(VALUE ary, long beg, long len) 
<dd>
<p>ary[beg, len]</p>
</dd><dt>rb_ary_push(VALUE ary, VALUE val) 
<dt>rb_ary_pop(VALUE ary) 
<dt>rb_ary_shift(VALUE ary) 
<dt>rb_ary_unshift(VALUE ary, VALUE val) 
<dd>
<p>ary.push, ary.pop, ary.shift, ary.unshift</p>
</dd><dt>rb_ary_cat(VALUE ary, const VALUE *ptr, long len) 
<dd>
<p>配列aryにptrからlen個のオブジェクトを追加する．</p>
</dd></dl>

<h2 id="label-Ruby-E3-81-AE-E6-A9-9F-E8-83-BD-E3-82-92-E4-BD-BF-E3-81-86">Rubyの機能を使う</h2>

<p>原理的にRubyで書けることはCでも書けます．RubyそのものがCで記述されているんですから，当然といえば当然なんですけど．ここではRubyの拡張に使うことが多いだろうと予測される機能を中心に紹介します．</p>

<h3 id="label-Ruby-E3-81-AB-E6-A9-9F-E8-83-BD-E3-82-92-E8-BF-BD-E5-8A-A0-E3-81-99-E3-82-8B">Rubyに機能を追加する</h3>

<p>Rubyで提供されている関数を使えばRubyインタプリタに新しい機能を追加することができます．Rubyでは以下の機能を追加する関数が提供されています．</p>
<ul><li>
<p>クラス，モジュール</p>
</li><li>
<p>メソッド，特異メソッドなど</p>
</li><li>
<p>定数</p>
</li></ul>

<p>では順に紹介します．</p>

<h4 id="label-E3-82-AF-E3-83-A9-E3-82-B9-2F-E3-83-A2-E3-82-B8-E3-83-A5-E3-83-BC-E3-83-AB-E5-AE-9A-E7-BE-A9">クラス/モジュール定義</h4>

<p>クラスやモジュールを定義するためには，以下の関数を使います．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> <span class='id identifier rubyid_rb_define_class'>rb_define_class</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='kw'>super</span>)
<span class='const'>VALUE</span> <span class='id identifier rubyid_rb_define_module'>rb_define_module</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span>)</code></pre>

<p>これらの関数は新しく定義されたクラスやモジュールを返します．メソッドや定数の定義にこれらの値が必要なので，ほとんどの場合は戻り値を変数に格納しておく必要があるでしょう．</p>

<p>クラスやモジュールを他のクラスの内部にネストして定義する時には以下の関数を使います．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> <span class='id identifier rubyid_rb_define_class_under'>rb_define_class_under</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_outer'>outer</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='kw'>super</span>)
<span class='const'>VALUE</span> <span class='id identifier rubyid_rb_define_module_under'>rb_define_module_under</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_outer'>outer</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span>)</code></pre>

<h4 id="label-E3-83-A1-E3-82-BD-E3-83-83-E3-83-89-2F-E7-89-B9-E7-95-B0-E3-83-A1-E3-82-BD-E3-83-83-E3-83-89-E5-AE-9A-E7-BE-A9">メソッド/特異メソッド定義</h4>

<p>メソッドや特異メソッドを定義するには以下の関数を使います．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_method'>rb_define_method</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
                      <span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_func'>func</span>)(<span class='const'>ANYARGS</span>)<span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span>)

<span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_singleton_method'>rb_define_singleton_method</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_object'>object</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
                                <span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_func'>func</span>)(<span class='const'>ANYARGS</span>)<span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span>)</code></pre>

<p>念のため説明すると「特異メソッド」とは，その特定のオブジェクトに対してだけ有効なメソッドです．RubyではよくSmalltalkにおけるクラスメソッドとして，クラスに対する特異メソッドが使われます．</p>

<p>これらの関数の argcという引数はCの関数へ渡される引数の数(と形式)を決めます．argcが0以上の時は関数に引き渡す引数の数を意味します．16個以上の引数は使えません(が，要りませんよね，そんなに)．実際の関数には先頭の引数としてselfが与えられますので，指定した数より1多い引数を持つことになります．</p>

<p>argcが負の時は引数の数ではなく，形式を指定したことになります．argcが-1の時は引数を配列に入れて渡されます．argcが-2の時は引数はRubyの配列として渡されます．</p>

<p>メソッドを定義する関数はまだいくつかあります. ひとつはメソッド名としてIDを取ります. IDについては2.2.2を参照.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_method_id'>rb_define_method_id</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
                         <span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_func'>func</span>)(<span class='const'>ANYARGS</span>)<span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span>)</code></pre>

<p>private/protectedなメソッドを定義するふたつの関数があります.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_private_method'>rb_define_private_method</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
                              <span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_func'>func</span>)(<span class='const'>ANYARGS</span>)<span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span>)
<span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_protected_method'>rb_define_protected_method</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
                                <span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_func'>func</span>)(<span class='const'>ANYARGS</span>)<span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span>)</code></pre>

<p>privateメソッドとは関数形式でしか呼び出すことの出来ないメソッドです．</p>

<p>最後に， rb_define_module関数はモジュール関数を定義します．モジュール関数とはモジュールの特異メソッドであり，同時にprivateメソッドでもあるものです．例をあげるとMathモジュールのsqrt()などがあげられます．このメソッドは</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Math</span>.<span class='id identifier rubyid_sqrt'>sqrt</span>(<span class='int'>4</span>)</code></pre>

<p>という形式でも</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_include'>include</span> <span class='const'>Math</span>
<span class='id identifier rubyid_sqrt'>sqrt</span>(<span class='int'>4</span>)</code></pre>

<p>という形式でも使えます．モジュール関数を定義する関数は以下の通りです．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_module_function'>rb_define_module_function</span>(<span class='const'>VALUE</span> <span class='kw'>module</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
                               <span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_func'>func</span>)(<span class='const'>ANYARGS</span>)<span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span>)</code></pre>

<p>関数的メソッド(Kernelモジュールのprivate method)を定義するための関数は以下の通りです．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_global_function'>rb_define_global_function</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_func'>func</span>)(<span class='const'>ANYARGS</span>)<span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span>)</code></pre>

<p>メソッドの別名を定義するための関数は以下の通りです．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_alias'>rb_define_alias</span>(<span class='const'>VALUE</span> <span class='kw'>module</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span><span class='op'>*</span> <span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span><span class='op'>*</span> <span class='id identifier rubyid_old'>old</span>)<span class='semicolon'>;</span></code></pre>

<p>属性の取得・設定メソッドを定義するには</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_attr'>rb_define_attr</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_read'>read</span><span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_write'>write</span>)</code></pre>

<p>クラスメソッドallocateを定義したり削除したりするための関数は以下の通りです．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_alloc_func'>rb_define_alloc_func</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_func'>func</span>)(<span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span>))<span class='semicolon'>;</span>
<span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_undef_alloc_func'>rb_undef_alloc_func</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span>)<span class='semicolon'>;</span></code></pre>

<p>funcはクラスを引数として受け取って，新しく割り当てられたインスタンスを返さなくてはなりません．このインスタンスは，外部リソースなどを含まない，できるだけ「空」のままにしておいたほうがよいでしょう．</p>

<p>継承したクラスにある既存のメソッドをオーバーライドしているなら，オーバーライドされたメソッドを呼び出すには以下の関数を使います．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> <span class='id identifier rubyid_rb_call_super'>rb_call_super</span>(<span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_argv'>argv</span>)</code></pre>

<p>現在のスコープのレシーバは(他に方法がなければ)，以下の関数で得ることができます．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> <span class='id identifier rubyid_rb_current_receiver'>rb_current_receiver</span>(<span class='id identifier rubyid_void'>void</span>)</code></pre>

<h4 id="label-E5-AE-9A-E6-95-B0-E5-AE-9A-E7-BE-A9">定数定義</h4>

<p>拡張ライブラリが必要な定数はあらかじめ定義しておいた方が良いでしょう．定数を定義する関数は二つあります．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_const'>rb_define_const</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='id identifier rubyid_val'>val</span>)
<span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_global_const'>rb_define_global_const</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='id identifier rubyid_val'>val</span>)</code></pre>

<p>前者は特定のクラス/モジュールに属する定数を定義するもの，後者はグローバルな定数を定義するものです．</p>

<h3 id="label-Ruby-E3-81-AE-E6-A9-9F-E8-83-BD-E3-82-92C-E3-81-8B-E3-82-89-E5-91-BC-E3-81-B3-E5-87-BA-E3-81-99">Rubyの機能をCから呼び出す</h3>

<p>既に『1.5 Rubyのデータを操作する』で一部紹介したような関数を使えば，Rubyの機能を実現している関数を直接呼び出すことが出来ます．</p>

<p># このような関数の一覧表はいまのところありません．ソースを見# るしかないですね．</p>

<p>それ以外にもRubyの機能を呼び出す方法はいくつかあります．</p>

<h4 id="label-Ruby-E3-81-AE-E3-83-97-E3-83-AD-E3-82-B0-E3-83-A9-E3-83-A0-E3-82-92eval-E3-81-99-E3-82-8B">Rubyのプログラムをevalする</h4>

<p>CからRubyの機能を呼び出すもっとも簡単な方法として，文字列で与えられたRubyのプログラムを評価する以下の関数があります．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> <span class='id identifier rubyid_rb_eval_string'>rb_eval_string</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_str'>str</span>)</code></pre>

<p>この評価は現在の環境で行われます．つまり，現在のローカル変数などを受け継ぎます．</p>

<p>評価は例外を発生するかもしれないことに注意しましょう. より安全な関数もあります.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> <span class='id identifier rubyid_rb_eval_string_protect'>rb_eval_string_protect</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_str'>str</span><span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='op'>*</span><span class='id identifier rubyid_state'>state</span>)</code></pre>

<p>この関数はエラーが発生するとnilを返します．そして，成功時には*stateはゼロに，さもなくば非ゼロになります．</p>

<h4 id="label-ID-E3-81-BE-E3-81-9F-E3-81-AF-E3-82-B7-E3-83-B3-E3-83-9C-E3-83-AB">IDまたはシンボル</h4>

<p>Cから文字列を経由せずにRubyのメソッドを呼び出すこともできます．その前に，Rubyインタプリタ内でメソッドや変数名を指定する時に使われているIDについて説明しておきましょう．</p>

<p>IDとは変数名，メソッド名を表す整数です．Rubyの中では</p>

<pre class="code ruby"><code class="ruby"><span class='symbeg'>:</span><span class='id identifier rubyid_識別子'>識別子</span></code></pre>

<p>または</p>

<pre class="code ruby"><code class="ruby"><span class='symbeg'>:&quot;</span><span class='tstring_content'>任意の文字列</span><span class='tstring_end'>&quot;</span></span></code></pre>

<p>でアクセスできます．Cからこの整数を得るためには関数</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rb_intern'>rb_intern</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span>)
<span class='id identifier rubyid_rb_intern_str'>rb_intern_str</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_name'>name</span>)</code></pre>

<p>を使います．Rubyから引数として与えられたシンボル(または文字列)をIDに変換するには以下の関数を使います．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rb_to_id'>rb_to_id</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_symbol'>symbol</span>)
<span class='id identifier rubyid_rb_check_id'>rb_check_id</span>(<span class='id identifier rubyid_volatile'>volatile</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span>)
<span class='id identifier rubyid_rb_check_id_cstr'>rb_check_id_cstr</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_long'>long</span> <span class='id identifier rubyid_len'>len</span><span class='comma'>,</span> <span class='id identifier rubyid_rb_encoding'>rb_encoding</span> <span class='op'>*</span><span class='id identifier rubyid_enc'>enc</span>)</code></pre>

<p>もし引数がシンボルでも文字列でもなければ，to_strメソッドで文字列に変換しようとします．第二の関数はその変換結果を*nameに保存し,その名前が既知のシンボルでない場合は0を返します．この関数が0以外を返した場合は*nameは常にシンボルか文字列であり，0を返した場合は常に文字列です．第三の関数はRubyの文字列ではなくNUL終端されたCの文字列を使います．</p>

<p>Rubyから引数として与えられたシンボル(または文字列)をシンボルに変換するには以下の関数を使います．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rb_to_symbol'>rb_to_symbol</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_name'>name</span>)
<span class='id identifier rubyid_rb_check_symbol'>rb_check_symbol</span>(<span class='id identifier rubyid_volatile'>volatile</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_namep'>namep</span>)
<span class='id identifier rubyid_rb_check_symbol_cstr'>rb_check_symbol_cstr</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_ptr'>ptr</span><span class='comma'>,</span> <span class='id identifier rubyid_long'>long</span> <span class='id identifier rubyid_len'>len</span><span class='comma'>,</span> <span class='id identifier rubyid_rb_encoding'>rb_encoding</span> <span class='op'>*</span><span class='id identifier rubyid_enc'>enc</span>)</code></pre>

<p>これらの関数は，IDの代わりにシンボルを返すことを除けば上記の関数と同じです．</p>

<h4 id="label-C-E3-81-8B-E3-82-89Ruby-E3-81-AE-E3-83-A1-E3-82-BD-E3-83-83-E3-83-89-E3-82-92-E5-91-BC-E3-81-B3-E5-87-BA-E3-81-99">CからRubyのメソッドを呼び出す</h4>

<p>Cから文字列を経由せずにRubyのメソッドを呼び出すためには以下の関数を使います．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> <span class='id identifier rubyid_rb_funcall'>rb_funcall</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_recv'>recv</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_mid'>mid</span><span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span><span class='comma'>,</span> <span class='op'>...</span>)</code></pre>

<p>この関数はオブジェクトrecvのmidで指定されるメソッドを呼び出します．その他に引数の指定の仕方が違う以下の関数もあります．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> <span class='id identifier rubyid_rb_funcall2'>rb_funcall2</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_recv'>recv</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_mid'>mid</span><span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_argv'>argv</span>)
<span class='const'>VALUE</span> <span class='id identifier rubyid_rb_funcallv'>rb_funcallv</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_recv'>recv</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_mid'>mid</span><span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_argv'>argv</span>)
<span class='const'>VALUE</span> <span class='id identifier rubyid_rb_apply'>rb_apply</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_recv'>recv</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_mid'>mid</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='id identifier rubyid_args'>args</span>)</code></pre>

<p>applyには引数としてRubyの配列を与えます．</p>

<h4 id="label-E5-A4-89-E6-95-B0-2F-E5-AE-9A-E6-95-B0-E3-82-92-E5-8F-82-E7-85-A7-2F-E6-9B-B4-E6-96-B0-E3-81-99-E3-82-8B">変数/定数を参照/更新する</h4>

<p>Cから関数を使って参照・更新できるのは，定数，インスタンス変数です．大域変数は一部のものはCの大域変数としてアクセスできます．ローカル変数を参照する方法は公開していません．</p>

<p>オブジェクトのインスタンス変数を参照・更新する関数は以下の通りです．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> <span class='id identifier rubyid_rb_ivar_get'>rb_ivar_get</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_obj'>obj</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_id'>id</span>)
<span class='const'>VALUE</span> <span class='id identifier rubyid_rb_ivar_set'>rb_ivar_set</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_obj'>obj</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='id identifier rubyid_val'>val</span>)</code></pre>

<p>idはrb_intern()で得られるものを使ってください．</p>

<p>定数を参照するには以下の関数を使ってください．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> <span class='id identifier rubyid_rb_const_get'>rb_const_get</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_obj'>obj</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_id'>id</span>)</code></pre>

<p>定数を新しく定義するためには『2.1.3 定数定義』で紹介されている関数を使ってください．</p>

<h2 id="label-Ruby-E3-81-A8C-E3-81-A8-E3-81-AE-E6-83-85-E5-A0-B1-E5-85-B1-E6-9C-89">RubyとCとの情報共有</h2>

<p>C言語とRubyの間で情報を共有する方法について解説します．</p>

<h3 id="label-C-E3-81-8B-E3-82-89-E5-8F-82-E7-85-A7-E3-81-A7-E3-81-8D-E3-82-8BRuby-E3-81-AE-E5-AE-9A-E6-95-B0">Cから参照できるRubyの定数</h3>

<p>以下のRubyの定数はCのレベルから参照できます．</p>
<dl class="rdoc-list note-list"><dt>Qtrue 
<dt>Qfalse 
<dd>
<p>真偽値．C言語から見た「true」と「false」．</p>
</dd><dt>Qnil 
<dd>
<p>C言語から見た「nil」．</p>
</dd></dl>

<p>RTEST(obj)というマクロはobjがQfalseかQnilのとき0を返します．</p>

<h3 id="label-C-E3-81-A8Ruby-E3-81-A7-E5-85-B1-E6-9C-89-E3-81-95-E3-82-8C-E3-82-8B-E5-A4-A7-E5-9F-9F-E5-A4-89-E6-95-B0">CとRubyで共有される大域変数</h3>

<p>CとRubyで大域変数を使って情報を共有できます．共有できる大域変数にはいくつかの種類があります．そのなかでもっとも良く使われると思われるのはrb_define_variable()です．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_variable'>rb_define_variable</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_var'>var</span>)</code></pre>

<p>この関数はRubyとCとで共有する大域変数を定義します．変数名が‘$’で始まらない時には自動的に追加されます．この変数の値を変更すると自動的にRubyの対応する変数の値も変わります．</p>

<p>またRuby側からは更新できない変数もあります．このread onlyの変数は以下の関数で定義します．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_readonly_variable'>rb_define_readonly_variable</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_var'>var</span>)</code></pre>

<p>これら変数の他にhookをつけた大域変数を定義できます．hook付きの大域変数は以下の関数を用いて定義します．hook付き大域変数の値の参照や設定はhookで行う必要があります．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_hooked_variable'>rb_define_hooked_variable</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_var'>var</span><span class='comma'>,</span>
                               <span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_getter'>getter</span>)()<span class='comma'>,</span> <span class='id identifier rubyid_void'>void</span> (<span class='op'>*</span><span class='id identifier rubyid_setter'>setter</span>)())</code></pre>

<p>この関数はCの関数によってhookのつけられた大域変数を定義します．変数が参照された時には関数getterが，変数に値がセットされた時には関数setterが呼ばれる．hookを指定しない場合はgetterやsetterに0を指定します．– getterもsetterも0ならばrb_define_variable()と同じになる．++</p>

<p>getterとsetterの仕様は次の通りです．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_getter'>getter</span>)(<span class='const'>ID</span> <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_var'>var</span>)<span class='semicolon'>;</span>
<span class='id identifier rubyid_void'>void</span> (<span class='op'>*</span><span class='id identifier rubyid_setter'>setter</span>)(<span class='const'>VALUE</span> <span class='id identifier rubyid_val'>val</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_var'>var</span>)<span class='semicolon'>;</span></code></pre>

<p>それから，対応するCの変数を持たないRubyの大域変数を定義することもできます. その変数の値はフック関数のみによって取得・設定されます.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_define_virtual_variable'>rb_define_virtual_variable</span>(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
                                <span class='const'>VALUE</span> (<span class='op'>*</span><span class='id identifier rubyid_getter'>getter</span>)()<span class='comma'>,</span> <span class='id identifier rubyid_void'>void</span> (<span class='op'>*</span><span class='id identifier rubyid_setter'>setter</span>)())</code></pre>

<p>この関数によって定義されたRubyの大域変数が参照された時にはgetterが，変数に値がセットされた時にはsetterが呼ばれます．</p>

<p>getterとsetterの仕様は以下の通りです．</p>

<pre class="code ruby"><code class="ruby">(<span class='op'>*</span><span class='id identifier rubyid_getter'>getter</span>)(<span class='const'>ID</span> <span class='id identifier rubyid_id'>id</span>)<span class='semicolon'>;</span>
(<span class='op'>*</span><span class='id identifier rubyid_setter'>setter</span>)(<span class='const'>VALUE</span> <span class='id identifier rubyid_val'>val</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_id'>id</span>)<span class='semicolon'>;</span></code></pre>

<h3 id="label-C-E3-81-AE-E3-83-87-E3-83-BC-E3-82-BF-E3-82-92Ruby-E3-82-AA-E3-83-96-E3-82-B8-E3-82-A7-E3-82-AF-E3-83-88-E3-81-AB-E3-81-99-E3-82-8B">CのデータをRubyオブジェクトにする</h3>

<p>Cの世界で定義されたデータ(構造体)をRubyのオブジェクトとして取り扱いたい場合がありえます．このような場合はTypedData_XXX マクロ群を用いて構造体へのポインタとRubyのオブジェクトとを互いに変換できます．</p>

<p>– 古い(非Typedな)Data_XXXマクロ群は非推奨になりました．将来のバージョンのRubyでは古いマクロは動作しなくなる可能性があります．++</p>

<h4 id="label-E6-A7-8B-E9-80-A0-E4-BD-93-E3-81-8B-E3-82-89-E3-82-AA-E3-83-96-E3-82-B8-E3-82-A7-E3-82-AF-E3-83-88-E3-81-B8">構造体からオブジェクトへ</h4>

<p>構造体へのポインタsvalをRubyオブジェクトに変換するには次のマクロを使います。</p>

<pre class="code ruby"><code class="ruby"><span class='const'>TypedData_Wrap_Struct</span>(<span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='id identifier rubyid_data_type'>data_type</span><span class='comma'>,</span> <span class='id identifier rubyid_sval'>sval</span>)</code></pre>

<p>このマクロの戻り値は生成されたオブジェクトを表すVALUE値です．</p>

<p>klassはこのオブジェクトのクラスです．klassは, Objectクラスから派生し, 必ずrb_define_alloc_funcかrb_undef_alloc_funcを呼び出してallocatorを設定してください．</p>

<p>data_typeはこの構造体をRubyが管理するための情報を記述したconst rb_data_type_t型へのポインタです．</p>

<p>rb_data_type_tは次のように定義されています．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_typedef'>typedef</span> <span class='id identifier rubyid_struct'>struct</span> <span class='id identifier rubyid_rb_data_type_struct'>rb_data_type_struct</span> <span class='id identifier rubyid_rb_data_type_t'>rb_data_type_t</span><span class='semicolon'>;</span>

<span class='id identifier rubyid_struct'>struct</span> <span class='id identifier rubyid_rb_data_type_struct'>rb_data_type_struct</span> {
    <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>*</span><span class='id identifier rubyid_wrap_struct_name'>wrap_struct_name</span><span class='semicolon'>;</span>
    <span class='id identifier rubyid_struct'>struct</span> {
        <span class='id identifier rubyid_void'>void</span> (<span class='op'>*</span><span class='id identifier rubyid_dmark'>dmark</span>)(<span class='id identifier rubyid_void'>void</span><span class='op'>*</span>)<span class='semicolon'>;</span>
        <span class='id identifier rubyid_void'>void</span> (<span class='op'>*</span><span class='id identifier rubyid_dfree'>dfree</span>)(<span class='id identifier rubyid_void'>void</span><span class='op'>*</span>)<span class='semicolon'>;</span>
        <span class='id identifier rubyid_size_t'>size_t</span> (<span class='op'>*</span><span class='id identifier rubyid_dsize'>dsize</span>)(<span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_void'>void</span> <span class='op'>*</span>)<span class='semicolon'>;</span>
        <span class='id identifier rubyid_void'>void</span> <span class='op'>*</span><span class='id identifier rubyid_reserved'>reserved</span>[<span class='int'>2</span>]<span class='semicolon'>;</span>
    } <span class='id identifier rubyid_function'>function</span><span class='semicolon'>;</span>
    <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_rb_data_type_t'>rb_data_type_t</span> <span class='op'>*</span><span class='id identifier rubyid_parent'>parent</span><span class='semicolon'>;</span>
    <span class='id identifier rubyid_void'>void</span> <span class='op'>*</span><span class='id identifier rubyid_data'>data</span><span class='semicolon'>;</span>
    <span class='const'>VALUE</span> <span class='id identifier rubyid_flags'>flags</span><span class='semicolon'>;</span>
}<span class='semicolon'>;</span></code></pre>

<p>wrap_struct_nameはこの構造体を識別する名前です．主に統計情報の収集と出力に用いられます．プロセス内で一意であれば特にCやRubyの識別子として有効である必要はありません．</p>

<p>dmarkおよびdfree関数はGC実行中に呼び出されます. なお, GC実行中はRubyオブジェクトのアロケーションは禁止されます. よって, dmarkおよびdfree関数でRubyオブジェクトのアロケーションは行わないでください.</p>

<p>dmarkはガーベージコレクタがオブジェクトへの参照をマークするときに用いる関数です．この構造体がRubyのオブジェクトへの参照を保持するときには, dmarkではrb_gc_markなどを用いて構造体内のすべての参照をマークしなければなりません．そのような参照を含まない時には0を指定します．</p>

<p>– そのような参照は勧められません．++</p>

<p>dfreeはこの構造体がもう不要になった時に呼ばれる関数です．この関数がガーベージコレクタから呼ばれます．これがRUBY_DEFAULT_FREEの場合は，単純に構造体が解放されます．</p>

<p>dsizeは構造体が消費しているメモリのバイト数を返す関数です．引数として構造体へのポインタが渡されます．実装困難であれば0 を渡しても差し支えありませんが, できるだけ指定するようにしてください．</p>

<p>reservedとparentは0で埋めなければなりません．</p>

<p>dataにはユーザー定義の任意の値を指定できます．Rubyはこの値には関知しないので，好きに使ってください．</p>

<p>flagsには次のフラグのうち当てはまるもののビット和を指定します．いずれもRubyのガーベージコレクタについての深い理解を必要としますので，良くわからない場合には0を指定すると良いでしょう．</p>
<dl class="rdoc-list note-list"><dt>RUBY_TYPED_FREE_IMMEDIATELY 
<dd>
<p>このフラグを指定すると，ガーベージコレクタはこの構造体が不要になった場合にはGC中に直ちにdfreeを呼び出します．dfreeがRuby内部のロック(GVL)を解放する可能性がない場合はこのフラグを指定できます．</p>

<p>指定しない場合はdfree呼び出しは遅延され, ファイナライザと同じタイミングで実行されます．</p>
</dd><dt>RUBY_TYPED_WB_PROTECTED 
<dd>
<p>オブジェクトの実装がライトバリアをサポートしていることを示します．このフラグを指定するとRubyはそのオブジェクトに対してGCをより効率的に実行できます．ただし，指定する場合はユーザーはそのオブジェクトのすべてのメソッドの実装に適切にライトバリアを挿入する責任があります．さもなくばRubyは実行時にクラッシュする可能性があります．</p>

<p>ライトバリアについてはdoc/extension.ja.rdocのAppendix D “世代別GC”も参照してください．</p>
</dd></dl>

<p>Cの構造体の割当と対応するオブジェクトの生成を同時に行うマクロとして以下のものが提供されています．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>TypedData_Make_Struct</span>(<span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='id identifier rubyid_type'>type</span><span class='comma'>,</span> <span class='id identifier rubyid_data_type'>data_type</span><span class='comma'>,</span> <span class='id identifier rubyid_sval'>sval</span>)</code></pre>

<p>このマクロの戻り値は生成されたオブジェクトのVALUE値です．このマクロは以下の式のように働きます:</p>

<pre class="code ruby"><code class="ruby">(<span class='id identifier rubyid_sval'>sval</span> <span class='op'>=</span> <span class='const'>ZALLOC</span>(<span class='id identifier rubyid_type'>type</span>)<span class='comma'>,</span> <span class='const'>TypedData_Wrap_Struct</span>(<span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='id identifier rubyid_data_type'>data_type</span><span class='comma'>,</span> <span class='id identifier rubyid_sval'>sval</span>))</code></pre>

<p>klass, data_typeはData_Wrap_Structと同じ働きをします．type は割り当てるC構造体の型です．割り当てられた構造体は変数sval に代入されます．この変数の型は (type*) である必要があります．</p>

<h4 id="label-E3-82-AA-E3-83-96-E3-82-B8-E3-82-A7-E3-82-AF-E3-83-88-E3-81-8B-E3-82-89-E6-A7-8B-E9-80-A0-E4-BD-93-E3-81-B8">オブジェクトから構造体へ</h4>

<p>TypedData_Wrap_StructやTypedData_Make_Structで生成したオブジェクトから構造体へのポインタを復元するには以下のマクロを用います．</p>

<pre class="code ruby"><code class="ruby"><span class='const'>TypedData_Get_Struct</span>(<span class='id identifier rubyid_obj'>obj</span><span class='comma'>,</span> <span class='id identifier rubyid_type'>type</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_data_type'>data_type</span><span class='comma'>,</span> <span class='id identifier rubyid_sval'>sval</span>)</code></pre>

<p>Cの構造体へのポインタは変数svalに代入されます．</p>

<p>これらのマクロの使い方はちょっと分かりにくいので，後で説明する例題を参照してください．</p>

<h2 id="label-E4-BE-8B-3A+dbm-E3-81-AE-E6-8B-A1-E5-BC-B5-E3-83-A9-E3-82-A4-E3-83-96-E3-83-A9-E3-83-AA-E3-81-AE-E4-BD-9C-E6-88-90">例: dbmの拡張ライブラリの作成</h2>

<h3 id="label-E3-83-87-E3-82-A3-E3-83-AC-E3-82-AF-E3-83-88-E3-83-AA-E3-82-92-E4-BD-9C-E3-82-8B">ディレクトリを作る</h3>

<pre class="code ruby"><code class="ruby"><span class='tstring'><span class='tstring_beg'>% </span><span class='tstring_content'>mkdir</span><span class='tstring_end'> </span></span><span class='id identifier rubyid_ext'>ext</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>dbm</span></code></pre>

<p>Ruby 1.1からは任意のディレクトリでダイナミックライブラリを作ることができるようになりました．Rubyに静的にリンクする場合にはRubyを展開したディレクトリの下，extディレクトリの中に拡張ライブラリ用のディレクトリを作る必要があります．名前は適当に選んで構いません．</p>

<h3 id="label-E8-A8-AD-E8-A8-88-E3-81-99-E3-82-8B">設計する</h3>

<p>まあ，当然なんですけど，どういう機能を実現するかどうかまず設計する必要があります．どんなクラスをつくるか，そのクラスにはどんなメソッドがあるか，クラスが提供する定数などについて設計します．</p>

<h3 id="label-C-E3-82-B3-E3-83-BC-E3-83-89-E3-82-92-E6-9B-B8-E3-81-8F">Cコードを書く</h3>

<p>拡張ライブラリ本体となるC言語のソースを書きます．C言語のソースがひとつの時には「ライブラリ名.c」を選ぶと良いでしょう．C 言語のソースが複数の場合には逆に「ライブラリ名.c」というファイル名は避ける必要があります．オブジェクトファイルとモジュール生成時に中間的に生成される「ライブラリ名.o」というファイルとが衝突するからです．また，後述する mkmf ライブラリのいくつかの関数がコンパイルを要するテストのために「conftest.c」というファイル名を使用することに注意してください．ソースファイル名として「conftest.c」を使用してはなりません．</p>

<p>Rubyは拡張ライブラリをロードする時に「Init_ライブラリ名」という関数を自動的に実行します．dbmライブラリの場合「Init_dbm」です．この関数の中でクラス，モジュール，メソッド，定数などの定義を行います．dbm.cから一部引用します．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span>
<span class='const'>Init_dbm</span>(<span class='id identifier rubyid_void'>void</span>)
{
    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* DBMクラスを定義する *</span><span class='regexp_end'>/</span></span>
    <span class='const'>VALUE</span> <span class='id identifier rubyid_cDBM'>cDBM</span> <span class='op'>=</span> <span class='id identifier rubyid_rb_define_class'>rb_define_class</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DBM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_rb_cObject'>rb_cObject</span>)<span class='semicolon'>;</span>
    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* DBMはEnumerableモジュールをインクルードする *</span><span class='regexp_end'>/</span></span>
    <span class='id identifier rubyid_rb_include_module'>rb_include_module</span>(<span class='id identifier rubyid_cDBM'>cDBM</span><span class='comma'>,</span> <span class='id identifier rubyid_rb_mEnumerable'>rb_mEnumerable</span>)<span class='semicolon'>;</span>

    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* DBMクラスのクラスメソッドopen(): 引数はCの配列で受ける *</span><span class='regexp_end'>/</span></span>
    <span class='id identifier rubyid_rb_define_singleton_method'>rb_define_singleton_method</span>(<span class='id identifier rubyid_cDBM'>cDBM</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_fdbm_s_open'>fdbm_s_open</span><span class='comma'>,</span> <span class='op'>-</span><span class='int'>1</span>)<span class='semicolon'>;</span>

    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* DBMクラスのメソッドclose(): 引数はなし *</span><span class='regexp_end'>/</span></span>
    <span class='id identifier rubyid_rb_define_method'>rb_define_method</span>(<span class='id identifier rubyid_cDBM'>cDBM</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>close</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_fdbm_close'>fdbm_close</span><span class='comma'>,</span> <span class='int'>0</span>)<span class='semicolon'>;</span>
    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* DBMクラスのメソッド[]: 引数は1個 *</span><span class='regexp_end'>/</span></span>
    <span class='id identifier rubyid_rb_define_method'>rb_define_method</span>(<span class='id identifier rubyid_cDBM'>cDBM</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_fdbm_fetch'>fdbm_fetch</span><span class='comma'>,</span> <span class='int'>1</span>)<span class='semicolon'>;</span>

    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* ... *</span><span class='regexp_end'>/</span></span>

    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* DBMデータを格納するインスタンス変数名のためのID *</span><span class='regexp_end'>/</span></span>
    <span class='id identifier rubyid_id_dbm'>id_dbm</span> <span class='op'>=</span> <span class='id identifier rubyid_rb_intern'>rb_intern</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dbm</span><span class='tstring_end'>&quot;</span></span>)<span class='semicolon'>;</span>
}</code></pre>

<p>DBMライブラリはdbmのデータと対応するオブジェクトになるはずですから，Cの世界のdbmをRubyの世界に取り込む必要があります．</p>

<p>dbm.cではTypedData_Make_Structを以下のように使っています．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_struct'>struct</span> <span class='id identifier rubyid_dbmdata'>dbmdata</span> {
    <span class='id identifier rubyid_int'>int</span>  <span class='id identifier rubyid_di_size'>di_size</span><span class='semicolon'>;</span>
    <span class='const'>DBM</span> <span class='op'>*</span><span class='id identifier rubyid_di_dbm'>di_dbm</span><span class='semicolon'>;</span>
}<span class='semicolon'>;</span>

<span class='id identifier rubyid_static'>static</span> <span class='id identifier rubyid_const'>const</span> <span class='id identifier rubyid_rb_data_type_t'>rb_data_type_t</span> <span class='id identifier rubyid_dbm_type'>dbm_type</span> <span class='op'>=</span> {
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dbm</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    {<span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_free_dbm'>free_dbm</span><span class='comma'>,</span> <span class='id identifier rubyid_memsize_dbm'>memsize_dbm</span><span class='comma'>,</span>}<span class='comma'>,</span>
    <span class='int'>0</span><span class='comma'>,</span> <span class='int'>0</span><span class='comma'>,</span>
    <span class='const'>RUBY_TYPED_FREE_IMMEDIATELY</span><span class='comma'>,</span>
}<span class='semicolon'>;</span>

<span class='id identifier rubyid_obj'>obj</span> <span class='op'>=</span> <span class='const'>TypedData_Make_Struct</span>(<span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span> <span class='id identifier rubyid_struct'>struct</span> <span class='id identifier rubyid_dbmdata'>dbmdata</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_dbm_type'>dbm_type</span><span class='comma'>,</span> <span class='id identifier rubyid_dbmp'>dbmp</span>)<span class='semicolon'>;</span></code></pre>

<p>ここではdbmdata構造体へのポインタをDataにカプセル化しています．DBM*を直接カプセル化しないのはclose()した時の処理を考えてのことです．</p>

<p>Dataオブジェクトからdbmstruct構造体のポインタを取り出すために以下のマクロを使っています．</p>

<pre class="code ruby"><code class="ruby"><span class='comment'>#define GetDBM(obj, dbmp) do {\
</span>    <span class='const'>TypedData_Get_Struct</span>((<span class='id identifier rubyid_obj'>obj</span>)<span class='comma'>,</span> <span class='id identifier rubyid_struct'>struct</span> <span class='id identifier rubyid_dbmdata'>dbmdata</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_dbm_type'>dbm_type</span><span class='comma'>,</span> (<span class='id identifier rubyid_dbmp'>dbmp</span>))<span class='semicolon'>;</span>\
    <span class='kw'>if</span> ((<span class='id identifier rubyid_dbmp'>dbmp</span>) <span class='op'>==</span> <span class='int'>0</span>) <span class='id identifier rubyid_closed_dbm'>closed_dbm</span>()<span class='semicolon'>;</span>\
    <span class='kw'>if</span> ((<span class='id identifier rubyid_dbmp'>dbmp</span>)<span class='tlambda'>-&gt;</span><span class='id identifier rubyid_di_dbm'>di_dbm</span> <span class='op'>==</span> <span class='int'>0</span>) <span class='id identifier rubyid_closed_dbm'>closed_dbm</span>()<span class='semicolon'>;</span>\
<span class='embexpr_end'>}</span> <span class='kw'>while</span> (<span class='int'>0</span>)</code></pre>

<p>ちょっと複雑なマクロですが，要するにdbmdata構造体のポインタの取り出しと，closeされているかどうかのチェックをまとめているだけです．</p>

<p>DBMクラスにはたくさんメソッドがありますが，分類すると3種類の引数の受け方があります．ひとつは引数の数が固定のもので，例としてはdeleteメソッドがあります．deleteメソッドを実装しているfdbm_delete()はこのようになっています．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_static'>static</span> <span class='const'>VALUE</span>
<span class='id identifier rubyid_fdbm_delete'>fdbm_delete</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_obj'>obj</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='id identifier rubyid_keystr'>keystr</span>)
{
    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* ... *</span><span class='regexp_end'>/</span></span>
}</code></pre>

<p>引数の数が固定のタイプは第1引数がself，第2引数以降がメソッドの引数となります．</p>

<p>引数の数が不定のものはCの配列で受けるものとRubyの配列で受けるものとがあります．dbmライブラリの中で，Cの配列で受けるものはDBMのクラスメソッドであるopen()です．これを実装している関数fdbm_s_open()はこうなっています．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_static'>static</span> <span class='const'>VALUE</span>
<span class='id identifier rubyid_fdbm_s_open'>fdbm_s_open</span>(<span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_argc'>argc</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_argv'>argv</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span>)
{
    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* ... *</span><span class='regexp_end'>/</span></span>

    <span class='kw'>if</span> (<span class='id identifier rubyid_rb_scan_args'>rb_scan_args</span>(<span class='id identifier rubyid_argc'>argc</span><span class='comma'>,</span> <span class='id identifier rubyid_argv'>argv</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>11</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_vmode'>vmode</span>) <span class='op'>==</span> <span class='int'>1</span>) {
        <span class='id identifier rubyid_mode'>mode</span> <span class='op'>=</span> <span class='int'>0666</span><span class='semicolon'>;</span>          <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* default value *</span><span class='regexp_end'>/</span></span>
    }

    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* ... *</span><span class='regexp_end'>/</span></span>
}</code></pre>

<p>このタイプの関数は第1引数が与えられた引数の数，第2引数が与えられた引数の入っている配列になります．selfは第3引数として与えられます．</p>

<p>この配列で与えられた引数を解析するための関数がopen()でも使われているrb_scan_args()です．第3引数に指定したフォーマットに従い，第4引数以降に指定したVALUEへの参照に値を代入してくれます．</p>

<p>引数の数をチェックするだけならrb_check_arity()が使えます．これは引数をリストとして扱いたいときに便利です．</p>

<p>引数をRubyの配列として受け取るメソッドの例にはThread#initializeがあります．実装はこうです．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_static'>static</span> <span class='const'>VALUE</span>
<span class='id identifier rubyid_thread_initialize'>thread_initialize</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_thread'>thread</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='id identifier rubyid_args'>args</span>)
{
    <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>* ... *</span><span class='regexp_end'>/</span></span>
}</code></pre>

<p>第1引数はself，第2引数はRubyの配列です．</p>

<p>*注意事項*</p>

<p>Rubyと共有はしないがRubyのオブジェクトを格納する可能性のあるCの大域変数は以下の関数を使ってRubyインタプリタに変数の存在を教えてあげてください．でないとGCでトラブルを起こします．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_void'>void</span> <span class='id identifier rubyid_rb_global_variable'>rb_global_variable</span>(<span class='const'>VALUE</span> <span class='op'>*</span><span class='id identifier rubyid_var'>var</span>)</code></pre>

<h3 id="label-extconf.rb-E3-82-92-E7-94-A8-E6-84-8F-E3-81-99-E3-82-8B">extconf.rbを用意する</h3>

<p>Makefileを作る場合の雛型になるextconf.rbというファイルを作ります．extconf.rbはライブラリのコンパイルに必要な条件のチェックなどを行うことが目的です．まず，</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mkmf</span><span class='tstring_end'>&#39;</span></span></code></pre>

<p>をextconf.rbの先頭に置きます．extconf.rbの中では以下のRuby関数を使うことが出来ます．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_have_library'>have_library</span>(<span class='id identifier rubyid_lib'>lib</span><span class='comma'>,</span> <span class='id identifier rubyid_func'>func</span>)<span class='op'>:</span> <span class='id identifier rubyid_ライブラリの存在チェック'>ライブラリの存在チェック</span>
<span class='id identifier rubyid_have_func'>have_func</span>(<span class='id identifier rubyid_func'>func</span><span class='comma'>,</span> <span class='id identifier rubyid_header'>header</span>)<span class='op'>:</span> <span class='id identifier rubyid_関数の存在チェック'>関数の存在チェック</span>
<span class='id identifier rubyid_have_header'>have_header</span>(<span class='id identifier rubyid_header'>header</span>)<span class='op'>:</span> <span class='id identifier rubyid_ヘッダファイルの存在チェック'>ヘッダファイルの存在チェック</span>
<span class='id identifier rubyid_create_makefile'>create_makefile</span>(<span class='id identifier rubyid_target'>target</span>[<span class='comma'>,</span> <span class='id identifier rubyid_target_prefix'>target_prefix</span>])<span class='op'>:</span> <span class='const'>Makefileの生成</span></code></pre>

<p>以下の変数を使うことができます．</p>

<pre class="code ruby"><code class="ruby"><span class='gvar'>$CFLAGS</span><span class='op'>:</span> <span class='id identifier rubyid_コンパイル時に追加的に指定するフラグ'>コンパイル時に追加的に指定するフラグ</span>(<span class='op'>-</span><span class='const'>Oなど</span>)
<span class='gvar'>$CPPFLAGS</span><span class='op'>:</span> <span class='id identifier rubyid_プリプロセッサに追加的に指定するフラグ'>プリプロセッサに追加的に指定するフラグ</span>(<span class='op'>-</span><span class='const'>Iや</span><span class='op'>-</span><span class='const'>Dなど</span>)
<span class='gvar'>$LDFLAGS</span><span class='op'>:</span> <span class='id identifier rubyid_リンク時に追加的に指定するフラグ'>リンク時に追加的に指定するフラグ</span>(<span class='op'>-</span><span class='const'>Lなど</span>)
<span class='gvar'>$objs</span><span class='op'>:</span> <span class='id identifier rubyid_リンクされるオブジェクトファイル名のリスト'>リンクされるオブジェクトファイル名のリスト</span></code></pre>

<p>オブジェクトファイルのリストは，通常はソースファイルを検索して自動的に生成されますが，makeの途中でソースを生成するような場合は明示的に指定する必要があります．</p>

<p>ライブラリをコンパイルする条件が揃わず，そのライブラリをコンパイルしない時にはcreate_makefileを呼ばなければMakefileは生成されず，コンパイルも行われません．</p>

<h3 id="label-depend-E3-82-92-E7-94-A8-E6-84-8F-E3-81-99-E3-82-8B">dependを用意する</h3>

<p>もし，ディレクトリにdependというファイルが存在すれば，Makefileが依存関係をチェックしてくれます．</p>

<pre class="code ruby"><code class="ruby"><span class='tstring'><span class='tstring_beg'>% </span><span class='tstring_content'>gcc</span><span class='tstring_end'> </span></span><span class='op'>-</span><span class='const'>MM</span> <span class='op'>*</span>.<span class='id identifier rubyid_c'>c</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_depend'>depend</span></code></pre>

<p>などで作ることが出来ます．あって損は無いでしょう．</p>

<h3 id="label-Makefile-E3-82-92-E7-94-9F-E6-88-90-E3-81-99-E3-82-8B">Makefileを生成する</h3>

<p>Makefileを実際に生成するためには</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_ruby'>ruby</span> <span class='id identifier rubyid_extconf'>extconf</span>.<span class='id identifier rubyid_rb'>rb</span></code></pre>

<p>とします．extconf.rbに require ‘mkmf’ の行がない場合にはエラーになりますので，引数を追加して</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_ruby'>ruby</span> <span class='op'>-</span><span class='id identifier rubyid_r'>r</span> <span class='id identifier rubyid_mkmf'>mkmf</span> <span class='id identifier rubyid_extconf'>extconf</span>.<span class='id identifier rubyid_rb'>rb</span></code></pre>

<p>としてください．</p>

<p>site_ruby ディレクトリでなく，vendor_ruby ディレクトリにインストールする場合には以下のように –vendor オプションを加えてください．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_ruby'>ruby</span> <span class='id identifier rubyid_extconf'>extconf</span>.<span class='id identifier rubyid_rb'>rb</span> <span class='op'>-</span><span class='op'>-</span><span class='id identifier rubyid_vendor'>vendor</span></code></pre>

<p>ディレクトリをext以下に用意した場合にはRuby全体のmakeの時に自動的にMakefileが生成されますので，このステップは不要です．</p>

<h3 id="label-make-E3-81-99-E3-82-8B">makeする</h3>

<p>動的リンクライブラリを生成する場合にはその場でmakeしてください．必要であれば make install でインストールされます．</p>

<p>ext以下にディレクトリを用意した場合は，Rubyのディレクトリでmakeを実行するとMakefileを生成からmake，必要によってはそのモジュールのRubyへのリンクまで自動的に実行してくれます．extconf.rbを書き換えるなどしてMakefileの再生成が必要な時はまたRubyディレクトリでmakeしてください．</p>

<p>拡張ライブラリはmake installでRubyライブラリのディレクトリの下にコピーされます．もし拡張ライブラリと協調して使うRubyで記述されたプログラムがあり，Rubyライブラリに置きたい場合には，拡張ライブラリ用のディレクトリの下に lib というディレクトリを作り，そこに 拡張子 .rb のファイルを置いておけば同時にインストールされます．</p>

<h3 id="label-E3-83-87-E3-83-90-E3-83-83-E3-82-B0">デバッグ</h3>

<p>まあ，デバッグしないと動かないでしょうね．ext/Setupにディレクトリ名を書くと静的にリンクするのでデバッガが使えるようになります．その分コンパイルが遅くなりますけど．</p>

<h3 id="label-E3-81-A7-E3-81-8D-E3-81-82-E3-81-8C-E3-82-8A">できあがり</h3>

<p>後はこっそり使うなり，広く公開するなり，売るなり，ご自由にお使いください．Rubyの作者は拡張ライブラリに関して一切の権利を主張しません．</p>

<h2 id="label-Appendix+A.+Ruby-E3-81-AE-E3-82-BD-E3-83-BC-E3-82-B9-E3-82-B3-E3-83-BC-E3-83-89-E3-81-AE-E5-88-86-E9-A1-9E">Appendix A. Rubyのソースコードの分類</h2>

<p>Rubyのソースはいくつかに分類することが出来ます．このうちクラスライブラリの部分は基本的に拡張ライブラリと同じ作り方になっています．これらのソースは今までの説明でほとんど理解できると思います．</p>

<h3 id="label-Ruby-E8-A8-80-E8-AA-9E-E3-81-AE-E3-82-B3-E3-82-A2">Ruby言語のコア</h3>
<dl class="rdoc-list note-list"><dt>class.c    
<dd>
<p>クラスとモジュール</p>
</dd><dt>error.c    
<dd>
<p>例外クラスと例外機構</p>
</dd><dt>gc.c       
<dd>
<p>記憶領域管理</p>
</dd><dt>load.c     
<dd>
<p>ライブラリのロード</p>
</dd><dt>object.c   
<dd>
<p>オブジェクト</p>
</dd><dt>variable.c 
<dd>
<p>変数と定数</p>
</dd></dl>

<h3 id="label-Ruby-E3-81-AE-E6-A7-8B-E6-96-87-E8-A7-A3-E6-9E-90-E5-99-A8">Rubyの構文解析器</h3>
<dl class="rdoc-list note-list"><dt>parse.y       
<dd>
<p>字句解析器と構文定義</p>
</dd><dt>parse.c       
<dd>
<p>自動生成</p>
</dd><dt>defs/keywords 
<dd>
<p>予約語</p>
</dd><dt>lex.c         
<dd>
<p>自動生成</p>
</dd></dl>

<h3 id="label-Ruby-E3-81-AE-E8-A9-95-E4-BE-A1-E5-99-A8+-28-E9-80-9A-E7-A7-B0YARV-29">Rubyの評価器 (通称YARV)</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_compile'>compile</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_eval'>eval</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_eval_error'>eval_error</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_eval_jump'>eval_jump</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_eval_safe'>eval_safe</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_insns'>insns</span>.<span class='id identifier rubyid_def'>def</span>           <span class='op'>:</span> <span class='id identifier rubyid_仮想機械語の定義'>仮想機械語の定義</span>
<span class='id identifier rubyid_iseq'>iseq</span>.<span class='id identifier rubyid_c'>c</span>              <span class='op'>:</span> <span class='const'>VM</span><span class='op'>::</span><span class='const'>ISeqの実装</span>
<span class='id identifier rubyid_thread'>thread</span>.<span class='id identifier rubyid_c'>c</span>            <span class='op'>:</span> <span class='id identifier rubyid_スレッド管理とコンテキスト切り替え'>スレッド管理とコンテキスト切り替え</span>
<span class='id identifier rubyid_thread_win32'>thread_win32</span>.<span class='id identifier rubyid_c'>c</span>      <span class='op'>:</span> <span class='id identifier rubyid_スレッド実装'>スレッド実装</span>
<span class='id identifier rubyid_thread_pthread'>thread_pthread</span>.<span class='id identifier rubyid_c'>c</span>    <span class='op'>:</span> <span class='id identifier rubyid_同上'>同上</span>
<span class='id identifier rubyid_vm'>vm</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_vm_dump'>vm_dump</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_vm_eval'>vm_eval</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_vm_exec'>vm_exec</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_vm_insnhelper'>vm_insnhelper</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_vm_method'>vm_method</span>.<span class='id identifier rubyid_c'>c</span>

<span class='id identifier rubyid_defs'>defs</span><span class='op'>/</span><span class='id identifier rubyid_opt_insns_unif'>opt_insns_unif</span>.<span class='id identifier rubyid_def'>def</span>  <span class='op'>:</span> <span class='id identifier rubyid_命令融合'>命令融合</span>
<span class='id identifier rubyid_defs'>defs</span><span class='op'>/</span><span class='id identifier rubyid_opt_operand'>opt_operand</span>.<span class='id identifier rubyid_def'>def</span>     <span class='op'>:</span> <span class='id identifier rubyid_最適化のための定義'>最適化のための定義</span>

  <span class='comment'>#=&gt; insn*.inc           : 自動生成
</span>  <span class='comment'>#=&gt; opt*.inc            : 自動生成
</span>  <span class='comment'>#=&gt; vm.inc              : 自動生成</span></code></pre>

<h3 id="label-E6-AD-A3-E8-A6-8F-E8-A1-A8-E7-8F-BE-E3-82-A8-E3-83-B3-E3-82-B8-E3-83-B3+-28-E9-AC-BC-E9-9B-B2-29">正規表現エンジン (鬼雲)</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_regcomp'>regcomp</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_regenc'>regenc</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_regerror'>regerror</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_regexec'>regexec</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_regparse'>regparse</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_regsyntax'>regsyntax</span>.<span class='id identifier rubyid_c'>c</span></code></pre>

<h3 id="label-E3-83-A6-E3-83-BC-E3-83-86-E3-82-A3-E3-83-AA-E3-83-86-E3-82-A3-E9-96-A2-E6-95-B0">ユーティリティ関数</h3>
<dl class="rdoc-list note-list"><dt>debug.c    
<dd>
<p>Cデバッガ用のデバッグシンボル</p>
</dd><dt>dln.c      
<dd>
<p>動的ローディング</p>
</dd><dt>st.c       
<dd>
<p>汎用ハッシュ表</p>
</dd><dt>strftime.c 
<dd>
<p>時刻整形</p>
</dd><dt>util.c     
<dd>
<p>その他のユーティリティ</p>
</dd></dl>

<h3 id="label-Ruby-E3-82-B3-E3-83-9E-E3-83-B3-E3-83-89-E3-81-AE-E5-AE-9F-E8-A3-85">Rubyコマンドの実装</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_dmyext'>dmyext</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_dmydln'>dmydln</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_dmyencoding'>dmyencoding</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_id'>id</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_inits'>inits</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_main'>main</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_ruby'>ruby</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_version'>version</span>.<span class='id identifier rubyid_c'>c</span>

<span class='id identifier rubyid_gem_prelude'>gem_prelude</span>.<span class='id identifier rubyid_rb'>rb</span>
<span class='id identifier rubyid_prelude'>prelude</span>.<span class='id identifier rubyid_rb'>rb</span></code></pre>

<h3 id="label-E3-82-AF-E3-83-A9-E3-82-B9-E3-83-A9-E3-82-A4-E3-83-96-E3-83-A9-E3-83-AA">クラスライブラリ</h3>
<dl class="rdoc-list note-list"><dt>array.c      
<dd>
<p>Array</p>
</dd><dt>bignum.c     
<dd>
<p>Bignum</p>
</dd><dt>compar.c     
<dd>
<p>Comparable</p>
</dd><dt>complex.c    
<dd>
<p>Complex</p>
</dd><dt>cont.c       
<dd>
<p>Fiber, Continuation</p>
</dd><dt>dir.c        
<dd>
<p>Dir</p>
</dd><dt>enum.c       
<dd>
<p>Enumerable</p>
</dd><dt>enumerator.c 
<dd>
<p>Enumerator</p>
</dd><dt>file.c       
<dd>
<p>File</p>
</dd><dt>hash.c       
<dd>
<p>Hash</p>
</dd><dt>io.c         
<dd>
<p>IO</p>
</dd><dt>marshal.c    
<dd>
<p>Marshal</p>
</dd><dt>math.c       
<dd>
<p>Math</p>
</dd><dt>numeric.c    
<dd>
<p>Numeric, Integer, Fixnum, Float</p>
</dd><dt>pack.c       
<dd>
<p>Array#pack, String#unpack</p>
</dd><dt>proc.c       
<dd>
<p>Binding, Proc</p>
</dd><dt>process.c    
<dd>
<p>Process</p>
</dd><dt>random.c     
<dd>
<p>乱数</p>
</dd><dt>range.c      
<dd>
<p>Range</p>
</dd><dt>rational.c   
<dd>
<p>Rational</p>
</dd><dt>re.c         
<dd>
<p>Regexp, MatchData</p>
</dd><dt>signal.c     
<dd>
<p>Signal</p>
</dd><dt>sprintf.c    
<dd>
<p>String#sprintf</p>
</dd><dt>string.c     
<dd>
<p>String</p>
</dd><dt>struct.c     
<dd>
<p>Struct</p>
</dd><dt>time.c       
<dd>
<p>Time</p>
</dd><dt>defs/known_errors.def 
<dd>
<p>例外クラス Errno::*</p>
</dd><dt>-&gt; known_errors.inc   
<dd>
<p>自動生成</p>
</dd></dl>

<h3 id="label-E5-A4-9A-E8-A8-80-E8-AA-9E-E5-8C-96">多言語化</h3>
<dl class="rdoc-list note-list"><dt>encoding.c  
<dd>
<p>Encoding</p>
</dd><dt>transcode.c 
<dd>
<p>Encoding::Converter</p>
</dd><dt>enc/*.c     
<dd>
<p>エンコーディングクラス群</p>
</dd><dt>enc/trans/* 
<dd>
<p>コードポイント対応表</p>
</dd></dl>

<h3 id="label-goruby-E3-82-B3-E3-83-9E-E3-83-B3-E3-83-89-E3-81-AE-E5-AE-9F-E8-A3-85">gorubyコマンドの実装</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_goruby'>goruby</span>.<span class='id identifier rubyid_c'>c</span>
<span class='id identifier rubyid_golf_prelude'>golf_prelude</span>.<span class='id identifier rubyid_rb'>rb</span>      <span class='op'>:</span> <span class='id identifier rubyid_goruby固有のライブラリ'>goruby固有のライブラリ</span>
  <span class='comment'>#=&gt; golf_prelude.c  : 自動生成</span></code></pre>

<h2 id="label-Appendix+B.+-E6-8B-A1-E5-BC-B5-E7-94-A8-E9-96-A2-E6-95-B0-E3-83-AA-E3-83-95-E3-82-A1-E3-83-AC-E3-83-B3-E3-82-B9">Appendix B. 拡張用関数リファレンス</h2>

<p>C言語からRubyの機能を利用するAPIは以下の通りである．</p>

<h3 id="label-E5-9E-8B">型</h3>
<dl class="rdoc-list note-list"><dt>VALUE 
<dd>
<p>Rubyオブジェクトを表現する型．必要に応じてキャストして用いる．組み込み型を表現するCの型はruby.hに記述してあるRで始まる構造体である．VALUE型をこれらにキャストするためにRで始まる構造体名を全て大文字にした名前のマクロが用意されている．</p>
</dd></dl>

<h3 id="label-E5-A4-89-E6-95-B0-E3-83-BB-E5-AE-9A-E6-95-B0">変数・定数</h3>
<dl class="rdoc-list note-list"><dt>Qnil 
<dd>
<p>定数: nilオブジェクト</p>
</dd><dt>Qtrue 
<dd>
<p>定数: trueオブジェクト(真のデフォルト値)</p>
</dd><dt>Qfalse 
<dd>
<p>定数: falseオブジェクト</p>
</dd></dl>

<h3 id="label-C-E3-83-87-E3-83-BC-E3-82-BF-E3-81-AE-E3-82-AB-E3-83-97-E3-82-BB-E3-83-AB-E5-8C-96">Cデータのカプセル化</h3>
<dl class="rdoc-list note-list"><dt>Data_Wrap_Struct(VALUE klass, void (*mark)(), void (*free)(), void *sval) 
<dd>
<p>Cの任意のポインタをカプセル化したRubyオブジェクトを返す．このポインタがRubyからアクセスされなくなった時，freeで指定した関数が呼ばれる．また，このポインタの指すデータが他のRubyオブジェクトを指している場合，markに指定する関数でマークする必要がある．</p>
</dd><dt>Data_Make_Struct(klass, type, mark, free, sval) 
<dd>
<p>type型のメモリをmallocし，変数svalに代入した後，それをカプセル化したデータを返すマクロ．</p>
</dd><dt>Data_Get_Struct(data, type, sval) 
<dd>
<p>dataからtype型のポインタを取り出し変数svalに代入するマクロ．</p>
</dd></dl>

<h3 id="label-E5-9E-8B-E3-83-81-E3-82-A7-E3-83-83-E3-82-AF">型チェック</h3>

<pre class="code ruby"><code class="ruby"><span class='const'>RB_TYPE_P</span>(<span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_type'>type</span>)
<span class='const'>TYPE</span>(<span class='id identifier rubyid_value'>value</span>)
<span class='const'>FIXNUM_P</span>(<span class='id identifier rubyid_value'>value</span>)
<span class='const'>NIL_P</span>(<span class='id identifier rubyid_value'>value</span>)
<span class='const'>RB_INTEGER_TYPE_P</span>(<span class='id identifier rubyid_value'>value</span>)
<span class='const'>RB_FLOAT_TYPE_P</span>(<span class='id identifier rubyid_value'>value</span>)
<span class='id identifier rubyid_void'>void</span> <span class='const'>Check_Type</span>(<span class='const'>VALUE</span> <span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_int'>int</span> <span class='id identifier rubyid_type'>type</span>)</code></pre>

<h3 id="label-E5-9E-8B-E5-A4-89-E6-8F-9B">型変換</h3>

<pre class="code ruby"><code class="ruby"><span class='const'>FIX2INT</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>INT2FIX</span>(<span class='id identifier rubyid_i'>i</span>)
<span class='const'>FIX2LONG</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>LONG2FIX</span>(<span class='id identifier rubyid_l'>l</span>)
<span class='const'>NUM2INT</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>INT2NUM</span>(<span class='id identifier rubyid_i'>i</span>)
<span class='const'>NUM2UINT</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>UINT2NUM</span>(<span class='id identifier rubyid_ui'>ui</span>)
<span class='const'>NUM2LONG</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>LONG2NUM</span>(<span class='id identifier rubyid_l'>l</span>)
<span class='const'>NUM2ULONG</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>ULONG2NUM</span>(<span class='id identifier rubyid_ul'>ul</span>)
<span class='const'>NUM2LL</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>LL2NUM</span>(<span class='id identifier rubyid_ll'>ll</span>)
<span class='const'>NUM2ULL</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>ULL2NUM</span>(<span class='id identifier rubyid_ull'>ull</span>)
<span class='const'>NUM2OFFT</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>OFFT2NUM</span>(<span class='id identifier rubyid_off'>off</span>)
<span class='const'>NUM2SIZET</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>SIZET2NUM</span>(<span class='id identifier rubyid_size'>size</span>)
<span class='const'>NUM2SSIZET</span>(<span class='id identifier rubyid_value'>value</span>)<span class='comma'>,</span> <span class='const'>SSIZET2NUM</span>(<span class='id identifier rubyid_ssize'>ssize</span>)
<span class='id identifier rubyid_rb_integer_pack'>rb_integer_pack</span>(<span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_words'>words</span><span class='comma'>,</span> <span class='id identifier rubyid_numwords'>numwords</span><span class='comma'>,</span> <span class='id identifier rubyid_wordsize'>wordsize</span><span class='comma'>,</span> <span class='id identifier rubyid_nails'>nails</span><span class='comma'>,</span> <span class='id identifier rubyid_flags'>flags</span>)<span class='comma'>,</span> <span class='id identifier rubyid_rb_integer_unpack'>rb_integer_unpack</span>(<span class='id identifier rubyid_words'>words</span><span class='comma'>,</span> <span class='id identifier rubyid_numwords'>numwords</span><span class='comma'>,</span> <span class='id identifier rubyid_wordsize'>wordsize</span><span class='comma'>,</span> <span class='id identifier rubyid_nails'>nails</span><span class='comma'>,</span> <span class='id identifier rubyid_flags'>flags</span>)
<span class='const'>NUM2DBL</span>(<span class='id identifier rubyid_value'>value</span>)
<span class='id identifier rubyid_rb_float_new'>rb_float_new</span>(<span class='id identifier rubyid_f'>f</span>)
<span class='const'>RSTRING_LEN</span>(<span class='id identifier rubyid_str'>str</span>)
<span class='const'>RSTRING_PTR</span>(<span class='id identifier rubyid_str'>str</span>)
<span class='const'>StringValue</span>(<span class='id identifier rubyid_value'>value</span>)
<span class='const'>StringValuePtr</span>(<span class='id identifier rubyid_value'>value</span>)
<span class='const'>StringValueCStr</span>(<span class='id identifier rubyid_value'>value</span>)
<span class='id identifier rubyid_rb_str_new2'>rb_str_new2</span>(<span class='id identifier rubyid_s'>s</span>)</code></pre>

<h3 id="label-E3-82-AF-E3-83-A9-E3-82-B9-2F-E3-83-A2-E3-82-B8-E3-83-A5-E3-83-BC-E3-83-AB-E5-AE-9A-E7-BE-A9">クラス/モジュール定義</h3>
<dl class="rdoc-list note-list"><dt>VALUE rb_define_class(const char *name, VALUE super) 
<dd>
<p>superのサブクラスとして新しいRubyクラスを定義する．</p>
</dd><dt>VALUE rb_define_class_under(VALUE module, const char *name, VALUE super) 
<dd>
<p>superのサブクラスとして新しいRubyクラスを定義し，moduleの定数として定義する．</p>
</dd><dt>VALUE rb_define_module(const char *name) 
<dd>
<p>新しいRubyモジュールを定義する．</p>
</dd><dt>VALUE rb_define_module_under(VALUE module, const char *name) 
<dd>
<p>新しいRubyモジュールを定義し，moduleの定数として定義する．</p>
</dd><dt>void rb_include_module(VALUE klass, VALUE module) 
<dd>
<p>モジュールをインクルードする．classがすでにmoduleをインクルードしている時には何もしない(多重インクルードの禁止)．</p>
</dd><dt>void rb_extend_object(VALUE object, VALUE module) 
<dd>
<p>オブジェクトをモジュール(で定義されているメソッド)で拡張する．</p>
</dd></dl>

<h3 id="label-E5-A4-A7-E5-9F-9F-E5-A4-89-E6-95-B0-E5-AE-9A-E7-BE-A9">大域変数定義</h3>
<dl class="rdoc-list note-list"><dt>void rb_define_variable(const char *name, VALUE *var) 
<dd>
<p>RubyとCとで共有するグローバル変数を定義する．変数名が‘$’で始まらない時には自動的に追加される．nameとしてRubyの識別子として許されない文字(例えば‘ ’)を含む場合にはRubyプログラムからは見えなくなる．</p>
</dd><dt>void rb_define_readonly_variable(const char *name, VALUE *var) 
<dd>
<p>RubyとCとで共有するread onlyのグローバル変数を定義する．read onlyであること以外はrb_define_variable()と同じ．</p>
</dd><dt>void rb_define_virtual_variable(const char *name, VALUE (*getter)(), void (*setter)()) 
<dd>
<p>関数によって実現されるRuby変数を定義する．変数が参照された時にはgetterが，変数に値がセットされた時にはsetterが呼ばれる．</p>
</dd><dt>void rb_define_hooked_variable(const char *name, VALUE *var, VALUE (*getter)(), void (*setter)()) 
<dd>
<p>関数によってhookのつけられたグローバル変数を定義する．変数が参照された時にはgetterが，関数に値がセットされた時にはsetterが呼ばれる．getterやsetterに0を指定した時にはhookを指定しないのと同じ事になる．</p>
</dd><dt>void rb_global_variable(VALUE *var) 
<dd>
<p>マークする必要のあるRubyオブジェクトを含む大域変数を，GC によって解放されないように保護する．</p>
</dd><dt>void rb_gc_register_mark_object(VALUE object) 
<dd>
<p>マークする必要のあるRubyオブジェクトを，GCによって解放されないように登録する．</p>
</dd></dl>

<h3 id="label-E5-AE-9A-E6-95-B0">定数</h3>
<dl class="rdoc-list note-list"><dt>void rb_define_const(VALUE klass, const char *name, VALUE val) 
<dd>
<p>定数を定義する．</p>
</dd><dt>void rb_define_global_const(const char *name, VALUE val) 
<dd>
<p>大域定数を定義する．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_rb_define_const'>rb_define_const</span>(<span class='id identifier rubyid_rb_cObject'>rb_cObject</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_val'>val</span>)</code></pre>

<p>と同じ意味．</p>
</dd></dl>

<h3 id="label-E3-83-A1-E3-82-BD-E3-83-83-E3-83-89-E5-AE-9A-E7-BE-A9">メソッド定義</h3>
<dl class="rdoc-list note-list"><dt>rb_define_method(VALUE klass, const char *name, VALUE (*func)(ANYARGS), int argc) 
<dd>
<p>メソッドを定義する．argcはselfを除く引数の数．argcが-1の時, 関数には引数の数(selfを含まない)を第1引数, 引数の配列を第2 引数とする形式で与えられる(第3引数はself)．argcが-2の時, 第1引数がself, 第2引数がargs(argsは引数を含むRubyの配列)という形式で与えられる．</p>
</dd><dt>rb_define_private_method(VALUE klass, const char *name, VALUE (*func)(ANYARGS), int argc) 
<dd>
<p>privateメソッドを定義する．引数はrb_define_method()と同じ．</p>
</dd><dt>rb_define_singleton_method(VALUE klass, const char *name, VALUE (*func)(ANYARGS), int argc) 
<dd>
<p>特異メソッドを定義する．引数はrb_define_method()と同じ．</p>
</dd><dt>rb_check_arity(int argc, int min, int max) 
<dd>
<p>引数の数であるargcがmin..maxの範囲に入っているかをチェックします．もしmaxがUNLIMITED_ARGUMENTSなら，上限はチェックしません．もしargcが範囲外ならArgumentErrorが発生します．</p>
</dd><dt>rb_scan_args(int argc, VALUE *argv, const char *fmt, …) 
<dd>
<p>argc, argv形式で与えられた指定されたフォーマットに従って引数を分解し，続くVALUEへの参照にセットします．このフォーマットは，ABNFで記述すると以下の通りです．</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_scan'>scan</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span>  <span class='symbeg'>:</span><span class='op'>=</span> <span class='id identifier rubyid_param'>param</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span> [<span class='id identifier rubyid_option'>option</span><span class='op'>-</span><span class='id identifier rubyid_hash'>hash</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span>] [<span class='id identifier rubyid_block'>block</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span>]

<span class='id identifier rubyid_param'>param</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span> <span class='symbeg'>:</span><span class='op'>=</span> <span class='id identifier rubyid_pre'>pre</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span> [<span class='id identifier rubyid_post'>post</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span>] <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'> post-arg-spec </span><span class='regexp_end'>/</span></span>
                  <span class='id identifier rubyid_pre'>pre</span><span class='op'>-</span><span class='id identifier rubyid_opt'>opt</span><span class='op'>-</span><span class='id identifier rubyid_post'>post</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span>
<span class='id identifier rubyid_pre'>pre</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span>   <span class='symbeg'>:</span><span class='op'>=</span> <span class='id identifier rubyid_num'>num</span><span class='op'>-</span><span class='id identifier rubyid_of'>of</span><span class='op'>-</span><span class='id identifier rubyid_leading'>leading</span><span class='op'>-</span><span class='id identifier rubyid_mandatory'>mandatory</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span> [<span class='id identifier rubyid_num'>num</span><span class='op'>-</span><span class='id identifier rubyid_of'>of</span><span class='op'>-</span><span class='id identifier rubyid_optional'>optional</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span>]
<span class='id identifier rubyid_post'>post</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span>  <span class='symbeg'>:</span><span class='op'>=</span> <span class='id identifier rubyid_sym'>sym</span><span class='op'>-</span><span class='kw'>for</span><span class='op'>-</span><span class='id identifier rubyid_variable'>variable</span><span class='op'>-</span><span class='id identifier rubyid_length'>length</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span>
                  [<span class='id identifier rubyid_num'>num</span><span class='op'>-</span><span class='id identifier rubyid_of'>of</span><span class='op'>-</span><span class='id identifier rubyid_trailing'>trailing</span><span class='op'>-</span><span class='id identifier rubyid_mandatory'>mandatory</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span>]
<span class='id identifier rubyid_pre'>pre</span><span class='op'>-</span><span class='id identifier rubyid_opt'>opt</span><span class='op'>-</span><span class='id identifier rubyid_post'>post</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span> <span class='symbeg'>:</span><span class='op'>=</span> <span class='id identifier rubyid_num'>num</span><span class='op'>-</span><span class='id identifier rubyid_of'>of</span><span class='op'>-</span><span class='id identifier rubyid_leading'>leading</span><span class='op'>-</span><span class='id identifier rubyid_mandatory'>mandatory</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span> <span class='id identifier rubyid_num'>num</span><span class='op'>-</span><span class='id identifier rubyid_of'>of</span><span class='op'>-</span><span class='id identifier rubyid_optional'>optional</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span>
                         <span class='id identifier rubyid_num'>num</span><span class='op'>-</span><span class='id identifier rubyid_of'>of</span><span class='op'>-</span><span class='id identifier rubyid_trailing'>trailing</span><span class='op'>-</span><span class='id identifier rubyid_mandatory'>mandatory</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span>
<span class='id identifier rubyid_option'>option</span><span class='op'>-</span><span class='id identifier rubyid_hash'>hash</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span> <span class='symbeg'>:</span><span class='op'>=</span> <span class='id identifier rubyid_sym'>sym</span><span class='op'>-</span><span class='kw'>for</span><span class='op'>-</span><span class='id identifier rubyid_option'>option</span><span class='op'>-</span><span class='id identifier rubyid_hash'>hash</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span>
<span class='id identifier rubyid_block'>block</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>-</span><span class='id identifier rubyid_spec'>spec</span> <span class='symbeg'>:</span><span class='op'>=</span> <span class='id identifier rubyid_sym'>sym</span><span class='op'>-</span><span class='kw'>for</span><span class='op'>-</span><span class='id identifier rubyid_block'>block</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span>

<span class='id identifier rubyid_num'>num</span><span class='op'>-</span><span class='id identifier rubyid_of'>of</span><span class='op'>-</span><span class='id identifier rubyid_leading'>leading</span><span class='op'>-</span><span class='id identifier rubyid_mandatory'>mandatory</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span>  <span class='symbeg'>:</span><span class='op'>=</span> <span class='const'>DIGIT</span> <span class='semicolon'>;</span> <span class='id identifier rubyid_先頭に置かれる省略不能な引数の数'>先頭に置かれる省略不能な引数の数</span>
<span class='id identifier rubyid_num'>num</span><span class='op'>-</span><span class='id identifier rubyid_of'>of</span><span class='op'>-</span><span class='id identifier rubyid_optional'>optional</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span>           <span class='symbeg'>:</span><span class='op'>=</span> <span class='const'>DIGIT</span> <span class='semicolon'>;</span> <span class='id identifier rubyid_続いて置かれる省略可能な引数の数'>続いて置かれる省略可能な引数の数</span>
<span class='id identifier rubyid_sym'>sym</span><span class='op'>-</span><span class='kw'>for</span><span class='op'>-</span><span class='id identifier rubyid_variable'>variable</span><span class='op'>-</span><span class='id identifier rubyid_length'>length</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span>   <span class='symbeg'>:</span><span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*</span><span class='tstring_end'>&quot;</span></span>   <span class='semicolon'>;</span> <span class='id identifier rubyid_続いて置かれる可変長引数を'>続いて置かれる可変長引数を</span>
                                        <span class='semicolon'>;</span> <span class='const'>Rubyの配列で取得するための指定</span>
<span class='id identifier rubyid_num'>num</span><span class='op'>-</span><span class='id identifier rubyid_of'>of</span><span class='op'>-</span><span class='id identifier rubyid_trailing'>trailing</span><span class='op'>-</span><span class='id identifier rubyid_mandatory'>mandatory</span><span class='op'>-</span><span class='id identifier rubyid_args'>args</span> <span class='symbeg'>:</span><span class='op'>=</span> <span class='const'>DIGIT</span> <span class='semicolon'>;</span> <span class='id identifier rubyid_終端に置かれる省略不能な引数の数'>終端に置かれる省略不能な引数の数</span>
<span class='id identifier rubyid_sym'>sym</span><span class='op'>-</span><span class='kw'>for</span><span class='op'>-</span><span class='id identifier rubyid_option'>option</span><span class='op'>-</span><span class='id identifier rubyid_hash'>hash</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span>        <span class='symbeg'>:</span><span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span>   <span class='semicolon'>;</span> <span class='id identifier rubyid_オプションハッシュを取得する'>オプションハッシュを取得する</span>
                                        <span class='semicolon'>;</span> <span class='id identifier rubyid_ための指定'>ための指定</span><span class='semicolon'>;</span> <span class='id identifier rubyid_省略不能な引数の'>省略不能な引数の</span>
                                        <span class='semicolon'>;</span> <span class='id identifier rubyid_数よりも多くの引数が指定され，'>数よりも多くの引数が指定され，</span>
                                        <span class='semicolon'>;</span> <span class='id identifier rubyid_最後の引数がハッシュ（または'>最後の引数がハッシュ（または</span>
                                        <span class='semicolon'>;</span> <span class='comment'>#to_hashで変換可能）の場合に
</span>                                        <span class='semicolon'>;</span> <span class='id identifier rubyid_取得される．最後の引数がnilの'>取得される．最後の引数がnilの</span>
                                        <span class='semicolon'>;</span> <span class='id identifier rubyid_場合，可変長引数指定がなく，'>場合，可変長引数指定がなく，</span>
                                        <span class='semicolon'>;</span> <span class='id identifier rubyid_省略不能引数の数よりも多くの'>省略不能引数の数よりも多くの</span>
                                        <span class='semicolon'>;</span> <span class='id identifier rubyid_引数が指定された場合に取得される'>引数が指定された場合に取得される</span>
<span class='id identifier rubyid_sym'>sym</span><span class='op'>-</span><span class='kw'>for</span><span class='op'>-</span><span class='id identifier rubyid_block'>block</span><span class='op'>-</span><span class='id identifier rubyid_arg'>arg</span>              <span class='symbeg'>:</span><span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&amp;</span><span class='tstring_end'>&quot;</span></span>   <span class='semicolon'>;</span> <span class='id identifier rubyid_イテレータブロックを取得するための'>イテレータブロックを取得するための</span>
                                        <span class='semicolon'>;</span> <span class='id identifier rubyid_指定'>指定</span></code></pre>

<p>フォーマットが“12”の場合，引数は最低1つで，3つ(1+2)まで許されるという意味になります．従って，フォーマット文字列に続いて3つのVALUEへの参照を置く必要があります．それらには取得した変数がセットされます．変数への参照の代わりにNULLを指定することもでき，その場合は取得した引数の値は捨てられます．なお，省略可能引数が省略された時の変数の値はnil(C言語のレベルではQnil)になります．</p>

<p>返り値は与えられた引数の数です．オプションハッシュおよびイテレータブロックは数えません．</p>
</dd><dt>int rb_get_kwargs(VALUE keyword_hash, const ID *table, int required, int optional, VALUE *values) 
<dd>
<p>キーワードで指定された値をtableにしたがって取り出します．tableの最初のrequired個のIDは必須キーワードを表し，続くoptional (optionalが負の場合は-optional-1) 個のIDは省略可能キーワードです．必須キーワードがkeyword_hash中にない場合，“missing keyword”ArgumentErrorが発生します．省略可能キーワードがない場合は，values中の対応する要素にはQundefがセットされます．keyword_hashに使用されない要素がある場合は，optionalが負なら無視されますが，そうでなければ“unknown keyword” ArgumentErrorが発生します．</p>
</dd><dt>VALUE rb_extract_keywords(VALUE *original_hash) 
<dd>
<p>original_hashで参照されるHashオブジェクトから，Symbolであるキーとその値を新しいHashに取り出します．original_hashの指す先には，元のHashがSymbol以外のキーを含んでいた場合はそれらがコピーされた別の新しいHash，そうでなければ0が保存されます．</p>
</dd></dl>

<h3 id="label-Ruby-E3-83-A1-E3-82-BD-E3-83-83-E3-83-89-E5-91-BC-E3-81-B3-E5-87-BA-E3-81-97">Rubyメソッド呼び出し</h3>
<dl class="rdoc-list note-list"><dt>VALUE rb_funcall(VALUE recv, ID mid, int narg, …) 
<dd>
<p>メソッド呼び出し．文字列からmidを得るためにはrb_intern()を使う．private/protectedなメソッドでも呼び出せる．</p>
</dd><dt>VALUE rb_funcall2(VALUE recv, ID mid, int argc, VALUE *argv) 
<dt>VALUE rb_funcallv(VALUE recv, ID mid, int argc, VALUE *argv) 
<dd>
<p>メソッド呼び出し．引数をargc, argv形式で渡す．private/protectedなメソッドでも呼び出せる．</p>
</dd><dt>VALUE rb_funcallv_public(VALUE recv, ID mid, int argc, VALUE *argv) 
<dd>
<p>メソッド呼び出し．publicなメソッドしか呼べない．</p>
</dd><dt>VALUE rb_eval_string(const char *str) 
<dd>
<p>文字列をRubyスクリプトとしてコンパイル・実行する．</p>
</dd><dt>ID rb_intern(const char *name) 
<dd>
<p>文字列に対応するIDを返す．</p>
</dd><dt>char *rb_id2name(ID id) 
<dd>
<p>IDに対応する文字列を返す(デバッグ用)．</p>
</dd><dt>char *rb_class2name(VALUE klass) 
<dd>
<p>クラスの名前を返す(デバッグ用)．クラスが名前を持たない時には, 祖先を遡って名前を持つクラスの名前を返す．</p>
</dd><dt>int rb_respond_to(VALUE obj, ID id) 
<dd>
<p>objがidで示されるメソッドを持つかどうかを返す．</p>
</dd></dl>

<h3 id="label-E3-82-A4-E3-83-B3-E3-82-B9-E3-82-BF-E3-83-B3-E3-82-B9-E5-A4-89-E6-95-B0">インスタンス変数</h3>
<dl class="rdoc-list note-list"><dt>VALUE rb_iv_get(VALUE obj, const char *name) 
<dd>
<p>objのインスタンス変数の値を得る．‘@’で始まらないインスタンス変数は Rubyプログラムからアクセスできない「隠れた」インスタンス変数になる．定数は大文字の名前を持つクラス(またはモジュール)のインスタンス変数として実装されている．</p>
</dd><dt>VALUE rb_iv_set(VALUE obj, const char *name, VALUE val) 
<dd>
<p>objのインスタンス変数をvalにセットする．</p>
</dd></dl>

<h3 id="label-E5-88-B6-E5-BE-A1-E6-A7-8B-E9-80-A0">制御構造</h3>
<dl class="rdoc-list note-list"><dt>VALUE rb_block_call(VALUE obj, ID mid, int argc, VALUE * argv, VALUE (*func) (ANYARGS), VALUE data2) 
<dd>
<p>funcをブロックとして設定し，objをレシーバ，argcとargvを引数としてmidメソッドを呼び出す．funcは第一引数にyieldされた値，第二引数にdata2を受け取る．複数の値がyieldされた場合(Cではrb_yield_values()とrb_yield_values2(), rb_yield_splat())，data2はArrayとしてパックされている．第三, 第四引数のargcとargvによってyieldされた値を取り出すことができる．</p>
</dd><dt>[OBSOLETE] VALUE rb_iterate(VALUE (*func1)(), VALUE arg1, VALUE (*func2)(), VALUE arg2) 
<dd>
<p>func2をブロックとして設定し, func1をイテレータとして呼ぶ．func1には arg1が引数として渡され, func2には第1引数にイテレータから与えられた値, 第2引数にarg2が渡される．</p>

<p>1.9でrb_iterateを使う場合は, func1の中でRubyレベルのメソッドを呼び出さなければならない. 1.9でobsoleteとなった. 代わりにrb_block_callが用意された.</p>
</dd><dt>VALUE rb_yield(VALUE val) 
<dd>
<p>valを値としてイテレータブロックを呼び出す．</p>
</dd><dt>VALUE rb_rescue(VALUE (*func1)(ANYARGS), VALUE arg1, VALUE (*func2)(ANYARGS), VALUE arg2) 
<dd>
<p>関数func1をarg1を引数に呼び出す．func1の実行中に例外が発生した時には func2をarg2を第一引数, 発生した例外オブジェクトを第二引数として呼ぶ．戻り値は例外が発生しなかった時はfunc1 の戻り値, 例外が発生した時にはfunc2の戻り値である．</p>
</dd><dt>VALUE rb_ensure(VALUE (*func1)(ANYARGS), VALUE arg1, VALUE (*func2)(ANYARGS), VALUE arg2) 
<dd>
<p>関数func1をarg1を引数として実行し, 実行終了後(たとえ例外が発生しても) func2をarg2を引数として実行する．戻り値はfunc1 の戻り値である(例外が発生した時は戻らない)．</p>
</dd><dt>VALUE rb_protect(VALUE (*func) (VALUE), VALUE arg, int *state) 
<dd>
<p>関数funcをargを引数として実行し, 例外が発生しなければその戻り値を返す．例外が発生した場合は, *stateに非0をセットしてQnilを返す．rb_jump_tag()を呼ばずに捕捉した例外を無視する場合には，rb_set_errinfo(Qnil)でエラー情報をクリアしなければならない．</p>
</dd><dt>void rb_jump_tag(int state) 
<dd>
<p>rb_protect()やrb_eval_string_protect()で捕捉された例外を再送する．stateはそれらの関数から返された値でなければならない．この関数は直接の呼び出し元に戻らない．</p>
</dd><dt>void rb_iter_break() 
<dd>
<p>現在の最も内側のブロックを終了する．この関数は直接の呼び出し元に戻らない．</p>
</dd><dt>void rb_iter_break_value(VALUE value) 
<dd>
<p>現在の最も内側のブロックをvalueで終了する．ブロックは引数で与えられたvalueを返す．この関数は直接の呼び出し元に戻らない．</p>
</dd></dl>

<h3 id="label-E4-BE-8B-E5-A4-96-E3-83-BB-E3-82-A8-E3-83-A9-E3-83-BC">例外・エラー</h3>
<dl class="rdoc-list note-list"><dt>void rb_warning(const char *fmt, …) 
<dd>
<p>rb_verbose時に標準エラー出力に警告情報を表示する．引数はprintf()と同じ．</p>
</dd><dt>void rb_raise(rb_eRuntimeError, const char *fmt, …) 
<dd>
<p>RuntimeError例外を発生させる．引数はprintf()と同じ．</p>
</dd><dt>void rb_raise(VALUE exception, const char *fmt, …) 
<dd>
<p>exceptionで指定した例外を発生させる．fmt以下の引数はprintf()と同じ．</p>
</dd><dt>void rb_fatal(const char *fmt, …) 
<dd>
<p>致命的例外を発生させる．通常の例外処理は行なわれず, インタープリタが終了する(ただしensureで指定されたコードは終了前に実行される)．</p>
</dd><dt>void rb_bug(const char *fmt, …) 
<dd>
<p>インタープリタなどプログラムのバグでしか発生するはずのない状況の時呼ぶ．インタープリタはコアダンプし直ちに終了する．例外処理は一切行なわれない．</p>
</dd></dl>

<p>注意: “%”PRIsVALUEがObject#to_s(‘+’フラグが指定されているときはObject#inspect)を使ったVALUEの出力に利用できる．これは“%i”と衝突するため，整数には“%d”を使用すること．</p>

<h3 id="label-Ruby-E3-81-AE-E5-88-9D-E6-9C-9F-E5-8C-96-E3-83-BB-E5-AE-9F-E8-A1-8C">Rubyの初期化・実行</h3>

<p>Rubyをアプリケーションに埋め込む場合には以下のインタフェースを使う．通常の拡張ライブラリには必要ない．</p>
<dl class="rdoc-list note-list"><dt>void ruby_init() 
<dd>
<p>Rubyインタプリタの初期化を行なう．</p>
</dd><dt>void *ruby_options(int argc, char **argv) 
<dd>
<p>Rubyインタプリタのコマンドライン引数の処理を行ない，Rubyのソースコードをコンパイルする．コンパイルされたソースへのポインタ，もしくは特殊値を返す.</p>
</dd><dt>int ruby_run_node(void *n) 
<dd>
<p>コンパイルされたコードを実行する．実行に成功した場合はEXIT_SUCCESSを，エラーが起こったときはそれ以外を返す．</p>
</dd><dt>void ruby_script(char *name) 
<dd>
<p>Rubyのスクリプト名($0)を設定する．</p>
</dd></dl>

<h3 id="label-E3-82-A4-E3-83-B3-E3-82-BF-E3-83-97-E3-83-AA-E3-82-BF-E3-81-AE-E3-82-A4-E3-83-99-E3-83-B3-E3-83-88-E3-81-AE-E3-83-95-E3-83-83-E3-82-AF">インタプリタのイベントのフック</h3>
<dl class="rdoc-list note-list"><dt>void rb_add_event_hook(rb_event_hook_func_t func, rb_event_flag_t events, VALUE data) 
<dd>
<p>指定されたインタプリタのイベントに対するフック関数を追加します．eventsは以下の値のorでなければなりません:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>RUBY_EVENT_LINE</span>
<span class='const'>RUBY_EVENT_CLASS</span>
<span class='const'>RUBY_EVENT_END</span>
<span class='const'>RUBY_EVENT_CALL</span>
<span class='const'>RUBY_EVENT_RETURN</span>
<span class='const'>RUBY_EVENT_C_CALL</span>
<span class='const'>RUBY_EVENT_C_RETURN</span>
<span class='const'>RUBY_EVENT_RAISE</span>
<span class='const'>RUBY_EVENT_ALL</span></code></pre>

<p>rb_event_hook_func_tの定義は以下の通りです:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_typedef'>typedef</span> <span class='id identifier rubyid_void'>void</span> (<span class='op'>*</span><span class='id identifier rubyid_rb_event_hook_func_t'>rb_event_hook_func_t</span>)(<span class='id identifier rubyid_rb_event_t'>rb_event_t</span> <span class='id identifier rubyid_event'>event</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='id identifier rubyid_data'>data</span><span class='comma'>,</span>
                                     <span class='const'>VALUE</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='const'>ID</span> <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='const'>VALUE</span> <span class='id identifier rubyid_klass'>klass</span>)</code></pre>

<p>rb_add_event_hook() の第3引数 data は，フック関数の第2引数として渡されます．これは1.8では現在のNODEへのポインタでした．以下の RB_EVENT_HOOKS_HAVE_CALLBACK_DATA も参照してください．</p>
</dd><dt>int rb_remove_event_hook(rb_event_hook_func_t func) 
<dd>
<p>指定されたフック関数を削除します．</p>
</dd></dl>

<h3 id="label-E3-83-A1-E3-83-A2-E3-83-AA-E4-BD-BF-E7-94-A8-E9-87-8F">メモリ使用量</h3>
<dl class="rdoc-list note-list"><dt>void rb_gc_adjust_memory_usage(ssize_t diff) 
<dd>
<p>登録された外部のメモリ使用量を調整します．この関数で外部のライブラリがどのくらいメモリを使っているのかをGCに伝えることができます．正のdiffでこの関数を呼び出すとメモリ使用量の増加を意味します．新しいメモリブロックが確保されたり，ブロックがより大きなサイズで再割り当てされたりした場合などです．負のdiffでこの関数を呼び出すとメモリ使用量の減少を意味します．メモリブロックが解放されたり，メモリブロックがより小さいサイズで再確保されたりした場合などです．この関数はGCを引き起こすかもしれません．</p>
</dd></dl>

<h3 id="label-E4-BA-92-E6-8F-9B-E6-80-A7-E3-81-AE-E3-81-9F-E3-82-81-E3-81-AE-E3-83-9E-E3-82-AF-E3-83-AD">互換性のためのマクロ</h3>

<p>APIの互換性をチェックするために以下のマクロがデフォルトで定義されています．</p>
<dl class="rdoc-list note-list"><dt>NORETURN_STYLE_NEW 
<dd>
<p>NORETURN マクロが関数型マクロとして定義されていることを意味する．</p>
</dd><dt>HAVE_RB_DEFINE_ALLOC_FUNC 
<dd>
<p>rb_define_alloc_func() 関数が提供されていること，つまりallocation framework が使われることを意味する．have_func(“rb_define_alloc_func”, “ruby.h”) の結果と同じ．</p>
</dd><dt>HAVE_RB_REG_NEW_STR 
<dd>
<p>StringオブジェクトからRegexpオブジェクトを作るrb_reg_new_str() 関数が提供されていることを意味する．have_func(“rb_reg_new_str”, “ruby.h”). の結果と同じ．</p>
</dd><dt>HAVE_RB_IO_T 
<dd>
<p>rb_io_t 型が提供されていることを意味する．</p>
</dd><dt>USE_SYMBOL_AS_METHOD_NAME 
<dd>
<p>メソッド名を返すメソッド，Module#methods, #singleton_methods などがSymbolを返すことを意味する．</p>
</dd><dt>HAVE_RUBY_*_H 
<dd>
<p>ruby.h で定義されている．対応するヘッダが提供されていることを意味する．たとえば，HAVE_RUBY_ST_H が定義されている場合は単なる st.h ではなく ruby/st.h を使用する．</p>
</dd><dt>RB_EVENT_HOOKS_HAVE_CALLBACK_DATA 
<dd>
<p>rb_add_event_hook() がフック関数に渡す data を第3引数として受け取ることを意味する．</p>
</dd></dl>

<h2 id="label-Appendix+C.+extconf.rb-E3-81-A7-E4-BD-BF-E3-81-88-E3-82-8B-E9-96-A2-E6-95-B0-E3-81-9F-E3-81-A1">Appendix C. extconf.rbで使える関数たち</h2>

<p>extconf.rbの中では利用可能なコンパイル条件チェックの関数は以下の通りである．</p>
<dl class="rdoc-list note-list"><dt>have_macro(macro, headers) 
<dd>
<p>ヘッダファイルheaderをインクルードしてマクロmacroが定義されているかどうかチェックする．マクロが定義されている時true を返す．</p>
</dd><dt>have_library(lib, func) 
<dd>
<p>関数funcを定義しているライブラリlibの存在をチェックする．チェックに成功すると，-llibを$libsに追加し，trueを返す．</p>
</dd><dt>find_library(lib, func, path…) 
<dd>
<p>関数funcを定義しているライブラリlibの存在を -Lpath を追加しながらチェックする．チェックに成功すると，-llibを$libsに追加し，trueを返す．</p>
</dd><dt>have_func(func, header) 
<dd>
<p>ヘッダファイルheaderをインクルードして関数funcの存在をチェックする．funcが標準ではリンクされないライブラリ内のものである時には先にhave_libraryでそのライブラリをチェックしておく事．チェックに成功すると，プリプロセッサマクロ<code>HAVE_{FUNC</code>} を定義し，trueを返す．</p>
</dd><dt>have_var(var, header) 
<dd>
<p>ヘッダファイルheaderをインクルードして変数varの存在をチェックする．varが標準ではリンクされないライブラリ内のものである時には先にhave_libraryでそのライブラリをチェックしておく事．チェックに成功すると，プリプロセッサマクロ<code>HAVE_{VAR</code>} を定義し，trueを返す．</p>
</dd><dt>have_header(header) 
<dd>
<p>ヘッダファイルの存在をチェックする．チェックに成功すると，プリプロセッサマクロ <code>HAVE_{HEADER_H</code>} を定義し，trueを返す．(スラッシュやドットはアンダースコアに置換される)</p>
</dd><dt>find_header(header, path…) 
<dd>
<p>ヘッダファイルheaderの存在を -Ipath を追加しながらチェックする．チェックに成功すると，プリプロセッサマクロ<code>HAVE_{HEADER_H</code>} を定義し，trueを返す．(スラッシュやドットはアンダースコアに置換される)</p>
</dd><dt>have_struct_member(type, member[, header[, opt]]) 
<dd>
<p>ヘッダファイルheaderをインクルードして型typeが定義され，なおかつメンバmemberが存在するかをチェックする．チェックに成功すると，プリプロセッサマクロ <code>HAVE_{TYPE</code>_<code>MEMBER</code>} を定義し，trueを返す．</p>
</dd><dt>have_type(type, header, opt) 
<dd>
<p>ヘッダファイルheaderをインクルードして型typeが存在するかをチェックする．チェックに成功すると，プリプロセッサマクロ<code>HAVE_TYPE_{TYPE</code>} を定義し，trueを返す．</p>
</dd><dt>check_sizeof(type, header) 
<dd>
<p>ヘッダファイルheaderをインクルードして型typeのchar単位サイズを調べる．チェックに成功すると，プリプロセッサマクロ<code>SIZEOF_{TYPE</code>} を定義し，そのサイズを返す．定義されていないときはnilを返す．</p>
</dd><dt>create_makefile(target[, target_prefix]) 
<dd>
<p>拡張ライブラリ用のMakefileを生成する．この関数を呼ばなければそのライブラリはコンパイルされない．targetはモジュール名を表す．</p>
</dd><dt>find_executable(command, path) 
<dd>
<p>コマンドcommandをFile::PATH_SEPARATORで区切られたパス名のリストpathから探す．pathがnilまたは省略された場合は，環境変数PATHの値を使用する．実行可能なコマンドが見つかった場合はパスを含むファイル名，見つからなかった場合はnilを返す．</p>
</dd><dt>with_config(withval[, default=nil]) 
<dd>
<p>コマンドライン上の–with-&lt;withval&gt;で指定されたオプション値を得る．</p>
</dd><dt>enable_config(config, *defaults) 
<dt>disable_config(config, *defaults) 
<dd>
<p>コマンドライン上の–enable-&lt;config&gt;または–disable-&lt;config&gt;で指定された真偽値を得る．–enable-&lt;config&gt;が指定されていた場合はtrue，–disable-&lt;config&gt;が指定されていた場合はfalseを返す．どちらも指定されていない場合は，ブロックつきで呼び出されている場合は*defaultsをyieldした結果，ブロックなしなら*defaultsを返す．</p>
</dd><dt>dir_config(target[, default_dir]) 
<dt>dir_config(target[, default_include, default_lib]) 
<dd>
<p>コマンドライン上の–with-&lt;target&gt;-dir, –with-&lt;target&gt;-include, –with-&lt;target&gt;-libのいずれかで指定されるディレクトリを$CFLAGS や $LDFLAGS に追加する．–with-&lt;target&gt;-dir=/pathは–with-&lt;target&gt;-include=/path/include –with-&lt;target&gt;-lib=/path/lib と等価である．追加された include ディレクトリと lib ディレクトリの配列を返す． ([include_dir, lib_dir])</p>
</dd><dt>pkg_config(pkg, option=nil) 
<dd>
<p>pkg-configコマンドからパッケージpkgの情報を [cflags, ldflags, libs] の配列として得る．$CFLAGS, $LDFLAGS, $libs にはそれぞれの値が追加される．</p>

<p>pkg-configの実際のコマンドは，以下の順で試される．</p>
<ol><li>
<p>コマンドラインで–with-<code>pkg</code>-config=<code>command</code>オプションが指定された場合: <code>command</code> <code>option</code></p>
</li><li>
<p><code>pkg</code>-config <code>option</code></p>
</li><li>
<p>pkg-config <code>option</code> <code>pkg</code></p>
</li></ol>

<p>optionが指定された場合は，上記の配列の代わりにそのオプションを指定して得られた出力をstripしたものを返す．</p>
</dd></dl>

<h2 id="label-Appendix+D.+-E4-B8-96-E4-BB-A3-E5-88-A5GC">Appendix D. 世代別GC</h2>

<p>Ruby 2.1から世代別GCに対応しました．我々はこれをRGenGCと呼んでいます．RGenGCは，過去の拡張ライブラリに（ほぼ）互換性を保つように開発されているため，拡張ライブラリ側の対応はほぼ不要です．</p>

<p>ただし，対応をすることで性能を向上することができる可能性があります．もし拡張ライブラリに高い性能が必要である場合は対応を検討して下さい．</p>

<p>とくにRARRAY_PTR()/RHASH_TBL()のようなマクロを用いてポインタに直接アクセスするようなコードは書かないようにして下さい．代わりに，rb_ary_aref(), rb_ary_store() などの，適切な API 関数を利用するようにして下さい．</p>

<p>そのほか，対応についての詳細は extension.rdoc の「Appendix D. Generational GC」を参照して下さい．</p>

<h2 id="label-Appendix+E.+Ractor+-E3-82-B5-E3-83-9D-E3-83-BC-E3-83-88">Appendix E. Ractor サポート</h2>

<p>Ruby 3.0 から、Ruby プログラムを並列に実行するための仕組みである Ractor が導入されました。適切に並列に実行するためには、Ractor サポートが必要になります。サポートしていないライブラリは、メイン Ractor 以外で実行するとエラーになります（Ractor::UnsafeError）。</p>

<p>Ractor をサポートするための詳細は、extension.rdoc の「Appendix F. Ractor support」を参照してください。</p>

<p>:enddoc: Local variables: :enddoc: fill-column: 60 :enddoc: end:</p>
</dd></dl>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>