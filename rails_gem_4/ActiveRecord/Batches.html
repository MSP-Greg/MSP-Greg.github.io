<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Module: ActiveRecord::Batches &mdash; Rails 4.2.11.3</title>

<link rel='stylesheet'  type='text/css' href='../../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "ActiveRecord::Batches",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../'>Rails 4.2.11.3</a> &raquo; 
      <a href='../_index.html#alpha_B'>Index (B)</a> &raquo; 
        <a href="../ActiveRecord.html" title="ActiveRecord (module)">ActiveRecord</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Batches&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='module'>
<h1>Module: ActiveRecord::Batches</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Extension / Inclusion / Inheritance Descendants</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Included In:</div>
      <div class='box_11'>
        <a href="AssociationRelation.html" title="ActiveRecord::AssociationRelation (class)">AssociationRelation</a>,
          <a href="Associations/CollectionProxy.html" title="ActiveRecord::Associations::CollectionProxy (class)">Associations::CollectionProxy</a>,
          <a href="Relation.html" title="ActiveRecord::Relation (class)">Relation</a>
      </div>
    </td></tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/rails/rails/blob/v4.2.11.3/activerecord/lib/active_record/relation/batches.rb#L2'>activerecord/lib/active_record/relation/batches.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#find_each-instance_method" title="#find_each (instance method)">#<strong>find_each</strong>(options = {})  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Looping through a collection of records from the database (using the <code>all</code> method, for example) is very inefficient since it will try to instantiate all the objects at once.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#find_in_batches-instance_method" title="#find_in_batches (instance method)">#<strong>find_in_batches</strong>(options = {})  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Yields each batch of records that was found by the find <code>options</code> as an array.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="find_each-instance_method">
  <h3 class='signature  first'>
    #<strong>find_each</strong>(options = {})  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Looping through a collection of records from the database (using the <code>all</code> method, for example) is very inefficient since it will try to instantiate all the objects at once.</p>

<p>In that case, batch processing methods allow you to work with the records in batches, thereby greatly reducing memory consumption.</p>

<p>The <code>#find_each</code> method uses <a href="#find_in_batches-instance_method" title="ActiveRecord::Batches#find_in_batches (method)">#find_in_batches</a> with a batch size of 1000 (or as specified by the <code>:batch_size</code> option).</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_find_each'>find_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_do_awesome_stuff'>do_awesome_stuff</span>
<span class='kw'>end</span>

<span class='const'>Person</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>age &gt; 21</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_find_each'>find_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span>
<span class='kw'>end</span></code></pre>

<p>If you do not provide a block to <code>#find_each</code>, it will return an Enumerator for chaining with other methods:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_find_each'>find_each</span>.<span class='id identifier rubyid_with_index'>with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='comma'>,</span> <span class='id identifier rubyid_index'>index</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_award_trophy'>award_trophy</span>(<span class='id identifier rubyid_index'>index</span> <span class='op'>+</span> <span class='int'>1</span>)
<span class='kw'>end</span></code></pre>

<h4 id="label-Options">Options</h4>
<ul><li>
<p><code>:batch_size</code> - Specifies the size of the batch. Default to 1000.</p>
</li><li>
<p><code>:start</code> - Specifies the starting point for the batch processing.</p>
</li></ul>

<p>This is especially useful if you want multiple workers dealing with the same processing queue. You can make worker 1 handle all the records between id 0 and 10,000 and worker 2 handle from 10,000 and beyond (by setting the <code>:start</code> option on that worker).</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Let&#39;s process for a batch of 2000 records, skipping the first 2000 rows
</span><span class='const'>Person</span>.<span class='id identifier rubyid_find_each'>find_each</span>(<span class='label'>start:</span> <span class='int'>2000</span><span class='comma'>,</span> <span class='label'>batch_size:</span> <span class='int'>2000</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span>
  <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span>
<span class='kw'>end</span></code></pre>

<p>NOTE: It&#39;s not possible to set the order. That is automatically set to ascending on the primary key (“id ASC”) to make the batch ordering work. This also means that this method only works with integer-based primary keys.</p>

<p>NOTE: You can&#39;t set the limit either, that&#39;s used to control the batch sizes.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v4.2.11.3/activerecord/lib/active_record/relation/batches.rb#L48-L58'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='48' data-end='58'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 48</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_find_each'>find_each</span>(<span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> {})
  <span class='kw'>if</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
    <span class='id identifier rubyid_find_in_batches'><a href="#find_in_batches-instance_method" title="ActiveRecord::Batches#find_in_batches (method)">find_in_batches</a></span>(<span class='id identifier rubyid_options'>options</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_records'>records</span><span class='op'>|</span>
      <span class='id identifier rubyid_records'>records</span>.<span class='id identifier rubyid_each'>each</span> { <span class='op'>|</span><span class='id identifier rubyid_record'>record</span><span class='op'>|</span> <span class='kw'>yield</span> <span class='id identifier rubyid_record'>record</span> }
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_enum_for'>enum_for</span> <span class='symbeg'>:</span><span class='id identifier rubyid_find_each'>find_each</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_start'>start</span>] <span class='op'>?</span> <span class='id identifier rubyid_where'>where</span>(<span class='id identifier rubyid_table'>table</span>[<span class='id identifier rubyid_primary_key'>primary_key</span>].<span class='id identifier rubyid_gteq'>gteq</span>(<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_start'>start</span>])).<span class='id identifier rubyid_size'>size</span> <span class='op'>:</span> <span class='id identifier rubyid_size'>size</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="find_in_batches-instance_method">
  <h3 class='signature '>
    #<strong>find_in_batches</strong>(options = {})  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Yields each batch of records that was found by the find <code>options</code> as an array.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_where'>where</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>age &gt; 21</span><span class='tstring_end'>&quot;</span></span>).<span class='id identifier rubyid_find_in_batches'>find_in_batches</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_group'>group</span><span class='op'>|</span>
  <span class='id identifier rubyid_sleep'>sleep</span>(<span class='int'>50</span>) <span class='comment'># Make sure it doesn&#39;t get too crowded in there!
</span>  <span class='id identifier rubyid_group'>group</span>.<span class='id identifier rubyid_each'>each</span> { <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span> <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span> }
<span class='kw'>end</span></code></pre>

<p>If you do not provide a block to <code>#find_in_batches</code>, it will return an Enumerator for chaining with other methods:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Person</span>.<span class='id identifier rubyid_find_in_batches'>find_in_batches</span>.<span class='id identifier rubyid_with_index'>with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_group'>group</span><span class='comma'>,</span> <span class='id identifier rubyid_batch'>batch</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Processing group #</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_batch'>batch</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_group'>group</span>.<span class='id identifier rubyid_each'>each</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_recover_from_last_night!'>recover_from_last_night!</span>)
<span class='kw'>end</span></code></pre>

<p>To be yielded each record one by one, use <a href="#find_each-instance_method" title="ActiveRecord::Batches#find_each (method)">#find_each</a> instead.</p>

<h4 id="label-Options">Options</h4>
<ul><li>
<p><code>:batch_size</code> - Specifies the size of the batch. Default to 1000.</p>
</li><li>
<p><code>:start</code> - Specifies the starting point for the batch processing.</p>
</li></ul>

<p>This is especially useful if you want multiple workers dealing with the same processing queue. You can make worker 1 handle all the records between id 0 and 10,000 and worker 2 handle from 10,000 and beyond (by setting the <code>:start</code> option on that worker).</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Let&#39;s process the next 2000 records
</span><span class='const'>Person</span>.<span class='id identifier rubyid_find_in_batches'>find_in_batches</span>(<span class='label'>start:</span> <span class='int'>2000</span><span class='comma'>,</span> <span class='label'>batch_size:</span> <span class='int'>2000</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_group'>group</span><span class='op'>|</span>
  <span class='id identifier rubyid_group'>group</span>.<span class='id identifier rubyid_each'>each</span> { <span class='op'>|</span><span class='id identifier rubyid_person'>person</span><span class='op'>|</span> <span class='id identifier rubyid_person'>person</span>.<span class='id identifier rubyid_party_all_night!'>party_all_night!</span> }
<span class='kw'>end</span></code></pre>

<p>NOTE: It&#39;s not possible to set the order. That is automatically set to ascending on the primary key (“id ASC”) to make the batch ordering work. This also means that this method only works with integer-based primary keys.</p>

<p>NOTE: You can&#39;t set the limit either, that&#39;s used to control the batch sizes.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/rails/rails/blob/v4.2.11.3/activerecord/lib/active_record/relation/batches.rb#L98-L130'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='98' data-end='130'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'activerecord/lib/active_record/relation/batches.rb', line 98</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_find_in_batches'>find_in_batches</span>(<span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> {})
  <span class='id identifier rubyid_options'>options</span>.<span class='id identifier rubyid_assert_valid_keys'>assert_valid_keys</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_start'>start</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_batch_size'>batch_size</span>)

  <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='kw'>self</span>
  <span class='id identifier rubyid_start'>start</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_start'>start</span>]
  <span class='id identifier rubyid_batch_size'>batch_size</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_batch_size'>batch_size</span>] <span class='op'>||</span> <span class='int'>1000</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_to_enum'>to_enum</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_find_in_batches'>find_in_batches</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span>) <span class='kw'>do</span>
      <span class='id identifier rubyid_total'>total</span> <span class='op'>=</span> <span class='id identifier rubyid_start'>start</span> <span class='op'>?</span> <span class='id identifier rubyid_where'>where</span>(<span class='id identifier rubyid_table'>table</span>[<span class='id identifier rubyid_primary_key'>primary_key</span>].<span class='id identifier rubyid_gteq'>gteq</span>(<span class='id identifier rubyid_start'>start</span>)).<span class='id identifier rubyid_size'>size</span> <span class='op'>:</span> <span class='id identifier rubyid_size'>size</span>
      (<span class='id identifier rubyid_total'>total</span> <span class='op'>-</span> <span class='int'>1</span>).<span class='id identifier rubyid_div'>div</span>(<span class='id identifier rubyid_batch_size'>batch_size</span>) <span class='op'>+</span> <span class='int'>1</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_logger'>logger</span> <span class='op'>&amp;&amp;</span> (<span class='id identifier rubyid_arel'>arel</span>.<span class='id identifier rubyid_orders'>orders</span>.<span class='id identifier rubyid_present?'>present?</span> <span class='op'>||</span> <span class='id identifier rubyid_arel'>arel</span>.<span class='id identifier rubyid_taken'>taken</span>.<span class='id identifier rubyid_present?'>present?</span>)
    <span class='id identifier rubyid_logger'>logger</span>.<span class='id identifier rubyid_warn'>warn</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Scoped order and limit are ignored, it&#39;s forced to be batch order and batch size</span><span class='tstring_end'>&quot;</span></span>)
  <span class='kw'>end</span>

  <span class='id identifier rubyid_relation'>relation</span> <span class='op'>=</span> <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_reorder'>reorder</span>(<span class='id identifier rubyid_batch_order'>batch_order</span>).<span class='id identifier rubyid_limit'>limit</span>(<span class='id identifier rubyid_batch_size'>batch_size</span>)
  <span class='id identifier rubyid_records'>records</span> <span class='op'>=</span> <span class='id identifier rubyid_start'>start</span> <span class='op'>?</span> <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_where'>where</span>(<span class='id identifier rubyid_table'>table</span>[<span class='id identifier rubyid_primary_key'>primary_key</span>].<span class='id identifier rubyid_gteq'>gteq</span>(<span class='id identifier rubyid_start'>start</span>)).<span class='id identifier rubyid_to_a'>to_a</span> <span class='op'>:</span> <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_to_a'>to_a</span>

  <span class='kw'>while</span> <span class='id identifier rubyid_records'>records</span>.<span class='id identifier rubyid_any?'>any?</span>
    <span class='id identifier rubyid_records_size'>records_size</span> <span class='op'>=</span> <span class='id identifier rubyid_records'>records</span>.<span class='id identifier rubyid_size'>size</span>
    <span class='id identifier rubyid_primary_key_offset'>primary_key_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_records'>records</span>.<span class='id identifier rubyid_last'>last</span>.<span class='id identifier rubyid_id'>id</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Primary key not included in the custom select clause</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_primary_key_offset'>primary_key_offset</span>

    <span class='kw'>yield</span> <span class='id identifier rubyid_records'>records</span>

    <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_records_size'>records_size</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_batch_size'>batch_size</span>

    <span class='id identifier rubyid_records'>records</span> <span class='op'>=</span> <span class='id identifier rubyid_relation'>relation</span>.<span class='id identifier rubyid_where'>where</span>(<span class='id identifier rubyid_table'>table</span>[<span class='id identifier rubyid_primary_key'>primary_key</span>].<span class='id identifier rubyid_gt'>gt</span>(<span class='id identifier rubyid_primary_key_offset'>primary_key_offset</span>)).<span class='id identifier rubyid_to_a'>to_a</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>