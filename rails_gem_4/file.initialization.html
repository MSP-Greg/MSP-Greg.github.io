<!DOCTYPE html>
<html>
<head>

<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>File: Initialization &mdash; Rails 4.2.11.3</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "initialization",
    relpath = '';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='.'>Rails 4.2.11.3</a> &raquo; 
      <a href='_index.html'>Index</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>File: Initialization&nbsp;&#x25B2;</a></span>
          </div>

    <a id='list_href' href="class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='file'>
<h1>The Rails Initialization Process</h1>
<p>This guide explains the internals of the initialization process in <a href="Rails.html" title="Rails (module)">Rails</a>
as of <a href="Rails.html" title="Rails (module)">Rails</a> 4. It is an extremely in-depth guide and recommended for advanced <a href="Rails.html" title="Rails (module)">Rails</a> developers.</p>
<p>After reading this guide, you will know:</p>
<ul>
<li>How to use <code>rails server</code>.</li>
<li>The timeline of Rails' initialization sequence.</li>
<li>Where different files are required by the boot sequence.</li>
<li>How the <a href="Rails/Server.html" title="Rails::Server (class)">::Rails::Server</a> interface is defined and used.</li>
</ul>
<hr />
<p>This guide goes through every method call that is
required to boot up the Ruby on <a href="Rails.html" title="Rails (module)">Rails</a> stack for a default <a href="Rails.html" title="Rails (module)">Rails</a> 4
application, explaining each part in detail along the way. For this
guide, we will be focusing on what happens when you execute <code>rails server</code>
to boot your app.</p>
<p>NOTE: Paths in this guide are relative to <a href="Rails.html" title="Rails (module)">Rails</a> or a <a href="Rails.html" title="Rails (module)">Rails</a> application unless otherwise specified.</p>
<p>TIP: If you want to follow along while browsing the <a href="Rails.html" title="Rails (module)">Rails</a> <code>href="https://github.com/rails/rails">https://github.com/rails/rails</a> source
code</code>, we recommend that you use the <code>t</code>
key binding to open the file finder inside GitHub and find files
quickly.</p>
<h2>Launch!</h2>
<p>Let's start to boot and initialize the app. A Rails application is usually
started by running <code>rails console</code> or <code>rails server</code>.</p>
<h3><code>railties/bin/rails</code></h3>
<p>The <code>rails</code> in the command <code>rails server</code> is a ruby executable in your load
path. This executable contains the following lines:</p>
<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_version'>version</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;= 0</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_load'>load</span> <span class='const'>Gem</span>.<span class='id identifier rubyid_bin_path'>bin_path</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>railties</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rails</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_version'>version</span>)</code></pre>
<p>If you try out this command in a Rails console, you would see that this loads
<code>railties/bin/rails</code>. A part of the file <code>railties/bin/rails.rb</code> has the
following code:</p>
<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rails/cli</span><span class='tstring_end'>&quot;</span></span></code></pre>
<p>The file <code>railties/lib/rails/cli</code> in turn calls
<a href="Rails/AppRailsLoader.html#exec_app_rails-instance_method" title="Rails::AppRailsLoader#exec_app_rails (method)">Rails::AppRailsLoader#exec_app_rails</a>.</p>
<h3><code>railties/lib/rails/app_rails_loader.rb</code></h3>
<p>The primary goal of the function <code>exec_app_rails</code> is to execute your app's
<code>bin/rails</code>. If the current directory does not have a <code>bin/rails</code>, it will
navigate upwards until it finds a <code>bin/rails</code> executable. Thus one can invoke a
<code>rails</code> command from anywhere inside a rails application.</p>
<p>For <code>rails server</code> the equivalent of the following command is executed:</p>
<pre class="code bash"><code class="bash">$ exec ruby bin/rails server
</code></pre>
<h3><code>bin/rails</code></h3>
<p>This file is as follows:</p>
<pre class="code ruby"><code class="ruby"><span class='comment'>#!/usr/bin/env ruby
</span><span class='const'>APP_PATH</span> <span class='op'>=</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_expand_path'>expand_path</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>../../config/application</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>__FILE__</span>)
<span class='id identifier rubyid_require_relative'>require_relative</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>../config/boot</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rails/commands</span><span class='tstring_end'>&#39;</span></span></code></pre>
<p>The <code>APP_PATH</code> constant will be used later in <code>rails/commands</code>. The <code>config/boot</code> file referenced here is the <code>config/boot.rb</code> file in our application which is responsible for loading Bundler and setting it up.</p>
<h3><code>config/boot.rb</code></h3>
<p><code>config/boot.rb</code> contains:</p>
<pre class="code ruby"><code class="ruby"><span class='comment'># Set up gems listed in the Gemfile.
</span><span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BUNDLE_GEMFILE</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>||=</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_expand_path'>expand_path</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>../../Gemfile</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>__FILE__</span>)

<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bundler/setup</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_exist?'>exist?</span>(<span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BUNDLE_GEMFILE</span><span class='tstring_end'>&#39;</span></span>])</code></pre>
<p>In a standard Rails application, there's a <code>Gemfile</code> which declares all
dependencies of the application. <code>config/boot.rb</code> sets
<code>ENV['BUNDLE_GEMFILE']</code> to the location of this file. If the Gemfile
exists, then <code>bundler/setup</code> is required. The require is used by Bundler to
configure the load path for your Gemfile's dependencies.</p>
<p>A standard Rails application depends on several gems, specifically:</p>
<ul>
<li>actionmailer</li>
<li>actionpack</li>
<li>actionview</li>
<li>activemodel</li>
<li>activerecord</li>
<li>activesupport</li>
<li>arel</li>
<li>builder</li>
<li>bundler</li>
<li>erubis</li>
<li>i18n</li>
<li>mail</li>
<li>mime-types</li>
<li>rack</li>
<li>rack-cache</li>
<li>rack-mount</li>
<li>rack-test</li>
<li>rails</li>
<li>railties</li>
<li>rake</li>
<li>sqlite3</li>
<li>thor</li>
<li>tzinfo</li>
</ul>
<h3><code>rails/commands.rb</code></h3>
<p>Once <code>config/boot.rb</code> has finished, the next file that is required is
<code>rails/commands</code>, which helps in expanding aliases. In the current case, the
<code>ARGV</code> array simply contains <code>server</code> which will be passed over:</p>
<pre class="code ruby"><code class="ruby"><span class='const'>ARGV</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>--help</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='const'>ARGV</span>.<span class='id identifier rubyid_empty?'>empty?</span>

<span class='id identifier rubyid_aliases'>aliases</span> <span class='op'>=</span> {
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>g</span><span class='tstring_end'>&quot;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>generate</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>d</span><span class='tstring_end'>&quot;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>destroy</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>c</span><span class='tstring_end'>&quot;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>console</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>s</span><span class='tstring_end'>&quot;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>server</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>db</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dbconsole</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r</span><span class='tstring_end'>&quot;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>runner</span><span class='tstring_end'>&quot;</span></span>
}

<span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='const'>ARGV</span>.<span class='id identifier rubyid_shift'>shift</span>
<span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='id identifier rubyid_aliases'>aliases</span>[<span class='id identifier rubyid_command'>command</span>] <span class='op'>||</span> <span class='id identifier rubyid_command'>command</span>

<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rails/commands/commands_tasks</span><span class='tstring_end'>&#39;</span></span>

<span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span><span class='op'>::</span><span class='const'><a href="Rails/CommandsTasks.html" title="Rails::CommandsTasks (class)">CommandsTasks</a></span>.<span class='id identifier rubyid_new'><a href="Rails/CommandsTasks.html#new-class_method" title="Rails::CommandsTasks.new (method)">new</a></span>(<span class='const'>ARGV</span>).<span class='id identifier rubyid_run_command!'><a href="Rails/CommandsTasks.html#run_command!-instance_method" title="Rails::CommandsTasks#run_command! (method)">run_command!</a></span>(<span class='id identifier rubyid_command'>command</span>)</code></pre>
<p>TIP: As you can see, an empty ARGV list will make Rails show the help
snippet.</p>
<p>If we had used <code>s</code> rather than <code>server</code>, Rails would have used the <code>aliases</code>
defined here to find the matching command.</p>
<h3><code>rails/commands/command_tasks.rb</code></h3>
<p>When one types an incorrect rails command, the <code>run_command</code> is responsible for
throwing an error message. If the command is valid, a method of the same name
is called.</p>
<pre class="code ruby"><code class="ruby"><span class='const'>COMMAND_WHITELIST</span> <span class='op'>=</span> <span class='qwords'><span class='qwords_beg'>%w(</span><span class='tstring_content'>plugin</span><span class='words_sep'> </span><span class='tstring_content'>generate</span><span class='words_sep'> </span><span class='tstring_content'>destroy</span><span class='words_sep'> </span><span class='tstring_content'>console</span><span class='words_sep'> </span><span class='tstring_content'>server</span><span class='words_sep'> </span><span class='tstring_content'>dbconsole</span><span class='words_sep'> </span><span class='tstring_content'>application</span><span class='words_sep'> </span><span class='tstring_content'>runner</span><span class='words_sep'> </span><span class='tstring_content'>new</span><span class='words_sep'> </span><span class='tstring_content'>version</span><span class='words_sep'> </span><span class='tstring_content'>help</span><span class='tstring_end'>)</span></span>

<span class='kw'>def</span> <span class='id identifier rubyid_run_command!'>run_command!</span>(<span class='id identifier rubyid_command'>command</span>)
  <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='id identifier rubyid_parse_command'>parse_command</span>(<span class='id identifier rubyid_command'>command</span>)
  <span class='kw'>if</span> <span class='const'>COMMAND_WHITELIST</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_command'>command</span>)
    <span class='id identifier rubyid_send'>send</span>(<span class='id identifier rubyid_command'>command</span>)
  <span class='kw'>else</span>
    <span class='id identifier rubyid_write_error_message'>write_error_message</span>(<span class='id identifier rubyid_command'>command</span>)
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>
<p>With the <code>server</code> command, Rails will further run the following code:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_set_application_directory!'>set_application_directory!</span>
  <span class='const'>Dir</span>.<span class='id identifier rubyid_chdir'>chdir</span>(<span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_expand_path'>expand_path</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>../../</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>APP_PATH</span>)) <span class='kw'>unless</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_exist?'>exist?</span>(<span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_expand_path'>expand_path</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>config.ru</span><span class='tstring_end'>&quot;</span></span>))
<span class='kw'>end</span>

<span class='kw'>def</span> <span class='id identifier rubyid_server'>server</span>
  <span class='id identifier rubyid_set_application_directory!'>set_application_directory!</span>
  <span class='id identifier rubyid_require_command!'>require_command!</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>server</span><span class='tstring_end'>&quot;</span></span>)

  <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span><span class='op'>::</span><span class='const'><a href="Rails/Server.html" title="Rails::Server (class)">Server</a></span>.<span class='id identifier rubyid_new'><a href="Rails/Server.html#new-class_method" title="Rails::Server.new (method)">new</a></span>.<span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='comment'># We need to require application after the server sets environment,
</span>    <span class='comment'># otherwise the --environment option given to the server won&#39;t propagate.
</span>    <span class='id identifier rubyid_require'>require</span> <span class='const'>APP_PATH</span>
    <span class='const'>Dir</span>.<span class='id identifier rubyid_chdir'>chdir</span>(<span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_application'><a href="Rails.html#application-class_method" title="Rails.application (method)">application</a></span>.<span class='id identifier rubyid_root'>root</span>)
    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_start'>start</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>def</span> <span class='id identifier rubyid_require_command!'>require_command!</span>(<span class='id identifier rubyid_command'>command</span>)
  <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rails/commands/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_command'>command</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>
<p>This file will change into the Rails root directory (a path two directories up
from <code>APP_PATH</code> which points at <code>config/application.rb</code>), but only if the
<code>config.ru</code> file isn't found. This then requires <code>rails/commands/server</code> which
sets up the <a href="Rails/Server.html" title="Rails::Server (class)">::Rails::Server</a> class.</p>
<pre class="code ruby"><code class="ruby">require &#39;fileutils&#39;
require &#39;optparse&#39;
require &#39;action_dispatch&#39;
require &#39;rails&#39;

module Rails
  class Server &lt; ::Rack::Server</code></pre>
<p><code>fileutils</code> and <code>optparse</code> are standard Ruby libraries which provide helper functions for working with files and parsing options.</p>
<h3><code>actionpack/lib/action_dispatch.rb</code></h3>
<p>Action Dispatch is the routing component of the Rails framework.
It adds functionality like routing, session, and common middlewares.</p>
<h3><code>rails/commands/server.rb</code></h3>
<p>The <a href="Rails/Server.html" title="Rails::Server (class)">::Rails::Server</a> class is defined in this file by inheriting from <code>Rack::Server</code>. When <a href="Rails/Server.html#new-class_method" title="Rails::Server.new (method)">Rails::Server.new</a> is called, this calls the <code>initialize</code> method in <code>rails/commands/server.rb</code>:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='op'>*</span>)
  <span class='kw'>super</span>
  <span class='id identifier rubyid_set_environment'>set_environment</span>
<span class='kw'>end</span></code></pre>
<p>Firstly, <code>super</code> is called which calls the <code>initialize</code> method on <code>Rack::Server</code>.</p>
<h3>Rack: <code>lib/rack/server.rb</code></h3>
<p><code>Rack::Server</code> is responsible for providing a common server interface for all Rack-based applications, which Rails is now a part of.</p>
<p>The <code>initialize</code> method in <code>Rack::Server</code> simply sets a couple of variables:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='kw'>nil</span>)
  <span class='ivar'>@options</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>
  <span class='ivar'>@app</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_app'>app</span>] <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_app'>app</span>]
<span class='kw'>end</span></code></pre>
<p>In this case, <code>options</code> will be <code>nil</code> so nothing happens in this method.</p>
<p>After <code>super</code> has finished in <code>Rack::Server</code>, we jump back to <code>rails/commands/server.rb</code>. At this point, <code>set_environment</code> is called within the context of the <a href="Rails/Server.html" title="Rails::Server (class)">::Rails::Server</a> object and this method doesn't appear to do much at first glance:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_set_environment'>set_environment</span>
  <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RAILS_ENV</span><span class='tstring_end'>&quot;</span></span>] <span class='op'>||=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_environment'>environment</span>]
<span class='kw'>end</span></code></pre>
<p>In fact, the <code>options</code> method here does quite a lot. This method is defined in <code>Rack::Server</code> like this:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_options'>options</span>
  <span class='ivar'>@options</span> <span class='op'>||=</span> <span class='id identifier rubyid_parse_options'>parse_options</span>(<span class='const'>ARGV</span>)
<span class='kw'>end</span></code></pre>
<p>Then <code>parse_options</code> is defined like this:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_parse_options'>parse_options</span>(<span class='id identifier rubyid_args'>args</span>)
  <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='id identifier rubyid_default_options'>default_options</span>

  <span class='comment'># Don&#39;t evaluate CGI ISINDEX parameters.
</span>  <span class='comment'># http://www.meb.uni-bonn.de/docs/cgi/cl.html
</span>  <span class='id identifier rubyid_args'>args</span>.<span class='id identifier rubyid_clear'>clear</span> <span class='kw'>if</span> <span class='const'>ENV</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>REQUEST_METHOD</span><span class='tstring_end'>&quot;</span></span>)

  <span class='id identifier rubyid_options'>options</span>.<span class='id identifier rubyid_merge!'>merge!</span> <span class='id identifier rubyid_opt_parser'>opt_parser</span>.<span class='id identifier rubyid_parse!'>parse!</span>(<span class='id identifier rubyid_args'>args</span>)
  <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span>] <span class='op'>=</span> <span class='op'>::</span><span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_expand_path'>expand_path</span>(<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span>])
  <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RACK_ENV</span><span class='tstring_end'>&quot;</span></span>] <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_environment'>environment</span>]
  <span class='id identifier rubyid_options'>options</span>
<span class='kw'>end</span></code></pre>
<p>With the <code>default_options</code> set to this:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_default_options'>default_options</span>
  <span class='id identifier rubyid_environment'>environment</span>  <span class='op'>=</span> <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RACK_ENV</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>development</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_default_host'>default_host</span> <span class='op'>=</span> <span class='id identifier rubyid_environment'>environment</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>development</span><span class='tstring_end'>&#39;</span></span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&#39;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&#39;</span></span>

  {
    <span class='symbeg'>:</span><span class='id identifier rubyid_environment'>environment</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_environment'>environment</span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_pid'>pid</span>         <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='const'>Port</span>        <span class='op'>=&gt;</span> <span class='int'>9292</span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='const'>Host</span>        <span class='op'>=&gt;</span> <span class='id identifier rubyid_default_host'>default_host</span><span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='const'>AccessLog</span>   <span class='op'>=&gt;</span> []<span class='comma'>,</span>
    <span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span>      <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>config.ru</span><span class='tstring_end'>&quot;</span></span>
  }
<span class='kw'>end</span></code></pre>
<p>There is no <code>REQUEST_METHOD</code> key in <code>ENV</code> so we can skip over that line. The next line merges in the options from <code>opt_parser</code> which is defined plainly in <code>Rack::Server</code>:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_opt_parser'>opt_parser</span>
  <span class='const'>Options</span>.<span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span></code></pre>
<p>The class <strong>is</strong> defined in <code>Rack::Server</code>, but is overwritten in <a href="Rails/Server.html" title="Rails::Server (class)">::Rails::Server</a> to take different arguments. Its <code>parse!</code> method begins like this:</p>
<pre class="code ruby"><code class="ruby">def parse!(args)
  args, options = args.dup, {}

  opt_parser = OptionParser.new do |opts|
    opts.banner = &quot;Usage: rails server [mongrel, thin, etc] [options]&quot;
    opts.on(&quot;-p&quot;, &quot;--port=port&quot;, Integer,
            &quot;Runs Rails on the specified port.&quot;, &quot;Default: 3000&quot;) { |v| options[:Port] = v }
  #...</code></pre>
<p>This method will set up keys for the <code>options</code> which Rails will then be
able to use to determine how its server should run. After <code>initialize</code>
has finished, we jump back into <code>rails/server</code> where <code>APP_PATH</code> (which was
set earlier) is required.</p>
<h3><code>config/application</code></h3>
<p>When <code>require APP_PATH</code> is executed, <code>config/application.rb</code> is loaded (recall
that <code>APP_PATH</code> is defined in <code>bin/rails</code>). This file exists in your application
and it's free for you to change based on your needs.</p>
<h3><a href="Rails/Server.html#start-instance_method" title="Rails::Server#start (method)">Rails::Server#start</a></h3>
<p>After <code>config/application</code> is loaded, <code>server.start</code> is called. This method is
defined like this:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_start'>start</span>
  <span class='id identifier rubyid_print_boot_information'>print_boot_information</span>
  <span class='id identifier rubyid_trap'>trap</span>(<span class='symbeg'>:</span><span class='const'>INT</span>) { <span class='id identifier rubyid_exit'>exit</span> }
  <span class='id identifier rubyid_create_tmp_directories'>create_tmp_directories</span>
  <span class='id identifier rubyid_log_to_stdout'>log_to_stdout</span> <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_log_stdout'>log_stdout</span>]

  <span class='kw'>super</span>
  <span class='comment'>#...
</span><span class='kw'>end</span>

<span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_print_boot_information'>print_boot_information</span>
    <span class='comment'>#...
</span>    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>=&gt; Run `rails server -h` for more startup options</span><span class='tstring_end'>&quot;</span></span>
    <span class='comment'>#...
</span>    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>=&gt; Ctrl-C to shutdown server</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_daemonize'>daemonize</span>]
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_create_tmp_directories'>create_tmp_directories</span>
    <span class='qwords'><span class='qwords_beg'>%w(</span><span class='tstring_content'>cache</span><span class='words_sep'> </span><span class='tstring_content'>pids</span><span class='words_sep'> </span><span class='tstring_content'>sessions</span><span class='words_sep'> </span><span class='tstring_content'>sockets</span><span class='tstring_end'>)</span></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_dir_to_make'>dir_to_make</span><span class='op'>|</span>
      <span class='const'>FileUtils</span>.<span class='id identifier rubyid_mkdir_p'>mkdir_p</span>(<span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_join'>join</span>(<span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_root'><a href="Rails.html#root-class_method" title="Rails.root (method)">root</a></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>tmp</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_dir_to_make'>dir_to_make</span>))
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_log_to_stdout'>log_to_stdout</span>
    <span class='id identifier rubyid_wrapped_app'>wrapped_app</span> <span class='comment'># touch the app so the logger is set up
</span>
    <span class='id identifier rubyid_console'>console</span> <span class='op'>=</span> <span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/Logger.html" title="ActiveSupport::Logger (class)">Logger</a></span>.<span class='id identifier rubyid_new'><a href="ActiveSupport/Logger.html#new-class_method" title="ActiveSupport::Logger.new (method)">new</a></span>(<span class='gvar'>$stdout</span>)
    <span class='id identifier rubyid_console'>console</span>.<span class='id identifier rubyid_formatter'>formatter</span> <span class='op'>=</span> <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_formatter'>formatter</span>
    <span class='id identifier rubyid_console'>console</span>.<span class='id identifier rubyid_level'>level</span> <span class='op'>=</span> <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_level'>level</span>

    <span class='const'><a href="Rails.html" title="Rails (module)">Rails</a></span>.<span class='id identifier rubyid_logger'><a href="Rails.html#logger-class_method" title="Rails.logger (method)">logger</a></span>.<span class='id identifier rubyid_extend'>extend</span>(<span class='const'><a href="ActiveSupport.html" title="ActiveSupport (module)">ActiveSupport</a></span><span class='op'>::</span><span class='const'><a href="ActiveSupport/Logger.html" title="ActiveSupport::Logger (class)">Logger</a></span>.<span class='id identifier rubyid_broadcast'><a href="ActiveSupport/Logger.html#broadcast-class_method" title="ActiveSupport::Logger.broadcast (method)">broadcast</a></span>(<span class='id identifier rubyid_console'>console</span>))
  <span class='kw'>end</span></code></pre>
<p>This is where the first output of the Rails initialization happens. This
method creates a trap for <code>INT</code> signals, so if you <code>CTRL-C</code> the server,
it will exit the process. As we can see from the code here, it will
create the <code>tmp/cache</code>, <code>tmp/pids</code>, <code>tmp/sessions</code> and <code>tmp/sockets</code>
directories. It then calls <code>wrapped_app</code> which is responsible for
creating the Rack app, before creating and assigning an
instance of <a href="ActiveSupport/Logger.html" title="ActiveSupport::Logger (class)">::ActiveSupport::Logger</a>.</p>
<p>The <code>super</code> method will call <code>Rack::Server.start</code> which begins its definition like this:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_start'>start</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_warn'>warn</span>]
    <span class='gvar'>$-w</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_includes'>includes</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_include'>include</span>]
    <span class='gvar'>$LOAD_PATH</span>.<span class='id identifier rubyid_unshift'>unshift</span>(<span class='op'>*</span><span class='id identifier rubyid_includes'>includes</span>)
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_library'>library</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_require'>require</span>]
    <span class='id identifier rubyid_require'>require</span> <span class='id identifier rubyid_library'>library</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_debug'>debug</span>]
    <span class='gvar'>$DEBUG</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pp</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_server'>server</span>]
    <span class='id identifier rubyid_pp'>pp</span> <span class='id identifier rubyid_wrapped_app'>wrapped_app</span>
    <span class='id identifier rubyid_pp'>pp</span> <span class='id identifier rubyid_app'>app</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_check_pid!'>check_pid!</span> <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_pid'>pid</span>]

  <span class='comment'># Touch the wrapped app, so that the config.ru is loaded before
</span>  <span class='comment'># daemonization (i.e. before chdir, etc).
</span>  <span class='id identifier rubyid_wrapped_app'>wrapped_app</span>

  <span class='id identifier rubyid_daemonize_app'>daemonize_app</span> <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_daemonize'>daemonize</span>]

  <span class='id identifier rubyid_write_pid'>write_pid</span> <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_pid'>pid</span>]

  <span class='id identifier rubyid_trap'>trap</span>(<span class='symbeg'>:</span><span class='const'>INT</span>) <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_shutdown'>shutdown</span>)
      <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_shutdown'>shutdown</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_exit'>exit</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_run'>run</span> <span class='id identifier rubyid_wrapped_app'>wrapped_app</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
<span class='kw'>end</span></code></pre>
<p>The interesting part for a Rails app is the last line, <code>server.run</code>. Here we encounter the <code>wrapped_app</code> method again, which this time
we're going to explore more (even though it was executed before, and
thus memoized by now).</p>
<pre class="code ruby"><code class="ruby"><span class='ivar'>@wrapped_app</span> <span class='op'>||=</span> <span class='id identifier rubyid_build_app'>build_app</span> <span class='id identifier rubyid_app'>app</span></code></pre>
<p>The <code>app</code> method here is defined like so:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_app'>app</span>
  <span class='ivar'>@app</span> <span class='op'>||=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_builder'>builder</span>] <span class='op'>?</span> <span class='id identifier rubyid_build_app_from_string'>build_app_from_string</span> <span class='op'>:</span> <span class='id identifier rubyid_build_app_and_options_from_config'>build_app_and_options_from_config</span>
<span class='kw'>end</span>
<span class='comment'>#...
</span><span class='id identifier rubyid_private'>private</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_build_app_and_options_from_config'>build_app_and_options_from_config</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='op'>::</span><span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_exist?'>exist?</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span>]
      <span class='id identifier rubyid_abort'>abort</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>configuration </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span>]<span class='embexpr_end'>}</span><span class='tstring_content'> not found</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='const'><a href="Rack.html" title="Rack (module)">Rack</a></span><span class='op'>::</span><span class='const'>Builder</span>.<span class='id identifier rubyid_parse_file'>parse_file</span>(<span class='kw'>self</span>.<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span>]<span class='comma'>,</span> <span class='id identifier rubyid_opt_parser'>opt_parser</span>)
    <span class='kw'>self</span>.<span class='id identifier rubyid_options'>options</span>.<span class='id identifier rubyid_merge!'>merge!</span> <span class='id identifier rubyid_options'>options</span>
    <span class='id identifier rubyid_app'>app</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_build_app_from_string'>build_app_from_string</span>
    <span class='const'><a href="Rack.html" title="Rack (module)">Rack</a></span><span class='op'>::</span><span class='const'>Builder</span>.<span class='id identifier rubyid_new_from_string'>new_from_string</span>(<span class='kw'>self</span>.<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_builder'>builder</span>])
  <span class='kw'>end</span></code></pre>
<p>The <code>options[:config]</code> value defaults to <code>config.ru</code> which contains this:</p>
<pre class="code ruby"><code class="ruby"># This file is used by Rack-based servers to start the application.

require ::File.expand_path(&#39;../config/environment&#39;, __FILE__)
run &lt;%= app_const %&gt;</code></pre>
<p>The <code>Rack::Builder.parse_file</code> method here takes the content from this <code>config.ru</code> file and parses it using this code:</p>
<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_app'>app</span> <span class='op'>=</span> <span class='id identifier rubyid_new_from_string'>new_from_string</span> <span class='id identifier rubyid_cfgfile'>cfgfile</span><span class='comma'>,</span> <span class='id identifier rubyid_config'>config</span>

<span class='comment'>#...
</span>
<span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_new_from_string'>new_from_string</span>(<span class='id identifier rubyid_builder_script'>builder_script</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(rackup)</span><span class='tstring_end'>&quot;</span></span>)
  <span class='id identifier rubyid_eval'>eval</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Rack::Builder.new {\n</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_builder_script'>builder_script</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n}.to_app</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='const'>TOPLEVEL_BINDING</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='int'>0</span>
<span class='kw'>end</span></code></pre>
<p>The <code>initialize</code> method of <code>Rack::Builder</code> will take the block here and execute it within an instance of <code>Rack::Builder</code>. This is where the majority of the initialization process of Rails happens. The <code>require</code> line for <code>config/environment.rb</code> in <code>config.ru</code> is the first to run:</p>
<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='op'>::</span><span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_expand_path'>expand_path</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>../config/environment</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>__FILE__</span>)</code></pre>
<h3><code>config/environment.rb</code></h3>
<p>This file is the common file required by <code>config.ru</code> (<code>rails server</code>) and Passenger. This is where these two ways to run the server meet; everything before this point has been Rack and Rails setup.</p>
<p>This file begins with requiring <code>config/application.rb</code>:</p>
<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_expand_path'>expand_path</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>../application</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>__FILE__</span>)</code></pre>
<h3><code>config/application.rb</code></h3>
<p>This file requires <code>config/boot.rb</code>:</p>
<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_expand_path'>expand_path</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>../boot</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>__FILE__</span>)</code></pre>
<p>But only if it hasn't been required before, which would be the case in <code>rails server</code>
but <strong>wouldn't</strong> be the case with Passenger.</p>
<p>Then the fun begins!</p>
<h2>Loading Rails</h2>
<p>The next line in <code>config/application.rb</code> is:</p>
<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rails/all</span><span class='tstring_end'>&#39;</span></span></code></pre>
<h3><code>railties/lib/rails/all.rb</code></h3>
<p>This file is responsible for requiring all the individual frameworks of Rails:</p>
<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rails</span><span class='tstring_end'>&quot;</span></span>

<span class='qwords'><span class='qwords_beg'>%w(</span><span class='words_sep'>
  </span><span class='tstring_content'>active_record</span><span class='words_sep'>
  </span><span class='tstring_content'>action_controller</span><span class='words_sep'>
  </span><span class='tstring_content'>action_view</span><span class='words_sep'>
  </span><span class='tstring_content'>action_mailer</span><span class='words_sep'>
  </span><span class='tstring_content'>rails/test_unit</span><span class='words_sep'>
  </span><span class='tstring_content'>sprockets</span><span class='words_sep'>
</span><span class='tstring_end'>)</span></span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_framework'>framework</span><span class='op'>|</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_framework'>framework</span><span class='embexpr_end'>}</span><span class='tstring_content'>/railtie</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>rescue</span> <span class='const'><a href="LoadError.html" title="LoadError (class)">LoadError</a></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>
<p>This is where all the Rails frameworks are loaded and thus made
available to the application. We won't go into detail of what happens
inside each of those frameworks, but you're encouraged to try and
explore them on your own.</p>
<p>For now, just keep in mind that common functionality like Rails engines,
I18n and Rails configuration are all being defined here.</p>
<h3>Back to <code>config/environment.rb</code></h3>
<p>The rest of <code>config/application.rb</code> defines the configuration for the
<a href="Rails/Application.html" title="Rails::Application (class)">::Rails::Application</a> which will be used once the application is fully
initialized. When <code>config/application.rb</code> has finished loading Rails and defined
the application namespace, we go back to <code>config/environment.rb</code>,
where the application is initialized. For example, if the application was called
<code>Blog</code>, here we would find <code>Rails.application.initialize!</code>, which is
defined in <code>rails/application.rb</code>.</p>
<h3><code>railties/lib/rails/application.rb</code></h3>
<p>The <code>initialize!</code> method looks like this:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_initialize!'>initialize!</span>(<span class='id identifier rubyid_group'>group</span><span class='op'>=</span><span class='symbeg'>:</span><span class='id identifier rubyid_default'>default</span>) <span class='comment'>#:nodoc:
</span>  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Application has been already initialized.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@initialized</span>
  <span class='id identifier rubyid_run_initializers'>run_initializers</span>(<span class='id identifier rubyid_group'>group</span><span class='comma'>,</span> <span class='kw'>self</span>)
  <span class='ivar'>@initialized</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></code></pre>
<p>As you can see, you can only initialize an app once. The initializers are run through
the <code>run_initializers</code> method which is defined in <code>railties/lib/rails/initializable.rb</code>:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_run_initializers'>run_initializers</span>(<span class='id identifier rubyid_group'>group</span><span class='op'>=</span><span class='symbeg'>:</span><span class='id identifier rubyid_default'>default</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>)
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_instance_variable_defined?'>instance_variable_defined?</span>(<span class='symbeg'>:</span><span class='ivar'>@ran</span>)
  <span class='id identifier rubyid_initializers'>initializers</span>.<span class='id identifier rubyid_tsort_each'>tsort_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_initializer'>initializer</span><span class='op'>|</span>
    <span class='id identifier rubyid_initializer'>initializer</span>.<span class='id identifier rubyid_run'>run</span>(<span class='op'>*</span><span class='id identifier rubyid_args'>args</span>) <span class='kw'>if</span> <span class='id identifier rubyid_initializer'>initializer</span>.<span class='id identifier rubyid_belongs_to?'>belongs_to?</span>(<span class='id identifier rubyid_group'>group</span>)
  <span class='kw'>end</span>
  <span class='ivar'>@ran</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span></code></pre>
<p>The <code>run_initializers</code> code itself is tricky. What Rails is doing here is
traversing all the class ancestors looking for those that respond to an
<code>initializers</code> method. It then sorts the ancestors by name, and runs them.
For example, the <code>Engine</code> class will make all the engines available by
providing an <code>initializers</code> method on them.</p>
<p>The <a href="Rails/Application.html" title="Rails::Application (class)">::Rails::Application</a> class, as defined in <code>railties/lib/rails/application.rb</code>
defines <code>bootstrap</code>, <code>railtie</code>, and <code>finisher</code> initializers. The <code>bootstrap</code> initializers
prepare the application (like initializing the logger) while the <code>finisher</code>
initializers (like building the middleware stack) are run last. The <code>railtie</code>
initializers are the initializers which have been defined on the <a href="Rails/Application.html" title="Rails::Application (class)">::Rails::Application</a>
itself and are run between the <code>bootstrap</code> and <code>finishers</code>.</p>
<p>After this is done we go back to <code>Rack::Server</code>.</p>
<h3>Rack: lib/rack/server.rb</h3>
<p>Last time we left when the <code>app</code> method was being defined:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_app'>app</span>
  <span class='ivar'>@app</span> <span class='op'>||=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_builder'>builder</span>] <span class='op'>?</span> <span class='id identifier rubyid_build_app_from_string'>build_app_from_string</span> <span class='op'>:</span> <span class='id identifier rubyid_build_app_and_options_from_config'>build_app_and_options_from_config</span>
<span class='kw'>end</span>
<span class='comment'>#...
</span><span class='id identifier rubyid_private'>private</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_build_app_and_options_from_config'>build_app_and_options_from_config</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='op'>::</span><span class='const'><a href="File.html" title="File (class)">File</a></span>.<span class='id identifier rubyid_exist?'>exist?</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span>]
      <span class='id identifier rubyid_abort'>abort</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>configuration </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span>]<span class='embexpr_end'>}</span><span class='tstring_content'> not found</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='const'><a href="Rack.html" title="Rack (module)">Rack</a></span><span class='op'>::</span><span class='const'>Builder</span>.<span class='id identifier rubyid_parse_file'>parse_file</span>(<span class='kw'>self</span>.<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_config'>config</span>]<span class='comma'>,</span> <span class='id identifier rubyid_opt_parser'>opt_parser</span>)
    <span class='kw'>self</span>.<span class='id identifier rubyid_options'>options</span>.<span class='id identifier rubyid_merge!'>merge!</span> <span class='id identifier rubyid_options'>options</span>
    <span class='id identifier rubyid_app'>app</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_build_app_from_string'>build_app_from_string</span>
    <span class='const'><a href="Rack.html" title="Rack (module)">Rack</a></span><span class='op'>::</span><span class='const'>Builder</span>.<span class='id identifier rubyid_new_from_string'>new_from_string</span>(<span class='kw'>self</span>.<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_builder'>builder</span>])
  <span class='kw'>end</span></code></pre>
<p>At this point <code>app</code> is the Rails app itself (a middleware), and what
happens next is Rack will call all the provided middlewares:</p>
<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_build_app'>build_app</span>(<span class='id identifier rubyid_app'>app</span>)
  <span class='id identifier rubyid_middleware'>middleware</span>[<span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_environment'>environment</span>]].<span class='id identifier rubyid_reverse_each'>reverse_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_middleware'>middleware</span><span class='op'>|</span>
    <span class='id identifier rubyid_middleware'>middleware</span> <span class='op'>=</span> <span class='id identifier rubyid_middleware'>middleware</span>.<span class='id identifier rubyid_call'>call</span>(<span class='kw'>self</span>) <span class='kw'>if</span> <span class='id identifier rubyid_middleware'>middleware</span>.<span class='id identifier rubyid_respond_to?'>respond_to?</span>(<span class='symbeg'>:</span><span class='id identifier rubyid_call'>call</span>)
    <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_middleware'>middleware</span>
    <span class='id identifier rubyid_klass'>klass</span> <span class='op'>=</span> <span class='id identifier rubyid_middleware'>middleware</span>.<span class='id identifier rubyid_shift'>shift</span>
    <span class='id identifier rubyid_app'>app</span> <span class='op'>=</span> <span class='id identifier rubyid_klass'>klass</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_middleware'>middleware</span>)
  <span class='kw'>end</span>
  <span class='id identifier rubyid_app'>app</span>
<span class='kw'>end</span></code></pre>
<p>Remember, <code>build_app</code> was called (by <code>wrapped_app</code>) in the last line of <code>Server#start</code>.
Here's how it looked like when we left:</p>
<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_run'>run</span> <span class='id identifier rubyid_wrapped_app'>wrapped_app</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span></code></pre>
<p>At this point, the implementation of <code>server.run</code> will depend on the
server you're using. For example, if you were using Puma, here's what
the <code>run</code> method would look like:</p>
<pre class="code ruby"><code class="ruby"><span class='comment'>#...
</span><span class='const'>DEFAULT_OPTIONS</span> <span class='op'>=</span> {
  <span class='symbeg'>:</span><span class='const'>Host</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='const'>Port</span> <span class='op'>=&gt;</span> <span class='int'>8080</span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='const'>Threads</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>0:16</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='symbeg'>:</span><span class='const'>Verbose</span> <span class='op'>=&gt;</span> <span class='kw'>false</span>
}

<span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_run'>run</span>(<span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> {})
  <span class='id identifier rubyid_options'>options</span>  <span class='op'>=</span> <span class='const'>DEFAULT_OPTIONS</span>.<span class='id identifier rubyid_merge'>merge</span>(<span class='id identifier rubyid_options'>options</span>)

  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='const'>Verbose</span>]
    <span class='id identifier rubyid_app'>app</span> <span class='op'>=</span> <span class='const'><a href="Rack.html" title="Rack (module)">Rack</a></span><span class='op'>::</span><span class='const'>CommonLogger</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='const'>STDOUT</span>)
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_environment'>environment</span>]
    <span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RACK_ENV</span><span class='tstring_end'>&#39;</span></span>] <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='id identifier rubyid_environment'>environment</span>].<span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_server'>server</span>   <span class='op'>=</span> <span class='op'>::</span><span class='const'>Puma</span><span class='op'>::</span><span class='const'>Server</span>.<span class='id identifier rubyid_new'>new</span>(<span class='id identifier rubyid_app'>app</span>)
  <span class='id identifier rubyid_min'>min</span><span class='comma'>,</span> <span class='id identifier rubyid_max'>max</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='const'>Threads</span>].<span class='id identifier rubyid_split'>split</span>(<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span>)

  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Puma </span><span class='embexpr_beg'>#{</span><span class='op'>::</span><span class='const'>Puma</span><span class='op'>::</span><span class='const'>Const</span><span class='op'>::</span><span class='const'>PUMA_VERSION</span><span class='embexpr_end'>}</span><span class='tstring_content'> starting...</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>* Min threads: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_min'>min</span><span class='embexpr_end'>}</span><span class='tstring_content'>, max threads: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max'>max</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>* Environment: </span><span class='embexpr_beg'>#{</span><span class='const'>ENV</span>[<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RACK_ENV</span><span class='tstring_end'>&#39;</span></span>]<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>* Listening on tcp://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='const'>Host</span>]<span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='const'>Port</span>]<span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_add_tcp_listener'>add_tcp_listener</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='const'>Host</span>]<span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span>[<span class='symbeg'>:</span><span class='const'>Port</span>]
  <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_min_threads'>min_threads</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
  <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_max_threads'>max_threads</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
  <span class='kw'>yield</span> <span class='id identifier rubyid_server'>server</span> <span class='kw'>if</span> <span class='id identifier rubyid_block_given?'>block_given?</span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_run'>run</span>.<span class='id identifier rubyid_join'>join</span>
  <span class='kw'>rescue</span> <span class='const'>Interrupt</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>* Gracefully stopping, waiting for requests to finish</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_server'>server</span>.<span class='id identifier rubyid_stop'>stop</span>(<span class='kw'>true</span>)
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>* Goodbye!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

<span class='kw'>end</span></code></pre>
<p>We won't dig into the server configuration itself, but this is
the last piece of our journey in the Rails initialization process.</p>
<p>This high level overview will help you understand when your code is
executed and how, and overall become a better Rails developer. If you
still want to know more, the Rails source code itself is probably the
best place to go next.</p>

<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>